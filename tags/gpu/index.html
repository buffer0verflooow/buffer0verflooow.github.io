<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Tag: gpu - buffer0verflooow - Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="buffer0verflooow - Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="buffer0verflooow - Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="buffer0verflooow - Blog"><meta property="og:url" content="https://buffer0verflooow.github.io/"><meta property="og:site_name" content="buffer0verflooow - Blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://buffer0verflooow.github.io/img/og_image.png"><meta property="article:author" content="buffer0verflooow"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://buffer0verflooow.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://buffer0verflooow.github.io"},"headline":"buffer0verflooow - Blog","image":["https://buffer0verflooow.github.io/img/og_image.png"],"author":{"@type":"Person","name":"buffer0verflooow"},"publisher":{"@type":"Organization","name":"buffer0verflooow - Blog","logo":{"@type":"ImageObject","url":"https://buffer0verflooow.github.io/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="buffer0verflooow - Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">Tags</a></li><li class="is-active"><a href="#" aria-current="page">gpu</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-18T08:50:51.000Z" title="2022/6/18 16:50:51">2022-06-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-06-20T14:08:16.790Z" title="2022/6/20 22:08:16">2022-06-20</time></span><span class="level-item">2 hours read (About 13695 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/18/Qualcomm-GPU%E9%A9%B1%E5%8A%A8UAF%E6%BC%8F%E6%B4%9E-CVE-2022-22057/">Qualcomm GPUé©±åŠ¨UAFæ¼æ´(CVE-2022-22057)</a></p><div class="content"><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åˆæ˜¯ä¸€ç¯‡å…³äº<code>Qualcomm</code>é©±åŠ¨ç¨‹åºçš„æ¼æ´ï¼Œç„¶è€Œä¸Šä¸€ç¯‡å…³äºé©±åŠ¨çš„æ¼æ´è¿˜æ²¡å»éªŒè¯å‘¢ğŸ˜®â€ğŸ’¨</p>
<p>ä»Šå¤©è¿™ä¸€ç¯‡æ˜¯å®˜å‘˜<code>Qualcomm GPU</code>çš„ UAF æ¼æ´ï¼Œå½±å“æ­è½½äº†<code>Snapdragon 888</code>åŠä»¥ä¸ŠèŠ¯ç‰‡ã€å†…æ ¸ç‰ˆæœ¬ä¸º 5.4 åŠä»¥ä¸Šçš„è®¾å¤‡ï¼Œå¦‚S21ã€Galaxy Z Flip3ç­‰ã€‚</p>
<p>é«˜é€šçš„å®‰å…¨å…¬å‘Šï¼š<a target="_blank" rel="noopener" href="https://docs.qualcomm.com/product/publicresources/securitybulletin/may-2022-bulletin.html">Qualcomm security bulletin in May 2022</a>ã€‚</p>
<h2 id="ä¸ºä»€ä¹ˆè¦æŒ–GPUé©±åŠ¨æ¼æ´å‘¢ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦æŒ–GPUé©±åŠ¨æ¼æ´å‘¢ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦æŒ–GPUé©±åŠ¨æ¼æ´å‘¢ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦æŒ–GPUé©±åŠ¨æ¼æ´å‘¢ï¼Ÿ</h2><ol>
<li>GPU é©±åŠ¨ä¸­æœ‰å¾ˆå¤šç¼“è§£æªæ–½ï¼›</li>
<li>2021å¹´åœ¨é‡åˆ©ç”¨çš„ Android 0Day æ¼æ´æœ‰7ä¸ªï¼Œå…¶ä¸­5ä¸ªæ˜¯å…³äº GPU é©±åŠ¨çš„ï¼›</li>
<li>GPU é©±åŠ¨å¯ä»¥ä»æœªä¿¡ä»»çš„åº”ç”¨æ²™ç®±ä¸­è¿›è¡Œè®¿é—®ï¼›</li>
<li>å¤§å¤šæ•°çš„ GPU é©±åŠ¨éƒ½ä¼šå¤„ç† GPU å’Œ CPU ä¹‹é—´çš„å¤æ‚çš„å†…å­˜å…±äº«é€»è¾‘ï¼Œå¤„ç†ç²¾å¿ƒåˆ¶ä½œçš„æ¶æ„ä»£ç å°†å¯¼è‡´ä»»æ„å†…å­˜è¯»å†™ã€‚ç”±äºæ”»å‡»è€…æ»¥ç”¨GPU å†…å­˜ç®¡ç†ä»£ç ï¼Œå°†å¯¼è‡´å†…å­˜æŸåéš¾ä»¥æ£€æµ‹ï¼Œä»¥åŠå¯¹ç°æœ‰çš„ç¼“è§£æªæ–½å…ç–«ï¼›<ol>
<li>è¿™é‡Œæœ‰ä¸¤ä¸ªæ»¥ç”¨ GPU opcode çš„ä¾‹å­ï¼š<a target="_blank" rel="noopener" href="https://github.com/secmob/TiYunZong-An-Exploit-Chain-to-Remotely-Root-Modern-Android-Devices/blob/master/us-20-Gong-TiYunZong-An-Exploit-Chain-to-Remotely-Root-Modern-Android-Devices-wp.pdf">Guang Gong</a> å’Œ <a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2020/09/attacking-qualcomm-adreno-gpu.html">Ben Hawkes</a>ã€‚</li>
</ol>
</li>
</ol>
<h1 id="æ¼æ´ä¿¡æ¯"><a href="#æ¼æ´ä¿¡æ¯" class="headerlink" title="æ¼æ´ä¿¡æ¯"></a>æ¼æ´ä¿¡æ¯</h1><p>æ¼æ´æ˜¯åœ¨Qualcomm <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/tree/msm-5.4.r2">msm 5.4 kernel</a> ä¸­å¼•å…¥çš„ï¼Œå¢åŠ äº†<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c">kgsl timeline</a>ç‰¹æ€§å’Œä¸€äº›<code>ioctl</code>ã€‚<code>msm 5.4</code> å†…æ ¸å¯¹å†…æ ¸å›¾å½¢æ”¯æŒå±‚ï¼ˆkgslï¼‰é©±åŠ¨ç¨‹åºï¼ˆä½äº<code>drivers/gpu/msm</code>ä¸‹ï¼‰è¿›è¡Œäº†ä¸€äº›ç›¸å½“é‡è¦çš„é‡æ„ï¼Œå¹¶å¼•å…¥äº†ä¸€äº›æ–°åŠŸèƒ½ã€‚å°±æ˜¯è¿™äº›æ–°åŠŸèƒ½å’Œé‡æ„ï¼Œå¯¼è‡´äº†æ–°çš„å®‰å…¨é—®é¢˜ã€‚å…¶ä¸­å¤§éƒ¨åˆ†æ˜¯åœ¨å†…éƒ¨å‘ç°å¹¶ä¿®å¤çš„ï¼Œç„¶ååœ¨å…¬å‘Šä¸­ä½œä¸ºå®‰å…¨é—®é¢˜å…¬å¼€æŠ«éœ²ã€‚</p>
<p> <code>kgsl_timeline</code> å¯¹è±¡å¯ä»¥é€šè¿‡<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L323"><code>IOCTL_KGSL_TIMELINE_CREATE</code></a> å’Œ <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L96"><code>IOCTL_KGSL_TIMELINE_DESTROY</code></a>è¿›è¡Œåˆ›å»ºå’Œé”€æ¯ã€‚ <code>kgsl_timeline</code>å¯¹è±¡åœ¨å…¶ <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.h#L26"><code>fences</code></a>å­—æ®µä¸­å­˜å‚¨äº†ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/v5.9/driver-api/dma-buf.html"><code>dma_fence</code></a> å¯¹è±¡é“¾è¡¨ã€‚ä½¿ç”¨<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L427"><code>IOCTL_KGSL_TIMELINE_FENCE_GET</code></a> å’Œ <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L358"><code>IOCTL_KGSL_TIMELINE_WAIT</code></a>å‘é“¾è¡¨ä¸­æ·»åŠ <code>dma_fence</code>å¯¹è±¡ã€‚æ·»åŠ çš„<code>dma_fence</code>å¯¹è±¡æ˜¯<code>refcounted</code>å¯¹è±¡ï¼Œ<code>dma_fence_put</code>æ–¹æ³•ç”¨äºå‡å°‘å®ƒä»¬çš„<code>refcount</code>ã€‚</p>
<p>æœ‰è¶£çš„æ˜¯ï¼Œ <code>timeline-&gt;fences</code> å¹¶æ²¡æœ‰çœŸçš„æŒæœ‰ä¸€ä¸ª<code>fences</code>çš„<code>refcount</code>ã€‚åä¹‹ï¼Œä¸ºäº†é¿å… <code>timeline-&gt;fences</code> ä¸­çš„ <code>dma_fence</code> è¢«é‡Šæ”¾ï¼Œä½¿ç”¨äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„ <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L231"><code>release</code></a> å‡½æ•°ï¼š <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L165"><code>timeline_fence_release</code></a> ï¼Œåœ¨<code>dma_fence</code>è¢«é‡Šæ”¾ä¹‹å‰ï¼Œ <code>timeline_fence_release</code> ä» <code>timeline-&gt;fences</code> ä¸­ç§»é™¤è¯¥<code>dma_fence</code>ã€‚</p>
<p>å½“å­˜å‚¨åœ¨ <code>kgsl_timeline::fences</code> ä¸­çš„ <code>dma_fence</code> çš„<code>refcount</code>å‡å°‘ä¸º0æ—¶ï¼Œæ–¹æ³• <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L165"><code>timeline_fence_release</code></a> è¢«è°ƒç”¨ï¼Œä»¥ä» <code>kgsl_timeline::fences</code> ä¸­ç§»é™¤ <code>dma_fence</code> ï¼Œç„¶åè°ƒç”¨ <code>dma_fence_free</code> æ–¹æ³•é‡Šæ”¾ <code>dma_fence</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">timeline_fence_release</span><span class="params">(<span class="keyword">struct</span> dma_fence *fence)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    spin_lock_irqsave(&amp;timeline-&gt;fence_lock, flags);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If the fence is still on the active list, remove it */</span></span><br><span class="line">    list_for_each_entry_safe(cur, temp, &amp;timeline-&gt;fences, node) &#123;</span><br><span class="line">        <span class="keyword">if</span> (f != cur)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        list_del_init(&amp;f-&gt;node);    <span class="comment">//&lt;----- 1. Remove fence</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irqrestore(&amp;timeline-&gt;fence_lock, flags);</span><br><span class="line">    ...</span><br><span class="line">    kgsl_timeline_put(f-&gt;timeline);</span><br><span class="line">    dma_fence_free(fence);     <span class="comment">//&lt;-------    2.  frees the fence</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°½ç®¡ç§»é™¤æ“ä½œè¢«<code>timeline-&gt;fence_lock</code>æ‰€ä¿æŠ¤ï¼Œ<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L515"><code>IOCTL_KGSL_TIMELINE_DESTROY</code></a>ä»ç„¶å¯ä»¥åœ¨ <code>dma_fence</code> çš„<code>refcount</code>å‡å°‘ä¸º0æ—¶ï¼Œä» <code>fences</code> ä¸­ç§»é™¤å‰ï¼Œè·å–å®ƒçš„ä¸€ä¸ªå¼•ç”¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    spin_lock(&amp;timeline-&gt;fence_lock);  <span class="comment">//&lt;------------- a.</span></span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;timeline-&gt;fences, node)</span><br><span class="line">        dma_fence_get(&amp;fence-&gt;base);</span><br><span class="line">    list_replace_init(&amp;timeline-&gt;fences, &amp;temp);</span><br><span class="line">    spin_unlock(&amp;timeline-&gt;fence_lock);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123; <span class="comment">//&lt;----- b.</span></span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ <code>kgsl_ioctl_timeline_destroy</code>ä¸­ï¼Œé”€æ¯ä¸€ä¸ª<code>timeline</code>ä¹‹å‰ï¼Œå…ˆå°†<code>timeline-&gt;fences</code>ä¸­çš„<code>fences</code>æ‹·è´åˆ°<code>temp</code>ä¸­ï¼Œç„¶åä»<code>timeline-&gt;fences</code>ä¸­åˆ é™¤ï¼ˆaï¼‰ã€‚ç”±äº<code>timeline-&gt;fences</code>æ²¡æœ‰ä¿ç•™é¢å¤–çš„<code>fence</code>å¼•ç”¨ï¼Œ<code>refcount</code>å°†è¢«å¢åŠ ä»¥é˜»æ­¢å®ƒä»¬åœ¨<code>temp</code>ä¸­è¢«é‡Šæ”¾ã€‚åŒæ ·çš„ï¼Œè¿™é‡Œå¯¹ <code>timeline-&gt;fences</code> çš„æ“ä½œä¹Ÿå—åˆ°<code>timeline-&gt;fence_lock</code>çš„ä¿æŠ¤ã€‚ä½†æ˜¯ï¼Œå½“åˆ°è¾¾ï¼ˆaï¼‰æ—¶ï¼Œ<code>fence</code>çš„<code>refcount</code>å·²ç»ä¸º0äº†ï¼Œæ–¹æ³• <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L165"><code>timeline_fence_release</code></a> è¿˜æ²¡æœ‰å°†å…¶ä» <code>kgsl_timeline::fences</code> ä¸­ç§»é™¤æ—¶ï¼Œ <code>dma_fence</code> å°†è¢«ç§»åŠ¨åˆ°<code>temp</code>ä¸­ï¼Œå°½ç®¡æ­¤æ—¶å®ƒçš„å¼•ç”¨å¢åŠ äº†ï¼Œä½†æ˜¯ä¹Ÿå·²ç»æ™šäº†ï¼Œå› ä¸ºï¼Œéšåæ–¹æ³• <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L165"><code>timeline_fence_release</code></a> å°†ä» <code>kgsl_timeline::fences</code> ä¸­ç§»é™¤å®ƒï¼Œæ— è®º<code>refcount</code>çš„å€¼æ˜¯å¤šå°‘ã€‚æŒ‰ç…§ä»¥ä¸‹æµç¨‹ï¼ŒUAF å°†åœ¨ï¼ˆbï¼‰å¤„è§¦å‘ã€‚</p>
<img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-1.webp" alt="Kernel-1"  />

<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¿™æ˜¯ç«äº‰çš„æµç¨‹ï¼Œé€šè¿‡åœ¨ <code>timeline-&gt;fence</code>ä¸­æ·»åŠ å¤§é‡çš„ <code>dma_fence</code> ï¼Œå¯ä»¥å¢åŠ <code>kgsl_ioctl_timeline_destroy</code>ä»£ç å—è¿è¡Œçš„æ—¶é—´ã€‚å¦‚æœåœ¨çº¿ç¨‹2ä¸­å°† <code>timeline-&gt;fence</code>ä¸­æœ€åä¸€ä¸ª <code>dma_fence</code> çš„<code>refcount</code>å‡å°‘ä¸º0ï¼ŒåŒæ—¶ä¿æŒçº¿ç¨‹1ç»§ç»­è¿è¡Œï¼Œæˆ‘ä»¬å¯ä»¥åœ¨çº¿ç¨‹1çš„ <code>dma_fence_get</code> å°†<code>refcount</code>åŠ 1å‰ï¼Œè°ƒç”¨ <code>timeline_fence_release</code> ã€‚å› ä¸ºçº¿ç¨‹2ä¹Ÿéœ€è¦ç­‰å¾… <code>timeline-&gt;fence_lock</code>ï¼Œå®ƒåªæœ‰ç­‰çº¿ç¨‹1ç»“æŸï¼Œæ‰èƒ½ä» <code>kgsl_timeline::fences</code> ä¸­ç§»é™¤ <code>dma_fence</code> ã€‚åˆ°é‚£æ—¶ï¼Œ <code>timeline-&gt;fence</code>ä¸­æ‰€æœ‰çš„ <code>dma_fence</code> éƒ½å·²ç»ç§»åŠ¨åˆ°<code>temp</code>ä¸­äº†ã€‚è¿™å°±æ„å‘³ç€ï¼Œå½“çº¿ç¨‹2è¿è¡Œæ—¶ï¼Œ <code>timeline-&gt;fence</code>æ˜¯ä¸€ä¸ªç©ºçš„é“¾è¡¨ï¼Œç„¶åæ‰§è¡Œæµç¨‹å°†å¾ˆå¿«åˆ°è¾¾ <code>dma_fence_free</code>ã€‚</p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œåªè¦åœ¨ <code>timeline-&gt;fence</code>ä¸­æ”¾ç½®è¶³å¤Ÿçš„ <code>dma_fence</code> ï¼Œå¯ä»¥åœ¨<code>kgsl_ioctl_timeline_destroy</code>å°† <code>timeline-&gt;fence</code>ä¸­ <code>dma_fence</code> ç§»åŠ¨åˆ°<code>temp</code>çš„è¿‡ç¨‹ä¸­ï¼Œåˆ›é€ ä¸€ä¸ªå¾ˆå¤§çš„ç«äº‰çª—å£ï¼Œåªè¦å°† <code>timeline-&gt;fence</code>ä¸­æœ€åä¸€ä¸ª <code>dma_fence</code> çš„<code>refcount</code>å‡å°‘ä¸º0ï¼Œå°±å¯ä»¥è§¦å‘UAFã€‚</p>
<h1 id="ç¼“è§£æªæ–½"><a href="#ç¼“è§£æªæ–½" class="headerlink" title="ç¼“è§£æªæ–½"></a>ç¼“è§£æªæ–½</h1><p>åˆ©ç”¨è¿™ä¸ªbugå¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯ï¼Œæœ‰å¾ˆå¤šæ¼æ´ç¼“è§£æªæ–½ï¼Œ<a target="_blank" rel="noopener" href="https://source.android.com/devices/tech/debug/kcfi">kCFI</a> (Kernel Control Flow Integrity) å’Œ <a target="_blank" rel="noopener" href="https://android-developers.googleblog.com/2020/06/system-hardening-in-android-11.html">variable initialization</a> ï¼ˆè¿™äº›åœ¨4.xå†…æ ¸ä¸­æ˜¯å…³é—­çš„ï¼Œä½†æ˜¯5.xå†…æ ¸å…¨éƒ¨å¼€å¯äº†ï¼‰ï¼Œè¿˜æœ‰ <a target="_blank" rel="noopener" href="https://www.samsungknox.com/en">Samsung RKP (Realtime Kernel Protection)</a> ã€‚</p>
<h2 id="kCFI"><a href="#kCFI" class="headerlink" title="kCFI"></a>kCFI</h2><p><code>kCFI</code>å¯ä»¥è¯´æ˜¯æœ€å®¹æ˜“è¢«ç»•è¿‡çš„ç¼“è§£æªæ–½ï¼Œç‰¹åˆ«æ˜¯åœ¨ä¸ä¸‰æ˜Ÿç®¡ç†ç¨‹åºä¸€èµ·ä½¿ç”¨æ—¶ï¼Œå®ƒä¿æŠ¤äº†å†…æ ¸ä¸­è®¸å¤šé‡è¦çš„å†…å­˜åŒºåŸŸã€‚<code>kCFI</code>é€šè¿‡é™åˆ¶åŠ¨æ€è°ƒç”¨ç‚¹å¯ä»¥ä½¿ç”¨å‡½æ•°ç­¾åè·³è½¬åˆ°çš„ä½ç½®æ¥é˜²æ­¢æ§åˆ¶æµè¢«åŠ«æŒã€‚ä¾‹å¦‚ï¼Œåœ¨å½“å‰çš„æ¼æ´ä¸­ï¼Œ<code>dma_fence</code>è¢«é‡Šæ”¾åï¼Œå‡½æ•°<code>dma_fence_signal_locked</code>è¢«è°ƒç”¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base);       <span class="comment">//&lt;---- free&#x27;d fence is used</span></span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dma_fence_signal_locked</code>å°†è°ƒç”¨ <code>cur-&gt;func</code> ï¼Œè¯¥å‡½æ•°æ˜¯<code>fence-&gt;cb_list</code>åˆ—è¡¨ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">dma_fence_signal_locked</span><span class="params">(<span class="keyword">struct</span> dma_fence *fence)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    list_for_each_entry_safe(cur, tmp, &amp;cb_list, node) &#123;</span><br><span class="line">        INIT_LIST_HEAD(&amp;cur-&gt;node);</span><br><span class="line">        cur-&gt;func(fence, cur);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ²¡æœ‰<code>kCFI</code>çš„è¯ï¼Œå·²é‡Šæ”¾çš„ <code>fence</code> å°†å¯ä»¥è¢«<code>fake object</code>ä»£æ›¿ï¼Œæ„å‘³ç€ï¼ŒåŒ…æ‹¬<code>cb_list</code>å’Œ<code>func</code>ï¼Œæ‰€æœ‰éƒ½æ˜¯å‡çš„ã€‚åªè¦ç»•è¿‡äº†<code>KASLR</code>ï¼Œåˆ©ç”¨å°±ååˆ†ç®€å•äº†ï¼Œå¦‚è¿™ä¸ª<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">åˆ©ç”¨</a>ã€‚ä½†æ˜¯ç”±äº<code>kCFI</code>ï¼Œç°åœ¨æ›¿æ¢<code>func</code>çš„å‡½æ•°ç±»å‹åªèƒ½ä¸º <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/include/linux/dma-fence.h#L118"><code>dma_fence_func_t</code></a>ã€‚</p>
<p>ä¹‹å‰æœ‰å…³äºå¦‚ä½•ç»•è¿‡ Samsung æ§åˆ¶æµå®Œæ•´æ€§æ ¡éªŒï¼ˆJOPP, jump-oriented programming preventionï¼‰çš„<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">æ–¹æ³•</a>ï¼Œä½†æ˜¯å¯¹<code>kCFI</code>æ²¡ä»€ä¹ˆä½œç”¨ï¼Œç»•è¿‡<code>kCFI</code>çš„å¸¸è§æ–¹æ³•æ˜¯é€šè¿‡<code>double free</code>å»åŠ«æŒé‡Šæ”¾çš„é“¾è¡¨ï¼Œç„¶åä½¿ç”¨<a target="_blank" rel="noopener" href="https://i.blackhat.com/briefings/asia/2018/asia-18-WANG-KSMA-Breaking-Android-kernel-isolation-and-Rooting-with-ARM-MMU-features.pdf">Kernel Space Mirroring Attack (KSMA)</a>ï¼Œä½†æ˜¯ï¼Œè¿™ç§æ–¹æ³•éœ€è¦å¤§é‡çš„æ—¶é—´ï¼Œå¦‚[Three dark clouds over the Android kernel](<a target="_blank" rel="noopener" href="https://github.com/2freeman/Slides/blob/main/PoC-2020-Three">https://github.com/2freeman/Slides/blob/main/PoC-2020-Three</a> Dark clouds over the Android kernel.pdf) å’Œ <a target="_blank" rel="noopener" href="https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Typhoon-Mangkhut-One-Click-Remote-Universal-Root-Formed-With-Two-Vulnerabilities.pdf">Typhoon Mangkhut: One-click remote universal root formed with two vulnerabilities</a> ã€‚</p>
<p>è¿™ä¸ªbugä¹Ÿèƒ½æä¾›<code>double free</code>ï¼Œå°±æ˜¯å½“ <code>dma_fence_put</code> åœ¨ <code>fence</code> è¢«é‡Šæ”¾åè°ƒç”¨æ—¶ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base); </span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);       <span class="comment">//&lt;----- free&#x27;d fence can be freed again</span></span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°åšæ³•å‡å°‘äº†å‡ <code>fence</code> å¯¹è±¡çš„<code>refcount</code>ï¼Œå¯ä»¥æ§åˆ¶ä¸º1ï¼Œè¿™æ ·å‡ <code>fence</code> å°±ä¼šå†æ¬¡è¢«é‡Šæ”¾ã€‚ç„¶è€Œï¼Œè¿™å¹¶ä¸èƒ½åº”ç”¨<code>KSMA</code>ï¼Œå› ä¸ºè¿™éœ€è¦è¦†ç›–<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/include/asm/pgtable.h#L465"><code>swapper_pg_dir</code></a>æ•°æ®ç»“æ„ï¼Œè€Œè¿™ä¸ªç»“æ„æ˜¯å—ä¸‰æ˜Ÿç®¡ç†ç¨‹åºä¿æŠ¤çš„ã€‚</p>
<h2 id="Variable-initialization"><a href="#Variable-initialization" class="headerlink" title="Variable initialization"></a>Variable initialization</h2><p>ä»Android 11å¼€å§‹ï¼Œå†…æ ¸å¯ä»¥é€šè¿‡å¯ç”¨å„ç§å†…æ ¸æ„å»ºæ ‡å¿—æ¥å®ç°è‡ªåŠ¨å˜é‡åˆå§‹åŒ–ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯Z Flip3çš„æ„å»ºé…ç½®ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Memory initialization</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">CONFIG_CC_HAS_AUTO_VAR_INIT_PATTERN=y</span></span><br><span class="line"><span class="string">CONFIG_CC_HAS_AUTO_VAR_INIT_ZERO=y</span></span><br><span class="line"><span class="comment"># CONFIG_INIT_STACK_NONE is not set</span></span><br><span class="line"><span class="comment"># CONFIG_INIT_STACK_ALL_PATTERN is not set</span></span><br><span class="line"><span class="string">CONFIG_INIT_STACK_ALL_ZERO=y</span></span><br><span class="line"><span class="string">CONFIG_INIT_ON_ALLOC_DEFAULT_ON=y</span></span><br><span class="line"><span class="comment"># CONFIG_INIT_ON_FREE_DEFAULT_ON is not set</span></span><br><span class="line"><span class="comment"># end of Memory initialization</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªç‰¹å¾é™¤äº†ä¿æŠ¤æœªåˆå§‹åŒ–çš„å˜é‡ä»¥å¤–ï¼Œè¿˜ä½¿å¾—æ›¿æ¢å¯¹è±¡å˜å¾—å›°éš¾ã€‚ç‰¹åˆ«æ˜¯ï¼Œå®ƒä¸å†å¯èƒ½æ‰§è¡Œéƒ¨åˆ†å¯¹è±¡æ›¿æ¢ï¼Œå³åªæ›¿æ¢å¯¹è±¡çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œè€Œå¯¹è±¡çš„å…¶ä½™éƒ¨åˆ†ä»ç„¶æœ‰æ•ˆã€‚å¦‚å †å–·ï¼Œ<a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2020/02/mitigations-are-attack-surface-too.html">Mitigations are attack surface, too</a>å°†ä¸å†å¯èƒ½ã€‚</p>
<p>è¿™ä¸ªç‰¹æ€§å°†ä½¿å¾—è¿™ä¸ªbugä¸èƒ½è¿›è¡Œå †å–·ã€‚</p>
<h2 id="kfree-rcu"><a href="#kfree-rcu" class="headerlink" title="kfree_rcu"></a>kfree_rcu</h2><p>è¿™ä¸æ˜¯ä¸€ä¸ªç¼“è§£æªæ–½ï¼Œä¹‹æ‰€ä»¥æï¼Œæ˜¯å› ä¸ºå®ƒæœ‰äº›ç±»ä¼¼å·²æå‡ºçš„ UAF ç¼“è§£æªæ–½çš„ä½œç”¨ã€‚è¿™ä¸ªbugä¸­ï¼Œ <code>fence</code> è¢« <code>dma_fence_free</code> é‡Šæ”¾ï¼Œä¸åŒäºå¸¸è§„çš„ <code>kfree</code>ï¼Œè¿™é‡Œæ˜¯ä½¿ç”¨ <code>kfree_rcu</code>ã€‚ç®€å•æ¥è¯´ï¼Œ<code>kfree_rcu</code>å¹¶ä¸ç›´æ¥é‡Šæ”¾æ‰å¯¹è±¡ï¼Œåªæ˜¯åœ¨é‡åˆ°æŸäº›æƒ…å†µæ—¶å†è¿›è¡Œé‡Šæ”¾ã€‚è¿™æœ‰ç‚¹åƒä¸€ä¸ªå»¶è¿Ÿé‡Šæ”¾ï¼Œåœ¨å¯¹è±¡è¢«é‡Šæ”¾çš„æ—¶é—´ä¸Šå¼•å…¥äº†ä¸€ä¸ªä¸ç¡®å®šæ€§ï¼ˆè¿™å’Œ <a target="_blank" rel="noopener" href="https://source.android.com/devices/tech/debug/scudo">Scudo</a>åˆ†é…å™¨çš„UAFç¼“è§£æªæ–½ç±»ä¼¼ï¼‰ï¼Œè¿™ç§ä¸ç¡®å®šæ€§å¯¹è¿™ä¸ªbugçš„åˆ©ç”¨è¿˜æ˜¯å¾ˆæœ‰é˜»ç¢ï¼ˆç«äº‰çª—å£å¾ˆç´§å¼ ï¼‰çš„ã€‚</p>
<p>ç„¶è€Œï¼Œæœ‰è®¸å¤šæ“çºµç«äº‰çª—å£å¤§å°çš„åŸè¯­ï¼Œæ¯”å¦‚<a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2022/03/racing-against-clock-hitting-tiny.html">Racing against the clockâ€”hitting a tiny kernel race window</a>å’Œ[Exploiting race conditions on (ancient) Linux](<a target="_blank" rel="noopener" href="https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019">https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019</a> - Exploiting race conditions on Linux.pdf)ä¸­çš„æŠ€æœ¯ï¼Œï¼ˆä¸¤è€…éƒ½æ˜¯ç”±Jann Hornç¼–å†™çš„ï¼Œè¾ƒæ—©çš„æŠ€æœ¯è¢«ç”¨äºåˆ©ç”¨å½“å‰çš„bugï¼‰ä»»ä½•ç´§å¼ çš„ç«äº‰çª—å£éƒ½å¯ä»¥è¢«åšå¾—è¶³å¤Ÿå¤§ï¼Œä»¥å…è®¸ç”±<code>kfree_rcu</code>å¼•èµ·çš„å»¶è¿Ÿï¼Œä»¥åŠéšåçš„å¯¹è±¡æ›¿æ¢ã€‚</p>
<h2 id="Samsung-RKP-Realtime-Kernel-Protection"><a href="#Samsung-RKP-Realtime-Kernel-Protection" class="headerlink" title="Samsung RKP (Realtime Kernel Protection)"></a>Samsung RKP (Realtime Kernel Protection)</h2><p><code>RKP</code>ä¿æŠ¤å†…å­˜ä¸è¢«å†™å…¥ï¼Œè¿™å¯ä»¥é˜²æ­¢è¿›ç¨‹è¦†ç›–è‡ªå·±çš„è¯ä¹¦æˆä¸º<code>root</code>ï¼Œä¹Ÿå¯ä»¥ä¿æŠ¤<code>SELinux</code>è®¾ç½®ä¸è¢«è¦†ç›–ã€‚å®ƒè¿˜å¯ä»¥é˜²æ­¢å†…æ ¸ä»£ç åŒºå’Œå…¶ä»–é‡è¦å¯¹è±¡ï¼Œå¦‚å†…æ ¸é¡µè¡¨ï¼Œè¢«è¦†ç›–ã€‚ä¸è¿‡åœ¨å®è·µä¸­ï¼Œä¸€æ—¦å®ç°äº†ä»»æ„çš„å†…æ ¸å†…å­˜è¯»å†™ï¼ˆå—<code>RKP</code>é™åˆ¶ï¼‰ï¼Œå°±æœ‰åŠæ³•ç»•è¿‡è¿™äº›é™åˆ¶ã€‚ä¾‹å¦‚ï¼Œ<code>SELinux</code>è§„åˆ™å¯ä»¥é€šè¿‡è¦†ç›–<code>avc</code>ç¼“å­˜æ¥ä¿®æ”¹ï¼ˆä¾‹å¦‚ï¼Œè§Valentina Palmiottiçš„è¿™ä¸ª<a target="_blank" rel="noopener" href="https://github.com/chompie1337/s8_2019_2215_poc/blob/master/poc/selinux_bypass.c">åˆ©ç”¨</a>ï¼‰ï¼Œè€Œè·å¾—<code>root</code>å¯ä»¥é€šè¿‡<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">hijacking other processes that run as root</a>å®ç°ã€‚</p>
<p>åœ¨è¿™ä¸ªbugä¸­ï¼Œ<code>RKP</code>ä¸<code>kCFI</code>åˆä½œï¼Œé˜²æ­¢ä»»æ„å‡½æ•°è°ƒç”¨ã€‚</p>
<h1 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h1><h2 id="Adding-dma-fence-to-timeline-fences"><a href="#Adding-dma-fence-to-timeline-fences" class="headerlink" title="Adding dma_fence to timeline-&gt;fences"></a>Adding <code>dma_fence</code> to <code>timeline-&gt;fences</code></h2><p>æœ‰ä¸¤ä¸ªé€‰é¡¹å¯ä»¥å°†<code>dma_fence</code>å¯¹è±¡æ·»åŠ åˆ°<code>kgsl_timeline</code>ä¸­ï¼Œç¬¬ä¸€ä¸ªæ˜¯ä½¿ç”¨<code>IOCTL_KGSL_TIMELINE_FENCE_GET</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_fence_get</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    timeline = kgsl_timeline_by_id(device, param-&gt;timeline);</span><br><span class="line">    ...</span><br><span class="line">    fence = kgsl_timeline_fence_alloc(timeline, param-&gt;seqno); <span class="comment">//&lt;----- dma_fence created and added to timeline</span></span><br><span class="line">    ...</span><br><span class="line">    sync_file = sync_file_create(fence);</span><br><span class="line">    <span class="keyword">if</span> (sync_file) &#123;</span><br><span class="line">        fd_install(fd, sync_file-&gt;file);</span><br><span class="line">        param-&gt;handle = fd;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>kgsl_timeline_fence_alloc</code>åˆ›å»ºä¸€ä¸ª<code>dma_fence</code>ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°<code>timeline</code>ä¸Šã€‚ç„¶åè°ƒç”¨è€…å¾—åˆ°ä¸€ä¸ªä¸<code>dma_fence</code>å¯¹åº”çš„<code>sync_file</code>çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å½“<code>sync_file</code>è¢«å…³é—­æ—¶ï¼Œ<code>dma_fence</code>çš„<code>refcount</code>è¢«å‡å°‘åˆ°0ã€‚</p>
<p>ç¬¬äºŒä¸ªæ˜¯ <code>IOCTL_KGSL_TIMELINE_WAIT</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_wait</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    fence = kgsl_timelines_to_fence_array(device, param-&gt;timelines,</span><br><span class="line">        param-&gt;count, param-&gt;timelines_size,</span><br><span class="line">        (param-&gt;flags == KGSL_TIMELINE_WAIT_ANY));     <span class="comment">//&lt;------ dma_fence created and added to timeline</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (!timeout)</span><br><span class="line">        ret = dma_fence_is_signaled(fence) ? <span class="number">0</span> : -EBUSY;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        ret = dma_fence_wait_timeout(fence, <span class="literal">true</span>, timeout);   <span class="comment">//&lt;----- 1.</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dma_fence_put(fence);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>kgsl_timelines_to_fence_array</code>åˆ›å»º<code>dma_fence</code>å¯¹è±¡ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°<code>timeline</code>ä¸Šã€‚å¦‚æœæŒ‡å®šäº†ä¸€ä¸ª <code>timeout</code> ï¼Œé‚£ä¹ˆè¯¥è°ƒç”¨å°†è¿›å…¥<code>dma_fence_wait_timeout</code>ï¼ˆè·¯å¾„æ ‡è®°ä¸º1ï¼‰è¿›è¡Œç­‰å¾…ï¼Œç›´åˆ°è¶…æ—¶æˆ–çº¿ç¨‹æ”¶åˆ°ä¸­æ–­ã€‚åœ¨<code>dma_fence_wait_timeout</code>ç»“æŸåï¼Œ<code>dma_fence_put</code>è¢«è°ƒç”¨ï¼Œä»¥å°†<code>dma_fence</code>çš„<code>refcount</code>å‡å°‘åˆ°0ï¼Œé‡Šæ”¾è¢«æ·»åŠ åˆ°<code>timeline</code>ä¸Šçš„<code>dma_fence</code>ã€‚</p>
<p>è™½ç„¶<code>IOCTL_KGSL_TIMELINE_FENCE_GET</code>ä¹çœ‹ä¹‹ä¸‹ä¼¼ä¹æ›´å®¹æ˜“ä½¿ç”¨å’Œæ§åˆ¶ï¼Œä½†å®é™…ä¸Šï¼Œå…³é—­<code>sync_file</code>äº§ç”Ÿçš„å¼€é”€ä½¿å¾—é”€æ¯<code>dma_fence</code>çš„æ—¶é—´ä¸é‚£ä¹ˆå¯é ã€‚å› æ­¤ï¼Œå¯¹äºè¿™ä¸ªbugï¼Œè¿™é‡Œä½¿ç”¨<code>IOCTL_KGSL_TIMELINE_FENCE_GET</code>æ¥åˆ›å»ºå’Œæ·»åŠ æŒä¹…åŒ–çš„<code>dma_fence</code>å¯¹è±¡æ¥å¡«å……<code>timeline-&gt;fences</code>åˆ—è¡¨ï¼Œä»¥æ‰©å¤§ç«äº‰çª—å£ï¼Œè€Œç”¨äºUAFæ¼æ´çš„æœ€åä¸€ä¸ª<code>dma_fence</code>å¯¹è±¡æ˜¯ä½¿ç”¨<code>IOCTL_KGSL_TIMELINE_WAIT</code>æ·»åŠ çš„ï¼Œå½“å‘é€ä¸­æ–­ä¿¡å·ç»™è°ƒç”¨<code>IOCTL_KGSL_TIMELINE_WAIT</code>çš„çº¿ç¨‹ï¼Œå®ƒå°±è¢«é‡Šæ”¾ã€‚</p>
<h2 id="Widening-the-tiny-race-window"><a href="#Widening-the-tiny-race-window" class="headerlink" title="Widening the tiny race window"></a>Widening the tiny race window</h2><p>ä¸ºäº†åˆ©ç”¨è¿™ä¸ªæ¼æ´ï¼Œéœ€è¦åœ¨ä»¥ä¸‹ä»£ç å—ä¸­æ ‡è®°çš„ç¬¬ä¸€ä¸ªç«äº‰çª—å£å†…åˆ é™¤<code>kgsl_timeline</code>çš„ <code>fences</code> åˆ—è¡¨ä¸­çš„<code>dma_fence</code>çš„<code>refcount</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//BEGIN OF FIRST RACE WINDOW</span></span><br><span class="line">    spin_lock(&amp;timeline-&gt;fence_lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;timeline-&gt;fences, node)</span><br><span class="line">        dma_fence_get(&amp;fence-&gt;base);</span><br><span class="line">    list_replace_init(&amp;timeline-&gt;fences, &amp;temp);</span><br><span class="line">    spin_unlock(&amp;timeline-&gt;fence_lock);</span><br><span class="line">    <span class="comment">//END OF FIRST RACE WINDOW</span></span><br><span class="line">    <span class="comment">//BEGIN OF SECOND RACE WINDOW</span></span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    <span class="comment">//END OF SECOND RACE WINDOW</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚å‰æ‰€è¿°ï¼Œé€šè¿‡å‘<code>timeline-&gt;fences</code>æ·»åŠ å¤§é‡çš„<code>dma_fence</code>å¯¹è±¡ï¼Œå¯ä»¥æ‰©å¤§ç¬¬ä¸€ä¸ªç«äº‰çª—å£ï¼Œè¿™ä½¿å¾—åœ¨è¿™ä¸ªçª—å£å†…å¾ˆå®¹æ˜“è§¦å‘<code>refcount</code>çš„å‡å°‘ã€‚ç„¶è€Œï¼Œä¸ºäº†åˆ©ç”¨è¿™ä¸ªé”™è¯¯ï¼Œä¸‹é¢çš„ä»£ç ä»¥åŠå¯¹è±¡æ›¿æ¢å¿…é¡»åœ¨ç¬¬äºŒä¸ªç«äº‰çª—å£ç»“æŸå‰å®Œæˆï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spin_lock_irqsave(&amp;timeline-&gt;fence_lock, flags);</span><br><span class="line">list_for_each_entry_safe(cur, temp, &amp;timeline-&gt;fences, node) &#123;</span><br><span class="line">    <span class="keyword">if</span> (f != cur)</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    list_del_init(&amp;f-&gt;node);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">spin_unlock_irqrestore(&amp;timeline-&gt;fence_lock, flags);</span><br><span class="line">trace_kgsl_timeline_fence_release(f-&gt;timeline-&gt;id, fence-&gt;seqno);</span><br><span class="line">kgsl_timeline_put(f-&gt;timeline);</span><br><span class="line">dma_fence_free(fence);</span><br></pre></td></tr></table></figure>

<p>å¦‚å‰æ‰€è¿°ï¼Œç”±äº<code>spin_lock</code>çš„å­˜åœ¨ï¼Œåœ¨ç¬¬ä¸€ä¸ªç«äº‰çª—å£ç»“æŸä¹‹å‰ï¼Œä¸Šè¿°ä»£ç ä¸èƒ½æ‰§è¡Œï¼Œä½†åœ¨è¿è¡Œè¿™æ®µä»£ç æ—¶ï¼Œ<code>timeline-&gt;fence</code>å·²ç»è¢«æ¸…ç©ºï¼Œæ‰€ä»¥å¾ªç¯ä¼šå¾ˆå¿«è¿è¡Œã€‚ç„¶è€Œï¼Œç”±äº<code>dma_fence_free</code>ä½¿ç”¨äº†<code>kfree_rcu</code>ï¼Œå®é™…é‡Šæ”¾<code>fence</code>çš„æ—¶é—´è¢«æ¨è¿Ÿäº†ã€‚è¿™ä½¿å¾—æˆ‘ä»¬ä¸å¯èƒ½åœ¨ç¬¬äºŒä¸ªç«äº‰çª—å£ç»“æŸå‰æ›¿æ¢å·²é‡Šæ”¾çš„<code>fence</code>ï¼Œé™¤éèƒ½æ“çºµè°ƒåº¦å™¨ã€‚è¿™é‡Œä½¿ç”¨[Exploiting race conditions on (ancient) Linux](<a target="_blank" rel="noopener" href="https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019">https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019</a> - Exploiting race conditions on Linux.pdf)ï¼Œå¦ä¸€ä¸ªAndroidæ¼æ´ä¸­ä¹Ÿä½¿ç”¨äº†è¿™é¡¹<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/one_day_short_of_a_fullchain_android/">æŠ€æœ¯</a>ï¼Œä»¥æ‰©å¤§è¿™ä¸ªç«äº‰çª—å£ã€‚</p>
<p><strong>ä¸‹é¢æ˜¯å…³äºè¿™é¡¹æŠ€æœ¯çš„æ¦‚è¿°ï¼š</strong></p>
<p><strong>ä¸ºäº†ç¡®ä¿æ¯ä¸ªä»»åŠ¡ï¼ˆçº¿ç¨‹æˆ–è¿›ç¨‹ï¼‰æœ‰å…¬å¹³çš„CPUæ—¶é—´ç‰‡ï¼ŒLinuxå†…æ ¸è°ƒåº¦ç¨‹åºå¯ä»¥ä¸­æ–­ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œå¹¶å°†å…¶æç½®ï¼Œä»¥ä¾¿å¦ä¸€ä¸ªä»»åŠ¡å¯ä»¥è¿è¡Œã€‚è¿™ç§ä¸­æ–­å’Œåœæ­¢ä»»åŠ¡çš„è¡Œä¸ºè¢«ç§°ä¸ºæŠ¢å ï¼ˆè¢«ä¸­æ–­çš„ä»»åŠ¡è¢«æŠ¢å ï¼‰ã€‚ä¸€ä¸ªä»»åŠ¡ä¹Ÿå¯ä»¥æŠŠè‡ªå·±æç½®èµ·æ¥ï¼Œè®©å¦ä¸€ä¸ªä»»åŠ¡è¿è¡Œï¼Œæ¯”å¦‚å½“å®ƒåœ¨ç­‰å¾…ä¸€äº›I&#x2F;Oè¾“å…¥æ—¶ï¼Œæˆ–è€…å½“å®ƒè°ƒç”¨<code>sched_yield()</code>æ—¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¯´è¯¥ä»»åŠ¡æ˜¯è‡ªæ„¿æŠ¢å çš„ã€‚æŠ¢å ä¹Ÿå¯ä»¥å‘ç”Ÿåœ¨ç³»ç»Ÿè°ƒç”¨å†…éƒ¨ï¼Œæ¯”å¦‚<code>ioctl</code>è°ƒç”¨ï¼Œåœ¨Androidä¸Šï¼Œé™¤äº†ä¸€äº›å…³é”®åŒºåŸŸï¼ˆæ¯”å¦‚æŒæœ‰è‡ªæ—‹é”ï¼‰ï¼Œä»»åŠ¡å¯ä»¥è¢«æŠ¢å ã€‚è¿™ç§è¡Œä¸ºå¯ä»¥é€šè¿‡ä½¿ç”¨CPUäº²å’ŒåŠ›å’Œä»»åŠ¡ä¼˜å…ˆçº§æ¥æ“çºµã€‚</strong></p>
<p><strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªä»»åŠ¡ä»¥<code>SCHED_NORMAL</code>çš„ä¼˜å…ˆçº§è¿è¡Œï¼Œä½†ä¹Ÿå¯ä»¥ä½¿ç”¨<code>sched_setscheduler</code>è°ƒç”¨ï¼ˆæˆ–çº¿ç¨‹çš„<code>pthread_setschedparam</code>ï¼‰è®¾ç½®ä¸€ä¸ªè¾ƒä½çš„ä¼˜å…ˆçº§<code>SCHED_IDLE</code>ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥ç”¨<code>sched_setaffinity</code>å°†å…¶å›ºå®šåœ¨ä¸€ä¸ªCPUä¸Šï¼Œè¿™å°†åªå…è®¸å®ƒåœ¨ä¸€ä¸ªç‰¹å®šçš„CPUä¸Šè¿è¡Œã€‚é€šè¿‡å°†ä¸¤ä¸ªä»»åŠ¡ï¼ˆä¸€ä¸ªå…·æœ‰<code>SCHED_NORMAL</code>ä¼˜å…ˆçº§ï¼Œå¦ä¸€ä¸ªå…·æœ‰<code>SCHED_IDLE</code>ä¼˜å…ˆçº§ï¼‰å›ºå®šåœ¨åŒä¸€ä¸ªCPUä¸Šï¼Œå¯ä»¥æ§åˆ¶æŠ¢å çš„æ—¶é—´ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<ol>
<li><strong>é¦–å…ˆè®©<code>SCHED_NORMAL</code>ä»»åŠ¡æ‰§è¡Œä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå¯¼è‡´å®ƒæš‚åœå’Œç­‰å¾…ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥ä»ä¸€ä¸ªæ²¡æœ‰æ•°æ®è¿›å…¥çš„ç®¡é“ä¸­è¯»å–æ•°æ®ï¼Œç„¶åå®ƒå°†ç­‰å¾…æ›´å¤šçš„æ•°æ®ï¼Œå¹¶ä¸»åŠ¨æŠ¢å è‡ªå·±çš„ä½ç½®ï¼Œä»¥ä¾¿<code>SCHED_IDLE</code>ä»»åŠ¡å¯ä»¥è¿è¡Œã€‚</strong></li>
<li><strong>å½“<code>SCHED_IDLE</code>ä»»åŠ¡æ­£åœ¨è¿è¡Œæ—¶ï¼Œå‘<code>SCHED_NORMAL</code>ä»»åŠ¡ä¸€ç›´åœ¨ç­‰å¾…çš„ç®¡é“å‘é€ä¸€äº›æ•°æ®ã€‚è¿™å°†å”¤é†’<code>SCHED_NORMAL</code>ä»»åŠ¡ï¼Œä½¿å…¶æŠ¢å <code>SCHED_IDLE</code>ä»»åŠ¡ï¼Œç”±äºä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œ<code>SCHED_IDLE</code>ä»»åŠ¡å°†è¢«æŠ¢å å¹¶æç½®ã€‚</strong></li>
<li><strong>ç„¶å<code>SCHED_NORMAL</code>ä»»åŠ¡å¯ä»¥è¿è¡Œä¸€ä¸ªç¹å¿™å¾ªç¯ï¼Œä»¥é˜²æ­¢<code>SCHED_IDLE</code>ä»»åŠ¡è¢«å”¤é†’ã€‚</strong></li>
</ol>
<p>åœ¨è¿™ä¸ªbugçš„æ¼æ´åˆ©ç”¨ä¸­ï¼Œè¯¥æŠ€æœ¯ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<ol>
<li><p>åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šè¿è¡Œ<code>IOCTL_KGSL_TIMELINE_WAIT</code>ï¼Œå‘<code>kgsl_timeline</code>æ·»åŠ <code>dma_fence</code>å¯¹è±¡ã€‚å°†è¶…æ—¶è®¾ç½®ä¸ºä¸€ä¸ªå¤§å€¼ï¼Œå¹¶ä½¿ç”¨ <code>sched_setaffinity</code> å°†è¿™ä¸ªä»»åŠ¡å›ºå®šåœ¨ä¸€ä¸ª CPU ä¸Šï¼Œç§°ä¹‹ä¸º <code>SPRAY_CPU</code>ã€‚ä¸€æ—¦<code>dma_fence</code>å¯¹è±¡è¢«æ·»åŠ ï¼Œè¿™ä¸ªä»»åŠ¡å°±ä¼šå˜æˆç©ºé—²çŠ¶æ€ï¼Œç›´åˆ°å®ƒæ”¶åˆ°ä¸€ä¸ªä¸­æ–­ã€‚</p>
</li>
<li><p>è®¾ç½®ä¸€ä¸ª<code>SCHED_NORMAL</code>ä»»åŠ¡ï¼Œå¹¶å°†å…¶å›ºå®šåœ¨å¦ä¸€ä¸ªCPUä¸Šï¼ˆ<code>DESTROY_CPU</code>ï¼‰ï¼Œè¯¥ CPU ç›‘å¬ä¸€ä¸ªç©ºç®¡é“ã€‚è¿™å°†å¯¼è‡´è¿™ä¸ªä»»åŠ¡æœ€åˆå˜å¾—ç©ºé—²ï¼Œå¹¶å…è®¸<code>DESTROY_CPU</code>è¿è¡Œä¸€ä¸ªä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚ä¸€æ—¦ç©ºç®¡é“æ”¶åˆ°ä¸€äº›æ•°æ®ï¼Œè¿™ä¸ªä»»åŠ¡å°±ä¼šè¿è¡Œä¸€ä¸ªç¹å¿™çš„å¾ªç¯ã€‚</p>
</li>
<li><p>åœ¨<code>DESTROY_CPUä¸Š</code>è®¾ç½®ä¸€ä¸ª<code>SCHED_IDLE</code>ä»»åŠ¡ï¼Œå®ƒå°†è¿è¡Œ<code>IOCTL_KGSL_TIMELINE_DESTROY</code>æ¥é”€æ¯æ­¥éª¤ä¸€ä¸­åŠ å…¥<code>dma_fence</code>çš„<code>timeline</code>ã€‚ç”±äºç¬¬äºŒæ­¥ä¸­è®¾ç½®çš„ä»»åŠ¡æ­£åœ¨ç­‰å¾…ç©ºç®¡çš„å“åº”ï¼Œ<code>DESTROY_CPU</code>å°†é¦–å…ˆè¿è¡Œè¿™ä¸ªä»»åŠ¡ã€‚</p>
</li>
<li><p>å‘è¿è¡Œ<code>IOCTL_KGSL_TIMELINE_WAIT</code>çš„ä»»åŠ¡å‘é€ä¸€ä¸ªä¸­æ–­ã€‚ç„¶åï¼Œåœ¨<code>IOCTL_KGSL_TIMELINE_DESTROY</code>åœ¨ç¬¬ä¸€ä¸ªç«äº‰çª—å£å†…è¿è¡Œæ—¶ï¼Œè¯¥ä»»åŠ¡å°†è§£é™¤å°é”å¹¶é‡Šæ”¾<code>dma_fence</code>ã€‚</p>
</li>
<li><p>å†™å…¥<code>SCHED_NORMAL</code>ä»»åŠ¡æ­£åœ¨ç›‘å¬çš„ç©ºç®¡é“ã€‚è¿™å°†å¯¼è‡´<code>SCHED_NORMAL</code>ä»»åŠ¡æŠ¢å <code>SCHED_IDLE</code>ä»»åŠ¡ã€‚ä¸€æ—¦å®ƒæˆåŠŸåœ°æŠ¢å äº†ä»»åŠ¡ï¼Œ<code>DESTROY_CPU</code>å°†è¿è¡Œç¹å¿™å¾ªç¯ï¼Œå¯¼è‡´<code>SCHED_IDLE</code>ä»»åŠ¡è¢«æç½®ã€‚</p>
</li>
<li><p>ç”±äºè¿è¡Œ<code>IOCTL_KGSL_TIMELINE_DESTROY</code>çš„<code>SCHED_IDLE</code>ä»»åŠ¡è¢«æç½®ï¼Œç°åœ¨æœ‰è¶³å¤Ÿçš„æ—¶é—´æ¥å…‹æœ<code>kfree_rcu</code>å¼•å…¥çš„å»¶è¿Ÿï¼Œå¹¶å…è®¸æ­¥éª¤4ä¸­çš„<code>dma_fence</code>è¢«é‡Šæ”¾å’Œæ›¿æ¢ã€‚ä¹‹åï¼Œæ¢å¤<code>IOCTL_KGSL_TIMELINE_DESTROY</code>ï¼Œè¿™æ ·åç»­çš„æ“ä½œå°†åœ¨ç°åœ¨è¢«é‡Šæ”¾å’Œæ›¿æ¢çš„<code>dma_fence</code>å¯¹è±¡ä¸Šæ‰§è¡Œã€‚</p>
</li>
</ol>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºåœ¨çº¿ç¨‹æŒæœ‰è‡ªæ—‹é”çš„æ—¶å€™ä¸èƒ½å‘ç”ŸæŠ¢å ï¼Œæ‰€ä»¥<code>IOCTL_KGSL_TIMELINE_DESTROY</code>åªèƒ½åœ¨è‡ªæ—‹é”ä¹‹é—´çš„çª—å£æœŸæŠ¢å ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    spin_lock(&amp;timeline-&gt;fence_lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;timeline-&gt;fences, node)</span><br><span class="line">      ...</span><br><span class="line">    spin_unlock(&amp;timeline-&gt;fence_lock);</span><br><span class="line">    <span class="comment">//Preemption window</span></span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶ä¸Šé¢çš„æŠ¢å çª—å£çœ‹èµ·æ¥éå¸¸å°ï¼Œä½†åœ¨å®è·µä¸­ï¼Œåªè¦<code>SCHED_NORMAL</code>ä»»åŠ¡è¯•å›¾åœ¨ç¬¬ä¸€ä¸ªè‡ªæ—‹é”è¢«æŒæœ‰æ—¶æŠ¢å è¿è¡Œ<code>IOCTL_KGSL_TIMELINE_DESTROY</code>çš„<code>SCHED_IDLE</code>ä»»åŠ¡ï¼Œä¸€æ—¦è‡ªæ—‹é”è¢«é‡Šæ”¾ï¼ŒæŠ¢å å°±ä¼šå‘ç”Ÿï¼Œè¿™ä½¿å¾—åœ¨æ­£ç¡®çš„æ—¶é—´æŠ¢å <code>IOCTL_KGSL_TIMELINE_DESTROY</code>æ›´å®¹æ˜“æˆåŠŸã€‚</p>
<p>ä¸‹å›¾çº¢è‰²å—è¡¨ç¤ºæŒæœ‰è‡ªæ—‹é”çš„åŒºåŸŸï¼Œå› æ­¤ä¸å¯èƒ½æŠ¢å ï¼Œè™šçº¿è¡¨ç¤ºé—²ç½®çš„ä»»åŠ¡ï¼š</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-2.webp" alt="Kernel-2"></p>
<p>å¯¹äºå¯¹è±¡çš„æ›¿æ¢ï¼Œä½¿ç”¨<a target="_blank" rel="noopener" href="https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part3.html"><code>sendmsg</code></a>ï¼Œè¿™æ˜¯ä¸€ç§æ ‡å‡†çš„æ–¹æ³•ï¼Œå¯ä»¥ç”¨å—æ§æ•°æ®æ›¿æ¢linuxå†…æ ¸ä¸­çš„å·²é‡Šæ”¾çš„å¯¹è±¡ã€‚ä¸‹é¢æ˜¯å‡å¯¹è±¡æ˜¯å¦‚ä½•è¢«ä½¿ç”¨çš„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">    dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">    dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">    dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">&#125;</span><br><span class="line">spin_unlock_irq(&amp;timeline-&gt;lock);</span><br></pre></td></tr></table></figure>

<p>ä¸‰ä¸ªä¸åŒçš„å‡½æ•°ï¼Œ<code>dma_fence_set_error</code>ã€<code>dma_fence_signal_locked</code>å’Œ<code>dma_fence_put</code>å°†è¢«è°ƒç”¨ï¼Œå‚æ•°ä¸º<code>fence</code>ã€‚å‡½æ•°<code>dma_fence_set_error</code>å°†å‘<code>fence</code>å¯¹è±¡å†™ä¸€ä¸ªé”™è¯¯ä»£ç ï¼Œè¿™å¯èƒ½å¯¹åˆé€‚çš„å¯¹è±¡æ›¿æ¢æœ‰ç”¨ï¼Œä½†å¯¹<code>sendmsg</code>å¯¹è±¡æ›¿æ¢æ²¡æœ‰ç”¨ï¼Œå‡½æ•°<code>dma_fence_signal_locked</code>å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">dma_fence_signal_locked</span><span class="params">(<span class="keyword">struct</span> dma_fence *fence)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (unlikely(test_and_set_bit(DMA_FENCE_FLAG_SIGNALED_BIT,   <span class="comment">//&lt;-- 1.</span></span><br><span class="line">                      &amp;fence-&gt;flags)))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Stash the cb_list before replacing it with the timestamp */</span></span><br><span class="line">    list_replace(&amp;fence-&gt;cb_list, &amp;cb_list);                    <span class="comment">//&lt;-- 2.</span></span><br><span class="line">    ...</span><br><span class="line">    list_for_each_entry_safe(cur, tmp, &amp;cb_list, node) &#123;        <span class="comment">//&lt;-- 3.</span></span><br><span class="line">        INIT_LIST_HEAD(&amp;cur-&gt;node);</span><br><span class="line">        cur-&gt;func(fence, cur);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆæ£€æŸ¥<code>fence-&gt;flags</code>ï¼ˆ1ï¼‰ï¼šå¦‚æœ<code>DMA_FENCE_FLAG_SIGNALED_BIT</code>æ ‡å¿—è¢«è®¾ç½®ï¼Œé‚£ä¹ˆ<code>fence</code>å·²ç»è¢«ä¿¡å·åŒ–ï¼Œå‡½æ•°é€€å‡ºã€‚å¦‚æœ<code>fence</code>æ²¡æœ‰è¢«å‘å‡ºä¿¡å·ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨<code>list_replace</code>æ¥ç§»é™¤<code>fence-&gt;cb_list</code>ä¸­çš„å¯¹è±¡ï¼Œå¹¶å°†å…¶æ”¾å…¥ä¸´æ—¶<code>cb_list</code>ä¸­ï¼ˆ2ï¼‰ ä¹‹åï¼Œå­˜å‚¨åœ¨<code>cb_list</code>ä¸­çš„å‡½æ•°è¢«è°ƒç”¨ï¼ˆ3ï¼‰ã€‚æ­£å¦‚åœ¨ <code>kCFI </code>ä¸€èŠ‚ä¸­è§£é‡Šçš„é‚£æ ·ï¼Œå› ä¸º<code>CFI</code>çš„ç¼“è§£ï¼Œè¿™å°†åªå…è®¸è°ƒç”¨æŸç§ç±»å‹çš„å‡½æ•°ï¼›æ­¤å¤–ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µï¼Œç”±äºå¯¹å‡½æ•°åœ°å€ä¸€æ— æ‰€çŸ¥ï¼Œæ‰€ä»¥å¦‚æœèµ°åˆ°è¾¾è¿™ä¸ªè·¯å¾„ï¼Œå¾ˆå¯èƒ½åªä¼šè®©å†…æ ¸å´©æºƒã€‚æ‰€ä»¥ï¼Œåªèƒ½åœ¨å‡å¯¹è±¡ä¸­è®¾ç½®<code>DMA_FENCE_FLAG_SIGNALED_BIT</code>æ ‡å¿—ï¼Œè®©<code>dma_fence_signal_locked</code>æå‰é€€å‡ºã€‚</p>
<p>åªå‰©ä¸‹äº†ã€<code>dma_fence_put</code>å‡½æ•°ï¼Œå®ƒå‡å°‘<code>fence</code>çš„<code>refcount</code>ï¼Œå¹¶åœ¨<code>refcount</code>è¾¾åˆ°0æ—¶è°ƒç”¨<code>dma_fence_release</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">dma_fence_release</span><span class="params">(<span class="keyword">struct</span> kref *kref)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (fence-&gt;ops-&gt;release)</span><br><span class="line">        fence-&gt;ops-&gt;release(fence);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        dma_fence_free(fence);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè°ƒç”¨<code>dma_fence_release</code>ï¼Œé‚£ä¹ˆæœ€ç»ˆä¼šæ£€æŸ¥<code>fence-&gt;ops</code>å¹¶è°ƒç”¨<code>fence-&gt;ops-&gt;release</code>ã€‚è¿™å°±æœ‰ä¸¤ä¸ªé—®é¢˜ã€‚é¦–å…ˆï¼Œ<code>fence-&gt;ops</code>éœ€è¦æŒ‡å‘æœ‰æ•ˆçš„å†…å­˜ï¼Œå¦åˆ™è§£é™¤å¼•ç”¨å°±ä¼šå¤±è´¥ï¼Œå³ä½¿è§£é™¤å¼•ç”¨æˆåŠŸï¼Œ<code>fence-&gt;ops-&gt;release</code>è¦ä¹ˆéœ€è¦ä¸ºé›¶ï¼Œè¦ä¹ˆå¿…é¡»æ˜¯ä¸€ä¸ªé€‚å½“ç±»å‹çš„å‡½æ•°çš„åœ°å€ã€‚</p>
<p>æ‰€æœ‰è¿™äº›ç»™äº†ä¸¤ä¸ªé€‰æ‹©ã€‚å¯ä»¥éµå¾ªæ ‡å‡†è·¯å¾„ï¼šå°è¯•ç”¨å¦ä¸€ä¸ªå¯¹è±¡æ›¿æ¢æ …æ å¯¹è±¡ï¼Œæˆ–è€…å°è¯•åˆ©ç”¨<code>dma_fence_put</code>å’Œ<code>dma_fence_set_error</code>æä¾›çš„æœ‰é™çš„å†™åŸè¯­ï¼ŒåŒæ—¶å¸Œæœ›ä»ç„¶å¯ä»¥æ§åˆ¶<code>flags</code>å’Œ<code>refcount</code>å­—æ®µä»¥é¿å…<code>dma_fence_signal_locked</code>æˆ–<code>dma_fence_release</code>ä½¿å†…æ ¸å´©æºƒã€‚</p>
<h2 id="The-ultimate-fake-object-store"><a href="#The-ultimate-fake-object-store" class="headerlink" title="The ultimate fake object store"></a>The ultimate fake object store</h2><p>åœ¨åˆ©ç”¨å¦ä¸€ä¸ª<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/one_day_short_of_a_fullchain_android/">é”™è¯¯</a>æ—¶ï¼Œä½œè€…å‘ç°äº†è½¯ä»¶è¾“å…¥è¾“å‡ºè½¬æ¢æ—è§‚ç¼“å†²åŒºï¼ˆ<code>SWIOTLB</code>ï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªåœ¨å¯åŠ¨æ—¶å¾ˆæ—©å°±åˆ†é…çš„å†…å­˜åŒºåŸŸã€‚å› æ­¤ï¼Œ<code>SWIOTLB</code>çš„ç‰©ç†åœ°å€æ˜¯éå¸¸å›ºå®šçš„ï¼Œåªå–å†³äºç¡¬ä»¶é…ç½®ã€‚æ­¤å¤–ï¼Œç”±äºè¯¥å†…å­˜ä½äº â€œä½å†…å­˜ â€œåŒºåŸŸï¼ˆAndroidè®¾å¤‡ä¼¼ä¹æ²¡æœ‰ â€œé«˜å†…å­˜ â€œåŒºåŸŸï¼‰ï¼Œå¹¶ä¸”ä¸åœ¨å†…æ ¸é•œåƒä¸­ï¼Œå› æ­¤è™šæ‹Ÿåœ°å€åªæ˜¯å¸¦æœ‰å›ºå®šåç§»çš„ç‰©ç†åœ°å€ï¼ˆå¯¹ç»†èŠ‚æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å…³æ³¨<code>kmap</code>å‡½æ•°çš„å®ç°ï¼‰:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __virt_to_phys_nodebug(x) (&#123;                   \</span></span><br><span class="line"><span class="meta">    phys_addr_t __x = (phys_addr_t)(__tag_reset(x));        \</span></span><br><span class="line"><span class="meta">    __is_lm_address(__x) ? __lm_to_phys(__x) : __kimg_to_phys(__x); \</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __is_lm_address(addr)  (!(((u64)addr) &amp; BIT(vabits_actual - 1)))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __lm_to_phys(addr) (((addr) + physvirt_offset))</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°å®šä¹‰æ¥è‡ª<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/include/asm/memory.h"><code>arch/arm64/include/asm/memory.h</code></a>ï¼Œå®ƒæ˜¯Androidçš„ç›¸å…³å®ç°ã€‚ç”¨äºç¿»è¯‘åœ°å€çš„å˜é‡<code>physvirt_offset</code>æ˜¯åœ¨<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/mm/init.c#L517"><code>arm64_memblock_init</code></a>ä¸­è®¾ç½®çš„ä¸€ä¸ªå›ºå®šå¸¸æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __init <span class="title function_">arm64_memblock_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;...</span><br><span class="line">    memstart_addr = round_down(memblock_start_of_DRAM(),</span><br><span class="line">                   ARM64_MEMSTART_ALIGN);</span><br><span class="line">    physvirt_offset = PHYS_OFFSET - PAGE_OFFSET;</span><br><span class="line"></span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é™¤æ­¤ä¹‹å¤–ï¼Œ<code>SWIOTLB</code>ä¸­çš„å†…å­˜å¯ä»¥é€šè¿‡<code>adsp</code>é©±åŠ¨è®¿é—®ï¼Œè€Œ<code>adsp</code>é©±åŠ¨æ˜¯å¯ä»¥ä»ä¸€ä¸ªä¸å—ä¿¡ä»»çš„åº”ç”¨ç¨‹åºä¸­åˆ°è¾¾çš„ï¼Œæ‰€ä»¥è¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªå­˜å‚¨å‡å¯¹è±¡å’Œé‡å®šå‘å‡æŒ‡é’ˆçš„å¥½åœ°æ–¹ã€‚ç„¶è€Œï¼Œåœ¨5.xç‰ˆæœ¬çš„å†…æ ¸ä¸­ï¼Œ<code>SWIOTLB</code>åªæœ‰åœ¨ç”¨<code>CONFIG_DMA_ZONE32</code>æ ‡å¿—ç¼–è¯‘å†…æ ¸æ—¶æ‰ä¼šè¢«åˆ†é…ï¼Œè€ŒZ Flip3 ä¸æ˜¯è¿™ç§æƒ…å†µã€‚</p>
<p>ç„¶è€Œï¼Œè¿˜æœ‰æ›´å¥½çš„ä¸œè¥¿ã€‚<code>SWIOTLB</code>çš„æ—©æœŸåˆ†é…ç»™äº†å®ƒä¸€ä¸ªå¯é¢„æµ‹çš„åœ°å€ï¼Œè¿™ä¿ƒä½¿ä½œè€…æ£€æŸ¥å¯åŠ¨æ—¥å¿—ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰å…¶ä»–çš„å†…å­˜åŒºåŸŸåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­è¢«æå‰åˆ†é…ï¼Œç»“æœå‘ç°ç¡®å®æœ‰å…¶ä»–çš„å†…å­˜åŒºåŸŸåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­è¢«å¾ˆæ—©åœ°åˆ†é…ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;6&gt;[    0.000000] [0:        swapper:    0]  Reserved memory: created CMA memory pool at 0x00000000f2800000, size 212 MiB</span><br><span class="line">&lt;6&gt;[    0.000000] [0:        swapper:    0]  OF: reserved mem: initialized node secure_display_region, compatible <span class="built_in">id</span> shared-dma-pool</span><br><span class="line">...</span><br><span class="line">&lt;6&gt;[    0.000000] [0:        swapper:    0]  OF: reserved mem: initialized node user_contig_region, compatible <span class="built_in">id</span> shared-dma-pool</span><br><span class="line">&lt;6&gt;[    0.000000] [0:        swapper:    0]  Reserved memory: created CMA memory pool at 0x00000000f0c00000, size 12 MiB</span><br><span class="line"></span><br><span class="line">&lt;6&gt;[    0.578613] [7:      swapper/0:    1]  platform soc:qcom,ion:qcom,ion-heap@22: assigned reserved memory node sdsp_region</span><br><span class="line">...</span><br><span class="line">&lt;6&gt;[    0.578829] [7:      swapper/0:    1]  platform soc:qcom,ion:qcom,ion-heap@26: assigned reserved memory node user_contig_region</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä¿ç•™å†…å­˜åŒºåŸŸä¼¼ä¹æ˜¯ç”¨äºåˆ†é…<code>ion</code>ç¼“å†²åŒºçš„å†…å­˜æ± ã€‚</p>
<p>åœ¨Androidä¸Šï¼Œ<code>ion_allocator</code>è¢«ç”¨æ¥åˆ†é…ç”¨äº<code>DMA</code>ï¼ˆç›´æ¥å†…å­˜è®¿é—®ï¼‰çš„å†…å­˜åŒºåŸŸï¼Œå…è®¸å†…æ ¸é©±åŠ¨å’Œç”¨æˆ·ç©ºé—´è¿›ç¨‹å…±äº«åŒä¸€åº•å±‚å†…å­˜ã€‚æœªå—ä¿¡ä»»çš„åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡<code>/dev/ion</code>æ–‡ä»¶è®¿é—®<code>ion</code>åˆ†é…å™¨ï¼Œ<code>ION_IOC_ALLOC</code> <code>ioctl</code>å¯ä»¥ç”¨æ¥åˆ†é…ä¸€ä¸ª<code>ion</code>ç¼“å†²åŒºã€‚è¯¥<code>ioctl</code>å‘ç”¨æˆ·è¿”å›ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç„¶åå¯ä»¥åœ¨<code>mmap syscall</code>ä¸­ä½¿ç”¨ï¼Œå°†<code>ion</code>ç¼“å†²åŒºçš„åå¤‡å­˜å‚¨æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p>
<p>ä½¿ç”¨<code>ion</code>ç¼“å†²åŒºçš„ä¸€ä¸ªç‰¹æ®ŠåŸå› æ˜¯ï¼Œç”¨æˆ·å¯ä»¥è¯·æ±‚å…·æœ‰è¿ç»­ç‰©ç†åœ°å€çš„å†…å­˜ã€‚è¿™ä¸€ç‚¹ç‰¹åˆ«é‡è¦ï¼Œå› ä¸ºæœ‰äº›è®¾å¤‡ï¼ˆå¦‚ç¡¬ä»¶ä¸Šçš„è®¾å¤‡ï¼Œè€Œä¸æ˜¯æ‰‹æœºæœ¬èº«ï¼‰ç›´æ¥è®¿é—®ç‰©ç†å†…å­˜ï¼Œæ‹¥æœ‰è¿ç»­çš„å†…å­˜åœ°å€å¯ä»¥å¤§å¤§æ”¹å–„è¿™ç§å†…å­˜è®¿é—®çš„æ€§èƒ½ï¼Œè€Œæœ‰äº›è®¾å¤‡ä¸èƒ½å¤„ç†éè¿ç»­çš„ç‰©ç†å†…å­˜ã€‚</p>
<p>ä¸<code>SWIOTLB</code>ç±»ä¼¼ï¼Œä¸ºäº†ç¡®ä¿å…·æœ‰è¯·æ±‚å¤§å°çš„è¿ç»­ç‰©ç†å†…å­˜åŒºåŸŸå¯ç”¨ï¼Œ<code>ion</code>é©±åŠ¨åœ¨å¯åŠ¨åˆæœŸå°±åˆ†é…äº†è¿™äº›å†…å­˜åŒºåŸŸï¼Œå¹¶å°†å…¶ä½œä¸ºå†…å­˜æ± ï¼ˆâ€åˆ’å‡ºçš„åŒºåŸŸâ€ï¼‰ï¼Œç„¶ååœ¨ä»¥åçš„è¯·æ±‚ä¸­ç”¨äºåˆ†é…<code>ion</code>ç¼“å†²åŒºã€‚å¹¶é<code>ion</code>è®¾å¤‡ä¸­çš„æ‰€æœ‰å†…å­˜æ± éƒ½æ˜¯è¿ç»­çš„å†…å­˜ï¼ˆä¾‹å¦‚ï¼Œé€šç”¨çš„ â€œç³»ç»Ÿå † â€œå¯èƒ½ä¸æ˜¯ç‰©ç†ä¸Šè¿ç»­çš„åŒºåŸŸï¼‰ï¼Œä½†æ˜¯ç”¨æˆ·å¯ä»¥åœ¨ä½¿ç”¨<code>ION_IOC_ALLOC</code>æ—¶æŒ‡å®š<code>heap_id_mask</code>æ¥æŒ‡å®šå…·æœ‰ç‰¹å®šå±æ€§ï¼ˆä¾‹å¦‚ï¼Œè¿ç»­çš„ç‰©ç†å†…å­˜ï¼‰çš„<code>ion</code>å †ã€‚</p>
<p>è¿™äº›å†…å­˜æ± åœ¨å¦‚æ­¤æ—©çš„é˜¶æ®µè¢«åˆ†é…ï¼Œæ„å‘³ç€å®ƒä»¬çš„åœ°å€æ˜¯å¯é¢„æµ‹çš„ï¼Œåªå–å†³äºç¡¬ä»¶çš„é…ç½®ï¼ˆè®¾å¤‡æ ‘ã€å¯ç”¨å†…å­˜ã€å†…å­˜èµ·å§‹åœ°å€ã€å„ç§å¯åŠ¨å‚æ•°ç­‰ï¼‰ã€‚è¿™å°¤å…¶æ„å‘³ç€ï¼Œå¦‚æœä½¿ç”¨<code>ION_IOC_ALLOC</code>ä»ä¸€ä¸ªå¾ˆå°‘ä½¿ç”¨çš„å†…å­˜æ± ä¸­åˆ†é…ä¸€ä¸ª<code>ion</code>ç¼“å†²åŒºï¼Œè¿™ä¸ªç¼“å†²åŒºå¾ˆå¯èƒ½è¢«åˆ†é…åˆ°ä¸€ä¸ªå¯é¢„æµ‹çš„åœ°å€ã€‚å¦‚æœä½¿ç”¨<code>mmap</code>å°†ç¼“å†²åŒºæ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå°±å¯ä»¥åœ¨ä»»ä½•æ—¶å€™è®¿é—®è¿™ä¸ªå¯é¢„æµ‹åœ°å€çš„å†…å­˜äº†ã€‚</p>
<p>ç»è¿‡ä¸€äº›å®éªŒï¼Œä¼¼ä¹<code>user_contig_region</code>å‡ ä¹ä»æœªè¢«ä½¿ç”¨ï¼Œæ¯æ¬¡éƒ½èƒ½æŠŠæ•´ä¸ªåŒºåŸŸæ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ã€‚æ‰€ä»¥åœ¨è¿™ä¸ªæ¼æ´ä¸­ï¼Œä½œè€…ä½¿ç”¨äº†è¿™ä¸ªå†…å­˜æ± ï¼Œå¹¶å‡è®¾å¯ä»¥åˆ†é…æ•´ä¸ªåŒºåŸŸä»¥ä¿æŒç®€å•ã€‚(åœ¨ä¸å½±å“å¯é æ€§çš„æƒ…å†µä¸‹ï¼Œä¿®æ”¹æ¼æ´ä»¥é€‚åº”éƒ¨åˆ†åŒºåŸŸä¸å¯ç”¨çš„æƒ…å†µæ˜¯å¾ˆå®¹æ˜“çš„)ã€‚</p>
<p>ç°åœ¨èƒ½å¤ŸæŠŠå—æ§çš„æ•°æ®æ”¾åœ¨ä¸€ä¸ªå¯é¢„æµ‹çš„åœ°å€ä¸Šï¼Œå¯ä»¥è§£å†³ä¹‹å‰åœ¨åˆ©ç”¨ä¸­é‡åˆ°çš„é—®é¢˜ã€‚å›é¡¾ä¸€ä¸‹ï¼Œå½“<code>dma_fence_release</code>åœ¨å‡ <code>fence</code> å¯¹è±¡ä¸Šè¢«è°ƒç”¨æ—¶ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">dma_fence_release</span><span class="params">(<span class="keyword">struct</span> kref *kref)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (fence-&gt;ops-&gt;release)</span><br><span class="line">        fence-&gt;ops-&gt;release(fence);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        dma_fence_free(fence);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œéœ€è¦<code>fence-&gt;ops</code>æŒ‡å‘ä¸€ä¸ªåŒ…å«æ‰€æœ‰é›¶çš„æœ‰æ•ˆåœ°å€ï¼Œè¿™æ ·<code>fence-&gt;ops-&gt;release</code>å°±ä¸ä¼šè¢«è°ƒç”¨ï¼ˆå› ä¸ºåœ¨è¿™ä¸ªé˜¶æ®µæ²¡æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„å‡½æ•°åœ°å€ä¸<code>fence-&gt;ops-&gt;release</code>çš„ç­¾åç›¸åŒ¹é…ï¼Œèµ°è¿™ä¸ªè·¯å¾„ä¼šä½¿å†…æ ¸å´©æºƒï¼‰ã€‚</p>
<p>ç”±äº<code>ion</code>ç¼“å†²åŒºåœ¨ä¸€ä¸ªå¯é¢„æµ‹çš„åœ°å€ä¸Šï¼Œå¯ä»¥ç®€å•åœ°æŠŠå®ƒå¡«ä¸ºé›¶ï¼Œè®©<code>fence-&gt;ops</code>æŒ‡å‘é‚£é‡Œã€‚è¿™å°†ç¡®ä¿<code>dma_fence_free</code>è·¯å¾„è¢«é‡‡å–ï¼Œç„¶åé‡Šæ”¾å‡å¯¹è±¡ï¼Œå½¢æˆä¸€ä¸ª<code>double free</code>çš„åŸå½¢ï¼ŒåŒæ—¶é˜²æ­¢å†…æ ¸å´©æºƒã€‚åœ¨ç»§ç»­åˆ©ç”¨è¿™ä¸ª<code>double free</code>åŸè¯­ä¹‹å‰ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦é¦–å…ˆè§£å†³ã€‚</p>
<h2 id="Escaping-an-infinite-loop"><a href="#Escaping-an-infinite-loop" class="headerlink" title="Escaping an infinite loop"></a>Escaping an infinite loop</h2><p>å›é¡¾ä¸€ä¸‹ï¼Œåœ¨<code>kgsl_ioctl_timeline_destroy</code>å‡½æ•°ä¸­ï¼Œåœ¨<code>fence</code>å¯¹è±¡è¢«é”€æ¯å’Œæ›¿æ¢åï¼Œä¼šæ‰§è¡Œä»¥ä¸‹å¾ªç¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">    dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">    dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">    dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">&#125;</span><br><span class="line">spin_unlock_irq(&amp;timeline-&gt;lock);</span><br></pre></td></tr></table></figure>

<p><code>list_for_each_entry_safe</code> å°†é¦–å…ˆä» <code>list_head</code> <code>temp</code> ä¸­è·å–ä¸‹ä¸€ä¸ªæŒ‡é’ˆï¼Œæ‰¾åˆ°åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ª<code>fence</code>æ¡ç›®ï¼Œç„¶åé€šè¿‡è·Ÿè¸ª <code>fence-&gt;node</code> ä¸­çš„ä¸‹ä¸€ä¸ªæŒ‡é’ˆè¿›è¡Œè¿­ä»£ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªæ¡ç›®å†æ¬¡æŒ‡å‘ <code>temp</code>ã€‚å¦‚æœä¸‹ä¸€ä¸ªæ¡ç›®æ²¡æœ‰æŒ‡å‘<code>temp</code>ï¼Œé‚£ä¹ˆè¿™ä¸ªå¾ªç¯å°±ä¼šç»§ç»­ã€‚è¿™æ˜¯ä¸€ä¸ªå˜é‡åˆå§‹åŒ–ä½¿åˆ©ç”¨æ›´åŠ å›°éš¾çš„åœ°æ–¹ã€‚çœ‹çœ‹<code>kgsl_timeline_fence</code>çš„ç»“æ„ï¼Œå®ƒåµŒå…¥äº†ä¸€ä¸ª<code>dma_fence</code>å¯¹è±¡ï¼Œè¢«æ·»åŠ åˆ°<code>kgsl_timeline</code>ä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kgsl_timeline_fence</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dma_fence</span> <span class="title">base</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kgsl_timeline</span> *<span class="title">timeline</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°<code>node</code>å­—æ®µæ˜¯<code>kgsl_timeline_fence</code>ä¸­çš„æœ€åä¸€ä¸ªå­—æ®µï¼Œè€Œä¸ºäº†æ„å»ºè¿™ä¸ªæ¼æ´ï¼Œåªéœ€è¦ç”¨å—æ§æ•°æ®æ›¿æ¢<code>base</code>ã€‚å¦‚æœç”¨éƒ¨åˆ†å¯¹è±¡æ›¿æ¢ï¼Œä¸Šè¿°é—®é¢˜å°±ä¼šå¾ˆå®¹æ˜“è§£å†³äº†ã€‚åœ¨æ²¡æœ‰è‡ªåŠ¨å˜é‡åˆå§‹åŒ–çš„æƒ…å†µä¸‹ï¼Œå¦‚æœåªå°†é‡Šæ”¾çš„<code>kgsl_timeline_fence</code>æ›¿æ¢æˆä¸€ä¸ª<code>dma_fence</code>å¤§å°çš„å¯¹è±¡ï¼Œé‚£ä¹ˆå­—æ®µ<code>timeline</code>å’Œ<code>node</code>å°†ä¿æŒä¸å˜ï¼Œå¹¶åŒ…å«æœ‰æ•ˆæ•°æ®ã€‚è¿™å°†å¯¼è‡´<code>node</code>ä¸­çš„ä¸‹ä¸€ä¸ªæŒ‡é’ˆæœ‰æ•ˆï¼Œå¹¶å…è®¸<code>kgsl_ioctl_timeline_destroy</code>çš„å¾ªç¯æ­£å¸¸é€€å‡ºã€‚ç„¶è€Œï¼Œåœ¨è‡ªåŠ¨å˜é‡åˆå§‹åŒ–çš„æƒ…å†µä¸‹ï¼Œå³ä½¿æŠŠé‡Šæ”¾çš„<code>kgsl_timeline_fence</code>å¯¹è±¡æ¢æˆä¸€ä¸ªæ›´å°çš„å¯¹è±¡ï¼Œæ•´ä¸ªå†…å­˜å—ä¹Ÿä¼šé¦–å…ˆè¢«è®¾ç½®ä¸ºé›¶ï¼ŒæŠ¹å»<code>kgsl_timeline</code>å’Œ<code>node</code>ï¼Œè¿™æ„å‘³ç€å¿…é¡»ä¼ªé€ <code>node</code>å­—æ®µï¼Œä»¥ä¾¿ï¼š</p>
<ol>
<li>ä¸‹ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªæœ‰æ•ˆçš„åœ°å€ï¼Œä»¥é¿å…ç«‹å³å´©æºƒï¼Œäº‹å®ä¸Šï¼Œä¸æ­¢å¦‚æ­¤ï¼Œå®ƒéœ€è¦æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯å¦ä¸€ä¸ªå‡çš„<code>kgsl_timeline_fence</code>ï¼Œå¯ä»¥è¢«å¾ªç¯ä¸­çš„å‡½æ•°ï¼ˆ<code>dma_fence_set_error</code>ã€<code>dma_fence_signal_locked</code>å’Œ<code>dma_fence_put</code>ï¼‰æ“ä½œè€Œä¸å´©æºƒã€‚è¿™æ„å‘³ç€éœ€è¦åˆ¶ä½œæ›´å¤šçš„å‡å¯¹è±¡ã€‚</li>
<li>è¿™äº›å‡çš„<code>kgsl_timeline_fence</code>å¯¹è±¡ä¸­çš„ä¸€ä¸ªä¸‹ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘äº†é€€å‡ºå¾ªç¯çš„<code>temp</code>åˆ—è¡¨ï¼Œè¿™æ˜¯ä¸€ä¸ªå †æ ˆåˆ†é…çš„å˜é‡ã€‚</li>
</ol>
<p>ç¬¬ä¸€ä¸ªè¦æ±‚å¹¶ä¸éš¾ï¼Œå› ä¸ºç°åœ¨å¯ä»¥ä½¿ç”¨<code>ion</code>ç¼“å†²å™¨æ¥åˆ›å»ºè¿™äº›å‡çš„<code>kgsl_timeline_fence</code>å¯¹è±¡ã€‚ç„¶è€Œï¼Œç¬¬äºŒä¸ªè¦æ±‚åˆ™è¦éš¾å¾—å¤šï¼š</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-4.webp" alt="Kernel-4"></p>
<p>è¿™å°†å¯¼è‡´ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œå¹¶è€½è¯¯CPUã€‚è™½ç„¶å®ƒå¾ˆéš¾çœ‹ï¼Œä½†å‡çš„å¯¹è±¡åº”è¯¥èƒ½è§£å†³å–æ¶ˆå¼•ç”¨çš„é—®é¢˜å¹¶é¿å…å´©æºƒï¼Œæ‰€ä»¥å®ƒå¯èƒ½ä¸æ˜¯ä¸€ä¸ªè‡´å‘½çš„é—®é¢˜ã€‚ä¸å¹¸çš„æ˜¯ï¼Œç”±äºè¯¥å¾ªç¯åœ¨è‡ªæ—‹é”å†…è¿è¡Œï¼Œåœ¨è¿è¡Œäº†ä¸€å°æ®µæ—¶é—´åï¼Œçœ‹é—¨ç‹—ä¼¼ä¹ä¼šå°†å…¶æ ‡è®°ä¸ºå ç”¨CPUçš„é—®é¢˜å¹¶è§¦å‘å†…æ ¸ææ…Œã€‚æ‰€ä»¥ï¼Œéœ€è¦æ‰¾åˆ°ä¸€ç§æ–¹æ³•æ¥é€€å‡ºå¾ªç¯ï¼Œè€Œä¸”æ˜¯å¿«é€Ÿé€€å‡ºã€‚</p>
<p>çœ‹çœ‹å‡½æ•°<code>dma_fence_signal_locked</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">dma_fence_signal_locked</span><span class="params">(<span class="keyword">struct</span> dma_fence *fence)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">cb_list</span>;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* Stash the cb_list before replacing it with the timestamp */</span></span><br><span class="line">    list_replace(&amp;fence-&gt;cb_list, &amp;cb_list);             <span class="comment">//&lt;-- 1.</span></span><br><span class="line">    ...</span><br><span class="line">    list_for_each_entry_safe(cur, tmp, &amp;cb_list, node) &#123; <span class="comment">//&lt;-- 2.</span></span><br><span class="line">        INIT_LIST_HEAD(&amp;cur-&gt;node);</span><br><span class="line">        cur-&gt;func(fence, cur);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°å°†å¯¹åˆ—è¡¨<code>temp</code>ä¸­çš„æ¯ä¸ªå‡<code>dma_fence</code>ï¼ˆåŸå§‹å·²é‡Šæ”¾çš„å’Œæ›¿æ¢çš„<code>dma_fence</code>ï¼ŒåŠ ä¸Šå®ƒåœ¨<code>ion buffer</code>ä¸­é“¾æ¥çš„é‚£äº›ï¼‰è¿è¡Œã€‚å¦‚å‰æ‰€è¿°ï¼Œå¦‚æœè¿è¡Œä¸Šé¢2å¤„çš„ä»£ç ï¼Œé‚£ä¹ˆå†…æ ¸å¯èƒ½ä¼šå´©æºƒï¼Œå› ä¸ºä¸èƒ½æä¾›ä¸€ä¸ªæœ‰æ•ˆçš„<code>func</code>ï¼Œæ‰€ä»¥è¿˜æ˜¯é¿å…è¿è¡Œè¿™ä¸ªè·¯å¾„ã€‚</p>
<p>ä¸ºäº†èƒ½å¤Ÿè¿è¡Œè¿™æ®µä»£ç è€Œä¸æ˜¯ä¸Šé¢2ä¸­çš„å¾ªç¯ä»£ç ï¼Œéœ€è¦å°†<code>fence.cb_list</code>åˆå§‹åŒ–ä¸ºä¸€ä¸ªç©ºåˆ—è¡¨ï¼Œè¿™æ ·å®ƒçš„<code>next</code>å’Œ<code>prev</code>éƒ½æŒ‡å‘å®ƒè‡ªå·±ã€‚è¿™å¯¹äºè¢«æ¼æ´é‡Šæ”¾çš„åˆå§‹å‡<code>dma_fence</code>æ¥è¯´æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸º<code>fence</code>çš„åœ°å€ä»¥åŠ<code>fence.cb_list</code>æ˜¯æœªçŸ¥çš„ï¼Œæ‰€ä»¥ä¸å¾—ä¸å¯¹è¿™ä¸ªç¬¬ä¸€ä¸ªå‡å¯¹è±¡å®Œå…¨é¿å…ä½¿ç”¨<code>list_replace</code>ä»£ç ã€‚ç„¶è€Œï¼Œç”±äºéšåé“¾æ¥åˆ°å®ƒçš„å‡<code>dma_fence</code>å¯¹è±¡æ˜¯åœ¨ä¸€ä¸ªå·²çŸ¥åœ°å€çš„<code>ion</code>ç¼“å†²åŒºä¸­ï¼Œç°åœ¨å¯ä»¥ä¸ºè¿™äº›å¯¹è±¡åˆ›å»ºä¸€ä¸ªç©ºçš„<code>cb_list</code>ï¼Œå°†<code>next</code>å’Œ<code>prev</code>æŒ‡é’ˆéƒ½è®¾ç½®ä¸º<code>fence.cb_list</code>å­—æ®µçš„åœ°å€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">list_replace</span><span class="params">(<span class="keyword">struct</span> list_head *old,</span></span><br><span class="line"><span class="params">                <span class="keyword">struct</span> list_head *new)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//old-&gt;next = &amp;(fence-&gt;cb_list)</span></span><br><span class="line">    new-&gt;next = old-&gt;next;</span><br><span class="line">    <span class="comment">//new-&gt;next = &amp;(fence-&gt;cb_list) =&gt; fence-&gt;cb_list.prev = &amp;cb_list</span></span><br><span class="line">    new-&gt;next-&gt;prev = new;</span><br><span class="line">    <span class="comment">//new-&gt;prev = fence-&gt;cb_list.prev =&gt; &amp;cb_list</span></span><br><span class="line">    new-&gt;prev = old-&gt;prev;</span><br><span class="line">    <span class="comment">//&amp;cb_list-&gt;next = &amp;cb_list</span></span><br><span class="line">    new-&gt;prev-&gt;next = new;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>list_replace</code>ä¹‹åï¼Œå †æ ˆå˜é‡<code>cb_list</code>çš„åœ°å€å·²ç»è¢«å†™å…¥äº†<code>fence-&gt;cb_list.prev</code>ï¼Œå®ƒåœ¨<code>ion</code>ç¼“å†²åŒºçš„æŸå¤„ã€‚ç”±äº<code>ion</code>ç¼“å†²åŒºè¢«æ˜ å°„åˆ°äº†ç”¨æˆ·ç©ºé—´ï¼Œå¯ä»¥é€šè¿‡è½®è¯¢<code>ion</code>ç¼“å†²åŒºç®€å•åœ°è¯»å–è¿™ä¸ªåœ°å€ã€‚ç”±äº<code>dma_fence_signal_locked</code>æ˜¯åœ¨å †æ ˆå˜é‡<code>temp</code>è¢«åˆ†é…ååœ¨<code>kgsl_ioctl_timeline_destroy</code>é‡Œé¢è¿è¡Œã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">temp</span>;</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        <span class="comment">//cb_list, is a stack variable allocated inside `dma_fence_signal_locked`</span></span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ‰äº†<code>cb_list</code>çš„åœ°å€ï¼Œå°±å¯ä»¥è®¡ç®—<code>temp</code>çš„åœ°å€ï¼Œï¼ˆå®ƒä¸<code>cb_list</code>çš„åœ°å€æœ‰ä¸€ä¸ªå›ºå®šçš„åç§»ï¼‰ï¼Œæ‰€ä»¥é€šè¿‡è½®è¯¢<code>cb_list</code>çš„åœ°å€ï¼Œç„¶åç”¨å®ƒæ¥è®¡ç®—<code>temp</code>çš„åœ°å€ï¼Œå¹¶æŠŠå®ƒå†™å›<code>ion</code>ç¼“å†²åŒºä¸­ä¸€ä¸ªå‡çš„<code>kgsl_timeline_fence</code>å¯¹è±¡çš„ä¸‹ä¸€ä¸ªæŒ‡é’ˆï¼Œå¯ä»¥åœ¨çœ‹é—¨ç‹—å’¬äººä¹‹å‰é€€å‡ºå¾ªç¯ã€‚</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-5.webp" alt="Kernel-5"></p>
<h2 id="Hijacking-the-freelist"><a href="#Hijacking-the-freelist" class="headerlink" title="Hijacking the freelist"></a>Hijacking the freelist</h2><p><code>dma_fence_put</code>å°†å‡å°‘å‡å¯¹è±¡çš„<code>refcount</code>ï¼Œå¦‚æœ<code>refcount</code>è¾¾åˆ°0ï¼Œå®ƒå°†è°ƒç”¨<code>dma_fence_free</code>ï¼Œç„¶åç”¨<code>kfree_rcu</code>é‡Šæ”¾è¯¥å¯¹è±¡ã€‚ç°åœ¨å‡è®¾å‡å¯¹è±¡å°†è¢«<code>kfree_rcu</code>é‡Šæ”¾ã€‚é€šè¿‡ç”¨å¦ä¸€ä¸ªå¯¹è±¡å†æ¬¡æ›¿æ¢è¿™ä¸ªå‡å¯¹è±¡ï¼Œå°±å¯ä»¥å¾—åˆ°å¯¹åŒä¸€ä¸ªå¯¹è±¡çš„ä¸¤ä¸ªå¼•ç”¨ï¼Œå°†èƒ½å¤Ÿåœ¨ä»»ä½•æ—¶å€™ä½¿ç”¨è¿™äº›å¯¹è±¡çš„å¥æŸ„é‡Šæ”¾è¿™äº›å¯¹è±¡ã€‚ä¸€èˆ¬çš„æƒ³æ³•æ˜¯ï¼Œå½“ä¸€ä¸ªå†…å­˜å—è¢«é‡Šæ”¾æ—¶ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªè‡ªç”±å—çš„<code>freelist</code>æŒ‡é’ˆå°†è¢«å†™å…¥å†…å­˜å—çš„å‰8å­—èŠ‚ã€‚å¦‚æœä»ä¸€ä¸ªå¥æŸ„ä¸­é‡Šæ”¾å¯¹è±¡ï¼Œç„¶åç”¨å¦ä¸€ä¸ªå¥æŸ„ä¿®æ”¹è¿™ä¸ªè¢«é‡Šæ”¾çš„å¯¹è±¡çš„å‰8å­—èŠ‚ï¼Œé‚£ä¹ˆå°±å¯ä»¥åŠ«æŒ<code>freelist</code>æŒ‡é’ˆï¼Œè®©å®ƒæŒ‡å‘é€‰æ‹©çš„åœ°å€ï¼Œè¿™å°±æ˜¯ä¸‹ä¸€æ¬¡åˆ†é…å°†å‘ç”Ÿçš„åœ°æ–¹ã€‚</p>
<p>ä¸ºäº†èƒ½å¤Ÿä¿®æ”¹å¯¹è±¡åˆ†é…åçš„å‰8å­—èŠ‚ï¼Œè¿™é‡Œä½¿ç”¨â€œ<a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2020/02/mitigations-are-attack-surface-too.html">Mitigations are attack surface too</a>â€ä¸­ä½¿ç”¨çš„<code>signalfd</code>å¯¹è±¡ã€‚<code>signalfd</code>ç³»ç»Ÿè°ƒç”¨åˆ†é…äº†ä¸€ä¸ª8å­—èŠ‚çš„å¯¹è±¡æ¥å­˜å‚¨<code>signalfd</code>æ–‡ä»¶çš„æ©ç ï¼Œè¿™ä¸ªæ©ç å¯ä»¥ç”±ç”¨æˆ·æŒ‡å®šï¼Œä½†æœ‰ä¸€äº›å°é™åˆ¶ã€‚æ‰€åˆ†é…å¯¹è±¡çš„å¯¿å‘½ä¸è¿”å›ç»™ç”¨æˆ·çš„<code>signalfd</code>æ–‡ä»¶ç›¸è”ç³»ï¼Œå¯ä»¥é€šè¿‡å…³é—­è¯¥æ–‡ä»¶è½»æ¾æ§åˆ¶ã€‚æ­¤å¤–ï¼Œè¿™ä¸ªå¯¹è±¡çš„å‰8ä¸ªå­—èŠ‚å¯ä»¥é€šè¿‡ç”¨ä¸åŒçš„æ©ç å†æ¬¡è°ƒç”¨<code>signalfd</code>æ¥æ”¹å˜ã€‚</p>
<p>ä¸ºäº†åŠ«æŒfreelistæŒ‡é’ˆï¼š</p>
<ol>
<li>è§¦å‘UAF bugï¼Œç”¨ä¸€ä¸ªé€šè¿‡<code>sendmsg</code>åˆ†é…çš„å‡çš„<code>dma_fence</code>å¯¹è±¡æ›¿æ¢å·²é‡Šæ”¾çš„å¯¹è±¡ï¼Œè¿™æ ·<code>dma_fence_free</code>å°†è¢«è°ƒç”¨ï¼Œç”¨<code>kfree_rcu</code>é‡Šæ”¾è¿™ä¸ªå‡å¯¹è±¡ã€‚</li>
<li>ç”¨<code>signalfd</code>å †å–·ï¼Œåœ¨<code>sendmsg</code>å¯¹è±¡è¢«é‡Šæ”¾åï¼Œåœ¨åŒä¸€åœ°å€åˆ†é…å¦ä¸€ä¸ªå¯¹è±¡ã€‚</li>
<li>é‡Šæ”¾<code>sendmsg</code>å¯¹è±¡ï¼Œä½¿<code>freelist</code>æŒ‡é’ˆè¢«å†™å…¥ç¬¬äºŒæ­¥ä¸­<code>signalfd</code>å¯¹è±¡çš„æ©ç ã€‚</li>
<li>ä¿®æ”¹<code>signalfd</code>å¯¹è±¡çš„æ©ç ï¼Œä½¿<code>freelist</code>æŒ‡é’ˆç°åœ¨æŒ‡å‘ä¸€ä¸ªæŒ‡å®šçš„åœ°å€ï¼Œç„¶åå†æ¬¡å †å–·ï¼Œåœ¨è¯¥åœ°å€åˆ†é…å¯¹è±¡ã€‚</li>
</ol>
<p>å¦‚æœå°†<code>freelist</code>æŒ‡é’ˆçš„åœ°å€è®¾ç½®ä¸ºæˆ‘ä»¬æ§åˆ¶çš„<code>ion</code>ç¼“å†²åŒºçš„åœ°å€ï¼Œé‚£ä¹ˆéšåçš„åˆ†é…å°†æŠŠå¯¹è±¡æ”¾å…¥<code>ion</code>ç¼“å†²åŒºï¼Œç„¶åå¯ä»¥éšæ—¶è®¿é—®å’Œä¿®æ”¹ï¼Œå³ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæœ‰è¯»å’Œå†™æƒé™çš„åŒºåŸŸå†…ä¼ªé€ è‡ªå·±çš„å†…æ ¸å †ã€‚</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-6.webp" alt="Kernel-6"></p>
<p>è¿™ä¸ªæ–¹æ¡ˆçš„ä¸»è¦éšœç¢æ¥è‡ªäº<code>kfree_rcu</code>å’Œè¿è¡Œ<code>dma_fence_put</code>çš„<code>CPU</code>åœ¨è°ƒç”¨<code>kfree_rcu</code>åå°†æš‚æ—¶é™·å…¥ä¸€ä¸ªç¹å¿™çš„å¾ªç¯ã€‚å›é¡¾ä¸Šä¸€èŠ‚ï¼Œåœ¨èƒ½å¤Ÿé€šè¿‡å°† <code>temp</code> åˆ—è¡¨çš„åœ°å€å†™å…¥å‡çš„<code>kgsl_timeline_fence::node</code>å¯¹è±¡çš„ä¸‹ä¸€ä¸ªæŒ‡é’ˆæ¥é€€å‡ºå¾ªç¯ä¹‹å‰ï¼Œè¿™ä¸ªå¾ªç¯å°†ä¸€ç›´è¿è¡Œã€‚è¿™æ„å‘³ç€ï¼Œä¸€æ—¦è°ƒç”¨<code>kfree_rcu</code>ï¼Œ<code>dma_fence_put</code>è¢«é€€å‡ºï¼Œè¯¥å¾ªç¯å°†ç»§ç»­å¤„ç†è¿è¡Œ<code>kfree_rcu</code>çš„<code>CPU</code>ä¸Šçš„å…¶ä»–å‡<code>dma_fence</code>å¯¹è±¡ã€‚æ­£å¦‚å‰é¢æ‰€è§£é‡Šçš„ï¼Œ<code>kfree_rcu</code>ä¸ä¼šç«‹å³é‡Šæ”¾ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œæ˜¯å»¶è¿Ÿç§»é™¤ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé‡Šæ”¾å°†å®é™…å‘ç”Ÿåœ¨è°ƒç”¨<code>kfree_rcu</code>çš„åŒä¸€ä¸ª<code>CPU</code>ä¸Šã€‚ç„¶è€Œï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”±äºè¿è¡Œ<code>kfree_rcu</code>çš„<code>CPU</code>å› ä¸ºè¿è¡Œå¾ªç¯è€Œåœ¨ <code>spinlock</code> ä¸­ä¿æŒç¹å¿™ï¼Œå¯¹è±¡å‡ ä¹è‚¯å®šä¸ä¼šåœ¨åŒä¸€ä¸ª<code>CPU</code>ä¸Šè¢«é‡Šæ”¾ã€‚ç›¸åï¼Œä¸€ä¸ªä¸åŒçš„<code>CPU</code>å°†è¢«ç”¨æ¥é‡Šæ”¾è¯¥å¯¹è±¡ã€‚è¿™å¯¼è‡´äº†ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºå¯¹è±¡æ›¿æ¢çš„å¯é æ€§å–å†³äºç”¨äºé‡Šæ”¾å¯¹è±¡çš„<code>CPU</code>ã€‚å½“ä¸€ä¸ªå¯¹è±¡åœ¨<code>CPU</code>ä¸Šè¢«é‡Šæ”¾æ—¶ï¼Œå†…å­˜åˆ†é…å™¨å°†æŠŠå®ƒæ”¾åœ¨æ¯ä¸ª<code>CPU</code>çš„ç¼“å­˜ä¸­ã€‚ç´§æ¥ç€åœ¨åŒä¸€<code>CPU</code>ä¸Šè¿›è¡Œçš„åˆ†é…å°†é¦–å…ˆåœ¨<code>CPU</code>ç¼“å­˜ä¸­å¯»æ‰¾ç©ºé—²ç©ºé—´ï¼Œå¹¶ä¸”å¾ˆå¯èƒ½ä¼šæ›¿æ¢é‚£ä¸ªæ–°é‡Šæ”¾çš„å¯¹è±¡ã€‚ç„¶è€Œï¼Œå¦‚æœåˆ†é…å‘ç”Ÿåœ¨ä¸åŒçš„<code>CPU</code>ä¸Šï¼Œé‚£ä¹ˆå®ƒå¾ˆå¯èƒ½ä¼šæ›¿æ¢ä¸åŒ<code>CPU</code>ç¼“å­˜ä¸­çš„ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä¸æ˜¯æ–°é‡Šæ”¾çš„å¯¹è±¡ã€‚ä¸çŸ¥é“å“ªä¸ª<code>CPU</code>è´Ÿè´£é‡Šæ”¾å¯¹è±¡ï¼Œå†åŠ ä¸Šå¯¹è±¡è¢«é‡Šæ”¾çš„æ—¶é—´ä¸ç¡®å®šï¼ˆå› ä¸º<code>kfree_rcu</code>å¼•å…¥çš„å»¶è¿Ÿï¼‰ï¼Œæ„å‘³ç€å¯èƒ½å¾ˆéš¾æ›¿æ¢å¯¹è±¡ã€‚ç„¶è€Œï¼Œåœ¨å®è·µä¸­ï¼Œç®€å•åœ°è¿è¡Œä¸€ä¸ªå¾ªç¯ï¼Œåœ¨æ¯ä¸ª<code>CPU</code>ä¸Šå–·å°„ç‰©ä½“ï¼Œå¹¶ä»¥ä¸€å®šçš„é—´éš”é‡å¤å–·å°„ï¼Œä»¥è€ƒè™‘åˆ°æ—¶é—´ä¸Šçš„ä¸ç¡®å®šæ€§ï¼ˆæˆåŠŸç‡å¤§äº70%ï¼‰ã€‚</p>
<p>æ¼æ´ä¸­ä½¿ç”¨çš„å¦ä¸€ä¸ªå°ä¿®æ”¹æ˜¯ï¼Œåœ¨<code>sendmsg</code>å¯¹è±¡è¢«é‡Šæ”¾åï¼Œç”¨å¦ä¸€è½®<code>signalfd</code>å †å–·æ¥æ›¿æ¢å®ƒä»¬ã€‚è¿™æ˜¯ä¸ºäº†ç¡®ä¿è¿™äº›<code>sendmsg</code>å¯¹è±¡ä¸ä¼šæ„å¤–åœ°è¢«ä¸æ§åˆ¶çš„å¯¹è±¡æ‰€æ›¿æ¢ï¼Œä»è€Œå¹²æ‰°äº†æ¼æ´çš„åˆ©ç”¨ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸ºäº†æ›´å®¹æ˜“è¯†åˆ«å®é™…è¢«ç ´åçš„å¯¹è±¡ã€‚</p>
<p>ç°åœ¨å¯ä»¥åŠ«æŒ<code>freelist</code>å¹¶å°†æ–°çš„å¯¹è±¡åˆ†é…é‡å®šå‘åˆ°å¯ä»¥éšæ—¶è‡ªç”±è®¿é—®çš„<code>ion</code>ç¼“å†²åŒºï¼Œç°åœ¨éœ€è¦å°†å…¶å˜æˆä¸€ä¸ªä»»æ„çš„å†…å­˜è¯»å†™åŸè¯­ã€‚</p>
<h2 id="The-Device-Memory-Mirroring-Attack"><a href="#The-Device-Memory-Mirroring-Attack" class="headerlink" title="The Device Memory Mirroring Attack"></a>The Device Memory Mirroring Attack</h2><p>å†…æ ¸é©±åŠ¨ç»å¸¸éœ€è¦å°†å†…å­˜æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå› æ­¤ï¼Œç»å¸¸æœ‰ä¸€äº›ç»“æ„åŒ…å«æŒ‡å‘<code>page</code>ç»“æ„æˆ–<code>sg_table</code>ç»“æ„çš„æŒ‡é’ˆã€‚è¿™äº›ç»“æ„é€šå¸¸åŒ…å«æŒ‡å‘é¡µé¢çš„æŒ‡é’ˆï¼Œè¿™äº›é¡µé¢å°†è¢«æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œä¾‹å¦‚ï¼Œå½“è°ƒç”¨<code>mmap</code>æ—¶ã€‚è¿™ä½¿å¾—å®ƒä»¬æˆä¸ºéå¸¸å¥½çš„ç ´åç›®æ ‡ã€‚ä¾‹å¦‚ï¼Œ<code>ion_buffer</code>å¯¹è±¡åœ¨æ‰€æœ‰çš„Androidè®¾å¤‡ä¸Šéƒ½å¯ç”¨ã€‚å®ƒæœ‰ä¸€ä¸ª<code>sg_table</code>ç»“æ„ï¼ŒåŒ…å«äº†å½“<code>mmap</code>è¢«ä½¿ç”¨æ—¶å°†è¢«æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´çš„é¡µé¢çš„ä¿¡æ¯ã€‚</p>
<p>é™¤äº†å¯ä»¥å¹¿æ³›ä½¿ç”¨å’Œä»ä¸å¯ä¿¡ä»»çš„åº”ç”¨ç¨‹åºä¸­è®¿é—®å¤–ï¼Œ<code>ion_buffer</code>å¯¹è±¡è¿˜è§£å†³äº†ä¸€äº›å…¶ä»–é—®é¢˜ï¼Œæ‰€ä»¥åœ¨ä¸‹é¢çš„å†…å®¹ä¸­ï¼Œå°†ä½¿ç”¨ä¸Šé¢çš„<code>freelist</code>åŠ«æŒåŸè¯­ï¼Œåœ¨æœ‰ä»»æ„è¯»å†™æƒé™çš„<code>ion</code>ç¼“å†²åŒºå¤‡ä»½å­˜å‚¨ä¸­åˆ†é…ä¸€ä¸ª<code>ion_buffer</code>ç»“æ„ã€‚é€šè¿‡è¿™æ ·åšï¼Œå¯ä»¥éšæ„ç ´åæ‰€æœ‰è¢«åˆ†é…çš„ <code>ion_buffer</code> ç»“æ„ä¸­çš„æ•°æ®ã€‚ä¸ºäº†é¿å…æ··æ·†ï¼Œä»ç°åœ¨å¼€å§‹ï¼Œå°†ä½¿ç”¨æœ¯è¯­ â€œå‡å†…æ ¸å † â€œæ¥è¡¨ç¤ºç”¨ä½œå‡å†…æ ¸å †çš„<code>ion</code>ç¼“å†²åŒºå¤‡ä»½å­˜å‚¨ï¼Œä»¥åŠåœ¨å‡å†…æ ¸å †ä¸­åˆ†é…çš„ç”¨ä½œç ´åç›®æ ‡çš„ç»“æ„çš„<code>ion_buffer</code>ã€‚</p>
<p>è¿™é‡Œçš„æ€»ä½“æƒ³æ³•æ˜¯ï¼Œé€šè¿‡åœ¨å‡çš„å†…æ ¸å †ä¸­åˆ†é…<code>ion_buffer</code>ç»“æ„ï¼Œå°†èƒ½å¤Ÿä¿®æ”¹<code>ion_buffer</code>ç»“æ„ï¼Œç”¨å—æ§æ•°æ®æ›¿æ¢å…¶<code>sg_table</code>ã€‚<code>sg_table</code>ç»“æ„åŒ…å«ä¸€ä¸ª<code>scatterlist</code>ç»“æ„ï¼Œè¡¨ç¤ºæ”¯æŒ<code>ion_buffer</code>ç»“æ„çš„é¡µé¢é›†åˆã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sg_table</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">scatterlist</span> *<span class="title">sgl</span>;</span>    <span class="comment">/* the list */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> nents;     <span class="comment">/* number of mapped entries */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> orig_nents;    <span class="comment">/* original size of list */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">scatterlist</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>   page_link;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>    offset;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>    length;</span><br><span class="line">    <span class="type">dma_addr_t</span>  dma_address;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NEED_SG_DMA_LENGTH</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>    dma_length;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>scatterlist</code>ä¸­çš„<code>page_link</code>å­—æ®µæ˜¯ä¸€ä¸ªé¡µé¢æŒ‡é’ˆçš„ç¼–ç å½¢å¼ï¼Œè¡¨æ˜<code>ion_buffer</code>ç»“æ„çš„å¤‡ä»½å­˜å‚¨æ‰€åœ¨çš„å®é™…é¡µé¢ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> page *<span class="title function_">sg_page</span><span class="params">(<span class="keyword">struct</span> scatterlist *sg)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_SG</span></span><br><span class="line">    BUG_ON(sg_is_chain(sg));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">struct</span> page *)((sg)-&gt;page_link &amp; ~(SG_CHAIN | SG_END));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“<code>mmap</code>è¢«è°ƒç”¨æ—¶ï¼Œç”±<code>page_link</code>ç¼–ç çš„é¡µé¢å°†è¢«æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">ion_heap_map_user</span><span class="params">(<span class="keyword">struct</span> ion_heap *heap, <span class="keyword">struct</span> ion_buffer *buffer,</span></span><br><span class="line"><span class="params">              <span class="keyword">struct</span> vm_area_struct *vma)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sg_table</span> *<span class="title">table</span> =</span> buffer-&gt;sg_table;</span><br><span class="line">    ...</span><br><span class="line">    for_each_sg(table-&gt;sgl, sg, table-&gt;nents, i) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> sg_page(sg);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//Maps pages to user space</span></span><br><span class="line">        ret = remap_pfn_range(vma, addr, page_to_pfn(page), len,</span><br><span class="line">                      vma-&gt;vm_page_prot);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äº <code>page</code> æŒ‡é’ˆåªæ˜¯é¡µé¢ç‰©ç†åœ°å€çš„é€»è¾‘ç§»ä½ï¼Œç„¶åæ˜¯ä¸€ä¸ªæ’å®šçš„çº¿æ€§åç§»ï¼ˆè§<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/include/asm/memory.h#L285"><code>phys_to_page</code></a>çš„å®šä¹‰ï¼‰ï¼Œèƒ½å¤Ÿæ§åˆ¶<code>page_link</code>å°±å¯ä»¥æŠŠä¸€ä¸ªä»»æ„çš„é¡µé¢æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ã€‚å¯¹äºè®¸å¤šè®¾å¤‡æ¥è¯´ï¼Œè¿™å°±è¶³ä»¥å®ç°ä»»æ„çš„å†…æ ¸å†…å­˜è¯»å†™ï¼Œå› ä¸ºå†…æ ¸æ˜ åƒæ˜¯åœ¨ä¸€ä¸ªå›ºå®šçš„ç‰©ç†åœ°å€ä¸Šæ˜ å°„çš„ï¼ˆ<code>KASLR</code>éšæœºåŒ–äº†è¿™ä¸ªå›ºå®šç‰©ç†åœ°å€çš„è™šæ‹Ÿåœ°å€åç§»ï¼‰ï¼Œæ‰€ä»¥åœ¨å¤„ç†ç‰©ç†åœ°å€çš„æ—¶å€™ä¸éœ€è¦æ‹…å¿ƒ<code>KASLR</code>ã€‚</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-7.webp" alt="Kernel-7"></p>
<p>ç„¶è€Œï¼Œä¸‰æ˜Ÿè®¾å¤‡ä»¥ä¸åŒçš„æ–¹å¼è¿›è¡Œ<code>KASLR</code>ã€‚å†…æ ¸é•œåƒçš„ç‰©ç†åœ°å€ä¸æ˜¯æ˜ å°„åˆ°ä¸€ä¸ªå›ºå®šçš„ç‰©ç†åœ°å€ï¼Œè€Œæ˜¯éšæœºåŒ–çš„ï¼ˆä¸¥æ ¼æ¥è¯´ï¼Œæ˜¯å†…æ ¸è®¤ä¸ºçš„ä¸­é—´ç‰©ç†åœ°å€ï¼Œè¿™ä¸æ˜¯çœŸæ­£çš„ç‰©ç†åœ°å€ï¼Œè€Œæ˜¯ç”±ç®¡ç†ç¨‹åºç»™å‡ºçš„è™šæ‹Ÿåœ°å€ï¼‰ã€‚æ‰€ä»¥åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œä»ç„¶éœ€è¦æ³„éœ²ä¸€ä¸ªåœ°å€æ¥æ‰“è´¥<code>KASLR</code>ã€‚ç„¶è€Œï¼Œæœ‰äº†å‡çš„å†…æ ¸å †ï¼Œè¿™å°±ç›¸å½“å®¹æ˜“å®ç°äº†ã€‚ä¸€ä¸ª<code>ion_buffer</code>å¯¹è±¡åŒ…å«ä¸€ä¸ªæŒ‡å‘<code>ion_heap</code>çš„æŒ‡é’ˆï¼Œå®ƒè´Ÿè´£ä¸º<code>ion_buffer</code>åˆ†é…åå¤‡å­˜å‚¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ion_buffer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ion_heap</span> *<span class="title">heap</span>;</span></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶<code>ion_heap</code>åœ¨å†…æ ¸é•œåƒä¸­ä¸æ˜¯ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œä½†æ¯ä¸ª<code>ion_heap</code>éƒ½åŒ…å«ä¸€ä¸ª<code>ion_heap_ops</code>å­—æ®µï¼Œå®ƒæŒ‡å‘ç‰¹å®š<code>ion_heap</code>å¯¹è±¡çš„ç›¸åº” <code>vtable</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ion_heap</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">plist_node</span> <span class="title">node</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">ion_heap_type</span> <span class="title">type</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ion_heap_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„<code>ops</code>å­—æ®µæ˜¯å†…æ ¸é•œåƒä¸­çš„ä¸€ä¸ªå…¨å±€å¯¹è±¡ã€‚å¦‚æœèƒ½å¤Ÿè¯»å–<code>ion_buffer-&gt;heap-&gt;ops</code>ï¼Œé‚£ä¹ˆä¹Ÿèƒ½å¤Ÿå¾—åˆ°ä¸€ä¸ªåœ°å€æ¥æ‰“è´¥<code>KASLR</code>ï¼Œå°†å†…æ ¸é•œåƒä¸­çš„åœ°å€ç¿»è¯‘æˆç‰©ç†åœ°å€ã€‚è¿™å¯ä»¥æŒ‰ä»¥ä¸‹æ–¹æ³•è¿›è¡Œã€‚</p>
<ol>
<li>é¦–å…ˆåœ¨å‡çš„å†…æ ¸å †ä¸­æ‰¾åˆ°<code>ion_buffer</code>ç»“æ„çš„ä½ç½®ã€‚è¿™å¯ä»¥é€šè¿‡<code>ion_buffer</code>ä¸­çš„<code>flags</code>å­—æ®µæ¥å®Œæˆã€‚</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ion_buffer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ion_heap</span> *<span class="title">heap</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯åœ¨åˆ›å»º<code>ion_buffer</code>æ—¶ä»<code>ION_IOC_ALLOC</code> <code>ioctl</code>çš„å‚æ•°ä¸­ä¼ é€’çš„4ä¸ªå­—èŠ‚çš„å€¼ã€‚å¯ä»¥å°†è¿™äº›è®¾ç½®ä¸ºç‰¹å®šçš„ â€œé­”æ³• â€œå€¼ï¼Œå¹¶åœ¨å‡çš„å†…æ ¸å †ä¸­æœç´¢å®ƒä»¬ã€‚</p>
<ol start="2">
<li>ä¸€æ—¦æ‰¾åˆ°<code>ion_buffer</code>ç»“æ„ï¼Œè¯»å–å…¶å †æŒ‡é’ˆã€‚è¿™å°†æ˜¯å†…æ ¸é•œåƒä¹‹å¤–çš„ä½å†…å­˜åŒºåŸŸçš„ä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼Œå› æ­¤ï¼Œå®ƒçš„ç‰©ç†åœ°å€å¯ä»¥é€šè¿‡åº”ç”¨å¸¸æ•°åç§»æ¥è·å¾—ã€‚</li>
<li>ä¸€æ—¦è·å¾—ç›¸åº”çš„<code>ion_heap</code>å¯¹è±¡çš„ç‰©ç†åœ°å€ï¼Œä¿®æ”¹<code>ion_buffer</code>çš„<code>sg_table</code>ï¼Œä½¿å…¶åå¤‡å­˜å‚¨æŒ‡å‘åŒ…å«<code>ion_heap</code>çš„é¡µé¢ã€‚</li>
<li>åœ¨<code>ion_buffer</code>çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šè°ƒç”¨<code>mmap</code>ï¼Œè¿™å°†æŠŠåŒ…å«<code>ion_heap</code>çš„é¡µé¢æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ã€‚ç„¶åå¯ä»¥ç›´æ¥ä»ç”¨æˆ·ç©ºé—´è¯»å–è¯¥é¡µä»¥è·å¾—<code>OPS</code>æŒ‡é’ˆï¼Œè¿™å°†æä¾›<code>KASLR</code>çš„åç§»ã€‚</li>
</ol>
<p><code>ion_buffer</code>ç»“æ„çš„ä½¿ç”¨ä¹Ÿè§£å†³äº†å¦ä¸€ä¸ªé—®é¢˜ã€‚è™½ç„¶å‡å†…æ ¸å †å¾ˆæ–¹ä¾¿ï¼Œä½†å®ƒå¹¶ä¸å®Œç¾ã€‚æ¯å½“å‡å†…æ ¸å †ä¸­çš„ä¸€ä¸ªå¯¹è±¡è¢«é‡Šæ”¾æ—¶ï¼Œ<code>kfree</code>å°†ä½¿ç”¨<code>PageSlab</code>æ£€æŸ¥æ¥æ£€æŸ¥åŒ…å«è¯¥å¯¹è±¡çš„é¡µé¢æ˜¯å¦æ˜¯æ¥è‡ª<code>SLUB</code>åˆ†é…å™¨çš„å•é¡µ<code>slab</code>ã€‚å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œé‚£ä¹ˆ<code>PageCompound</code>æ£€æŸ¥å°†è¢«æ‰§è¡Œï¼Œä»¥æ£€æŸ¥è¯¥é¡µæ˜¯å¦æ˜¯ä¸€ä¸ªæ›´å¤§çš„<code>slab</code>çš„ä¸€éƒ¨åˆ†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">kfree</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *x)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">    <span class="type">void</span> *object = (<span class="type">void</span> *)x;</span><br><span class="line"></span><br><span class="line">    trace_kfree(_RET_IP_, x);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(x)))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    page = virt_to_head_page(x);</span><br><span class="line">    <span class="keyword">if</span> (unlikely(!PageSlab(page))) &#123;     <span class="comment">//&lt;-------- check if the page allocated is a single page slab</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> order = compound_order(page);</span><br><span class="line"></span><br><span class="line">        BUG_ON(!PageCompound(page));     <span class="comment">//&lt;-------- check if the page is allocated as part of a multipage slab</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äºè¿™äº›æ£€æŸ¥æ˜¯åœ¨åŒ…å«é¡µé¢å…ƒæ•°æ®çš„é¡µé¢ç»“æ„æœ¬èº«ä¸Šè¿›è¡Œçš„ï¼Œå› æ­¤åªè¦æœ‰å¯¹è±¡è¢«é‡Šæ”¾ï¼Œå®ƒä»¬å°±ä¼šå¤±è´¥å¹¶å¯¼è‡´å†…æ ¸å´©æºƒã€‚è¿™å¯ä»¥é€šè¿‡ä½¿ç”¨ç°åœ¨æ‹¥æœ‰çš„ä»»æ„è¯»å†™åŸè¯­æ¥è¦†ç›–é¡µé¢ç»“æ„ä¸­å„è‡ªçš„å…ƒæ•°æ®æ¥è§£å†³ï¼ˆå¯¹åº”äºç‰©ç†åœ°å€çš„é¡µé¢ç»“æ„çš„åœ°å€åªæ˜¯ç‰©ç†åœ°å€çš„é€»è¾‘ç§»åŠ¨ï¼Œç„¶åæ˜¯å›ºå®šåç§»é‡çš„è½¬æ¢ï¼Œæ‰€ä»¥å¯ä»¥å°†åŒ…å«é¡µé¢ç»“æ„çš„é¡µé¢æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´å¹¶ä¿®æ”¹å…¶å†…å®¹ï¼‰ã€‚ç„¶è€Œï¼Œå¦‚æœèƒ½å¤Ÿç¡®ä¿å æ®å‡å†…æ ¸å †çš„å¯¹è±¡æ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾ï¼Œé‚£å°±æ›´ç®€å•äº†ã€‚åœ¨<code>ion_buffer</code>ç»“æ„è¢«é‡Šæ”¾ä¹‹å‰ï¼Œä¼šè°ƒç”¨<code>ion_buffer_destroy</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">ion_buffer_destroy</span><span class="params">(<span class="keyword">struct</span> ion_device *dev, <span class="keyword">struct</span> ion_buffer *buffer)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    heap = buffer-&gt;heap;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (heap-&gt;flags &amp; ION_HEAP_FLAG_DEFER_FREE)</span><br><span class="line">        ion_heap_freelist_add(heap, buffer);    <span class="comment">//&lt;--------- does not free immediately</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        ion_buffer_release(buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ<code>ion_heap</code>åŒ…å«æ ‡å¿—<code>ION_HEAP_FLAG_DEFER_FREE</code>ï¼Œé‚£ä¹ˆ<code>ion_buffer</code>ä¸ä¼šç«‹å³è¢«é‡Šæ”¾ï¼Œè€Œæ˜¯é€šè¿‡<code>ion_heap_freelist_add</code>è¢«æ·»åŠ åˆ°<code>ion_heap</code>çš„<code>free_list</code>ã€‚æ·»åŠ åˆ°è¿™ä¸ªåˆ—è¡¨ä¸­çš„<code>ion_buffer</code>å¯¹è±¡åªæœ‰åœ¨ä»¥åéœ€è¦çš„æ—¶å€™æ‰ä¼šè¢«é‡Šæ”¾ï¼Œè€Œä¸”åªæœ‰åœ¨<code>ION_HEAP_FLAG_DEFER_FREE</code>æ ‡å¿—è¢«è®¾ç½®çš„æƒ…å†µä¸‹ã€‚å½“ç„¶ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œ<code>ION_HEAP_FLAG_DEFER_FREE</code>åœ¨<code>ION_heap</code>çš„ç”Ÿå‘½å‘¨æœŸå†…ä¸ä¼šæ”¹å˜ï¼Œä½†æ˜¯é€šè¿‡æˆ‘ä»¬çš„ä»»æ„å†…å­˜å†™å…¥åŸºå…ƒï¼Œå¯ä»¥ç®€å•åœ°å°†<code>ION_HEAP_FLAG_DEFER_FREE</code>æ·»åŠ åˆ°<code>ION_heap-&gt;flags</code>ä¸­ï¼Œé‡Šæ”¾<code>ION_buffer</code>ï¼Œç„¶åå†æ¬¡ç§»é™¤<code>ION_HEAP_FLAG_DEFER_FREE</code>ï¼Œ<code>ION_buffer</code>å°†åªæ˜¯åœç•™åœ¨<code>ION_heap</code>çš„<code>freelist</code>ä¸­è€Œæ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾ã€‚æ­¤å¤–ï¼ŒåŒ…å«<code>ion_heap</code>å¯¹è±¡çš„é¡µé¢å·²ç»è¢«æ˜ å°„ï¼Œç›®çš„æ˜¯ä¸ºäº†ç»•è¿‡<code>KASLR</code>ï¼Œæ‰€ä»¥åˆ‡æ¢è¯¥æ ‡å¿—æ˜¯ç›¸å½“å¾®ä¸è¶³é“çš„ã€‚é€šè¿‡å–·æ´’å‡çš„å†…æ ¸å †ï¼Œä½¿å…¶å……æ»¡äº†<code>ion_buffer</code>å¯¹è±¡åŠå…¶é™„å±ç‰©ï¼Œå¯ä»¥ç¡®ä¿è¿™äº›å¯¹è±¡æ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾ï¼Œé¿å…å†…æ ¸å´©æºƒã€‚</p>
<h2 id="Bypassing-SELinux"><a href="#Bypassing-SELinux" class="headerlink" title="Bypassing SELinux"></a>Bypassing SELinux</h2><p>å½“<code>SELinux</code>è¢«å¯ç”¨æ—¶ï¼Œå®ƒå¯ä»¥åœ¨ <code>permissive</code> æ¨¡å¼æˆ– <code>enforcing</code> æ¨¡å¼ä¸‹è¿è¡Œã€‚å½“å¤„äº <code>permissive</code> æ¨¡å¼æ—¶ï¼Œå®ƒå°†åªå®¡è®¡å’Œè®°å½•æœªç»æˆæƒçš„è®¿é—®ï¼Œä½†ä¸ä¼šé˜»æ­¢å®ƒä»¬ã€‚<code>SELinux</code>çš„è¿è¡Œæ¨¡å¼æ˜¯ç”±<code>selinux_enforcing</code>å˜é‡æ§åˆ¶çš„ã€‚å¦‚æœè¿™ä¸ªå˜é‡ä¸ºé›¶ï¼Œé‚£ä¹ˆ<code>SELinux</code>å°±ä»¥ <code>permissive</code> æ¨¡å¼è¿è¡Œã€‚é€šå¸¸ï¼Œå¯¹ç³»ç»Ÿå®‰å…¨è‡³å…³é‡è¦çš„å˜é‡ä¼šå—åˆ°ä¸‰æ˜Ÿå†…æ ¸æ•°æ®ä¿æŠ¤ï¼ˆKDPï¼‰çš„ä¿æŠ¤ï¼Œé€šè¿‡ä½¿ç”¨<code>__kdp_ro</code>æˆ–<code>__rkp_ro</code>å±æ€§å°†å…¶æ ‡è®°ä¸ºåªè¯»ã€‚è¿™ä¸ªå±æ€§è¡¨æ˜è¯¥å˜é‡å¤„äºåªè¯»é¡µé¢ï¼Œå…¶ä¿®æ”¹å—åˆ°ç®¡ç†ç¨‹åºè°ƒç”¨çš„ä¿æŠ¤ã€‚ç„¶è€Œï¼Œåœ¨5.xåˆ†æ”¯çš„é«˜é€šå†…æ ¸ä¸­ï¼Œä¸‰æ˜Ÿä¼¼ä¹å¿˜è®°äº†ä¿æŠ¤è¿™ä¸ªå˜é‡ï¼ˆ<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">åˆæ˜¯è¿™æ ·å—</a>ï¼ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//In security/selinux/hooks.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY_SELINUX_DEVELOP</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> selinux_enforcing_boot;</span><br><span class="line"><span class="type">int</span> selinux_enforcing;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ï¼Œå¯ä»¥ç›´æ¥å°†<code>selinux_enforcing</code>è¦†ç›–ä¸ºé›¶ï¼Œå¹¶å°†<code>SELinux</code>è®¾ç½®ä¸º<code>permissive</code>æ¨¡å¼ã€‚è™½ç„¶è¿˜æœ‰å…¶ä»–ç»•è¿‡<code>SELinux</code>çš„æ–¹æ³•ï¼ˆæ¯”å¦‚Valentina Palmiottiåœ¨è¿™ä¸ª<a target="_blank" rel="noopener" href="https://github.com/chompie1337/s8_2019_2215_poc/blob/master/poc/selinux_bypass.c">æ¼æ´</a>ä¸­ä½¿ç”¨çš„æ–¹æ³•ï¼‰ï¼Œä½†æ­¤æ—¶çš„æ·å¾„æ›´å—æ¬¢è¿ï¼Œæ‰€ä»¥å°†ç›´æ¥è®¾ç½®<code>selinux_enforcing</code>å˜é‡ã€‚</p>
<h2 id="Running-arbitrary-root-commands-using-ret2kworker-TM"><a href="#Running-arbitrary-root-commands-using-ret2kworker-TM" class="headerlink" title="Running arbitrary root commands using ret2kworker(TM)"></a>Running arbitrary root commands using ret2kworker(TM)</h2><p>åœ¨ä¸‰æ˜Ÿè®¾å¤‡ä¸Šè·å¾—<code>root</code>æƒé™çš„ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„é—®é¢˜æ˜¯ä¸‰æ˜Ÿçš„<code>RKP</code>ï¼ˆå®æ—¶å†…æ ¸ä¿æŠ¤ï¼‰æ‰€æ–½åŠ çš„ä¿æŠ¤ã€‚åœ¨å®‰å“è®¾å¤‡ä¸Šè·å¾—<code>root</code>æƒé™çš„ä¸€ä¸ªå¸¸è§æ–¹æ³•æ˜¯ç”¨<code>root</code>æƒé™è¦†ç›–æˆ‘ä»¬è‡ªå·±è¿›ç¨‹çš„è¯ä¹¦ã€‚ç„¶è€Œï¼Œä¸‰æ˜Ÿçš„<code>RKP</code>å†™ä¿æŠ¤æ¯ä¸ªè¿›ç¨‹çš„å‡­è¯ï¼Œæ‰€ä»¥è¿™åœ¨è¿™é‡Œæ˜¯ä¸å¯èƒ½çš„ã€‚åœ¨ä½œè€…çš„ä¸Šä¸€æ¬¡<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">åˆ©ç”¨</a>ä¸­ï¼Œèƒ½å¤Ÿä»¥<code>root</code>èº«ä»½æ‰§è¡Œä»»æ„ä»£ç ï¼Œå› ä¸ºæ‰€åˆ©ç”¨çš„ç‰¹å®šUAFå¯¼è‡´ä¸€ä¸ªå—æ§å‡½æ•°æŒ‡é’ˆåœ¨ä»¥<code>root</code>èº«ä»½è¿è¡Œçš„<code>kworker</code>çš„ä»£ç ä¸­è¢«æ‰§è¡Œã€‚</p>
<p>å½“ç„¶ï¼Œé€šè¿‡ä»»æ„çš„å†…å­˜è¯»å†™åŸè¯­ï¼Œå¯ä»¥ç®€å•åœ°å°†å¯¹è±¡æ·»åŠ åˆ°è¿™äº›å·¥ä½œé˜Ÿåˆ—ä¹‹ä¸€ï¼ˆåŸºæœ¬ä¸Šæ˜¯åŒ…å«å·¥ä½œç»“æ„çš„é“¾æ¥åˆ—è¡¨ï¼‰ï¼Œå¹¶ç­‰å¾…ä¸€ä¸ª<code>kworker</code>æ¥æ¥å–å·¥ä½œã€‚äº‹å®è¯æ˜ï¼Œè®¸å¤šè¿™äº›å·¥ä½œé˜Ÿåˆ—ç¡®å®æ˜¯é™æ€çš„å…¨å±€å¯¹è±¡ï¼Œåœ¨å†…æ ¸é•œåƒä¸­å…·æœ‰å›ºå®šçš„åœ°å€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ffffffc012c8f7e0 D system_wq</span><br><span class="line">ffffffc012c8f7e8 D system_highpri_wq</span><br><span class="line">ffffffc012c8f7f0 D system_long_wq</span><br><span class="line">ffffffc012c8f7f8 D system_unbound_wq</span><br><span class="line">ffffffc012c8f800 D system_freezable_wq</span><br><span class="line">ffffffc012c8f808 D system_power_efficient_wq</span><br><span class="line">ffffffc012c8f810 D system_freezable_power_efficient_wq</span><br></pre></td></tr></table></figure>

<p>å› æ­¤ï¼Œå°†æ¡ç›®æ·»åŠ åˆ°è¿™äº›å·¥ä½œé˜Ÿåˆ—ä¸­å¹¶è®©<code>kworker</code>æ¥å¤„ç†è¿™äº›å·¥ä½œæ˜¯æ¯”è¾ƒç›´æ¥çš„ã€‚ç„¶è€Œï¼Œç”±äº<code>kCFI</code>ï¼Œåªèƒ½è°ƒç”¨å…·æœ‰ä»¥ä¸‹ç­¾åçš„å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> (func*)(<span class="keyword">struct</span> work_struct *work)</span><br></pre></td></tr></table></figure>

<p>æ˜¯å¦èƒ½æ‰¾åˆ°ä¸€ä¸ªè¶³å¤Ÿå¼ºå¤§çš„å‡½æ•°æ¥è¿è¡Œï¼Ÿç»“æœç›¸å½“ç®€å•ã€‚å‡½æ•°<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/kernel/umh.c#L190"><code>call_usermodehelper_exec_work</code></a>ï¼Œé€šå¸¸åœ¨å†…æ ¸æ¼æ´ä¸­è¢«ç”¨æ¥è¿è¡Œ<code>shell</code>å‘½ä»¤ï¼Œå®ƒç¬¦åˆè¿™ä¸ªè¦æ±‚ï¼Œå¯ä»¥è¿è¡Œæä¾›çš„<code>shell</code>å‘½ä»¤ã€‚å› æ­¤ï¼Œé€šè¿‡ä¿®æ”¹ï¼Œæ¯”å¦‚è¯´ï¼Œ<code>system_unbound_wq</code>ï¼Œå¹¶åœ¨å…¶ä¸­æ·»åŠ ä¸€ä¸ªæŒæœ‰<code>call_usermodehelper_exec_work</code>æŒ‡é’ˆçš„æ¡ç›®ï¼Œå¯ä»¥ç»•è¿‡ä¸‰æ˜Ÿçš„<code>RKP</code>å’Œ<code>kCFI</code>ï¼Œä»¥<code>root</code>èº«ä»½è¿è¡Œä»»æ„å‘½ä»¤ã€‚</p>
<h1 id="å¤ç°æƒ…å†µ"><a href="#å¤ç°æƒ…å†µ" class="headerlink" title="å¤ç°æƒ…å†µ"></a>å¤ç°æƒ…å†µ</h1><p>éœ€è¦<code>Snapdragon 888</code>åŠä»¥ä¸ŠèŠ¯ç‰‡çš„æµ‹è¯•æœºï¼Œç›®å‰æ²¡æœ‰ã€‚</p>
<h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><p><a target="_blank" rel="noopener" href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/">The Android kernel mitigations obstacle race</a></p>
<p><a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2022/04/the-more-you-know-more-you-know-you.html">The More You Know, The More You Know You Donâ€™t Know</a></p>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://avatars.githubusercontent.com/u/19711495?v=4" alt="buffer0verflooow"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">buffer0verflooow</p><p class="is-size-6 is-block">Security Researcher</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Beijing</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">56</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">51</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="me noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-10-10T06:23:56.000Z">2022-10-10</time></p><p class="title"><a href="/2022/10/10/%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"> </a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-30T07:29:09.000Z">2022-07-30</time></p><p class="title"><a href="/2022/07/30/Android%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0/">Androidå®‰å…¨ç¬”è®°</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-20T12:35:56.000Z">2022-07-20</time></p><p class="title"><a href="/2022/07/20/Android%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E6%95%B4%E7%90%86/">Androidä¸­é—´äººæ”»å‡»æ–¹æ³•æ•´ç†</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-04T12:34:01.000Z">2022-07-04</time></p><p class="title"><a href="/2022/07/04/Android-11-%E9%AD%94%E5%BD%A2%E5%A5%B3%E6%BC%8F%E6%B4%9E/">Android 11 é­”å½¢å¥³æ¼æ´</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-01T13:59:36.000Z">2022-07-01</time></p><p class="title"><a href="/2022/07/01/macOS-Intel%E5%9B%BE%E5%BD%A2%E5%86%85%E6%A0%B8%E6%8B%93%E5%B1%95RCE-EOP/">macOS Intelå›¾å½¢å†…æ ¸æ‹“å±•RCE+EOP</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">October 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">July 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">June 2022</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">May 2022</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">April 2022</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">March 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/02/"><span class="level-start"><span class="level-item">February 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">January 2022</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">December 2021</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">November 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">August 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ASN-1/"><span class="tag">ASN.1</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AppleAVE2/"><span class="tag">AppleAVE2</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ContentProvider/"><span class="tag">ContentProvider</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/IOServices/"><span class="tag">IOServices</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LPE/"><span class="tag">LPE</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PendingIntent/"><span class="tag">PendingIntent</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/adobe/"><span class="tag">adobe</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/afl/"><span class="tag">afl++</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ams/"><span class="tag">ams</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android/"><span class="tag">android</span><span class="tag">18</span></a></div><div class="control"><a class="tags has-addons" href="/tags/aosp/"><span class="tag">aosp</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/apple/"><span class="tag">apple</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/arm64/"><span class="tag">arm64</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cfprefsd/"><span class="tag">cfprefsd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/chrome/"><span class="tag">chrome</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/darwin/"><span class="tag">darwin</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/exploit/"><span class="tag">exploit</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/fuzz/"><span class="tag">fuzz</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gpu/"><span class="tag">gpu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hook/"><span class="tag">hook</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/intel/"><span class="tag">intel</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/intent/"><span class="tag">intent</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iomfb/"><span class="tag">iomfb</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ios/"><span class="tag">ios</span><span class="tag">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/logic-vul/"><span class="tag">logic vul</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lpe/"><span class="tag">lpe</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mach/"><span class="tag">mach</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/macos/"><span class="tag">macos</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mig/"><span class="tag">mig</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/note/"><span class="tag">note</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/npu/"><span class="tag">npu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pac/"><span class="tag">pac</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pipe/"><span class="tag">pipe</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pongoOS/"><span class="tag">pongoOS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qemu/"><span class="tag">qemu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qualcom/"><span class="tag">qualcom</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qualcomm/"><span class="tag">qualcomm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/rce/"><span class="tag">rce</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/safari/"><span class="tag">safari</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/samsung/"><span class="tag">samsung</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/soot/"><span class="tag">soot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/static-analysis/"><span class="tag">static analysis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/syzkaller/"><span class="tag">syzkaller</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tcc/"><span class="tag">tcc</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/telecom/"><span class="tag">telecom</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/uaf/"><span class="tag">uaf</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vul/"><span class="tag">vul</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/webaudio/"><span class="tag">webaudio</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xnu/"><span class="tag">xnu</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xpc/"><span class="tag">xpc</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="buffer0verflooow - Blog" height="28"></a><p class="is-size-7"><span>&copy; 2024 buffer0verflooow</span>Â Â Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>Â &amp;Â <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">Â© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">Ã—</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>