<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"buffer0verflooow.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="buffer0verflooow - Blog">
<meta property="og:url" content="https://buffer0verflooow.github.io/page/28/index.html">
<meta property="og:site_name" content="buffer0verflooow - Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="buffer0verflooow">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://buffer0verflooow.github.io/page/28/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/28/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>buffer0verflooow - Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">buffer0verflooow - Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/home/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">buffer0verflooow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">56</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://buffer0verflooow.github.io/2022/04/09/MacOS-SUHelper%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E-CVE-2022-22639/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="buffer0verflooow">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | buffer0verflooow - Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/09/MacOS-SUHelper%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E-CVE-2022-22639/" class="post-title-link" itemprop="url">MacOS SUHelper提权漏洞(CVE-2022-22639)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-04-09 09:41:01" itemprop="dateCreated datePublished" datetime="2022-04-09T09:41:01+08:00">2022-04-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-04-10 17:49:47" itemprop="dateModified" datetime="2022-04-10T17:49:47+08:00">2022-04-10</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>CVE-2022-22639 在iOS 15.4 、iPadOS 15.4、macOS Monterey 12.3上进行了修复。</p>
<p>也影响了iOS，是由<a target="_blank" rel="noopener" href="https://www.trendmicro.com/en_us/research/22/d/macos-suhelper-root-privilege-escalation-vulnerability-a-deep-di.html">trend micro</a>发现的。</p>
<h1 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h1><p><code>suhelpd</code>是macOS中软件更新的辅助守护进程，其中有一个类叫SUHelper，使用IPC提供系统服务。这个进程以root身份运行，并使用特殊权利进行签名，如<code>com.apple.rootless.install</code>。<code>suhelpd</code>可以授予进程绕过系统完整性保护(SIP)限制的能力。</p>
<h2 id="IPC服务"><a href="#IPC服务" class="headerlink" title="IPC服务"></a>IPC服务</h2><p><code>suhelpd</code>通过<code>bootstrap_check_in</code>注册名为<code>com.apple.suhelperd</code>的IPC服务。</p>
<img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/202204091356.png" alt="202204091356" style="zoom: 50%;" />

<p>IPC 服务器提供了 45 个服务例程，但是不知道是怎么逆向出来的。</p>
<p><img src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/d/suhelper/suhelper02.png" alt="图 2. 一些 IPC 服务例程"></p>
<p>调用这些服务例程，可以使用OC提供的SUHelperProxy 的类，它封装了所有可以直接使用的 IPC 客户端接口，后面exp也是利用这个来写的。 </p>
<h2 id="客户端授权"><a href="#客户端授权" class="headerlink" title="客户端授权"></a>客户端授权</h2><p>这 45 种服务有一部分可供非特权客户端使用，并且服务器可以通过权限授权机制来验证服务请求是否来自合法客户端。 </p>
<p>客户端需要通过 API <code>AuthorizationCreate</code> 生成一个授权对象，然后将其作为外部表单（32 字节数据），将授权对象传递给服务器进行验证。</p>
<p><img src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/d/suhelper/suhelper05.png" alt="图 5. 生成授权对象的客户端"></p>
<p>服务器收到授权对象后，判断是否可以授予客户端特定的权限。在这个阶段，服务器检查客户端的授权对象和uid。</p>
<p><img src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/d/suhelper/suhelper06.png" alt="图 6. 服务器验证客户端的授权对象和 uid"></p>
<p>当客户端请求一个特殊的服务例程时，服务器检查特定的权限是否先前被授予给客户端，否则拒绝该请求。</p>
<h2 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h2><p>以此逆向分析 45 个服务例程，然后过滤掉带有验证码的那些，发现了一些名称以“IPC_0_”开头的。对这些例程再进行逆向，发现函数<code>-[SUHelper prepareInstallAssistantWithPath:(NSString *) path]</code>是可利用的。调用者函数 <code>IPC_0_prepareInstallAssistantWithPath</code> 没有验证客户端的权限，而是直接调用了真实的例程。</p>
<p><img src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/d/suhelper/suhelper11.png" alt="图 11. 易受攻击的 IPC 服务例程"></p>
<p>函数的实现如下，第三个参数<code>(NSString *)</code>是从客户端传过来的路径。</p>
<p><img src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/d/suhelper/suhelper12.png" alt="图 12. 函数“–[SUHelper prepareInstallAssitantWithPath:]”的实现"></p>
<p>查看内部函数会发现它在第 70 行加载了一个包。</p>
<p><img src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/d/suhelper/suhelper13.png" alt="图 13. 内部函数实现"></p>
<p>调试发现捆绑路径为 <code>$&#123;Assistant.app&#125;/Contents/Frameworks/OSInstallerSetup.framework</code>。一个重要的发现是<code>$&#123;Assistant.app&#125;</code>其实是第三个参数<code>(NSString *)</code>路径，可以完全由客户端控制。</p>
<p>在正常情况下，<code>$&#123;Assistant.app&#125;</code>应该是安装<code>macOS XXX.app</code>的真实路径。是从 Apple 服务器下载的 <code>InstallAssistant.pkg</code> 中提取的。但是，我发现用户可以利用此漏洞伪造 <code>$&#123;Assistant.app&#125;</code> 的路径和内容。</p>
<p>似乎找到了一个将任何 dylib 加载到目标进程中以获得 root 特权和特殊权利的原语。但是，无法直接加载自签名 dylib，因为当 SIP 开启时，系统进程默认启用<a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/security/hardened_runtime?language=objc">强化运行</a>时，即使它没有使用运行时标志进行签名。但可以将任意 Apple 签名的 dylib 加载到其中，即使它是一个旧的、易受攻击的 dylib。</p>
<p>还有另一个办法，让它加载原始的 <code>OSInstallerSetup.framework</code>。一旦 <code>OSInstallerSetup.framework</code> 被加载，它就会调用函数<code>-[OSISClient _startServer]</code>。在第 103 行，它通过 API <code>SMJobSubmit</code> 启动另一个 IPC 服务 <code>com.apple.install.osinstallersetupd</code>。从第 48 行可以看出，如果当前进程以 root 身份运行，那么新提交的作业也以 root 权限运行在系统域。 </p>
<p><img src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/d/suhelper/suhelper14.png" alt="图 14. 函数“–[OSISClient _startServer]”的实现"></p>
<p>当前进程是 <code>suhelperd</code>，以 root 身份运行，作业可执行路径是 <code>toolPath</code>，它位于包 <code>$&#123;Assistant.app&#125;/Contents/Frameworks/OSInstallerSetup.framework/Resources/osinstallersetupd</code> 内。攻击者可以将payload直接放入 <code>toolPath</code> 以实现 root 权限升级。</p>
<p><img src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/d/suhelper/suhelper15.png" alt="图 15. 如何获取 toolPath"></p>
<h1 id="补丁"><a href="#补丁" class="headerlink" title="补丁"></a>补丁</h1><p>Apple 已通过<a target="_blank" rel="noopener" href="https://support.apple.com/en-us/HT213183">macOS Monterey 12.3 安全更新</a>解决了 CVE-2022-22639 问题。这个补丁现在在第 9 行添加了验证代码。</p>
<p><img src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/d/suhelper/suhelper16.png" alt="图 16. CVE-2022-22639 补丁"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/27/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><span class="page-number current">28</span><a class="page-number" href="/page/29/">29</a><span class="space">&hellip;</span><a class="page-number" href="/page/56/">56</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/29/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">buffer0verflooow</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
